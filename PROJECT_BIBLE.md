# Project Bible

Generated on: 2026-02-14 14:34:30 MST

## Full /specs File Index (Every File)
- specs/ADAPTIVE_STANDARDS_ENGINE_SPEC.md
- specs/AI_OPERATING_PREFERENCES.md
- specs/AUTO_CORRECTION_SYSTEM_SPEC.md
- specs/AWARDS_CEREMONY_FIGMA_SPEC.md
- specs/BASEBALL_STATE_MACHINE_AUDIT.md
- specs/BWAR_CALCULATION_SPEC.md
- specs/CLUTCH_ATTRIBUTION_SPEC.md
- specs/CONTRACTION_EXPANSION_FIGMA_SPEC.md
- specs/CURRENT_STATE.md
- specs/DECISIONS_LOG.md
- specs/DRAFT_FIGMA_SPEC.md
- specs/DYNAMIC_DESIGNATIONS_SPEC.md
- specs/EOS_RATINGS_ADJUSTMENT_SPEC.md
- specs/EOS_RATINGS_FIGMA_SPEC.md
- specs/FAN_FAVORITE_SYSTEM_SPEC.md
- specs/FAN_MORALE_SYSTEM_SPEC.md
- specs/FARM_SYSTEM_SPEC.md
- specs/FEATURE_TEMPLATE.md
- specs/FEATURE_WISHLIST.md
- specs/FIELDING_PIPELINE_MAPPINGS.md
- specs/FIELDING_SYSTEM_SPEC.md
- specs/FIELD_ZONE_INPUT_SPEC.md
- specs/FINALIZE_ADVANCE_FIGMA_SPEC.md
- specs/FRANCHISE_MODE_SPEC.md
- specs/FREE_AGENCY_FIGMA_SPEC.md
- specs/FWAR_CALCULATION_SPEC.md
- specs/GAMETRACKER_BUGS.md
- specs/GAMETRACKER_DRAGDROP_SPEC.md
- specs/GAME_SIMULATION_SPEC.md
- specs/GRADE_ALGORITHM_SPEC.md
- specs/IMPLEMENTATION_PLAN.md
- specs/INHERITED_RUNNERS_SPEC.md
- specs/KBL GameTracker fullview.pdf
- specs/KBL_TRACKER_UI_UX_PLANNING.md
- specs/KBL_XHD_TRACKER_MASTER_SPEC_v3.md
- specs/LEAGUE_BUILDER_FIGMA_SPEC.md
- specs/LEAGUE_BUILDER_SPEC.md
- specs/LEVERAGE_INDEX_SPEC.md
- specs/MASTER_BASEBALL_RULES_AND_LOGIC.md
- specs/MASTER_SPEC_ERRATA.md
- specs/MILESTONE_SYSTEM_SPEC.md
- specs/MOJO_FITNESS_SYSTEM_SPEC.md
- specs/MWAR_CALCULATION_SPEC.md
- specs/NARRATIVE_SYSTEM_SPEC.md
- specs/OFFSEASON_SYSTEM_SPEC.md
- specs/PITCHER_STATS_TRACKING_SPEC.md
- specs/PITCH_COUNT_TRACKING_SPEC.md
- specs/PLAYOFFS_FIGMA_SPEC.md
- specs/PLAYOFF_SYSTEM_SPEC.md
- specs/PWAR_CALCULATION_SPEC.md
- specs/README.md
- specs/REQUIREMENTS.md
- specs/RETIREMENT_FIGMA_SPEC.md
- specs/RUNNER_ADVANCEMENT_RULES.md
- specs/RWAR_CALCULATION_SPEC.md
- specs/SALARY_SYSTEM_SPEC.md
- specs/SCHEDULE_SYSTEM_FIGMA_SPEC.md
- specs/SEASON_END_FIGMA_SPEC.md
- specs/SEASON_SETUP_FIGMA_SPEC.md
- specs/SEASON_SETUP_SPEC.md
- specs/SESSION_LOG.md
- specs/SMB4_GAME_REFERENCE.md
- specs/SPECIAL_EVENTS_SPEC.md
- specs/SPEC_INDEX.md
- specs/STADIUM_ANALYTICS_SPEC.md
- specs/STAT_TRACKING_ARCHITECTURE_SPEC.md
- specs/SUBSTITUTION_FLOW_SPEC.md
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140443.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140447.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140450.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140454.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140456.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140507.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140511.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140514.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140517.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140520.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140527.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140530.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140534.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140537.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140540.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140547.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140552.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140555.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140559.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140609.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140618.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140623.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140626.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140630.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140633.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140647.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140651.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140655.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140658.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140701.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140706.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140710.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140713.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140717.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140719.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140730.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140733.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140736.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140739.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140742.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140748.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140832.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140835.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140838.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140841.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140849.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140852.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140855.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140858.jpg
- specs/Super Mega Baseball 4 Teams and Players/10 final SML teams/Super Mega Baseball 4_20260126140900.jpg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140138.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140152.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140157.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140200.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140203.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140216.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140220.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140223.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140226.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140234.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140238.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140241.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140244.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140311.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140316.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140319.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140323.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140326.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140337.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140341.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140344.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140348.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140351.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140359.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140404.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140407.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140410.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140413.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140421.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140426.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140429.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140432.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140435.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140443.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140447.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140450.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140454.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140456.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140507.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140511.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140514.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140517.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140520.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140527.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140530.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140534.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140537.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140540.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140547.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140552.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140555.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140559.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140609.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140618.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140623.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140626.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140630.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140633.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140647.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140651.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140655.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140658.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140701.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140706.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140710.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140713.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140717.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140719.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140730.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140733.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140736.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140739.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140742.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140748.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140832.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140835.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140838.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140841.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140849.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140852.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140855.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140858.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140900.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140908.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140911.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140914.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140917.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140920.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140927.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140931.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140934.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140937.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140939.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140949.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140952.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140955.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126140958.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141001.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141007.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141011.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141013.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141016.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141019.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141216.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141536.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141547.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141553.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141556.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141559.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141606.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141610.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141613.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141615.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141618.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141625.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141629.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141632.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141636.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141638.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141647.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141653.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141656.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141659.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141702.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141709.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141713.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141716.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141718.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141722.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141730.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141733.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141736.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141739.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141741.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141749.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141754.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141757.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141759.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141802.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141809.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141813.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141816.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141819.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141822.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141829.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141833.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141836.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141839.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141842.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141854.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141858.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141901.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141904.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141906.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141917.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141921.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141926.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141929.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141932.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141939.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141943.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141946.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141948.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126141951.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142001.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142005.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142008.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142011.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142014.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142021.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142024.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142027.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142030.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142032.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142051.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142055.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142059.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142102.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142105.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142124.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142129.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142132.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142135.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142138.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142750.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142753.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142755.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142758.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142800.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142808.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142812.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142814.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142816.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142820.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142827.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142830.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142833.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142836.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142838.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142845.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142848.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142851.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142853.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142856.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142904.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142907.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142910.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142912.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142915.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142922.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142926.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142929.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142931.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142934.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142941.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142944.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142947.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142949.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126142952.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143000.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143003.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143006.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143008.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143011.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143018.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143021.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143024.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143027.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143029.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143036.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143040.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143043.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143045.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143048.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143056.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143100.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143103.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143106.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143109.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143116.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143119.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143122.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143124.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143127.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143134.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143138.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143141.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143143.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143146.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143153.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143156.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143159.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143202.jpeg
- specs/Super Mega Baseball 4 Teams and Players/Super Mega Baseball 4_20260126143205.jpeg
- specs/TRADE_FIGMA_SPEC.md
- specs/TRADE_SYSTEM_SPEC.md
- specs/archive/AUDIT_REPORT.md
- specs/archive/AUDIT_TRIAGE.xlsx
- specs/archive/Audit Triage.xlsx
- specs/archive/BASEBALL_LOGIC_TEST_PLAN.md
- specs/archive/BASEBALL_RULES_INTEGRATION.md
- specs/archive/BASEBALL_RULES_QUICK_REFERENCE.md
- specs/archive/BROKEN_IMPLEMENTATION_AUDIT.md
- specs/archive/BROKEN_IMPLEMENTATION_AUDIT_v2.md
- specs/archive/BROWSER_TEST_REPORT.md
- specs/archive/BUGFIX_VERIFICATION_REPORT.md
- specs/archive/BUG_RESOLUTION_EXHIBITION.md
- specs/archive/BUG_RESOLUTION_LEAGUE_BUILDER.md
- specs/archive/BUG_RESOLUTION_LOAD_FRANCHISE.md
- specs/archive/BUG_RESOLUTION_NEW_FRANCHISE.md
- specs/archive/BUG_RESOLUTION_PLAYOFF_MODE.md
- specs/archive/CALCULATION_MATRIX_REPORT.md
- specs/archive/CHANGELOG_OLD.md
- specs/archive/CLAUDE_CODE_CONSTITUTION.md
- specs/archive/COHESION_REPORT.md
- specs/archive/COHESION_REPORT_DRAFT.md
- specs/archive/COMPREHENSIVE_GAP_ANALYSIS.md
- specs/archive/CORRECTED_GAP_ANALYSIS.md
- specs/archive/CURRENT_STATE_2026-02-11.md
- specs/archive/DATA_INTEGRITY_FIX_REPORT.md
- specs/archive/DATA_PIPELINE_TRACE_REPORT.md
- specs/archive/DATA_WIRING_REPORT_2026-02-07.md
- specs/archive/DECISIONS_LOG_through_2026-02-11.md
- specs/archive/DETECTION_FUNCTIONS_IMPLEMENTATION.md
- specs/archive/DRAGDROP_AUDIT_2026-01-31.md
- specs/archive/DRAGDROP_IMPLEMENTATION_PLAN.md
- specs/archive/DUMMY_DATA_SCRUB_REPORT.md
- specs/archive/E2E_PLAYTEST_REPORT.md
- specs/archive/EOS_RATINGS_READINESS.md
- specs/archive/EXHAUSTIVE_AUDIT_FINDINGS.md
- specs/archive/EXHAUSTIVE_AUDIT_PROGRESS.md
- specs/archive/FAME_SYSTEM_TRACKING.md
- specs/archive/FAN_HAPPINESS_SPEC_LEGACY.md
- specs/archive/FEATURES_ROADMAP_OLD.md
- specs/archive/FIGMA_BLURB_FREE_AGENCY_EXCHANGE.md
- specs/archive/FIGMA_COMPLETION_MAP.md
- specs/archive/FIGMA_GAMETRACKER_IMPLEMENTATION_PLAN.md
- specs/archive/FILESYSTEM_SYNC_RESOLUTION.md
- specs/archive/FIX_EXECUTION_REPORT_2026-02-05.md
- specs/archive/FIX_EXECUTION_REPORT_2026-02-06.md
- specs/archive/FIX_EXECUTION_REPORT_2026-02-07.md
- specs/archive/FULL_STACK_AUDIT.md
- specs/archive/GAMETRACKER_AUDIT_REPORT.md
- specs/archive/GAMETRACKER_BUG_AUDIT_PLAN.md
- specs/archive/GAMETRACKER_REDESIGN_GAP_ANALYSIS.md
- specs/archive/GAMETRACKER_TEST_REPORT.md
- specs/archive/GAMETRACKER_TEST_RESULTS_2026-01-31.md
- specs/archive/GAMETRACKER_TEST_RESULTS_2026-02-05.md
- specs/archive/GAPS_MASTER.md
- specs/archive/GOLDEN_CASES_REVIEW.md
- specs/archive/IMPLEMENTATION_GUIDE_OLD.md
- specs/archive/IMPLEMENTATION_PLAN_FULL.md
- specs/archive/IMPLEMENTATION_PLAN_v1_DEPRECATED.md
- specs/archive/INFERENTIAL_LOGIC_GAP_ANALYSIS.md
- specs/archive/JOURNEY_TEST_REPORT.md
- specs/archive/KBL_TRACKER_FIGMA_MAKE_PROMPT_V2.md
- specs/archive/KBL_XHD_TRACKER_MASTER_SPEC.md
- specs/archive/KBL_XHD_TRACKER_MASTER_SPEC_v2.md
- specs/archive/LEGACY_VS_FIGMA_AUDIT.md
- specs/archive/LIFECYCLE_VERIFICATION.md
- specs/archive/LOGIC_MATRIX_REPORT.md
- specs/archive/MANUAL_TESTING_BUG_FIX_PLAN.md
- specs/archive/MASTER_SPEC_CORRECTIONS.md
- specs/archive/MASTER_SPEC_CORRECTIONS_v2.md
- specs/archive/MOCK_DATA_INVENTORY.md
- specs/archive/NFL_AUDIT_REPORT_JAN23.md
- specs/archive/PHASE_B_EXECUTION_REPORT.md
- specs/archive/PIPELINE.md
- specs/archive/PLAN_MILESTONE_IMPLEMENTATION.md
- specs/archive/POST_SEASON_DIAGNOSIS.md
- specs/archive/PRE_MANUAL_CLEANUP.md
- specs/archive/RALPH_FRAMEWORK.md
- specs/archive/README.md
- specs/archive/RECONCILIATION_PLAN.md
- specs/archive/SALARY_SYSTEM_SPEC.md
- specs/archive/SEASON_SIMULATOR_REPORT.md
- specs/archive/SESSION_LOG_SUMMARY.md
- specs/archive/SESSION_LOG_through_2026-02-11.md
- specs/archive/SKILL_AUDIT_REPORT.md
- specs/archive/SMB4_GAME_MECHANICS.md
- specs/archive/SPEC_INVENTORY.md
- specs/archive/SPEC_TO_CODE_AUDIT_REPORT.md
- specs/archive/SPEC_TO_CODE_TRACEABILITY.md
- specs/archive/SPEC_TRIAGE.md
- specs/archive/SPEC_UI_ALIGNMENT_REPORT.md
- specs/archive/TEAM_VISUALS.md
- specs/archive/TEST_MATRIX.md
- specs/archive/TIER0_BATCH_PROMPTS.md
- specs/archive/TIER0_DIAGNOSTIC.md
- specs/archive/TIER0_REVISED_FIX_PLAN.md
- specs/archive/TIER1_DIAGNOSTIC.md
- specs/archive/TIER1_FIX_PLAN.md
- specs/archive/TIER1_VERIFICATION.md
- specs/archive/TIER3_BUILD_PLAN.md
- specs/archive/TRACKER_LOGIC_AUDIT.md
- specs/archive/TRIAGE_DECISIONS.md
- specs/archive/UI_FLOW_CRAWL_REPORT.md
- specs/archive/WORST_CASE_SCENARIOS.md
- specs/archive/app_features_and_questions.md
- specs/archive/cli-prompts/CLI_PROMPT_BATCH_1.md
- specs/archive/cli-prompts/CLI_PROMPT_BATCH_2.md
- specs/archive/cli-prompts/CLI_PROMPT_PHASE_B.md
- specs/archive/cli-prompts/CLI_PROMPT_PHASE_B_TIER.md
- specs/archive/cli-prompts/CLI_PROMPT_SPEC_CONSOLIDATION.md
- specs/archive/cli-prompts/CLI_PROMPT_TRIAGE_FIX.md
- specs/archive/cli-prompts/CONSOLIDATE_CROSS_DOMAIN_VALIDATOR.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_1_WAR_STATS.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_2_GAMETRACKER.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_3_PLAYER_SYSTEMS.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_4_FRANCHISE_OFFSEASON.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_5_LEAGUE_PLAYOFFS.md
- specs/archive/cli-prompts/CONSOLIDATE_DOMAIN_6_MASTER.md
- specs/archive/cli-prompts/QUICK_REFERENCE.txt
- specs/archive/cli-prompts/README.md
- specs/archive/cli-prompts/SOURCE_FILES_MANIFEST.md
- specs/archive/eos_ratings_adjustment_v3.md
- specs/archive/eos_ratings_adjustment_v4.md
- specs/archive/exhaustive-spec-auditor.zip
- specs/archive/fame_and_events_system.md
- specs/archive/fame_triggers_comprehensive.md
- specs/archive/gametracker-enhanced/OVERLAP_WITH_LEGACY.md
- specs/archive/gametracker-enhanced/README.md
- specs/archive/gametracker-legacy/OVERLAP_WITH_ENHANCED.md
- specs/archive/gametracker-legacy/README.md
- specs/archive/grade_tracking_system.md
- specs/archive/offseason_system_design.md
- specs/archive/random_events_expanded.md
- specs/archive/ratings_adjustment_analysis.md
- specs/archive/ratings_adjustment_analysis_v2.md
- specs/archive/session_summary_fame_events_grades.md
- specs/archive/skils.zip
- specs/archive/smb_maddux_analysis.md
- specs/canonical/ARCHITECTURE.md
- specs/canonical/CANONICAL_TYPES.md
- specs/canonical/FEATURE_INVENTORY.md
- specs/canonical/features/gametracker.md
- specs/canonical/working/gametracker-components-raw.md
- specs/canonical/working/gametracker-engines-raw.md
- specs/canonical/working/gametracker-hooks-raw.md
- specs/canonical/working/gametracker-storage-raw.md
- specs/canonical/working/gametracker-usegamestate-raw.md
- specs/data/README.md
- specs/data/all_players_combined.csv
- specs/data/all_teams_combined.csv
- specs/data/apps-script-import-data.js
- specs/data/apps-script-setup.js
- specs/data/csv-templates-v2/README.md
- specs/data/csv-templates-v2/allstars.csv
- specs/data/csv-templates-v2/awards.csv
- specs/data/csv-templates-v2/batting.csv
- specs/data/csv-templates-v2/boxscores.csv
- specs/data/csv-templates-v2/homeruns.csv
- specs/data/csv-templates-v2/mvpstats.csv
- specs/data/csv-templates-v2/pitching.csv
- specs/data/csv-templates-v2/players.csv
- specs/data/csv-templates-v2/randomevents.csv
- specs/data/csv-templates-v2/records.csv
- specs/data/csv-templates-v2/rosters.csv
- specs/data/csv-templates-v2/schedule.csv
- specs/data/csv-templates-v2/seasons.csv
- specs/data/csv-templates-v2/stadiums.csv
- specs/data/csv-templates-v2/teams.csv
- specs/data/csv-templates-v2/transactions.csv
- specs/data/names_database.json
- specs/data/players_final.csv
- specs/data/players_for_import.csv
- specs/data/rosters_for_import.csv
- specs/data/smb4_players.csv
- specs/data/smb4_players_fixed.csv
- specs/data/smb4_season_baselines_raw.md
- specs/data/stadiums_for_import.csv
- specs/data/teams_for_import.csv
- specs/ralph/ACCEPTANCE_CRITERIA.md
- specs/ralph/IMPLEMENTATION_ORDER.md
- specs/ralph/PRD_UI_COMPONENTS.md
- specs/ralph/STORIES_PHASE_B.md
- specs/ralph/STORIES_PHASE_C.md
- specs/ralph/STORIES_PHASE_D.md
- specs/ralph/STORIES_PHASE_E.md
- specs/ralph/STORIES_PHASE_F.md
- specs/ralph/STORIES_PHASE_G.md
- specs/ralph/UI_INVENTORY.md
- specs/ralph/USER_STORIES.md
- specs/smb4_traits_reference.md
- specs/stories/STORIES_AWARDS_CEREMONY.md
- specs/stories/STORIES_CONTRACTION_EXPANSION.md
- specs/stories/STORIES_DRAFT.md
- specs/stories/STORIES_FINALIZE_ADVANCE.md
- specs/stories/STORIES_FREE_AGENCY.md
- specs/stories/STORIES_GAMETRACKER_FIXES.md
- specs/stories/STORIES_GAP_CLOSERS.md
- specs/stories/STORIES_LEAGUE_BUILDER.md
- specs/stories/STORIES_PLAYOFFS.md
- specs/stories/STORIES_RATINGS_ADJUSTMENT.md
- specs/stories/STORIES_RETIREMENT.md
- specs/stories/STORIES_SEASON_END.md
- specs/stories/STORIES_TRADE.md
- specs/stories/STORIES_WIRING.md
- specs/testing/COMPLETE_TESTING_PIPELINE_GUIDE.md
- specs/testing/ENGINE_API_MAP.md
- specs/testing/FRANCHISE_API_MAP.md
- specs/testing/FRANCHISE_BUTTON_AUDIT.md
- specs/testing/TESTING_IMPLEMENTATION_PLAN.md
- specs/testing/TESTING_PIPELINE_GUIDE.md

## Core Goals of the App (Exact Source Text)

### Source File: specs/REQUIREMENTS.md

~~~markdown
# KBL Tracker - Requirements

> **Purpose**: Documented user requirements and constraints
> **Last Updated**: January 2025

---

## Core Purpose

**KBL Tracker is a stat-tracking application for VIDEO GAME baseball** (e.g., MLB The Show).

This is NOT for:
- Real-life baseball games
- Umpire/official scorer use
- Kids league or modified rules

---

## Functional Requirements

### Must Have (P0)

| Requirement | Status | Notes |
|-------------|--------|-------|
| Track all standard at-bat results | ‚úÖ Done | 1B, 2B, 3B, HR, BB, K, GO, FO, etc. |
| Track runner advancement | ‚úÖ Done | User selects outcome for each runner |
| Calculate outs correctly | ‚úÖ Done | Including DP (2 outs), inning flip at 3 |
| Calculate runs correctly | ‚úÖ Done | Respects 3rd-out-on-force rule |
| Calculate RBIs correctly | ‚úÖ Done | Excludes errors, DP, WP, PB, Balk |
| Track extra events | ‚úÖ Done | SB, CS, WP, PB, Pickoff, Balk |
| Undo functionality | ‚úÖ Done | At least 10 states |
| Activity log | ‚úÖ Done | Shows recent plays |

### Should Have (P1)

| Requirement | Status | Notes |
|-------------|--------|-------|
| Data persistence | ‚ùå Not done | Survive page refresh |
| Substitution tracking | ‚ö†Ô∏è Partial | Buttons exist, no logic |
| Pitcher stat tracking | ‚ùå Not done | IP, K, BB, ER |

### Nice to Have (P2)

| Requirement | Status | Notes |
|-------------|--------|-------|
| Box score export | ‚ùå Not done | |
| Multi-game tracking | ‚ùå Not done | |
| Walk-off detection | ‚ùå Not done | |

---

## Constraints

### Video Game Context

Since this is for video games, the following real-baseball scenarios are **OUT OF SCOPE**:

- Catcher interference
- Batter interference
- Runner interference (non-obvious)
- Umpire judgment calls
- Checked swing rulings
- Infield fly rule (game handles automatically)
- Balks (game detects, user just records outcome)
- Kids league modifications
- Pitch clock violations

### User Interaction Model

**Core Principle: Non-User-Intensive Tracking Through Inferential Logic**

The GameTracker should minimize user input burden by leveraging inferential logic based on real baseball gameplay intuition. The goal is to make tracking feel natural and automatic.

#### Detection Philosophy

1. **Auto-Detection** (no user input needed):
   - Events determinable from play-by-play context (cycle, no-hitter, perfect game, immaculate inning)
   - Statistical milestones (career HRs, season hits, etc.)
   - Mechanical events (blown saves, GIDP, etc.)

2. **Prompt-Detection** (system suggests, user confirms):
   - Events the system suspects but cannot be certain (web gems, TOOTBLAN, robbery, nut shot)
   - System calculates probability and prompts user only when warranted
   - Example: Fly out in deep zone with high fielder difficulty ‚Üí "Was that a Web Gem? üåü"

3. **Manual Entry** (rare, user-initiated):
   - Edge cases the system cannot detect
   - Quick buttons available (ü•ú Nut Shot, üí• Killed Pitcher, ü§¶ TOOTBLAN, ‚≠ê Web Gem)
   - Full Fame Event Modal for comprehensive manual entry

#### Input Hierarchy (Preference Order)

1. **Infer automatically** when baseball logic makes outcome clear
2. **Prompt for confirmation** when system has reasonable suspicion
3. **Ask only when necessary** for genuinely ambiguous situations
4. **Manual entry as fallback** for edge cases

#### User Override

- User can always override any auto-detected or prompted event
- RBI count, fielder assignments, Fame events can be manually adjusted
- User is final authority, system provides intelligent defaults

---

## Non-Functional Requirements

| Requirement | Target | Status |
|-------------|--------|--------|
| Responsive UI | Works on desktop | ‚úÖ |
| Fast interactions | No lag on clicks | ‚úÖ |
| Clear feedback | Know what was recorded | ‚úÖ |
| Error prevention | Disable invalid actions | ‚úÖ |

---

## User Preferences (Discovered)

These are preferences learned through our working sessions:

1. **Thoroughness over speed** - Complete testing before moving on
2. **Documentation required** - All decisions and findings must be written down
3. **First principles reasoning** - Don't assume, verify
4. **Negative Feedback Loop** - Actively try to break things before declaring success

---

## Glossary

| Term | Definition |
|------|------------|
| AB | At-Bat (excludes walks, HBP, SF, SAC) |
| PA | Plate Appearance (all trips to plate) |
| RBI | Run Batted In |
| RISP | Runner In Scoring Position (2B or 3B) |
| DP | Double Play |
| FC | Fielder's Choice |
| WP | Wild Pitch |
| PB | Passed Ball |
| SF | Sacrifice Fly |
| SAC | Sacrifice Bunt |
| D3K | Dropped Third Strike |
| Force Play | Runner must advance because batter/other runner takes their base |
| Time Play | Non-force out where run can score if it crosses before tag |

---

*Update this document when new requirements are discovered or clarified.*
~~~

### Source File: specs/README.md

~~~markdown
# KBL Tracker - Specification Documents

> **Last Updated**: January 24, 2026

---

## üö® START HERE

### For AI Sessions

**Read these files IN ORDER before doing any work:**

1. **`CURRENT_STATE.md`** - What's implemented, what's not
2. **`AI_OPERATING_PREFERENCES.md`** - How to work on this project (NFL process, etc.)
3. **`IMPLEMENTATION_PLAN.md`** - The active 14-day sprint plan (Data-Flow-First methodology)
4. **`FEATURE_WISHLIST.md`** - 124 known gaps from spec-to-implementation audit

### Critical Context

- **IMPLEMENTATION_PLAN.md is the active plan** - Uses Data-Flow-First methodology
- **Original "completed" days are being re-evaluated** - Many engines are orphaned
- **124 gaps identified** - See FEATURE_WISHLIST.md for full audit results

---

## üìÅ Document Categories

### Session Management (Check Every Session)

| Document | Purpose |
|----------|---------|
| `CURRENT_STATE.md` | What's implemented now |
| `SESSION_LOG.md` | Work session history |
| `IMPLEMENTATION_PLAN.md` | Active sprint plan |
| `FEATURE_WISHLIST.md` | Known gaps and missing features |
| `AI_OPERATING_PREFERENCES.md` | How AI should work on this project |
| `DECISIONS_LOG.md` | Key design decisions |

### Master Reference

| Document | Purpose |
|----------|---------|
| `KBL_XHD_TRACKER_MASTER_SPEC_v3.md` | Comprehensive spec (idea bank, not source of truth for implementation) |
| `MASTER_SPEC_ERRATA.md` | Corrections to master spec |

### Core Game Logic Specs

| Document | Purpose |
|----------|---------|
| `BASEBALL_STATE_MACHINE_AUDIT.md` | Game state transitions |
| `MASTER_BASEBALL_RULES_AND_LOGIC.md` | Baseball rules reference |
| `RUNNER_ADVANCEMENT_RULES.md` | Base running logic |
| `SUBSTITUTION_FLOW_SPEC.md` | Player substitutions |
| `FIELDING_SYSTEM_SPEC.md` | Fielding mechanics |

### WAR Calculation Specs

| Document | Purpose |
|----------|---------|
| `ADAPTIVE_STANDARDS_ENGINE_SPEC.md` | League baselines, replacement level |
| `BWAR_CALCULATION_SPEC.md` | Batting WAR |
| `PWAR_CALCULATION_SPEC.md` | Pitching WAR |
| `FWAR_CALCULATION_SPEC.md` | Fielding WAR |
| `RWAR_CALCULATION_SPEC.md` | Baserunning WAR |
| `MWAR_CALCULATION_SPEC.md` | Manager WAR |
| `LEVERAGE_INDEX_SPEC.md` | Leverage calculation |
| `CLUTCH_ATTRIBUTION_SPEC.md` | Clutch situations |

### Game System Specs

| Document | Purpose |
|----------|---------|
| `FAME_SYSTEM_TRACKING.md` | Fame implementation status |
| `SPECIAL_EVENTS_SPEC.md` | Special game events |
| `MILESTONE_SYSTEM_SPEC.md` | Career milestones |
| `MOJO_FITNESS_SYSTEM_SPEC.md` | Mojo/Fitness/PED systems |
| `SALARY_SYSTEM_SPEC.md` | Player salary calculations |
| `FAN_MORALE_SYSTEM_SPEC.md` | Fan morale engine |
| `NARRATIVE_SYSTEM_SPEC.md` | Beat reporter system |
| `OFFSEASON_SYSTEM_SPEC.md` | Off-season mechanics |
| `TRADE_SYSTEM_SPEC.md` | Trade system |
| `FRANCHISE_MODE_SPEC.md` | Multi-franchise saves |
| `PLAYOFF_SYSTEM_SPEC.md` | Playoffs and brackets |

### Statistics Specs

| Document | Purpose |
|----------|---------|
| `STAT_TRACKING_ARCHITECTURE_SPEC.md` | 4-layer stat system |
| `PITCHER_STATS_TRACKING_SPEC.md` | Pitching stats |
| `INHERITED_RUNNERS_SPEC.md` | ER attribution |
| `PITCH_COUNT_TRACKING_SPEC.md` | Pitch counts |
| `EOS_RATINGS_ADJUSTMENT_SPEC.md` | End-of-season ratings |

### Reference Materials

| Document | Purpose |
|----------|---------|
| `SMB4_GAME_REFERENCE.md` | SMB4 mechanics reference |
| `smb4_traits_reference.md` | SMB4 player traits |
| `REQUIREMENTS.md` | User requirements |
| `TEST_MATRIX.md` | Testing strategy |

---

## üì¶ Archive Folder

The `archive/` folder contains superseded documents. **DO NOT use these as source of truth.**

Archived items include:
- Old implementation plans (v1)
- Old feature roadmaps
- Superseded spec versions (v1, v2)
- Historical audit reports

---

## üìä Data Folder

The `data/` folder contains:
- CSV templates for database schemas
- SMB4 baseline data
- Player/team data files

---

*For detailed spec index, see `SPEC_INDEX.md`*
~~~

### Source File: specs/CURRENT_STATE.md

~~~markdown
# KBL TRACKER ‚Äî CURRENT STATE
# Last updated: 2026-02-14 (codebase cleanup + architecture documentation)
---

## CODEBASE ARCHITECTURE (Read This First)

### Directory Layout
```
kbl-tracker/
‚îú‚îÄ‚îÄ src/                          # ALL source code (tsconfig include: ["src"])
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                   # Root router ‚Äî ALL routes import from src_figma/
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx                  # Vite entry point
‚îÇ   ‚îú‚îÄ‚îÄ src_figma/                # ACTIVE UI layer (Figma-designed components)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/            # 16 page components (all routed in App.tsx)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/       # ~50 UI components (modals, flows, overlays)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/            # Figma-layer type definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                # Figma-layer hooks (useFranchiseData, useMuseumData, etc.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ archived-docs/        # 11 stale migration docs (safe to ignore)
‚îÇ   ‚îú‚îÄ‚îÄ engines/                  # 36 game/stat engines (WAR, mojo, salary, playoffs, etc.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__/            # Engine unit tests
‚îÇ   ‚îú‚îÄ‚îÄ utils/                    # 38 storage + utility modules (IndexedDB, game processing)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                    # 16 shared hooks (WAR, stats, aging, morale, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ types/                    # 4 shared type files (game.ts, franchise.ts, war.ts, index.ts)
‚îÇ   ‚îú‚îÄ‚îÄ context/                  # AppContext.tsx + appStateStorage.ts
‚îÇ   ‚îú‚îÄ‚îÄ components/               # 7 active items (GameTracker/ + 6 shared components)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GameTracker/          # 31 files ‚Äî core game tracking UI
‚îÇ   ‚îú‚îÄ‚îÄ tests/                    # 3 test files (logic matrix, state machine)
‚îÇ   ‚îú‚îÄ‚îÄ styles/                   # global.css
‚îÇ   ‚îú‚îÄ‚îÄ pages/                    # Only NotFound.tsx is routed (imported by App.tsx)
‚îÇ   ‚îú‚îÄ‚îÄ archived-pages/           # 20 dead legacy pages (252K)
‚îÇ   ‚îú‚îÄ‚îÄ archived-components/      # 35 dead components (372K)
‚îÇ   ‚îú‚îÄ‚îÄ archived-hooks/           # 3 dead hooks (16K)
‚îÇ   ‚îî‚îÄ‚îÄ archived-tests/           # 8 orphan test files (124K)
‚îú‚îÄ‚îÄ spec-docs/                    # Project documentation (263MB, mostly SMB4 images)
‚îÇ   ‚îú‚îÄ‚îÄ archive/                  # 119 archived docs (completed work, superseded versions)
‚îÇ   ‚îú‚îÄ‚îÄ stories/                  # 14 user story files by feature area
‚îÇ   ‚îú‚îÄ‚îÄ testing/                  # 6 testing pipeline docs + API maps
‚îÇ   ‚îú‚îÄ‚îÄ canonical/                # Auto-generated architecture docs
‚îÇ   ‚îú‚îÄ‚îÄ ralph/                    # Phased implementation roadmap
‚îÇ   ‚îú‚îÄ‚îÄ data/                     # CSV data files + import scripts
‚îÇ   ‚îî‚îÄ‚îÄ [~50 active spec docs]   # Feature specs, Figma specs, system specs
‚îú‚îÄ‚îÄ public/                       # Static assets
‚îú‚îÄ‚îÄ vite.config.ts                # Vite + Vitest config (@ alias ‚Üí src/src_figma)
‚îú‚îÄ‚îÄ tsconfig.app.json             # TS config (@ paths ‚Üí src/src_figma/*)
‚îî‚îÄ‚îÄ package.json
```

### Key Architecture Rules
1. **All routes** are in `App.tsx` and import exclusively from `src/src_figma/app/pages/`
2. **Vite alias `@`** resolves to `src/src_figma` (configured in both vite.config.ts and tsconfig.app.json)
3. **384+ cross-imports** from src_figma ‚Üí src/ for engines, utils, types, hooks (this is correct ‚Äî src/ is the shared business logic layer)
4. **IndexedDB** is the persistence layer ‚Äî unified via `src/utils/trackerDb.ts`
5. **No mock data** in production paths ‚Äî all removed during prior audit
6. **archived-*/ folders** contain dead code preserved for reference ‚Äî NOT imported anywhere
7. **UI boundary rule:** `src/src_figma/` is the active UI. `src/components/`, `src/pages/`, and other legacy UI paths under `src/` are legacy and must only be used when explicitly invoked by `src/src_figma` integration points. Do not treat legacy UI paths as primary runtime UI.

### Type Duplication (Known, Deferred)
- `src/types/game.ts` (1576 lines) vs `src/src_figma/app/types/game.ts` (1572 lines) ‚Äî differ by FAILED_ROBBERY constant
- `src/types/war.ts` is identical to `src/src_figma/app/types/war.ts`
- `src/types/index.ts` (119 lines) vs `src/src_figma/app/types/index.ts` (78 lines)
- Consolidation requires updating import paths across 384+ files ‚Äî deferred to dedicated session

---
## BUILD STATUS
| Metric | Value |
|--------|-------|
| Build | PASSING (exit 0) |
| Tests | 5,653 passing / 0 failing / 134 files |
| Logic Matrix | 480/480 pass |
| Console errors | 0 (verified across full franchise UI) |
---
## MANUAL TESTING BUG FIX STATUS ‚Äî ALL TIERS COMPLETE ‚úÖ

Source: `MANUAL_TESTING_BUG_FIX_PLAN.md` (35 issue IDs, 28 commits)

### Tier 0: Game-Breaking (9 commits)
| ID | Issue | Fix | Commit |
|----|-------|-----|--------|
| T0-01 | End-of-game not triggered | Auto game-end detection at regulation end | c52b685 |
| T0-02 | Pitcher doesn't switch at half-inning | Wire pitcher swap in half-inning transition | 2d689cb |
| T0-03 | 3rd out on basepaths doesn't end half-inning | CS/pickoff/TOOTBLAN trigger half-inning end | 1ecca6b |
| T0-04 | Error (E) selection dead-ends | Wire error flow position buttons to recordError() | 06d075d |
| T0-05 | Game results don't persist to franchise | Played games persist to standings/schedule | 7e7b363 |
| T0-06 | Fresh franchise has pre-completed games | (Addressed by T0-05 persistence fix) | ‚Äî |
| T0-07/11/12 | Hardcoded Tigers/Sox team names | Dynamic team names throughout | db5ba24 |
| T0-08 | Franchise roster not loaded into GameTracker | handlePlayGame passes real IndexedDB rosters | f7f573f |
| T0-09 | Phantom bullpen stats | Zero out hardcoded mock data in fallback rosters | a8b3a0c |
| T0-15 | Post-game shows 9-inning header always | Dynamic numInnings from inningScores.length | 91911ba |

### Tier 1: Wrong Results (6 commits)
| ID | Issue | Fix | Commit |
|----|-------|-----|--------|
| T1-02/03/04 | Runner identity bugs | getBaseRunnerNames() sync from tracker + version counter | 8b8505c |
| T1-05 | Fielding inference wrong | Auto-infer credits from fieldingSequence, skip modal | 21aa89c |
| T1-06 | Error prompt on OUT plays | Clear stale React state + local variable for check | 02876e5 |
| T1-08 | Stats doubled in post-game | Idempotency guards in completeGameInternal + endGame | ba382fe |
| T1-09 | Mojo/Fitness factors | VERIFIED CORRECT ‚Äî no fix needed | N/A |
| T1-10 | Pitcher rotation in SIM | Rotation cycling, closer usage, save/hold detection | 8c52ba8 |
| T1-11 | SMB4 traits made-up | Replaced 32 fake traits with 63 real SMB4 traits | 0bd310c |

### Tier 2: Missing Wiring (6 commits + 5 already resolved)
| ID | Issue | Fix | Commit |
|----|-------|-----|--------|
| T2-01 | Mock data in displays | mockData.ts orphaned/unused ‚Äî already resolved | ‚Äî |
| T2-02 | Lineup card not reactive | Dynamic reactive data flow ‚Äî already resolved | ‚Äî |
| T2-03 | Beat writers empty | Shows empty state (expected ‚Äî feature not built) | ‚Äî |
| T2-04 | Salaries all $0.0 | computeInitialSalary() at franchise init | b17d025 |
| T2-05 | Team Hub no player stats | Derive correct seasonId from franchiseData | 0e5c288 |
| T2-06 | SIM box scores empty | Data pipeline complete ‚Äî already resolved | ‚Äî |
| T2-07 | No narratives in news tab | Generate on-the-fly from recent games | 951c6f2 |
| T2-08 | Manager decisions not wired | Fully wired ‚Äî already resolved | ‚Äî |
| T2-09 | Immaculate inning no popup | Wire confirmPitchCount to fameTrackingHook | 11e7a9c |
| T2-10 | Duplicate positions in lineup | 3-pass greedy position-fill algorithm | efe0d43 |
| T2-11 | Errors not on MiniScoreboard | Add awayErrors/homeErrors to MiniScoreboard | 24692ab |

### Tier 3: Feature Builds (7 commits)
| ID | Issue | Fix | Commit |
|----|-------|-----|--------|
| T3-01 | No pre-game lineup screen | PreGameData overlay with lineup preview + starter picker | 498e4be |
| T3-02 | View Roster button dead | Wire useNavigate to league-builder/rosters | e252ccb |
| T3-03 | No way to remove games | Delete button + inline confirm on scheduled games | acfb04b |
| T3-04 | Museum data pipeline empty | museumPipeline.ts auto-populate AllTimeLeaders from career data | c74d4c7 |
| T3-05 | SMB4 name verification | Audited all name pools ‚Äî 100% real SMB4 names | 1725882 |
| T3-06 | No milestone watch UI | MilestoneWatchPanel component in pre-game overlay | 9f6f362 |
| T3-07 | fWAR/rWAR no display columns | Added to BattingSortKey, useFranchiseData, SeasonLeaderboards | 8348962 |

### All Runtime UNVERIFIED ‚Äî Awaiting Manual Testing
All fixes pass build + tests but need browser verification.

---
## WHAT WORKS END-TO-END (Verified in Browser)
### Regular Season ‚úÖ
- Franchise creation wizard (6 steps, SMB4 import, 20 teams)
- Schedule generation (configurable games per team)
- GameTracker: play games with real players, baserunner logic, scoring
- SIM 1 GAME: animated play-by-play via syntheticGameFactory
- SKIP 1 GAME: removes game from schedule
- Batch SIM/SKIP: 1 game / 1 day / 1 week / rest of season
- Standings: all 20 teams, 4 divisions, real W-L, games back
- Schedule: real team names, real stadium names from IndexedDB
- Today's Game: real team records from standings
### Playoffs ‚úÖ
- Conference-aware seeding via playoffEngine.qualifyTeams()
- Interactive seeding wizard (PlayoffSeedingFlow)
- Bracket generation from real standings
- PLAY playoff games via GameTracker
- SIM playoff games (same pipeline as regular season SIM)
- Auto series advancement
- Championship completion + persistence to IndexedDB
### Champion Celebration ‚úÖ
- SeasonEndFlow with confetti + PostseasonMVPFlow card-reveal
- Real team name, real series result
### Offseason ‚úÖ (11/11 phases walkable, 0 crashes, browser-verified)
- 11-phase state machine (offseasonStorage + IndexedDB)
- All 11 transitions verified: tab auto-selects, content renders, IndexedDB updates correctly
- Phase 1‚Äì11 all functional (see SESSION_LOG for detailed verification)
- "START SEASON N+1" button appears after Phase 11 completion
### Season Advancement ‚úÖ
- seasonTransitionEngine: age players, recalculate salaries, reset mojo, clear stats
- Both advancement paths aligned (handleStartNewSeason + FinalizeAdvanceFlow)
- Career stats preserved across transitions
### Infrastructure ‚úÖ
- Unified IndexedDB via trackerDb.ts (resolved v2/v3 version deadlock)
- Real stadium names from IndexedDB (stadiumData.ts deleted)
- All 84 franchise handlers wired (0 stubs, 0 broken)
- 0 Math.random() fake stats, 0 hardcoded MLB names
- Player salaries computed from ratings at franchise init
- Errors displayed in MiniScoreboard
- fWAR/rWAR visible in league leaders
- Museum auto-populates from career data
- Milestone watches shown in pre-game overlay
- Post-game scoreboard adapts to actual inning count
---
## REMAINING ISSUES (Not Part of Bug Fix Plan)
### Deferred Placeholders (Not Broken)
1. Farm Reconciliation ‚Äî placeholder "coming soon"
2. Chemistry Rebalancing ‚Äî placeholder "coming soon"
3. Contraction/Expansion ‚Äî placeholder "coming soon"
### Feature Gaps (Pre-Existing, Not Regressions)
4. Mojo/Fitness not shown in scoreboard ‚Äî usePlayerState wired, MiniScoreboard lacks display
5. PostGameSummary data gaps ‚Äî errors hardcoded to 0, no batting box score
6. Inning summary ‚Äî NOT BUILT in Figma layer (legacy component not ported)
7. Exit type requires double entry (BUG-006) ‚Äî UX flow issue
8. No lineup access in GameTracker (BUG-009) ‚Äî no modal to view/edit lineup during game
9. Special plays not logged (BUG-014) ‚Äî no fame/activity log for diving catches, robberies
10. Fan Morale ‚Äî engine built + wired, no visible UI display
11. Park Factors ‚Äî used in bWAR/pWAR calculators, no standalone UI
12. Manager tracking ‚Äî empty state (feature not built)
13. Clutch Calculator ‚Äî hook exists but NOT imported in active Figma GameTracker
14. Performance optimization (P6-005) pending
15. Phase 3-11 automated tests not started
### Data Integrity (21/21 RESOLVED ‚Äî see DATA_INTEGRITY_FIX_REPORT.md)
- Batches 1A-i through F3 all complete (Feb 12, 2026)
- Includes: WPA system, substitution validation, autoCorrectResult, walk-off, isPlayoff, SB/CS in WAR
---
## KEY ARCHITECTURAL DECISIONS
| Decision | Rationale | Date |
|----------|-----------|------|
| Unified IndexedDB (trackerDb.ts) | v2/v3 version deadlock caused silent SIM failures | 2026-02-11 |
| Empty state over mock data | Honest "no data" better than fake stats | 2026-02-11 |
| WAR-based ratings adjustments | Replaced Math.random() with performance-based formula | 2026-02-12 |
| Contraction/Expansion deferred | 1,310 lines of stub; placeholder until real design | 2026-02-12 |
| Both advancement paths aligned | handleStartNewSeason + FinalizeAdvanceFlow do identical ops | 2026-02-12 |
| Museum auto-populate from career | museumPipeline.ts bridges careerStorage ‚Üí museumStorage | 2026-02-14 |
| Milestone watch non-blocking | Async IIFE in handlePlayGame, doesn't block game start | 2026-02-14 |
---
## FILE INVENTORY (Key Files)
### Core Infrastructure
- `src/utils/trackerDb.ts` ‚Äî unified IndexedDB initializer
- `src/utils/processCompletedGame.ts` ‚Äî game result orchestrator
- `src/utils/syntheticGameFactory.ts` ‚Äî deterministic game generation
- `src/utils/seasonTransitionEngine.ts` ‚Äî 8 season transition operations
- `src/utils/franchiseInitializer.ts` ‚Äî franchise creation + schedule gen
- `src/utils/museumPipeline.ts` ‚Äî career ‚Üí museum data bridge
### Storage Layer
- `src/utils/gameStorage.ts` ‚Äî per-game stats
- `src/utils/seasonStorage.ts` ‚Äî season aggregates
- `src/utils/careerStorage.ts` ‚Äî career stats (survive transitions)
- `src/utils/playoffStorage.ts` ‚Äî playoff bracket, series, champion
- `src/utils/offseasonStorage.ts` ‚Äî 11-phase state machine
- `src/utils/leagueBuilderStorage.ts` ‚Äî teams, players, rosters
### Franchise UI
- `FranchiseHome.tsx` ‚Äî main franchise hub
- `FranchiseSetup.tsx` ‚Äî creation wizard
- `SimulationOverlay.tsx` ‚Äî SIM animation
- `SeasonEndFlow.tsx` ‚Äî champion celebration
- `FinalizeAdvanceFlow.tsx` ‚Äî season transition UI
- `WorldSeries.tsx` ‚Äî playoff bracket display
- `MilestoneWatchPanel.tsx` ‚Äî approaching milestones in pre-game
### Offseason Flows
- `AwardsCeremonyFlow.tsx` ‚Äî 13 award sub-screens
- `RatingsAdjustmentFlow.tsx` ‚Äî WAR-based ratings
- `ContractionExpansionFlow.tsx` ‚Äî placeholder
- `RetirementFlow.tsx` ‚Äî retirement + roster removal
- `FreeAgencyFlow.tsx` ‚Äî FA signings + roster transfers
- `DraftFlow.tsx` ‚Äî dynamic prospects + roster addition
- `TradeFlow.tsx` ‚Äî full trade interface
- `SpringTrainingFlow.tsx` ‚Äî career phase projections
- `PlayoffSeedingFlow.tsx` ‚Äî interactive seeding wizard
- `PostseasonMVPFlow.tsx` ‚Äî MVP card-reveal
### New Files (This Bug Fix Cycle)
- `src/utils/museumPipeline.ts` ‚Äî career ‚Üí museum auto-populate
- `src/src_figma/app/components/MilestoneWatchPanel.tsx` ‚Äî milestone watch UI
~~~

## Standard Baseball Rules + Custom Depth (Every Stat, Outcome, Edge Case)

### Source File: specs/MASTER_BASEBALL_RULES_AND_LOGIC.md

~~~markdown
# Master Baseball Rules & Logic Reference
## KBL XHD Tracker - Comprehensive Baseball Rules Document

**Version:** 1.0  
**Created:** January 2026  
**Purpose:** Authoritative reference for implementing baseball logic in the KBL XHD Tracker application

---

## Table of Contents

1. [Game Structure](#1-game-structure)
2. [Scoring Runs](#2-scoring-runs)
3. [At-Bat Results](#3-at-bat-results)
4. [Batted Ball Types](#4-batted-ball-types)
5. [Outs and Force Plays](#5-outs-and-force-plays)
6. [Base Running](#6-base-running)
7. [Situational Rules](#7-situational-rules)
8. [Statistical Calculations](#8-statistical-calculations)
9. [Rare Events & Special Achievements](#9-rare-events--special-achievements)
10. [Fielding Positions](#10-fielding-positions)
11. [Lineup & Strategy](#11-lineup--strategy)
12. [Application Logic Rules](#12-application-logic-rules)

---

## 1. Game Structure

### Basic Game Format
- **Innings:** Standard game is 9 innings
- **Half-Innings:** Each inning has a top (away team bats) and bottom (home team bats)
- **Outs per Half-Inning:** 3 outs end a half-inning
- **Winning:** Team with most runs after 9 innings wins; extra innings if tied

### Batting Order
- 9 batters in fixed order
- Order cycles continuously throughout the game
- In leagues with DH: 9 batters, pitcher does not bat
- Without DH: Pitcher typically bats 9th

---

## 2. Scoring Runs

### Basic Run Scoring
A run scores when a runner legally touches all bases (1st ‚Üí 2nd ‚Üí 3rd ‚Üí Home) before 3 outs are recorded.

### CRITICAL: Third Out Exceptions
**A run does NOT score if the third out is made by:**

1. **Batter-runner out before reaching first base**
   - Any out at first on the batter ends the inning; no runs score on that play

2. **ANY force out** ‚ö†Ô∏è IMPORTANT
   - A force out for the third out NEGATES ALL RUNS on that play
   - Timing does NOT matter - even if runner crosses home before the force out
   - Example: Runner on 3rd, runner on 1st, 2 outs. Ground ball to SS, throw to 2B for force out. Even if R3 crossed home first, the run does NOT count.

3. **Appeal play on preceding runner**
   - If a runner misses a base and is appealed out as the third out

### When Runs CAN Score on Third Out (Time Plays)
- If the third out is a TAG OUT (not a force out), timing matters
- Run counts if runner crosses home BEFORE the tag is applied
- Example: R3, R1, 1 out. Fly ball caught (2 outs). R1 doesn't tag up, thrown out at 1st (tag play). If R3 tagged and scored before throw reached 1st, run counts.

### RBI (Run Batted In) Rules

**RBI IS credited for:**
- Safe hits that score runners
- Sacrifice flies (runner scores from 3rd on caught fly ball)
- Sacrifice bunts that score runners
- Walks/HBP with bases loaded (forces in a run)
- Fielder's choice where runner scores (if runner was going home)
- Ground outs that score runners (if not a double play)

**RBI is NOT credited for:**
- Runs scoring on errors
- Runs scoring on double plays
- Runs scoring on wild pitches/passed balls (unless bases loaded walk/HBP)
- Runs scoring due to balk

---

## 3. At-Bat Results

### Hits

| Result | Code | Description | Bases Reached |
|--------|------|-------------|---------------|
| Single | 1B | Batter reaches 1st safely on hit | 1 |
| Double | 2B | Batter reaches 2nd safely on hit | 2 |
| Triple | 3B | Batter reaches 3rd safely on hit | 3 |
| Home Run | HR | Batter circles all bases, scores | 4 |

### Outs (Batter is Out)

| Result | Code | Description | Ball in Play? |
|--------|------|-------------|---------------|
| Strikeout | K | Batter strikes out swinging | No |
| Strikeout Looking | KL | Batter strikes out called | No |
| Ground Out | GO | Out on ground ball | Yes |
| Fly Out | FO | Out on fly ball to outfield | Yes |
| Line Out | LO | Out on line drive | Yes |
| Pop Out | PO | Out on popup to infield | Yes |

### Special Results

| Result | Code | Description | At-Bat? | Notes |
|--------|------|-------------|---------|-------|
| Sacrifice Fly | SF | Fly out that scores runner from 3rd | No | Requires runner on 3rd, <2 outs |
| Sacrifice Bunt | SAC | Bunt that advances runner, batter out | No | Requires runner(s), <2 outs |
| Double Play | DP | Two outs recorded on one play | Yes | Requires runner(s), <2 outs |
| Fielder's Choice | FC | Batter reaches, runner put out | Yes | Fielder chose to retire runner |
| Dropped 3rd Strike | D3K | Batter reaches on uncaught K | Yes | Special conditions apply |
| Error | E | Batter reaches on fielding error | Yes | Error charged to fielder |
| Walk | BB | Four balls, batter to 1st | No | - |
| Intentional Walk | IBB | Intentional four balls | No | - |
| Hit By Pitch | HBP | Batter hit by pitch | No | - |

---

## 4. Batted Ball Types

### Classification by Launch Angle

| Type | Launch Angle | Description |
|------|--------------|-------------|
| Ground Ball | Below 10¬∞ | Ball contacts ground shortly after hit |
| Line Drive | 10¬∞ - 25¬∞ | Ball hit in nearly straight line |
| Fly Ball | 25¬∞+ (outfield) | Arcing ball to outfield |
| Pop Up | 25¬∞+ (infield) | Arcing ball stays in infield |

### Hit Probability by Type
- **Line Drive:** ~72.5% chance of hit (BEST for hitters)
- **Fly Ball:** ~27% chance of hit
- **Ground Ball:** Low hit probability, but avoids double plays less than fly balls
- **Pop Up:** Almost always an out (<1% hit rate)

### League Averages (Approximate)
- Ground Balls: 44%
- Fly Balls: 35%
- Line Drives: 21%
- Infield Fly Balls (of total FB): 11%

---

## 5. Outs and Force Plays

### Force Out Definition
A force out occurs when a runner is REQUIRED to advance because the batter became a runner. The defense can retire the runner by touching the base before the runner arrives.

**Force situations:**
- Runner on 1st MUST advance when batter hits ball
- Runner on 2nd MUST advance only if runner on 1st is also forced
- Runner on 3rd MUST advance only if runners on 1st and 2nd are also forced

### Force Out vs Tag Out - Critical Distinction

| Situation | Type | Run Scores on 3rd Out? |
|-----------|------|------------------------|
| Runner thrown out at base they're forced to | Force Out | NO - Never |
| Runner tagged between bases on force play | Force Out | NO - Never |
| Runner tagged after passing force base | Tag Out | YES - if timed correctly |
| Runner tagged on non-force advancement | Tag Out | YES - if timed correctly |

### Double Play Types

| Code | Description | Common Situation |
|------|-------------|------------------|
| 6-4-3 | SS ‚Üí 2B ‚Üí 1B | Most common, ball to SS |
| 4-6-3 | 2B ‚Üí SS ‚Üí 1B | Ball hit toward 2B |
| 5-4-3 | 3B ‚Üí 2B ‚Üí 1B | "Around the horn" |
| 3-6-3 | 1B ‚Üí SS ‚Üí 1B | Ball to 1B, back to 1B |
| 6-3 | SS ‚Üí 1B (unassisted at 2B) | SS steps on 2B, throws to 1B |
| 4-3 | 2B ‚Üí 1B (unassisted at 2B) | 2B steps on 2B, throws to 1B |
| 1-6-3 | P ‚Üí SS ‚Üí 1B | Ball hit to pitcher |
| 1-4-3 | P ‚Üí 2B ‚Üí 1B | Ball hit to pitcher |

### DP Requirements
- Less than 2 outs
- At least one runner on base
- If 2 outs, cannot turn DP (would be 3rd and 4th out)

---

## 6. Base Running

### Stolen Base Rules

**When a stolen base IS credited:**
- Runner advances on pitch without ball being batted
- Runner was attempting to steal (not just taking extra base on WP/PB)

**When a stolen base is NOT credited:**
- Runner advances on wild pitch or passed ball (unless was already stealing)
- Runner advances due to fielding error
- Another runner attempting to steal on same play is thrown out

### Caught Stealing
- Runner is tagged out while attempting to steal
- Runner is thrown out attempting to advance on pitch
- NOT charged if runner is picked off while returning to base (unless runner feinted toward next base)

### Pickoff Rules (2023+ MLB)
- Pitchers limited to 2 disengagement attempts per plate appearance
- After 2 attempts, must either pitch or successfully pick off runner
- Failed 3rd attempt = balk, runners advance

### Tag Up Rule
**On caught fly balls:**
- Runners MUST return to ("tag") their original base
- After ball is touched by fielder, runner may attempt to advance
- If runner leaves early and ball is caught, runner can be doubled off by throw to original base
- This is an APPEAL PLAY, not automatic

**Tag up considerations:**
- Deep fly balls: Runners often advance (especially from 3rd = Sac Fly)
- Shallow fly balls: Runners rarely attempt to advance
- Line drives: Very risky to advance

---

## 7. Situational Rules

### Dropped Third Strike (D3K)

**Batter may attempt to reach first when:**
1. First base is UNOCCUPIED, OR
2. There are 2 OUTS (regardless of runners)

**Batter may NOT run when:**
- First base is OCCUPIED and less than 2 outs
- Reason: Prevents catcher from intentionally dropping to turn DP

**Recording:**
- K + WP (Wild Pitch) if pitch was uncatchable
- K + PB (Passed Ball) if catcher should have caught it
- K + E2 if catcher error on catchable pitch

### Infield Fly Rule

**Conditions (ALL must be met):**
1. Less than 2 outs
2. Runners on 1st and 2nd, OR bases loaded
3. Fair fly ball (not line drive, not bunt)
4. Can be caught with "ordinary effort"

**Effect:**
- Batter is OUT immediately (whether caught or not)
- Removes force play on runners
- Runners may advance at their own risk

**Does NOT apply:**
- With only runner on 1st (no advantage to defense)
- With 2 outs
- On bunts
- On line drives

### Sacrifice Fly (SF) Requirements
1. Less than 2 outs
2. Runner on 3rd base
3. Fly ball is caught (out recorded)
4. Runner from 3rd scores after tagging up

**Special case:** If outfielder drops catchable ball and run scores, SF is still credited (plus error to fielder)

### Sacrifice Bunt (SAC) Requirements
1. Less than 2 outs
2. Runner(s) on base
3. Batter bunts
4. Batter is put out at first
5. At least one runner advances

**Scorer's judgment:** If batter appeared to be bunting for a hit (not sacrificing), charge as at-bat instead

---

## 8. Statistical Calculations

### Batting Statistics

**Batting Average (AVG)**
```
AVG = Hits / At-Bats
```
Good: .300+ | Average: .250 | Poor: Below .200

**On-Base Percentage (OBP)**
```
OBP = (H + BB + HBP) / (AB + BB + HBP + SF)
```
Good: .340+ | Elite: .400+

**Slugging Percentage (SLG)**
```
SLG = Total Bases / At-Bats
Total Bases = (1B√ó1) + (2B√ó2) + (3B√ó3) + (HR√ó4)
```
Good: .430+ | Elite: .550+

**OPS (On-base Plus Slugging)**
```
OPS = OBP + SLG
```
Above Average: .800+ | Excellent: .900+ | Elite: 1.000+

### Pitching Statistics

**ERA (Earned Run Average)**
```
ERA = (Earned Runs √ó 9) / Innings Pitched
```
Excellent: Below 3.00 | Good: 3.00-4.00 | Average: 4.00-5.00

**WHIP (Walks + Hits per Inning Pitched)**
```
WHIP = (Walks + Hits) / Innings Pitched
```
Elite: Below 1.00 | Good: 1.00-1.20 | Average: 1.20-1.40

### What Counts as an At-Bat?

**IS an At-Bat:**
- Hits (1B, 2B, 3B, HR)
- Outs (K, GO, FO, LO, PO)
- Fielder's Choice
- Errors (reaching on error)

**NOT an At-Bat:**
- Walks (BB, IBB)
- Hit By Pitch (HBP)
- Sacrifice Fly (SF)
- Sacrifice Bunt (SAC)
- Catcher's Interference

---

## 9. Rare Events & Special Achievements

### Pitching Achievements

| Achievement | Definition |
|-------------|------------|
| **Perfect Game** | Complete game, no batters reach base (no hits, walks, errors, HBP) |
| **No-Hitter** | Complete game with no hits allowed (walks/errors allowed) |
| **Shutout** | Complete game with no runs allowed |
| **Maddux** | Complete game shutout in under 100 pitches |
| **Quality Start** | 6+ innings, 3 or fewer earned runs |
| **Immaculate Inning** | 3 strikeouts on exactly 9 pitches |

### Batting Achievements

| Achievement | Definition |
|-------------|------------|
| **Cycle** | Single, Double, Triple, and Home Run in same game |
| **Natural Cycle** | Cycle achieved in order (1B, 2B, 3B, HR) |
| **Grand Slam** | Home run with bases loaded (4 RBI) |
| **Walk-Off** | Game-winning hit/play in bottom of final inning |

### Fielding Achievements

| Achievement | Definition |
|-------------|------------|
| **Unassisted Triple Play** | One fielder records all 3 outs on single play |
| **Triple Play** | 3 outs recorded on single play |

### Rarity Rankings
1. Unassisted Triple Play (rarest - 15 in modern era)
2. Perfect Game (24 in MLB history)
3. Immaculate Inning (116 total through 2024)
4. Cycle (~350 total in MLB history)
5. No-Hitter (more common, several per year)

---

## 10. Fielding Positions

### Position Numbers and Abbreviations

| # | Position | Abbrev | Location |
|---|----------|--------|----------|
| 1 | Pitcher | P | Mound |
| 2 | Catcher | C | Behind plate |
| 3 | First Baseman | 1B | First base |
| 4 | Second Baseman | 2B | Between 1B and 2B |
| 5 | Third Baseman | 3B | Third base |
| 6 | Shortstop | SS | Between 2B and 3B |
| 7 | Left Fielder | LF | Left outfield |
| 8 | Center Fielder | CF | Center outfield |
| 9 | Right Fielder | RF | Right outfield |

### Typical Fielder by Hit Direction

| Direction | Ground Ball | Fly Ball |
|-----------|-------------|----------|
| Left | 3B (5) or SS (6) | LF (7) |
| Left-Center | SS (6) | LF (7) or CF (8) |
| Center | SS (6) or 2B (4) | CF (8) |
| Right-Center | 2B (4) | CF (8) or RF (9) |
| Right | 1B (3) or 2B (4) | RF (9) |

---

## 11. Lineup & Strategy

### Batting Order Strategy

| Position | Traditional Role | Key Attributes |
|----------|-----------------|----------------|
| 1 (Leadoff) | Get on base | High OBP, speed, plate discipline |
| 2 | Move runners, contact | Bat control, can hit-and-run |
| 3 | Best overall hitter | High AVG, good power |
| 4 (Cleanup) | Primary power | Most HRs/RBIs, drives in runs |
| 5 | Secondary power | "Protects" cleanup hitter |
| 6 | Second leadoff | Some OBP, bridge to bottom |
| 7-8 | Weaker hitters | Varies by team |
| 9 | Pitcher (no DH) or speedy player (with DH) | - |

### RISP (Runners in Scoring Position)
- Runner on 2nd or 3rd base
- Key stat: BA/RISP (batting average with RISP)
- Critical situations: 2 outs + RISP

### Clutch Situations
Typically defined as:
- Late innings (7th+)
- Close game (within 2 runs)
- RISP situations
- Walk-off opportunities (home team, final inning, tied or down by ‚â§ run differential that can be overcome)

---

## 12. Application Logic Rules

### Smart Defaults & Auto-Corrections

#### Exit Type Defaults
| Result | Default Exit Type |
|--------|------------------|
| GO | Ground |
| DP | Ground |
| FO | Fly Ball |
| SF | Fly Ball |
| LO | Line Drive |
| PO | Pop Up |

#### Fielder Inference by Direction
| Direction | GO/DP | FO | LO | PO |
|-----------|-------|----|----|-----|
| Left | 5 (3B) | 7 (LF) | 5 or 7 | 5 (3B) |
| Left-Center | 6 (SS) | 7 (LF) | 6 or 7 | 6 (SS) |
| Center | 6 (SS) | 8 (CF) | 1 or 8 | 6 or 4 |
| Right-Center | 4 (2B) | 9 (RF) | 4 or 9 | 4 (2B) |
| Right | 3 (1B) | 9 (RF) | 3 or 9 | 3 (1B) |

#### Runner Advancement Defaults
| Result | R1 Default | R2 Default | R3 Default |
|--------|------------|------------|------------|
| 1B | To 2B | To 3B | Scores |
| 2B | To 3B | Scores | Scores |
| 3B | Scores | Scores | Scores |
| HR | Scores | Scores | Scores |
| BB/HBP | To 2B (if forced) | To 3B (if forced) | Scores (if forced) |
| GO/FO/LO/PO | Held | Held | Held |
| SF | Held | Held | Scores |
| DP | Out at 2B | To 3B | Held |

### Button Availability Rules

| Button | Disabled When |
|--------|---------------|
| SAC | 2 outs (batter out = inning over, no sacrifice possible) |
| SF | 2 outs OR no runner on 3rd |
| DP | 2 outs OR no runners on base |
| D3K | 1st base occupied AND less than 2 outs |

### Auto-Correction Logic

| User Input | Condition | Auto-Correct To |
|------------|-----------|-----------------|
| FO | R3 scores, <2 outs | SF |
| GO | Runner advances, <2 outs | Suggest SAC (don't auto-correct - requires intent) |

### Validation Rules

1. **Run Scoring on Force Out**
   - If result creates force out at any base for 3rd out
   - ALL runs on that play should be invalidated
   - Display warning if user tries to score run with force out for 3rd out

2. **SF Validation**
   - Cannot record SF with 2 outs
   - Must have runner on 3rd who scores
   - Auto-convert FO ‚Üí SF if conditions met

3. **DP Validation**
   - Cannot record DP with 2 outs
   - Must have at least 1 runner
   - Should track which runners are out

4. **D3K Validation**
   - Block if 1st occupied AND < 2 outs
   - Allow if 1st empty OR 2 outs

---

## Sources & References

### Official Rules
- [2025 Official Baseball Rules (MLB)](https://mktg.mlbstatic.com/mlb/official-information/2025-official-baseball-rules.pdf)
- [2024 Official Baseball Rules (MLB)](https://mktg.mlbstatic.com/mlb/official-information/2024-official-baseball-rules.pdf)
- [MLB Official Information](https://www.mlb.com/official-information)

### Scoring Rules
- [Baseball Scoring Rules - Sacrifices](https://baseballscoring.wordpress.com/site-index/sacrifices/)
- [Baseball Scoring Rules - RBIs](https://baseballscoring.wordpress.com/site-index/runs-batted-in/)
- [Baseball Scoring Rules - Stolen Bases](https://baseballscoring.wordpress.com/site-index/stolen-bases/)

### Force Plays & Run Scoring
- [Umpire Empire - Tag out vs Force out](https://umpire-empire.com/topic/81251-tag-out-vs-force-out-run-scoring/)
- [Baseball Rules Academy - Time Plays](https://baseballrulesacademy.com/multiple-ways-a-time-play-can-score-a-run/)
- [Steve the Ump - Scoring Runs](http://www.stevetheump.com/scoring_runs.htm)

### Statistics
- [FanGraphs - Batted Ball Stats](https://library.fangraphs.com/offense/batted-ball/)
- [FanGraphs - WHIP](https://library.fangraphs.com/pitching/whip/)
- [MLB Glossary](https://www.mlb.com/glossary)

### Special Rules
- [Dropped Third Strike - MLB](https://www.mlb.com/news/dropped-third-strike-strangest-baseball-rule)
- [Infield Fly Rule - MLB](https://www.mlb.com/news/the-infield-fly-rule-a-history-and-explanation)
- [Wikipedia - Force Play](https://en.wikipedia.org/wiki/Force_play)
- [Wikipedia - Tag Up](https://en.wikipedia.org/wiki/Tag_up)

### Achievements
- [Maddux Definition - MLB](https://www.mlb.com/glossary/idioms/maddux)
- [Immaculate Innings - MLB](https://www.mlb.com/news/immaculate-innings-c265720420)
- [Hitting for the Cycle - Wikipedia](https://en.wikipedia.org/wiki/Hitting_for_the_cycle)

---

## Implementation Status

The following rules from this document have been implemented in the KBL XHD Tracker:

| Rule | Section | Status | Implementation Doc |
|------|---------|--------|-------------------|
| Force out 3rd out negates runs | 2 | ‚úÖ Implemented | IMPLEMENTATION_GUIDE.md |
| RBI not credited on DP | 2 | ‚úÖ Implemented | AtBatFlow.tsx |
| Tag-up required on fly outs | 6 | ‚úÖ Implemented | IMPLEMENTATION_GUIDE.md |
| Infield Fly Rule conditions | 7 | ‚úÖ Indicator Added | IMPLEMENTATION_GUIDE.md |
| Fielder's Choice flow | 3 | ‚úÖ Implemented | IMPLEMENTATION_GUIDE.md |
| SAC requires runners | 3 | ‚úÖ Implemented | IMPLEMENTATION_GUIDE.md |
| Hit type statistics (2B/3B) | 8 | ‚úÖ Implemented | IMPLEMENTATION_GUIDE.md |
| Button availability rules | 12 | ‚úÖ Implemented | AtBatButtons.tsx |

**Related Documentation:**
- `TRACKER_LOGIC_AUDIT.md` - Audit of implementation vs rules
- `IMPLEMENTATION_GUIDE.md` - Technical implementation details
- `CHANGELOG.md` - History of changes

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Jan 2026 | Initial creation - comprehensive baseball rules reference |
| 1.1 | Jan 21, 2026 | Added implementation status section |

---

*This document serves as the authoritative reference for baseball logic implementation in the KBL XHD Tracker. All game logic, scoring, and statistical calculations should be validated against these rules.*
~~~

### Source File: specs/RUNNER_ADVANCEMENT_RULES.md

~~~markdown
# Runner Advancement Rules - Complete Reference
## What Movements Are Legally Possible in Baseball

**Created:** January 21, 2026
**Updated:** January 22, 2026
**Purpose:** Define ALL legal/illegal runner movements to prevent impossible UI states
**Integration:** FIELD_ZONE_INPUT_SPEC.md, INHERITED_RUNNERS_SPEC.md

---

## ‚ö†Ô∏è SMB4 Game Limitations

> **IMPORTANT:** Super Mega Baseball 4 does NOT implement all real baseball mechanics.
> The following events **DO NOT EXIST** in SMB4 and should NOT be tracked:

| Event | In SMB4? | Notes |
|-------|----------|-------|
| Balks | ‚ùå NO | No balk mechanic in game |
| Catcher Interference | ‚ùå NO | Not implemented |
| Infield Fly Rule | ‚úÖ YES | Called with R1+R2 or loaded, <2 outs |
| Ground Rule Double | ‚ö†Ô∏è RARE | May exist in some stadiums |
| Obstruction | ‚ùå NO | Not implemented |
| Dropped 3rd Strike | ‚úÖ YES | Batter can run to 1B if unoccupied (or 2 outs) |

**Events that ARE in SMB4:**
- Hits (1B, 2B, 3B, HR)
- Walks (BB, IBB)
- Hit By Pitch (HBP)
- Strikeouts (K)
- Ground outs, Fly outs, Line outs, Pop outs
- Double plays, Triple plays
- Fielder's Choice
- Errors (fielding and throwing)
- Wild Pitch / Passed Ball
- Stolen Bases / Caught Stealing
- Sacrifice Flies, Sacrifice Bunts

---

## Table of Contents

1. [Core Principle: Force Plays](#core-principle-force-plays)
2. [Walk/HBP/IBB Scenarios](#walkhbpibb-scenarios)
3. [Hit Scenarios](#hit-scenarios)
4. [Out Scenarios](#out-scenarios)
5. [Wild Pitch / Passed Ball](#5-wild-pitch--passed-ball)
6. [Stolen Bases](#6-stolen-bases)
7. [~~Balks~~](#7-balks) *(NOT IN SMB4)*
8. [Error Advancement](#8-error-advancement)
9. [Special Situations](#9-special-situations)
10. [Implementation Matrix](#implementation-matrix)

---

## Core Principle: Force Plays

### What is a Force?

A runner is **FORCED** to advance when:
- The batter becomes a runner (hit, walk, HBP, etc.)
- AND there is no empty base behind them

### The Chain Rule

Forces create a **chain** from 1st base forward:
- Batter ALWAYS forces R1 (runner on 1st)
- R1 forces R2 ONLY IF R1 is forced (i.e., batter reached)
- R2 forces R3 ONLY IF R2 is forced (i.e., R1 was forced)

### Key Insight

**A forced runner CANNOT stay on their current base.** They MUST either:
1. Advance to the next base safely
2. Be put out at the next base
3. Advance beyond the next base (if possible)

---

## Walk/HBP/IBB Scenarios

On a walk, HBP, or IBB, the batter is awarded 1st base. This creates MANDATORY forces.

### Scenario: Runner on 1st Only

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R1 | To 2B (forced) | ‚ùå Held 1B (impossible - batter takes 1B) |
| Batter | To 1B (automatic) | N/A |

**Implementation:** R1 auto-advances to 2B. No user choice needed.

### Scenario: Runners on 1st and 2nd

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R2 | To 3B (forced) | ‚ùå Held 2B (R1 is coming) |
| R1 | To 2B (forced) | ‚ùå Held 1B (batter takes 1B) |
| Batter | To 1B (automatic) | N/A |

**Implementation:** Both runners auto-advance. No user choice needed.

### Scenario: Bases Loaded

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R3 | Scores (forced) | ‚ùå Held 3B (R2 is coming) |
| R2 | To 3B (forced) | ‚ùå Held 2B (R1 is coming) |
| R1 | To 2B (forced) | ‚ùå Held 1B (batter takes 1B) |
| Batter | To 1B (automatic) | N/A |

**Implementation:** All runners auto-advance. R3 scores. No user choice needed.

### Scenario: Runner on 2nd Only

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R2 | Held 2B, To 3B | ‚ùå None - both are legal |
| Batter | To 1B (automatic) | N/A |

**Implementation:** R2 has a choice - they're NOT forced (no one behind them).

### Scenario: Runner on 3rd Only

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R3 | Held 3B, Scores | ‚ùå None - both are legal |
| Batter | To 1B (automatic) | N/A |

**Implementation:** R3 has a choice - they're NOT forced.

### Scenario: Runners on 1st and 3rd

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R3 | Held 3B, Scores | ‚ùå None - not forced (2B empty) |
| R1 | To 2B (forced) | ‚ùå Held 1B |
| Batter | To 1B (automatic) | N/A |

**Implementation:** R1 auto-advances. R3 has choice.

### Scenario: Runners on 2nd and 3rd

| Runner | Legal Options | Illegal Options |
|--------|---------------|-----------------|
| R3 | Held 3B, Scores | ‚ùå None - not forced |
| R2 | Held 2B, To 3B | ‚ùå None - not forced |
| Batter | To 1B (automatic) | N/A |

**Implementation:** Both runners have choices - neither is forced (1B was empty).

---

## Hit Scenarios

On hits, batter reaches base. Runners have more options but still obey force rules.

### Single (1B)

Batter reaches 1st. Creates force chain from 1st.

| Base State | R1 Options | R2 Options | R3 Options |
|------------|------------|------------|------------|
| R1 only | To 2B, To 3B, Scores, Out | N/A | N/A |
| R2 only | N/A | Held, To 3B, Scores, Out | N/A |
| R3 only | N/A | N/A | Held, Scores, Out |
| R1 + R2 | To 2B, To 3B, Scores, Out | To 3B, Scores, Out | N/A |
| R1 + R3 | To 2B, To 3B, Scores, Out | N/A | Held, Scores, Out |
| R2 + R3 | N/A | Held, To 3B, Scores, Out | Held, Scores, Out |
| Loaded | To 2B, To 3B, Scores, Out | To 3B, Scores, Out | Scores, Out |

**Key Rules for Singles:**
- R1 CANNOT hold (batter takes 1B) - must advance at least to 2B
- R2 can hold IF R1 is not coming to 2B (i.e., R1 went to 3B or scored or out)
- R3 can hold IF R2 is not coming to 3B

### Double (2B)

Batter reaches 2nd. R1 and R2 MUST vacate.

| Base State | R1 Options | R2 Options | R3 Options |
|------------|------------|------------|------------|
| R1 only | To 3B, Scores, Out | N/A | N/A |
| R2 only | N/A | To 3B, Scores, Out | N/A |
| R3 only | N/A | N/A | Held, Scores, Out |
| R1 + R2 | To 3B, Scores, Out | Scores, Out | N/A |
| R1 + R3 | To 3B, Scores, Out | N/A | Held, Scores, Out |
| R2 + R3 | N/A | Scores, Out | Held, Scores, Out |
| Loaded | Scores, Out | Scores, Out | Scores, Out |

**Key Rules for Doubles:**
- R1 CANNOT hold or go to 2B (batter takes 2B)
- R2 CANNOT hold (batter takes 2B)
- R3 can hold (no one forcing them)

### Triple (3B)

Batter reaches 3rd. R1, R2, R3 all MUST vacate (score or out).

| Base State | R1 Options | R2 Options | R3 Options |
|------------|------------|------------|------------|
| Any | Scores, Out | Scores, Out | Scores, Out |

**Key Rules for Triples:**
- ALL runners must score or be out - batter needs 3B clear

### Home Run (HR)

Everyone scores. No choices.

---

## Out Scenarios

### Ground Out (GO)

Batter is out at 1st. Force situation depends on play type.

**If batter out at 1st (normal GO):**
- No force on runners (batter didn't reach)
- Runners CAN hold
- Runners CAN advance (if they were running)
- Runners CAN be out (if throw beats them)

**If runner out on force (FC situation):**
- Batter reaches 1st
- Other runners follow single rules

### Fly Out (FO/LO/PO/SF)

Batter is out. Runners must TAG UP to advance.

| Situation | Runner Options |
|-----------|----------------|
| Didn't tag | Held, Doubled Off |
| Tagged | Held, Advance, Scored, Out (thrown out advancing) |

### Double Play (DP)

Two outs recorded. Usually force at 2B then throw to 1B.

**6-4-3 DP (SS to 2B to 1B):**
- R1 out at 2B (force)
- Batter out at 1B
- R2 and R3 may advance (no longer forced after R1 out)

### Strikeout (K)

Batter is out. Runners may advance at their own risk.

| Situation | Runner Options |
|-----------|----------------|
| Normal K | Held, Advance (steal attempt), Out |
| Dropped 3rd Strike | Batter can run to 1B if 1B unoccupied (or 2 outs) |
| K + Wild Pitch | See Wild Pitch section |

---

## 5. Wild Pitch / Passed Ball

Wild pitches (WP) and passed balls (PB) allow runners to advance at their own risk.

### 5.1 Basic Rules

- **No force** - runners choose to advance
- **Batter does NOT become a runner** (unless dropped 3rd strike)
- Any runner can attempt to advance
- Multiple runners can advance on same WP/PB

### 5.2 Advancement Options

| Runner | Options | Notes |
|--------|---------|-------|
| R1 | Held, To 2B, Out at 2B | Most common advance |
| R2 | Held, To 3B, Out at 3B | Depends on ball location |
| R3 | Held, Scores, Out at Home | Risky - catcher usually recovers |

### 5.3 UI Implementation

```typescript
interface WildPitchEvent {
  eventType: 'WP' | 'PB';
  pitcherId: string;      // WP charged to pitcher
  catcherId: string;      // PB charged to catcher

  // Each runner's outcome (optional advancement)
  runnerOutcomes: {
    from: '1B' | '2B' | '3B';
    outcome: 'HELD' | 'ADVANCED' | 'SCORED' | 'OUT';
    advancedTo?: '2B' | '3B' | 'HOME';
    putOutBy?: string[];  // Fielders involved if out
  }[];
}
```

### 5.4 Validation Rules

```typescript
function validateWildPitchAdvancement(outcomes) {
  const errors = [];

  // WP/PB never creates a force - all advances are optional
  // But can't advance past next base without extra error
  for (const outcome of outcomes) {
    if (outcome.from === '1B' && outcome.advancedTo === 'HOME') {
      // R1 scoring on WP alone is rare but possible
      errors.push('Warning: R1 scoring from 1B on WP is unusual - verify');
    }
  }

  // Can't have runner pass another runner
  // (handled by general validation)

  return errors;
}
```

---

## 6. Stolen Bases

### 6.1 Basic Rules

- Runner attempts to advance **during the pitch**
- Catcher throws to base to try for out
- Can occur on any pitch (even if batter makes contact)

### 6.2 Stolen Base Scenarios

| Scenario | Result | Runner Outcome |
|----------|--------|----------------|
| SB | Clean steal | Advanced to next base |
| CS | Caught stealing | Out |
| SB + E | Steal + throwing error | May advance extra base |
| Double Steal | Two runners steal | Both advance or one/both out |

### 6.3 Implementation

```typescript
interface StolenBaseEvent {
  eventType: 'SB' | 'CS';
  runnerId: string;
  fromBase: '1B' | '2B' | '3B';
  toBase: '2B' | '3B' | 'HOME';

  // CS details
  putOutBy?: string[];    // Usually C, fielder at base
  throwingError?: boolean;
  errorBy?: string;

  // SB details
  isDefensiveIndifference?: boolean;  // No SB credit if DI
}

// For double steals
interface DoubleStealEvent {
  eventType: 'DOUBLE_STEAL';
  runners: StolenBaseEvent[];
}
```

### 6.4 Special Cases

**Steal of Home:**
- Very rare
- Usually on squeeze play or delayed steal
- If batter interferes, runner is out

**Caught Stealing then Safe:**
- CS can be overturned to SB if throwing error allows runner to be safe
- Original call matters for stat attribution

---

## 7. ~~Balks~~ - NOT IN SMB4

> ‚ö†Ô∏è **This section is for reference only.** SMB4 does not have a balk mechanic.
> **DO NOT IMPLEMENT** balk tracking in the KBL tracker.

<details>
<summary>Real Baseball Reference (collapsed)</summary>

A balk is an illegal pitching motion that awards all runners one base.
- R1 ‚Üí 2B, R2 ‚Üí 3B, R3 ‚Üí Scores
- Not applicable to SMB4 tracking

</details>

---

## 8. Error Advancement

### 8.1 Types of Errors Affecting Advancement

| Error Type | Effect on Runners |
|------------|-------------------|
| Fielding error | Batter reaches, runners may advance |
| Throwing error | Runners may advance extra bases |
| Catcher error | Similar to passed ball |
| Dropped fly ball | Runners who tagged may advance |

### 8.2 Error on Batted Ball

When a fielder commits an error on a batted ball:

```typescript
interface ErrorOnBattedBall {
  eventType: 'E';
  fielderId: string;        // Who committed error
  errorType: 'FIELDING' | 'THROWING' | 'DROPPED_FLY';

  // What WOULD have happened without error
  projectedResult: 'OUT' | '1B' | '2B';

  // What actually happened
  batterReachedBase: '1B' | '2B' | '3B';

  // Runner outcomes (may get extra bases due to error)
  runnerOutcomes: RunnerOutcome[];
}
```

### 8.3 Throwing Error Advancement

When a throwing error occurs, runners get extra bases:

```typescript
function calculateErrorAdvancement(error, originalOutcome) {
  // Runner gets original advancement PLUS error advancement
  // Usually one extra base per throwing error

  if (error.type === 'THROWING') {
    // Allow advancement options up to 2 bases beyond normal
    return {
      minAdvance: originalOutcome.base,
      maxAdvance: Math.min(originalOutcome.base + 2, 'HOME')
    };
  }
}
```

### 8.4 UI Implications

- Show error icon on play result
- Allow extended advancement options
- Track which bases were reached due to error vs. normal play

---

## 9. Special Situations

### 9.1 ~~Catcher Interference~~ - NOT IN SMB4

> ‚ö†Ô∏è **Not implemented in SMB4.** Do not track.

### 9.2 Infield Fly Rule (IFR)

The infield fly rule IS in SMB4. Called when:
- Runners on 1st+2nd OR bases loaded
- Less than 2 outs
- Fair fly ball that can be caught by infielder with ordinary effort

**Effect:**
- Batter is OUT immediately (regardless of catch)
- Runners may advance at their own risk (NOT forced)

```typescript
interface InfieldFlyEvent {
  eventType: 'IFR';
  batterOutcome: 'OUT';  // Always out
  ballCaught: boolean;   // May or may not be caught

  // Runners not forced - can advance at own risk
  runnerOutcomes: {
    runnerId: string;
    fromBase: '1B' | '2B' | '3B';
    outcome: 'HELD' | 'ADVANCED' | 'OUT' | 'DOUBLED_OFF';
    taggedUp?: boolean;
  }[];
}
```

### 9.3 Ground Rule Double - RARE IN SMB4

> ‚ö†Ô∏è **May exist in some SMB4 stadiums but is rare.** Include minimal support.

Batter automatically to 2B. Runners advance **two bases** from position at time of pitch.

| Runner Position | Automatic Advancement |
|-----------------|----------------------|
| R1 | To 3B (two bases) |
| R2 | Scores (two bases) |
| R3 | Scores |

### 9.4 ~~Interference / Obstruction~~ - NOT IN SMB4

> ‚ö†Ô∏è **Not implemented in SMB4.** Do not track.

### 9.5 Tag-Up Rules (Expanded)

When a fly ball is caught:

```typescript
interface TagUpScenario {
  // Runner must return to original base AFTER catch
  canAdvance: boolean;  // Did they tag up?

  // If tagged up
  advancementOptions: ['HELD', 'ADVANCED', 'OUT'];

  // If didn't tag up
  doubledOffOptions: ['SAFE_RETURNED', 'OUT_DOUBLED_OFF'];
}

function validateTagUp(runner, playResult) {
  if (playResult.type === 'FO' || playResult.type === 'LO') {
    // Runner cannot advance unless they tagged
    if (!runner.taggedUp && runner.outcome === 'ADVANCED') {
      return 'Error: Runner cannot advance without tagging up on fly out';
    }

    // If runner didn't return in time, they can be doubled off
    if (!runner.taggedUp && runner.outcome === 'HELD') {
      return 'Warning: Did runner return to base in time? Could be doubled off.';
    }
  }
}
```

**Sacrifice Fly Requirements:**
- Less than 2 outs
- Runner on 3B tags and scores
- Fly ball caught in fair or foul territory

---

## Implementation Matrix

### Walk/HBP/IBB - Required UI Behavior

| Situation | R1 | R2 | R3 | UI Behavior |
|-----------|----|----|----| ------------|
| R1 only | **AUTO ‚Üí 2B** | - | - | No selection needed |
| R2 only | - | Choice | - | Show options for R2 |
| R3 only | - | - | Choice | Show options for R3 |
| R1+R2 | **AUTO ‚Üí 2B** | **AUTO ‚Üí 3B** | - | No selection needed |
| R1+R3 | **AUTO ‚Üí 2B** | - | Choice | Show options for R3 only |
| R2+R3 | - | Choice | Choice | Show options for both |
| Loaded | **AUTO ‚Üí 2B** | **AUTO ‚Üí 3B** | **AUTO ‚Üí Scores** | No selection - all forced |

### Single (1B) - Required UI Behavior

| Situation | R1 Options | R2 Options | R3 Options |
|-----------|------------|------------|------------|
| R1 only | 2B/3B/Score/Out | - | - |
| R2 only | - | Hold/3B/Score/Out | - |
| R3 only | - | - | Hold/Score/Out |
| R1+R2 | 2B/3B/Score/Out | **3B/Score/Out*** | - |
| R1+R3 | 2B/3B/Score/Out | - | Hold/Score/Out |
| R2+R3 | - | Hold/3B/Score/Out | **Depends on R2** |
| Loaded | 2B/3B/Score/Out | **Depends on R1** | **Depends on R2** |

*R2 cannot hold if R1 is going to 2B

### Validation Rules (Pseudo-code)

```typescript
function validateRunnerOutcomes(result, bases, outcomes) {
  const errors = [];
  
  // RULE 1: On BB/IBB/HBP, forced runners MUST advance
  if (['BB', 'IBB', 'HBP'].includes(result)) {
    if (bases.first && outcomes.first === 'HELD') {
      errors.push('R1 cannot hold on walk - forced to advance');
    }
    if (bases.first && bases.second && outcomes.second === 'HELD') {
      errors.push('R2 cannot hold on walk with R1 - forced to advance');
    }
    if (bases.first && bases.second && bases.third && outcomes.third === 'HELD') {
      errors.push('R3 cannot hold on walk with bases loaded - forced to advance');
    }
  }
  
  // RULE 2: On 1B, R1 cannot hold
  if (result === '1B' && bases.first && outcomes.first === 'HELD') {
    errors.push('R1 cannot hold on single - batter takes 1B');
  }
  
  // RULE 3: On 2B, R1 and R2 cannot hold or stay below 3B
  if (result === '2B') {
    if (bases.first && ['HELD', 'TO_2B'].includes(outcomes.first)) {
      errors.push('R1 must advance past 2B on double');
    }
    if (bases.second && outcomes.second === 'HELD') {
      errors.push('R2 cannot hold on double - batter takes 2B');
    }
  }
  
  // RULE 4: On 3B, all runners must score or be out
  if (result === '3B') {
    if (bases.first && !['SCORED', 'OUT_HOME', 'OUT_3B'].includes(outcomes.first)) {
      errors.push('R1 must score or be out on triple');
    }
    // ... similar for R2, R3
  }
  
  // RULE 5: Two runners cannot occupy same base
  // (implicit in the UI but should be validated)
  
  return errors;
}
```

---

## 10. Auto-Advancement Summary

### 10.1 Events with AUTOMATIC Advancement (No User Choice)

| Event | Runners | Auto-Advancement |
|-------|---------|------------------|
| Walk/HBP/IBB | Forced runners | R1‚Üí2B, R2‚Üí3B (if R1 forced), R3‚ÜíHome (if loaded) |
| Ground Rule Double | All runners | Each runner +2 bases |
| Home Run | All runners | All score |

### 10.2 Events with OPTIONAL Advancement (User Choice)

| Event | Runners | Options |
|-------|---------|---------|
| Single | Non-forced runners | Hold or advance |
| Double | R3 only (R1/R2 must advance) | Hold or score |
| Wild Pitch / Passed Ball | All runners | Hold or advance |
| Stolen Base Attempt | Stealing runner | Safe or out |
| Fly Out | Tagged runners | Hold or advance |
| Error | All runners | May get extra bases |

### 10.3 Force Situations

Force situations occur when a runner MUST advance because another runner (or the batter) is taking their base. On walks and HBP, the batter is awarded first base, creating a chain of forces.

#### Force Detection Function

```typescript
/**
 * Determines if a runner is forced to advance.
 * A forced runner CANNOT hold - they MUST advance to the next base.
 *
 * @param base - The base the runner is currently on (1, 2, or 3)
 * @param runners - Object indicating which bases are occupied
 * @param event - The event type (WALK, HBP, IBB, 1B, 2B, etc.)
 * @returns boolean - true if the runner is forced, false otherwise
 */
function isForced(base: number, runners: { first: boolean; second: boolean; third: boolean }, event: string): boolean {
  // Walk/HBP/IBB: Batter is awarded 1B, creating force chain
  if (event === 'WALK' || event === 'HBP' || event === 'IBB' || event === 'BB') {
    // R1 is always forced (batter takes 1B)
    if (base === 1 && runners.first) return true;
    // R2 is forced only if R1 exists (chain: Batter ‚Üí R1 ‚Üí R2)
    if (base === 2 && runners.first && runners.second) return true;
    // R3 is forced only if R1 AND R2 exist (chain: Batter ‚Üí R1 ‚Üí R2 ‚Üí R3)
    if (base === 3 && runners.first && runners.second && runners.third) return true;
  }

  // Single (1B): Batter takes 1B, same force chain as walk
  if (event === '1B') {
    if (base === 1 && runners.first) return true;
    if (base === 2 && runners.first && runners.second) return true;
    if (base === 3 && runners.first && runners.second && runners.third) return true;
  }

  // Double (2B): Batter takes 2B, R1 and R2 must vacate
  if (event === '2B') {
    if (base === 1 && runners.first) return true;  // R1 must advance past 2B
    if (base === 2 && runners.second) return true; // R2 must vacate for batter
  }

  // Triple (3B): Batter takes 3B, all runners must vacate
  if (event === '3B') {
    if (base === 1 && runners.first) return true;
    if (base === 2 && runners.second) return true;
    if (base === 3 && runners.third) return true;
  }

  return false;
}
```

#### Force Situation Examples

| Event | Base State | R1 Forced? | R2 Forced? | R3 Forced? |
|-------|------------|------------|------------|------------|
| WALK  | R1         | YES        | -          | -          |
| WALK  | R2         | -          | NO (1B empty) | -       |
| WALK  | R1+R2      | YES        | YES        | -          |
| WALK  | R1+R3      | YES        | -          | NO (2B empty) |
| WALK  | R2+R3      | -          | NO         | NO         |
| WALK  | Loaded     | YES        | YES        | YES        |
| 1B    | R1         | YES        | -          | -          |
| 2B    | R1         | YES        | -          | -          |
| 2B    | R2         | -          | YES        | -          |

### 10.4 Runner Advancement Options Logic

```typescript
/**
 * Returns the valid advancement options for a runner.
 * Forced runners do NOT get a "Hold" option - they auto-advance.
 *
 * @param base - The base the runner is on (1, 2, or 3)
 * @param runners - Current base state
 * @param event - The event type
 * @returns Array of valid options, or 'AUTO' for forced advancement
 */
function getRunnerAdvancementOptions(
  base: number,
  runners: { first: boolean; second: boolean; third: boolean },
  event: string
): string[] | 'AUTO' {
  // Check if this runner is forced
  if (isForced(base, runners, event)) {
    // Forced runners auto-advance - no user choice needed
    // Return 'AUTO' to indicate the UI should not show options
    return 'AUTO';
  }

  // Non-forced runners get options based on event type
  if (event === 'WALK' || event === 'HBP' || event === 'IBB' || event === 'BB') {
    // Non-forced runners on walk can hold or advance
    if (base === 2) return ['HELD', 'TO_3B'];
    if (base === 3) return ['HELD', 'SCORED']; // Can attempt to score (rare)
  }

  if (event === '1B') {
    if (base === 2) return ['HELD', 'TO_3B', 'SCORED', 'OUT'];
    if (base === 3) return ['HELD', 'SCORED', 'OUT'];
  }

  if (event === '2B') {
    // Only R3 can hold on a double (R1/R2 are forced)
    if (base === 3) return ['HELD', 'SCORED', 'OUT'];
  }

  // Default for fly outs, ground outs, etc.
  return ['HELD', 'ADVANCED', 'SCORED', 'OUT'];
}
```

### 10.5 UI Decision Tree

```typescript
function getAdvancementUI(eventType, baseState, runnerPosition) {
  // Get the runners object
  const runners = {
    first: baseState.includes('R1') || baseState.first,
    second: baseState.includes('R2') || baseState.second,
    third: baseState.includes('R3') || baseState.third
  };

  // AUTOMATIC - no UI needed (HR, GRD)
  if (isAutoAdvance(eventType, baseState, runnerPosition)) {
    return { type: 'AUTO', destination: calculateAutoDestination() };
  }

  // FORCED - auto-advance, no "Hold" option
  if (isForced(runnerPosition, runners, eventType)) {
    // Calculate the forced destination
    const destination = runnerPosition === 1 ? '2B' :
                        runnerPosition === 2 ? '3B' : 'HOME';
    return {
      type: 'FORCED',
      destination: destination,
      message: `Runner auto-advances to ${destination} (forced)`
    };
  }

  // OPTIONAL - show advancement options (includes "HELD")
  const options = getRunnerAdvancementOptions(runnerPosition, runners, eventType);
  return {
    type: 'OPTIONAL',
    options: options
  };
}
```

---

## Current Bugs to Fix

### Bug 1: Walk with R1 allows "Held 1B"
**Seen in:** Screenshot showing BB with Mantle on 1B, "Held 1B" selected
**Fix:** Added `isForced()` function and `getRunnerAdvancementOptions()` logic in Section 10.3-10.5.
       Forced runners now auto-advance with no "Hold" option shown in UI.
**Status:** ‚úÖ FIXED - See Section 10.3 "Force Situations"

### Bug 2: Need to audit all other scenarios
**TODO:** Systematically test each base state √ó result combination
**Status:** In progress

---

## Testing Matrix

### Batted Ball Events

| Result | Empty | R1 | R2 | R3 | R1R2 | R1R3 | R2R3 | Loaded |
|--------|-------|----|----|----|----- |------|------|--------|
| BB/HBP | ‚úÖ | ‚úÖ FIXED | ? | ? | ? | ? | ? | ? |
| 1B | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| 2B | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| 3B | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| HR | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| GO | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| FO | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| LO | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| FC | N/A | ? | ? | ? | ? | ? | ? | ? |
| DP | N/A | ? | ? | ? | ? | ? | ? | ? |
| GRD | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |
| E | ‚úÖ | ? | ? | ? | ? | ? | ? | ? |

### Non-Batted Ball Events (SMB4)

| Event | Empty | R1 | R2 | R3 | R1R2 | R1R3 | R2R3 | Loaded |
|-------|-------|----|----|----|----- |------|------|--------|
| WP/PB | N/A | ? | ? | ? | ? | ? | ? | ? |
| SB | N/A | ? | ? | ? | ? | ? | ? | ? |
| CS | N/A | ? | ? | ? | ? | ? | ? | ? |
| ~~BALK~~ | ‚ùå NOT IN SMB4 | - | - | - | - | - | - | - |
| ~~CI~~ | ‚ùå NOT IN SMB4 | - | - | - | - | - | - | - |

Legend: ‚úÖ Verified correct | ‚ö†Ô∏è Bug found | ? Needs testing | N/A Not applicable | ‚ùå Not in SMB4

---

## Appendix: Quick Reference Cards

### Force Play Quick Reference

```
FORCE EXISTS when:
‚îú‚îÄ‚îÄ Batter reaches base (hit, walk, HBP, error, FC, CI)
‚îî‚îÄ‚îÄ Chain continues for consecutive occupied bases from 1B

FORCE CHAIN:
Batter ‚Üí R1 ‚Üí R2 ‚Üí R3
         ‚Üì      ‚Üì      ‚Üì
        (only if base behind is occupied)

EXAMPLE: R1 + R3 (2B empty)
- Batter forces R1 ‚úì
- R1 does NOT force R3 (2B empty, breaks chain) ‚úó
- R3 has choice to hold or advance
```

### Tag-Up Quick Reference

```
FLY BALL CAUGHT:
‚îú‚îÄ‚îÄ Runner TAGGED ‚Üí Can advance at own risk
‚îÇ   ‚îú‚îÄ‚îÄ Safe ‚Üí ADVANCED
‚îÇ   ‚îî‚îÄ‚îÄ Thrown out ‚Üí OUT
‚îî‚îÄ‚îÄ Runner DID NOT TAG
    ‚îú‚îÄ‚îÄ Returned in time ‚Üí HELD
    ‚îî‚îÄ‚îÄ Ball thrown to base ‚Üí DOUBLED OFF (OUT)
```

### Automatic Advancement Quick Reference (SMB4)

```
AUTO-ADVANCE (no user input needed):
‚îú‚îÄ‚îÄ HR ‚Üí Everyone scores
‚îú‚îÄ‚îÄ GRD ‚Üí Everyone +2 bases (rare in SMB4)
‚îî‚îÄ‚îÄ BB/HBP with FORCED runner ‚Üí Forced runners advance

USER INPUT NEEDED:
‚îú‚îÄ‚îÄ Hits (except HR) ‚Üí Non-forced runners choose
‚îú‚îÄ‚îÄ Outs ‚Üí Tagging runners choose
‚îú‚îÄ‚îÄ WP/PB ‚Üí All runners choose
‚îî‚îÄ‚îÄ SB attempt ‚Üí Result of attempt

NOT IN SMB4 (do not implement):
‚îú‚îÄ‚îÄ BALK
‚îú‚îÄ‚îÄ Catcher Interference
‚îî‚îÄ‚îÄ Obstruction

IN SMB4 (implement):
‚îî‚îÄ‚îÄ Infield Fly Rule (IFR) - Called with R1+R2 or loaded, <2 outs
```

---

*Last Updated: January 24, 2026*
*Version: 2.1 - Added force validation logic (isForced function), fixed Walk/HBP force advancement bug*
~~~

### Source File: specs/SMB4_GAME_REFERENCE.md

~~~markdown
# SMB4 Game Reference

> **Purpose**: Comprehensive reference for Super Mega Baseball 4 game mechanics
> **Source**: BillyYank's Guide (3rd Edition) + Jester's SMB Reference V2
> **Created**: January 21, 2026
> **IMPORTANT**: Read this BEFORE implementing any game-specific features

---

## Table of Contents

1. [Game Overview](#1-game-overview)
2. [Player Ratings](#2-player-ratings)
3. [Mojo System](#3-mojo-system)
4. [Chemistry & Traits](#4-chemistry--traits)
5. [Pitching Arsenal](#5-pitching-arsenal)
6. [Fielding by Position](#6-fielding-by-position)
7. [Franchise Mode](#7-franchise-mode)
8. [SMB4-Specific Events](#8-smb4-specific-events)
9. [Stats to Track](#9-stats-to-track)
10. [Reference Documents](#10-reference-documents)

---

## 1. Game Overview

SMB4 is a highly customizable baseball game with three pre-built leagues:

| League | Teams | Description |
|--------|-------|-------------|
| Super Mega League | 20 | Balanced teams with characters from previous games |
| Legends League | 8 | Retired MLB players at different career stages |
| Creators Classic | 8 | Blend of SML, Legends, and baseball personalities |

### Ego System
Four independent difficulty settings (0-99 each):
- **Batting** - How hard it is to hit
- **Pitching** - How hard it is to pitch effectively
- **Fielding** - How hard it is to field
- **Baserunning** - How hard it is to run bases

---

## 2. Player Ratings

All skills range from **0 to 99**.

### Position Players

| Rating | Description | In-Game Effect |
|--------|-------------|----------------|
| **Power (POW)** | How hard player hits | Size of batting reticle center dot |
| **Contact (CON)** | Ability to make contact | Size of batting reticle outer circle |
| **Speed (SPD)** | Running speed | Used for both fielding and baserunning |
| **Fielding (FLD)** | Fielding ability | Fewer errors, better range, diving plays |
| **Arm (ARM)** | Throw speed/distance | Critical for C, SS, CF, 3B positions |

### Pitchers

| Rating | Description | Notes |
|--------|-------------|-------|
| **Velocity (VEL)** | Fastball speed | Critical for fastball-heavy arsenals |
| **Junk (JNK)** | Pitch curve amount | Critical for off-speed pitches |
| **Accuracy (ACC)** | Pitch control | Can compensate for low VEL/JNK |

### Player Tiers

| Tier | Salary Range | Description |
|------|--------------|-------------|
| S | $15M+ | Elite players |
| A | $9-15M | Stars |
| B | $5.5-9M | Quality starters |
| C | $2.5-5.5M | Role players |
| D | <$2.5M | Bench/replacement |

---

## 3. Mojo System

Mojo is a fluctuating mood stat that affects performance. **This is critical for Fame tracking.**

### Mojo Levels (High to Low)

**Mojo uses a 5-level scale from -2 to +2:**

| Level | Value | Enum | Description | Effect |
|-------|-------|------|-------------|--------|
| **Jacked** | +2 | VERY_HIGH | Peak performance, rarely achieved | Huge bonuses (~+15-20%) |
| **Locked In** | +1 | HIGH | Having a great game | Good bonuses (~+8-10%) |
| **Normal** | 0 | NEUTRAL | Default starting state | Baseline |
| **Tense** | -1 | LOW | Struggling | Decreased stats (~-8-10%) |
| **Rattled** | -2 | VERY_LOW | Sustained failure, hard to escape | Significant penalties (~-15-20%) |

> **Note**: "Locked In" is the +1 Mojo state. It may also be referred to as "On Fire" in some contexts - they are the same level. The system uses 5 levels total, not 6.

### Mojo Triggers

**Positive (Mojo Up)**:
- Getting hits (especially extra-base hits)
- Stealing bases
- Making outs (pitchers)
- Strikeouts (pitchers)

**Negative (Mojo Down)**:
- Making outs (batters)
- Strikeouts (batters)
- Committing errors
- Getting caught stealing
- Allowing walks/hits/runs (pitchers)

### Pressure Situations
Mojo effects are **amplified** in high-pressure situations:
- Tied games in late innings
- Runners in scoring position
- Close games

---

## 4. Chemistry & Traits

### Chemistry Types (5 Colors)

| Chemistry | Color | Focus |
|-----------|-------|-------|
| **Competitive** | Orange | Two-strike performance, durability |
| **Spirited** | Yellow | Batting versatility, comeback ability |
| **Crafty** | Green | Baserunning, platoon advantages |
| **Disciplined** | Purple | Count management, composure |
| **Scholarly** | Blue | Power hitting, mental game |

### Trait Potency Levels

Traits scale based on team chemistry composition:

| Players of Chemistry Type | Potency Level | Effect |
|---------------------------|---------------|--------|
| 0-2 | Level 1 | Minimal bonus |
| 3-6 | Level 2 | Mid-level bonus |
| 7+ | Level 3 | Huge bonus |

**Max 22 players per team** ‚Üí Can only max out 2-3 chemistry types

### Key Traits by Chemistry

#### COMPETITIVE (Orange)
| Trait | Effect | Notes |
|-------|--------|-------|
| **K Collector** | +VEL/JNK on 2-strike counts | One of the best pitcher traits |
| **Tough Out** | +CON on 2-strike counts | Excellent for batters |
| **Cannon Arm** | Increased throw speed | Best for C, SS, CF, 3B |
| **Durable** | Reduced injury risk, slower fitness decay | Critical for catchers |
| **First Pitch Slayer** | +POW/CON on 0-0 count | Forces tough pitcher decisions |
| **Sprinter** | Faster out of batter's box | Good for speed guys |
| K Neglecter | -VEL/JNK on 2-strike counts | **AVOID** |
| Whiffer | -CON on 2-strike counts | **AVOID** |
| Slow Poke | Slower out of batter's box | **AVOID** |

#### CRAFTY (Green)
| Trait | Effect | Notes |
|-------|--------|-------|
| **Stealer** | Faster steal speed | Can make average runners threats |
| **Specialist** | Debuffs same-handed batters | Affects 53% of batters (RH) |
| **Reverse Splits** | Debuffs opposite-handed batters | Only way to neutralize switch hitters |
| **Bad Ball Hitter** | Reduced penalty on edge pitches | Expands effective zone |
| **Mind Gamer** | Opposing pitcher -ACC | Constant advantage |
| **Distractor** | Opposing pitcher -ACC when on base | Hilarious and effective |
| **Pick Officer** | Opposing runners slower stealing | Great for limiting steals |
| Bad Jumps | Slower steal speed | Situationally bad |
| Easy Jumps | Opposing runners faster stealing | **AVOID** |
| Wild Thrower | +Error chance | **AVOID** |

#### DISCIPLINED (Purple)
| Trait | Effect | Notes |
|-------|--------|-------|
| **Composed** | +ACC on 3-ball counts | Good for junkballers |
| **Base Rounder** | Faster rounding bases | Always useful |
| BB Prone | -ACC on 3-ball counts | Bad for low-ACC pitchers |
| Base Jogger | Slower rounding bases | Situationally bad |

#### SPIRITED (Yellow)
| Trait | Effect | Notes |
|-------|--------|-------|
| **Rally Starter** | Bonus when team is losing | Comeback potential |
| **Stopper** | Bonus when team is winning | Lock down wins |

#### SCHOLARLY (Blue)
| Trait | Effect | Notes |
|-------|--------|-------|
| **Power Surge** | Situational power boost | Extra pop |
| **Extra Bases** | Better at stretching hits | More doubles/triples |

---

## 5. Pitching Arsenal

### Pitch Types

**Fastballs** (high VEL important):
| Pitch | Movement | Notes |
|-------|----------|-------|
| Four Seam (4F) | Straight | Basic fastball |
| Two Seam (2F) | Slight horizontal | Moves with junk |
| Cutter (CT) | Slight horizontal | Moves with junk |

**Off-Speed** (high JNK important):
| Pitch | Movement | Notes |
|-------|----------|-------|
| Change Up (CH) | Slow, slight drop | Speed deception |
| Curveball (CB) | Slow, significant drop | Classic breaking ball |
| Slider (SL) | Faster, diagonal drop | Sweeping movement |
| Forkball (FK) | Quick vertical drop | Sharp late break |
| Screwball (SC) | Sudden horizontal | Rare, deceptive |

### Pitcher Positions

| Position | Stamina | Rest Needed | Notes |
|----------|---------|-------------|-------|
| SP (Starter) | ~70 pitches | 3 games | Best stamina |
| SP/RP | ~45 pitches | 2 games | Versatile, no mojo penalty |
| RP (Reliever) | ~25 pitches | 1 game | Middle relief |
| CP (Closer) | ~20 pitches | Fastest | 8th+ inning only, or mojo penalty |

**Important**: Using pitchers outside their role causes **mojo penalty**.

---

## 6. Fielding by Position

### Minimum Requirements (Rule of Thumb)

| Position | FLD | SPD | ARM | Notes |
|----------|-----|-----|-----|-------|
| **C** | 60+ | - | 70+ | Must stop steals, handle every pitch |
| **1B** | 35+ | - | 25+ | Easiest position, prioritize hitting |
| **2B** | 50+ | 50+ | 25+ | Need range, short throw |
| **SS** | 65+ | 65+ | 65+ | Highest demands, most critical |
| **3B** | 60+ | - | 65+ | Long throw, line drives |
| **LF** | 25+ | 50+ | 30+ | Easiest OF, prioritize hitting |
| **CF** | 40+ | 70+ | 70+ | Most ground to cover |
| **RF** | 40+ | 50+ | 65+ | Long throws to 3B/home |

### Position Priority

Defense matters most at: **C > SS > CF > 3B > RF > 2B > 1B > LF**

Offense matters most at: **1B > LF > RF > 3B > 2B > CF > SS > C**

### Catcher Special Rules
- **Cannot play non-catchers at C** (too many chances per game)
- Catchers need rest (~1 of every 4 games)
- Always need a backup catcher

---

## 7. Franchise Mode

### Budget System
- Team budget: ~$175M
- Unspent salary ‚Üí PDO (Player Development Opportunity) funds
- Young/cheap roster = more development funds

### PDOs (Player Development Opportunities)
- Random stat improvements
- Can gain/lose traits
- Also increases player Loyalty

### Loyalty System
- **High Loyalty**: Player accepts below-market salary
- **Low Loyalty**: Player demands premium to stay
- Manager Moments affect Loyalty (positive or negative choices)
- PDOs increase Loyalty

### Off-Season
- 32 rounds of free agency
- AI snaps up players around round 14
- Players reduce demands each round
- Keep chemistry composition in mind when signing

### Player Aging
- Young players (18-29): Generally improve
- Older players (30+): Generally decline
- Max age: 49 (most retire earlier)

---

## 8. SMB4-Specific Events

### Comebacker Scenarios
| Event | Impact |
|-------|--------|
| Normal comebacker | P gets assist, +fWAR |
| Comebacker caught | P gets putout, +Clutch if ends inning |
| Pitcher injured by comebacker | Significant fitness hit, may exit game |

### Nutshot Event
Ball hits pitcher in groin area (unique SMB4 animation):
- Mojo penalty to pitcher
- No fitness penalty
- Play may or may not be made

### Failed HR Robbery
Outfielder attempts to rob HR, ball bounces off glove over fence:
- **-1 Fame** to fielder
- Still counts as HR

### Bad Hop
Ball takes unexpected bounce over fielder:
- NOT an error (bad luck ‚â† error)
- Track separately for analysis
- Affects spray chart accuracy

---

## 9. Stats to Track

### Batting Stats (from Jester's Reference)
| Stat | Column | Description |
|------|--------|-------------|
| G | Games played |
| AB | At bats |
| H | Hits |
| HR | Home runs |
| RBI | Runs batted in |
| R | Runs scored |
| TB | Total bases |
| 2B | Doubles |
| 3B | Triples |
| BB | Walks |
| SO | Strikeouts |
| SB | Stolen bases |
| CS | Caught stealing |
| HBP | Hit by pitch |
| SAC | Sacrifice bunts |
| SF | Sacrifice flies |
| E | Errors |
| PB | Passed balls (catchers) |

### Pitching Stats
| Stat | Column | Description |
|------|--------|-------------|
| W | Wins |
| L | Losses |
| RA | Runs allowed |
| ER | Earned runs |
| Gp | Games pitched |
| GS | Games started |
| SV | Saves |
| IP | Innings pitched |
| Ha | Hits allowed |
| K | Strikeouts |
| BBa | Walks allowed |
| WP | Wild pitches |
| HRa | Home runs allowed |
| CG | Complete games |
| SHO | Shutouts |
| HB | Hit batters |
| TBF | Total batters faced |
| NP | Number of pitches |

### Defensive Stats
Position-specific plate appearances tracked:
- PA_C, PA_1B, PA_2B, PA_3B, PA_SS, PA_LF, PA_CF, PA_RF, PA_DH

DRS (Defensive Runs Saved) by position:
- DRS_P, DRS_C, DRS_1B, DRS_2B, DRS_3B, DRS_SS, DRS_LF, DRS_CF, DRS_RF

### Calculated Stats
| Stat | Description |
|------|-------------|
| OBP | On-base percentage |
| SLG | Slugging percentage |
| OPS+ | OPS adjusted for league |
| wOBA | Weighted on-base average |
| wRC | Weighted runs created |
| wRAA | Weighted runs above average |
| wRC+ | wRC adjusted for league |
| batRAA | Batting runs above average |
| bsrRAA | Baserunning runs above average |
| fldRAA | Fielding runs above average |
| posADJ | Positional adjustment |
| bWAR | Position player WAR |

### Awards Tracked
- All-Star
- Cy Young Award
- Most Valuable Player
- Rookie of the Year
- Gold Glove
- Platinum Glove
- Silver Slugger
- Rolaids Relief Pitcher of the Year
- Golden Spikes
- Postseason MVP
- Champion

---

## 10. Reference Documents

### Available in `/reference-docs/`:

1. **BillyYank Super Mega Baseball Guide 3rd Edition.docx**
   - Complete SMB4 guide (~90+ pages)
   - Trait analysis with player examples
   - Team rankings and analysis
   - Park dimensions

2. **Jester's Super Mega Baseball Reference V2 clean.xlsx**
   - Season-over-season stat tracking template
   - WAR calculations
   - Leaderboards and awards
   - FIP defense adjustments

### How to Use These Documents

For **trait implementation**: Read BillyYank's Traits section (starts around page 18)
For **stat tracking schema**: Use Jester's PLAYER LOG columns as reference
For **WAR calculations**: See Jester's formula columns and GUTS sheet

---

## Key Takeaways for KBL Tracker

1. **Mojo is central** to SMB4 - track events that affect it
2. **Chemistry/Traits** create complex interactions - must track potency
3. **Fielding positions** have very different requirements
4. **Catchers are special** - fatigue faster, can't be played by non-catchers
5. **Pitcher roles matter** - using wrong role = mojo penalty
6. **PDOs and Loyalty** are key to franchise success
7. **Track everything** - the reference spreadsheet shows ~220 columns per player

---

*This document extracts key SMB4 mechanics. For full details, consult the original reference documents.*
~~~

### Source File: specs/GAME_SIMULATION_SPEC.md

~~~markdown
# Game Simulation & Skip Specification

> **Purpose**: Define architecture for skipping and simulating games
> **Status**: PLANNING - Build out deferred until other features complete
> **Priority**: Future Phase
> **Related Specs**: STAT_TRACKING_ARCHITECTURE_SPEC.md, FRANCHISE_MODE_SPEC.md

---

## 1. Overview

The simulation system allows users to:
1. **Skip** individual games (no stats generated, adjusts qualification thresholds)
2. **Simulate** individual games (generates realistic stats via play-by-play engine)
3. **Sim to Next Event** (batch simulate multiple games, stopping at season milestones)
4. **Unsimulate** (reverse a simulated game if user decides to play it manually)

### 1.1 Core Principles

- Simulated games should feel **real** (clutch moments, fame events, realistic distributions)
- Use **player ratings from roster data** as simulation inputs
- Simulated games are **visually distinct** in box scores and history
- Simulations are **reversible** (can unsimulate before playing)
- **Data integrity first** - no simulation operation should risk data loss

---

## 2. Game Status Types

```typescript
type GameStatus =
  | 'scheduled'      // Not yet played or simulated
  | 'in_progress'    // Currently being played manually
  | 'completed'      // Played manually, finalized
  | 'simulated'      // Generated by simulation engine
  | 'skipped';       // Marked as skipped, no stats

interface ScheduledGame {
  gameId: string;
  seasonId: string;
  gameNumber: number;        // 1-512 (or whatever total)
  scheduledDate: string;     // YYYY-MM-DD
  awayTeamId: string;
  homeTeamId: string;
  status: GameStatus;

  // Simulation metadata (if simulated)
  simulatedAt?: number;      // Timestamp
  simulationSeed?: number;   // For reproducibility
  canUnsimulate?: boolean;   // False after manual game played after this one

  // Skip metadata (if skipped)
  skippedAt?: number;
  skipReason?: string;       // Optional user note
}
```

---

## 3. Skip Game Feature

### 3.1 What Happens When a Game is Skipped

1. Game marked as `status: 'skipped'`
2. No stats generated for any players
3. Season schedule advances
4. Qualification thresholds recalculate based on games actually played

### 3.2 Qualification Threshold Adjustment

Standard thresholds are based on team games played:

| Stat | Standard Threshold | Adjusted Formula |
|------|-------------------|------------------|
| Batting title | 3.1 PA per team game | `3.1 √ó teamGamesPlayed` |
| ERA title | 1 IP per team game | `1.0 √ó teamGamesPlayed` |
| Fielding | 2/3 of team games at position | `0.667 √ó teamGamesAtPosition` |

```typescript
interface TeamSeasonContext {
  teamId: string;
  seasonId: string;
  gamesScheduled: number;    // Total on schedule
  gamesPlayed: number;       // Completed + Simulated
  gamesSkipped: number;      // Skipped
  gamesRemaining: number;    // Scheduled - Played - Skipped
}

function getQualifyingPA(team: TeamSeasonContext): number {
  return Math.floor(3.1 * team.gamesPlayed);
}

function getQualifyingIP(team: TeamSeasonContext): number {
  return team.gamesPlayed; // 1 IP per game played
}
```

### 3.3 Skip Game UI

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Game 45: Tigers @ Yankees                      ‚îÇ
‚îÇ  April 15, 2026                                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [Play Game]  [Simulate]  [Skip]                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚Üì User clicks "Skip"

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Skip Game?                                     ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  No stats will be generated. Qualification     ‚îÇ
‚îÇ  thresholds will adjust automatically.         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Reason (optional): [________________]          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [Cancel]  [Skip Game]                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 4. Simulate Game Feature

### 4.1 Simulation Engine Overview

The simulation engine generates **play-by-play** at-bat results that flow through the existing event log system, producing:

- Realistic box scores
- Individual player stats
- Fame events (when triggered)
- Proper run/hit/error distributions

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SIMULATION FLOW                       ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  Roster Data ‚îÄ‚îÄ‚ñ∫ Simulation ‚îÄ‚îÄ‚ñ∫ Event Log ‚îÄ‚îÄ‚ñ∫ Stats     ‚îÇ
‚îÇ  (ratings)       Engine        (same as     (same as    ‚îÇ
‚îÇ                  (new)          manual)      manual)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.2 Simulation Engine Architecture

```typescript
interface SimulationEngine {
  // Simulate a single game
  simulateGame(
    game: ScheduledGame,
    awayRoster: SimRoster,
    homeRoster: SimRoster,
    options?: SimulationOptions
  ): Promise<SimulatedGameResult>;

  // Simulate multiple games (for "Sim to Next Event")
  simulateGames(
    games: ScheduledGame[],
    rosters: Map<TeamId, SimRoster>,
    options?: SimulationOptions
  ): AsyncGenerator<SimulatedGameResult>;
}

interface SimulationOptions {
  seed?: number;              // For reproducibility
  verboseLog?: boolean;       // Log each at-bat (for debugging)
  fameDetectionEnabled?: boolean;  // Generate fame events (default: true)
}

interface SimRoster {
  teamId: string;
  lineup: SimPlayer[];        // 9 batters in order
  startingPitcher: SimPlayer;
  bench: SimPlayer[];
  bullpen: SimPlayer[];
}

interface SimPlayer {
  playerId: string;
  name: string;
  position: Position;
  ratings: PlayerRatings;     // From roster data
}
```

### 4.3 At-Bat Simulation Logic

Each at-bat is resolved using probability tables based on player ratings:

```typescript
interface AtBatSimulator {
  simulateAtBat(
    batter: SimPlayer,
    pitcher: SimPlayer,
    situation: GameSituation
  ): SimulatedAtBatResult;
}

interface GameSituation {
  inning: number;
  halfInning: 'TOP' | 'BOTTOM';
  outs: number;
  runners: RunnerState;
  awayScore: number;
  homeScore: number;

  // For fatigue/substitution decisions
  pitcherPitchCount: number;
  pitcherOutsRecorded: number;
}

interface SimulatedAtBatResult {
  result: AtBatResult;
  runnerOutcomes: RunnerOutcomes;
  runsScored: number;
  rbiCount: number;

  // For event log
  leverageIndex: number;
  isClutch: boolean;
  fameEvents: FameEvent[];
}
```

### 4.4 Probability Model with Randomness

Base probabilities derived from player ratings (0-99 scale from SMB4), but with **variance injected** to prevent deterministic outcomes. If simulation were 100% rating-driven, results would be predictable and uninteresting.

#### 4.4.1 Rating-Based Probabilities

```typescript
// Simplified probability calculation
function calculateOutcomeProbabilities(
  batter: SimPlayer,
  pitcher: SimPlayer
): OutcomeProbabilities {
  const batterContact = batter.ratings.contact;    // 0-99
  const batterPower = batter.ratings.power;        // 0-99
  const batterEye = batter.ratings.eye;            // 0-99
  const pitcherStuff = pitcher.ratings.stuff;      // 0-99
  const pitcherControl = pitcher.ratings.control;  // 0-99

  // Matchup adjustment (batter vs pitcher)
  const contactDiff = (batterContact - pitcherStuff) / 100;
  const powerDiff = (batterPower - pitcherStuff) / 100;
  const eyeDiff = (batterEye - pitcherControl) / 100;

  // Base rates (league average)
  const baseRates = {
    strikeout: 0.22,
    walk: 0.08,
    hit: 0.24,
    homeRun: 0.03,
    // etc.
  };

  // Adjusted rates
  return {
    strikeout: Math.max(0.05, Math.min(0.40, baseRates.strikeout - contactDiff * 0.15)),
    walk: Math.max(0.02, Math.min(0.20, baseRates.walk + eyeDiff * 0.10)),
    homeRun: Math.max(0.005, Math.min(0.08, baseRates.homeRun + powerDiff * 0.05)),
    // ... more outcomes
  };
}
```

#### 4.4.2 Variance & Randomness

Ratings determine the **expected distribution**, but each at-bat introduces randomness:

```typescript
interface VarianceConfig {
  // How much randomness to inject (0 = pure ratings, 1 = pure chaos)
  varianceFactor: number;  // Recommended: 0.15-0.25

  // Hot/cold streak simulation
  streakEnabled: boolean;
  streakLength: { min: number; max: number };  // e.g., 3-10 at-bats

  // Clutch variance (more variance in high-leverage situations)
  clutchVarianceBoost: number;  // e.g., 0.05 extra variance when LI > 2.0
}

function applyVariance(
  baseProbabilities: OutcomeProbabilities,
  config: VarianceConfig,
  rng: SeededRandom
): OutcomeProbabilities {
  const result = { ...baseProbabilities };

  // Add random variance to each probability
  for (const key of Object.keys(result)) {
    const variance = (rng.random() - 0.5) * 2 * config.varianceFactor;
    result[key] = clamp(result[key] * (1 + variance), 0.01, 0.99);
  }

  // Normalize so probabilities sum to 1
  return normalizeProbabilities(result);
}
```

**Why Variance Matters:**
- A 99-rated hitter should hit ~.340, not exactly .340 every season
- Underdogs can win games (like real baseball)
- Creates meaningful hot/cold streaks
- Prevents "solved" simulations where you know the outcome

#### 4.4.3 Seeded Random Number Generator

For **reproducibility** (same seed = same results), use a seeded PRNG:

```typescript
class SeededRandom {
  private seed: number;

  constructor(seed?: number) {
    this.seed = seed ?? Date.now();
  }

  // Mulberry32 algorithm - fast and good distribution
  random(): number {
    let t = this.seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }

  getSeed(): number {
    return this.seed;
  }
}
```

This allows:
- **Reproducible simulations**: Re-run with same seed, get same game
- **Debugging**: Reproduce a specific unusual result
- **Fairness verification**: Users can verify simulation wasn't rigged

### 4.5 Simulation Output ‚Üí Event Log

Simulated at-bats produce the **same `AtBatEvent` structure** as manual games:

```typescript
async function simulateAndLog(game: ScheduledGame, ...): Promise<void> {
  // Create game header (marked as simulated)
  await createGameHeader({
    ...gameData,
    isSimulated: true,  // NEW FIELD
    simulationSeed: options.seed,
  });

  // Simulate each at-bat
  let sequence = 0;
  while (!gameOver) {
    const result = atBatSimulator.simulateAtBat(batter, pitcher, situation);
    sequence++;

    // Log to event log (same as manual game!)
    await logAtBatEvent({
      eventId: `${game.gameId}_${sequence}`,
      gameId: game.gameId,
      sequence,
      isSimulated: true,  // NEW FIELD - marks this at-bat as simulated
      // ... all other fields same as manual
    });

    // Update situation
    updateGameState(result);
  }

  // Complete game
  await completeGame(game.gameId, finalScore, finalInning);
}
```

### 4.6 Visual Distinction for Simulated Games

Box scores and history show simulated games differently:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä SIMULATED                                   ‚îÇ
‚îÇ  Game 45: Tigers 5, Yankees 3                   ‚îÇ
‚îÇ  April 15, 2026                                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [View Box Score]  [Unsimulate]                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.7 Stat Filtering: Manual vs Simulated

Stats from simulated games are tracked separately, allowing users to filter leaderboards and records.

#### 4.7.1 Filter Modes

| Mode | Shows | Use Case |
|------|-------|----------|
| **All Games** | Manual + Simulated stats combined | Default view, complete picture |
| **Manual Only** | Only stats from manually played games | "Pure" competitive view |
| **Sim Only** | Only stats from simulated games | Compare sim performance |

```typescript
type StatFilterMode = 'all' | 'manual_only' | 'sim_only';

interface LeaderboardOptions {
  seasonId: string;
  statCategory: 'batting' | 'pitching' | 'fielding';
  filterMode: StatFilterMode;
  minQualifyingGames?: number;
}
```

#### 4.7.2 UI Implementation

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Season 1 Batting Leaders                                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Filter: [All Games ‚ñº] [Manual Only] [Sim Only]            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Batting Average (min 3.1 PA/team game)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 1. J. Smith      .342  (128 G: 112 manual, 16 sim)    ‚îÇ‚îÇ
‚îÇ  ‚îÇ 2. M. Johnson    .328  (128 G: 96 manual, 32 sim)     ‚îÇ‚îÇ
‚îÇ  ‚îÇ 3. T. Williams   .315  (128 G: 128 manual, 0 sim)     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  üìä = includes simulated games                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 4.7.3 Per-Player Stat Breakdown

Player stat pages show the split:

```typescript
interface PlayerSeasonStatsSplit {
  playerId: string;
  seasonId: string;

  // Combined totals
  total: BattingStats;

  // Breakdown by source
  manual: BattingStats;   // From manually played games
  simulated: BattingStats; // From simulated games

  // Metadata
  manualGames: number;
  simulatedGames: number;
  totalGames: number;
}
```

### 4.8 Stat Legitimacy: Fully Simulated vs Partially Played Seasons

A critical question: **Should a fully simulated season have the same stat legitimacy as a partially played season?**

#### 4.8.1 Recommendation: Simulation Percentage Threshold

Stats from seasons with **low manual play percentage** should be treated differently:

| Manual Play % | Classification | Award Eligibility | Record Eligibility |
|---------------|----------------|-------------------|-------------------|
| 75%+ | **Primary Season** | ‚úÖ Full eligibility | ‚úÖ Full eligibility |
| 25-74% | **Mixed Season** | ‚ö†Ô∏è With asterisk | ‚ö†Ô∏è With asterisk |
| <25% | **Simulated Season** | ‚ùå Not eligible | ‚ùå Not eligible |

```typescript
interface SeasonClassification {
  seasonId: string;
  totalGames: number;
  manualGames: number;
  simulatedGames: number;
  skippedGames: number;

  manualPercentage: number;  // manualGames / (manualGames + simulatedGames)
  classification: 'primary' | 'mixed' | 'simulated';
}

function classifySeason(stats: SeasonClassification): 'primary' | 'mixed' | 'simulated' {
  const playedGames = stats.manualGames + stats.simulatedGames;
  if (playedGames === 0) return 'simulated';

  const manualPct = stats.manualGames / playedGames;

  if (manualPct >= 0.75) return 'primary';
  if (manualPct >= 0.25) return 'mixed';
  return 'simulated';
}
```

#### 4.8.2 Impact on Awards & Records

**MVP/Cy Young/ROY Awards:**
- **Primary seasons**: Full eligibility for all awards
- **Mixed seasons**: Can win awards, but noted with "(mixed season)"
- **Simulated seasons**: Stats tracked but not eligible for awards

**All-Time Records:**
- **Primary seasons**: Records count fully
- **Mixed seasons**: Records noted with "‚Ä†" (dagger) annotation
- **Simulated seasons**: Records tracked separately ("Sim Records" category)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  All-Time Home Run Leaders                                  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  1. J. Smith       287  (S1-S5, primary)                   ‚îÇ
‚îÇ  2. M. Johnson     245‚Ä† (S1-S3, mixed S2)                  ‚îÇ
‚îÇ  3. T. Williams    198  (S1-S2, primary)                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚Ä† Season included >25% simulated games                     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  [Show Simulated Records]                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 4.8.3 User Control

Users can configure their own thresholds:

```typescript
interface SimulationSettings {
  // Threshold for "primary" classification
  primarySeasonThreshold: number;  // Default: 0.75 (75%)

  // Threshold for "mixed" (below this = "simulated")
  mixedSeasonThreshold: number;    // Default: 0.25 (25%)

  // Whether to show simulated stats in default leaderboard view
  includeSimulatedInDefault: boolean;  // Default: true

  // Whether simulated seasons can earn awards
  allowSimulatedAwards: boolean;  // Default: false
}
```

#### 4.8.4 Rationale

This approach balances flexibility with competitive integrity:

1. **Users who sim most games** get a complete franchise experience but don't claim records they didn't "earn"
2. **Users who play most games** get full recognition for their stats
3. **Mixed usage** (sim some, play some) is acknowledged but still counts
4. **All data is preserved** - nothing is discarded, just classified differently

---

## 5. Unsimulate Feature

### 5.1 When Unsimulate is Available

A simulated game can be unsimulated **only if**:
- No manual games have been played AFTER it in the schedule
- The season hasn't ended
- It hasn't been more than X days (optional time limit?)

```typescript
function canUnsimulate(game: ScheduledGame, season: SeasonContext): boolean {
  if (game.status !== 'simulated') return false;
  if (season.isComplete) return false;

  // Check if any manual game was played after this one
  const laterManualGame = season.games.find(g =>
    g.gameNumber > game.gameNumber &&
    g.status === 'completed'
  );

  return !laterManualGame;
}
```

### 5.2 Unsimulate Process

1. **Confirmation prompt**: "Unsimulate this game? All generated stats will be removed."
2. **Remove event log entries**: Delete all `AtBatEvent` records for this game
3. **Remove from season stats**: Re-aggregate season without this game
4. **Reset game status**: Change to `scheduled`
5. **Integrity check**: Verify season totals still valid

```typescript
async function unsimulateGame(gameId: string): Promise<void> {
  const game = await getGame(gameId);
  if (!canUnsimulate(game)) {
    throw new Error('Cannot unsimulate: manual game played after this one');
  }

  // 1. Delete event log entries
  await deleteGameEvents(gameId);

  // 2. Delete game header
  await deleteGameHeader(gameId);

  // 3. Re-aggregate season stats (rebuild from remaining games)
  await rebuildSeasonStats(game.seasonId);

  // 4. Reset schedule entry
  await updateScheduleEntry(gameId, { status: 'scheduled' });

  console.log(`[Unsimulate] Game ${gameId} reverted to scheduled`);
}
```

### 5.3 Data Safety

- Event log provides complete audit trail
- Season stats can always be rebuilt from event log
- Unsimulate is safe because we're just removing simulated data

---

## 6. Sim to Next Event

### 6.1 Season Event Milestones

The "Sim to Next Event" feature stops at these milestones:

| Event | Description |
|-------|-------------|
| **All-Star Break** | Mid-season break (if configured) |
| **Trade Deadline** | Last day for trades |
| **September Callups** | Roster expansion date |
| **Regular Season End** | Last game before playoffs |
| **Playoff Series** | Each series (WC, Division, LCS, WS) |
| **Off-Season Events** | Draft, free agency, etc. |

```typescript
type SeasonMilestone =
  | 'all_star_break'
  | 'trade_deadline'
  | 'roster_expansion'
  | 'regular_season_end'
  | 'wild_card_round'
  | 'division_series'
  | 'championship_series'
  | 'world_series'
  | 'offseason_start'
  | 'draft'
  | 'free_agency_opens'
  | 'free_agency_closes'
  | 'spring_training';

interface SeasonEvent {
  type: SeasonMilestone;
  date: string;
  gameNumber?: number;  // For game-based milestones
  description: string;
}
```

### 6.2 Sim to Next Event Flow

```
User clicks "Sim to Next Event"
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Sim to Next Event                          ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Current: Game 45 of 512                    ‚îÇ
‚îÇ  Next Event: All-Star Break (Game 256)      ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  This will simulate 211 games.              ‚îÇ
‚îÇ  Estimated time: ~30 seconds                ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [Cancel]  [Simulate]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº User confirms
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Simulating...                              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  45%                  ‚îÇ
‚îÇ  Game 140 of 211                            ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Tigers: 38-24 (.613)                       ‚îÇ
‚îÇ  Current game: Tigers 4, Yankees 2 (6th)    ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [Cancel]                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº Complete
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Simulation Complete!                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  211 games simulated                        ‚îÇ
‚îÇ  Season standings updated                   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Notable events:                            ‚îÇ
‚îÇ  ‚Ä¢ J. Smith hit for the cycle (Game 89)     ‚îÇ
‚îÇ  ‚Ä¢ M. Johnson threw a no-hitter (Game 156)  ‚îÇ
‚îÇ  ‚Ä¢ Tigers clinched division (Game 198)      ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [View Standings]  [Continue]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.3 Batch Simulation Performance

For 200+ games, we need efficient batch processing:

```typescript
async function simToNextEvent(
  seasonId: string,
  onProgress?: (progress: SimProgress) => void
): Promise<SimBatchResult> {
  const season = await getSeason(seasonId);
  const nextEvent = findNextMilestone(season);
  const gamesToSim = getGamesUntil(season, nextEvent);

  const results: SimulatedGameResult[] = [];
  const notableEvents: NotableEvent[] = [];

  for (let i = 0; i < gamesToSim.length; i++) {
    const game = gamesToSim[i];

    // Simulate game
    const result = await simulateGame(game, ...);
    results.push(result);

    // Check for notable events
    notableEvents.push(...detectNotableEvents(result));

    // Report progress
    onProgress?.({
      current: i + 1,
      total: gamesToSim.length,
      currentGame: result,
      standings: calculateStandings(results),
    });

    // Yield to UI every 10 games
    if (i % 10 === 0) {
      await new Promise(r => setTimeout(r, 0));
    }
  }

  return { results, notableEvents, nextEvent };
}
```

### 6.4 Cancellation Support

User can cancel mid-simulation:
- Games already simulated remain simulated
- Current game in progress is discarded
- User can continue from where they stopped

---

## 7. Off-Season Simulation

### 7.1 Off-Season Events (Future Consideration)

Off-season events that could potentially be simulated:

| Event | Simulatable? | Notes |
|-------|--------------|-------|
| Award voting | ‚úÖ Yes | Based on season stats |
| Draft | ‚ö†Ô∏è Partial | Could auto-pick based on team needs |
| Free agency | ‚ö†Ô∏è Partial | AI could make signings based on team needs/budget |
| Trades | ‚ùå Manual | Too complex for meaningful simulation |
| Roster cuts | ‚úÖ Yes | Based on ratings/contracts |
| Spring training | ‚úÖ Yes | Minor rating adjustments |

### 7.2 Recommendation

For initial implementation, **off-season events should remain manual**:
- They're infrequent (once per season)
- User decisions matter more here
- Simulation logic would be complex

Future enhancement: "Auto-draft" and "Auto-sign" options for users who want hands-off off-seasons.

---

## 8. Implementation Dependencies

### 8.1 Prerequisites

Before implementing simulation:

- [x] Event log system (Phase 4) - ‚úÖ Complete
- [ ] Season schedule management
- [ ] Roster/lineup management with ratings
- [ ] Standings calculations
- [ ] Playoff bracket system

### 8.2 New Components Needed

| Component | Purpose |
|-----------|---------|
| `SimulationEngine` | Core at-bat simulation logic |
| `ProbabilityModel` | Rating ‚Üí outcome probabilities |
| `ScheduleManager` | Track game status, find next event |
| `BatchSimulator` | Handle "Sim to Next Event" |
| `SimulationUI` | Progress dialogs, confirmations |

### 8.3 Database Schema Additions

```typescript
// GameHeader additions
interface GameHeader {
  // ... existing fields
  isSimulated: boolean;
  simulatedAt: number | null;
  simulationSeed: number | null;
}

// AtBatEvent additions
interface AtBatEvent {
  // ... existing fields
  isSimulated: boolean;
}

// New: Schedule tracking
interface SeasonSchedule {
  seasonId: string;
  games: ScheduledGame[];
  milestones: SeasonEvent[];
  currentGameNumber: number;
}
```

---

## 9. Open Questions

1. **Simulation speed vs. fidelity tradeoff**: How detailed should pitch-by-pitch be? Could simplify to just at-bat outcomes.

2. **Injury simulation**: Should simulated games generate injuries? Could affect realism but adds complexity.

3. **Fatigue/rest**: Should simulation respect pitcher rest days? Probably yes for realism.

4. **Home field advantage**: Small boost for home team? (e.g., 54% win rate vs 50%)

5. **Weather/park factors**: ‚úÖ **RESOLVED** - See Section 9.2 below.

6. **Partial game simulation**: User plays 5 innings, sims the rest? Probably not for v1.

### 9.1 Resolved Questions

| Question | Decision |
|----------|----------|
| How should simulated stats count? | Track separately, allow filtering (manual/sim/all) |
| Randomness in simulation? | Yes, 15-25% variance factor with seeded PRNG |
| Awards for simulated seasons? | No awards for <25% manual play; asterisk for 25-74% |
| How to differentiate fully sim vs partial? | Percentage-based classification (primary/mixed/simulated) |
| Park factors in simulation? | ‚úÖ Yes - see Section 9.2 |

### 9.2 Park Factor Integration

> **See STADIUM_ANALYTICS_SPEC.md** for complete park factor system.

Park factors modify outcome probabilities during game simulation:

```javascript
interface SimulationParkModifiers {
  homeRunChance: number;         // Multiply base HR probability
  doubleChance: number;          // Multiply base 2B probability
  tripleChance: number;          // Multiply base 3B probability
  hitChance: number;             // Multiply base hit probability

  // Per-handedness modifiers
  byHandedness: {
    left: { homeRunChance: number; hitChance: number; };
    right: { homeRunChance: number; hitChance: number; };
  };

  strikeoutChance: number;
  walkChance: number;
}

function getSimulationModifiers(stadiumId: string): SimulationParkModifiers {
  const stadium = getStadium(stadiumId);
  const pf = stadium.parkFactors;

  return {
    homeRunChance: pf.homeRuns,
    doubleChance: pf.doubles,
    tripleChance: pf.triples,
    hitChance: pf.hits,

    byHandedness: {
      left: {
        homeRunChance: pf.leftHandedHR,
        hitChance: pf.leftHandedAVG || pf.hits
      },
      right: {
        homeRunChance: pf.rightHandedHR,
        hitChance: pf.rightHandedAVG || pf.hits
      }
    },

    strikeoutChance: pf.strikeouts,
    walkChance: pf.walks
  };
}
```

#### Applying Park Factors to Plate Appearances

```javascript
function resolvePlateAppearance(
  batter: Player,
  pitcher: Player,
  gameContext: SimulationContext
): PlateAppearanceResult {
  // Get base probabilities from batter/pitcher matchup
  const baseProbs = calculateBaseOutcomeProbabilities(batter, pitcher, gameContext);

  // Apply park factor modifiers for current stadium
  const parkMods = getSimulationModifiers(gameContext.stadiumId);
  const handedness = batter.bats;

  const adjustedProbs = {
    homeRun: baseProbs.homeRun * parkMods.byHandedness[handedness].homeRunChance,
    triple: baseProbs.triple * parkMods.tripleChance,
    double: baseProbs.double * parkMods.doubleChance,
    single: baseProbs.single * parkMods.byHandedness[handedness].hitChance,
    walk: baseProbs.walk * parkMods.walkChance,
    strikeout: baseProbs.strikeout * parkMods.strikeoutChance,
    // Out probability adjusts to maintain total = 1.00
  };

  // Normalize and roll for outcome
  const normalized = normalizeProbabilities(adjustedProbs);
  return selectOutcome(normalized, gameContext.rng);
}
```

#### Confidence Threshold

Only apply park factors when confidence is sufficient:

```javascript
function shouldApplyParkFactors(stadium: Stadium): boolean {
  // Don't apply unreliable factors
  return stadium.parkFactors.confidence !== 'LOW';
}

// In simulation:
if (shouldApplyParkFactors(stadium)) {
  probs = applyParkModifiers(probs, stadium);
} else {
  // Use base probabilities (neutral park assumption)
}

---

## 10. UI Mockups

### 10.1 Schedule View with Sim Options

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Season 1 Schedule                    [Sim to Next Event]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  Game 43 ‚úì  Tigers 5, Yankees 3         [Box Score]        ‚îÇ
‚îÇ  Game 44 ‚úì  Tigers 2, Red Sox 7         [Box Score]        ‚îÇ
‚îÇ  Game 45 üìä Tigers 4, Red Sox 1  (SIM)  [Box] [Unsim]      ‚îÇ
‚îÇ  Game 46 ‚óã  @ Blue Jays                 [Play] [Sim] [Skip]‚îÇ
‚îÇ  Game 47 ‚óã  @ Blue Jays                 [Play] [Sim] [Skip]‚îÇ
‚îÇ  ...                                                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ ALL-STAR BREAK (Game 256) ‚îÄ‚îÄ‚îÄ                         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Game 257 ‚óã  vs Orioles                                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Legend: ‚úì = Played, üìä = Simulated, ‚óã = Scheduled, ‚äò = Skipped
```

### 10.2 Simulated Box Score Indicator

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ üìä SIMULATED GAME                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ This game was simulated, not played manually.        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [Unsimulate] to play this game yourself.             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  TIGERS 4, RED SOX 1                                       ‚îÇ
‚îÇ  Game 45 ‚Ä¢ April 15, 2026                                  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  1  2  3  4  5  6  7  8  9    R  H  E                      ‚îÇ
‚îÇ  0  0  2  0  1  0  0  1  0    4  9  0   Tigers             ‚îÇ
‚îÇ  0  0  0  0  0  1  0  0  0    1  5  1   Red Sox            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ... (normal box score content) ...                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 11. Summary

| Feature | Description | Complexity |
|---------|-------------|------------|
| **Skip Game** | Mark as skipped, adjust thresholds | Low |
| **Simulate Game** | Play-by-play generation from ratings + variance | Medium |
| **Unsimulate** | Revert simulated game to scheduled | Low |
| **Sim to Next Event** | Batch simulate to milestone | Medium |
| **Stat Filtering** | Manual-only / Sim-only / All games views | Low |
| **Season Classification** | Primary (75%+) / Mixed (25-74%) / Simulated (<25%) | Low |
| **Off-Season Sim** | Auto-handle off-season events | High (deferred) |

The simulation system integrates cleanly with the existing event log architecture - simulated at-bats produce the same data structures as manual games, just with an `isSimulated` flag for visual distinction and reversibility.

**Key Design Decisions:**
1. **Randomness**: 15-25% variance factor prevents deterministic outcomes
2. **Stat tracking**: All stats tracked with source flag, filterable in UI
3. **Legitimacy tiers**: Seasons classified by manual play percentage for awards/records
4. **User control**: Thresholds configurable per franchise

---

## 12. References

| Document | Relevance |
|----------|-----------|
| STAT_TRACKING_ARCHITECTURE_SPEC.md | Event log integration |
| FRANCHISE_MODE_SPEC.md | Season/schedule context |
| eventLog.ts | AtBatEvent structure |
| KBL_XHD_TRACKER_MASTER_SPEC_v3.md | Player ratings schema |

---

*Last Updated: January 22, 2026 (v2 - added randomness, stat filtering, season classification)*
*Status: PLANNING - Awaiting completion of prerequisite features*
~~~

### Source File: specs/STAT_TRACKING_ARCHITECTURE_SPEC.md

~~~markdown
# Stat Tracking Architecture Specification

> **Purpose**: Define the architecture for tracking statistics from at-bat ‚Üí game ‚Üí season ‚Üí career
> **Related Specs**: PITCHER_STATS_TRACKING_SPEC.md, KBL_XHD_TRACKER_MASTER_SPEC_v3.md ¬ßDatabase Structure
> **Current State**: Phases 1-4 implemented; Phase 5 (multi-season, career, export) pending

---

## 1. The Problem

### 1.1 Current Architecture (Stateless)

The current implementation rebuilds context from scratch each at-bat:

```typescript
// CURRENT: Stats built fresh each at-bat (index.tsx ~903)
const pitcherStatsForFame = {
  playerId: 'pitcher',
  hitsAllowed: 0,      // Always 0 - no accumulation!
  walksAllowed: 0,     // Always 0
  basesReachedViaError: result === 'E' ? 1 : 0,  // Only knows THIS at-bat
  // ...
};
```

**Consequence**: Perfect game detection fails because `basesReachedViaError` resets to 0 each at-bat. By the 9th inning, we've "forgotten" the error that happened in the 2nd.

### 1.2 Required Architecture (Stateful)

```
AT-BAT EVENT
    ‚Üì
GAME ACCUMULATOR (persists across at-bats within game)
    ‚Üì
SEASON AGGREGATOR (persists across games within season)
    ‚Üì
CAREER TOTALS (persists across seasons)
```

---

## 2. Data Flow Layers

### 2.1 Layer 1: At-Bat Event (Ephemeral)

What happens right now. Each result produces an event:

```typescript
interface AtBatEvent {
  timestamp: number;
  gameId: string;
  inning: number;
  halfInning: 'TOP' | 'BOTTOM';
  outs: number;
  batterId: string;
  pitcherId: string;
  result: AtBatResult;  // '1B', 'K', 'E', etc.
  rbis: number;
  // ... fielding data, ball-in-play data
}
```

**Lifetime**: One at-bat. Triggers detection, then discarded.

### 2.2 Layer 2: Game State (Session Persistence)

Accumulates stats across at-bats within a single game:

```typescript
interface GameState {
  gameId: string;
  awayTeam: string;
  homeTeam: string;

  // Current state
  inning: number;
  halfInning: 'TOP' | 'BOTTOM';
  outs: number;
  bases: Bases;
  score: { away: number; home: number };

  // Accumulated stats per player
  playerStats: Map<string, PlayerGameStats>;

  // Game-level tracking
  leadChanges: LeadChange[];
  maxDeficits: { away: number; home: number };
  atBatHistory: AtBatEvent[];
}

interface PlayerGameStats {
  playerId: string;
  playerName: string;
  teamId: string;

  // Batting (accumulated)
  pa: number;
  ab: number;
  hits: { '1B': number; '2B': number; '3B': number; 'HR': number };
  rbi: number;
  runs: number;
  walks: number;
  strikeouts: number;
  hitOrder: ('1B' | '2B' | '3B' | 'HR')[];  // For cycle detection

  // Pitching (accumulated)
  outsRecorded: number;
  hitsAllowed: number;
  runsAllowed: number;
  earnedRuns: number;
  walksAllowed: number;
  strikeoutsThrown: number;
  homeRunsAllowed: number;
  hitBatters: number;
  basesReachedViaError: number;  // NEW: For perfect game
  wildPitches: number;
  pitchCount: number;
  battersFaced: number;
  consecutiveHRsAllowed: number;

  // Pitching context
  isStarter: boolean;
  entryInning: number;
  inheritedRunners: number;
  bequeathedRunners: number;

  // Fielding (accumulated)
  putouts: number;
  assists: number;
  errors: number;

  // Fame events detected
  fameEvents: FameEvent[];
}
```

**Lifetime**: One game session. Persists across page refreshes (localStorage/IndexedDB).

### 2.3 Layer 3: Season Stats (Long-term Persistence)

Aggregates game stats into season totals:

```typescript
interface PlayerSeasonStats {
  playerId: string;
  seasonId: string;
  teamId: string;

  // Counting stats (sum of all games)
  batting: {
    games: number;
    pa: number;
    ab: number;
    hits: number;
    singles: number;
    doubles: number;
    triples: number;
    homeRuns: number;
    rbi: number;
    runs: number;
    walks: number;
    strikeouts: number;
    hitByPitch: number;
    stolenBases: number;
    caughtStealing: number;
  };

  pitching: {
    games: number;
    gamesStarted: number;
    outsRecorded: number;
    hitsAllowed: number;
    runsAllowed: number;
    earnedRuns: number;
    walksAllowed: number;
    strikeouts: number;
    homeRunsAllowed: number;
    hitBatters: number;
    wildPitches: number;
    wins: number;
    losses: number;
    saves: number;
    holds: number;
    blownSaves: number;
  };

  fielding: {
    games: number;
    putouts: number;
    assists: number;
    errors: number;
    // Per-position breakdown
    byPosition: Map<Position, FieldingStats>;
  };

  // Derived stats (calculated on read)
  calculated: {
    avg: number;    // H / AB
    obp: number;    // (H + BB + HBP) / (AB + BB + HBP + SF)
    slg: number;    // TB / AB
    ops: number;    // OBP + SLG
    era: number;    // (ER / IP) √ó 9
    whip: number;   // (BB + H) / IP
    war: number;    // See WAR specs
  };

  // Achievements
  achievements: {
    qualityStarts: number;
    completeGames: number;
    shutouts: number;
    noHitters: number;
    perfectGames: number;
    cycles: number;
    multiHRGames: number;
  };

  // Fame totals
  fame: {
    bonusPoints: number;
    bonerPoints: number;
    netFame: number;
    events: FameEventSummary[];
  };
}
```

**Lifetime**: One season. Stored in IndexedDB.

### 2.4 Layer 4: Career Stats (Permanent)

Aggregates season stats into career totals:

```typescript
interface PlayerCareerStats {
  playerId: string;

  // Counting stats (sum of all seasons)
  seasons: number;
  // ... same structure as season stats, but totals

  // Career milestones
  milestones: Milestone[];  // 100 HR, 1000 hits, etc.

  // Season-by-season breakdown (for career graphs)
  seasonHistory: PlayerSeasonStats[];
}
```

**Lifetime**: Forever. Stored in IndexedDB, exportable.

---

## 3. The Accumulation Pattern

### 3.1 Event ‚Üí Game Accumulation

When an at-bat completes:

```typescript
function processAtBatEvent(event: AtBatEvent, gameState: GameState): void {
  const batterStats = gameState.playerStats.get(event.batterId);

  // IMPORTANT: Get pitcher using currentPitcher tracking (not fixed IDs)
  const pitcherId = getCurrentPitcherId(); // Uses lineupState.currentPitcher
  const pitcherStats = gameState.playerStats.get(pitcherId);

  // Always increment PA
  batterStats.pa += 1;
  pitcherStats.battersFaced += 1;

  // Update based on result
  switch (event.result) {
    case '1B':
    case '2B':
    case '3B':
    case 'HR':
      batterStats.hits[event.result] += 1;
      batterStats.ab += 1;
      batterStats.hitOrder.push(event.result);
      pitcherStats.hitsAllowed += 1;
      if (event.result === 'HR') pitcherStats.homeRunsAllowed += 1;
      break;

    case 'K':
    case 'KL':
      batterStats.strikeouts += 1;
      batterStats.ab += 1;
      pitcherStats.strikeoutsThrown += 1;
      pitcherStats.outsRecorded += 1;
      break;

    case 'BB':
      batterStats.walks += 1;
      pitcherStats.walksAllowed += 1;
      break;

    case 'E':
      batterStats.ab += 1;  // Reaches, but AB counted
      pitcherStats.basesReachedViaError += 1;  // KEY: Accumulates!
      break;

    // ... other cases
  }

  // Persist to storage
  saveGameState(gameState);
}
```

### 3.2 Pitcher Stats Initialization on Substitution

When a pitching change occurs, the new pitcher must have their stats entry initialized **before** any at-bats are recorded against them:

```typescript
function handleSubstitutionComplete(event: SubstitutionEvent): void {
  if (event.eventType === 'PITCH_CHANGE') {
    const pc = event as PitchingChangeEvent;

    setPitcherGameStats((prev) => {
      const newMap = new Map(prev);

      // CRITICAL: Initialize stats for new pitcher if not already present
      if (!newMap.has(pc.incomingPitcherId)) {
        const teamId = halfInning === 'TOP' ? homeTeamId : awayTeamId;
        newMap.set(pc.incomingPitcherId,
          createInitialPitcherStats(
            pc.incomingPitcherId,
            pc.incomingPitcherName,
            teamId,
            false,  // isStarter = false for relievers
            inning  // entryInning = current inning
          )
        );
      }
      return newMap;
    });

    // Also update lineupState.currentPitcher for stat attribution
    setLineupState((prev) => ({
      ...prev,
      currentPitcher: {
        playerId: pc.incomingPitcherId,
        playerName: pc.incomingPitcherName,
        // ... other fields
      }
    }));
  }
}
```

> **Implementation Note**: Without this initialization, stats for relief pitchers would not
> accumulate because the `pitcherGameStats` Map would have no entry for them. This was fixed
> in the January 2026 implementation audit. See SUBSTITUTION_FLOW_SPEC.md ¬ß6.4 for details.

### 3.3 Game ‚Üí Season Aggregation

When a game ends:

```typescript
function finalizeGame(gameState: GameState, seasonStats: SeasonStats): void {
  for (const [playerId, playerGame] of gameState.playerStats) {
    const playerSeason = seasonStats.getOrCreate(playerId);

    // Aggregate counting stats
    playerSeason.batting.games += 1;
    playerSeason.batting.pa += playerGame.pa;
    playerSeason.batting.ab += playerGame.ab;
    playerSeason.batting.hits += playerGame.totalHits;
    // ... etc

    // Aggregate pitching if applicable
    if (playerGame.outsRecorded > 0) {
      playerSeason.pitching.games += 1;
      if (playerGame.isStarter) playerSeason.pitching.gamesStarted += 1;
      playerSeason.pitching.outsRecorded += playerGame.outsRecorded;
      // ... etc
    }

    // Record achievements
    if (playerGame.isCompleteGame && playerGame.runsAllowed === 0) {
      playerSeason.achievements.shutouts += 1;
    }
    if (checkForCycle(playerGame.hitOrder)) {
      playerSeason.achievements.cycles += 1;
    }
  }

  // Mark game as finalized
  gameState.status = 'COMPLETED';

  // Persist
  saveSeasonStats(seasonStats);
  archiveCompletedGame(gameState);
}
```

### 3.4 Season ‚Üí Career Aggregation

When a season ends:

```typescript
function finalizeSeason(seasonStats: SeasonStats, careerStats: CareerStats): void {
  for (const [playerId, playerSeason] of seasonStats.playerStats) {
    const playerCareer = careerStats.getOrCreate(playerId);

    playerCareer.seasons += 1;
    playerCareer.batting.games += playerSeason.batting.games;
    playerCareer.batting.pa += playerSeason.batting.pa;
    // ... aggregate all stats

    // Check career milestones
    checkCareerMilestones(playerCareer);

    // Archive season snapshot
    playerCareer.seasonHistory.push(playerSeason);
  }

  saveCa reerStats(careerStats);
}
```

---

## 4. Storage Strategy

### 4.1 Storage Tiers

| Data Type | Storage | Rationale |
|-----------|---------|-----------|
| Current at-bat | React state | Ephemeral, UI-only |
| Current game | IndexedDB + React state | Survives refresh, fast access |
| Season stats | IndexedDB | Persistent, queryable |
| Career stats | IndexedDB | Permanent, exportable |
| Historical games | IndexedDB (compressed) | Archival, box scores |

### 4.2 IndexedDB Schema

```typescript
const dbSchema = {
  version: 1,
  stores: {
    games: {
      keyPath: 'gameId',
      indexes: ['seasonId', 'date', 'status']
    },
    playerGameStats: {
      keyPath: ['gameId', 'playerId'],
      indexes: ['playerId', 'seasonId']
    },
    playerSeasonStats: {
      keyPath: ['seasonId', 'playerId'],
      indexes: ['playerId', 'teamId']
    },
    playerCareerStats: {
      keyPath: 'playerId'
    },
    fameEvents: {
      keyPath: 'eventId',
      indexes: ['playerId', 'gameId', 'seasonId', 'eventType']
    }
  }
};
```

### 4.3 Auto-Save Strategy

```typescript
// Save game state on every at-bat completion
// Debounce to avoid excessive writes
const saveGameState = debounce((state: GameState) => {
  idb.put('games', state);
}, 500);

// Also save on visibility change (user switching tabs/closing)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    saveGameStateImmediate(currentGameState);
  }
});
```

---

## 5. Migration Path

### 5.1 Phase 1: In-Game Accumulation ‚úÖ COMPLETED

1. ‚úÖ Replace ad-hoc stat building with persistent `GameState`
2. ‚úÖ Add `PitcherGameStats` map that accumulates across at-bats
3. ‚úÖ Pass accumulated stats to Fame detection (not rebuilt stats)
4. ‚úÖ Add localStorage backup for game recovery
5. ‚úÖ Initialize pitcher stats on substitution (January 2026 fix)
6. ‚úÖ Track `currentPitcher` via lineupState for accurate stat attribution

**Implementation:**
- `PitcherGameStats` interface in `GameTracker/index.tsx`
- `pitcherGameStats` Map state with `updatePitcherStats()` function
- Stats accumulate on each at-bat completion
- `handleSubstitutionComplete()` initializes new pitcher's stats entry
- `getCurrentPitcherId()` uses `lineupState.currentPitcher` after substitutions

### 5.2 Phase 2: Game Persistence ‚úÖ COMPLETED

1. ‚úÖ Add IndexedDB for completed games
2. ‚úÖ Implement game save/load with recovery prompt
3. ‚úÖ Add end-game aggregation to season stats

**Implementation:**
- `src/utils/gameStorage.ts` - IndexedDB CRUD operations
- `src/hooks/useGamePersistence.ts` - Auto-save hook (500ms debounce)
- Recovery modal on page load if saved game exists

### 5.3 Phase 3: Season Management ‚úÖ COMPLETED

1. ‚úÖ Season stats aggregation on game completion
2. ‚úÖ Leaderboards hook with derived stat calculations
3. ‚úÖ Live stats display (season + current game merged)

**Implementation:**
- `src/utils/seasonStorage.ts` - Season stats IndexedDB schema (DB_VERSION=2)
- `src/utils/seasonAggregator.ts` - `aggregateGameToSeason()` called at game end
- `src/hooks/useSeasonStats.ts` - Leaderboard queries with sorting
- `src/utils/liveStatsCalculator.ts` - Merge season + game stats
- `src/hooks/useLiveStats.ts` - Real-time stats during gameplay

### 5.4 Phase 4: Event Log & Data Integrity ‚úÖ COMPLETED

1. ‚úÖ Event log system for bulletproof data preservation
2. ‚úÖ Full situational context capture (enables WAR, Clutch, Leverage recalculation)
3. ‚úÖ Aggregation status tracking with retry logic
4. ‚úÖ Startup integrity check and automatic recovery

**Implementation:**
- `src/utils/eventLog.ts` - Event log database and operations
- `src/hooks/useDataIntegrity.ts` - Startup integrity check and recovery

### 5.5 Phase 5: Multi-Season & Export (PENDING)

1. Career tracking
2. Historical queries
3. JSON/CSV export
4. Cloud sync (optional)

---

## 6. Event Log System (Data Integrity)

### 6.1 Overview

The event log captures every at-bat with full situational context, enabling:
- Complete game reconstruction (box scores)
- Full season stat recalculation from raw events
- Advanced metrics recalculation (WAR, Clutch, Leverage, WPA)
- Fame event recalculation
- Recovery from any crash or write failure

### 6.2 Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   DURING GAMEPLAY                            ‚îÇ
‚îÇ  logAtBatEvent() called IMMEDIATELY after each at-bat       ‚îÇ
‚îÇ  Full situational context captured (not debounced)          ‚îÇ
‚îÇ  Pitching appearances tracked for inherited runners         ‚îÇ
‚îÇ  Fielding events tracked for FWAR                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     GAME END                                 ‚îÇ
‚îÇ  1. completeGame() marks game as finished                   ‚îÇ
‚îÇ  2. aggregateGameToSeason() writes to season stats          ‚îÇ
‚îÇ  3. markGameAggregated() only on SUCCESS                    ‚îÇ
‚îÇ  If step 2 fails ‚Üí game remains aggregated: false           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   APP STARTUP                                ‚îÇ
‚îÇ  useDataIntegrity hook checks for:                          ‚îÇ
‚îÇ  - Unaggregated games (aggregated === false)                ‚îÇ
‚îÇ  - Games with aggregation errors                            ‚îÇ
‚îÇ  - Incomplete games                                         ‚îÇ
‚îÇ  Automatically re-runs aggregation for failed games         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.3 What Gets Captured Per At-Bat

```typescript
interface AtBatEvent {
  // WHO
  batterId, batterName, batterTeamId
  pitcherId, pitcherName, pitcherTeamId

  // RESULT
  result: AtBatResult    // '1B', 'K', 'HR', etc.
  rbiCount, runsScored

  // SITUATION BEFORE (for Leverage Index, Clutch)
  inning, halfInning, outs
  runners: { first, second, third }  // with responsible pitcher IDs
  awayScore, homeScore

  // SITUATION AFTER (for WPA)
  outsAfter, runnersAfter
  awayScoreAfter, homeScoreAfter

  // CALCULATED (stored for efficiency, can recalculate)
  leverageIndex, winProbabilityBefore, winProbabilityAfter, wpa

  // FIELDING
  ballInPlay: { trajectory, zone, velocity, fielderIds }

  // FAME
  fameEvents: FameEventRecord[]

  // FLAGS
  isLeadoff, isClutch, isWalkOff
}
```

### 6.4 Storage Cost

- ~500 bytes per at-bat
- ~70 at-bats per game
- **~35KB per game**
- 162-game season = **~5.7MB** (very manageable)

### 6.5 What This Enables

| Feature | Without Event Log | With Event Log |
|---------|-------------------|----------------|
| Box scores | ‚ùå Only summary | ‚úÖ Full game reconstruction |
| Season rebuild | ‚ùå Must track manually | ‚úÖ Recalculate from events |
| WAR recalculation | ‚ùå Lost context | ‚úÖ Full situational data |
| Clutch/Leverage | ‚ùå Lost context | ‚úÖ Before/after state |
| WPA | ‚ùå Lost context | ‚úÖ Win probability delta |
| Fame recovery | ‚ùå Lost events | ‚úÖ All events preserved |
| Crash recovery | ‚ùå Data lost | ‚úÖ Re-aggregate on startup |

### 6.6 Key Files

| File | Purpose |
|------|---------|
| `src/utils/eventLog.ts` | Event log database, write/read operations, box score generation |
| `src/hooks/useDataIntegrity.ts` | Startup integrity check, automatic recovery |

---

## 7. Live Stats Display System

### 7.1 Overview

The live stats system provides real-time statistics during gameplay by merging stored season stats with current game stats. This enables displaying up-to-the-moment stats like "Season AVG + this game = Live AVG" without any database writes during gameplay.

### 7.2 Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     GAME START                               ‚îÇ
‚îÇ  useLiveStats hook loads season stats from IndexedDB        ‚îÇ
‚îÇ  Stats indexed by player ID in Map for O(1) lookup          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   DURING GAMEPLAY                            ‚îÇ
‚îÇ  calculateLiveBatting(seasonStats, gameStats)               ‚îÇ
‚îÇ  calculateLivePitching(seasonStats, gameStats)              ‚îÇ
‚îÇ  ‚Üí Pure in-memory calculation, ZERO DB writes               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     GAME END                                 ‚îÇ
‚îÇ  aggregateGameToSeason() writes final stats to IndexedDB    ‚îÇ
‚îÇ  (This is the ONLY DB write for stats)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3 Key Files

| File | Purpose |
|------|---------|
| `src/utils/liveStatsCalculator.ts` | Pure functions to merge season + game stats |
| `src/hooks/useLiveStats.ts` | React hook that loads season stats and exposes merge functions |

### 7.4 Usage in GameTracker

```typescript
// Hook loads season stats once at game start
const liveStats = useLiveStats({ autoLoad: true });

// Get live batting for current batter (merges season + game)
const getPlayerLiveBatting = (playerId: string) => {
  const gameStats = playerStats[playerId];
  return liveStats.getLiveBatting(playerId, toGameBattingStats(gameStats));
};

// Get live pitching for current pitcher
const getPitcherLivePitching = (pitcherId: string) => {
  const gameStats = pitcherGameStats.get(pitcherId);
  return liveStats.getLivePitching(pitcherId, toGamePitchingStats(gameStats));
};
```

### 7.5 Live Stats Interfaces

```typescript
interface LiveBattingStats {
  // Combined counting stats (season + game)
  games: number;
  pa: number; ab: number; hits: number;
  homeRuns: number; rbi: number; runs: number;
  walks: number; strikeouts: number;
  stolenBases: number;

  // Derived stats (calculated from combined totals)
  avg: number; obp: number; slg: number; ops: number;

  // This game only (for "today's line" display)
  gameHits: number; gameAB: number;
  gameHR: number; gameRBI: number;
}

interface LivePitchingStats {
  // Combined counting stats
  games: number; gamesStarted: number;
  wins: number; losses: number; saves: number;
  outsRecorded: number; hitsAllowed: number;
  strikeouts: number; earnedRuns: number;

  // Derived stats
  era: number; whip: number;
  inningsPitched: string;  // Formatted: "45.2"

  // This game only
  gameOuts: number; gameHits: number;
  gameER: number; gameK: number;
}
```

### 7.6 Formatting Helpers

```typescript
// Display batting average: ".285" or "---" for no ABs
formatAvg(avg: number, ab: number): string

// Display ERA: "3.45" or "---" for no innings
formatERA(era: number, outs: number): string

// Format batter's game line: "2-4, HR, 2 RBI"
formatBatterGameLine(stats: LiveBattingStats): string

// Format pitcher's game line: "5.2 IP, 3 H, 1 ER, 6 K"
formatPitcherGameLine(stats: LivePitchingStats): string
```

### 7.7 Performance Characteristics

- **Memory**: ~1KB per player with season history (negligible)
- **Load time**: Single IndexedDB read at game start (~10-50ms)
- **Per at-bat**: Zero DB operations, pure in-memory merge
- **CPU**: O(1) player lookup + O(1) stat merge = instant

---

## 8. Impact on Fame System

### 8.1 What Changes

| Detection | Before | After |
|-----------|--------|-------|
| Perfect game | `basesReachedViaError: result === 'E' ? 1 : 0` | `pitcherStats.basesReachedViaError` (accumulated) |
| No-hitter | `hitsAllowed: 0` (always) | `pitcherStats.hitsAllowed` (accumulated) |
| 5-hit game | `totalHits` (rebuilt) | `batterStats.totalHits` (accumulated) |
| Cycle | Hit order not tracked | `batterStats.hitOrder` array |
| Maddux | Pitch count not persisted | `pitcherStats.pitchCount` (accumulated) |

### 8.2 Detection Context Update

```typescript
// BEFORE: Stats rebuilt fresh
const pitcherStatsForFame = {
  hitsAllowed: 0,  // Wrong!
  basesReachedViaError: result === 'E' ? 1 : 0,  // Only this AB
};

// AFTER: Stats from accumulated game state
const pitcherStats = gameState.playerStats.get(currentPitcherId);
// pitcherStats.hitsAllowed is 3 (accumulated from innings 1-6)
// pitcherStats.basesReachedViaError is 1 (from 2nd inning error)
```

---

## 9. Implementation Priority

### Immediate (Fix Fame Detection)

1. Add `pitcherGameStats` map to GameTracker state
2. Accumulate stats on each at-bat completion
3. Pass accumulated stats to `checkForFameEvents`
4. Fix perfect game / no-hitter detection

### Short-term (Game Persistence)

1. Add IndexedDB storage
2. Implement game recovery on page refresh
3. Add game completion handler

### Medium-term (Season Tracking)

1. Season stats aggregation
2. Player dashboards
3. Leaderboards

### Long-term (Full System)

1. Multi-season support
2. Career tracking
3. Historical analysis
4. Export/backup

---

## 10. Related Specs

| Spec | Relationship |
|------|--------------|
| PITCHER_STATS_TRACKING_SPEC.md | Defines what pitching stats to track |
| FAME_SYSTEM_TRACKING.md | Consumer of accumulated stats |
| KBL_XHD_TRACKER_MASTER_SPEC_v3.md | Overall database structure |
| INHERITED_RUNNERS_SPEC.md | ER attribution logic |

---

*Last Updated: January 22, 2026*
*Version: 3.1 - Added pitcher stats initialization on substitution, currentPitcher tracking documentation*
~~~

### Source File: specs/PITCHER_STATS_TRACKING_SPEC.md

~~~markdown
# Pitcher Stats Tracking Specification

> **Purpose**: Define how pitcher statistics are tracked, calculated, and displayed during games
> **Integration**: PWAR_CALCULATION_SPEC.md (uses these stats), INHERITED_RUNNERS_SPEC.md (ER attribution), PITCH_COUNT_TRACKING_SPEC.md (pitch counts)
> **Related Specs**: KBL_XHD_TRACKER_MASTER_SPEC_v3.md ¬ß4 (In-Game Tracking)
> **SMB4 Reference**: SMB4_GAME_MECHANICS.md

---

## Table of Contents

1. [Overview](#1-overview)
2. [Core Counting Stats](#2-core-counting-stats)
3. [Innings Pitched (IP) Calculation](#3-innings-pitched-ip-calculation)
4. [Runs and Earned Runs](#4-runs-and-earned-runs)
5. [Win/Loss/Save Decisions](#5-winlosssave-decisions)
6. [Hold and Blown Save](#6-hold-and-blown-save)
7. [Total Batters Faced (TBF)](#7-total-batters-faced-tbf)
8. [Quality Start and Complete Game](#8-quality-start-and-complete-game)
9. [Special Achievement Detection](#9-special-achievement-detection)
10. [Pitcher Game Line Format](#10-pitcher-game-line-format)
11. [Data Schema](#11-data-schema)
12. [Integration Notes](#12-integration-notes)

---

## 1. Overview

### What This Spec Covers

This spec defines the **tracking mechanics** for pitcher statistics during gameplay:
- When and how stats increment
- Decision rules for W/L/SV/H/BS
- Display formatting for box scores
- Special achievement detection (Maddux, Immaculate Inning, etc.)

### What This Spec Does NOT Cover

- **WAR calculation**: See PWAR_CALCULATION_SPEC.md
- **Inherited runner ER attribution**: See INHERITED_RUNNERS_SPEC.md
- **Pitch count tracking**: See PITCH_COUNT_TRACKING_SPEC.md
- **Pitching change flow**: See SUBSTITUTION_FLOW_SPEC.md

### Design Philosophy

- **Track at the source**: Capture stats as events happen, not derived later
- **Real-time accuracy**: Stats should be accurate at any point during the game
- **SMB4 alignment**: Respect what's possible in the game (no balks, etc.)

---

## 2. Core Counting Stats

### 2.1 Stats Tracked Per Game Appearance

| Stat | Abbrev | Description | When Incremented |
|------|--------|-------------|------------------|
| Innings Pitched | IP | Outs recorded √∑ 3 | Each out recorded |
| Hits Allowed | H | Hits given up | Each hit (1B, 2B, 3B, HR) |
| Runs Allowed | R | Total runs scored | Each run scores |
| Earned Runs | ER | Runs without errors | See INHERITED_RUNNERS_SPEC |
| Strikeouts | K | Batters struck out | Each strikeout |
| Walks | BB | Bases on balls | Each walk (not IBB) |
| Intentional Walks | IBB | Intentional walks | Each IBB |
| Hit By Pitch | HBP | Batters hit | Each HBP |
| Home Runs | HR | Home runs allowed | Each HR |
| Pitch Count | PC | Total pitches | Each pitch |
| Batters Faced | TBF | Total batters faced | Each PA completed |

### 2.2 Event-to-Stat Mapping

```typescript
function updatePitcherStats(event: AtBatResult, pitcher: PitcherGameStats) {
  // Always increment TBF for completed PA
  pitcher.battersFaced += 1;

  switch (event.result) {
    // HITS
    case 'SINGLE':
    case 'DOUBLE':
    case 'TRIPLE':
      pitcher.hits += 1;
      break;
    case 'HOME_RUN':
      pitcher.hits += 1;
      pitcher.homeRuns += 1;
      break;

    // OUTS (add to IP)
    case 'STRIKEOUT':
    case 'STRIKEOUT_LOOKING':
      pitcher.strikeouts += 1;
      pitcher.outsRecorded += 1;
      break;
    case 'GROUNDOUT':
    case 'FLYOUT':
    case 'LINEOUT':
    case 'POPOUT':
      pitcher.outsRecorded += 1;
      break;
    case 'DOUBLE_PLAY':
      pitcher.outsRecorded += 2;
      break;
    case 'TRIPLE_PLAY':
      pitcher.outsRecorded += 3;
      break;

    // WALKS
    case 'WALK':
      pitcher.walks += 1;
      break;
    case 'INTENTIONAL_WALK':
      pitcher.intentionalWalks += 1;
      // Note: IBB doesn't count toward BB for FIP
      break;

    // HBP
    case 'HIT_BY_PITCH':
      pitcher.hitByPitch += 1;
      break;

    // ERRORS (batter reached, no hit charged)
    case 'ERROR':
    case 'FIELDERS_CHOICE':
      // No hit, no out - just TBF already incremented
      break;

    // SACRIFICE (out but different TBF handling)
    case 'SAC_FLY':
    case 'SAC_BUNT':
      pitcher.outsRecorded += 1;
      // TBF already incremented
      break;
  }
}
```

### 2.3 Wild Pitch and Passed Ball

Wild pitches and passed balls are tracked separately but don't affect the core pitching line:

```typescript
// WP is pitcher's fault
if (event.type === 'WILD_PITCH') {
  pitcher.wildPitches += 1;
}

// PB is catcher's fault - no pitcher stat impact
// But runs scoring on WP/PB have ER implications
// See INHERITED_RUNNERS_SPEC.md for attribution
```

---

## 3. Innings Pitched (IP) Calculation

### 3.1 Outs to IP Conversion

Innings Pitched is stored as **outs recorded** internally, then displayed in fractional format.

```typescript
interface PitcherGameStats {
  outsRecorded: number;  // Store as outs (0, 1, 2, 3, 4, 5, ...)
  // IP is derived for display
}

function formatIP(outsRecorded: number): string {
  const fullInnings = Math.floor(outsRecorded / 3);
  const partialOuts = outsRecorded % 3;

  if (partialOuts === 0) {
    return `${fullInnings}.0`;
  } else {
    return `${fullInnings}.${partialOuts}`;
  }
}

// Examples:
// 0 outs  ‚Üí "0.0"
// 1 out   ‚Üí "0.1"
// 2 outs  ‚Üí "0.2"
// 3 outs  ‚Üí "1.0"
// 14 outs ‚Üí "4.2"
// 27 outs ‚Üí "9.0"
```

### 3.2 IP Arithmetic

When aggregating IP across appearances:

```typescript
function addIP(ip1Outs: number, ip2Outs: number): number {
  return ip1Outs + ip2Outs;  // Simple addition when stored as outs
}

function ipToDecimal(outsRecorded: number): number {
  // For rate calculations (ERA, WHIP, etc.)
  return outsRecorded / 3;
}

// Example: 4.2 IP + 2.1 IP
// = 14 outs + 7 outs = 21 outs = 7.0 IP
```

### 3.3 Display Formats

| Context | Format | Example |
|---------|--------|---------|
| Game line | X.X | 6.2, 4.1, 9.0 |
| Season totals | X.X | 142.1, 89.2 |
| Verbal | "X and a third" | "5 and two-thirds" |

---

## 4. Runs and Earned Runs

### 4.1 Run Scoring

When a run scores, determine:
1. Which pitcher is responsible (see INHERITED_RUNNERS_SPEC.md)
2. Whether it's earned or unearned

```typescript
function recordRunScored(
  runner: Runner,
  gameState: GameState,
  responsiblePitcher: Pitcher
) {
  // Always add to Runs
  responsiblePitcher.runsAllowed += 1;

  // Determine if earned
  const isEarned = determineIfEarnedRun(runner, gameState);
  if (isEarned) {
    responsiblePitcher.earnedRuns += 1;
  }
}
```

### 4.2 First Inning Runs (Starters Only)

For starting pitchers, we separately track runs allowed in the first inning for performance analysis.

#### 4.2.1 Initialization Sequence (CRITICAL)

Starting pitchers **MUST** be initialized before the first at-bat occurs. The initialization
sequence establishes the three conditions required for first inning runs tracking:

```
isStarter && entryInning === 1 && gameState.inning === 1
```

**Required Initialization Sequence:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        GAME START SEQUENCE                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  1. GAME START EVENT                                                    ‚îÇ
‚îÇ     ‚îî‚îÄ> Triggered when user starts new game                             ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  2. INITIALIZE STARTING PITCHERS (BEFORE any at-bats)                   ‚îÇ
‚îÇ     ‚îú‚îÄ> Create PitcherGameStats for home starter                        ‚îÇ
‚îÇ     ‚îÇ   ‚Ä¢ isStarter = true                                              ‚îÇ
‚îÇ     ‚îÇ   ‚Ä¢ entryInning = 1                                               ‚îÇ
‚îÇ     ‚îÇ   ‚Ä¢ entryOuts = 0                                                 ‚îÇ
‚îÇ     ‚îÇ   ‚Ä¢ firstInningRuns = 0                                           ‚îÇ
‚îÇ     ‚îÇ                                                                   ‚îÇ
‚îÇ     ‚îî‚îÄ> Create PitcherGameStats for away starter                        ‚îÇ
‚îÇ         ‚Ä¢ isStarter = true                                              ‚îÇ
‚îÇ         ‚Ä¢ entryInning = 1                                               ‚îÇ
‚îÇ         ‚Ä¢ entryOuts = 0                                                 ‚îÇ
‚îÇ         ‚Ä¢ firstInningRuns = 0                                           ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  3. FIRST AT-BAT BEGINS                                                 ‚îÇ
‚îÇ     ‚îî‚îÄ> Now tracking is active with all conditions met                  ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Code Example - Correct Initialization:**

```typescript
function initializeGame(gameConfig: GameConfig): GameState {
  const gameState: GameState = {
    inning: 1,
    halfInning: 'TOP',
    outs: 0,
    // ... other game state
  };

  // CRITICAL: Initialize starting pitchers BEFORE first at-bat
  const homePitcherStats = initializeStartingPitcher(
    gameConfig.homeStartingPitcher,
    'home',
    gameState
  );

  const awayPitcherStats = initializeStartingPitcher(
    gameConfig.awayStartingPitcher,
    'away',
    gameState
  );

  return gameState;
}

function initializeStartingPitcher(
  pitcher: Pitcher,
  team: 'home' | 'away',
  gameState: GameState
): PitcherGameStats {
  // Validate: Must be inning 1 with 0 outs
  if (gameState.inning !== 1 || gameState.outs !== 0) {
    throw new Error(
      `Starting pitcher must be initialized at start of game. ` +
      `Current state: inning ${gameState.inning}, outs ${gameState.outs}`
    );
  }

  return {
    pitcherId: pitcher.id,
    pitcherName: pitcher.name,
    team: team,

    // CRITICAL: These three fields enable first inning tracking
    isStarter: true,
    entryInning: 1,
    entryOuts: 0,

    // Initialize all counting stats
    outsRecorded: 0,
    hits: 0,
    runsAllowed: 0,
    earnedRuns: 0,
    walks: 0,
    intentionalWalks: 0,
    strikeouts: 0,
    hitByPitch: 0,
    homeRuns: 0,
    wildPitches: 0,
    pitchCount: 0,
    battersFaced: 0,

    // Starter-specific (initialized to 0)
    firstInningRuns: 0,
    basesReachedViaError: 0,

    // Other fields...
    inheritedRunners: 0,
    inheritedRunnersScored: 0,
    bequeathedRunners: 0,
    bequeathedRunnersScored: 0,
    enteredInSaveSituation: false,
    leadLostDuringAppearance: false,
    finishedGame: false,
    immaculateInnings: []
  };
}
```

#### 4.2.2 Error Case: Delayed Initialization

If pitcher initialization is delayed until after the first at-bat, first inning runs
tracking will **silently fail** because the conditions cannot be properly established.

**What Happens If Initialization Is Delayed:**

```typescript
// WRONG: Initializing after first at-bat has started
function handleFirstAtBat(event: AtBatEvent, gameState: GameState) {
  // ERROR: Pitcher doesn't exist yet!
  const pitcher = getPitcherStats(event.pitcherId);
  if (!pitcher) {
    // Late initialization - this is WRONG
    pitcher = {
      isStarter: true,
      entryInning: gameState.inning,  // Might be > 1 if runs scored
      // ...
    };
  }
}

// If a run scores before initialization:
// - gameState.inning might already be > 1 (if scoring advanced innings)
// - entryInning will be set incorrectly
// - firstInningRuns will never increment because condition fails
```

**Detection of Initialization Errors:**

```typescript
function validatePitcherInitialization(
  pitcher: PitcherGameStats,
  gameState: GameState
): void {
  // Check: If this is supposed to be a starter, verify timing
  if (pitcher.isStarter) {
    if (pitcher.entryInning !== 1) {
      console.error(
        `INITIALIZATION ERROR: Starting pitcher ${pitcher.pitcherName} ` +
        `has entryInning=${pitcher.entryInning}. ` +
        `First inning runs tracking will be incorrect.`
      );
    }
    if (pitcher.entryOuts !== 0) {
      console.error(
        `INITIALIZATION ERROR: Starting pitcher ${pitcher.pitcherName} ` +
        `has entryOuts=${pitcher.entryOuts}. ` +
        `Pitcher should enter with 0 outs.`
      );
    }
  }
}
```

#### 4.2.3 First Inning Runs Recording

Once properly initialized, first inning runs are tracked as follows:

```typescript
function recordRunScored(
  runner: Runner,
  gameState: GameState,
  responsiblePitcher: PitcherGameStats
) {
  responsiblePitcher.runsAllowed += 1;

  // Track first inning runs for starters
  // IMPORTANT: Only increment when ALL THREE conditions are true:
  // 1. Pitcher is a starter (isStarter === true)
  // 2. Pitcher entered in inning 1 (entryInning === 1)
  // 3. Current game inning is still inning 1 (gameState.inning === 1)
  if (responsiblePitcher.isStarter &&
      responsiblePitcher.entryInning === 1 &&
      gameState.inning === 1) {
    responsiblePitcher.firstInningRuns += 1;
  }

  // ... ER attribution continues below
}
```

> **Implementation Note**: The `inning === 1` check is critical. Without it, ALL runs
> against starters would be counted as "first inning runs," which would produce incorrect
> statistics. This was fixed in the January 2026 implementation audit.

> **Initialization Note**: The `entryInning === 1` check validates that the pitcher
> was properly initialized as a starter before the game began. If initialization
> was delayed, this check will fail and first inning runs won't be tracked.

### 4.3 Earned Run Summary

> **Full ER/UER logic is in INHERITED_RUNNERS_SPEC.md**

Quick reference:

| Scenario | Earned? |
|----------|---------|
| Runner reached on hit, scored normally | ‚úÖ Earned |
| Runner reached on error | ‚ùå Unearned |
| Runner advanced due to error | ‚ùå Unearned |
| Runner scored on error | ‚ùå Unearned |
| Inning extended by error, then run scores | ‚ùå Unearned |
| Runner scored on wild pitch | ‚úÖ Earned (pitcher's fault) |
| Runner scored on passed ball | ‚ùå Unearned (catcher's fault) |

> **Note**: Passed balls are the catcher's fault, not the pitcher's. Runs scoring on PB are unearned per MLB Rule 9.16(e).

---

## 5. Win/Loss/Save Decisions

### 5.1 Core Concepts

- **Decision**: A W, L, or ND (No Decision) assigned to each pitcher
- **Pitcher of Record**: The pitcher in line for W or L based on game state
- **Only one W and one L per game** (each team)

### 5.2 Win (W) Rules

```typescript
function determineWinningPitcher(game: CompletedGame): Pitcher | null {
  const winningTeam = game.homeScore > game.awayScore ? 'home' : 'away';
  const pitchers = game.pitchers.filter(p => p.team === winningTeam);

  // Find the pitcher of record when the winning team took the lead for good
  const leadChanges = game.leadChanges;
  const finalLeadChange = leadChanges.findLast(lc => lc.team === winningTeam && !lc.wasLost);

  if (!finalLeadChange) return null;

  const pitcherOfRecord = finalLeadChange.pitcherAtTime;

  // STARTING PITCHER WIN REQUIREMENT
  if (pitcherOfRecord.isStarter) {
    // Starter must pitch at least 5 innings to qualify for win
    // Exception: In shorter games (6-7 innings), minimum scales down
    const minOuts = getMinimumOutsForStarterWin(game.scheduledInnings);
    if (pitcherOfRecord.outsRecorded < minOuts) {
      // Win goes to most effective reliever instead
      return findMostEffectiveReliever(pitchers, finalLeadChange.inning);
    }
  }

  return pitcherOfRecord;
}

function getMinimumOutsForStarterWin(scheduledInnings: number): number {
  // MLB rule: 5 IP minimum (15 outs) for 9-inning games
  // Scale for shorter games
  if (scheduledInnings >= 9) return 15;  // 5.0 IP
  if (scheduledInnings === 7) return 12;  // 4.0 IP
  if (scheduledInnings === 6) return 9;   // 3.0 IP
  return Math.floor(scheduledInnings / 2) * 3;  // Half the game
}

/**
 * Find the most effective reliever for win assignment when starter doesn't qualify.
 * MLB Rule: Scorer's discretion, typically longest appearance among eligible relievers.
 */
function findMostEffectiveReliever(
  pitchers: PitcherAppearance[],
  leadTakenInning: number
): Pitcher | null {
  const eligibleRelievers = pitchers.filter(p =>
    !p.isStarter &&
    p.entryInning <= leadTakenInning  // Must have been in game when lead taken
  );

  if (eligibleRelievers.length === 0) return null;

  // Primary: Longest appearance (most outs recorded)
  // Tiebreaker: Entered earliest
  return eligibleRelievers.sort((a, b) => {
    if (b.outsRecorded !== a.outsRecorded) {
      return b.outsRecorded - a.outsRecorded;
    }
    return a.entryInning - b.entryInning;
  })[0];
}
```

### 5.3 Loss (L) Rules

```typescript
function determineLosingPitcher(game: CompletedGame): Pitcher | null {
  const losingTeam = game.homeScore < game.awayScore ? 'home' : 'away';

  // Find the pitcher who gave up the lead for the last time
  // (the run that made the score go from tied/ahead to behind and never recovered)
  const criticalRun = findCriticalGoAheadRun(game, losingTeam);

  if (!criticalRun) return null;

  // The pitcher responsible for that runner gets the L
  return criticalRun.pitcherResponsible;
}

/**
 * Find the run that gave the opponent the lead they never lost.
 * Returns the RunScored event and the pitcher responsible.
 */
function findCriticalGoAheadRun(game: CompletedGame, losingTeam: string): RunScored | null {
  // Work backwards through runs scored against the losing team
  // Find the run that put opponent ahead and they never lost that lead
  const opponentTeam = losingTeam === 'home' ? 'away' : 'home';

  let currentLeadForOpponent = 0;
  let criticalRun: RunScored | null = null;

  for (const run of game.runsScored) {
    if (run.scoringTeam === opponentTeam) {
      currentLeadForOpponent += 1;
      // If this run gave opponent the lead
      const scoreBefore = game.getScoreAtPoint(run.timestamp);
      const wasGoAhead = scoreBefore[opponentTeam] === scoreBefore[losingTeam];
      if (wasGoAhead) {
        criticalRun = run;  // This might be THE run if lead holds
      }
    } else {
      currentLeadForOpponent -= 1;
      if (currentLeadForOpponent <= 0) {
        criticalRun = null;  // Lead was lost, reset
      }
    }
  }

  return criticalRun;
}
```

### 5.4 No Decision (ND)

A pitcher gets a No Decision if:
- They left with the game tied
- Their team lost the lead after they left
- The game was tied when they left and opponent later took lead

### 5.5 Decision Assignment Flow

```
Game ends ‚Üí Determine winning team
          ‚Üí Find when winning team took final lead
          ‚Üí Identify pitcher of record (POR) at that moment
          ‚Üí If POR is starter with <5 IP: give W to best reliever
          ‚Üí Otherwise: POR gets W
          ‚Üí Pitcher who allowed go-ahead run gets L
          ‚Üí All others get ND
```

### 5.6 Example Scenarios

**Scenario 1: Starter goes 6 IP, leaves with lead, team wins**
```
Starter:  6.0 IP, left leading 4-2
Reliever: 3.0 IP, maintained lead
Final: 4-3 W

‚Üí Starter gets W (was POR when lead was taken, had 5+ IP)
‚Üí Reliever gets ND
```

**Scenario 2: Starter leaves early, reliever holds**
```
Starter:  3.2 IP, left trailing 3-1
Reliever1: 2.1 IP, team tied it, then took lead during his stint
Reliever2: 3.0 IP, held lead
Final: 5-3 W

‚Üí Starter gets ND (left trailing, never had lead)
‚Üí Reliever1 gets W (was POR when lead was taken)
‚Üí Reliever2 gets ND
```

**Scenario 3: Blown lead**
```
Starter: 7.0 IP, left leading 3-2
Reliever: 2.0 IP, gave up 2 runs, team lost
Final: 4-3 L

‚Üí Starter gets ND (left with lead but team lost)
‚Üí Reliever gets L (gave up go-ahead run)
```

---

## 6. Hold and Blown Save

### 6.1 Save (SV) Rules

A save is credited when a pitcher:

```typescript
function qualifiesForSave(pitcher: PitcherAppearance, game: CompletedGame): boolean {
  // Must be a reliever (not the starter)
  if (pitcher.isStarter) return false;

  // Team must win
  if (!game.teamWon(pitcher.team)) return false;

  // Must finish the game
  if (!pitcher.finishedGame) return false;

  // Must not be winning pitcher
  if (pitcher === game.winningPitcher) return false;

  // Must meet one of these criteria:
  return (
    // 1. Entered with lead of 3 or fewer runs and pitched at least 1 inning
    (pitcher.leadWhenEntered <= 3 && pitcher.outsRecorded >= 3) ||

    // 2. Entered with tying run on base, at bat, or on deck
    pitcher.tyingRunInScoringPosition ||

    // 3. Pitched at least 3 innings
    pitcher.outsRecorded >= 9
  );
}
```

### 6.2 Save Opportunity

Track when a pitcher enters a save situation:

```typescript
function isSaveOpportunity(gameState: GameState, pitcher: Pitcher): boolean {
  const lead = gameState.getLeadForTeam(pitcher.team);

  // Must have a lead
  if (lead <= 0) return false;

  // Must be in final 3 innings (or extra innings)
  if (gameState.inning < gameState.scheduledInnings - 2) return false;

  // Check criteria
  return (
    lead <= 3 ||
    gameState.tyingRunOnBase ||
    gameState.tyingRunAtBat ||
    gameState.tyingRunOnDeck
  );
}
```

### 6.3 Hold (HLD) Rules

A hold is credited when a reliever:

```typescript
function qualifiesForHold(pitcher: PitcherAppearance, game: CompletedGame): boolean {
  // Must be a reliever
  if (pitcher.isStarter) return false;

  // Team must win
  if (!game.teamWon(pitcher.team)) return false;

  // Must NOT be the final pitcher (that's potentially a save)
  if (pitcher.finishedGame) return false;

  // Must have entered in a save situation
  if (!pitcher.enteredInSaveSituation) return false;

  // Must have maintained the lead (not blown save)
  if (pitcher.blownSave) return false;

  // Must have recorded at least 1 out
  if (pitcher.outsRecorded < 1) return false;

  // Must not be the winning pitcher
  if (pitcher === game.winningPitcher) return false;

  return true;
}
```

### 6.4 Blown Save (BS) Rules

```typescript
function isBlownSave(pitcher: PitcherAppearance): boolean {
  // Must have entered in save situation
  if (!pitcher.enteredInSaveSituation) return false;

  // Must have allowed the tying or go-ahead run
  // (Lead was lost during their appearance)
  return pitcher.leadLostDuringAppearance;
}
```

**Note**: A pitcher can get both a BS and a W (if team comes back).

---

## 7. Total Batters Faced (TBF)

### 7.1 Definition

TBF counts every completed plate appearance against a pitcher.

```typescript
function incrementTBF(pitcher: PitcherGameStats, paResult: PAResult) {
  // Increment for ANY completed PA
  // Includes: hits, outs, walks, HBP, errors, FC, etc.
  pitcher.tbf += 1;
}
```

### 7.2 TBF vs IP Relationship

```
Average TBF per inning ‚âà 4.3 (MLB)
TBF = (IP √ó 3) + Hits + Walks + HBP + Errors - Double Plays
```

### 7.3 Usage

TBF is used for:
- Pitch efficiency (PC/TBF)
- Rate stats when IP is too small (1-inning relievers)
- Workload tracking

---

## 8. Quality Start and Complete Game

### 8.1 Quality Start (QS)

```typescript
function isQualityStart(starter: PitcherGameStats, gameInnings: number): boolean {
  // Standard: 6+ IP, 3 or fewer ER
  // Scale for shorter games

  const minOuts = gameInnings >= 9 ? 18 : Math.floor(gameInnings * 2);  // 2/3 of game
  const maxER = gameInnings >= 9 ? 3 : Math.ceil(gameInnings / 3);

  return starter.outsRecorded >= minOuts && starter.earnedRuns <= maxER;
}
```

| Game Length | Min IP | Max ER |
|-------------|--------|--------|
| 9 innings | 6.0 | 3 |
| 7 innings | 4.2 | 3 |
| 6 innings | 4.0 | 2 |

### 8.2 Complete Game (CG)

```typescript
function isCompleteGame(pitcher: PitcherGameStats, game: CompletedGame): boolean {
  // Pitcher must pitch entire game for their team
  // (All defensive innings)
  return pitcher.outsRecorded === game.totalOuts && pitcher.isStarter;
}
```

### 8.3 Shutout (SHO)

```typescript
function isShutout(pitcher: PitcherGameStats, game: CompletedGame): boolean {
  return isCompleteGame(pitcher, game) && pitcher.runsAllowed === 0;
}
```

### 8.4 Combined Shutout

When multiple pitchers combine for a shutout:
- Track as team achievement
- No individual SHO credit
- All participating pitchers get narrative mention

---

## 9. Special Achievement Detection

### 9.1 Maddux

A Maddux is a complete game shutout with low pitch count.

```typescript
function isMaddux(pitcher: PitcherGameStats, game: CompletedGame): boolean {
  if (!isShutout(pitcher, game)) return false;

  // Pitch threshold scales with game length
  const threshold = getMadduxThreshold(game.scheduledInnings);
  return pitcher.pitchCount < threshold;
}

function getMadduxThreshold(innings: number): number {
  // Threshold is < (innings √ó 9.44), rounded down
  // 9 innings: < 85 pitches (9 √ó 9.44 = 84.96, so threshold is 85)
  // 7 innings: < 66 pitches (7 √ó 9.44 = 66.08, so threshold is 66)
  // 6 innings: < 57 pitches (6 √ó 9.44 = 56.64, so threshold is 57)
  return Math.ceil(innings * 9.44);
}
```

**Fame Bonus**: +3 for Maddux (see SPECIAL_EVENTS_SPEC.md)

### 9.2 Immaculate Inning

9 pitches, 9 strikes, 3 strikeouts in a single inning.

```typescript
interface InningPitchData {
  inning: number;
  pitches: number;
  outsRecorded: number;  // Outs in this inning (for 9-pitch inning detection)
  strikeouts: number;
  // Note: strikes count not tracked in SMB4 (no pitch location data)
}

function isImmaculateInning(inningData: InningPitchData): boolean {
  // Immaculate Inning: 9 pitches, 3 strikeouts
  // Note: In real baseball, all 9 pitches must be strikes.
  // In SMB4, we can't track strikes (no pitch location data).
  // We infer it: 9 pitches + 3 Ks = must be 3 pitches per K = all strikes.
  return (
    inningData.pitches === 9 &&
    inningData.strikeouts === 3 &&
    inningData.outsRecorded === 3
  );
}
```

**Detection**: Track per-inning pitch data. At end of each inning, check criteria.

**Fame Bonus**: +2 for Immaculate Inning

### 9.3 9-Pitch Inning (Non-Immaculate)

3 outs on exactly 9 pitches, but not all strikeouts.

```typescript
function isNinePitchInning(inningData: InningPitchData): boolean {
  return (
    inningData.pitches === 9 &&
    inningData.outsRecorded === 3 &&
    !isImmaculateInning(inningData)  // Not already immaculate
  );
}
```

**Fame Bonus**: +1 for 9-pitch inning

### 9.4 No-Hitter

```typescript
function isNoHitter(pitcher: PitcherGameStats, game: CompletedGame): boolean {
  return isCompleteGame(pitcher, game) && pitcher.hits === 0;
}
```

**Fame Bonus**: +3 for No-Hitter

### 9.5 Perfect Game

```typescript
function isPerfectGame(pitcher: PitcherGameStats, game: CompletedGame): boolean {
  // Perfect game: no baserunners allowed at all
  // Check: no hits, no walks, no HBP, and no errors by defense during pitcher's stint
  return (
    isNoHitter(pitcher, game) &&
    pitcher.walks === 0 &&
    pitcher.hitByPitch === 0 &&
    game.getErrorsWhilePitcherOnMound(pitcher.pitcherId) === 0
  );
}

// Note: game.getErrorsWhilePitcherOnMound() tracks defensive errors
// that occurred while this pitcher was pitching. This is a game-level
// stat, not stored in PitcherGameStats directly.
```

**Fame Bonus**: +5 for Perfect Game

### 9.6 Detection Timing

| Achievement | When to Check |
|-------------|---------------|
| Immaculate Inning | End of each inning |
| 9-Pitch Inning | End of each inning |
| Maddux | End of game |
| No-Hitter | End of game |
| Perfect Game | End of game |

---

## 10. Pitcher Game Line Format

### 10.1 Standard Box Score Format

```
NAME            IP    H    R   ER   BB    K   HR   PC
Smith (W, 8-3)  6.0   5    2    2    1    7    1   89
Jones           2.0   1    0    0    0    3    0   28
Davis (S, 15)   1.0   0    0    0    1    2    0   19
```

### 10.2 Format Specification

```typescript
interface PitcherGameLine {
  name: string;
  decision?: 'W' | 'L' | 'S' | 'H' | 'BS';  // If applicable
  seasonRecord?: { wins: number; losses: number };  // For starters
  saveNumber?: number;  // For closers

  ip: string;      // "6.0", "4.2"
  h: number;       // Hits
  r: number;       // Runs
  er: number;      // Earned Runs
  bb: number;      // Walks
  k: number;       // Strikeouts
  hr: number;      // Home Runs
  pc: number;      // Pitch Count
}

function formatPitcherLine(stats: PitcherGameStats, decision?: string): string {
  const name = stats.name;
  const decisionStr = decision ? ` (${decision})` : '';

  return [
    `${name}${decisionStr}`.padEnd(16),
    formatIP(stats.outsRecorded).padStart(4),
    stats.hits.toString().padStart(5),
    stats.runsAllowed.toString().padStart(5),
    stats.earnedRuns.toString().padStart(5),
    stats.walks.toString().padStart(5),
    stats.strikeouts.toString().padStart(5),
    stats.homeRuns.toString().padStart(5),
    stats.pitchCount.toString().padStart(5)
  ].join('');
}
```

### 10.3 Extended Format (with inherited runners)

```
NAME            IP    H    R   ER   BB    K   HR   PC   IR  IRS
Smith (W, 8-3)  6.0   5    2    2    1    7    1   89    -    -
Jones           2.0   1    1    0    0    3    0   28    2    1
Davis (S, 15)   1.0   0    0    0    1    2    0   19    1    0
```

- **IR**: Inherited Runners
- **IRS**: Inherited Runners Scored (charged to previous pitcher)

---

## 11. Data Schema

### 11.1 Pitcher Game Stats

```typescript
interface PitcherGameStats {
  pitcherId: string;
  pitcherName: string;
  gameId: string;
  team: 'home' | 'away';

  // Role
  isStarter: boolean;
  entryInning: number;
  entryOuts: number;
  exitInning?: number;
  exitOuts?: number;
  finishedGame: boolean;

  // Core Stats (stored)
  outsRecorded: number;  // IP derived from this
  hits: number;
  runsAllowed: number;
  earnedRuns: number;
  walks: number;
  intentionalWalks: number;
  strikeouts: number;
  hitByPitch: number;
  homeRuns: number;
  wildPitches: number;
  pitchCount: number;
  battersFaced: number;

  // Starter-specific tracking
  firstInningRuns: number;       // Runs allowed in the 1st inning only (starters only)
  basesReachedViaError: number;  // Runners who reached via error (for perfect game detection)

  // Decision
  decision?: 'W' | 'L' | 'ND';
  save?: boolean;
  hold?: boolean;
  blownSave?: boolean;

  // Inherited Runners
  inheritedRunners: number;
  inheritedRunnersScored: number;

  // Bequeathed Runners
  bequeathedRunners: number;
  bequeathedRunnersScored: number;

  // Context
  leadWhenEntered?: number;
  enteredInSaveSituation: boolean;
  leadLostDuringAppearance: boolean;

  // Special Achievements
  qualityStart?: boolean;
  completeGame?: boolean;
  shutout?: boolean;
  noHitter?: boolean;
  perfectGame?: boolean;
  maddux?: boolean;
  immaculateInnings: number[];  // Which innings
}
```

### 11.2 Season Aggregation

```typescript
interface PitcherSeasonStats {
  pitcherId: string;
  season: number;
  team: string;

  // Counting Stats
  gamesPlayed: number;
  gamesStarted: number;
  outsRecorded: number;  // Total IP in outs
  hits: number;
  runsAllowed: number;
  earnedRuns: number;
  walks: number;
  intentionalWalks: number;
  strikeouts: number;
  hitByPitch: number;
  homeRuns: number;
  wildPitches: number;
  totalPitches: number;
  totalBattersFaced: number;

  // Decisions
  wins: number;
  losses: number;
  saves: number;
  holds: number;
  blownSaves: number;

  // Derived Stats (calculated)
  era: number;           // (ER / IP) √ó 9
  whip: number;          // (BB + H) / IP
  kPer9: number;         // (K / IP) √ó 9
  bbPer9: number;        // (BB / IP) √ó 9
  hrPer9: number;        // (HR / IP) √ó 9
  fip: number;           // See PWAR_CALCULATION_SPEC

  // Achievements
  qualityStarts: number;
  completeGames: number;
  shutouts: number;
  noHitters: number;
  perfectGames: number;
  madduxes: number;
  immaculateInnings: number;

  // Inherited Runners
  totalInheritedRunners: number;
  totalInheritedRunnersScored: number;
  inheritedRunnersScoredPct: number;
}
```

---

## 12. Integration Notes

### 12.1 With PWAR_CALCULATION_SPEC

pWAR uses:
- `outsRecorded` ‚Üí IP for FIP denominator
- `strikeouts` ‚Üí K for FIP
- `walks` (NOT intentionalWalks) ‚Üí BB for FIP
- `hitByPitch` ‚Üí HBP for FIP
- `homeRuns` ‚Üí HR for FIP
- `gamesStarted` vs `gamesPlayed` ‚Üí Starter/Reliever split

### 12.2 With INHERITED_RUNNERS_SPEC

ER attribution handled there. This spec only tracks:
- `runsAllowed` (total)
- `earnedRuns` (result of attribution)
- `inheritedRunners` / `inheritedRunnersScored` (for display)

### 12.3 With PITCH_COUNT_TRACKING_SPEC

This spec uses pitch count for:
- Maddux detection
- Immaculate inning detection
- Box score display
- TBF correlation

### 12.4 With SPECIAL_EVENTS_SPEC

Fame bonuses awarded by SPECIAL_EVENTS_SPEC:
- Maddux: +3
- Immaculate Inning: +2
- 9-Pitch Inning: +1
- No-Hitter: +3
- Perfect Game: +5

This spec provides the **detection logic**; SPECIAL_EVENTS_SPEC provides the **Fame values**.

### 12.5 With SUBSTITUTION_FLOW_SPEC

When pitching change occurs:
1. SUBSTITUTION_FLOW_SPEC handles the flow
2. This spec captures outgoing pitcher's final stats
3. INHERITED_RUNNERS_SPEC tracks runner ownership

### 12.6 Current Pitcher Tracking

The `lineupState.currentPitcher` field tracks the **actual** pitcher currently on the mound after any substitutions:

```typescript
function getCurrentPitcherId(): string {
  // CORRECT: Use lineupState.currentPitcher if set (after substitution)
  if (lineupState.currentPitcher) {
    return lineupState.currentPitcher.playerId;
  }
  // Fallback: Use default pitcher IDs for starting pitchers
  return halfInning === 'TOP' ? 'home_pitcher' : 'away_pitcher';
}
```

> **Implementation Note**: When a pitching change occurs, `lineupState.currentPitcher` is
> updated with the new pitcher's information. All subsequent stat accumulation uses this
> value to correctly attribute stats to the relief pitcher rather than the starter.
> This was fixed in the January 2026 implementation audit.

---

## Appendix: Quick Reference

### IP Conversion Table

| Outs | IP Display | Decimal |
|------|------------|---------|
| 0 | 0.0 | 0.000 |
| 1 | 0.1 | 0.333 |
| 2 | 0.2 | 0.667 |
| 3 | 1.0 | 1.000 |
| 4 | 1.1 | 1.333 |
| 5 | 1.2 | 1.667 |
| 6 | 2.0 | 2.000 |
| 14 | 4.2 | 4.667 |
| 27 | 9.0 | 9.000 |

### Decision Assignment Cheat Sheet

| Situation | W | L | Notes |
|-----------|---|---|-------|
| Starter 6+ IP, team wins | Starter | Opponent | Standard |
| Starter 4 IP, team wins | Best reliever | Opponent | Starter didn't qualify |
| Reliever takes lead, holds | Reliever | Opponent | |
| Reliever blows lead, team wins anyway | Reliever (W+BS) | Opponent | Can have both |
| Starter leaves leading, reliever blows | Starter (ND) | Reliever | |

### Maddux Thresholds

| Innings | Pitch Threshold |
|---------|-----------------|
| 9 | < 85 |
| 7 | < 66 |
| 6 | < 57 |
| 5 | < 47 |

---

*Last Updated: January 24, 2026*
*Version: 1.2 - Added explicit initialization sequence documentation for first inning runs tracking (Section 4.2.1-4.2.3)*
~~~

### Source File: specs/PITCH_COUNT_TRACKING_SPEC.md

~~~markdown
# Pitch Count Tracking Specification

> **Purpose**: Define when and how pitch counts are captured during in-game tracking
> **Integration**: PWAR_CALCULATION_SPEC.md, INHERITED_RUNNERS_SPEC.md
> **Related Specs**: KBL_XHD_TRACKER_MASTER_SPEC_v3.md ¬ß4 (In-Game Tracking)

---

## Table of Contents

1. [Overview](#1-overview)
2. [When to Track Pitch Counts](#2-when-to-track-pitch-counts)
3. [Entry Methods](#3-entry-methods)
4. [Per-Inning vs Cumulative](#4-per-inning-vs-cumulative)
5. [UI Flow](#5-ui-flow)
6. [Data Schema](#6-data-schema)
7. [Validation Rules](#7-validation-rules)
8. [Integration Points](#8-integration-points)

---

## 1. Overview

### Why Track Pitch Counts?

Pitch counts are used for:
- **Pitcher workload management** - Identifying fatigue
- **Narrative generation** - "Cole labored through 98 pitches..."
- **Manager evaluation** - Did they leave a tired pitcher in too long?
- **Historical comparison** - Season pitch count totals

### Design Goal

**Minimize data entry while maximizing accuracy.**

We do NOT track pitch-by-pitch (too slow). Instead, we capture cumulative pitch counts at strategic moments.

---

## 2. When to Track Pitch Counts

### 2.1 Mandatory Capture Points

| Trigger | When | Why |
|---------|------|-----|
| **Pitching Change** | Before confirming change | Last chance to capture outgoing pitcher's count |
| **End of Game** | After final out | Capture final counts for all pitchers |
| **Starter Exit** | When starter leaves | Critical for workload tracking |

### 2.2 Optional Capture Points

| Trigger | When | Why |
|---------|------|-----|
| **End of Inning** | Between half-innings | More granular tracking (user preference) |
| **High Pitch Count Alert** | At 80, 100, 120 pitches | Notify user to verify accuracy |
| **Long At-Bat** | 7+ pitch AB completed | Can prompt for verification |

### 2.3 Decision: Per-Inning vs End-of-Game Only

**Recommendation: Mandatory at pitching changes, optional per-inning.**

```javascript
const PITCH_COUNT_CONFIG = {
  // Always required
  mandatoryOnPitchingChange: true,
  mandatoryOnGameEnd: true,

  // User preference (settings)
  promptPerInning: false,  // Default: off (faster entry)
  showHighPitchCountAlert: true,
  highPitchCountThreshold: 100
};
```

---

## 3. Entry Methods

### 3.1 Cumulative Entry (Recommended)

User enters the **total pitches thrown so far**. App calculates per-inning.

```
Enter CUMULATIVE pitch count: [72]

App shows: "5th inning = 7 pitches (72 - 65 from innings 1-4)"
```

**Pros:**
- Matches what's displayed on TV/scoreboard
- Less mental math for user
- Can verify against game feed

**Cons:**
- User must remember to look at pitch count

### 3.2 Per-Inning Entry (Alternative)

User enters pitches for just the completed inning.

```
Pitches this inning: [15]

App shows: "Total: 72 pitches (57 + 15)"
```

**Pros:**
- Smaller numbers, easier to recall
- Can estimate if not watching closely

**Cons:**
- Requires more frequent entry
- Harder to verify against broadcast

### 3.3 Hybrid Approach (Default)

- Show cumulative pitch count from last known point
- User confirms or corrects
- App calculates difference

```javascript
function promptPitchCount(pitcher, currentInning) {
  const lastKnownCount = pitcher.pitchCount;
  const lastKnownInning = pitcher.lastPitchCountInning;

  return {
    prompt: `Pitch count for ${pitcher.name}`,
    subtext: `Last recorded: ${lastKnownCount} after inning ${lastKnownInning}`,
    inputType: 'cumulative',
    defaultValue: lastKnownCount,  // Pre-fill with last known
    minValue: lastKnownCount,      // Can't go down
    maxValue: lastKnownCount + 50  // Sanity check
  };
}
```

---

## 4. Per-Inning vs Cumulative

### 4.1 Data Storage

Always store **both** cumulative and per-inning:

```javascript
interface PitcherPitchCount {
  pitcherId: string;
  gameId: string;

  // Cumulative (primary)
  totalPitches: number;

  // Per-inning breakdown
  pitchesByInning: {
    1: number;
    2: number;
    // ... etc
  };

  // Tracking
  lastUpdatedInning: number;
  lastUpdatedOuts: number;
}
```

### 4.2 Calculating Per-Inning from Cumulative

```javascript
function calculateInningPitches(pitcher, inning, newCumulativeCount) {
  // Sum of all previous innings
  let previousTotal = 0;
  for (let i = 1; i < inning; i++) {
    previousTotal += pitcher.pitchesByInning[i] || 0;
  }

  // This inning = cumulative - previous
  const thisInningPitches = newCumulativeCount - previousTotal;

  // Validation
  if (thisInningPitches < 0) {
    throw new Error('Cumulative count cannot be less than previous innings');
  }
  if (thisInningPitches > 50) {
    // Warn user - unusually high for one inning
    warnUser('High pitch count for single inning. Please verify.');
  }

  return thisInningPitches;
}
```

---

## 5. UI Flow

### 5.1 Pitching Change Flow (Mandatory)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ö†Ô∏è PITCHING CHANGE - PITCH COUNT REQUIRED                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Outgoing Pitcher: Mike Simmons                                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Last recorded: 65 pitches (after 4th inning)                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Pitch count by inning:                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ  ‚îÇ 1st ‚îÇ 2nd ‚îÇ 3rd ‚îÇ 4th ‚îÇ 5th ‚îÇ                                ‚îÇ
‚îÇ  ‚îÇ 14  ‚îÇ 18  ‚îÇ 12  ‚îÇ 21  ‚îÇ ?? ‚îÇ                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Enter CURRENT pitch count: [____]                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üí° Check the broadcast or scoreboard for current count         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è Cannot proceed without pitch count.                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                    [Confirm & Continue]                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.2 End-of-Inning Flow (Optional)

If `promptPerInning` is enabled:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  END OF INNING - UPDATE PITCH COUNTS?                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Cole (NYY): [72] pitches (was 65)                              ‚îÇ
‚îÇ  Simmons (SF): [68] pitches (was 54)                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [Skip]                    [Update]                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.3 End-of-Game Flow (Mandatory)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FINAL PITCH COUNTS                                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  YANKEES PITCHERS:                                              ‚îÇ
‚îÇ  Cole:     [98] pitches (6.0 IP)                                ‚îÇ
‚îÇ  Powers:   [28] pitches (2.0 IP)                                ‚îÇ
‚îÇ  Chapman:  [15] pitches (1.0 IP)                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  GIANTS PITCHERS:                                               ‚îÇ
‚îÇ  Simmons:  [72] pitches (4.2 IP)                                ‚îÇ
‚îÇ  Webb:     [45] pitches (3.1 IP)                                ‚îÇ
‚îÇ  Doval:    [12] pitches (1.0 IP)                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üí° Enter final pitch counts from box score                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                    [Confirm & Finish Game]                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.4 High Pitch Count Alert

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ö†Ô∏è HIGH PITCH COUNT ALERT                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Cole has thrown approximately 100+ pitches                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Current estimate: ~102 pitches                                 ‚îÇ
‚îÇ  (Based on average pitches per batter faced)                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Is this accurate?                                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [It's Close]              [Update Count: ____]          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 6. Data Schema

### 6.1 Pitch Count Record

```typescript
interface PitchCountRecord {
  // Identity
  pitcherId: string;
  gameId: string;
  appearanceNumber: number;  // 1 for starter, 2+ for relievers

  // Cumulative
  totalPitches: number;

  // Per-inning (sparse - only innings pitched)
  pitchesByInning: Record<number, number>;

  // Batters faced (for estimation)
  battersFaced: number;

  // Tracking metadata
  entryMethod: 'cumulative' | 'per_inning' | 'estimated';
  lastVerifiedInning: number;
  estimateConfidence: 'high' | 'medium' | 'low';
}
```

### 6.2 Estimation System

When pitch count isn't entered, estimate based on batters faced:

```javascript
const PITCHES_PER_BATTER_ESTIMATE = {
  // By pitcher type
  starter: 3.9,      // Starters average ~3.9 pitches per batter
  reliever: 4.1,     // Relievers slightly higher (more strikeouts)

  // By event type (for better estimates)
  strikeout: 5.5,
  walk: 5.8,
  hit: 3.2,
  out_in_play: 3.0,
  home_run: 2.8
};

function estimatePitchCount(pitcher, events) {
  let estimate = 0;

  for (const event of events) {
    estimate += PITCHES_PER_BATTER_ESTIMATE[event.type] ||
                PITCHES_PER_BATTER_ESTIMATE[pitcher.role];
  }

  return Math.round(estimate);
}
```

---

## 7. Validation Rules

### 7.1 Sanity Checks

```javascript
const PITCH_COUNT_VALIDATION = {
  // Per-inning limits
  minPitchesPerInning: 3,      // At least 3 batters faced = 3 pitches minimum
  maxPitchesPerInning: 50,     // Extremely long inning cap
  warningPitchesPerInning: 30, // Warn if over 30 in one inning

  // Game limits
  maxPitchesPerGame: 150,      // Extremely rare to exceed
  warningPitchesPerGame: 120,  // Typical starter max

  // Per-batter limits
  minPitchesPerBatter: 1,      // First pitch out
  maxPitchesPerBatter: 20,     // Foul ball marathon
  averagePitchesPerBatter: 3.9
};

function validatePitchCount(newCount, pitcher, context) {
  const errors = [];
  const warnings = [];

  // Can't decrease
  if (newCount < pitcher.pitchCount) {
    errors.push('Pitch count cannot decrease');
  }

  // Per-inning check
  const inningPitches = newCount - pitcher.previousInningTotal;
  if (inningPitches > PITCH_COUNT_VALIDATION.maxPitchesPerInning) {
    errors.push(`${inningPitches} pitches in one inning seems too high`);
  } else if (inningPitches > PITCH_COUNT_VALIDATION.warningPitchesPerInning) {
    warnings.push(`${inningPitches} pitches is unusually high for one inning`);
  }

  // Game total check
  if (newCount > PITCH_COUNT_VALIDATION.maxPitchesPerGame) {
    errors.push(`${newCount} pitches exceeds reasonable game maximum`);
  } else if (newCount > PITCH_COUNT_VALIDATION.warningPitchesPerGame) {
    warnings.push(`${newCount} pitches is very high - please verify`);
  }

  return { isValid: errors.length === 0, errors, warnings };
}
```

### 7.2 Auto-Correction Suggestions

```javascript
function suggestCorrection(enteredCount, pitcher, context) {
  const estimated = estimatePitchCount(pitcher, context.events);
  const difference = Math.abs(enteredCount - estimated);

  if (difference > 20) {
    return {
      suggestion: `Did you mean ${estimated}? Your entry differs significantly from the estimate.`,
      confidence: 'low'
    };
  }

  return null;
}
```

---

## 8. Integration Points

### 8.1 pWAR Calculation

Pitch count is informational for pWAR, not directly used in calculation:

```javascript
// From PWAR_CALCULATION_SPEC.md
// Pitch count helps identify workload but doesn't affect FIP-based pWAR
```

### 8.2 Narrative Generation

```javascript
function generatePitchingNarrative(pitcher) {
  const { totalPitches, inningsPitched, strikeouts } = pitcher;

  if (totalPitches > 100) {
    return `${pitcher.name} labored through ${totalPitches} pitches over ${inningsPitched} innings.`;
  } else if (totalPitches / inningsPitched < 12) {
    return `${pitcher.name} was efficient, needing just ${totalPitches} pitches over ${inningsPitched} innings.`;
  }

  return `${pitcher.name}: ${inningsPitched} IP, ${strikeouts} K, ${totalPitches} pitches.`;
}
```

### 8.3 Manager Decision Context

```javascript
// High pitch count should influence manager evaluation
function shouldConsiderPitchingChange(pitcher, gameState) {
  const factors = {
    pitchCount: pitcher.pitchCount > 100,
    innings: pitcher.inningsPitched >= 6,
    fatigueIndicator: pitcher.lastInningPitches > 25,
    runsAllowed: pitcher.runsThisInning > 0
  };

  return Object.values(factors).filter(Boolean).length >= 2;
}
```

### 8.4 Season Totals

```javascript
interface SeasonPitchingStats {
  // ... other stats

  // Pitch count aggregates
  totalPitches: number;
  pitchesPerStart: number;      // For starters
  pitchesPerAppearance: number; // For relievers
  averagePitchesPerInning: number;

  // Efficiency
  pitchesPerBatterFaced: number;
}
```

---

## Appendix: Quick Reference

### Entry Timing Cheat Sheet

| Moment | Required? | Method |
|--------|-----------|--------|
| Game start | No | Starts at 0 |
| After each inning | Optional | Cumulative |
| Pitching change | **YES** | Cumulative |
| End of game | **YES** | Cumulative |
| High count alert | Prompted | Confirm/correct |

### Typical Pitch Counts

| Pitcher Type | Low | Average | High |
|--------------|-----|---------|------|
| Starter (complete game) | 90 | 105 | 130 |
| Starter (6 IP) | 80 | 95 | 115 |
| Reliever (1 IP) | 10 | 15 | 25 |
| Closer (1 IP) | 12 | 17 | 25 |

---

*Last Updated: January 22, 2026*
*Version: 1.0 - Initial pitch count tracking specification*
~~~

### Source File: specs/INHERITED_RUNNERS_SPEC.md

~~~markdown
# Inherited Runners Tracking Specification

> **Purpose**: Define how inherited runners are tracked for ER/UER attribution and reliever evaluation
> **Integration**: PWAR_CALCULATION_SPEC.md, MWAR_CALCULATION_SPEC.md, CLUTCH_ATTRIBUTION_SPEC.md
> **Related Specs**: KBL_XHD_TRACKER_MASTER_SPEC_v3.md ¬ß4 (In-Game Tracking)
> **SMB4 Reference**: SMB4_GAME_MECHANICS.md

---

## Table of Contents

1. [Overview](#1-overview)
2. [Core Concepts](#2-core-concepts)
3. [Runner Ownership Rules](#3-runner-ownership-rules)
4. [Pitching Change Flow](#4-pitching-change-flow)
5. [Run Attribution (ER vs UER)](#5-run-attribution-er-vs-uer)
6. [Data Schema](#6-data-schema)
7. [Clutch Integration](#7-clutch-integration)
8. [Manager Evaluation](#8-manager-evaluation)
9. [Edge Cases](#9-edge-cases)
10. [UI Display](#10-ui-display)

---

## 1. Overview

### The Problem

When a reliever enters with runners on base:
- If those runners score, it's **NOT the reliever's earned run**
- The **previous pitcher** is charged with those runs
- But the **reliever** still gets evaluated on whether they allowed them to score

This creates complexity:
- Pitcher A's ERA is affected by runs scored after they leave
- Pitcher B's ERA is NOT affected, but their performance IS judged
- Manager decisions are evaluated by the outcome

### What We Track

| Data Point | Where It's Used |
|------------|-----------------|
| Runners inherited | Reliever evaluation |
| Inherited runners scored | Previous pitcher's ER |
| Inherited runners stranded | Reliever clutch credit |
| Manager decision context | mWAR calculation |

---

## 2. Core Concepts

### 2.1 Runner Ownership

Every runner on base has an **owner** - the pitcher who put them there.

```javascript
interface BaseRunner {
  playerId: string;
  playerName: string;
  base: '1B' | '2B' | '3B';
  reachedOn: 'hit' | 'walk' | 'hbp' | 'error' | 'fc' | 'interference';

  // Ownership tracking
  pitcherResponsible: string;  // ID of pitcher who allowed baserunner
  pitcherResponsibleName: string;

  // For inherited runner tracking
  wasInherited: boolean;       // True if runner was on when current pitcher entered
  inheritedFrom: string | null; // Previous pitcher ID (null if current pitcher's runner)
}
```

### 2.2 Key Definitions

| Term | Definition |
|------|------------|
| **Inherited Runner** | A runner on base when a reliever enters |
| **Bequeathed Runner** | A runner left on base when a pitcher exits |
| **IR Scored (IRS)** | Inherited runners who score |
| **IR Stranded** | Inherited runners who don't score (out or LOB) |
| **ER** | Earned Run - charged to the pitcher who allowed the runner |
| **UER** | Unearned Run - run that scored due to error (no pitcher charged) |

---

## 3. Runner Ownership Rules

### 3.1 Basic Rule

**A pitcher "owns" a runner if they allowed that runner to reach base.**

The runner remains owned by that pitcher even after:
- The pitcher is replaced
- The runner advances
- Innings change (rare - runner must have advanced on wild pitch/PB/SB)

### 3.2 Ownership Transfer Rules

Ownership NEVER transfers. The original pitcher always owns the runner.

```javascript
/**
 * Get the pitcher responsible for a run scoring
 */
function getPitcherResponsibleForRun(runner) {
  // Always the pitcher who allowed them to reach
  return runner.pitcherResponsible;
}
```

### 3.3 When Runner Ownership is Assigned

| Event | Pitcher Responsible |
|-------|---------------------|
| Single, Double, Triple | Current pitcher |
| Home Run | Current pitcher |
| Walk (BB) | Current pitcher |
| HBP | Current pitcher |
| Error (reaches base) | Current pitcher (but run is unearned) |
| Fielder's Choice (reaches) | Current pitcher |
| Dropped 3rd Strike | Current pitcher |

> **Note**: Catcher Interference is NOT possible in SMB4. See `SMB4_GAME_MECHANICS.md`.

---

## 4. Pitching Change Flow

### 4.1 Pre-Change: Capture Outgoing Pitcher State

Before confirming a pitching change, the system must capture:

```javascript
interface OutgoingPitcherState {
  pitcherId: string;
  pitcherName: string;

  // Final stats at exit
  inningsPitched: number;      // Partial innings OK (e.g., 4.2)
  hits: number;
  runs: number;
  earnedRuns: number;
  strikeouts: number;
  walks: number;
  pitchCount: number;

  // Runners being bequeathed
  bequeathedRunners: BaseRunner[];

  // For context
  outsWhenExited: number;      // 0, 1, or 2
  inningWhenExited: number;
}
```

### 4.2 On Pitching Change

```javascript
function handlePitchingChange(outgoingPitcher, incomingPitcher, gameState) {
  // 1. Capture all runners currently on base
  const runnersOnBase = [
    gameState.runners.first,
    gameState.runners.second,
    gameState.runners.third
  ].filter(r => r !== null);

  // 2. Mark these as inherited for the new pitcher
  const inheritedRunners = runnersOnBase.map(runner => ({
    ...runner,
    wasInherited: true,
    inheritedFrom: outgoingPitcher.id
  }));

  // 3. Update outgoing pitcher's record
  outgoingPitcher.bequeathedRunners = runnersOnBase.length;
  outgoingPitcher.bequeathedRunnersScored = 0;  // Will be updated if they score

  // 4. Initialize incoming pitcher's appearance
  const reliefAppearance = {
    pitcherId: incomingPitcher.id,
    entryInning: gameState.inning,
    entryOuts: gameState.outs,
    inheritedRunners: inheritedRunners.length,
    inheritedRunnersScored: 0,
    inheritedRunnersStranded: 0,

    // Track which bases had inherited runners
    inheritedOnFirst: inheritedRunners.some(r => r.base === '1B'),
    inheritedOnSecond: inheritedRunners.some(r => r.base === '2B'),
    inheritedOnThird: inheritedRunners.some(r => r.base === '3B')
  };

  // 5. Log manager decision for mWAR
  logManagerDecision({
    type: 'PITCHING_CHANGE',
    managerId: gameState.getCurrentManager(),
    context: {
      inning: gameState.inning,
      outs: gameState.outs,
      score: gameState.score,
      inheritedRunners: inheritedRunners.length,
      leverageIndex: calculateLeverageIndex(gameState)
    }
  });

  return reliefAppearance;
}
```

### 4.3 UI Flow for Pitching Change

```
STEP 1: Mandatory Pitch Count Entry
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ö†Ô∏è PITCHING CHANGE - UPDATE PITCH COUNT FIRST                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Outgoing Pitcher: Mike Simmons                                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Enter CUMULATIVE pitch count: [72]                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è This data cannot be recovered after the pitcher exits.      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ            [Confirm Pitch Count & Continue]                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

STEP 2: Inherited Runner Confirmation
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PITCHING CHANGE                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Outgoing: Mike Simmons                                         ‚îÇ
‚îÇ  Final line: 4.2 IP, 6 H, 3 R, 3 ER, 5 K, 2 BB, 72 pitches     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  INHERITED RUNNERS (Simmons' responsibility):                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  2B: Torres (singled in 5th)                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  1B: Rizzo (walked in 5th)                                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  If these runners score, Simmons is charged with the ER.        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  NEW PITCHER: [Jake Powers ‚ñº]                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                    [Confirm Change]                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 5. Run Attribution (ER vs UER)

### 5.1 When a Run Scores

```javascript
function handleRunScored(runner, gameState, howScored) {
  const responsiblePitcher = runner.pitcherResponsible;
  const currentPitcher = gameState.currentPitcher;

  // 1. Determine if earned or unearned
  const isEarned = determineIfEarnedRun(runner, howScored, gameState);

  // 2. Credit/charge the responsible pitcher
  if (isEarned) {
    responsiblePitcher.stats.earnedRuns += 1;
  }
  responsiblePitcher.stats.runs += 1;

  // 3. If inherited runner, update both pitchers' tracking
  if (runner.wasInherited) {
    // Previous pitcher (owner)
    responsiblePitcher.bequeathedRunnersScored += 1;

    // Current pitcher (inheritor)
    currentPitcher.inheritedRunnersScored += 1;
  }

  // 4. Update game score
  gameState.updateScore(runner.team, 1);

  return {
    runScored: true,
    earnedRun: isEarned,
    chargedTo: responsiblePitcher.id,
    wasInherited: runner.wasInherited
  };
}
```

### 5.2 Earned Run Determination

```javascript
function determineIfEarnedRun(runner, howScored, gameState) {
  // Unearned if runner reached on error
  if (runner.reachedOn === 'error') {
    return false;
  }

  // Unearned if runner advanced due to error
  if (howScored === 'error_advance') {
    return false;
  }

  // Unearned if runner scored on error
  if (howScored === 'error') {
    return false;
  }

  // Unearned if run only scored because inning was extended by error
  // (Complex - requires tracking "would have been 3rd out")
  if (gameState.inningExtendedByError && !gameState.wouldHaveScoredAnyway(runner)) {
    return false;
  }

  // Otherwise earned
  return true;
}
```

### 5.3 ER Attribution Table

| Scenario | Pitcher Charged | Earned? |
|----------|-----------------|---------|
| Runner scores on hit | Pitcher who allowed runner | Yes |
| Runner scores on sac fly | Pitcher who allowed runner | Yes |
| Runner scores on wild pitch | Current pitcher* | Yes |
| Runner scores on passed ball | Neither (catcher) | Yes |
| Runner scores on error | Pitcher who allowed runner | No |
| Inherited runner scores | **Previous** pitcher | Yes |
| Inherited runner scores on error | Previous pitcher | No |

*Wild pitch is charged to current pitcher because it's their fault, but inherited runner scoring means it goes to original owner for ER purposes.

### 5.4 Wild Pitch / Passed Ball Special Case

When an inherited runner advances or scores on WP/PB:

```javascript
function handleWildPitchAdvance(runner, gameState) {
  // The RUN is still charged to the original pitcher
  // But the WILD PITCH is charged to the current pitcher

  if (runner.wasInherited) {
    // Run goes to original pitcher
    const originalPitcher = getPitcherById(runner.pitcherResponsible);

    if (runner.scores) {
      originalPitcher.stats.runs += 1;
      originalPitcher.stats.earnedRuns += 1;  // WP is still earned
      originalPitcher.bequeathedRunnersScored += 1;

      gameState.currentPitcher.inheritedRunnersScored += 1;
    }

    // WP goes to current pitcher (for their WP stat)
    gameState.currentPitcher.stats.wildPitches += 1;
  }
}
```

---

## 6. Data Schema

### 6.1 Pitcher Appearance Record

```typescript
interface PitcherAppearance {
  // Identity
  pitcherId: string;
  gameId: string;

  // When
  entryInning: number;
  entryOuts: number;
  exitInning: number;
  exitOuts: number;

  // Standard stats
  inningsPitched: number;
  hits: number;
  runs: number;
  earnedRuns: number;
  strikeouts: number;
  walks: number;
  homeRuns: number;
  hitByPitch: number;
  wildPitches: number;
  pitchCount: number;
  battersFaced: number;

  // Inherited runner tracking
  inheritedRunners: number;
  inheritedRunnersScored: number;
  inheritedRunnersStranded: number;

  // Bequeathed runner tracking
  bequeathedRunners: number;
  bequeathedRunnersScored: number;

  // Context
  isStart: boolean;
  leverageIndexAtEntry: number;
  scoreDifferentialAtEntry: number;

  // Outcomes
  earnedWin: boolean;
  earnedLoss: boolean;
  earnedSave: boolean;
  earnedHold: boolean;
  blownSave: boolean;
}
```

### 6.2 Game-Level Runner State

```typescript
interface GameRunnerState {
  runners: {
    first: BaseRunner | null;
    second: BaseRunner | null;
    third: BaseRunner | null;
  };

  // Quick access helpers
  runnersOnBase: number;
  isRISP: boolean;
  isBasesLoaded: boolean;

  // Inherited runner quick check
  hasInheritedRunners: boolean;
  inheritedRunnerCount: number;
}
```

---

## 7. Clutch Integration

### 7.1 Inherited Runner Escape (Clutch Credit)

From CLUTCH_ATTRIBUTION_SPEC.md - relievers get clutch credit for stranding inherited runners:

```javascript
function evaluateInheritedRunnerEscape(reliefAppearance, gameState) {
  const { inheritedRunners, inheritedRunnersScored, inheritedRunnersStranded } = reliefAppearance;

  // No inherited runners = no clutch for escape
  if (inheritedRunners === 0) return 0;

  // Calculate escape rate
  const escapeRate = inheritedRunnersStranded / inheritedRunners;

  let clutchValue = 0;

  // Full escape (0 runs allowed)
  if (inheritedRunnersScored === 0) {
    if (inheritedRunners >= 3) {
      // Bases loaded escape = huge clutch
      clutchValue = 2.0;
    } else if (inheritedRunners === 2) {
      // 2 runners escaped
      clutchValue = 1.5;
    } else {
      // 1 runner escaped
      clutchValue = 1.0;
    }
  }
  // Partial escape
  else if (escapeRate > 0.5) {
    clutchValue = 0.5;
  }

  // Apply leverage index
  const li = reliefAppearance.leverageIndexAtEntry;
  return clutchValue * Math.sqrt(li);
}
```

### 7.2 Inherited Runner Allowed to Score (Choke)

```javascript
function evaluateInheritedRunnerScored(reliefAppearance) {
  const { inheritedRunners, inheritedRunnersScored } = reliefAppearance;

  if (inheritedRunnersScored === 0) return 0;

  // All inherited runners scored = significant choke
  if (inheritedRunnersScored === inheritedRunners) {
    return -1.0 * inheritedRunnersScored;
  }

  // Partial scoring
  return -0.5 * inheritedRunnersScored;
}
```

---

## 8. Manager Evaluation

### 8.1 Pitching Change Decision (mWAR)

From MWAR_CALCULATION_SPEC.md:

```javascript
function evaluatePitchingChangeDecision(decision, outcome) {
  const { inheritedRunners, leverageIndex } = decision.context;
  const { runsAllowed, outsRecorded, inheritedRunnersScored } = outcome;

  let mwarImpact = 0;

  // Success: New pitcher escapes jam and performs well
  if (inheritedRunnersScored === 0 && runsAllowed <= 1 && outsRecorded >= 3) {
    mwarImpact = 0.1 * Math.sqrt(leverageIndex);  // Good move
  }

  // Failure: Inherited runners score or disaster
  if (inheritedRunnersScored > 0 || (runsAllowed >= 2 && outsRecorded < 3)) {
    mwarImpact = -0.1 * Math.sqrt(leverageIndex);  // Bad move

    // Extra penalty if bases were loaded and all scored
    if (inheritedRunners >= 3 && inheritedRunnersScored >= 3) {
      mwarImpact -= 0.05;
    }
  }

  return mwarImpact;
}
```

### 8.2 Leave Pitcher In (Implicit Decision)

When a manager DOESN'T make a pitching change, that's also evaluated:

```javascript
function evaluateNoPitchingChange(pitcher, situation, outcome) {
  // Only evaluate if leaving them in was questionable
  // (e.g., high pitch count, fatigued, facing tough lineup spot)

  if (situation.shouldHaveConsidered PitchingChange) {
    if (outcome.escapedJam) {
      return 0.05;  // Minor credit for trusting pitcher
    } else if (outcome.gaveTUpRuns) {
      return -0.1;  // Should have pulled them
    }
  }

  return 0;  // No strong opinion
}
```

---

## 9. Edge Cases

### 9.1 Multiple Pitching Changes in One Inning

```javascript
// Pitcher A leaves with runners on 1B and 2B
// Pitcher B enters, walks a batter (bases loaded)
// Pitcher C enters

// Runner ownership:
// - 1B runner: Pitcher A (original)
// - 2B runner: Pitcher A (original)
// - 3B runner: Pitcher B (walked by them)

// For Pitcher C:
// - Inherited: 3 runners
// - Inherited from Pitcher B: 1 runner (the walk)
// - Inherited from Pitcher A: 2 runners (via Pitcher B)
```

### 9.2 Inning-Ending Plays

When inning ends before inherited runners score:

```javascript
function handleInningEnd(gameState) {
  const currentPitcher = gameState.currentPitcher;

  // Any runners left on base who were inherited = stranded
  const strandedInherited = gameState.runners
    .filter(r => r !== null && r.wasInherited);

  currentPitcher.inheritedRunnersStranded += strandedInherited.length;

  // These runners no longer exist (LOB)
  // Original pitchers don't get charged with runs
}
```

### 9.3 Inherited Runner Scores in Later Inning

Rare but possible (e.g., runner on 3B, inning ends, comes back to bat):

```javascript
// This doesn't happen in SMB4 as runners clear between innings
// But if it did: runner still owned by original pitcher
```

### 9.4 Pinch Runner for Inherited Runner

```javascript
function handlePinchRunner(originalRunner, pinchRunner, gameState) {
  // Pinch runner inherits the ownership
  pinchRunner.pitcherResponsible = originalRunner.pitcherResponsible;
  pinchRunner.wasInherited = originalRunner.wasInherited;
  pinchRunner.inheritedFrom = originalRunner.inheritedFrom;

  // If PR scores, original pitcher still charged
}
```

---

## 10. UI Display

### 10.1 Box Score Display

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  YANKEES PITCHING                                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Pitcher      IP    H   R  ER   K  BB  PC   IR  IRS             ‚îÇ
‚îÇ  Cole         4.2   6   3   3   5   2  72    -   -              ‚îÇ
‚îÇ  Powers       2.1   2   2   2*  3   1  28    2   1              ‚îÇ
‚îÇ  Chapman      2.0   0   0   0   4   0  25    1   0              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  * Powers allowed 1 inherited runner (Cole's) to score          ‚îÇ
‚îÇ    That run is charged to Cole's ERA, not Powers'               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

IR = Inherited Runners
IRS = Inherited Runners Scored
```

### 10.2 Live In-Game Display

When inherited runners are on base:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CURRENT PITCHER: Jake Powers (2.1 IP, 28 pitches)              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  INHERITED RUNNERS:                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ  ‚ö†Ô∏è Torres on 3B - Cole's runner (if scores: Cole's ER)    ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚úì Rizzo stranded (was on 2B, now out)                      ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Powers' line so far: 2.1 IP, 2 H, 1 R (own), 0 ER             ‚îÇ
‚îÇ  Cole's inherited runner that scored: 1                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 10.3 Post-Game Reliever Summary

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  JAKE POWERS - RELIEF APPEARANCE                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Entered: 5th inning, 2 outs, runners on 1st & 2nd             ‚îÇ
‚îÇ  Exited: 8th inning, 0 outs                                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Line: 2.1 IP, 2 H, 2 R, 1 ER, 3 K, 1 BB, 28 pitches           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  INHERITED RUNNERS: 2                                           ‚îÇ
‚îÇ  ‚Ä¢ Torres (2B) ‚Üí SCORED (charged to Cole)                       ‚îÇ
‚îÇ  ‚Ä¢ Rizzo (1B) ‚Üí Grounded out                                    ‚îÇ
‚îÇ  IR Escape Rate: 50%                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  CLUTCH IMPACT:                                                 ‚îÇ
‚îÇ  ‚Ä¢ -0.5 (allowed inherited runner to score)                     ‚îÇ
‚îÇ  ‚Ä¢ +0.3 (2+ scoreless innings after escape)                     ‚îÇ
‚îÇ  ‚Ä¢ Net: -0.2                                                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Appendix: Quick Reference

### ER Attribution Cheat Sheet

| Who put runner on base? | Who let runner score? | Who gets ER? |
|-------------------------|----------------------|--------------|
| Pitcher A | Pitcher A | Pitcher A |
| Pitcher A | Pitcher B | Pitcher A |
| Pitcher B | Pitcher B | Pitcher B |
| Error | Anyone | Nobody (UER) |

### Stat Tracking Checklist

For every pitching appearance, track:
- [ ] Inherited runners count
- [ ] Inherited runners scored
- [ ] Inherited runners stranded
- [ ] Bequeathed runners count
- [ ] Leverage index at entry
- [ ] Score differential at entry

---

*Last Updated: January 22, 2026*
*Version: 1.0 - Initial inherited runners specification*
~~~

### Source File: specs/FIELDING_SYSTEM_SPEC.md

~~~markdown
# Fielding System Specification

> **Purpose**: Complete specification for fielding tracking, inferential logic, and integration with fWAR/Fame systems
> **Created**: January 21, 2025
> **Last Updated**: January 21, 2026
> **Status**: IMPLEMENTED - Core fielding flow complete, data persistence pending
>
> **Related Specs**:
> - `FWAR_CALCULATION_SPEC.md` - Detailed per-play run values, positional adjustments, complete fWAR formula
> - `KBL_XHD_TRACKER_MASTER_SPEC_v3.md` Section 10 - EOS salary percentile integration

---

## Table of Contents

1. [Overview](#1-overview)
2. [User Input Flow](#2-user-input-flow)
3. [Spray Chart & Direction System](#3-spray-chart--direction-system)
4. [Fielder Inference Logic](#4-fielder-inference-logic)
5. [Catcher & Pitcher Fielding](#5-catcher--pitcher-fielding)
6. [Strikeout Putouts & Dropped Third Strike](#6-strikeout-putouts--dropped-third-strike)
7. [Foul Ball Handling](#7-foul-ball-handling)
8. [Hit Tracking (1B, 2B, 3B)](#8-hit-tracking-1b-2b-3b)
9. [Sacrifice Flies](#9-sacrifice-flies)
10. [Fielder's Choice](#10-fielders-choice)
11. [Assist Chain Tracking](#11-assist-chain-tracking)
12. [Star Plays & Exceptional Fielding](#12-star-plays--exceptional-fielding)
13. [SMB4-Specific Events](#13-smb4-specific-events)
14. [Infield Fly Rule](#14-infield-fly-rule)
15. [Ground Rule Double](#15-ground-rule-double)
16. [Shift Handling](#16-shift-handling)
17. [Adaptive Learning System](#17-adaptive-learning-system)
18. [Contextual UI Principles](#18-contextual-ui-principles)
19. [Data Schema](#19-data-schema)
20. [Integration Points](#20-integration-points)
21. [Appendix: MLB Research Summary](#appendix-mlb-research-summary)

---

## 1. Overview

### Purpose

Track complete fielding data for every play to support:
- **fWAR calculations** - Fielding value above replacement
- **Fame triggers** - Diving catches, robbed HRs, errors, outfield assists
- **Gold Glove tracking** - Position-specific fielding stats
- **Spray charts** - Visual representation of batted ball locations
- **Games at position** - For position detection and UTIL eligibility
- **Clutch tracking** - Pitcher comebackers, inning-ending plays

### Design Philosophy

1. **Minimize manual entry** - Infer the most likely fielder; user confirms or overrides
2. **Learn over time** - Track expected vs. actual to improve inference accuracy
3. **Capture exceptional plays** - Star plays and errors are narratively important
4. **Support assist chains** - Double plays and relay throws need full credit
5. **Track everything** - Putouts on strikeouts, fielding on base hits, all of it

---

## 1.1 Fielding Chance Logic (CRITICAL)

> **IMPORTANT**: This section defines when a fielder is credited with a fielding chance.
> A fielding chance affects fielding percentage calculations. Getting this wrong corrupts stats.

### Core Principle

**A fielding chance is recorded ONLY when a fielder attempts to make a play on the ball.**

### Decision Matrix

| Result | Fielding Attempt? | Fielding Chance? | UI Flow |
|--------|-------------------|------------------|---------|
| **Outs (GO, FO, LO, PO)** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **Double Play (DP)** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **Sac Fly (SF)** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **Fielder's Choice (FC)** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **Error (E)** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **D3K** | Always yes | ‚úÖ Yes | Fielding confirmation required |
| **Strikeout (K, KL)** | No batted ball | ‚ùå No | No fielding confirmation |
| **Walk (BB, IBB, HBP)** | No batted ball | ‚ùå No | No fielding confirmation |
| **Clean Hit (1B, 2B, 3B)** | No | ‚ùå No | Direct submit (default) |
| **Hit with Diving attempt** | User indicates | ‚úÖ Yes | Fielding confirmation required |
| **Hit with Leaping attempt** | User indicates | ‚úÖ Yes | Fielding confirmation required |
| **Clean HR** | No | ‚ùå No | Direct submit (default) |
| **HR with Robbery Attempt** | User indicates | ‚úÖ Yes | Fielding confirmation required |

### Hits: The "Fielding Attempt?" Question

For hits (1B, 2B, 3B, HR), the UI shows a "FIELDING ATTEMPT?" section:

| Option | Meaning | Fielding Chance |
|--------|---------|-----------------|
| **Clean** (default) | Ball got through without a play attempt | ‚ùå No |
| **Diving** | Fielder dove but ball got through | ‚úÖ Yes |
| **Leaping** | Fielder leaped but ball got through | ‚úÖ Yes |
| **Running** | Fielder ran hard but couldn't get there | ‚úÖ Yes |
| **Sliding** | Fielder slid but ball got through | ‚úÖ Yes |
| **Over-shoulder** | Fielder tried over-shoulder catch | ‚úÖ Yes |
| **Robbery Attempt** | Outfielder tried to rob HR | ‚úÖ Yes |

**Default behavior**: "Clean" is auto-selected. User must explicitly choose a non-Clean option to indicate a fielding attempt was made.

### Implementation Reference

```typescript
// In AtBatFlow.tsx
const isHitResult = ['1B', '2B', '3B', 'HR'].includes(result);
const hitWithFieldingAttempt = isHitResult && specialPlay !== null && specialPlay !== 'Clean';
const needsFieldingConfirmation =
  (isOutOrErrorResult && !['K', 'KL'].includes(result)) || hitWithFieldingAttempt;
```

### Why This Matters

- **Fielding %** = (Putouts + Assists) / (Putouts + Assists + Errors)
- If we credit a fielder with a "chance" on a clean hit, their fielding % incorrectly drops
- Example: CF has no chance on a clean double to the gap - shouldn't affect his stats
- Example: CF dives and misses ‚Üí that IS a fielding chance (even though it's a hit, not an error)

---

## 2. User Input Flow

### Current Inputs (Already Tracked)

| Input | Values | Notes |
|-------|--------|-------|
| At-bat result | GO, FO, LO, PO, 1B, 2B, 3B, HR, K, BB, etc. | Implies batted ball type |
| Direction | L, LC, C, RC, R | 5-zone spray direction (to be enhanced) |

### Batted Ball Type Mapping

| Result Code | Batted Ball Type | Fielder Pool |
|-------------|------------------|--------------|
| GO (Ground Out) | Ground Ball | Infielders (P, C, 1B, 2B, SS, 3B) |
| FO (Fly Out) | Fly Ball | Outfielders (LF, CF, RF), sometimes IF |
| LO (Line Out) | Line Drive | Any position |
| PO (Pop Out) | Pop Fly | Infielders primarily, OF has priority |
| DP (Double Play) | Ground Ball | Infielders (initiator varies) |
| SF (Sacrifice Fly) | Fly Ball | Outfielders |
| FC (Fielder's Choice) | Ground Ball | Infielders |
| 1B, 2B, 3B | Varies | Fielder who played the ball |
| HR | Fly Ball | No fielder (unless robbed or failed robbery) |
| E (Error) | Varies | Fielder who committed error |
| K (Strikeout) | N/A | Catcher gets putout |
| D3K (Dropped 3rd Strike) | N/A | Catcher assist, 1B putout (typically) |

### New Inputs Required

After user selects result + direction, the system:

1. **Infers primary fielder** (displayed as default)
2. **User confirms or changes fielder**
3. **If applicable**: User selects star play type or error type
4. **If applicable**: User confirms assist chain (for DP, relay throws)
5. **If applicable**: User notes SMB4-specific events (nutshot, comebacker injury)

---

## 3. Spray Chart & Direction System

### Current System (Testing Phase)

5 discrete zones: L, LC, C, RC, R

### Future System (UI/UX Phase)

Interactive spray chart allowing tap/click on visual baseball field:
- **Infield zones**: Finer granularity for ground balls
- **Outfield zones**: Depth + angle for fly balls
- **Foul territory**: Left foul, right foul areas

### Direction Categories (Enhanced)

| Code | Description | Fair/Foul | Typical Fielders |
|------|-------------|-----------|------------------|
| FL | Foul Left | Foul | 3B, LF, C |
| L | Left Field Line | Fair | 3B, LF |
| LC | Left-Center Gap | Fair | SS, LF, CF |
| C | Center | Fair | P, 2B, SS, CF |
| RC | Right-Center Gap | Fair | 2B, RF, CF |
| R | Right Field Line | Fair | 1B, RF |
| FR | Foul Right | Foul | 1B, RF, C |

### Depth Indicator (For Pop Flies & Fly Balls)

| Depth | Description | Primary Fielders |
|-------|-------------|------------------|
| Shallow | Near home plate / pitcher's mound | C, P |
| Infield | Standard infield depth | 1B, 2B, SS, 3B |
| Outfield Grass | Shallow outfield | OF or deep-playing IF |
| Deep | Warning track / wall | OF |

**Implementation**: Spray chart tap location determines both direction AND depth automatically.

---

## 4. Fielder Inference Logic

### Primary Inference Matrix

Based on batted ball type + direction, return the most likely fielder.

#### Ground Balls (GO, DP, FC)

| Direction | Primary | Secondary | Tertiary |
|-----------|---------|-----------|----------|
| FL (Foul Left) | C | 3B | P |
| L (Left) | 3B | SS | P |
| LC (Left-Center) | SS | 3B | 2B |
| C (Center) | P | SS | 2B |
| RC (Right-Center) | 2B | 1B | SS |
| R (Right) | 1B | 2B | P |
| FR (Foul Right) | C | 1B | P |

**Default probabilities (starting point):**
- Primary: 65%
- Secondary: 25%
- Tertiary: 10%

#### Fly Balls (FO, SF)

| Direction | Primary | Secondary | Tertiary |
|-----------|---------|-----------|----------|
| FL (Foul Left) | LF | 3B | C |
| L (Left) | LF | CF | 3B |
| LC (Left-Center) | CF | LF | SS |
| C (Center) | CF | - | - |
| RC (Right-Center) | CF | RF | 2B |
| R (Right) | RF | CF | 1B |
| FR (Foul Right) | RF | 1B | C |

**Note**: CF has priority on all catchable fair fly balls per MLB convention.

#### Line Drives (LO)

| Direction | Primary | Secondary | Notes |
|-----------|---------|-----------|-------|
| L (Left) | 3B | LF | Hot corner takes heat |
| LC (Left-Center) | SS | LF/CF | Hard to field |
| C (Center) | P | 2B/CF | Comebackers common |
| RC (Right-Center) | 2B | RF/CF | - |
| R (Right) | 1B | RF | - |

#### Pop Flies (PO)

| Direction + Depth | Primary | Secondary | Notes |
|-------------------|---------|-----------|-------|
| Any + Shallow | C | P | Near home plate |
| L + Infield | 3B | SS | - |
| LC + Infield | SS | 3B | SS has priority |
| C + Infield | SS | 2B | Middle infield |
| RC + Infield | 2B | 1B | - |
| R + Infield | 1B | 2B | - |
| Any + OF Grass | CF/LF/RF | SS/2B | OF calls off IF |

**Priority order for pop flies** (per MLB convention):
1. Center Fielder (calls off everyone)
2. Corner Outfielders (call off infielders)
3. Shortstop (highest infield priority)
4. Second Baseman
5. First Baseman / Third Baseman
6. Pitcher / Catcher (lowest)

---

## 5. Catcher & Pitcher Fielding

### Catcher Fielding Scenarios

| Scenario | Catcher Role | Putout/Assist |
|----------|--------------|---------------|
| Strikeout (normal) | Catches pitch | **Putout** |
| Dropped 3rd strike | Throws to 1B | **Assist** |
| Pop fly near home | Catches fly | **Putout** |
| Bunt near home | Fields, throws | **Assist** (or PO if tags) |
| Play at plate | Receives throw, tags | **Putout** |
| Passed ball (runner advances) | N/A | No fielding credit |
| Pickoff throw | Throws to base | **Assist** if out |

### Pitcher Fielding Scenarios

| Scenario | Pitcher Role | Putout/Assist | Fame/Clutch Impact |
|----------|--------------|---------------|-------------------|
| Comebacker (out) | Catches, throws to 1B | **Assist** | +1 Clutch if ends inning |
| Comebacker (caught for out) | Catches line drive | **Putout** | +1 Clutch if ends inning |
| Bunt fielded | Fields, throws | **Assist** | - |
| Covering 1B | Receives throw | **Putout** | - |
| Starts DP | Fields, throws to 2B | **Assist** | +1 Clutch (DP always clutch) |
| Pop fly | Catches pop | **Putout** | - |

**Clutch Trigger**: Pitcher fielding a comebacker to end an inning = +1 Clutch
**Clutch Trigger**: Pitcher starting a double play = +1 Clutch

---

## 6. Strikeout Putouts & Dropped Third Strike

### Every Strikeout = Catcher Putout

This is often overlooked but critical for accurate fielding stats:

| Strikeout Type | Catcher | Notes |
|----------------|---------|-------|
| K (swinging) | Putout | Normal strikeout |
| K (looking) | Putout | Called strike three |
| Foul tip strike 3 | Putout | Same as regular K |

**Implementation**: When result = K or KL, automatically credit catcher with putout. No user input needed.

### Dropped Third Strike (D3K) - Complete Scenarios

The D3K is a complex play with multiple possible outcomes. The ball may be fielded by the **Catcher (default)**, **Pitcher** (comeback near mound), or **Third Baseman** (ball deflected toward foul territory).

| Scenario | Batter Outcome | Fielder Credit | 1B Credit | Batter Stats | Event Type |
|----------|----------------|----------------|-----------|--------------|------------|
| D3K ‚Üí thrown out at 1B | Out | Assist (C/P/3B) | Putout | K (strikeout) | Normal out |
| D3K ‚Üí safe on Wild Pitch | Reaches 1B | - | - | K + WP | Wild Pitch |
| D3K ‚Üí safe on Passed Ball | Reaches 1B | - | - | K + PB | Passed Ball |
| D3K ‚Üí safe on Throwing Error | Reaches 1B | Error (C/P/3B) | - | K + E | Throwing Error |
| D3K ‚Üí safe (1B error on catch) | Reaches 1B | Assist (C/P/3B) | Error | K + E | Fielding Error |

**Fielders Who Can Handle D3K:**
- **Catcher (C)** - Default, most common scenario
- **Pitcher (P)** - Ball deflects near mound, pitcher fields and throws to 1B
- **Third Baseman (3B)** - Ball deflects toward foul territory on third base side

**Key Points:**
- Batter ALWAYS gets credited with a strikeout, even when reaching safely
- When batter reaches safely, they are NOT credited with a stolen base
- The cause of reaching (WP, PB, or E) must be recorded
- WP is charged to pitcher, PB is charged to catcher (no error), E is an error

**UI Flow for D3K:**
1. User selects D3K as result
2. System asks: "Who fielded the ball?" ‚Üí **[Catcher] [Pitcher] [3B]** (default: Catcher)
3. System asks: "Batter thrown out at first?"
4. If YES: Record fielder assist, 1B putout, K for batter
5. If NO: System asks: "What allowed batter to reach?"
   - Wild Pitch (charged to pitcher)
   - Passed Ball (charged to catcher, not an error)
   - Throwing Error by fielder
   - Fielding Error by 1B

---

## 7. Foul Ball Handling

### Foul Territory Zones

| Zone | Code | Primary Fielders | Priority |
|------|------|------------------|----------|
| Foul Left (near line) | FL-LINE | LF, 3B | LF has priority |
| Foul Left (near plate) | FL-HOME | C, 3B | C has priority |
| Foul Right (near line) | FR-LINE | RF, 1B | RF has priority |
| Foul Right (near plate) | FR-HOME | C, 1B | C has priority |
| Behind home plate | FOUL-BACK | C | C only |

### Foul Ball Inference

| Result + Zone | Primary | Secondary |
|---------------|---------|-----------|
| FO + FL-LINE | LF | 3B |
| FO + FL-HOME | C | 3B |
| PO + FL (any) | 3B | C |
| FO + FR-LINE | RF | 1B |
| FO + FR-HOME | C | 1B |
| PO + FR (any) | 1B | C |
| FO + FOUL-BACK | C | - |

**Note**: Foul pop flies in infield still follow infield priority (3B/1B before C typically), but catcher has priority for foul flies behind home plate.

---

## 8. Hit Tracking (1B, 2B, 3B)

### Why Track Fielding on Hits?

Even when the batter reaches base safely, we want to know:
- **Which fielder played the ball** (for spray charts)
- **Was there a throw** (for assist tracking, even if unsuccessful)
- **Was there an error** (reached on error vs. clean hit)

### Hit Fielding Data

| Hit Type | Direction | Primary Fielder | Notes |
|----------|-----------|-----------------|-------|
| 1B (ground) | L | 3B or SS | Fielded but couldn't throw in time |
| 1B (ground) | LC | SS | Through the hole |
| 1B (line) | C | P (touched) or CF | Line drive single |
| 2B (gap) | LC | LF or CF | Who retrieved it? |
| 2B (line) | R | RF | Off the wall |
| 3B (gap) | RC | RF or CF | Deep gap triple |

### Implementation

For all hits (1B, 2B, 3B), ask:
1. **Direction** (from spray chart)
2. **Fielder who played ball** (inferred, user confirms)
3. **Optional**: Did fielder make a throw? To which base?

This data feeds spray charts and helps track fielder range over time.

---

## 9. Sacrifice Flies

### SF = Fly Ball + Out + Run Scores

| Component | Tracking |
|-----------|----------|
| Fielder | Who caught the fly ball (usually OF) |
| Putout | Catching fielder |
| Assist | If throw involved, all fielders in chain |
| Run | Runner scores (RBI credited to batter) |

### SF Fielding Flow

1. Result = SF
2. Direction selected
3. System infers: Likely OF based on direction
4. User confirms fielder
5. System asks: "Throw to plate?" (for assist tracking)
6. If yes: OF gets assist, C gets putout on the catch (if tag play) or just the fly out putout

**Note**: SF putout goes to the fielder who caught the fly, NOT the catcher (unless there's a tag play at home on a second runner).

---

## 10. Fielder's Choice

### FC = Fielder Chose to Get Different Runner

| Data Point | Description |
|------------|-------------|
| Fielder | Who fielded the ball |
| Runner Out | Which base/runner was retired |
| Batter | Reaches (typically 1B) |
| Assist Chain | Fielder ‚Üí base where out occurred |

### FC Tracking Flow

1. Result = FC
2. Direction selected
3. System infers fielder (same as GO logic)
4. User confirms fielder
5. System asks: "Out at which base?" (2B, 3B, Home)
6. System auto-determines assist chain based on base

### FC Assist Chains

| Out At | Typical Chain | Example |
|--------|---------------|---------|
| 2B | Fielder ‚Üí 2B/SS covering | 6-4 (SS to 2B) |
| 3B | Fielder ‚Üí 3B | 4-5 (2B to 3B) |
| Home | Fielder ‚Üí C | 5-2 (3B to C) |

---

## 11. Assist Chain Tracking

### When Assists Apply

| Situation | Assist Chain | Example |
|-----------|--------------|---------|
| Ground out (not unassisted) | 1+ assists | SS ‚Üí 1B = SS assist |
| Ground out to 1B (unassisted) | 0 assists | 1B fields, steps on base |
| Double play | 2 assists typical | SS ‚Üí 2B ‚Üí 1B |
| Outfield throw to base | 1-2 assists | RF ‚Üí SS ‚Üí 3B |
| Strikeout (dropped 3rd) | 1 assist | C ‚Üí 1B |
| Sacrifice fly with throw | 1 assist | LF ‚Üí C (tag at home) |
| Rundown | Multiple assists | Back-and-forth throws |

### Common Double Play Chains

| Code | Description | Positions |
|------|-------------|-----------|
| 6-4-3 | SS to 2B to 1B | SS (A), 2B (A), 1B (PO) |
| 4-6-3 | 2B to SS to 1B | 2B (A), SS (A), 1B (PO) |
| 5-4-3 | 3B to 2B to 1B | 3B (A), 2B (A), 1B (PO) |
| 1-6-3 | P to SS to 1B | P (A), SS (A), 1B (PO) |
| 6-3 | SS to 1B (no pivot) | SS (A), 1B (PO) |
| 4-3 | 2B to 1B (no pivot) | 2B (A), 1B (PO) |
| 3-6-3 | 1B to SS to 1B | 1B (A), SS (A), 1B (PO) |
| 5-3 | 3B to 1B | 3B (A), 1B (PO) |

### DP Inference by Direction

| Direction | Default DP Chain |
|-----------|------------------|
| L | 5-4-3 (3B starts) |
| LC | 6-4-3 (SS starts) - **most common** |
| C | 1-6-3 or 6-4-3 (comebacker or up middle) |
| RC | 4-6-3 (2B starts) |
| R | 3-6-3 (1B starts) |

### Relay Throw Logic (Outfield Assists)

For outfield assists:
1. Select outfielder who fielded
2. System asks: "Relay throw?"
3. If yes: Select relay man (SS for left side, 2B for right side typically)
4. Select base where runner was out
5. All fielders in chain receive assists

---

## 12. Star Plays & Exceptional Fielding

### Star Play Categories

> **Note**: fWAR values shown are for 48-game season. See FWAR_CALCULATION_SPEC.md for scaling by season length.

| Category | Description | Fame | fWAR (48g) | Clutch |
|----------|-------------|------|------------|--------|
| **Diving Catch** | Horizontal extension (2.5x multiplier) | +1 | +0.030 | - |
| **Leaping Catch** | Leaps to catch (2.0x multiplier) | +1 | +0.024 | - |
| **Wall Catch** | Catches at wall (2.5x multiplier) | +1 | +0.030 | - |
| **Running Catch** | Covered significant ground (1.5x) | - | +0.018 | - |
| **Sliding Catch** | Sliding catch in outfield (2.5x) | +1 | +0.030 | - |
| **Over-Shoulder Catch** | Over-the-shoulder catch (2.0x) | +1 | +0.024 | - |
| **Robbed HR** | Catch over wall, was HR (5.0x) | +2 | +0.078 | +1 |
| **Charging Play** | Charges slow roller | - | tracked | - |
| **Outfield Assist** | Throw results in out | +1 | +0.045 | +1 if key |
| **DP Turned** | Middle infielder pivot (+0.12 runs) | - | +0.041 | - |
| **Caught Comebacker** | Pitcher catches liner | - | +0.017 | +1 if ends inning |
| **Pitcher Starts DP** | 1-6-3 or 1-4-3 | - | +0.027 | +1 |

> **SMB4 Note**: Barehanded plays are not possible in SMB4 and are excluded from tracking.

### Error Categories

> **Note**: fWAR penalties shown are for 48-game season. See FWAR_CALCULATION_SPEC.md Section 8 for full context modifiers.

| Category | Description | Fame | fWAR (48g) | Notes |
|----------|-------------|------|------------|-------|
| **Fielding Error** | Bobble, drop, mishandle | -1 | -0.051 | Most common |
| **Throwing Error** | Wild throw | -1 | -0.068 | Charged to thrower |
| **Mental Error** | Wrong base, missed cutoff | -1 | -0.084 | **NEW**: Highest penalty |
| **Missed Catch (routine)** | Should have caught | -1 | -0.051 | Routine play blown |
| **Missed Dive** | Dove and missed | 0 | 0 | Good effort, no penalty |
| **Collision Error** | Two fielders collide | -1 each | -0.051 | Rare |
| **Failed HR Robbery** | Ball bounces off glove over wall | -1 | -0.078 | See SMB4-specific |

**Error Context Modifiers** (multiply base penalty):
- `allowedRun`: 1.5x penalty (error let a run score)
- `wasRoutine`: 1.2x penalty (should have been easy)
- `wasDifficult`: 0.7x penalty (tough play, reduced blame)

### Fame Trigger Summary (Fielding)

| Event | Fame Change |
|-------|-------------|
| Diving catch | +1 |
| Leaping catch | +1 |
| Wall catch | +1 |
| Sliding catch | +1 |
| Over-shoulder catch | +1 |
| Robbed HR | +2 |
| Outfield assist | +1 |
| Error allowing run | -1 |
| Multiple errors in game (2+) | -2 |
| Failed HR robbery (ball goes over) | -1 |

---

## 13. SMB4-Specific Events

### Comebacker Scenarios (Unique to SMB4)

| Event | Description | Impact |
|-------|-------------|--------|
| **Comebacker (normal)** | Pitcher fields, throws out batter | P gets assist, fWAR+ |
| **Comebacker (pitcher injured)** | Ball hits pitcher, knocks them out | Fitness hit (significant), may injure |
| **Comebacker (pitcher catches)** | Line drive caught | P gets putout, +Clutch if ends inning |

### Nutshot Event

**Description**: Ball hits pitcher in groin area. Unique SMB4 animation.

| Outcome | Description | Impact |
|---------|-------------|--------|
| **Nutshot + Out Made** | Another fielder (or pitcher) still makes play | Mojo hit to pitcher, fielding credit to whoever made play |
| **Nutshot + No Out** | Play not made | Mojo hit to pitcher, hit recorded |
| **Nutshot + Pitcher Makes Play** | Pitcher recovers, makes out | Mojo hit + fielding credit to P |

**Tracking**:
```javascript
{
  nutshotEvent: true,
  pitcherAffected: 'player-015',
  mojoImpact: -1,  // or whatever SMB4 uses
  fitnessImpact: 0,  // nutshot = mojo only, not fitness
  playStillMade: true,
  fielderWhoMadePlay: 'SS'  // could be P if pitcher recovered
}
```

### Failed Home Run Robbery

**Description**: Outfielder attempts to rob HR, ball bounces off glove and over fence.

| Scenario | Result | Impact |
|----------|--------|--------|
| Ball was catchable, player missed | HR (failed robbery) | -1 Fame to fielder |
| Ball was over fence regardless | HR | No Fame impact |

**User Flow**:
1. Result = HR
2. System asks: "Was there an attempted robbery?"
3. If yes: "Did ball bounce off fielder's glove?"
4. If yes: Record failed robbery, -1 Fame

**Tracking**:
```javascript
{
  atBatResult: 'HR',
  robberyAttempted: true,
  robberyFailed: true,
  fielderAttempting: 'CF',
  fameImpact: -1
}
```

### Pitcher Knocked Out of Game

When a comebacker injures the pitcher enough to remove them:

| Data Point | Value |
|------------|-------|
| Event Type | `pitcher_injured_comebacker` |
| Pitcher | Player ID |
| Fitness Impact | Significant (TBD based on SMB4 mechanics) |
| Pitching Line | Closed out (IP, K, BB, ER finalized) |
| Replacement | Triggers pitching change flow |

### Bad Hop

**Description**: Ball takes an unexpected bounce over a fielder, turning what should be a routine play into a hit or extra-base hit.

| Scenario | Result | Impact |
|----------|--------|--------|
| Routine GB hops over infielder | Hit (usually 1B) | No error charged, but tracked for analysis |
| Routine FB/GB hops over outfielder | Extra-base hit | No error charged, but tracked for analysis |
| Bad hop on throw | Could be hit or error | Depends on play |

**Why Track This:**
- Separates "unlucky" hits from legitimate hard-hit balls
- Important for 360-degree Moneyball-type analysis
- Helps identify field conditions or tendencies
- Does NOT affect fielder's error count (bad luck ‚â† error)

**UI Flow:**
- Toggle available on any hit: "Bad hop?"
- Only appears contextually when result is a hit
- Optional - user can skip if not relevant

**Tracking**:
```javascript
{
  badHopEvent: true,
  fielderAffected: 'SS',
  expectedResult: 'GO',  // What should have happened
  actualResult: '1B',     // What did happen
  notes: 'Ball hit rock on infield'  // Optional
}
```

**Future Analytics:**
- Track bad hop frequency by stadium (field quality)
- Track bad hop frequency by fielder position
- Exclude bad hop plays from defensive metrics (optional toggle)

---

## 14. Infield Fly Rule

### What Is It?

The Infield Fly Rule (IFR) is called when:
- Fair fly ball (NOT a line drive or bunt)
- Can be caught with ordinary effort by an infielder
- Runners on 1st & 2nd OR bases loaded
- Less than 2 outs

**Effect**: Batter is automatically OUT, regardless of whether the ball is caught.

### SMB4 Behavior

SMB4 enforces the Infield Fly Rule. When IFR is called:
- Batter is out even if ball is dropped
- Runners may advance at their own risk (not forced)

### Tracking Requirements

| Scenario | Batter | Fielder | Notes |
|----------|--------|---------|-------|
| IFR called, ball caught | Out (PO) | Putout | Normal fly out |
| IFR called, ball dropped | Out (IFR) | No putout | Batter still out, no fielding credit |
| IFR called, ball dropped, runner tagged | Out (IFR) + runner out | No putout + putout on tag | Two outs possible |

### UI Flow

**When to show IFR toggle:**
- Result is PO or FO
- Runners on 1st & 2nd, OR bases loaded
- Less than 2 outs

**Toggle**: "Infield Fly Rule called?"

If YES:
- Ask: "Was the ball caught?"
- If caught: Normal PO to fielder
- If dropped: Batter out (IFR), no putout credited to fielder

**Tracking**:
```javascript
{
  infieldFlyRule: true,
  ballCaught: false,  // true if caught, false if dropped
  fielderPosition: 'SS',
  // If dropped, runners may have advanced - track separately
}
```

---

## 15. Ground Rule Double

### What Is It?

A ground rule double occurs when a fair ball bounces over the outfield wall (or into the stands). The batter is awarded second base, and all runners advance two bases from their position at the time of the pitch.

### Difference from Regular Double

| Type | How It Happens | Runner Advancement |
|------|----------------|-------------------|
| Regular 2B | Ball stays in play, batter runs to 2B | Runners advance based on play |
| Ground Rule 2B | Ball bounces out of play | Runners automatically advance 2 bases |

### Why Track Separately?

- **Spray chart accuracy**: Ball location is where it bounced over, not where it landed
- **Fielder analysis**: Fielder may have been in position but ball bounced out
- **Park factors**: Some parks have more GRDs due to wall height/distance
- **Hit quality**: GRD may indicate a hard-hit ball that "got away"

### UI Flow

**When to show GRD toggle:**
- Result is 2B

**Toggle**: "Ground rule double?"

If YES:
- Track which fielder was chasing (for spray chart)
- Track direction/location where ball bounced over
- Mark as GRD in database (affects park factor calculations)

**Tracking**:
```javascript
{
  groundRuleDouble: true,
  fielderChasing: 'RF',
  direction: 'R',
  bounceLocation: 'deep',  // or however we track depth
  wallSection: 'RF_corner'  // for park factor analysis
}
```

---

## 18. Contextual UI Principles

### Show Options Only When Relevant

To avoid overwhelming the user with buttons, show conditional UI elements:

| Element | Show When |
|---------|-----------|
| "Infield Fly Rule?" | PO/FO + R1&R2 or bases loaded + < 2 outs |
| "Ground Rule Double?" | Result = 2B |
| "Bad Hop?" | Result is a hit (1B, 2B, 3B) |
| "Nutshot?" | Direction = Center + ball in play |
| "Pitcher Injured?" | Direction = Center + comebacker scenario |
| "Robbery Attempt?" | Result = HR |
| "Throw to plate?" | SF result |

### Default Behavior

- All toggles default to OFF (unchecked)
- User only engages with them when the event actually happened
- Minimizes clicks for the 90% of plays that are routine

---

## 16. Shift Handling

### Shift Types

| Shift Type | Configuration | When Used |
|------------|---------------|-----------|
| **Standard** | Traditional alignment | Default |
| **Pull Shift** | 3 infielders on pull side | vs. extreme pull hitters |
| **No Shift** | Explicitly standard | Override for specific AB |

### How Shift Affects Inference

When shift is active, adjust fielder probabilities:

**Pull Shift vs. LHH:**

| Direction | Standard Primary | Shifted Primary |
|-----------|------------------|-----------------|
| L | 3B | (Hole - less likely) |
| LC | SS | 3B |
| C | SS | SS |
| RC | 2B | SS |
| R | 1B | 2B |

### Shift Tracking

```javascript
gameState.shift = {
  active: false,
  type: 'standard',  // 'standard', 'pull', 'custom'
  againstBatter: null
};
```

### User Flow

1. Before at-bat: User can toggle "Shift" button
2. System remembers shift state until changed
3. Inference adjusts based on configuration
4. User can always override fielder

---

## 17. Adaptive Learning System

### Core Concept

Track every inference vs. actual outcome. Over time, adjust probabilities based on real data.

### Data Points Tracked

```javascript
{
  battedBallType: 'GB',
  direction: 'LC',
  depth: 'infield',
  inferredFielder: 'SS',
  actualFielder: 'SS',
  wasOverridden: false,
  shiftActive: false,
  timestamp: '2025-01-21T...',
  gameId: 'game-001',
  batterId: 'player-042',
  pitcherId: 'player-015',
  stadiumId: 'stadium-001'  // For park factors
}
```

### Learning Applications

| System | What We Learn |
|--------|---------------|
| **Fielder Inference** | Actual fielder distributions by type/direction |
| **Park Factors** | HR distances by stadium |
| **Player Tendencies** | Pull rates, batted ball types by batter |
| **Fielder Range** | Which fielders make plays outside expected zones |

### Algorithm

```javascript
function updateInferenceProbabilities() {
  const groups = groupHistoricalData();

  for (const group of groups) {
    const counts = countFielderOccurrences(group);
    const total = group.length;

    // Update if sufficient sample size (n >= 20)
    if (total >= 20) {
      for (const [fielder, count] of Object.entries(counts)) {
        const newProbability = count / total;
        // Blend: 70% historical, 30% default
        INFERENCE_MATRIX[group.key][fielder] =
          0.7 * newProbability + 0.3 * DEFAULT_MATRIX[group.key][fielder];
      }
    }
  }
}
```

### Future Features

- Confidence indicators: "SS (85% confident)" vs. "SS (estimated)"
- Anomaly detection: Flag unusual patterns
- Per-player tendencies: "CF Jones has +15% range to LC"

---

## 19. Data Schema

### FieldingPlay Record

```typescript
interface FieldingPlay {
  id: string;
  gameId: string;
  inning: number;
  halfInning: 'TOP' | 'BOTTOM';

  // At-bat context
  batterId: string;
  pitcherId: string;
  atBatResult: string;

  // Batted ball data
  battedBallType: 'GB' | 'FB' | 'LD' | 'PF' | 'NONE';
  direction: 'FL' | 'L' | 'LC' | 'C' | 'RC' | 'R' | 'FR' | null;
  depth: 'shallow' | 'infield' | 'outfield' | 'deep' | null;

  // Fielding data
  primaryFielder: string;
  primaryFielderId: string;

  // Play difficulty (affects fWAR multiplier - see FWAR_CALCULATION_SPEC.md Section 7)
  playType: 'routine' | 'diving' | 'leaping' | 'wall' | 'charging' |
            'running' | 'sliding' | 'over_shoulder' |
            'error' | 'robbed_hr' | 'failed_robbery';

  // Error classification (affects fWAR penalty - see FWAR_CALCULATION_SPEC.md Section 8)
  errorType?: 'fielding' | 'throwing' | 'mental' | 'missed_catch' | 'collision';

  // Error context modifiers (multiply base error penalty)
  errorContext?: {
    allowedRun: boolean;      // 1.5x penalty if true
    wasRoutine: boolean;      // 1.2x penalty if true
    wasDifficult: boolean;    // 0.7x penalty (reduced) if true
  };

  // Assist chain (with fWAR-relevant metadata)
  assists: Array<{
    position: string;
    playerId: string;
    assistType: 'infield' | 'outfield' | 'relay' | 'cutoff';
    targetBase?: '1B' | '2B' | '3B' | 'HOME';  // For outfield assists
  }>;
  putoutPosition: string;
  putoutPlayerId: string;

  // Double play role tracking (for fWAR credit assignment)
  dpRole?: 'started' | 'turned' | 'completed' | 'unassisted';  // See FWAR_CALCULATION_SPEC.md Section 5.3

  // Inference tracking
  inferredFielder: string;
  wasOverridden: boolean;

  // Context
  shiftActive: boolean;
  shiftType?: string;

  // SMB4-specific
  nutshotEvent: boolean;
  comebackerInjury: boolean;
  robberyAttempted: boolean;
  robberyFailed: boolean;

  // Edge case tracking
  infieldFlyRule: boolean;
  ifrBallCaught: boolean | null;  // Only relevant if infieldFlyRule = true
  groundRuleDouble: boolean;
  grdWallSection: string | null;  // 'LF_corner', 'CF', 'RF_line', etc.
  badHopEvent: boolean;
  badHopExpectedResult: string | null;  // 'GO', 'FO', etc. - what should have happened

  // D3K tracking
  d3kEvent: boolean;
  d3kOutcome: 'OUT' | 'WP' | 'PB' | 'E_CATCHER' | 'E_1B' | null;

  // Result
  outsRecorded: number;
  runnersOut: string[];

  timestamp: string;
}
```

### PlayerFieldingStats (Aggregated)

```typescript
interface PlayerFieldingStats {
  playerId: string;
  seasonId: string;

  byPosition: {
    [position: string]: {
      gamesPlayed: number;
      inningsPlayed: number;

      // Core stats
      putouts: number;
      assists: number;
      errors: number;
      fieldingPercentage: number;

      // Advanced
      doublePlaysParticipated: number;
      doublePlaysStarted: number;
      doublePlaysTurned: number;      // Pivot man credit
      doublePlaysCompleted: number;   // 1B completing DP
      totalChances: number;
      rangeFactor: number;

      // Star plays (difficulty-based)
      divingCatches: number;
      leapingCatches: number;         // Renamed from jumpingCatches
      wallCatches: number;
      runningCatches: number;         // NEW: Had to cover ground
      slidingCatches: number;         // NEW: Sliding catch
      overShoulderCatches: number;    // NEW: Over-the-shoulder catch
      robbedHRs: number;
      failedRobberies: number;
      outfieldAssists: number;
      outfieldAssistsToSecond: number;  // NEW: Target base breakdown
      outfieldAssistsToThird: number;   // NEW
      outfieldAssistsToHome: number;    // NEW

      // Error breakdown
      fieldingErrors: number;
      throwingErrors: number;
      mentalErrors: number;           // NEW: Wrong base, missed cutoff

      // Pitcher-specific
      comebackersCaught: number;
      comebackersFielded: number;

      // Catcher-specific (if C)
      strikeoutPutouts: number;
      passedBalls: number;
      catcherInterference: number;
    };
  };

  // Totals
  totalPutouts: number;
  totalAssists: number;
  totalErrors: number;
  overallFieldingPercentage: number;
}
```

---

## 20. Integration Points

### fWAR Calculation

> **See `FWAR_CALCULATION_SPEC.md` for complete per-play run values and formulas.**

Fielding data feeds into fWAR:
- Putouts by position (run value: +0.02 to +0.05 base)
- Assists by position (run value: +0.03 to +0.12 base)
- Errors (negative: -0.15 to -0.25 base)
- Star play multipliers (diving = 2.5x, robbed HR = 5.0x)
- Position modifiers (SS = 1.2x, 1B = 0.7x, etc.)
- Pitcher fielding (contributes to pWAR)

**Quick Reference**:
- 10 fielding runs = 1 fWAR
- Elite SS in 48 games: ~+0.5 fWAR
- Poor 1B in 48 games: ~-0.1 fWAR

### Fame System

| Event | Fame Change |
|-------|-------------|
| Diving catch | +1 |
| Leaping catch | +1 |
| Wall catch | +1 |
| Sliding catch | +1 |
| Over-shoulder catch | +1 |
| Robbed HR | +2 |
| Outfield assist | +1 |
| Error allowing run | -1 |
| Multiple errors (2+) | -2 |
| Failed HR robbery | -1 |

### Clutch System

| Event | Clutch Change |
|-------|---------------|
| Pitcher comebacker ends inning | +1 |
| Pitcher starts DP | +1 |
| Robbed HR | +1 |
| Key outfield assist | +1 |
| Error in clutch situation | +1 Choke |

### Gold Glove Tracking

End of season ranking by:
- fWAR at position (70%)
- LI-weighted clutch defensive plays (30%)

> **Note**: Gold Glove does NOT use Fame. Fame is for narrative/subjective awards
> (All-Star, MVP). Defensive excellence is measured by actual performance metrics.
> See fame_and_events_system.md for Fame system details.

### Position Detection

Track `gamesAtPosition` for:
- UTIL detection (3+ positions with threshold games)
- Gold Glove eligibility
- Primary position determination

---

## Appendix: MLB Research Summary

### Putout Distribution by Position (2012 MLB)

| Position | % of Putouts |
|----------|--------------|
| 1B | 31.9% |
| C | 28.3% |
| CF | 9.2% |
| RF | 7.2% |
| 2B | 6.8% |
| LF | 6.8% |
| SS | 5.5% |
| 3B | 2.4% |
| P | 2.0% |

**Note**: Catcher's high % includes all strikeout putouts.

### Double Play Frequency

- 6-4-3 (SS ‚Üí 2B ‚Üí 1B): ~27-28% of all DPs
- 4-6-3 (2B ‚Üí SS ‚Üí 1B): Second most common
- 98% of outs come from just 28 scoring combinations

### Batted Ball Distribution

| Type | % | Launch Angle |
|------|---|--------------|
| Ground Ball | 42-44% | < 5¬∞ |
| Line Drive | 20-21% | 5-25¬∞ |
| Fly Ball | 28-35% | 25-50¬∞ |
| Pop-up | 7-11% of FB | > 50¬∞ |

### Sources

- Baseball Savant (Statcast, OAA, spray charts)
- FanGraphs (UZR, DRS, batted ball stats)
- Baseball-Reference (historical data)
- MLB Official Rules

---

*End of Fielding System Specification*
~~~

### Source File: specs/FIELDING_PIPELINE_MAPPINGS.md

~~~markdown
# Fielding Data Pipeline ‚Äî Field Mappings & Gaps

> **Created**: Feb 9, 2026
> **Status**: ACTIVE ‚Äî Pipeline wired and verified via Playwright E2E

---

## Overview

The fielding data collection pipeline extracts fielding events from the EnhancedInteractiveField's `PlayData` output and writes them to IndexedDB via `logFieldingEvent()`. These events feed into:
- **Season fielding stats** (putouts, assists, errors) via `seasonAggregator.ts`
- **fWAR calculation** via `fwarCalculator.ts`

### Data Flow

```
EnhancedInteractiveField (PlayData)
  ‚Üí extractFieldingEvents() [fieldingEventExtractor.ts]
  ‚Üí logFieldingEvent() √ó N [eventLog.ts ‚Üí IndexedDB: kbl-event-log.fieldingEvents]
  ‚Üí completeGameInternal() / endGame() [useGameState.ts]
    ‚Üí getGameFieldingEvents() ‚Üí tally putouts/assists/errors per player
    ‚Üí playerStatsRecord with real fielding stats
  ‚Üí aggregateGameToSeason() [seasonAggregator.ts] ‚Äî accumulates fielding stats
  ‚Üí calculateFWARFromPersistedEvents() [fwarCalculator.ts] ‚Äî computes fWAR
```

---

## PlayData ‚Üí FieldingEvent Field Mapping

### Directly Mapped Fields

| PlayData Field | FieldingEvent Field | Mapping Logic | Notes |
|---|---|---|---|
| `fieldingSequence[last]` | `position` (putout event) | Position number ‚Üí Position via `POSITION_MAP` | `{1:'P', 2:'C', 3:'1B', 4:'2B', 5:'3B', 6:'SS', 7:'LF', 8:'CF', 9:'RF'}` |
| `fieldingSequence[0..n-1]` | `position` (assist events) | Each intermediate fielder gets an assist event | Multi-fielder plays produce multiple events |
| `exitType` | `ballInPlay.trajectory` | `Ground‚Üíground`, `Line Drive‚Üíline`, `Fly Ball‚Üífly`, `Pop Up‚Üípopup` | Falls back to outType inference if exitType missing |
| `playDifficulty` | `difficulty` | `routine‚Üíroutine`, `likely‚Üílikely`, `difficult‚Üí50-50`, `impossible‚Üíspectacular` | Defaults to `routine` if undefined |
| `spraySector` | `ballInPlay.zone` | `Left‚Üí1`, `Left-Center‚Üí2`, `Center‚Üí3`, `Right-Center‚Üí4`, `Right‚Üí5`, `Infield‚Üí6` | Defaults to `0` if undefined |
| `errorType` | Error event `playType='error'` | `FIELDING‚Üífielding`, `THROWING‚Üíthrowing`, `MENTAL‚Üímental` | Only for `type: 'error'` plays |
| `errorFielder` | Error event `position` | Position number ‚Üí Position via `POSITION_MAP` | Identifies which fielder committed the error |
| `dpType` | `double_play_pivot` events | Parse `"6-4-3"` ‚Üí 3 events: assist, DP pivot, putout | Pivot man gets `double_play_pivot` playType |
| `inferredFielder` | `ballInPlay.primaryFielderId` | Position number of system's predicted primary fielder | Used in `primaryFielderId` of `BallInPlayData` |
| `fieldingSequence` (all) | `ballInPlay.fielderIds` | All position numbers ‚Üí position strings | Full list of fielders involved |

### Derived Fields (Not Direct Mapping)

| FieldingEvent Field | Derivation | Notes |
|---|---|---|
| `fieldingEventId` | `${gameId}_fe_${atBatSequence}_${sequenceIdx}` | Unique ID combining game, at-bat, and event index |
| `gameId` | From `FieldingExtractionContext` | Passed by GameTracker from `gameState.gameId` |
| `atBatEventId` | `${gameId}_ab_${atBatSequence}` | Links to the at-bat event for cross-reference |
| `sequence` | Index within the play's events | 0-based, increments for each event on same play |
| `playerId` | Position string (e.g., `"SS"`) | Resolved to real player ID in `completeGameInternal()` via lineup refs |
| `playerName` | Position string (fallback) | Same as playerId; could be enhanced with lineup lookup |
| `teamId` | From `FieldingExtractionContext` | Defensive team determined by `gameState.isTop` |
| `success` | `playType !== 'error'` | All putouts/assists are successful; errors are not |

---

## Fielding Event Extraction Rules by Play Type

### Outs

| Out Type | Events Generated | Example |
|---|---|---|
| **GO** (Groundout) | Assists for all but last, putout for last | `[6,3]` ‚Üí SS assist + 1B putout |
| **FO** (Flyout) | Single putout for catching fielder | `[8]` ‚Üí CF putout |
| **LO** (Lineout) | Same as FO | `[4]` ‚Üí 2B putout |
| **PO** (Popout) | Same as FO | `[5]` ‚Üí 3B putout |
| **DP** (Double Play) | Assist for starter, DP pivot for middle, putout for last | `[6,4,3]` ‚Üí SS assist + 2B DP pivot + 1B putout |
| **TP** (Triple Play) | Assists for all but last, putout for last | `[5,4,3]` ‚Üí 3B assist + 2B assist + 1B putout |
| **SF** (Sacrifice Fly) | Putout for catcher of fly, assists for throwers | `[9]` ‚Üí RF putout |
| **FC** (Fielder's Choice) | Assists for all but last, putout for last | `[6,5]` ‚Üí SS assist + 3B putout |
| **SAC** (Sacrifice Bunt) | Same as GO structure | `[1,3]` ‚Üí P assist + 1B putout |
| **K** (Strikeout) | No events (not a ball in play) | ‚Äî |
| **K (D3K)** | If catcher in sequence: C assist + 1B putout | `[2,3]` ‚Üí C assist + 1B putout |
| **KL** (Strikeout Looking) | No events | ‚Äî |

### Non-Outs

| Play Type | Events Generated | Notes |
|---|---|---|
| **hit** (1B/2B/3B) | None | Hit = defense failed to record out. Runner thrown out on hit handled via fielder credit modal. |
| **hr** (Home Run) | None | Ball leaves the park ‚Äî no fielding opportunity |
| **error** | 1 error event | `errorFielder` gets error event with `errorType` mapped |
| **foul_out** | 1 putout event | First fielder in sequence gets putout |
| **walk** | None | Not a ball in play |
| **foul_ball** | None | Not a ball in play |

### Special Cases

| Scenario | Handling |
|---|---|
| **Outfield assist** | If first fielder is OF (position 7-9) with subsequent fielders, first event upgraded to `outfield_assist` |
| **DP pivot man** | Middle fielder(s) in DP sequence get `double_play_pivot` playType (counts as assist in tally) |
| **Empty fieldingSequence** | No events generated (can't attribute fielding credit) |
| **Position fallback** | If position number not in POSITION_MAP, defaults to `'SS'` |

---

## Player ID Resolution

The extractor stores **position strings** (e.g., `"SS"`, `"1B"`) as `playerId` because the actual player IDs require lineup context not available at extraction time.

**Resolution happens in `useGameState.ts` at game end:**
1. Build `positionToPlayerIdMap` from `awayLineupRef` + `homeLineupRef`
   - Key: `${position}_${teamId}` (e.g., `"SS_tigers-id"`)
   - Value: actual `playerId`
2. For each fielding event, resolve via:
   ```
   resolvedId = map.get(`${fe.playerId}_${fe.teamId}`)
             || map.get(`${fe.position}_${fe.teamId}`)
             || fe.playerId  // fallback to position string
   ```
3. Tally putouts/assists/errors per resolved player ID
4. Write to `playerStatsRecord` in `PersistedGameState`

---

## Gaps ‚Äî Fields That Cannot Be Populated from Current PlayData

| FieldingEvent Field | Current Value | Why Missing | Potential Future Fix |
|---|---|---|---|
| `ballInPlay.velocity` | Always `'medium'` | SMB4 does not expose exit velocity | Could infer from hit type + distance (line drive = hard, popup = soft) |
| `runsPreventedOrAllowed` | Always `0` | Requires real-time Leverage Index integration | Wire `playData.leverageIndex` when available from LI calculator |
| `playerName` | Position string | Need lineup lookup at extraction time | Pass lineup context to extractor, or resolve in post-processing |
| `ballInPlay.zone` | Coarse (1-6) | `spraySector` is string-based, not the detailed zone system fWAR wants | Map `ballLocation` coordinates to detailed zone grid |
| `difficulty: 'unlikely'` | Never produced | PlayData only has 4 difficulty levels; eventLog has 5 | Could map a sub-category of `difficult` to `unlikely` |

### PlayData Fields NOT Used by Extractor

| PlayData Field | Reason Not Used |
|---|---|
| `hitType` | Hit events don't generate fielding events |
| `walkType` | Walks don't generate fielding events |
| `ballLocation` (coordinates) | Used for spray charts but not directly for fielding events; `spraySector` covers zone mapping |
| `batterLocation` | Batter position irrelevant to fielding |
| `isFoul` / `foulType` | Only `foul_out` generates events; the foul details aren't needed |
| `hrDistance` / `hrType` | HRs don't generate fielding events |
| `inferenceConfidence` | Learning metric, not persisted to fielding events |
| `wasOverridden` | Learning metric, not persisted to fielding events |
| `leverageIndex` / `leverageCategory` | Could feed `runsPreventedOrAllowed` but not yet wired |
| `gameSituation` | Same as above ‚Äî context for LI calculation |
| `isClutchSituation` | Fame system concern, not fielding |
| `playoffContext` | Fame multiplier, not fielding |
| `fameValue` / `fameEventType` | Fame system, separate pipeline |
| `runnerOutcomes` | Runner tracking, not fielding credit |

---

## Downstream Consumers

### 1. Season Aggregator (`seasonAggregator.ts:243`)
Reads `putouts`, `assists`, `fieldingErrors` from `PersistedGameState.playerStats` and accumulates into season totals. **Works automatically** once `completeGameInternal()` provides real values.

### 2. fWAR Calculator (`fwarCalculator.ts:665`)
`calculateFWARFromPersistedEvents()` queries `getGameFieldingEvents()` from IndexedDB, converts via `convertPersistedToCalculatorEvent()` (line 619), and calculates fielding WAR. **Works automatically** once fielding events are written.

### 3. fWAR Adapter (`fwarCalculator.ts:619`)
Converts storage-model `FieldingEvent` to calculator-model `FieldingEvent`:
- `playType: 'putout'` ‚Üí `type: 'putout'`, `putoutType: 'flyball'|'groundball'|'tag'`
- `playType: 'assist'` ‚Üí `type: 'assist'`, `assistType: 'throw'|'relay'`
- `playType: 'error'` ‚Üí `type: 'error'`
- `playType: 'double_play_pivot'` ‚Üí `type: 'double_play_pivot'`
- `playType: 'outfield_assist'` ‚Üí `type: 'outfield_assist'`

---

## Verification Results (Feb 9, 2026)

### Playwright E2E Test

Simulated 4 play types via React fiber `onPlayComplete` callback:

| Play | Console Log | IndexedDB Events | Correct? |
|---|---|---|---|
| 6-3 Groundout | `Logged 2 fielding event(s) for out` | SS=assist, 1B=putout, trajectory=ground | YES |
| Flyout to CF | `Logged 1 fielding event(s) for out` | CF=putout, trajectory=fly | YES |
| 6-4-3 Double Play | `Logged 3 fielding event(s) for out` | SS=assist, 2B=DP pivot, 1B=putout, trajectory=ground | YES |
| Error by SS | `Logged 1 fielding event(s) for error` | SS=error, success=false, trajectory=ground | YES |

**Total: 7 events in IndexedDB, all correctly mapped. Zero console errors related to fielding.**

### Build & Test
- TypeScript: 0 errors (`npx tsc --noEmit`)
- Tests: 5416 pass / 211 fail (all pre-existing, no new failures)
~~~

### Source File: specs/BASEBALL_STATE_MACHINE_AUDIT.md

~~~markdown
# Baseball State Machine Audit

## Philosophy
The KBL XHD Tracker should function like a chess engine - every move must be legal, every outcome must be accounted for, and impossible states must be prevented.

## Phase 1: Map All Legal Transitions

### Result Types and Their Effects on Runners

#### Walks/HBP (BB, IBB, HBP)
- **Batter**: Goes to 1B
- **Force Chain**: Batter ‚Üí R1 ‚Üí R2 ‚Üí R3 (only if each base behind is occupied)
- **R1**: MUST advance to 2B (forced)
- **R2**: MUST advance to 3B only if R1 exists (forced by chain)
- **R3**: MUST score only if bases loaded (forced by chain)
- **Non-forced runners**: Can HOLD

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Always | TO_2B, TO_3B*, SCORED*, OUT_2B, OUT_3B, OUT_HOME |
| R2 | If R1 | TO_3B, SCORED*, HELD (if not forced), OUT_3B, OUT_HOME |
| R3 | If loaded | SCORED, HELD (if not forced), OUT_HOME |

*Requires extra event inference (SB, WP, PB, E)

#### Single (1B)
- **Batter**: Goes to 1B
- **R1**: MUST advance to at least 2B (forced)
- **R2**: Can advance to 3B or score, or HOLD
- **R3**: Almost always scores, can HOLD

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Yes | TO_2B, TO_3B, SCORED*, OUT_2B, OUT_3B, OUT_HOME |
| R2 | No | TO_3B, SCORED, HELD, OUT_3B, OUT_HOME |
| R3 | No | SCORED, HELD, OUT_HOME |

*R1 scoring on a single is rare - likely requires error (infer E)

#### Double (2B)
- **Batter**: Goes to 2B
- **R1**: MUST advance to at least 3B (batter takes 2B)
- **R2**: MUST advance (batter takes 2B)
- **R3**: Almost always scores

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Yes | TO_3B, SCORED, OUT_3B, OUT_HOME |
| R2 | Yes | TO_3B, SCORED, OUT_3B, OUT_HOME |
| R3 | No | SCORED, HELD (rare), OUT_HOME |

#### Triple (3B)
- **Batter**: Goes to 3B
- **All runners**: MUST score (batter takes 3B)

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Yes | SCORED, OUT_HOME |
| R2 | Yes | SCORED, OUT_HOME |
| R3 | Yes | SCORED, OUT_HOME |

#### Home Run (HR)
- **All runners + batter**: Score automatically
- **No user input needed for runners**

#### Outs (K, KL, GO, FO, LO, PO)
- **Batter**: Out
- **No force plays** (batter doesn't reach)
- **All runners**: Can HOLD or advance at their own risk

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | No | HELD, TO_2B, TO_3B, SCORED, OUT_2B, OUT_3B, OUT_HOME |
| R2 | No | HELD, TO_3B, SCORED, OUT_3B, OUT_HOME |
| R3 | No | HELD, SCORED (tag up on fly), OUT_HOME |

**Default**: HELD (runners typically don't advance on outs)

#### Strikeout (K, KL)
- **Batter**: Out (or reaches on D3K with 2 outs and 1B empty)
- **Runners**: Almost always HOLD
- **Exception**: Passed ball or wild pitch on K can allow advancement

**Default**: HELD for all runners

#### Double Play (DP)
- **Batter**: Out
- **R1**: OUT (typical 6-4-3 or 4-6-3)
- **Other runners**: Can advance on the play

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | N/A | OUT_2B (standard), HELD (unusual), TO_2B, TO_3B, SCORED |
| R2 | No | HELD, TO_3B, SCORED, OUT_3B, OUT_HOME |
| R3 | No | HELD, SCORED, OUT_HOME |

#### Sacrifice Fly (SF)
- **Batter**: Out
- **R3**: Typically SCORES (that's what makes it a SF)
- **Other runners**: Can advance on tag-up

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | No | HELD, TO_2B, OUT_2B |
| R2 | No | HELD, TO_3B, OUT_3B |
| R3 | No | SCORED (expected), HELD, OUT_HOME |

#### Sacrifice Bunt (SAC)
- **Batter**: Out
- **Runners**: Typically advance one base

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | No | TO_2B (expected), OUT_2B, HELD |
| R2 | No | TO_3B (expected), OUT_3B, HELD |
| R3 | No | SCORED, HELD, OUT_HOME |

#### Fielder's Choice (FC)
- **Batter**: Reaches 1B (defense chose to get another runner)
- **R1**: Force play, typically OUT

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Yes | OUT_2B (typical), TO_2B, TO_3B, SCORED |
| R2 | No | OUT_3B, TO_3B, SCORED, HELD |
| R3 | No | OUT_HOME, SCORED, HELD |

#### Error (E)
- **Batter**: Reaches base (1B, 2B, or 3B depending on error)
- **Runners**: Can advance beyond normal

**Legal Outcomes:**
| Runner | Forced? | Legal Outcomes |
|--------|---------|----------------|
| R1 | Varies | HELD, TO_2B, TO_3B, SCORED, OUT_2B, OUT_3B, OUT_HOME |
| R2 | Varies | HELD, TO_3B, SCORED, OUT_3B, OUT_HOME |
| R3 | No | HELD, SCORED, OUT_HOME |

---

## Phase 2: Impossible/Improbable Transitions

### IMPOSSIBLE (Must Block)
1. ‚ùå R1 HELD on walk/HBP (always forced)
2. ‚ùå R2 HELD on walk with R1 on base (forced by chain)
3. ‚ùå R3 HELD on bases-loaded walk (forced by chain)
4. ‚ùå R1 TO_2B on double (must go to 3B minimum)
5. ‚ùå R1 HELD on double (must vacate for batter)
6. ‚ùå Any runner HELD on triple (must vacate for batter)
7. ‚ùå R1 HELD on single (must vacate for batter)

### IMPROBABLE (Require Inference)
1. ‚ö†Ô∏è R1 ‚Üí 3B on walk ‚Üí Requires SB, WP, PB, or E
2. ‚ö†Ô∏è R1 ‚Üí HOME on walk ‚Üí Requires extra event
3. ‚ö†Ô∏è R2 ‚Üí HOME on walk (not forced) ‚Üí Requires extra event
4. ‚ö†Ô∏è R1 ‚Üí HOME on single ‚Üí Likely requires E
5. ‚ö†Ô∏è Any runner advances 2+ bases on walk ‚Üí Requires extra event

---

## Phase 3: Inference Rules

### Extra Event Types
| Code | Event | Description |
|------|-------|-------------|
| SB | Stolen Base | Runner advances on own during pitch/play |
| WP | Wild Pitch | Pitcher throws ball catcher can't handle |
| PB | Passed Ball | Catcher fails to catch catchable pitch |
| E | Error | Fielder misplays allowing extra advancement |

> **Note:** BALK is not in SMB4 and has been removed from this list.

### When to Prompt for Extra Event
```
IF (result IN [BB, IBB, HBP]) AND (runner advances > 1 base beyond forced position):
  PROMPT for extra event

IF (result = 1B) AND (R1 scores):
  PROMPT for extra event (likely E)

IF (result IN [K, KL]) AND (any runner advances):
  PROMPT for extra event (WP, PB, or SB)
```

### Clearing Extra Events
When user changes a runner's outcome:
1. Clear any pending extra event prompt for that runner
2. Remove any recorded extra events for that runner
3. Re-evaluate if new selection requires extra event

---

## Phase 4: Default Outcomes

### Auto-Default Rules by Result Type

| Result | R1 Default | R2 Default | R3 Default |
|--------|------------|------------|------------|
| BB/IBB/HBP | TO_2B | TO_3B (if forced) / HELD | SCORED (if forced) / HELD |
| 1B | TO_2B | TO_3B | SCORED |
| 2B | SCORED | SCORED | SCORED |
| 3B | SCORED | SCORED | SCORED |
| HR | (auto) | (auto) | (auto) |
| K/KL | HELD | HELD | HELD |
| GO | HELD | HELD | HELD |
| FO | HELD | HELD | SCORED (if < 2 outs, tag up) |
| LO | HELD | HELD | HELD |
| PO | HELD | HELD | HELD |
| DP | OUT_2B | HELD | HELD |
| SF | HELD | HELD | SCORED |
| SAC | TO_2B | TO_3B | HELD |
| FC | OUT_2B | HELD | HELD |
| E | TO_2B | TO_3B | SCORED |

---

## Implementation Checklist

### Bug Fixes Required
- [x] Prevent HELD option for forced runners
- [x] Fix extra events stacking infinitely on selection change
- [x] Add default outcomes for K/KL and other outs
- [x] Clear extra events when runner outcome changes

### State Machine Validation
- [x] Validate all outcomes against legal transitions table
- [x] Block impossible transitions in UI (via getRunnerOptions)
- [x] Prompt for extra events on improbable transitions
- [x] Auto-default to most common outcomes (via useEffect on mount)

---

## Test Results

**30 tests passed, 0 failed** ‚úÖ

Run tests with: `node testStateMachine.mjs`

### Tests Covered:
1. Walk with R2 only - R2 defaults to HELD
2. Walk with R1+R2 - Both forced, advance 1 base
3. FO with R3 (< 2 outs) - R3 scores, auto-converts to SF
4. Strikeout with R1+R2 - All default to HELD
5. Double with R2 - R2 defaults to SCORED
6. Walk with R1 - R1‚Üí3B requires extra event
7. Walk with R3 only (not forced) - R3 HELD
8. Bases loaded walk - All advance, R3 scores
9. FO with R3 and 2 outs - R3 HELD (no tag-up)
10. Single with bases loaded - Standard advancement
11. Triple with R1+R2 - All score
12. DP with R1 - R1 out at 2B
13. SAC with R1 - R1 to 2B
14. FC with R1 - R1 out at 2B
15. GO with R1+R2 - All HELD
16. Walk with R2+R3 (no R1) - Neither forced, both HELD
17. Walk with R1+R3 (no R2) - R1 forced, R3 not forced
18. Double with R1 only - R1 to 3B (not just 2B)
19. Double with R1+R2+R3 - R1 to 3B, R2+R3 score
20. HBP same as walk - R1 forced to 2B
21. IBB same as walk - bases loaded forces R3 score
22. Error with R1+R2 - both advance one base
23. SF with R1+R3 - R3 scores, R1 holds
24. SAC with R1+R2 - both advance one base
25. Line out with runners - all HELD
26. Pop out with runners - all HELD
27. K with advancement requires extra event
28. DP with R1+R2 - R1 out, R2 holds
29. FC with R1+R2 - R1 out, R2 holds
30. Single with R1 scoring requires extra event (error)

---

## Implementation Log

### Session 1 Fixes
1. **Force play logic** - `isRunnerForced()` correctly identifies forced runners
2. **Minimum advancement** - `getMinimumAdvancement()` returns correct minimum base
3. **Runner options filtering** - `getRunnerOptions()` hides HELD for forced runners
4. **Extra event detection** - `isExtraAdvancement()` flags non-standard advances

### Session 2 Fixes (Continuation)
1. **Extra events stacking** - Fixed by clearing events when selection changes
2. **Auto-defaults on mount** - Added `useEffect` to set defaults via `handleRunnerOutcomeChange`
3. **FO‚ÜíSF auto-conversion** - Fixed by running auto-correction on mount defaults
4. **R2 default on walk** - Fixed: non-forced R2 defaults to HELD
5. **Double outcomes** - Fixed: R2 defaults to SCORED (not TO_3B) on doubles
6. **Strikeout inference** - Added: any runner advancement on K requires extra event
7. **Non-forced R3 on walk** - Added: R3 scoring when not forced requires inference

### Key Functions
- `isRunnerForced(base)` - Determines if runner is forced to advance
- `getMinimumAdvancement(base)` - Returns minimum destination for forced runner
- `getDefaultOutcome(base)` - Returns expected/standard outcome
- `getRunnerOptions(base)` - Returns legal outcome options for UI
- `isExtraAdvancement(base, outcome)` - Checks if outcome needs extra event
- `checkAutoCorrection(outcomes)` - Handles FO‚ÜíSF conversion

---

*Document created as part of Baseball State Machine Audit*
*Last updated: Session 2 continuation*
~~~

## Exact Drag-and-Drop UI Requirements and Baseball-Strategy Flows

### Source File: specs/GAMETRACKER_DRAGDROP_SPEC.md

~~~markdown
# GameTracker Drag-and-Drop Specification

> **Purpose**: Define the drag-and-drop interaction model for the GameTracker component
> **Status**: DRAFT v4 - Added Foul Territory, Substitutions, Undo
> **Created**: 2026-01-31
> **Updated**: 2026-01-31 - Added foul geometry, lineup card subs, undo button

---

## Executive Summary

The GameTracker captures deep metrics (spray charts, park factors, fielding sequences) via an intuitive drag-and-drop interface on a **continuous geometric plane**.

### Core Principles

1. **ALL contact is tracked** - Every ball in play gets a spray chart location
2. **Fielder drop = where ball was fielded** (not where they throw)
3. **Tap sequence = throw chain** (tap fielder ‚Üí implies throw to them)
4. **Extended field includes stands** - HR landing spots tracked for distance/park data
5. **Two ways to log HRs** - Drag past fence (fun) OR HR button (quick)
6. **Foul territory is geometric** - Auto-detected from coordinates
7. **Substitutions via lineup card** - Not field dragging (prevents accidents)
8. **Undo button** - 5-step undo stack, no gestures (prevents accidents)
9. **Contextual refinement buttons** - After play, inferred special event buttons appear

---

## Four Ways to End an At-Bat

The user has **four primary input methods** to signal an at-bat has concluded:

| # | Action | What It Implies | Ball Location |
|---|--------|-----------------|---------------|
| **1** | **Drag fielder** to a spot on field | Out of some form (the drop location = where ball was fielded) | Captured from drop |
| **2** | **Drag batter** to safe/out zone at base | Hit (even if runner thrown out after) | User prompted to tap location |
| **3** | **Drag runner** to safe/out zone | Runner movement (steal, caught stealing, advancing on throw) | N/A - no ball in play |
| **4** | **Tap HR button** | Home run (quick entry) | User prompted for location + distance |

### Ball Location Capture Rules

- **Option 1 (Fielder drag)**: Drop location IS the ball location - no additional prompt needed
- **Option 2 (Batter drag)**: User is prompted "Touch where the ball landed" after dragging batter
- **Option 3 (Runner drag)**: No ball location - this is between-pitch or between-AB movement
- **Option 4 (HR button)**: User taps stands location, then enters distance

### After Play: Contextual Refinement Buttons (v2 - 2026-01-31)

> **Design Philosophy**: The user already told us WHAT happened. Contextual buttons ask "was there anything SPECIAL about it?"
>
> These buttons appear temporarily after play completion, positioned along the southern border of the field (foul territory area). They're quick one-tap refinements, not modals.

#### Inference Logic by Play Type

| Play Detected | First Fielder | Contextual Buttons Shown | Inference Logic |
|---------------|---------------|--------------------------|-----------------|
| **FO/LO (y > 0.95)** | 7, 8, 9 | `üé≠ ROBBERY` | Catch at wall = HR denied |
| **FO/LO (0.8 < y ‚â§ 0.95)** | 7, 8, 9 | `‚≠ê WEB GEM` | Deep catch = spectacular |
| **K (2-3 seq)** | 2 | `K` / `ÍùÑ` (looking) | Catcher throw to 1B = strikeout |
| **K (2-3-3 seq)** | 2 | `K` / `ÍùÑ` / `D3K` | Catcher dropped K, batter ran |
| **GO/FC (1-X seq)** | 1 | `üí• KILLED` / `ü•ú NUTSHOT` | Pitcher fielded = comebacker |
| **1B (y < 0.4)** | Any IF | `üèÉ BEAT THROW` / `üèè BUNT` | Infield hit = either beat throw or bunt |
| **Out (runner also out, non-DP)** | Any | `ü§¶ TOOTBLAN` | Runner out on same play = possible baserunning blunder |
| **Out (y > 0.8, throw to 2B/3B/HP)** | 7, 8, 9 | `ü§¶ TOOTBLAN` | Deep fly, runner thrown out = tried to tag |
| **Any AB ends** | ‚Äî | `7Ô∏è‚É£ 7+ PITCH` | Always available (no pitch tracking) |

#### Button Behavior

1. **One-tap confirmation**: Tapping a button records the special event immediately
2. **Auto-dismiss**: Buttons disappear after ~3 seconds OR when next play starts
3. **Fielder attribution**: Special events auto-credit the first fielder from the previous play
4. **Fame integration**: Events flow to Fame system with LI weighting: `fameValue = baseFame √ó ‚àöLI`

#### Fame Values (per SPECIAL_EVENTS_SPEC.md + kbl-detection-philosophy.md)

| Event | Base Fame | Notes |
|-------|-----------|-------|
| üé≠ ROBBERY | +1.5 | Fielder - catch at wall (y > 0.95) |
| ‚≠ê WEB GEM | +1.0 | Fielder - spectacular catch (0.8 < y ‚â§ 0.95) |
| ü§¶ TOOTBLAN | -3.0 | Runner - baserunning blunder |
| üí• KILLED | +3.0 | Batter - knocked pitcher down |
| ü•ú NUTSHOT | +1.0 | Batter - comebacker to sensitive area |

> **NOTE**: Robbery > Web Gem in Fame because denying a HR is more impactful than a diving catch.

#### Permanent Buttons (Always Available)

These buttons are NOT contextual - they're always visible:

| Button | Purpose | Notes |
|--------|---------|-------|
| `üí£ HR` | Quick HR entry | Bypasses drag-to-stands, prompts for location + distance |
| `7Ô∏è‚É£ 7+ PITCH` | Mark tough AB | No pitch tracking required - user just knows |

#### Deprecated (DO NOT USE)

The following patterns from earlier versions are **deprecated**:

- ‚ùå Pop-up modals for special events (replaced by contextual buttons)
- ‚ùå Manual special event entry via separate menu (replaced by contextual inference)
- ‚ùå Asking "Was that a Web Gem?" after every fly out (only show for deep catches)

---

## Coordinate System

### Extended Field Geometry (Includes Stands & Foul Territory)

The field extends beyond the wall and includes foul territory:

```
     y=1.4  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  (Upper Deck)
            ‚îÇ         STANDS              ‚îÇ
     y=1.2  ‚îÇ    LF      CF      RF       ‚îÇ
            ‚îÇ   Seats   Seats   Seats     ‚îÇ
     y=1.0  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚Üê WALL
            ‚îÇ \                       /   ‚îÇ
     y=0.85 ‚îÇ  \   LF     CF     RF  /    ‚îÇ  (Deep OF)
            ‚îÇ   \                 /       ‚îÇ
     y=0.65 ‚îÇ    \ [7]   [8]   [9]/       ‚îÇ  (OF positions)
            ‚îÇ     \             /         ‚îÇ
     y=0.42 ‚îÇ      \  [6] [4]  /          ‚îÇ  (IF positions)
            ‚îÇ   [5] \       / [3]         ‚îÇ
     y=0.35 ‚îú‚îÄ‚îÄ3B‚îÄ‚îÄ‚îÄ‚îÄ\‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ/‚îÄ‚îÄ‚îÄ‚îÄ1B‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
            ‚îÇ  FOUL   \   /    FOUL       ‚îÇ  ‚Üê Foul lines at 45¬∞
     y=0.18 ‚îÇ          [1]                ‚îÇ  (Pitcher)
            ‚îÇ           ‚îÇ                 ‚îÇ
     y=0.08 ‚îÇ          [2]                ‚îÇ  (Catcher)
            ‚îÇ           ‚îÇ                 ‚îÇ
     y=0.0  ‚îî‚îÄ‚îÄ‚îÄFOUL‚îÄ‚îÄ[HOME]‚îÄ‚îÄFOUL‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           x=0.0      x=0.5             x=1.0

            FOUL = |x - 0.5| > y √ó 0.5
```

### Foul Territory Detection

```typescript
/**
 * Determines if a coordinate is in foul territory.
 * Foul lines extend from home plate at 45¬∞ angles.
 *
 * Fair zone widens as y increases:
 * - At y=0 (home), fair zone is just x=0.5
 * - At y=0.5, fair zone is x=0.25 to x=0.75
 * - At y=1.0 (wall), fair zone is x=0.0 to x=1.0
 */
function isFoulTerritory(x: number, y: number): boolean {
  // Behind home plate is always foul
  if (y < 0) return true;

  // Foul lines: distance from centerline > y √ó 0.5
  // This creates 45¬∞ foul lines from home plate
  const distanceFromCenter = Math.abs(x - 0.5);
  const fairZoneHalfWidth = y * 0.5;

  return distanceFromCenter > fairZoneHalfWidth;
}

/**
 * Get the foul territory type for display purposes
 */
function getFoulType(x: number, y: number): 'left_foul' | 'right_foul' | 'behind_home' | null {
  if (!isFoulTerritory(x, y)) return null;
  if (y < 0.1) return 'behind_home';
  return x < 0.5 ? 'left_foul' : 'right_foul';
}
```

### Coordinate Mapping

| Location | Coordinates | Notes |
|----------|-------------|-------|
| Home Plate | (0.5, 0.0) | Batter starts here |
| Catcher | (0.5, 0.08) | Behind home |
| Pitcher | (0.5, 0.18) | Mound |
| First Base | (0.75, 0.35) | Right side infield |
| Second Base | (0.5, 0.42) | Middle infield |
| Third Base | (0.25, 0.35) | Left side infield |
| Shortstop | (0.38, 0.40) | Between 2B and 3B |
| Left Field | (0.15, 0.65) | Deep left |
| Center Field | (0.5, 0.75) | Deep center |
| Right Field | (0.85, 0.65) | Deep right |
| **LF Wall** | (0.0-0.35, 1.0) | Left field fence |
| **CF Wall** | (0.35-0.65, 1.0) | Center field fence |
| **RF Wall** | (0.65-1.0, 1.0) | Right field fence |
| **LF Stands** | (0.0-0.35, 1.0-1.4) | HR landing zone LF |
| **CF Stands** | (0.35-0.65, 1.0-1.4) | HR landing zone CF |
| **RF Stands** | (0.65-1.0, 1.0-1.4) | HR landing zone RF |
| **LF Foul** | x < 0.5 - y√ó0.5 | Left foul territory |
| **RF Foul** | x > 0.5 + y√ó0.5 | Right foul territory |

### Spray Chart: Wall Scrapers vs Bombs

The y-coordinate beyond the wall indicates HR type:

```typescript
function classifyHomeRun(y: number): 'wall_scraper' | 'deep' | 'bomb' {
  if (y < 1.05) return 'wall_scraper';  // Just cleared
  if (y < 1.2) return 'deep';           // Solid HR
  return 'bomb';                         // Upper deck / monster shot
}
```

---

## Core Interaction Patterns

### Pattern 1: Hit - Batter Reaches Base Safely

**Step 1**: Drag **batter** to destination base (1B, 2B, 3B)

**Step 2**: Engine prompts: **"Touch where the ball landed"**

**Step 3**: User taps location on field ‚Üí spray chart captured

**Step 4**: Pop-up asks for hit type:
- Ground ball / Line drive / Fly ball

**Optional Step 5**: If fielder made diving attempt but missed:
- Prompt: "Diving attempt?" ‚Üí Yes/No
- If Yes: Fielding chance recorded (affects fWAR, not error)

```
Batter drag to 1B ‚Üí "Touch where ball landed" ‚Üí User taps LCF ‚Üí "Hit type?" ‚Üí Line drive ‚Üí Done
```

### Pattern 2: Home Run (Two Methods)

#### Method A: Drag Past Fence (Fun)

**Step 1**: Drag **batter** beyond the wall (y > 1.0)

**Step 2**: User drops batter in the stands at landing location
- Drop position = exact spray chart location (including stands)
- Y-coordinate determines wall scraper vs bomb automatically

**Step 3**: Pop-up with text input: **"Distance (ft)?"**
- Text box for exact distance (SMB4 shows this)
- Example: 427

**Step 4**: Record HR with full data

```
Drag batter to RF stands (0.8, 1.15) ‚Üí "Distance?" ‚Üí 412 ‚Üí HR recorded
```

#### Method B: HR Button (Quick)

**Step 1**: Tap **[HR]** button (in foul territory per Figma)

**Step 2**: Engine prompts: **"Touch where the ball landed"**
- User taps location in stands (y > 1.0)

**Step 3**: Pop-up with text input: **"Distance (ft)?"**

**Step 4**: Record HR with full data

Both methods capture the same data; user chooses preferred UX.

### Pattern 3: Out - Fielder Makes Play

**Step 1**: Drag **fielder** to the spot where they fielded the ball
- This captures spray chart location
- Fielder snaps back to position after drop (or shows at drop spot briefly)

**Step 2**: Tap **next fielder(s)** in throw sequence
- Tap 1B (position 3) ‚Üí implies throw to first for out
- Tap 2B then 1B ‚Üí builds "4-3" or "6-4-3" sequence
- Tapping a fielder AT a base implies out at that base

**Step 3**: Pop-up confirms play type:
- Ground out / Line out / Fly out / Pop out
- Shows fielder sequence (e.g., "6-4-3")
- Checkboxes: Double play? Triple play?

```
Drag SS to (0.4, 0.38) ‚Üí Tap 2B ‚Üí Tap 1B ‚Üí "6-4-3 Double Play" confirmed
```

### Pattern 4: Fly Out / Line Out (Single Fielder)

**Step 1**: Drag **outfielder** to catch location

**Step 2**: Tap **dugout** (or don't tap anyone - just the fielder made the catch)

**Step 3**: Pop-up: "Fly out or Line out?"

**Special prompts if applicable**:
- Deep location (y > 0.8): "Web Gem?"
- Near wall (y > 0.95): "Robbery? (HR denied)"

```
Drag CF to (0.5, 0.85) ‚Üí "Fly out / Line out?" ‚Üí "Web Gem?" ‚Üí F-8, Web Gem recorded
```

### Pattern 5: Foul Out (Auto-Detected)

**Step 1**: Drag **fielder** to catch location in **foul territory**
- System auto-detects foul territory from coordinates
- No need for user to specify "foul out"

**Step 2**: System recognizes `isFoulTerritory(x, y) === true`

**Step 3**: Pop-up confirms: **"Foul out to [position]"**
- Shows territory: "LF foul territory" / "RF foul territory" / "Behind home"

```
Drag catcher to (0.6, 0.05) ‚Üí Auto-detect foul ‚Üí "Foul out to C" confirmed
Drag 1B to (0.9, 0.3) ‚Üí Auto-detect RF foul ‚Üí "Foul out to 1B" confirmed
```

### Pattern 6: Foul Ball (Strike, Not Caught)

For foul balls that add a strike but aren't caught:

**Option A**: Tap **[üìç Foul]** quick button
- Adds strike (unless already 2 strikes)
- No location tracking needed

**Option B**: Drag fielder to foul territory but **cancel** the catch
- Shows foul territory, user cancels popup
- Strike added automatically

### Pattern 7: Runner Advance/Out (Mid-At-Bat)

**User Action**: Drag **runner** from current base to new base

**If dropped ON the bag** (safe):
- Pop-up: SB, WP, PB, DI, Error?
- If Error: Tap fielder who committed it

**If dropped OFF the bag** (out):
- Pop-up: CS, Pickoff, TOOTBLAN?
- Then tap fielder sequence for the out

### Pattern 8: Walk / HBP / Strikeout (No Ball in Play)

**Quick buttons** below field:

```
[BB] [IBB] [HBP] [K] [ÍùÄ] [Drop K] [HR]
```

- **BB/IBB/HBP**: Batter auto-advances to 1B
- **K/ÍùÄ**: Strikeout (swinging/looking)
- **Drop K**: Dropped third strike - then show fielder interaction
- **HR**: Alternative to drag-past-fence method

### Pattern 9: Error

**Step 1**: Long-press (or double-tap) **fielder** to enter error mode
- Fielder icon shows "E" indicator

**Step 2**: Drag fielder to where ball was fielded

**Step 3**: Pop-up: Error type
- Fielding error
- Throwing error
- Dropped ball

**Step 4**: Batter advances, error charged to fielder

### Pattern 10: Fielding Chance on Hit (Diving Attempt)

When a hit occurs but fielder made a play attempt:

**After user taps ball landing location**:
- If location is near a fielder's range, prompt: "Fielding attempt?"
- If Yes: "Diving / Leaping / Sliding?"
- Records fielding chance (affects fielding%, fWAR) but not an error

---

## Substitution System

### Design Principle

**Substitutions happen in the lineup card, NOT by dragging on the field.**

Dragging players across the field is error-prone. Instead:
- **Lineup card** handles all position player substitutions
- **Pitcher slot** (next to current batter) handles pitching changes
- **Field view** is display-only (reflects lineup card state)

### GameTracker Layout

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [FIELD VIEW] - Display only, shows defensive positions     ‚îÇ
‚îÇ  [BIG SCOREBOARD BANNER] - Inning, score, count            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  CURRENT   ‚îÇ  ‚îÇ   SMALL    ‚îÇ  ‚îÇ  CURRENT   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  BATTER    ‚îÇ  ‚îÇ SCOREBOARD ‚îÇ  ‚îÇ  PITCHER   ‚îÇ ‚Üê Drop     ‚îÇ
‚îÇ  ‚îÇ [J.Smith]  ‚îÇ  ‚îÇ  2-1  B:1  ‚îÇ  ‚îÇ [M.Jones]  ‚îÇ   zone     ‚îÇ
‚îÇ  ‚îÇ  SS  .287  ‚îÇ  ‚îÇ  S:2  O:1  ‚îÇ  ‚îÇ  RHP  4.12 ‚îÇ   for new  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   pitcher  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [LINEUP CARD] - Drag-and-drop for subs                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 1. SS  J. Smith    .287   ‚Üê‚Üí  Drag to swap/sub     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 2. CF  M. Jones    .312                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 3. 1B  R. Davis    .298                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 4. LF  T. Wilson   .276                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 5. 3B  K. Brown    .289                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 6. RF  A. Lee      .267                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 7. 2B  C. Garcia   .245                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 8. C   P. Martinez .231                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 9. DH  S. Taylor   .301                             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ BENCH                                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ B. Wilson (OF) ‚îÇ T. Lee (IF) ‚îÇ J. Park (C)         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [BULLPEN]                                                  ‚îÇ
‚îÇ  Available: Smith (L) ‚îÇ Jones (R) ‚îÇ Davis (R)              ‚îÇ
‚îÇ  Used: ~~Martinez (R)~~ ‚ùå                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Pitching Change

**Step 1**: Drag reliever from **bullpen section** ‚Üí drop on **Current Pitcher slot**

**Step 2**: Confirmation popup:
- "Replace [Old Pitcher] with [New Pitcher]?"
- Shows pitcher stats

**Step 3**: On confirm:
- New pitcher appears in Current Pitcher slot
- Old pitcher moves to bullpen, shown as: ~~Name~~ ‚ùå (grayed, crossed out)
- Field view updates to show new pitcher on mound
- Scoreboard updates pitcher name

### Position Player Substitution

**Step 1**: In **lineup card**, drag bench player ‚Üí drop on lineup slot

**Step 2**: Confirmation popup:
- "Replace [Old Player] with [New Player] at [Position]?"
- Option to change position if new player is versatile

**Step 3**: On confirm:
- New player appears in lineup slot
- Old player moves to bench, shown as: ~~Name~~ ‚ùå (grayed, crossed out)
- Field view updates defensive positions

### Defensive Switch (No Substitution)

**Step 1**: In **lineup card**, drag player A ‚Üí drop on player B's slot

**Step 2**: Confirmation popup:
- "Switch [A] and [B] positions?"
- Shows: "A: SS ‚Üí 3B, B: 3B ‚Üí SS"

**Step 3**: On confirm:
- Players swap positions in lineup
- Field view updates
- No one leaves the game

### Double Switch

**Step 1**: Make pitching change (drag reliever to pitcher slot)

**Step 2**: Before confirming, drag bench player to lineup slot

**Step 3**: Confirmation shows combined move:
- "Pitching change: [Old P] ‚Üí [New P]"
- "Substitution: [Old Player] ‚Üí [New Player]"
- "Lineup spot swap if applicable"

### Player States

| State | Visual | Meaning |
|-------|--------|---------|
| **In Game** | Normal, highlighted border | Currently playing |
| **Available** | Normal | On bench/bullpen, can enter |
| **Used** | Grayed + ~~strikethrough~~ + ‚ùå | Already removed, cannot re-enter |

---

## Undo System

### Design Principle

**Undo button only, no gestures.**

Swipe gestures are too easy to trigger accidentally during normal field interaction.

### Undo Button

- **Location**: Top-left corner of GameTracker
- **Appearance**: Small button with ‚Ü© icon
- **Shows remaining undos**: "‚Ü© 3" (3 undos available)
- **Grayed out**: When stack is empty

### Undo Stack

```typescript
interface UndoState {
  maxSteps: 5;
  stack: GameSnapshot[];
  currentIndex: number;
}

interface GameSnapshot {
  timestamp: number;
  gameState: GameState;
  playDescription: string; // For display: "Single to LF"
}
```

### What Can Be Undone

| Action | Undoable | Notes |
|--------|----------|-------|
| Record hit | ‚úÖ | Restores previous state |
| Record out | ‚úÖ | Restores previous state |
| Record HR | ‚úÖ | Restores previous state |
| Runner advance | ‚úÖ | Restores previous state |
| Substitution | ‚úÖ | Restores previous state |
| Pitching change | ‚úÖ | Restores previous state |
| End inning | ‚úÖ | Restores previous state |
| End game | ‚ùå | Too significant, requires confirmation |

### Undo UX Flow

**Step 1**: User taps undo button

**Step 2**: Toast notification shows what was undone:
- "Undone: Single to LF by J. Smith"

**Step 3**: Game state reverts to previous snapshot

**Step 4**: Button updates count: "‚Ü© 2"

### Snapshot Timing

Snapshots are taken **before** each significant action:
- Before recording any play outcome
- Before making any substitution
- Before ending half-inning/inning

---

## Fielder Interaction Details

### Fielder Positions

```typescript
const FIELDER_POSITIONS = {
  1: { x: 0.50, y: 0.18, label: 'P' },   // Pitcher
  2: { x: 0.50, y: 0.08, label: 'C' },   // Catcher
  3: { x: 0.75, y: 0.35, label: '1B' },  // First Base
  4: { x: 0.58, y: 0.42, label: '2B' },  // Second Base
  5: { x: 0.25, y: 0.35, label: '3B' },  // Third Base
  6: { x: 0.42, y: 0.40, label: 'SS' },  // Shortstop
  7: { x: 0.15, y: 0.65, label: 'LF' },  // Left Field
  8: { x: 0.50, y: 0.75, label: 'CF' },  // Center Field
  9: { x: 0.85, y: 0.65, label: 'RF' },  // Right Field
};
```

### Tap Sequence Mechanics

After dragging a fielder to the ball location:

| Tap Target | Meaning |
|------------|---------|
| Another fielder | Throw to that fielder |
| Fielder at a base | Out at that base |
| Dugout | Ball caught (no throw needed) |
| Nothing (confirm) | Unassisted play |

### Building Sequences - Examples

| Play | User Actions | Result |
|------|--------------|--------|
| F-8 | Drag CF to catch spot ‚Üí Confirm | Fly out to CF |
| 6-3 | Drag SS to ball spot ‚Üí Tap 1B | Ground out SS to 1B |
| 6-4-3 DP | Drag SS ‚Üí Tap 2B ‚Üí Tap 1B | Double play |
| 5-4 | Drag 3B ‚Üí Tap 2B | Force out at 2B |
| U-3 | Drag 1B to ball spot ‚Üí Confirm | Unassisted out |
| 1-3 | Drag P ‚Üí Tap 1B | Comebacker, out at first |
| Foul-2 | Drag C to foul area ‚Üí Confirm | Foul out to catcher |

---

## Special Events Detection

### Auto-Prompt Events

| Event | Trigger | Prompt |
|-------|---------|--------|
| **Comebacker** | Pitcher (1) is first fielder | "Killed Pitcher / Nutshot?" |
| **Web Gem** | OF catch at y > 0.8 | "Great catch? (Web Gem)" |
| **Robbery** | Catch at y > 0.95 | "HR Robbery?" |
| **TOOTBLAN** | Runner out (not force) | "TOOTBLAN?" |
| **7+ Pitch AB** | Pitch count ‚â• 7 | Auto-logged |
| **Foul Out** | Catch in foul territory | Auto-classified |

### Manual Quick Buttons

Always visible:

```
[ü•ú Nutshot] [üí• Killed P] [ü§¶ TOOTBLAN] [‚≠ê Web Gem] [üìç Foul]
```

---

## Data Recording

### Hit Recording

```typescript
recordHit({
  batterId: string,
  type: 'single' | 'double' | 'triple' | 'homeRun',
  hitType: 'ground' | 'line' | 'fly',
  location: { x: number, y: number },  // Where ball landed
  distance?: number,                    // For HRs (exact feet from SMB4)
  rbis: number,
  fieldingAttempt?: {
    fielderId: string,
    attemptType: 'diving' | 'leaping' | 'sliding',
  },
  specialEvents: SpecialEvent[],
});
```

### Out Recording

```typescript
recordOut({
  batterId: string,
  type: 'flyOut' | 'groundOut' | 'lineOut' | 'popOut' | 'strikeout' | 'foulOut',
  fielderSequence: number[],           // [6, 4, 3] for 6-4-3
  ballLocation: { x: number, y: number }, // Where ball was fielded
  isFoulTerritory: boolean,            // Auto-detected from location
  isDoublePlay: boolean,
  isTriplePlay: boolean,
  runnersOut: { runnerId: string, base: BaseId }[],
  specialEvents: SpecialEvent[],
});
```

### Home Run Recording

```typescript
recordHomeRun({
  batterId: string,
  landingLocation: { x: number, y: number }, // In stands (y > 1.0)
  distance: number,                          // Exact feet from SMB4
  type: 'wall_scraper' | 'deep' | 'bomb',    // Derived from y
  rbis: number,
  specialEvents: SpecialEvent[],
});
```

### Substitution Recording

```typescript
recordSubstitution({
  type: 'pitching_change' | 'position_player' | 'defensive_switch' | 'double_switch',
  incomingPlayerId: string,
  outgoingPlayerId: string,
  newPosition?: Position,           // For position changes
  lineupSpot?: number,              // 1-9
  inning: number,
  halfInning: 'top' | 'bottom',
});
```

---

## UI Components

### 1. FieldCanvas (Extended)
- SVG field with stands area (y extends to 1.4)
- Coordinate system (0,0) to (1,1.4)
- Wall line clearly visible at y=1.0
- Stands rendered with seat pattern above wall
- **Foul lines visible** at 45¬∞ from home
- **Foul territory shaded differently**

### 2. DraggableFielder
- 9 fielder icons at positions
- Draggable to indicate ball fielded location
- Returns to position after drop
- Tappable for throw sequences

### 3. DraggableBatter
- At home plate
- Draggable to bases (hit) or past wall (HR)
- Visual feedback during drag

### 4. DraggableRunner
- At occupied bases
- Draggable to next base or out zone

### 5. BaseTarget
- 4 bases: 1B, 2B, 3B, Home
- Safe zone (on bag) vs Out zone (near bag)
- Visual feedback: green (safe) / red (out)

### 6. BallLandingPrompt
- Appears after batter reaches base
- "Touch where the ball landed"
- Full field is tappable

### 7. DistanceInput
- Text input for HR distance
- Numeric keyboard
- "Distance (ft)?" label

### 8. PlayConfirmationPopup
- Shows inferred play
- Fielder sequence display
- **Auto-shows "Foul out" for foul territory catches**
- Special event checkboxes
- Confirm / Edit / Cancel

### 9. QuickButtons
- Row below field
- BB, IBB, HBP, K, ÍùÄ, Drop K, HR
- Special events row

### 10. UndoButton
- Top-left corner
- Shows "‚Ü© N" with remaining undos
- Grayed when empty

### 11. LineupCard
- Draggable player slots
- Shows position, name, key stat
- Drop zones for substitutions

### 12. BenchPanel
- List of available bench players
- Draggable to lineup slots
- Used players grayed + ‚ùå

### 13. BullpenPanel
- List of available relievers
- Draggable to pitcher slot
- Used pitchers grayed + ‚ùå

### 14. CurrentPitcherSlot
- Drop zone for pitching changes
- Shows current pitcher name + stats
- Accepts drops from bullpen

---

## Implementation Phases

### Phase 1: Extended Field Canvas
- [ ] Create SVG field with stands area
- [ ] Implement coordinate system (0-1.4 for y)
- [ ] Add wall line at y=1.0
- [ ] **Add foul lines at 45¬∞**
- [ ] **Shade foul territory**
- [ ] Render fielder icons at positions
- [ ] Add base targets

### Phase 2: Batter Drag-Drop
- [ ] Draggable batter component
- [ ] Drop detection on bases
- [ ] Drop detection past wall (HR)
- [ ] "Touch where ball landed" prompt
- [ ] Distance input for HRs

### Phase 3: Fielder Drag-Drop
- [ ] Draggable fielder components
- [ ] Drop = ball fielded location
- [ ] **Auto-detect foul territory from coordinates**
- [ ] Tap sequence for throws
- [ ] Build fielder sequence display
- [ ] Confirm popup with play type

### Phase 4: Play Classification
- [ ] Hit classification (type, location)
- [ ] Out classification (sequence, type)
- [ ] **Foul out auto-classification**
- [ ] HR classification (distance, type)
- [ ] Fielding chance on hits (diving attempts)
- [ ] Special event detection

### Phase 5: Runner Events
- [ ] Draggable runners
- [ ] Safe/out zones at bases
- [ ] SB/CS/WP/PB classification
- [ ] Error mode (long-press)

### Phase 6: Substitution System
- [ ] Lineup card component
- [ ] Bench panel with draggable players
- [ ] Bullpen panel with draggable pitchers
- [ ] Current pitcher slot (drop zone)
- [ ] Substitution confirmation popup
- [ ] Used player visual state (grayed + ‚ùå)
- [ ] Field view sync with lineup card

### Phase 7: Undo System
- [ ] Undo button component
- [ ] GameSnapshot type
- [ ] Snapshot capture before actions
- [ ] Undo stack management (max 5)
- [ ] Undo action with state restore
- [ ] Toast notification for undone action

### Phase 8: Data Layer & Polish
- [ ] Connect to useGameState
- [ ] Wire all record functions
- [ ] IndexedDB persistence
- [ ] Animations & feedback
- [ ] Mobile touch support

---

## Open Questions (All Resolved)

1. ~~**Spray chart precision**~~ ‚Üí **RESOLVED**: Continuous (x, y) including stands
2. ~~**Fielder inference**~~ ‚Üí **RESOLVED**: User drags fielder to ball spot
3. ~~**HR entry**~~ ‚Üí **RESOLVED**: Both drag-past-fence AND HR button supported
4. ~~**HR distance**~~ ‚Üí **RESOLVED**: Text input for exact feet from SMB4
5. ~~**Wall scraper vs bomb**~~ ‚Üí **RESOLVED**: Y-coordinate determines automatically
6. ~~**Foul balls**~~ ‚Üí **RESOLVED**: Auto-detected from coordinates, [üìç Foul] button for strikes
7. ~~**Pitcher substitution**~~ ‚Üí **RESOLVED**: Drag from bullpen to pitcher slot
8. ~~**Replay/undo**~~ ‚Üí **RESOLVED**: Undo button with 5-step stack, no gestures

---

## Appendix: SMB4-Specific Considerations

Per `spec-docs/SMB4_GAME_MECHANICS.md`:

- **No balks** - Excluded from runner options
- **No catcher interference** - Excluded from outcomes
- **No checked swings** - K is K
- **HR distance shown** - SMB4 displays exact feet, we capture it

The system should NOT offer options that don't exist in SMB4.
~~~

### Source File: specs/FIELD_ZONE_INPUT_SPEC.md

~~~markdown
# Field Zone Input System Specification

> **Purpose**: Define touch-based zone input system for recording batted ball locations
> **Replaces**: Directional buttons (Pull/Center/Oppo, Shallow/Medium/Deep)
> **Integration**: Feeds into CLUTCH_ATTRIBUTION_SPEC.md (Contact Quality) and spray charts
> **UI Style**: GameChanger-like visual baseball diamond

---

## Table of Contents

1. [Overview](#1-overview)
2. [Zone Definitions](#2-zone-definitions)
3. [Zone ‚Üí Data Mapping](#3-zone--data-mapping)
4. [UI Layout & Design](#4-ui-layout--design)
5. [Touch Interaction](#5-touch-interaction)
6. [Integration with Contact Quality](#6-integration-with-contact-quality)
7. [Fielder Auto-Assignment](#7-fielder-auto-assignment)
8. [Spray Chart Generation](#8-spray-chart-generation)
9. [Implementation](#9-implementation)

---

## 1. Overview

### Why Zone-Based Input?

The current button-based system requires multiple taps:
- Direction: Pull / Center / Oppo
- Depth: Shallow / Medium / Deep
- Fielder: Manual selection

Zone-based input captures all three in **one tap**:
- Tap where the ball landed or was fielded
- System infers direction, depth, and likely fielder

### Design Philosophy

| Principle | Implementation |
|-----------|---------------|
| **Speed** | Single tap captures location |
| **Accuracy** | 25 zones (18 fair + 7 foul) balance precision vs complexity |
| **Intuitive** | Visual field matches real baseball positions |
| **Forgiving** | Tap anywhere, system finds nearest zone |
| **Complete** | Covers all playable territory including foul ground |

---

## 2. Zone Definitions

### 2.1 The 25-Zone System

The field is divided into **25 zones** covering fair territory AND foul territory:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FOUL                         OUTFIELD                               FOUL    ‚îÇ
‚îÇ [F05]                                                               [F00]   ‚îÇ
‚îÇ  ‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ    LF     ‚îÇ   LCF     ‚îÇ    CF     ‚îÇ   RCF     ‚îÇ  RF   ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ  WALL/WT  ‚îÇ           ‚îÇ  WALL/WT  ‚îÇ           ‚îÇ WALL  ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ   [Z17]   ‚îÇ   [Z16]   ‚îÇ   [Z15]   ‚îÇ   [Z14]   ‚îÇ [Z13] ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ     ‚îÇ
‚îÇ [F04]  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   [F01]   ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ    LF     ‚îÇ   LCF     ‚îÇ    CF     ‚îÇ   RCF     ‚îÇ  RF   ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ   DEEP    ‚îÇ   DEEP    ‚îÇ   DEEP    ‚îÇ   DEEP    ‚îÇ DEEP  ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ   [Z12]   ‚îÇ   [Z11]   ‚îÇ   [Z10]   ‚îÇ   [Z09]   ‚îÇ [Z08] ‚îÇ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ     ‚îÇ
‚îÇ [F03]      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              [F02]    ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ  LF     ‚îÇ       CF          ‚îÇ   RF    ‚îÇ                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ SHALLOW ‚îÇ     SHALLOW       ‚îÇ SHALLOW ‚îÇ                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ  [Z07]  ‚îÇ      [Z06]        ‚îÇ  [Z05]  ‚îÇ                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                                                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                         INFIELD                                   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                                                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ          ‚îÇ 3B  ‚îÇ                       ‚îÇ 1B  ‚îÇ                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ          ‚îÇ[Z04]‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ[Z01]‚îÇ                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   P     ‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                     ‚îÇ  [Z00]  ‚îÇ                                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ      ‚îÇ SS  ‚îÇ                           ‚îÇ 2B  ‚îÇ                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ      ‚îÇ[Z03]‚îÇ                           ‚îÇ[Z02]‚îÇ                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                                                    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ  C  ‚îÇ                                  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                          ‚îÇ     ‚îÇ                                  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                                                    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ FOUL LINE (3B) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚óá ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FOUL LINE (1B) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                             HOME                                           ‚îÇ
‚îÇ                                                                            ‚îÇ
‚îÇ                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                   ‚îÇ
‚îÇ                      ‚îÇ   CATCHER FOUL  ‚îÇ                                   ‚îÇ
‚îÇ                      ‚îÇ      [F06]      ‚îÇ                                   ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

FOUL ZONES:
F00 = RF Foul Line (deep)     F03 = LF Foul Line (shallow/infield)
F01 = RF Foul Line (medium)   F04 = LF Foul Line (medium)
F02 = RF Foul Line (shallow)  F05 = LF Foul Line (deep)
F06 = Behind Home Plate (catcher popup)
```

### 2.2 Zone ID Reference

```javascript
const FIELD_ZONES = {
  // ============================================
  // FAIR TERRITORY (Z00-Z17)
  // ============================================

  // Infield (0-4)
  Z00: { id: 'Z00', name: 'Pitcher', area: 'infield', position: 'P', isFoul: false },
  Z01: { id: 'Z01', name: '1B Area', area: 'infield', position: '1B', isFoul: false },
  Z02: { id: 'Z02', name: '2B Area', area: 'infield', position: '2B', isFoul: false },
  Z03: { id: 'Z03', name: 'SS Area', area: 'infield', position: 'SS', isFoul: false },
  Z04: { id: 'Z04', name: '3B Area', area: 'infield', position: '3B', isFoul: false },

  // Shallow Outfield (5-7)
  Z05: { id: 'Z05', name: 'Shallow RF', area: 'shallow_outfield', position: 'RF', isFoul: false },
  Z06: { id: 'Z06', name: 'Shallow CF', area: 'shallow_outfield', position: 'CF', isFoul: false },
  Z07: { id: 'Z07', name: 'Shallow LF', area: 'shallow_outfield', position: 'LF', isFoul: false },

  // Deep Outfield (8-12)
  Z08: { id: 'Z08', name: 'Deep RF', area: 'deep_outfield', position: 'RF', isFoul: false },
  Z09: { id: 'Z09', name: 'Deep RCF', area: 'deep_outfield', position: 'CF', isFoul: false },
  Z10: { id: 'Z10', name: 'Deep CF', area: 'deep_outfield', position: 'CF', isFoul: false },
  Z11: { id: 'Z11', name: 'Deep LCF', area: 'deep_outfield', position: 'CF', isFoul: false },
  Z12: { id: 'Z12', name: 'Deep LF', area: 'deep_outfield', position: 'LF', isFoul: false },

  // Warning Track / Wall (13-17)
  Z13: { id: 'Z13', name: 'RF Wall', area: 'wall', position: 'RF', isFoul: false },
  Z14: { id: 'Z14', name: 'RCF Wall', area: 'wall', position: 'CF', isFoul: false },
  Z15: { id: 'Z15', name: 'CF Wall', area: 'wall', position: 'CF', isFoul: false },
  Z16: { id: 'Z16', name: 'LCF Wall', area: 'wall', position: 'CF', isFoul: false },
  Z17: { id: 'Z17', name: 'LF Wall', area: 'wall', position: 'LF', isFoul: false },

  // ============================================
  // FOUL TERRITORY (F00-F06)
  // ============================================

  // Right Field Foul Line (1B side)
  F00: { id: 'F00', name: 'RF Foul Deep', area: 'foul_deep', position: 'RF', isFoul: true, foulSide: 'right' },
  F01: { id: 'F01', name: 'RF Foul Medium', area: 'foul_medium', position: 'RF', isFoul: true, foulSide: 'right' },
  F02: { id: 'F02', name: 'RF Foul Shallow', area: 'foul_shallow', position: '1B', isFoul: true, foulSide: 'right' },

  // Left Field Foul Line (3B side)
  F03: { id: 'F03', name: 'LF Foul Shallow', area: 'foul_shallow', position: '3B', isFoul: true, foulSide: 'left' },
  F04: { id: 'F04', name: 'LF Foul Medium', area: 'foul_medium', position: 'LF', isFoul: true, foulSide: 'left' },
  F05: { id: 'F05', name: 'LF Foul Deep', area: 'foul_deep', position: 'LF', isFoul: true, foulSide: 'left' },

  // Behind Home Plate
  F06: { id: 'F06', name: 'Catcher Foul', area: 'foul_catcher', position: 'C', isFoul: true, foulSide: 'back' }
};
```

### 2.3 Zone Geometry (SVG Coordinates)

The field uses a normalized coordinate system (0-100 for both axes):

```javascript
const ZONE_POLYGONS = {
  // Home plate at (50, 95), center field at (50, 5)

  // ============================================
  // FAIR TERRITORY
  // ============================================

  // Infield zones - pentagon/quadrilateral shapes
  Z00: { path: 'M 50,75 L 55,70 L 55,60 L 45,60 L 45,70 Z' },  // Pitcher
  Z01: { path: 'M 70,85 L 80,75 L 70,65 L 60,75 Z' },           // 1B
  Z02: { path: 'M 60,70 L 70,60 L 60,50 L 50,60 Z' },           // 2B
  Z03: { path: 'M 50,60 L 40,50 L 30,60 L 40,70 Z' },           // SS
  Z04: { path: 'M 40,75 L 30,65 L 20,75 L 30,85 Z' },           // 3B

  // Shallow outfield - arc segments
  Z05: { path: 'M 75,55 L 85,45 L 75,35 L 65,45 Z' },           // Shallow RF
  Z06: { path: 'M 65,45 L 75,35 L 50,25 L 25,35 L 35,45 Z' },   // Shallow CF
  Z07: { path: 'M 35,45 L 25,35 L 15,45 L 25,55 Z' },           // Shallow LF

  // Deep outfield - arc segments
  Z08: { path: 'M 85,45 L 95,30 L 85,20 L 75,35 Z' },           // Deep RF
  Z09: { path: 'M 75,35 L 85,20 L 65,12 L 60,25 Z' },           // Deep RCF
  Z10: { path: 'M 60,25 L 65,12 L 35,12 L 40,25 Z' },           // Deep CF
  Z11: { path: 'M 40,25 L 35,12 L 15,20 L 25,35 Z' },           // Deep LCF
  Z12: { path: 'M 25,35 L 15,20 L 5,30 L 15,45 Z' },            // Deep LF

  // Wall zones - thin strips at outer edge
  Z13: { path: 'M 95,30 L 98,18 L 90,12 L 85,20 Z' },           // RF Wall
  Z14: { path: 'M 85,20 L 90,12 L 70,5 L 65,12 Z' },            // RCF Wall
  Z15: { path: 'M 65,12 L 70,5 L 30,5 L 35,12 Z' },             // CF Wall
  Z16: { path: 'M 35,12 L 30,5 L 10,12 L 15,20 Z' },            // LCF Wall
  Z17: { path: 'M 15,20 L 10,12 L 2,18 L 5,30 Z' },             // LF Wall

  // ============================================
  // FOUL TERRITORY
  // ============================================

  // Right Field Foul Line (1B side) - runs along right edge
  F00: { path: 'M 98,18 L 100,5 L 100,20 L 98,18 Z' },          // RF Foul Deep (corner)
  F01: { path: 'M 95,30 L 100,20 L 100,45 L 90,50 Z' },         // RF Foul Medium
  F02: { path: 'M 80,75 L 90,50 L 100,45 L 100,80 L 85,90 Z' }, // RF Foul Shallow (1B side)

  // Left Field Foul Line (3B side) - runs along left edge
  F03: { path: 'M 20,75 L 15,90 L 0,80 L 0,45 L 10,50 Z' },     // LF Foul Shallow (3B side)
  F04: { path: 'M 5,30 L 10,50 L 0,45 L 0,20 Z' },              // LF Foul Medium
  F05: { path: 'M 2,18 L 0,20 L 0,5 L 2,18 Z' },                // LF Foul Deep (corner)

  // Behind Home Plate
  F06: { path: 'M 15,90 L 50,95 L 85,90 L 100,100 L 0,100 Z' }  // Catcher Foul (behind home)
};
```

---

## 3. Zone ‚Üí Data Mapping

### 3.1 Direction Mapping

Each zone maps to a spray direction based on batter handedness:

```javascript
/**
 * Get spray direction from zone for a batter
 * Pull = towards batter's same side (L‚ÜíRF, R‚ÜíLF)
 * Oppo = towards opposite side
 * Center = middle zones
 * Foul zones return 'foul_left', 'foul_right', or 'foul_back'
 */
function getDirectionFromZone(zoneId, batterHand) {
  const ZONE_TO_DIRECTION = {
    // Right side of field (pull for lefties, oppo for righties)
    Z01: 'right', Z05: 'right', Z08: 'right', Z13: 'right',
    Z02: 'center_right', Z09: 'center_right', Z14: 'center_right',

    // Center
    Z00: 'center', Z06: 'center', Z10: 'center', Z15: 'center',

    // Left side of field (pull for righties, oppo for lefties)
    Z03: 'center_left', Z11: 'center_left', Z16: 'center_left',
    Z04: 'left', Z07: 'left', Z12: 'left', Z17: 'left',

    // Foul territory (always returns foul direction, no pull/oppo conversion)
    F00: 'foul_right', F01: 'foul_right', F02: 'foul_right',  // 1B/RF line
    F03: 'foul_left', F04: 'foul_left', F05: 'foul_left',     // 3B/LF line
    F06: 'foul_back'                                           // Behind home
  };

  const rawDirection = ZONE_TO_DIRECTION[zoneId] || 'center';

  // Foul zones don't convert to pull/oppo - they stay as foul
  if (rawDirection.startsWith('foul_')) {
    return rawDirection;
  }

  // Convert to pull/center/oppo based on handedness
  if (batterHand === 'L') {
    return {
      right: 'pull',
      center_right: 'pull_center',
      center: 'center',
      center_left: 'oppo_center',
      left: 'oppo'
    }[rawDirection];
  } else {  // Right-handed or unknown
    return {
      left: 'pull',
      center_left: 'pull_center',
      center: 'center',
      center_right: 'oppo_center',
      right: 'oppo'
    }[rawDirection];
  }
}
```

### 3.2 Depth Mapping

```javascript
const ZONE_TO_DEPTH = {
  // ============================================
  // FAIR TERRITORY
  // ============================================

  // Infield
  Z00: 'infield', Z01: 'infield', Z02: 'infield',
  Z03: 'infield', Z04: 'infield',

  // Shallow outfield
  Z05: 'shallow', Z06: 'shallow', Z07: 'shallow',

  // Deep outfield
  Z08: 'medium', Z09: 'medium', Z10: 'medium',
  Z11: 'medium', Z12: 'medium',

  // Warning track / wall
  Z13: 'deep', Z14: 'deep', Z15: 'deep',
  Z16: 'deep', Z17: 'deep',

  // ============================================
  // FOUL TERRITORY
  // ============================================

  // RF Foul Line (1B side)
  F00: 'foul_deep',     // Corner near RF wall
  F01: 'foul_medium',   // Along line in OF
  F02: 'foul_shallow',  // Near 1B dugout area

  // LF Foul Line (3B side)
  F03: 'foul_shallow',  // Near 3B dugout area
  F04: 'foul_medium',   // Along line in OF
  F05: 'foul_deep',     // Corner near LF wall

  // Behind home
  F06: 'foul_catcher'   // Catcher popup territory
};

/**
 * Get depth category from zone
 */
function getDepthFromZone(zoneId) {
  return ZONE_TO_DEPTH[zoneId] || 'medium';
}

/**
 * Check if zone is foul territory
 */
function isFoulZone(zoneId) {
  return zoneId.startsWith('F');
}
```

### 3.3 Complete Zone Data Export

```javascript
/**
 * Get all data from a zone tap
 */
function getZoneData(zoneId, batterHand) {
  const zone = FIELD_ZONES[zoneId];

  return {
    zoneId: zoneId,
    zoneName: zone.name,

    // For spray charts
    direction: getDirectionFromZone(zoneId, batterHand),
    depth: getDepthFromZone(zoneId),

    // For fielder assignment
    area: zone.area,
    likelyFielder: zone.position,

    // Foul territory info
    isFoul: zone.isFoul || false,
    foulSide: zone.foulSide || null,  // 'left', 'right', 'back', or null

    // For CQ inference
    isInfield: zone.area === 'infield',
    isWall: zone.area === 'wall'
  };
}
```

---

## 4. UI Layout & Design

### 4.1 Visual Design

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     TAP WHERE BALL LANDED                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                          ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ                            ‚îÇ
‚îÇ                       ‚ï≠‚îÄ‚îÄ‚î§  WALL   ‚îú‚îÄ‚îÄ‚ïÆ                         ‚îÇ
‚îÇ                    ‚ï≠‚îÄ‚îÄ‚î§  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îú‚îÄ‚îÄ‚ïÆ                      ‚îÇ
‚îÇ                 ‚ï≠‚îÄ‚îÄ‚î§      DEEP OF       ‚îú‚îÄ‚îÄ‚ïÆ                    ‚îÇ
‚îÇ              ‚ï≠‚îÄ‚îÄ‚î§  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îú‚îÄ‚îÄ‚ïÆ                  ‚îÇ
‚îÇ           ‚ï≠‚îÄ‚îÄ‚î§       SHALLOW OF             ‚îú‚îÄ‚îÄ‚ïÆ                ‚îÇ
‚îÇ        ‚ï≠‚îÄ‚îÄ‚î§  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îú‚îÄ‚îÄ‚ïÆ               ‚îÇ
‚îÇ     ‚ï≠‚îÄ‚îÄ‚î§                                       ‚îú‚îÄ‚îÄ‚ïÆ             ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ  3B ‚óè              ‚óè 1B                 ‚îÇ  ‚îÇ           ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ       ‚óèSS      P‚óè      ‚óè2B              ‚îÇ  ‚îÇ           ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óèC‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ           ‚îÇ
‚îÇ    ‚îÇ                      ‚óá                        ‚îÇ           ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Selected: [None]           Fielder: [Auto-assign]       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ          [FOUL LEFT]     [POPUP]     [FOUL RIGHT]              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.2 Visual States

```javascript
const ZONE_VISUAL_STATES = {
  idle: {
    fill: 'transparent',
    stroke: '#444',
    strokeWidth: 1
  },
  hover: {
    fill: 'rgba(100, 150, 255, 0.2)',
    stroke: '#6699ff',
    strokeWidth: 2
  },
  selected: {
    fill: 'rgba(255, 200, 50, 0.4)',
    stroke: '#ffcc33',
    strokeWidth: 3
  },
  disabled: {
    fill: 'rgba(100, 100, 100, 0.1)',
    stroke: '#333',
    strokeWidth: 1
  }
};
```

### 4.3 Color Coding by Area

```javascript
const AREA_COLORS = {
  infield: {
    base: '#8B4513',      // Brown (dirt)
    highlight: '#CD853F'
  },
  shallow_outfield: {
    base: '#228B22',      // Green (grass)
    highlight: '#32CD32'
  },
  deep_outfield: {
    base: '#006400',      // Darker green
    highlight: '#228B22'
  },
  wall: {
    base: '#4169E1',      // Blue (warning track indicator)
    highlight: '#6495ED'
  },

  // Foul territory - grayed out to distinguish from fair
  foul_shallow: {
    base: '#A9A9A9',      // Dark gray
    highlight: '#C0C0C0'
  },
  foul_medium: {
    base: '#808080',      // Gray
    highlight: '#A9A9A9'
  },
  foul_deep: {
    base: '#696969',      // Dim gray
    highlight: '#808080'
  },
  foul_catcher: {
    base: '#778899',      // Light slate gray
    highlight: '#B0C4DE'
  }
};
```

---

## 5. Touch Interaction

### 5.1 Tap Detection

```javascript
/**
 * Handle tap on field SVG
 */
function handleFieldTap(event, svgElement) {
  const point = getSVGPoint(event, svgElement);
  const zoneId = findZoneAtPoint(point);

  if (zoneId) {
    selectZone(zoneId);
  }
}

/**
 * Convert screen coordinates to SVG coordinates
 */
function getSVGPoint(event, svg) {
  const rect = svg.getBoundingClientRect();
  const x = ((event.clientX - rect.left) / rect.width) * 100;
  const y = ((event.clientY - rect.top) / rect.height) * 100;
  return { x, y };
}

/**
 * Find which zone contains a point
 */
function findZoneAtPoint(point) {
  for (const [zoneId, zone] of Object.entries(ZONE_POLYGONS)) {
    if (pointInPolygon(point, zone.path)) {
      return zoneId;
    }
  }

  // If no exact match, find nearest zone
  return findNearestZone(point);
}
```

### 5.2 Nearest Zone Fallback

```javascript
/**
 * Find nearest zone if tap is outside all polygons
 */
function findNearestZone(point) {
  let nearestZone = null;
  let nearestDistance = Infinity;

  const ZONE_CENTERS = {
    // Fair territory
    Z00: { x: 50, y: 67 },
    Z01: { x: 70, y: 75 },
    Z02: { x: 60, y: 60 },
    Z03: { x: 40, y: 60 },
    Z04: { x: 30, y: 75 },
    Z05: { x: 75, y: 45 },
    Z06: { x: 50, y: 38 },
    Z07: { x: 25, y: 45 },
    Z08: { x: 85, y: 32 },
    Z09: { x: 68, y: 22 },
    Z10: { x: 50, y: 18 },
    Z11: { x: 32, y: 22 },
    Z12: { x: 15, y: 32 },
    Z13: { x: 92, y: 20 },
    Z14: { x: 75, y: 10 },
    Z15: { x: 50, y: 8 },
    Z16: { x: 25, y: 10 },
    Z17: { x: 8, y: 20 },

    // Foul territory
    F00: { x: 98, y: 12 },   // RF foul deep (corner)
    F01: { x: 95, y: 38 },   // RF foul medium
    F02: { x: 88, y: 70 },   // RF foul shallow (1B side)
    F03: { x: 12, y: 70 },   // LF foul shallow (3B side)
    F04: { x: 5, y: 38 },    // LF foul medium
    F05: { x: 2, y: 12 },    // LF foul deep (corner)
    F06: { x: 50, y: 98 }    // Catcher foul (behind home)
  };

  for (const [zoneId, center] of Object.entries(ZONE_CENTERS)) {
    const dist = Math.hypot(point.x - center.x, point.y - center.y);
    if (dist < nearestDistance) {
      nearestDistance = dist;
      nearestZone = zoneId;
    }
  }

  return nearestZone;
}
```

### 5.3 Quick Tap Shortcuts

For common plays, provide quick-tap buttons below the field:

```javascript
const QUICK_TAP_BUTTONS = [
  { id: 'foul_left', label: 'Foul L', zone: null, special: 'foul_left' },
  { id: 'popup', label: 'Popup', zone: 'Z00', exitType: 'Popup' },
  { id: 'foul_right', label: 'Foul R', zone: null, special: 'foul_right' },
  { id: 'hr_left', label: 'HR L', zone: 'Z17', result: 'HR' },
  { id: 'hr_center', label: 'HR C', zone: 'Z15', result: 'HR' },
  { id: 'hr_right', label: 'HR R', zone: 'Z13', result: 'HR' }
];
```

---

## 6. Integration with Contact Quality

### 6.1 Zone ‚Üí CQ Depth Mapping

The zone directly informs the Contact Quality inference from CLUTCH_ATTRIBUTION_SPEC.md:

```javascript
/**
 * Get CQ trajectory info from zone tap
 * Integrates with getContactQualityFromUI() from Clutch spec
 */
function getCQTrajectoryFromZone(zoneId, exitType) {
  const depth = getDepthFromZone(zoneId);

  // Map zone depth to CQ inference parameters
  if (exitType === 'Fly Ball') {
    return {
      depth: {
        'infield': 'shallow',    // Popup territory
        'shallow': 'shallow',
        'medium': 'medium',
        'deep': 'deep'
      }[depth]
    };
  }

  if (exitType === 'Ground Ball') {
    // Ground balls in outfield = through hole = hard
    // Ground balls in infield with out = routine
    return {
      speed: {
        'infield': 'medium',
        'shallow': 'hard',       // Got through infield
        'medium': 'hard',
        'deep': 'hard'
      }[depth]
    };
  }

  // Line drives don't need depth modification
  return {};
}

/**
 * Complete CQ resolution from zone + exit type
 */
function getContactQualityFromZone(zoneId, exitType, result) {
  const trajectory = getCQTrajectoryFromZone(zoneId, exitType);

  // Use the function from CLUTCH_ATTRIBUTION_SPEC.md
  return getContactQualityFromUI(exitType, trajectory, result);
}
```

### 6.2 Foul Territory Contact Quality

Foul balls that result in outs still have Contact Quality for clutch attribution:

```javascript
/**
 * Get CQ for foul territory catches
 * Foul popups are generally weak contact; foul flies down line vary
 */
function getFoulContactQuality(zoneId, exitType) {
  const FOUL_CQ = {
    // Catcher foul popup - always weak (mishit)
    F06: 0.15,

    // Shallow foul (near dugout) - usually weak popup
    F02: 0.20,
    F03: 0.20,

    // Medium foul - could be decent fly ball
    F01: 0.35,
    F04: 0.35,

    // Deep foul corner - often hard foul ball
    F00: 0.50,
    F05: 0.50
  };

  // Override for line drives in foul territory (hard but foul)
  if (exitType === 'Line Drive') {
    return 0.70;  // Hard contact, just foul
  }

  return FOUL_CQ[zoneId] || 0.25;
}
```

### 6.3 Example CQ Calculations

| Tap Zone | Exit Type | Result | CQ | Reasoning |
|----------|-----------|--------|-----|-----------|
| Z15 (CF Wall) | Fly Ball | Out | 0.75 | Deep fly = hard contact |
| Z06 (Shallow CF) | Fly Ball | Out | 0.35 | Shallow fly = weak contact |
| Z03 (SS Area) | Ground Ball | Out | 0.50 | Routine grounder |
| Z07 (Shallow LF) | Ground Ball | Single | 0.70 | Through hole = hard contact |
| Z10 (Deep CF) | Line Drive | Out | 0.85 | Line drive always = hard |
| Z13 (RF Wall) | Fly Ball | HR | 1.0 | Home run always = barrel |
| **F06 (Catcher Foul)** | Popup | Out | 0.15 | Weak popup = mishit |
| **F00 (RF Corner Foul)** | Fly Ball | Out | 0.50 | Deep foul = decent contact |
| **F03 (3B Foul Shallow)** | Popup | Out | 0.20 | Foul popup = weak |

---

## 7. Fielder Auto-Assignment

### 7.1 Default Fielder by Zone

```javascript
/**
 * Get most likely fielder for a zone
 */
function getDefaultFielder(zoneId) {
  return FIELD_ZONES[zoneId]?.position || null;
}
```

### 7.2 Fielder Override UI

After zone selection, show fielder chips for override:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FIELDER: CF (auto)                                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [P] [C] [1B] [2B] [SS] [3B] [LF] [‚óèCF] [RF]                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Tap to change if different fielder made the play               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3 Smart Fielder Suggestions

Based on zone, suggest plausible fielders:

```javascript
/**
 * Get fielder suggestions for a zone (primary + alternates)
 */
function getFielderSuggestions(zoneId) {
  const suggestions = {
    // ============================================
    // FAIR TERRITORY
    // ============================================

    // Infield zones - primary + adjacent
    Z00: ['P', 'C', '1B', '3B'],
    Z01: ['1B', '2B', 'P'],
    Z02: ['2B', 'SS', '1B'],
    Z03: ['SS', '3B', '2B'],
    Z04: ['3B', 'SS', 'P'],

    // Shallow outfield - could be infielder going back or OF coming in
    Z05: ['RF', '2B', '1B'],
    Z06: ['CF', 'SS', '2B'],
    Z07: ['LF', 'SS', '3B'],

    // Deep outfield - OF only but could be adjacent
    Z08: ['RF'],
    Z09: ['CF', 'RF'],
    Z10: ['CF'],
    Z11: ['CF', 'LF'],
    Z12: ['LF'],

    // Wall - OF only
    Z13: ['RF'],
    Z14: ['CF', 'RF'],
    Z15: ['CF'],
    Z16: ['CF', 'LF'],
    Z17: ['LF'],

    // ============================================
    // FOUL TERRITORY
    // ============================================

    // RF Foul Line (1B side)
    F00: ['RF'],                    // Deep foul corner - RF
    F01: ['RF', '1B'],              // Medium foul - RF or 1B
    F02: ['1B', 'C', '2B'],         // Shallow foul near dugout - 1B, C, or 2B

    // LF Foul Line (3B side)
    F03: ['3B', 'C', 'SS'],         // Shallow foul near dugout - 3B, C, or SS
    F04: ['LF', '3B'],              // Medium foul - LF or 3B
    F05: ['LF'],                    // Deep foul corner - LF

    // Behind Home Plate
    F06: ['C', 'P', '1B', '3B']     // Catcher popup - C primarily, corners possible
  };

  return suggestions[zoneId] || ['CF'];
}
```

---

## 8. Spray Chart Generation

> **See STADIUM_ANALYTICS_SPEC.md** for stadium-level spray chart tracking, aggregation, and visualization.

### 8.1 Zone-to-Spray-Point Mapping

Each zone tap converts to a spray chart point with slight randomization:

```javascript
/**
 * Generate spray chart point from zone
 */
function generateSprayPoint(zoneId, randomize = true) {
  const center = ZONE_CENTERS[zoneId];

  if (!randomize) {
    return { x: center.x, y: center.y };
  }

  // Add small random offset within zone
  const jitter = 3;  // ¬±3 units
  return {
    x: center.x + (Math.random() - 0.5) * jitter * 2,
    y: center.y + (Math.random() - 0.5) * jitter * 2
  };
}

/**
 * Spray chart point with metadata
 */
function createSprayChartEntry(zoneId, batterHand, result, exitType) {
  const point = generateSprayPoint(zoneId);
  const zoneData = getZoneData(zoneId, batterHand);

  return {
    x: point.x,
    y: point.y,
    zoneId: zoneId,
    direction: zoneData.direction,
    depth: zoneData.depth,
    result: result,           // 'single', 'double', 'out', 'HR', etc.
    exitType: exitType,       // 'Line Drive', 'Fly Ball', etc.

    // For spray chart coloring
    isHit: ['single', 'double', 'triple', 'HR'].includes(result),
    isHR: result === 'HR'
  };
}
```

### 8.2 Stadium Spray Chart Integration

Zone data feeds into both player spray charts AND stadium spray charts:

```javascript
/**
 * Create batted ball event for stadium analytics
 * Maps our 25-zone system to STADIUM_ANALYTICS_SPEC spray zones
 */
function createStadiumBattedBallEvent(
  zoneId: string,
  gameContext: GameContext,
  batterHand: 'L' | 'R',
  result: string,
  exitType: string
): BattedBallEvent {
  const zoneData = getZoneData(zoneId, batterHand);
  const sprayPoint = generateSprayPoint(zoneId);

  // Map our zones to stadium analytics spray zones
  const stadiumZone = mapToStadiumSprayZone(zoneId);

  return {
    gameId: gameContext.gameId,
    inning: gameContext.inning,
    batterId: gameContext.batterId,
    pitcherId: gameContext.pitcherId,
    batterHandedness: batterHand,

    // Location
    zone: stadiumZone,           // Stadium spray zone (7 zones)
    inputZone: zoneId,           // Our 25-zone ID for detail
    distance: estimateDistance(zoneId, result),
    angle: estimateAngle(zoneId),

    // Outcome
    outcome: mapResultToOutcome(result),
    outType: exitType === 'Ground Ball' ? 'GROUND' :
             exitType === 'Line Drive' ? 'LINE' :
             exitType === 'Fly Ball' ? 'FLY' : 'POP',

    // Coordinates for visualization
    x: sprayPoint.x,
    y: sprayPoint.y
  };
}

/**
 * Map 25-zone system to 7 stadium spray zones
 */
function mapToStadiumSprayZone(zoneId: string): SprayZone {
  const ZONE_TO_SPRAY_ZONE = {
    // Left line
    Z04: 'LEFT_LINE', Z17: 'LEFT_LINE', F03: 'LEFT_LINE', F04: 'LEFT_LINE', F05: 'LEFT_LINE',

    // Left field
    Z07: 'LEFT_FIELD', Z12: 'LEFT_FIELD',

    // Left-center
    Z11: 'LEFT_CENTER', Z16: 'LEFT_CENTER',

    // Center
    Z00: 'CENTER', Z06: 'CENTER', Z10: 'CENTER', Z15: 'CENTER',

    // Right-center
    Z02: 'RIGHT_CENTER', Z03: 'RIGHT_CENTER', Z09: 'RIGHT_CENTER', Z14: 'RIGHT_CENTER',

    // Right field
    Z05: 'RIGHT_FIELD', Z08: 'RIGHT_FIELD',

    // Right line
    Z01: 'RIGHT_LINE', Z13: 'RIGHT_LINE', F00: 'RIGHT_LINE', F01: 'RIGHT_LINE', F02: 'RIGHT_LINE',

    // Catcher foul - map to center for simplicity
    F06: 'CENTER'
  };

  return ZONE_TO_SPRAY_ZONE[zoneId] || 'CENTER';
}

/**
 * Estimate HR distance from zone (for stadium records)
 */
function estimateDistance(zoneId: string, result: string): number {
  if (result !== 'HR') return 0;

  // Base distances for HR zones (wall zones)
  const HR_DISTANCES = {
    Z13: 330,  // RF wall - shorter
    Z14: 375,  // RCF wall
    Z15: 400,  // CF wall - deepest
    Z16: 375,  // LCF wall
    Z17: 340,  // LF wall
  };

  const base = HR_DISTANCES[zoneId] || 370;

  // Add randomness for variety (¬±30 feet)
  return base + Math.floor((Math.random() - 0.3) * 60);
}
```

### 8.3 Post-Play Stadium Update

After each batted ball is recorded:

```javascript
/**
 * Called after recording a batted ball play
 * Updates both player and stadium spray charts
 */
async function recordBattedBallToStadium(
  stadiumId: string,
  event: BattedBallEvent
): Promise<void> {
  // From STADIUM_ANALYTICS_SPEC.md
  const stadium = await getStadium(stadiumId);

  // Add to spray chart
  recordBattedBall(stadium, event);

  // Check for stadium records (HR distance, etc.)
  if (event.outcome === 'HOME_RUN') {
    await checkHRDistanceRecord(stadium, event);
  }

  // Recalculate park factors if needed
  if (shouldRecalculateParkFactors(stadium)) {
    await updateParkFactors(stadium);
  }
}
```

### 8.2 Spray Chart Visualization

```javascript
/**
 * Spray chart color coding
 */
const SPRAY_COLORS = {
  HR: '#FF4444',          // Red
  triple: '#FF8800',      // Orange
  double: '#FFCC00',      // Yellow
  single: '#44FF44',      // Green
  out: '#888888',         // Gray
  error: '#8844FF'        // Purple
};

/**
 * Spray point size by result
 */
const SPRAY_SIZES = {
  HR: 12,
  triple: 10,
  double: 9,
  single: 8,
  out: 6,
  error: 8
};
```

---

## 9. Implementation

### 9.1 React Component Structure

```typescript
// Types
interface ZoneTapResult {
  zoneId: string;
  zoneName: string;
  direction: 'pull' | 'pull_center' | 'center' | 'oppo_center' | 'oppo'
           | 'foul_left' | 'foul_right' | 'foul_back';
  depth: 'infield' | 'shallow' | 'medium' | 'deep'
       | 'foul_shallow' | 'foul_medium' | 'foul_deep' | 'foul_catcher';
  likelyFielder: string;
  area: 'infield' | 'shallow_outfield' | 'deep_outfield' | 'wall'
      | 'foul_shallow' | 'foul_medium' | 'foul_deep' | 'foul_catcher';
  isFoul: boolean;
  foulSide: 'left' | 'right' | 'back' | null;
}

interface FieldZoneInputProps {
  batterHand: 'L' | 'R';
  onZoneSelect: (result: ZoneTapResult) => void;
  onFielderOverride?: (position: string) => void;
  selectedZone?: string;
  disabled?: boolean;
}
```

### 9.2 Component Hierarchy

```
<FieldZoneInput>
  ‚îú‚îÄ‚îÄ <FieldSVG>                    // The visual field
  ‚îÇ   ‚îú‚îÄ‚îÄ <FairZonePolygon> √ó 18    // Fair territory zones (Z00-Z17)
  ‚îÇ   ‚îú‚îÄ‚îÄ <FoulZonePolygon> √ó 7     // Foul territory zones (F00-F06)
  ‚îÇ   ‚îú‚îÄ‚îÄ <FoulLines>               // Visual foul lines
  ‚îÇ   ‚îú‚îÄ‚îÄ <PositionMarkers>         // P, C, 1B, etc labels
  ‚îÇ   ‚îî‚îÄ‚îÄ <SelectedZoneHighlight>   // Selection indicator
  ‚îÇ
  ‚îú‚îÄ‚îÄ <ZoneInfo>                    // Shows selected zone info
  ‚îÇ   ‚îú‚îÄ‚îÄ <FoulIndicator>           // Shows "FOUL" badge if foul zone
  ‚îÇ   ‚îî‚îÄ‚îÄ <FielderChips>            // Override fielder selection
  ‚îÇ
  ‚îî‚îÄ‚îÄ <QuickTapButtons>             // Popup, HR shortcuts (removed foul buttons - now tappable)
```

### 9.3 State Management

```javascript
const fieldZoneReducer = (state, action) => {
  switch (action.type) {
    case 'SELECT_ZONE':
      return {
        ...state,
        selectedZone: action.zoneId,
        fielder: FIELD_ZONES[action.zoneId].position,
        fielderOverridden: false
      };

    case 'OVERRIDE_FIELDER':
      return {
        ...state,
        fielder: action.position,
        fielderOverridden: true
      };

    case 'CLEAR_SELECTION':
      return {
        ...state,
        selectedZone: null,
        fielder: null,
        fielderOverridden: false
      };

    default:
      return state;
  }
};
```

### 9.4 Integration with Play Entry

```javascript
/**
 * When recording a batted ball play, call this to get zone data
 */
function recordBattedBall(playData, zoneState, exitType, result) {
  const { selectedZone, fielder } = zoneState;
  const zoneData = getZoneData(selectedZone, playData.batterHand);

  return {
    ...playData,

    // Zone data
    zoneId: selectedZone,
    direction: zoneData.direction,
    depth: zoneData.depth,

    // Fielder (possibly overridden)
    fielderPosition: fielder,

    // Contact Quality (for clutch calculation)
    contactQuality: getContactQualityFromZone(selectedZone, exitType, result),

    // Spray chart point
    sprayPoint: generateSprayPoint(selectedZone),

    // Exit type from separate UI
    exitType: exitType,
    result: result
  };
}
```

---

## Appendix A: Zone Coordinate Reference

### Fair Territory (Z00-Z17)

| Zone ID | Center (x, y) | Area | Primary Fielder |
|---------|---------------|------|-----------------|
| Z00 | (50, 67) | infield | P |
| Z01 | (70, 75) | infield | 1B |
| Z02 | (60, 60) | infield | 2B |
| Z03 | (40, 60) | infield | SS |
| Z04 | (30, 75) | infield | 3B |
| Z05 | (75, 45) | shallow_outfield | RF |
| Z06 | (50, 38) | shallow_outfield | CF |
| Z07 | (25, 45) | shallow_outfield | LF |
| Z08 | (85, 32) | deep_outfield | RF |
| Z09 | (68, 22) | deep_outfield | CF |
| Z10 | (50, 18) | deep_outfield | CF |
| Z11 | (32, 22) | deep_outfield | CF |
| Z12 | (15, 32) | deep_outfield | LF |
| Z13 | (92, 20) | wall | RF |
| Z14 | (75, 10) | wall | CF |
| Z15 | (50, 8) | wall | CF |
| Z16 | (25, 10) | wall | CF |
| Z17 | (8, 20) | wall | LF |

### Foul Territory (F00-F06)

| Zone ID | Center (x, y) | Area | Primary Fielder | Side |
|---------|---------------|------|-----------------|------|
| F00 | (98, 12) | foul_deep | RF | Right (1B line) |
| F01 | (95, 38) | foul_medium | RF | Right (1B line) |
| F02 | (88, 70) | foul_shallow | 1B | Right (1B line) |
| F03 | (12, 70) | foul_shallow | 3B | Left (3B line) |
| F04 | (5, 38) | foul_medium | LF | Left (3B line) |
| F05 | (2, 12) | foul_deep | LF | Left (3B line) |
| F06 | (50, 98) | foul_catcher | C | Back (behind home) |

### Foul Zone CQ Reference

| Zone | Typical Contact Quality | Common Play Type |
|------|------------------------|------------------|
| F06 (Catcher) | 0.15 | Popup behind plate |
| F02, F03 (Shallow) | 0.20 | Foul popup near dugout |
| F01, F04 (Medium) | 0.35 | Foul fly down line |
| F00, F05 (Deep) | 0.50 | Deep foul to corner |

---

*Last Updated: January 22, 2026*
*Version: 1.1 - Added foul territory zones (F00-F06)*
~~~

### Source File: specs/SUBSTITUTION_FLOW_SPEC.md

~~~markdown
# Substitution Flow Specification

> **Purpose**: Define how player substitutions are tracked during in-game tracking
> **Integration**: INHERITED_RUNNERS_SPEC.md, PITCH_COUNT_TRACKING_SPEC.md
> **Related Specs**: KBL_XHD_TRACKER_MASTER_SPEC_v3.md ¬ß4 (In-Game Tracking)
> **SMB4 Reference**: SMB4_GAME_MECHANICS.md

---

## Table of Contents

1. [Overview](#1-overview)
2. [Substitution Types](#2-substitution-types)
3. [Pinch Hitter Flow](#3-pinch-hitter-flow)
4. [Pinch Runner Flow](#4-pinch-runner-flow)
5. [Defensive Substitution Flow](#5-defensive-substitution-flow)
6. [Pitching Change Flow](#6-pitching-change-flow)
7. [Double Switch](#7-double-switch)
8. [Data Schema](#8-data-schema)
9. [UI Flows](#9-ui-flows)
10. [Validation Rules](#10-validation-rules)

---

## 1. Overview

### Why Track Substitutions?

Substitutions impact:
- **Lineup management** - Who is in and out of the game
- **WAR calculations** - Partial game appearances
- **Inherited runners** - Reliever evaluations
- **Narrative generation** - "Manager brought in lefty specialist..."
- **Historical accuracy** - Complete game records

### SMB4 Substitution Mechanics

SMB4 supports:
- ‚úÖ Pinch hitters
- ‚úÖ Pinch runners
- ‚úÖ Defensive substitutions
- ‚úÖ Pitching changes
- ‚úÖ Double switches (manual combination)

SMB4 does NOT have:
- ‚ùå Designated Hitter (DH) rules - pitchers bat
- ‚ùå Two-way player rules
- ‚ùå Position eligibility restrictions

---

## 2. Substitution Types

### 2.1 Types Summary

| Type | Code | When | Who Leaves | Who Enters |
|------|------|------|------------|------------|
| Pinch Hitter | PH | During at-bat | Current batter | Bench player |
| Pinch Runner | PR | Runner on base | Current runner | Bench player |
| Defensive Sub | DEF | Between innings or after out | Fielder | Bench player |
| Pitching Change | PITCH | Any time (with runners or not) | Pitcher | Reliever |
| Double Switch | DS | Usually with pitching change | Pitcher + fielder | Reliever + position player |

### 2.2 When Substitutions Occur

```
DURING AT-BAT:
‚îú‚îÄ‚îÄ Pinch Hitter ‚Üí Before pitch (or between pitches)
‚îî‚îÄ‚îÄ Pitching Change ‚Üí Before pitch

RUNNER ON BASE:
‚îú‚îÄ‚îÄ Pinch Runner ‚Üí Between plays
‚îî‚îÄ‚îÄ Pitching Change ‚Üí Can happen with runners on

BETWEEN HALF-INNINGS:
‚îú‚îÄ‚îÄ Defensive Sub ‚Üí Any position
‚îú‚îÄ‚îÄ Pitching Change ‚Üí Starter/reliever swap
‚îî‚îÄ‚îÄ Double Switch ‚Üí Position swap + pitching change

AFTER AN OUT:
‚îú‚îÄ‚îÄ Defensive Sub ‚Üí With dead ball
‚îî‚îÄ‚îÄ Pitching Change ‚Üí Mid-inning
```

---

## 3. Pinch Hitter Flow

### 3.1 When to Trigger

Pinch hitter entry should be prompted/available:
- When a new batter comes up
- Before any pitch is thrown to that batter
- User initiates "Substitution" action

### 3.2 UI Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PINCH HITTER                                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Current Batter: Mike Thompson (P) - .180 AVG                   ‚îÇ
‚îÇ  Spot: #9 in lineup                                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Select Pinch Hitter:                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ [‚óè] Jake Wilson (OF) - .312 AVG - R bat vs L pitch       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] Sam Davis (1B) - .285 AVG - L bat vs L pitch         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] Chris Martin (IF) - .267 AVG - S bat                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] (Other available bench players...)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  After at-bat, Wilson will play: [Select Position ‚ñº]            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ RF (replacing Thompson's spot)                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ LF ‚îÇ CF ‚îÇ 1B ‚îÇ 2B ‚îÇ SS ‚îÇ 3B ‚îÇ C ‚îÇ P                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [Cancel]                    [Confirm Pinch Hitter]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.3 Data Captured

```typescript
interface PinchHitterEvent {
  eventType: 'PINCH_HITTER';
  gameId: string;
  inning: number;
  halfInning: 'top' | 'bottom';
  outs: number;

  // Who's out
  replacedPlayerId: string;
  replacedPlayerName: string;
  replacedBattingOrder: number;  // 1-9

  // Who's in
  pinchHitterId: string;
  pinchHitterName: string;

  // Defensive assignment after AB
  fieldingPosition: Position;

  // Context
  pitcherFacing: string;  // Opposing pitcher
  situation: string;      // "R1R3, 2 outs"
}
```

### 3.4 Post-AB Handling

After the pinch hitter's at-bat:
1. PH remains in game at specified position
2. Original player is OUT of the game
3. Update lineup and defensive alignment

---

## 4. Pinch Runner Flow

### 4.1 When to Trigger

Pinch runner entry available:
- When any runner is on base
- Between plays (dead ball)
- User initiates "Substitution" action

### 4.2 Special Consideration: Inherited Runners

When a pinch runner replaces a baserunner:
- **Pitcher responsibility does NOT change**
- If original runner reached off Pitcher A, PR is still "owned" by Pitcher A
- If PR scores, it's charged to Pitcher A (ER or UER based on how they reached)

```typescript
// From INHERITED_RUNNERS_SPEC.md
interface PinchRunnerEvent {
  // ... standard fields

  // CRITICAL: Maintain pitcher responsibility
  originalRunnerPitcherResponsible: string;
  // PR inherits this - they are STILL owned by that pitcher
}
```

### 4.3 UI Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PINCH RUNNER                                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Current Runner on 2B: Tony Martinez (.240 AVG, 3 SB)           ‚îÇ
‚îÇ  Reached on: Double off Cole (2nd inning)                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Select Pinch Runner:                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ [‚óè] Speed Williams (OF) - 15 SB, 95 SPD rating           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] Flash Gordon (IF) - 12 SB, 88 SPD rating             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] (Other available bench players...)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è If Williams scores, run charged to Cole (original pitcher)  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  After inning, Williams will play: [Select Position ‚ñº]          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [Cancel]                    [Confirm Pinch Runner]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.4 Data Captured

```typescript
interface PinchRunnerEvent {
  eventType: 'PINCH_RUNNER';
  gameId: string;
  inning: number;
  halfInning: 'top' | 'bottom';
  outs: number;

  // Who's out
  replacedPlayerId: string;
  replacedPlayerName: string;
  replacedBattingOrder: number;
  base: '1B' | '2B' | '3B';

  // Who's in
  pinchRunnerId: string;
  pinchRunnerName: string;

  // INHERITED RUNNER TRACKING - Critical!
  pitcherResponsible: string;  // Pitcher who allowed original runner
  howOriginalReached: 'hit' | 'walk' | 'hbp' | 'error' | 'fc';

  // Defensive assignment after inning
  fieldingPosition: Position;
}
```

---

## 5. Defensive Substitution Flow

### 5.1 When to Trigger

Defensive subs typically occur:
- Between half-innings
- After a pinch hitter's AB (PH takes a position)
- After a pitching change (shuffling positions)
- During dead ball situations

### 5.2 UI Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DEFENSIVE SUBSTITUTION                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Current Defense:                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ     LF: Jones     CF: Smith     RF: Wilson               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ          SS: Davis       2B: Brown                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     3B: Miller                      1B: Garcia           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                   P: Cole                                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                   C: Martinez                            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Substitution:                                                  ‚îÇ
‚îÇ  Player OUT: [Select from current fielders ‚ñº]                   ‚îÇ
‚îÇ  Player IN:  [Select from bench ‚ñº]                              ‚îÇ
‚îÇ  Position:   [Confirm position ‚ñº]                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üí° You can make multiple subs before confirming                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Pending Changes:                                               ‚îÇ
‚îÇ  ‚Ä¢ Wilson (RF) OUT ‚Üí Parker IN at RF                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ    [Add Another Sub]        [Cancel]        [Confirm All]       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.3 Data Captured

```typescript
interface DefensiveSubEvent {
  eventType: 'DEFENSIVE_SUB';
  gameId: string;
  inning: number;
  halfInning: 'top' | 'bottom';

  // Can have multiple subs at once
  substitutions: {
    playerOut: string;
    playerOutName: string;
    playerIn: string;
    playerInName: string;
    position: Position;
    battingOrder: number;  // Takes over batting spot
  }[];
}
```

---

## 6. Pitching Change Flow

### 6.1 Integration with Other Specs

Pitching changes trigger:
1. **PITCH_COUNT_TRACKING_SPEC.md** - Capture outgoing pitcher's final count
2. **INHERITED_RUNNERS_SPEC.md** - Document bequeathed runners

### 6.2 UI Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PITCHING CHANGE                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  OUTGOING PITCHER: Gerrit Cole                                  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Line: 6.2 IP, 3 H, 2 ER, 1 BB, 8 K                        ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Pitch Count: [___] (REQUIRED)                              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Runners Left: R1 (via single), R2 (via walk)               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è Runners on base will be charged to Cole if they score       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  INCOMING PITCHER:                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ [‚óè] Chapman (CL) - 2.10 ERA, 98 mph                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] Loaisiga (RP) - 3.45 ERA, 96 mph                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ [ ] Holmes (RP) - 2.85 ERA, sinker specialist            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [Cancel]                    [Confirm Pitching Change]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.3 Data Captured

```typescript
interface PitchingChangeEvent {
  eventType: 'PITCHING_CHANGE';
  gameId: string;
  inning: number;
  halfInning: 'top' | 'bottom';
  outs: number;

  // Outgoing pitcher
  outgoingPitcherId: string;
  outgoingPitcherName: string;
  outgoingPitchCount: number;       // REQUIRED
  outgoingLine: PitcherGameLine;    // IP, H, R, ER, BB, K

  // Bequeathed runners (from INHERITED_RUNNERS_SPEC)
  bequeathedRunners: {
    base: '1B' | '2B' | '3B';
    runnerId: string;
    howReached: string;
  }[];

  // Incoming pitcher
  incomingPitcherId: string;
  incomingPitcherName: string;
  incomingPitcherRole: 'SP' | 'RP' | 'CL';

  // Context
  inheritedRunners: number;  // Count for new pitcher
  currentScore: { home: number; away: number };
  leverage: 'low' | 'medium' | 'high';  // Game situation
}
```

### 6.4 Pitcher Stats Initialization ‚úÖ IMPLEMENTED

When a pitching change is processed in `handleSubstitutionComplete()`:

```typescript
// 1. Apply substitution to lineup state
const newLineupState = applySubstitution(lineupState, event, inning);
// This sets lineupState.currentPitcher to the new pitcher

// 2. Initialize pitcher stats for new pitcher in pitcherGameStats Map
if (event.eventType === 'PITCH_CHANGE') {
  const pc = event as PitchingChangeEvent;
  setPitcherGameStats((prev) => {
    const newMap = new Map(prev);
    if (!newMap.has(pc.incomingPitcherId)) {
      // Team determined by which half of inning (home pitches in TOP)
      const teamId = halfInning === 'TOP' ? homeTeamId : awayTeamId;
      newMap.set(
        pc.incomingPitcherId,
        createInitialPitcherStats(
          pc.incomingPitcherId,
          pc.incomingPitcherName,
          teamId,
          false,  // isStarter = false for relievers
          inning  // entryInning for tracking
        )
      );
    }
    return newMap;
  });
}
```

**Why This Matters:**
- `pitcherGameStats` Map accumulates stats across all at-bats
- New pitchers need an entry BEFORE their first at-bat
- `isStarter: false` ensures relievers are categorized correctly
- `entryInning` enables "first inning disaster" tracking for starters only
- `getCurrentPitcherId()` now uses `lineupState.currentPitcher` instead of fixed IDs

**Integration with STAT_TRACKING_ARCHITECTURE_SPEC.md:**
- Pitcher stats persist in game state (Phase 2)
- Stats aggregate to season totals on game completion (Phase 3)
- Enables proper no-hitter/perfect game detection (needs full-game accumulation)

---

## 7. Double Switch

### 7.1 What is a Double Switch?

A double switch is:
1. Pitching change AND
2. Position swap to change batting order

**Purpose**: Avoid having the new pitcher bat soon

### 7.2 Example

```
Before Double Switch:
#8 batter: RF Johnson (just made out)
#9 batter: P Smith (due up next inning)

Double Switch:
- Smith (P) OUT ‚Üí Chapman IN at P
- Johnson (RF) OUT ‚Üí Williams IN at RF

After Double Switch:
#8 batter: P Chapman (won't bat for a while)
#9 batter: RF Williams (takes Johnson's spot)
```

### 7.3 UI Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DOUBLE SWITCH                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  This is a pitching change PLUS batting order swap.             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  PITCHING CHANGE:                                               ‚îÇ
‚îÇ  OUT: Smith (P) - 4.1 IP, Pitch Count: [72]                     ‚îÇ
‚îÇ  IN:  [Select reliever ‚ñº]                                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  POSITION SWAP:                                                 ‚îÇ
‚îÇ  Player leaving: [Select position player ‚ñº]                     ‚îÇ
‚îÇ  Player entering: [Select bench player ‚ñº]                       ‚îÇ
‚îÇ  Position: [Select ‚ñº]                                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  BATTING ORDER RESULT:                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ #8: New Pitcher (was #9)                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ #9: New Position Player (was #8)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         [Cancel]                    [Confirm Double Switch]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.4 Data Captured

```typescript
interface DoubleSwitchEvent {
  eventType: 'DOUBLE_SWITCH';
  gameId: string;
  inning: number;
  halfInning: 'top' | 'bottom';

  // Pitching change component
  pitchingChange: PitchingChangeEvent;

  // Position swap component
  positionSwap: {
    playerOut: string;
    playerOutPosition: Position;
    playerOutBattingOrder: number;

    playerIn: string;
    playerInPosition: Position;
    playerInBattingOrder: number;  // Takes pitcher's old spot
  };

  // New batting order spots
  newPitcherBattingOrder: number;
  newPositionPlayerBattingOrder: number;
}
```

---

## 8. Data Schema

### 8.1 Master Substitution Record

```typescript
interface GameSubstitutions {
  gameId: string;

  // All substitutions in order
  events: (
    | PinchHitterEvent
    | PinchRunnerEvent
    | DefensiveSubEvent
    | PitchingChangeEvent
    | DoubleSwitchEvent
  )[];

  // Current game state (updated after each sub)
  currentLineup: {
    battingOrder: number;  // 1-9
    playerId: string;
    playerName: string;
    position: Position;
    enteredGame: number;   // Inning entered
    enteredFor: string;    // Who they replaced
  }[];

  // Players no longer in game
  exitedPlayers: {
    playerId: string;
    playerName: string;
    exitedInning: number;
    exitedFor: string;     // Who replaced them
    finalPosition: Position;
  }[];
}
```

### 8.2 Lineup State Tracking

```typescript
interface LineupState {
  // Current 9-player lineup
  lineup: LineupSpot[];

  // Available bench players
  bench: BenchPlayer[];

  // Already used (can't re-enter)
  usedPlayers: string[];
}

interface LineupSpot {
  order: number;           // 1-9
  currentPlayer: string;
  position: Position;
  originalPlayer: string;  // Who started in this spot
}

interface BenchPlayer {
  playerId: string;
  playerName: string;
  positions: Position[];   // Positions they can play
  isAvailable: boolean;    // Not yet used
}
```

---

## 9. UI Flows

### 9.1 Substitution Entry Point

From main tracking screen, user can access substitutions via:
1. "Substitution" button (always visible)
2. Long-press on a player
3. Before recording a plate appearance

### 9.2 Quick Sub vs Full Sub

**Quick Sub** (common case):
- Pitching change only
- PH for pitcher spot

**Full Sub** (complex case):
- Double switch
- Multiple defensive changes
- Mid-inning position swaps

### 9.3 Visual Lineup Editor

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LINEUP EDITOR                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Batting Order:                   Field Positions:              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ 1. CF Smith      [Edit] ‚îÇ      ‚îÇ     LF    CF    RF  ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ 2. 2B Johnson    [Edit] ‚îÇ      ‚îÇ       SS    2B      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ 3. 1B Martinez   [Edit] ‚îÇ      ‚îÇ  3B           1B    ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ 4. RF Wilson     [Edit] ‚îÇ      ‚îÇ         P           ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ 5. LF Brown      [Edit] ‚îÇ      ‚îÇ         C           ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ 6. 3B Davis      [Edit] ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ  ‚îÇ 7. SS Garcia     [Edit] ‚îÇ                                    ‚îÇ
‚îÇ  ‚îÇ 8. C Thompson    [Edit] ‚îÇ      Bench:                        ‚îÇ
‚îÇ  ‚îÇ 9. P Cole        [Edit] ‚îÇ      Parker (OF), Lee (IF),        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      Adams (C), Powers (P)         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Tap [Edit] to substitute, or drag to swap positions            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 10. Validation Rules

### 10.1 Substitution Constraints

```typescript
const SUBSTITUTION_RULES = {
  // Player can only enter once per game
  noReEntry: true,

  // Must have 9 players in lineup at all times
  minLineupSize: 9,
  maxLineupSize: 9,

  // Can't substitute during live ball
  requireDeadBall: true,

  // Pinch hitter must bat before defensive assignment
  phMustBat: true,
};

function validateSubstitution(sub, gameState) {
  const errors = [];

  // Check player hasn't already played
  if (gameState.usedPlayers.includes(sub.playerIn)) {
    errors.push(`${sub.playerInName} has already been used in this game`);
  }

  // Check player is on bench
  if (!gameState.bench.find(p => p.playerId === sub.playerIn)) {
    errors.push(`${sub.playerInName} is not available on bench`);
  }

  // For pitching change, ensure pitch count captured
  if (sub.eventType === 'PITCHING_CHANGE' && !sub.outgoingPitchCount) {
    errors.push('Pitch count required before confirming pitching change');
  }

  return errors;
}
```

### 10.2 Lineup Integrity Checks

```typescript
function validateLineup(lineup) {
  const errors = [];

  // Must have exactly 9 players
  if (lineup.length !== 9) {
    errors.push(`Lineup has ${lineup.length} players, must have 9`);
  }

  // Must have exactly 9 positions filled
  const positions = lineup.map(l => l.position);
  const requiredPositions = ['P', 'C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF'];

  for (const pos of requiredPositions) {
    if (!positions.includes(pos)) {
      errors.push(`No player at ${pos}`);
    }
  }

  // No duplicate batting order numbers
  const orders = lineup.map(l => l.order);
  const uniqueOrders = new Set(orders);
  if (uniqueOrders.size !== 9) {
    errors.push('Duplicate batting order positions');
  }

  return errors;
}
```

---

## Appendix: Common Substitution Patterns

### Pattern 1: Late-Game Pitching Change
```
Situation: 8th inning, protecting lead
Action: Bring in setup man for starter
Steps:
1. Record pitch count for starter
2. Select reliever
3. Note inherited runners (if any)
```

### Pattern 2: Pinch Hit for Pitcher
```
Situation: Pitcher spot due up, need offense
Action: PH for pitcher, then pitching change
Steps:
1. Record PH for pitcher's spot
2. After AB, record pitching change
3. PH takes a defensive position
```

### Pattern 3: Double Switch to Avoid Quick AB
```
Situation: Pitcher just batted, want fresh arm
Action: Bring in reliever at different lineup spot
Steps:
1. Select "Double Switch" option
2. Choose reliever and their new batting spot
3. Choose position player to swap with
```

### Pattern 4: Late-Inning Defensive Replacement
```
Situation: Leading late, upgrade defense
Action: Sub in better defender for bat-first player
Steps:
1. Select "Defensive Sub"
2. Choose player out (weak defender)
3. Choose player in (defensive specialist)
4. Confirm position
```

---

*Last Updated: January 22, 2026*
*Version: 1.0 - Initial substitution flow specification*
~~~

## All Acceptance Criteria (Exact Source Text)

### Source File: specs/ralph/ACCEPTANCE_CRITERIA.md

~~~markdown
# KBL Tracker - Acceptance Criteria

> **Purpose**: Objectively verifiable acceptance criteria for all user stories
> **Generated**: January 26, 2026
> **Rule**: NO subjective language - all criteria must be verifiable by someone unfamiliar with the project

---

## Phase 1: Foundation & Bug Fixes

### Acceptance Criteria for S-001: Install Tailwind CSS ‚úÖ VERIFIED

**AC-1: Tailwind Dependencies Installed** ‚úÖ PASS
- **Given:** The project with current package.json
- **When:** Run `npm install -D tailwindcss postcss autoprefixer`
- **Then:** package.json devDependencies contains tailwindcss, postcss, and autoprefixer
- **Verified:** January 26, 2026 - Dependencies installed

**AC-2: Tailwind Config Created** ‚úÖ PASS
- **Given:** Tailwind dependencies installed
- **When:** Run `npx tailwindcss init -p`
- **Then:** Files `tailwind.config.js` and `postcss.config.js` exist in project root
- **Verified:** January 26, 2026 - Config files created

**AC-3: Build Completes Successfully** ‚úÖ PASS
- **Given:** Tailwind configured with content paths `./src/**/*.{js,ts,jsx,tsx}`
- **When:** Run `npm run build`
- **Then:** Build exits with code 0, no errors in output
- **Verified:** January 26, 2026 - Tailwind directives added to src/index.css

---

### Acceptance Criteria for S-002: Wire Team Names to Scoreboard

**AC-1: Away Team Name Displays**
- **Given:** GameTracker loads with teams "Sirloins" vs "Beewolves"
- **When:** User views the scoreboard area
- **Then:** Text "Sirloins" is visible in the scoreboard
- **Verify:** Open dev tools, inspect scoreboard, find text node containing "Sirloins"

**AC-2: Home Team Name Displays**
- **Given:** GameTracker loads with teams "Sirloins" vs "Beewolves"
- **When:** User views the scoreboard area
- **Then:** Text "Beewolves" is visible in the scoreboard
- **Verify:** Open dev tools, inspect scoreboard, find text node containing "Beewolves"

**AC-3: Team Names Position Correctly**
- **Given:** Scoreboard displayed
- **When:** User views team names
- **Then:** Away team name appears on left/above, home team name appears on right/below (matching score positions)
- **Verify:** Visual inspection confirms away team (left) and home team (right) alignment with scores

---

### Acceptance Criteria for S-003: Make Current Batter Name Clickable

**AC-1: Batter Name Has Cursor Pointer**
- **Given:** GameTracker loaded with a batter at plate
- **When:** User hovers mouse over current batter's name
- **Then:** Cursor changes to pointer (hand icon)
- **Verify:** Hover over batter name, observe cursor style change

**AC-2: Click Opens PlayerCard**
- **Given:** Current batter "Madoka Hayata" is displayed
- **When:** User clicks on "Madoka Hayata" text
- **Then:** A modal appears with title containing "Madoka Hayata"
- **Verify:** Click name, observe modal with player name in header

**AC-3: PlayerCard Shows Player Data**
- **Given:** PlayerCard modal opened for Madoka Hayata
- **When:** Modal is displayed
- **Then:** Modal shows at least: position (SS), batting side (R), and a stats section
- **Verify:** Read modal content, confirm position/batting info present

---

### Acceptance Criteria for S-004: Make Due-Up List Names Clickable

**AC-1: Due-Up Names Have Cursor Pointer**
- **Given:** GameTracker shows due-up list with multiple players
- **When:** User hovers over any player name in due-up list
- **Then:** Cursor changes to pointer
- **Verify:** Hover over each due-up name, confirm cursor change on all

**AC-2: Click Opens Correct PlayerCard**
- **Given:** Due-up list shows "Damien Rush" as second batter
- **When:** User clicks on "Damien Rush"
- **Then:** PlayerCard modal opens showing "Damien Rush" data
- **Verify:** Click second due-up name, confirm modal shows that specific player

**AC-3: Multiple Players Accessible**
- **Given:** Due-up list shows 4 players
- **When:** User clicks each name in sequence (closing modal between)
- **Then:** Each click opens correct PlayerCard for that player
- **Verify:** Click all 4, confirm each shows different correct player

---

### Acceptance Criteria for S-005: Add Undo Button to UI

**AC-1: Undo Button Visible**
- **Given:** GameTracker loaded
- **When:** User views the UI
- **Then:** A button labeled "Undo" or with undo icon (‚Ü∂) is visible
- **Verify:** Visual scan of UI finds undo button

**AC-2: Undo Button Initially Disabled**
- **Given:** Fresh game started, no actions taken
- **When:** User views undo button
- **Then:** Button appears disabled (grayed out, opacity reduced, or `disabled` attribute)
- **Verify:** Inspect button element, confirm disabled state or visual indicator

**AC-3: Undo Button Enables After Action**
- **Given:** User records a hit (e.g., click "1B", confirm in modal)
- **When:** At-bat completes and next batter shown
- **Then:** Undo button is now enabled (full opacity, clickable)
- **Verify:** Click undo button, confirm it responds (action undoes)

---

## Phase 2: Lineup & Display Components

### Acceptance Criteria for S-006: Create Lineup View Button

**AC-1: Lineup Button Visible**
- **Given:** GameTracker loaded
- **When:** User views the substitution/control area
- **Then:** A button labeled "View Lineup" or "Lineup" is visible
- **Verify:** Find button with text containing "Lineup"

**AC-2: Button Responds to Click**
- **Given:** Lineup button visible
- **When:** User clicks the button
- **Then:** UI state changes (panel opens or state toggles)
- **Verify:** Click button, observe visual change

---

### Acceptance Criteria for S-007: Create Lineup Panel Structure

**AC-1: Panel Shows 9 Batting Positions**
- **Given:** Lineup panel opened
- **When:** User counts the player entries
- **Then:** Exactly 9 rows/entries are displayed (1-9 batting order)
- **Verify:** Count visible player entries, confirm 9 total

**AC-2: Each Entry Shows Player Name**
- **Given:** Lineup panel with 9 entries
- **When:** User reads each entry
- **Then:** Each shows a player name (text is not empty or "undefined")
- **Verify:** Read each entry, confirm non-empty player names

**AC-3: Each Entry Shows Defensive Position**
- **Given:** Lineup panel with 9 entries
- **When:** User reads each entry
- **Then:** Each shows a defensive position abbreviation (P, C, 1B, 2B, 3B, SS, LF, CF, RF, or DH)
- **Verify:** Read each entry, confirm valid position abbreviation present

---

### Acceptance Criteria for S-008: Add Mojo Indicators to Lineup Panel

**AC-1: Mojo Indicator Present**
- **Given:** Lineup panel open
- **When:** User views any player entry
- **Then:** A mojo indicator (badge, icon, or number) is visible next to name
- **Verify:** Inspect entry, find mojo element

**AC-2: Indicator Uses Color Coding**
- **Given:** Player with mojo = +2 (Jacked)
- **When:** User views that player's entry
- **Then:** Mojo indicator has blue/green coloring (not gray/red)
- **Verify:** Compare indicator color to expected color scheme

**AC-3: Mojo Range Represented**
- **Given:** Lineup with various mojo levels
- **When:** User views indicators
- **Then:** Different mojo levels show different colors (-2=red, -1=orange, 0=gray, +1=green, +2=blue)
- **Verify:** If testable, set different mojos and observe color variation

---

### Acceptance Criteria for S-009: Add Fitness Indicators to Lineup Panel

**AC-1: Fitness Indicator Present**
- **Given:** Lineup panel open
- **When:** User views any player entry
- **Then:** A fitness indicator is visible (distinct from mojo indicator)
- **Verify:** Inspect entry, find second indicator element

**AC-2: Fitness States Represented**
- **Given:** Fitness indicator displayed
- **When:** User hovers or views the indicator
- **Then:** Indicator shows/represents one of: Hurt, Weak, Strained, Well, Fit, Juiced
- **Verify:** Tooltip or visual matches one of 6 defined states

---

### Acceptance Criteria for S-010: Display Pitch Count in UI

**AC-1: Pitch Count Visible**
- **Given:** Game in progress with pitches thrown
- **When:** User views pitcher info area or scoreboard
- **Then:** A number is displayed labeled "Pitches:" or "PC:"
- **Verify:** Find text containing pitch count value

**AC-2: Pitch Count Updates**
- **Given:** Pitch count shows 15
- **When:** User records another at-bat (e.g., strikeout requiring 3+ pitches)
- **Then:** Pitch count increases to 18 or more
- **Verify:** Record at-bat, observe pitch count increase

---

### Acceptance Criteria for S-011: Wire Career Display Button

**AC-1: Career Button Visible**
- **Given:** GameTracker or main app loaded
- **When:** User looks for navigation options
- **Then:** A button/tab labeled "Career" or "Career Stats" is visible
- **Verify:** Find career access button

**AC-2: Button Opens Career Display**
- **Given:** Career button exists
- **When:** User clicks the button
- **Then:** CareerDisplay component renders (shows career stats header)
- **Verify:** Click button, observe career leaderboard content

---

## Phase 3: Game Setup

### Acceptance Criteria for S-012: Create Game Setup Modal Shell

**AC-1: Modal Renders**
- **Given:** App loads before game started
- **When:** Game setup triggered
- **Then:** A modal overlay appears with visible container
- **Verify:** Modal element present in DOM, visible

**AC-2: Modal Has Close Option**
- **Given:** Game setup modal open
- **When:** User looks for close/cancel
- **Then:** An X button or "Cancel" button is present
- **Verify:** Find close/cancel element

**AC-3: Start Game Button Present**
- **Given:** Game setup modal open
- **When:** User views modal content
- **Then:** A "Start Game" button is visible (may be disabled)
- **Verify:** Find button with text "Start Game"

---

### Acceptance Criteria for S-013: Add Team Selection to Game Setup

**AC-1: Away Team Dropdown Exists**
- **Given:** Game setup modal open
- **When:** User views the modal
- **Then:** A dropdown/select labeled "Away Team" exists with options
- **Verify:** Find select element, confirm it has team options

**AC-2: Home Team Dropdown Exists**
- **Given:** Game setup modal open
- **When:** User views the modal
- **Then:** A dropdown/select labeled "Home Team" exists with options
- **Verify:** Find select element, confirm it has team options

**AC-3: Team Options Include Database Teams**
- **Given:** Team dropdowns present
- **When:** User opens a dropdown
- **Then:** Options include "Sirloins" and "Beewolves"
- **Verify:** Click dropdown, verify team names in options

---

### Acceptance Criteria for S-014: Add Starting Pitcher Selection to Game Setup

**AC-1: Pitcher Selector Appears After Team Selection**
- **Given:** Away team "Sirloins" selected
- **When:** Selection confirmed
- **Then:** A pitcher dropdown for Sirloins appears with rotation pitchers
- **Verify:** Select team, observe pitcher dropdown appears

**AC-2: Pitcher Options Are From Team Rotation**
- **Given:** Sirloins pitcher dropdown open
- **When:** User views options
- **Then:** Options include "Hurley Bender" (S-grade starter from database)
- **Verify:** Click dropdown, find Hurley Bender in options

**AC-3: Both Teams Have Pitcher Selection**
- **Given:** Both teams selected
- **When:** User views modal
- **Then:** Both away and home have pitcher dropdown
- **Verify:** Confirm two pitcher selectors visible

---

### Acceptance Criteria for S-015: Wire Game Setup to GameTracker

**AC-1: Start Game Uses Selected Teams**
- **Given:** Away team "Beewolves", Home team "Sirloins" selected
- **When:** User clicks "Start Game"
- **Then:** Scoreboard shows "Beewolves @ Sirloins"
- **Verify:** Observe scoreboard team names match selections

**AC-2: Selected Pitcher Is Starting**
- **Given:** Hurley Bender selected as Sirloins starter
- **When:** Game starts and Sirloins are home team batting first
- **Then:** Current pitcher shown is Hurley Bender
- **Verify:** Check pitcher display matches selection (when applicable)

**AC-3: Modal Closes After Start**
- **Given:** Game setup complete
- **When:** User clicks "Start Game"
- **Then:** Modal disappears, game view is shown
- **Verify:** Modal element no longer visible, game UI active

---

## Phase 4: Bug Fixes

### Acceptance Criteria for S-016: Fix Exit Type Double Entry

**AC-1: Single Click Flow**
- **Given:** At-bat in progress
- **When:** User clicks result button (e.g., "GO")
- **Then:** Flow proceeds without requiring a second click for exit type
- **Verify:** Click GO once, observe modal or next step without redundant click

**AC-2: Exit Type Selected In Modal**
- **Given:** Result selected and modal open
- **When:** User views fielding modal
- **Then:** Exit type options are available within the modal (not separate popup)
- **Verify:** Modal contains exit type selection inline

**AC-3: Flow Completes Without Extra Steps**
- **Given:** GO selected, exit type selected, fielder confirmed
- **When:** User clicks confirm
- **Then:** At-bat records and next batter appears without extra prompts
- **Verify:** Count clicks from GO to completion - should be ‚â§3 clicks

---

## Phase 5: Summaries & Enhancements

### Acceptance Criteria for S-017: Create Inning End Summary Modal Shell

**AC-1: Modal Appears on Inning End**
- **Given:** Bottom of 1st with 2 outs
- **When:** Third out recorded
- **Then:** A summary modal appears
- **Verify:** Record third out, observe modal popup

**AC-2: Modal Auto-Dismisses**
- **Given:** Inning summary modal showing
- **When:** User waits 3-4 seconds
- **Then:** Modal disappears automatically
- **Verify:** Time the display, confirm auto-dismiss at ~3 seconds

**AC-3: Modal Dismissible by Click**
- **Given:** Inning summary modal showing
- **When:** User clicks anywhere on modal or background
- **Then:** Modal closes immediately
- **Verify:** Click modal, confirm immediate close

---

### Acceptance Criteria for S-018: Add Stats to Inning End Summary

**AC-1: Runs Displayed**
- **Given:** Inning where 2 runs scored
- **When:** Inning ends and summary shows
- **Then:** Summary shows "Runs: 2" or "2 R"
- **Verify:** Score 2 runs, end inning, read summary

**AC-2: Hits Displayed**
- **Given:** Inning with 3 hits
- **When:** Summary shows
- **Then:** Summary shows "Hits: 3" or "3 H"
- **Verify:** Record 3 hits, end inning, read summary

**AC-3: LOB Displayed**
- **Given:** Inning ends with runner on second
- **When:** Summary shows
- **Then:** Summary shows "LOB: 1" or "1 LOB"
- **Verify:** Leave runner on base, end inning, read summary

---

### Acceptance Criteria for S-019: Add Mojo Badge to Current Batter

**AC-1: Badge Visible Next to Batter Name**
- **Given:** Current batter displayed
- **When:** User views batter area
- **Then:** A colored badge/icon appears adjacent to batter name
- **Verify:** Find visual element next to name text

**AC-2: Badge Color Matches Mojo State**
- **Given:** Batter with Jacked mojo (+2)
- **When:** User views badge
- **Then:** Badge color is blue/bright green (not red/orange/gray)
- **Verify:** Compare badge color to expected scheme

---

### Acceptance Criteria for S-020: Add Fitness Badge to Current Pitcher

**AC-1: Badge Visible in Pitcher Info**
- **Given:** Pitcher displayed
- **When:** User views pitcher area
- **Then:** A fitness indicator badge is visible
- **Verify:** Find fitness element in pitcher display

**AC-2: Badge Near Pitch Count**
- **Given:** Pitch count and fitness badge displayed
- **When:** User views pitcher area
- **Then:** Fitness badge is within 100 pixels of pitch count display
- **Verify:** Visual proximity check or inspector measurement

---

## Phase 6: Double Switch

### Acceptance Criteria for S-021: Create Double Switch Button

**AC-1: Button Visible in Substitution Area**
- **Given:** GameTracker loaded (NL rules / no DH)
- **When:** User views substitution buttons
- **Then:** "Double Switch" button is visible
- **Verify:** Find button with text "Double Switch"

**AC-2: Button Opens Modal**
- **Given:** Double Switch button visible
- **When:** User clicks button
- **Then:** A modal appears with double switch options
- **Verify:** Click button, observe modal

---

### Acceptance Criteria for S-022: Create Double Switch Modal Structure

**AC-1: Pitcher Selection Present**
- **Given:** Double switch modal open
- **When:** User views modal
- **Then:** A dropdown to select incoming pitcher exists
- **Verify:** Find pitcher selector element

**AC-2: Position Player Selection Present**
- **Given:** Double switch modal open
- **When:** User views modal
- **Then:** A dropdown to select incoming position player exists
- **Verify:** Find position player selector element

**AC-3: Batting Order Position Selectable**
- **Given:** Players selected
- **When:** User views modal
- **Then:** Batting position options (1-9) are available for each incoming player
- **Verify:** Find batting order selectors

---

### Acceptance Criteria for S-023: Implement Double Switch Logic

**AC-1: Pitcher Takes Selected Batting Position**
- **Given:** Pitcher enters at batting position 8
- **When:** Double switch confirmed
- **Then:** Lineup shows new pitcher batting 8th
- **Verify:** Check lineup panel, confirm pitcher at position 8

**AC-2: Position Player Takes Exiting Player's Position**
- **Given:** Position player enters for catcher who batted 8th
- **When:** Double switch confirmed
- **Then:** New position player has C defensive position
- **Verify:** Check lineup panel, confirm position player at C

**AC-3: All 9 Positions Still Filled**
- **Given:** Double switch completed
- **When:** User views defensive alignment
- **Then:** Exactly 9 defensive positions are filled (P, C, 1B, 2B, 3B, SS, LF, CF, RF)
- **Verify:** Count positions in lineup, confirm 9 unique positions

---

## Criteria Quality Summary

| Story | Criteria Count | All Objective | All Verifiable |
|-------|----------------|---------------|----------------|
| S-001 | 3 | ‚úÖ | ‚úÖ |
| S-002 | 3 | ‚úÖ | ‚úÖ |
| S-003 | 3 | ‚úÖ | ‚úÖ |
| S-004 | 3 | ‚úÖ | ‚úÖ |
| S-005 | 3 | ‚úÖ | ‚úÖ |
| S-006 | 2 | ‚úÖ | ‚úÖ |
| S-007 | 3 | ‚úÖ | ‚úÖ |
| S-008 | 3 | ‚úÖ | ‚úÖ |
| S-009 | 2 | ‚úÖ | ‚úÖ |
| S-010 | 2 | ‚úÖ | ‚úÖ |
| S-011 | 2 | ‚úÖ | ‚úÖ |
| S-012 | 3 | ‚úÖ | ‚úÖ |
| S-013 | 3 | ‚úÖ | ‚úÖ |
| S-014 | 3 | ‚úÖ | ‚úÖ |
| S-015 | 3 | ‚úÖ | ‚úÖ |
| S-016 | 3 | ‚úÖ | ‚úÖ |
| S-017 | 3 | ‚úÖ | ‚úÖ |
| S-018 | 3 | ‚úÖ | ‚úÖ |
| S-019 | 2 | ‚úÖ | ‚úÖ |
| S-020 | 2 | ‚úÖ | ‚úÖ |
| S-021 | 2 | ‚úÖ | ‚úÖ |
| S-022 | 3 | ‚úÖ | ‚úÖ |
| S-023 | 3 | ‚úÖ | ‚úÖ |

**Total Criteria:** 62
**Criteria per Story Average:** 2.7

---

*All criteria use specific, measurable language with exact verification steps. No subjective terms like "looks good", "works well", or "properly" are used.*
~~~

### Source File: specs/ralph/STORIES_PHASE_B.md

~~~markdown
# KBL Tracker - Phase B User Stories: Core Game Loop

> **Purpose**: User stories for Pre-Game, Post-Game, and Game Flow features
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE B: CORE GAME LOOP

---

## S-B001: Create PreGameScreen Component

**Parent Feature:** F-B001
**Priority:** P0
**Estimated Size:** Large

**As a** user starting a game
**I want to** see a pre-game screen with matchup info
**So that** I have context before the game begins

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Shows Matchup**
- **Given:** Game setup complete with Sirloins vs Beewolves
- **When:** PreGameScreen renders
- **Then:** "Sirloins @ Beewolves" or similar visible
- **Verify:** Find both team names on screen

**AC-2: Shows Stadium**
- **Given:** Stadium selected as "Emerald Diamond"
- **When:** PreGameScreen displays
- **Then:** Stadium name visible
- **Verify:** Find "Emerald Diamond" text

**AC-3: Start Button Works**
- **Given:** PreGameScreen displayed
- **When:** User clicks "Start Game"
- **Then:** Navigation to game view occurs
- **Verify:** Click, confirm URL change to /game

### Technical Notes
- New file: `src/pages/PreGameScreen.tsx`
- Pull data from game setup context

---

## S-B002: Add Starting Pitchers to PreGame

**Parent Feature:** F-B001
**Priority:** P0
**Estimated Size:** Medium

**As a** user viewing pre-game
**I want to** see starting pitchers with stats
**So that** I know the pitching matchup

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Away Starter Shown**
- **Given:** Hurley Bender selected as away starter
- **When:** PreGameScreen displays
- **Then:** "Hurley Bender" with W-L and ERA visible
- **Verify:** Find pitcher name and stats

**AC-2: Home Starter Shown**
- **Given:** Sakda Sanoh selected as home starter
- **When:** PreGameScreen displays
- **Then:** "Sakda Sanoh" with W-L and ERA visible
- **Verify:** Find pitcher name and stats

**AC-3: Side-by-Side Display**
- **Given:** Both pitchers displayed
- **When:** User views layout
- **Then:** Pitchers displayed in comparison format (left/right or columns)
- **Verify:** Visual layout shows comparison

### Technical Notes
- Pull pitcher stats from seasonStats or careerStats
- Handle 0-0 record for new season

---

## S-B003: Create GameSetupModal Component

**Parent Feature:** F-B002
**Priority:** P0
**Estimated Size:** Large

**As a** user starting a new game
**I want to** configure the matchup
**So that** I play with the correct teams

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Modal Renders**
- **Given:** "New Game" clicked
- **When:** Modal opens
- **Then:** GameSetupModal visible with team dropdowns
- **Verify:** Find modal with team selection UI

**AC-2: Away Team Selection**
- **Given:** Modal open
- **When:** User clicks away team dropdown
- **Then:** All teams in league listed
- **Verify:** Open dropdown, count team options

**AC-3: Home Team Selection**
- **Given:** Modal open
- **When:** User clicks home team dropdown
- **Then:** All teams in league listed
- **Verify:** Open dropdown, count team options

### Technical Notes
- New file: `src/components/GameSetupModal.tsx`
- Pull teams from league config or playerDatabase

---

## S-B004: Add Pitcher Selection to GameSetup

**Parent Feature:** F-B002
**Priority:** P0
**Estimated Size:** Medium

**As a** user setting up a game
**I want to** select starting pitchers
**So that** I have the right matchup

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Pitcher Dropdowns Appear**
- **Given:** Both teams selected
- **When:** User views modal
- **Then:** Pitcher dropdown for each team visible
- **Verify:** Find two pitcher selectors

**AC-2: Shows Team's Pitchers**
- **Given:** Sirloins selected as away team
- **When:** User opens away pitcher dropdown
- **Then:** Sirloins rotation pitchers listed
- **Verify:** Find known Sirloins pitcher names

**AC-3: Start Requires Pitchers**
- **Given:** Teams selected but no pitchers
- **When:** User tries to start game
- **Then:** Error or disabled state prevents start
- **Verify:** Try start without pitchers, confirm blocked

### Technical Notes
- Filter to ROTATION role from team roster
- Default to first starter in rotation

---

## S-B005: Add Stadium Selection to GameSetup

**Parent Feature:** F-B003
**Priority:** P1
**Estimated Size:** Medium

**As a** user setting up a game
**I want to** select the stadium
**So that** park factors apply correctly

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Stadium Dropdown Exists**
- **Given:** GameSetupModal open
- **When:** User views form
- **Then:** Stadium dropdown present
- **Verify:** Find stadium selector

**AC-2: Defaults to Home Team Stadium**
- **Given:** Beewolves selected as home team
- **When:** Stadium dropdown checked
- **Then:** Beewolves' home stadium pre-selected
- **Verify:** Confirm default matches home team

**AC-3: Selection Saved**
- **Given:** User selects "Emerald Diamond"
- **When:** Game starts
- **Then:** Game record has stadium = "Emerald Diamond"
- **Verify:** Check game data in storage

### Technical Notes
- Need stadium database with team associations
- Per STADIUM_ANALYTICS_SPEC.md

---

## S-B006: Create PostGameScreen Component

**Parent Feature:** F-B004
**Priority:** P0
**Estimated Size:** Large

**As a** user completing a game
**I want to** see a comprehensive summary
**So that** I know what happened

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Final Score Displayed**
- **Given:** Game ended Sirloins 5, Beewolves 3
- **When:** PostGameScreen renders
- **Then:** "Sirloins 5 - Beewolves 3" or similar visible
- **Verify:** Find final score text

**AC-2: Winner Highlighted**
- **Given:** Sirloins won
- **When:** User views screen
- **Then:** "Sirloins Win!" or winning team emphasized
- **Verify:** Find winner indication

**AC-3: Continue Button Works**
- **Given:** PostGameScreen displayed
- **When:** User clicks "Continue"
- **Then:** Navigation to season dashboard occurs
- **Verify:** Click, confirm URL change

### Technical Notes
- New file: `src/pages/PostGameScreen.tsx`
- Archive game to seasonGames storage

---

## S-B007: Add Top Performers to PostGame

**Parent Feature:** F-B004
**Priority:** P0
**Estimated Size:** Medium

**As a** user viewing post-game summary
**I want to** see top performers
**So that** I know who had the best game

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Top Batters Shown**
- **Given:** Player A had 3-4 with 2 RBI
- **When:** PostGameScreen displays
- **Then:** Player A listed in top performers
- **Verify:** Find batter stats in performers section

**AC-2: Winning Pitcher Shown**
- **Given:** Pitcher earned the win
- **When:** PostGameScreen displays
- **Then:** Winning pitcher with "W" designation shown
- **Verify:** Find pitcher with win indicator

**AC-3: Save Shown If Applicable**
- **Given:** Reliever earned save
- **When:** PostGameScreen displays
- **Then:** Save pitcher with "S" designation shown
- **Verify:** Find save pitcher or confirm hidden if no save

### Technical Notes
- Calculate W/L/S per baseball rules
- Top batters by hits or RBI

---

## S-B008: Create Player of Game Display

**Parent Feature:** F-B005
**Priority:** P0
**Estimated Size:** Medium

**As a** user after a game
**I want to** see Player of the Game
**So that** I celebrate the standout performance

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: POG Displayed**
- **Given:** Game ended
- **When:** PostGameScreen renders
- **Then:** Player of the Game section with player name visible
- **Verify:** Find POG element with name

**AC-2: POG Stats Shown**
- **Given:** POG had 4-5, 3 RBI, HR
- **When:** POG section displays
- **Then:** Key stats that earned POG visible
- **Verify:** Find stat line in POG section

**AC-3: Fame Bonus Shown**
- **Given:** POG selection
- **When:** POG section displays
- **Then:** "+2 Fame" or similar bonus indicated
- **Verify:** Find fame bonus text

### Technical Notes
- POG calculation: highest WPA or stat combination
- Store with game record

---

## S-B009: Create BoxScoreView Component

**Parent Feature:** F-B006
**Priority:** P1
**Estimated Size:** Large

**As a** user wanting game details
**I want to** see a complete box score
**So that** I can review all player performances

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Batting Tables Present**
- **Given:** Game completed
- **When:** BoxScoreView renders
- **Then:** Batting table for each team visible
- **Verify:** Find two batting tables

**AC-2: Standard Columns**
- **Given:** Batting table displayed
- **When:** User views columns
- **Then:** AB, R, H, RBI, BB, K columns visible
- **Verify:** Find all 6 standard columns

**AC-3: Totals Row**
- **Given:** Batting table displayed
- **When:** User views bottom row
- **Then:** Team totals row present
- **Verify:** Find row with "Totals" or sum values

### Technical Notes
- New file: `src/components/BoxScoreView.tsx`
- Calculate from game event log

---

## S-B010: Add Pitching Box Score

**Parent Feature:** F-B006
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing box score
**I want to** see pitching stats
**So that** I can review pitching performances

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Pitching Table Present**
- **Given:** BoxScoreView open
- **When:** User scrolls to pitching
- **Then:** Pitching table for each team visible
- **Verify:** Find pitching tables

**AC-2: Pitching Columns**
- **Given:** Pitching table displayed
- **When:** User views columns
- **Then:** IP, H, R, ER, BB, K columns visible
- **Verify:** Find 6 pitching columns

**AC-3: Decision Noted**
- **Given:** Pitcher got the win
- **When:** User views that pitcher's row
- **Then:** "W" or win indicator shown
- **Verify:** Find decision indicator

### Technical Notes
- IP calculated as outs/3 (e.g., 5.1 = 5 innings + 1 out)
- W/L/S indicators

---

## S-B011: Create InningEndSummary Component

**Parent Feature:** F-B007
**Priority:** P1
**Estimated Size:** Medium

**As a** user during a game
**I want to** see a summary at inning end
**So that** I track the game flow

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Appears on Inning Flip**
- **Given:** Bottom of 1st, 2 outs
- **When:** Third out recorded
- **Then:** Summary modal appears
- **Verify:** Record out, see modal

**AC-2: Shows Half-Inning Stats**
- **Given:** Inning had 2 runs, 3 hits, 1 LOB
- **When:** Summary displays
- **Then:** "2R 3H 1LOB" or similar shown
- **Verify:** Read stats in modal

**AC-3: Auto-Dismisses**
- **Given:** Summary showing
- **When:** User waits 3 seconds
- **Then:** Modal disappears
- **Verify:** Time display, confirm auto-close

### Technical Notes
- New file: `src/components/GameTracker/InningEndSummary.tsx`
- Track half-inning stats separately

---

## S-B012: Create PitcherExitPrompt Component

**Parent Feature:** F-B008
**Priority:** P1
**Estimated Size:** Medium

**As a** manager
**I want to** be prompted about tired pitchers
**So that** I consider pitching changes

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Triggers at 100 Pitches**
- **Given:** Pitcher at 100 pitches
- **When:** Next at-bat starts
- **Then:** Prompt appears asking about pitcher change
- **Verify:** Track pitch count, confirm prompt at 100

**AC-2: Keep In Option**
- **Given:** Prompt displayed
- **When:** User clicks "Keep In"
- **Then:** Prompt closes, no change made
- **Verify:** Click keep, confirm game continues

**AC-3: Change Pitcher Option**
- **Given:** Prompt displayed
- **When:** User clicks "Change Pitcher"
- **Then:** Substitution modal opens
- **Verify:** Click change, see pitching change UI

### Technical Notes
- Configurable threshold (default 100)
- Non-blocking - can be ignored

---

## S-B013: Create DoubleSwitchModal Component

**Parent Feature:** F-B009
**Priority:** P1
**Estimated Size:** Large

**As a** manager (NL rules)
**I want to** execute a double switch
**So that** I optimize batting order with pitcher change

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Pitcher Selection**
- **Given:** DoubleSwitchModal open
- **When:** User views modal
- **Then:** Bullpen pitchers selectable
- **Verify:** Find pitcher dropdown/list

**AC-2: Position Player Selection**
- **Given:** DoubleSwitchModal open
- **When:** User views modal
- **Then:** Bench position players selectable
- **Verify:** Find position player dropdown/list

**AC-3: Batting Position Selection**
- **Given:** Both players selected
- **When:** User views modal
- **Then:** Batting order position (1-9) selectable for each
- **Verify:** Find batting position inputs

### Technical Notes
- New file: `src/components/GameTracker/DoubleSwitchModal.tsx`
- Per SUBSTITUTION_FLOW_SPEC.md

---

## S-B014: Implement Double Switch Logic

**Parent Feature:** F-B009
**Priority:** P1
**Estimated Size:** Medium

**As a** manager completing double switch
**I want to** batting order correctly updated
**So that** my lineup reflects the change

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Pitcher at Selected Spot**
- **Given:** Pitcher enters at batting position 8
- **When:** Double switch confirmed
- **Then:** Lineup shows pitcher batting 8th
- **Verify:** Check lineup panel

**AC-2: Position Player Swapped**
- **Given:** Position player enters
- **When:** Double switch confirmed
- **Then:** New player takes outgoing player's defensive position
- **Verify:** Check defensive alignment

**AC-3: Nine Positions Valid**
- **Given:** Double switch complete
- **When:** User views lineup
- **Then:** Exactly 9 valid defensive positions
- **Verify:** Count positions, confirm all 9 unique

### Technical Notes
- Update lineupState correctly
- Validate no duplicate positions

---

## S-B015: Detect Walkoff Wins

**Parent Feature:** F-B010
**Priority:** P1
**Estimated Size:** Medium

**As a** user
**I want to** walkoffs automatically detected
**So that** they get special recognition

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Detects Walkoff Condition**
- **Given:** Bottom of 9th, home down by 1
- **When:** Home team scores 2 runs to win
- **Then:** Walkoff flag set to true
- **Verify:** Check game record for walkoff: true

**AC-2: Identifies Hero**
- **Given:** Walkoff HR by Madoka Hayata
- **When:** Walkoff recorded
- **Then:** Hayata marked as walkoff hero
- **Verify:** Check walkoffHero in game record

**AC-3: Extra Innings Supported**
- **Given:** Bottom of 11th, tie game
- **When:** Home team scores winning run
- **Then:** Still detected as walkoff
- **Verify:** Extra inning walkoff recognized

### Technical Notes
- Check: bottom of 9+, home team scores winning run
- Hero: player with game-winning RBI/run

---

## S-B016: Display Walkoff Celebration

**Parent Feature:** F-B010
**Priority:** P1
**Estimated Size:** Medium

**As a** user after a walkoff
**I want to** see a celebration screen
**So that** the moment feels special

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Walkoff Banner**
- **Given:** Walkoff detected
- **When:** Game ends
- **Then:** "WALKOFF!" banner displayed
- **Verify:** Find walkoff banner text

**AC-2: Hero Highlighted**
- **Given:** Walkoff hero identified
- **When:** Celebration shows
- **Then:** Hero name prominently displayed
- **Verify:** Find hero name in celebration

**AC-3: Fame Bonus Shown**
- **Given:** Walkoff celebrated
- **When:** User views celebration
- **Then:** Fame bonus (+3) indicated
- **Verify:** Find fame bonus text

### Technical Notes
- Display before normal post-game screen
- Transition to post-game after dismissal

---

## S-B017: Create FameEventToast Component

**Parent Feature:** F-B011
**Priority:** P1
**Estimated Size:** Medium

**As a** user during a game
**I want to** see Fame events as they happen
**So that** I know about notable moments

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Toast Appears on Event**
- **Given:** Player hits home run (Fame +1)
- **When:** At-bat completes
- **Then:** Toast with "HR! +1 Fame" or similar appears
- **Verify:** Record HR, see toast

**AC-2: Shows Event Details**
- **Given:** Toast displayed
- **When:** User reads toast
- **Then:** Event type and fame value visible
- **Verify:** Read toast content

**AC-3: Auto-Dismisses**
- **Given:** Toast showing
- **When:** 3 seconds pass
- **Then:** Toast disappears
- **Verify:** Time display, confirm auto-close

### Technical Notes
- New file: `src/components/GameTracker/FameEventToast.tsx`
- Queue multiple toasts if simultaneous

---

## S-B018: Generate Post-Game Headline

**Parent Feature:** F-B012
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing post-game
**I want to** see a generated headline
**So that** I get narrative context

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Headline Generated**
- **Given:** Game ended Sirloins 8, Beewolves 2
- **When:** PostGameScreen displays
- **Then:** Headline like "Sirloins Dominate Beewolves 8-2" shown
- **Verify:** Find headline text

**AC-2: Reporter Name Shown**
- **Given:** Headline displayed
- **When:** User views byline
- **Then:** Reporter name visible
- **Verify:** Find byline with name

**AC-3: Matches Game Outcome**
- **Given:** Close game (5-4)
- **When:** Headline generated
- **Then:** Headline reflects close nature
- **Verify:** Headline mentions "edge" or "squeak" not "dominate"

### Technical Notes
- Use narrativeEngine templates
- Select template based on margin

---

# PHASE B SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-B001 | PreGameScreen Component | P0 |
| S-B002 | Starting Pitchers in PreGame | P0 |
| S-B003 | GameSetupModal Component | P0 |
| S-B004 | Pitcher Selection in Setup | P0 |
| S-B005 | Stadium Selection | P1 |
| S-B006 | PostGameScreen Component | P0 |
| S-B007 | Top Performers in PostGame | P0 |
| S-B008 | Player of Game Display | P0 |
| S-B009 | BoxScoreView Component | P1 |
| S-B010 | Pitching Box Score | P1 |
| S-B011 | InningEndSummary | P1 |
| S-B012 | PitcherExitPrompt | P1 |
| S-B013 | DoubleSwitchModal | P1 |
| S-B014 | Double Switch Logic | P1 |
| S-B015 | Walkoff Detection | P1 |
| S-B016 | Walkoff Celebration | P1 |
| S-B017 | FameEventToast | P1 |
| S-B018 | Post-Game Headline | P1 |

**Total Phase B Stories:** 18
**P0 Stories:** 8
**P1 Stories:** 10

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/STORIES_PHASE_C.md

~~~markdown
# KBL Tracker - Phase C User Stories: Season Infrastructure

> **Purpose**: User stories for Standings, Schedule, Leaders, Roster, Team Stats
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE C: SEASON INFRASTRUCTURE

---

## S-C001: Create StandingsView Component

**Parent Feature:** F-C001
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** see full league standings
**So that** I know how all teams are performing

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Teams Listed**
- **Given:** 8 teams in league
- **When:** StandingsView renders
- **Then:** All 8 teams listed in standings
- **Verify:** Count team rows, confirm 8

**AC-2: W-L-PCT Columns**
- **Given:** Standings displayed
- **When:** User views table columns
- **Then:** Wins, Losses, PCT columns visible
- **Verify:** Find 3 record columns

**AC-3: Sorted By Winning %**
- **Given:** Team A is 30-10, Team B is 25-15
- **When:** Standings render
- **Then:** Team A appears above Team B
- **Verify:** Confirm descending sort by PCT

### Technical Notes
- New file: `src/components/StandingsView.tsx`
- Calculate from season game results

---

## S-C002: Add Games Back Column

**Parent Feature:** F-C001
**Priority:** P0
**Estimated Size:** Small

**As a** user viewing standings
**I want to** see games back from first place
**So that** I understand the race

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: GB Column Present**
- **Given:** Standings displayed
- **When:** User views columns
- **Then:** "GB" column visible
- **Verify:** Find GB column header

**AC-2: First Place Shows "-"**
- **Given:** Team in first place
- **When:** User views their GB
- **Then:** Shows "-" not "0"
- **Verify:** Find "-" in first place row

**AC-3: Calculation Correct**
- **Given:** Leader is 30-10, second place is 28-14
- **When:** GB calculated
- **Then:** Second place shows "3.0" GB
- **Verify:** Formula: ((30-28) + (14-10))/2 = 3

### Technical Notes
- GB = ((FirstWins - TeamWins) + (TeamLosses - FirstLosses)) / 2

---

## S-C003: Add Streak Column

**Parent Feature:** F-C001
**Priority:** P1
**Estimated Size:** Small

**As a** user viewing standings
**I want to** see win/loss streaks
**So that** I know who's hot or cold

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Streak Column Present**
- **Given:** Standings displayed
- **When:** User views columns
- **Then:** "Streak" column visible
- **Verify:** Find streak column

**AC-2: Format Correct**
- **Given:** Team won last 5 games
- **When:** User views streak
- **Then:** Shows "W5"
- **Verify:** Find "W5" text

**AC-3: Color Coded**
- **Given:** W5 streak vs L3 streak
- **When:** User views both
- **Then:** W5 is green, L3 is red
- **Verify:** Check text colors

### Technical Notes
- Calculate from recent game results
- Track consecutive W or L

---

## S-C004: Create ScheduleView Component

**Parent Feature:** F-C002
**Priority:** P1
**Estimated Size:** Large

**As a** user
**I want to** see the season schedule
**So that** I know what games to play

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Games Listed**
- **Given:** 48-game season schedule
- **When:** ScheduleView renders
- **Then:** 48 game rows visible
- **Verify:** Count or paginate through all

**AC-2: Past Games Show Score**
- **Given:** Game 1 was Sirloins 5, Beewolves 3
- **When:** User views Game 1 row
- **Then:** Score "5-3" visible
- **Verify:** Find score in completed game row

**AC-3: Future Games Show Matchup**
- **Given:** Game 20 not yet played
- **When:** User views Game 20 row
- **Then:** Shows "Sirloins @ Beewolves" (no score)
- **Verify:** Find matchup text, no score

### Technical Notes
- New file: `src/pages/ScheduleView.tsx`
- Generate schedule from league config

---

## S-C005: Add Team Filter to Schedule

**Parent Feature:** F-C002
**Priority:** P1
**Estimated Size:** Small

**As a** user viewing schedule
**I want to** filter by team
**So that** I see only my team's games

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Filter Dropdown Present**
- **Given:** ScheduleView displayed
- **When:** User views controls
- **Then:** Team filter dropdown visible
- **Verify:** Find team filter element

**AC-2: Filter Works**
- **Given:** "Sirloins" selected in filter
- **When:** Schedule updates
- **Then:** Only games with Sirloins shown
- **Verify:** Check all visible games include Sirloins

**AC-3: All Teams Option**
- **Given:** Filter active
- **When:** User selects "All Teams"
- **Then:** Full schedule displays again
- **Verify:** Count returns to full

### Technical Notes
- Default to user's selected team if set

---

## S-C006: Create LeagueLeadersView Component

**Parent Feature:** F-C003
**Priority:** P1
**Estimated Size:** Large

**As a** user
**I want to** see league leaders
**So that** I know the best performers

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Batting Leaders Section**
- **Given:** LeagueLeadersView renders
- **When:** User views page
- **Then:** Batting leaders for AVG, HR, RBI visible
- **Verify:** Find 3 batting categories

**AC-2: Pitching Leaders Section**
- **Given:** LeagueLeadersView renders
- **When:** User views page
- **Then:** Pitching leaders for ERA, W, K visible
- **Verify:** Find 3 pitching categories

**AC-3: Top 10 Per Category**
- **Given:** AVG leaders displayed
- **When:** User counts entries
- **Then:** Up to 10 players shown
- **Verify:** Count ‚â§ 10 entries

### Technical Notes
- New file: `src/pages/LeagueLeadersView.tsx`
- Apply qualification minimums

---

## S-C007: Add Qualification Rules

**Parent Feature:** F-C003
**Priority:** P1
**Estimated Size:** Small

**As a** user viewing leaders
**I want to** see only qualified players
**So that** stats are meaningful

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Batting Qualification Applied**
- **Given:** 20 games played, team
- **When:** AVG leaders calculated
- **Then:** Only players with 62+ PA qualify (3.1*20)
- **Verify:** Check minimum PA of listed players

**AC-2: Pitching Qualification Applied**
- **Given:** 20 games played
- **When:** ERA leaders calculated
- **Then:** Only pitchers with 20+ IP qualify (1*20)
- **Verify:** Check minimum IP of listed pitchers

**AC-3: "Q" Badge Shown**
- **Given:** Qualified player displayed
- **When:** User views row
- **Then:** Small "Q" badge or indicator visible
- **Verify:** Find qualification indicator

### Technical Notes
- Batting: 3.1 PA per team game
- Pitching: 1 IP per team game

---

## S-C008: Create SeasonProgressTracker Component

**Parent Feature:** F-C004
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** see season progress
**So that** I know where I am in the season

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Progress Bar Visible**
- **Given:** 20 of 48 games played
- **When:** Component renders
- **Then:** Progress bar at ~42% visible
- **Verify:** Find progress element showing ~42%

**AC-2: Games Count Shown**
- **Given:** 20 of 48 games played
- **When:** User views tracker
- **Then:** "20/48" or "Game 20 of 48" text shown
- **Verify:** Find game count text

**AC-3: Phase Indicator**
- **Given:** In regular season
- **When:** User views tracker
- **Then:** "Regular Season" phase shown
- **Verify:** Find phase text

### Technical Notes
- Phases: Regular Season, All-Star Break, Trade Deadline, Playoffs, Offseason

---

## S-C009: Create RosterView Component

**Parent Feature:** F-C005
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** see my team roster
**So that** I know all my players

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Players Listed**
- **Given:** Team has 22 players
- **When:** RosterView renders
- **Then:** All 22 players visible
- **Verify:** Count player rows

**AC-2: Position Shown**
- **Given:** Player Madoka Hayata is SS
- **When:** User views roster
- **Then:** "SS" shown for Hayata
- **Verify:** Find position abbreviation

**AC-3: Grouped By Type**
- **Given:** Roster displayed
- **When:** User views layout
- **Then:** Players grouped (Catchers, Infielders, Outfielders, Pitchers)
- **Verify:** Find group headers or sections

### Technical Notes
- New file: `src/pages/RosterView.tsx`
- 22-man roster per SMB4

---

## S-C010: Add Stats to Roster View

**Parent Feature:** F-C005
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing roster
**I want to** see key stats per player
**So that** I know how they're performing

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Batter Stats Shown**
- **Given:** Batter on roster
- **When:** User views row
- **Then:** AVG, HR, RBI visible
- **Verify:** Find 3 batting stat columns

**AC-2: Pitcher Stats Shown**
- **Given:** Pitcher on roster
- **When:** User views row
- **Then:** W-L, ERA visible
- **Verify:** Find pitching stats

**AC-3: Click Opens PlayerCard**
- **Given:** Roster row displayed
- **When:** User clicks row
- **Then:** PlayerCard modal opens
- **Verify:** Click row, see modal

### Technical Notes
- Pull from seasonStats aggregation

---

## S-C011: Create TeamStatsView Component

**Parent Feature:** F-C006
**Priority:** P1
**Estimated Size:** Medium

**As a** user
**I want to** see team aggregate statistics
**So that** I know overall team performance

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Team Batting Totals**
- **Given:** TeamStatsView renders
- **When:** User views batting section
- **Then:** R, H, HR, AVG totals visible
- **Verify:** Find team batting aggregate

**AC-2: Team Pitching Totals**
- **Given:** TeamStatsView renders
- **When:** User views pitching section
- **Then:** ERA, WHIP, K totals visible
- **Verify:** Find team pitching aggregate

**AC-3: League Rank Shown**
- **Given:** Team batting stats displayed
- **When:** User views each stat
- **Then:** League rank (e.g., "3rd in HR") indicated
- **Verify:** Find rank indicators

### Technical Notes
- New file: `src/components/TeamStatsView.tsx`
- Calculate by summing player stats

---

## S-C012: Create TeamFinancialsView Component

**Parent Feature:** F-C007
**Priority:** P1
**Estimated Size:** Large

**As a** user
**I want to** see team financial overview
**So that** I understand salary situation

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Total Payroll Shown**
- **Given:** Team payroll is $50M
- **When:** TeamFinancialsView renders
- **Then:** "$50,000,000" or "50M" visible
- **Verify:** Find payroll total

**AC-2: Cap Space Shown**
- **Given:** Cap is $80M, payroll is $50M
- **When:** User views finances
- **Then:** "$30,000,000 available" or similar shown
- **Verify:** Find cap space amount

**AC-3: Top Salaries Listed**
- **Given:** Financials displayed
- **When:** User views detail
- **Then:** Top 5 highest-paid players listed
- **Verify:** Find 5 player salaries

### Technical Notes
- Per SALARY_SYSTEM_SPEC.md
- Requires player ratings (S-A009)

---

## S-C013: Create FanMoralePanel Component

**Parent Feature:** F-C008
**Priority:** P1
**Estimated Size:** Medium

**As a** user
**I want to** see fan morale status
**So that** I understand team support level

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Morale Value Shown**
- **Given:** Team morale is 65
- **When:** FanMoralePanel renders
- **Then:** "65" or gauge at 65% visible
- **Verify:** Find morale value

**AC-2: State Name Shown**
- **Given:** Morale 65 = CONTENT state
- **When:** User views panel
- **Then:** "CONTENT" or similar label shown
- **Verify:** Find state name

**AC-3: Trend Indicator**
- **Given:** Morale rising
- **When:** User views panel
- **Then:** ‚Üë or green arrow visible
- **Verify:** Find trend indicator

### Technical Notes
- Per FAN_MORALE_ENGINE_SPEC.md
- States: HOSTILE(0-20), FRUSTRATED, APATHETIC, CONTENT, SUPPORTIVE, EUPHORIC(90-100)

---

## S-C014: Create PlayoffBracket Component

**Parent Feature:** F-C009
**Priority:** P1
**Estimated Size:** Large

**As a** user in playoffs
**I want to** see the bracket visually
**So that** I understand the tournament

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Bracket Structure**
- **Given:** 4-team playoff
- **When:** PlayoffBracket renders
- **Then:** Bracket with 2 semifinal + 1 final shown
- **Verify:** Find bracket structure

**AC-2: Teams Placed**
- **Given:** Seeds 1-4 determined
- **When:** Bracket displays
- **Then:** Team names in correct seeded positions
- **Verify:** Find teams in bracket

**AC-3: Series Score Shown**
- **Given:** Series at 2-1
- **When:** User views matchup
- **Then:** "2-1" displayed
- **Verify:** Find series score

### Technical Notes
- New file: `src/components/PlayoffBracket.tsx`
- Support 4 or 8 team brackets

---

## S-C015: Create ChampionshipCelebration Component

**Parent Feature:** F-C010
**Priority:** P1
**Estimated Size:** Large

**As a** user winning championship
**I want to** celebrate the victory
**So that** the achievement feels special

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Champion Displayed**
- **Given:** Sirloins won championship
- **When:** Celebration renders
- **Then:** "SIRLOINS ARE CHAMPIONS!" or similar shown
- **Verify:** Find championship text

**AC-2: Series MVP Shown**
- **Given:** MVP determined
- **When:** Celebration displays
- **Then:** MVP name prominently shown
- **Verify:** Find MVP display

**AC-3: Saved to History**
- **Given:** Championship celebrated
- **When:** User continues
- **Then:** Championship recorded in franchiseHistory
- **Verify:** Check history storage

### Technical Notes
- Archive championship with: year, team, MVP, opponent, games

---

# PHASE C SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-C001 | StandingsView Component | P0 |
| S-C002 | Games Back Column | P0 |
| S-C003 | Streak Column | P1 |
| S-C004 | ScheduleView Component | P1 |
| S-C005 | Team Filter for Schedule | P1 |
| S-C006 | LeagueLeadersView | P1 |
| S-C007 | Qualification Rules | P1 |
| S-C008 | SeasonProgressTracker | P0 |
| S-C009 | RosterView Component | P0 |
| S-C010 | Stats in Roster | P1 |
| S-C011 | TeamStatsView | P1 |
| S-C012 | TeamFinancialsView | P1 |
| S-C013 | FanMoralePanel | P1 |
| S-C014 | PlayoffBracket | P1 |
| S-C015 | ChampionshipCelebration | P1 |

**Total Phase C Stories:** 15
**P0 Stories:** 4
**P1 Stories:** 11

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/STORIES_PHASE_D.md

~~~markdown
# KBL Tracker - Phase D User Stories: Awards & Recognition

> **Purpose**: User stories for Awards Ceremony, All-Star Break, Trait Lottery
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE D: AWARDS & RECOGNITION

---

## S-D001: Create AwardsCeremonyHub Component

**Parent Feature:** F-D001
**Priority:** P0
**Estimated Size:** Large

**As a** user at season end
**I want to** experience a guided awards flow
**So that** achievements are properly celebrated

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Award Categories Listed**
- **Given:** Awards ceremony starts
- **When:** AwardsCeremonyHub renders
- **Then:** All award categories visible (Leaders, Gold Glove, Silver Slugger, MVP, Cy Young, ROY)
- **Verify:** Find 6+ award category links

**AC-2: Progress Indicator**
- **Given:** User on 3rd of 6 awards
- **When:** User views hub
- **Then:** Progress shows "3 of 6" or similar
- **Verify:** Find progress indicator

**AC-3: Next Button Works**
- **Given:** On current award
- **When:** User clicks "Next Award"
- **Then:** Navigates to next award in sequence
- **Verify:** Click next, confirm navigation

### Technical Notes
- New file: `src/pages/AwardsCeremonyHub.tsx`
- Per MASTER_SPEC ¬ß9 ceremony flow

---

## S-D002: Add Skip to Summary Option

**Parent Feature:** F-D001
**Priority:** P1
**Estimated Size:** Small

**As a** user in a hurry
**I want to** skip to awards summary
**So that** I can see results quickly

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Skip Button Present**
- **Given:** Awards ceremony in progress
- **When:** User views any award screen
- **Then:** "Skip to Summary" button visible
- **Verify:** Find skip button

**AC-2: Confirms Before Skip**
- **Given:** Skip button clicked
- **When:** Confirmation shown
- **Then:** "Are you sure?" dialog appears
- **Verify:** See confirmation dialog

**AC-3: Awards Still Calculated**
- **Given:** User skips to summary
- **When:** Summary displays
- **Then:** All award winners shown (not empty)
- **Verify:** All award winners populated

### Technical Notes
- Calculation happens regardless of view

---

## S-D003: Create LeagueLeadersAward Component

**Parent Feature:** F-D002
**Priority:** P0
**Estimated Size:** Medium

**As a** user viewing awards
**I want to** see league leaders recognized
**So that** statistical excellence is celebrated

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Batting Triple Crown**
- **Given:** LeagueLeadersAward renders
- **When:** User views batting section
- **Then:** AVG, HR, RBI leaders shown with üëë icon
- **Verify:** Find 3 batting leader rows with crown

**AC-2: Pitching Triple Crown**
- **Given:** LeagueLeadersAward renders
- **When:** User views pitching section
- **Then:** ERA, W, K leaders shown with üëë icon
- **Verify:** Find 3 pitching leader rows with crown

**AC-3: Actual Triple Crown Detection**
- **Given:** Player leads all 3 batting categories
- **When:** Award displays
- **Then:** "TRIPLE CROWN WINNER!" banner shown
- **Verify:** Find special banner for triple crown

### Technical Notes
- Per MASTER_SPEC Screen 1

---

## S-D004: Create GoldGloveAwards Component

**Parent Feature:** F-D003
**Priority:** P0
**Estimated Size:** Large

**As a** user viewing awards
**I want to** see Gold Glove winners by position
**So that** defensive excellence is recognized

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Nine Positions Covered**
- **Given:** GoldGloveAwards renders
- **When:** User views display
- **Then:** Winner for each of 9 positions shown
- **Verify:** Count 9 position winners

**AC-2: fWAR Shown**
- **Given:** Winner displayed
- **When:** User views stats
- **Then:** fWAR value visible for each winner
- **Verify:** Find fWAR stat per winner

**AC-3: Gold Glove Icon**
- **Given:** Winner displayed
- **When:** User views row
- **Then:** üß§ or gold glove icon visible
- **Verify:** Find icon per winner

### Technical Notes
- Per MASTER_SPEC Screen 2
- Requires fWAR calculation

---

## S-D005: Create SilverSluggerAwards Component

**Parent Feature:** F-D004
**Priority:** P0
**Estimated Size:** Large

**As a** user viewing awards
**I want to** see Silver Slugger winners by position
**So that** offensive excellence is recognized

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Positions Including DH**
- **Given:** SilverSluggerAwards renders
- **When:** User views display
- **Then:** Winner for each position + DH shown
- **Verify:** Count 10 position winners (9 + DH)

**AC-2: Batting Stats Shown**
- **Given:** Winner displayed
- **When:** User views stats
- **Then:** AVG, HR, RBI visible for each
- **Verify:** Find 3 stats per winner

**AC-3: Silver Bat Icon**
- **Given:** Winner displayed
- **When:** User views row
- **Then:** üèè or silver bat icon visible
- **Verify:** Find icon per winner

### Technical Notes
- Per MASTER_SPEC Screen 2
- Position eligibility: 10+ games at position

---

## S-D006: Create MVPReveal Component

**Parent Feature:** F-D005
**Priority:** P0
**Estimated Size:** Large

**As a** user at MVP reveal
**I want to** see dramatic MVP announcement
**So that** the achievement feels important

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Build-Up Display**
- **Given:** MVPReveal starts
- **When:** Initial view
- **Then:** "And the MVP is..." or build-up text shown
- **Verify:** Find anticipation text

**AC-2: Winner Revealed**
- **Given:** After build-up
- **When:** Reveal completes
- **Then:** MVP name and team prominently displayed
- **Verify:** Find winner name

**AC-3: WAR Breakdown**
- **Given:** Winner revealed
- **When:** User views stats
- **Then:** Total WAR and breakdown (bWAR, fWAR, rWAR) shown
- **Verify:** Find WAR components

### Technical Notes
- Per MASTER_SPEC Screen 4
- MVP = highest total WAR (position player)

---

## S-D007: Apply MVP Fame Bonus

**Parent Feature:** F-D005
**Priority:** P0
**Estimated Size:** Small

**As a** game system
**I want to** award Fame bonus to MVP
**So that** the honor is recorded

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: +10 Fame Applied**
- **Given:** MVP selected
- **When:** Award finalized
- **Then:** MVP's Fame increases by 10
- **Verify:** Check player Fame before/after

**AC-2: Fame Event Logged**
- **Given:** Fame bonus applied
- **When:** User checks events
- **Then:** "MVP Award: +10 Fame" event in log
- **Verify:** Find Fame event in player history

**AC-3: Award in Career**
- **Given:** MVP awarded
- **When:** User views player career
- **Then:** MVP award listed in career awards
- **Verify:** Find MVP in career achievements

### Technical Notes
- Per MASTER_SPEC Fame table

---

## S-D008: Create CyYoungReveal Component

**Parent Feature:** F-D006
**Priority:** P0
**Estimated Size:** Medium

**As a** user at Cy Young reveal
**I want to** see the best pitcher honored
**So that** pitching excellence is celebrated

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Winner Revealed**
- **Given:** CyYoungReveal renders
- **When:** Reveal complete
- **Then:** Winner name and team displayed
- **Verify:** Find winner name

**AC-2: Pitching Stats**
- **Given:** Winner revealed
- **When:** User views stats
- **Then:** W-L, ERA, K, pWAR visible
- **Verify:** Find pitching stat line

**AC-3: +8 Fame Shown**
- **Given:** Winner displayed
- **When:** User views bonus
- **Then:** "+8 Fame" indicated
- **Verify:** Find Fame bonus text

### Technical Notes
- Per MASTER_SPEC Screen 4
- Cy Young = highest pWAR

---

## S-D009: Create ROYReveal Component

**Parent Feature:** F-D007
**Priority:** P0
**Estimated Size:** Medium

**As a** user at ROY reveal
**I want to** see Rookie of the Year honored
**So that** new talent is recognized

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Winner With Rookie Badge**
- **Given:** ROYReveal renders
- **When:** Winner displayed
- **Then:** "ROOKIE" badge visible with name
- **Verify:** Find rookie badge

**AC-2: Season Stats**
- **Given:** Winner revealed
- **When:** User views stats
- **Then:** Full season line visible
- **Verify:** Find stat line

**AC-3: +5 Fame Applied**
- **Given:** ROY awarded
- **When:** Award finalized
- **Then:** Fame increased by 5
- **Verify:** Check Fame change

### Technical Notes
- Rookie = < 30 career PA before season
- Per MASTER_SPEC ROY criteria

---

## S-D010: Create AwardsSummary Component

**Parent Feature:** F-D008
**Priority:** P0
**Estimated Size:** Large

**As a** user completing awards ceremony
**I want to** see summary of all awards
**So that** I have a complete record

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Winners Listed**
- **Given:** AwardsSummary renders
- **When:** User views list
- **Then:** MVP, Cy Young, ROY, Gold Gloves, Silver Sluggers all shown
- **Verify:** Find all award categories with winners

**AC-2: Key Stat Per Winner**
- **Given:** Award winner listed
- **When:** User views row
- **Then:** One key stat shown (e.g., ".342 AVG" for Silver Slugger)
- **Verify:** Find stat per winner

**AC-3: Continue Button**
- **Given:** Summary displayed
- **When:** User clicks "Continue to Offseason"
- **Then:** Navigation to offseason hub
- **Verify:** Click, confirm navigation

### Technical Notes
- Per MASTER_SPEC Screen 6

---

## S-D011: Create AllStarScreen Component

**Parent Feature:** F-D009
**Priority:** P1
**Estimated Size:** Large

**As a** user at All-Star Break
**I want to** see All-Star selections
**So that** midseason honors are shown

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Both Rosters Displayed**
- **Given:** AllStarScreen renders
- **When:** User views
- **Then:** Two roster columns visible
- **Verify:** Find two team columns

**AC-2: User's Players Highlighted**
- **Given:** User manages Sirloins
- **When:** Sirloins player is All-Star
- **Then:** That player highlighted in roster
- **Verify:** Find highlight on user's players

**AC-3: Trait Lottery Link**
- **Given:** AllStarScreen displayed
- **When:** User views All-Star
- **Then:** "Spin for Trait" button available
- **Verify:** Find trait lottery button

### Technical Notes
- Per MASTER_SPEC ¬ß8
- All-Star selection criteria in spec

---

## S-D012: Create TraitLotteryWheel Component

**Parent Feature:** F-D010
**Priority:** P1
**Estimated Size:** Large

**As a** user with All-Star/Award winner
**I want to** spin for a new trait
**So that** they get a reward

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Wheel Displayed**
- **Given:** TraitLotteryWheel opens
- **When:** Component renders
- **Then:** Spinning wheel with trait segments visible
- **Verify:** Find wheel element

**AC-2: Spin Animation**
- **Given:** Wheel displayed
- **When:** User clicks "Spin"
- **Then:** Wheel animates spinning then stops
- **Verify:** Observe animation

**AC-3: Result Applied**
- **Given:** Wheel lands on "Whiffer" trait
- **When:** Result finalized
- **Then:** Player's traits updated to include "Whiffer"
- **Verify:** Check player traits after spin

### Technical Notes
- Per OFFSEASON_SPEC ¬ß4 trait pools
- Different pools for All-Star vs MVP

---

## S-D013: Configure Trait Pools

**Parent Feature:** F-D010
**Priority:** P1
**Estimated Size:** Medium

**As a** game system
**I want to** appropriate trait pools for events
**So that** rewards match achievement level

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All-Star Pool**
- **Given:** All-Star spinning
- **When:** Wheel configured
- **Then:** Pool contains positive traits only
- **Verify:** Check all wheel options are beneficial

**AC-2: MVP Pool Different**
- **Given:** MVP spinning
- **When:** Wheel configured
- **Then:** Pool contains elite-tier traits
- **Verify:** Find "elite" traits like Utility, Unfazed

**AC-3: No Duplicate Traits**
- **Given:** Player already has "Tough Out"
- **When:** Wheel spins
- **Then:** "Tough Out" not possible result
- **Verify:** Existing traits filtered from pool

### Technical Notes
- Per OFFSEASON_SPEC trait pools

---

# PHASE D SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-D001 | AwardsCeremonyHub | P0 |
| S-D002 | Skip to Summary | P1 |
| S-D003 | LeagueLeadersAward | P0 |
| S-D004 | GoldGloveAwards | P0 |
| S-D005 | SilverSluggerAwards | P0 |
| S-D006 | MVPReveal | P0 |
| S-D007 | MVP Fame Bonus | P0 |
| S-D008 | CyYoungReveal | P0 |
| S-D009 | ROYReveal | P0 |
| S-D010 | AwardsSummary | P0 |
| S-D011 | AllStarScreen | P1 |
| S-D012 | TraitLotteryWheel | P1 |
| S-D013 | Trait Pools Config | P1 |

**Total Phase D Stories:** 13
**P0 Stories:** 9
**P1 Stories:** 4

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/STORIES_PHASE_E.md

~~~markdown
# KBL Tracker - Phase E User Stories: Offseason System

> **Purpose**: User stories for Offseason Hub, Retirements, Free Agency, Draft, Trades
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE E: OFFSEASON SYSTEM

---

## S-E001: Create OffseasonHub Component

**Parent Feature:** F-E001
**Priority:** P0
**Estimated Size:** Large

**As a** user in offseason
**I want to** see all offseason phases
**So that** I can navigate the process

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All 11 Phases Listed**
- **Given:** OffseasonHub renders
- **When:** User views list
- **Then:** All 11 phases visible with names
- **Verify:** Count 11 phase entries

**AC-2: Current Phase Highlighted**
- **Given:** On phase 3 (Retirements)
- **When:** User views hub
- **Then:** Phase 3 highlighted/active
- **Verify:** Find visual highlight on current

**AC-3: Navigate to Phase**
- **Given:** Phase 3 clickable
- **When:** User clicks
- **Then:** Navigation to Retirements screen
- **Verify:** Click, confirm navigation

### Technical Notes
- Per OFFSEASON_SPEC ¬ß1-16
- Phases: Awards, EOS Ratings, Retirements, FA Protection, FA Rounds, Draft, Trades, Signings, Spring Training, Schedule

---

## S-E002: Enforce Phase Order

**Parent Feature:** F-E001
**Priority:** P0
**Estimated Size:** Small

**As a** user
**I want to** complete phases in order
**So that** the process is structured

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Locked Phases Show Icon**
- **Given:** Phase 5 not yet unlocked
- **When:** User views hub
- **Then:** Phase 5 shows üîí icon
- **Verify:** Find lock icon on future phases

**AC-2: Cannot Skip Ahead**
- **Given:** On phase 3
- **When:** User tries to click phase 5
- **Then:** Click blocked or warning shown
- **Verify:** Click locked phase, confirm blocked

**AC-3: Unlock on Completion**
- **Given:** Phase 3 complete
- **When:** User returns to hub
- **Then:** Phase 4 now unlocked
- **Verify:** Complete phase, see next unlock

### Technical Notes
- Store completion state per phase
- Block navigation to locked phases

---

## S-E003: Create OffseasonProgressTracker Component

**Parent Feature:** F-E002
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** see offseason progress
**So that** I know how far along I am

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Progress Bar**
- **Given:** 4 of 11 phases complete
- **When:** Tracker renders
- **Then:** Progress bar at ~36%
- **Verify:** Find progress bar

**AC-2: Completed Checkmarks**
- **Given:** Phases 1-4 complete
- **When:** User views tracker
- **Then:** ‚úì visible on phases 1-4
- **Verify:** Find checkmarks on completed

**AC-3: Remaining Grayed**
- **Given:** Phases 5-11 pending
- **When:** User views tracker
- **Then:** Phases 5-11 grayed/dimmed
- **Verify:** Compare visual treatment

### Technical Notes
- Show in offseason hub sidebar

---

## S-E004: Create EOSRatingsView Component

**Parent Feature:** F-E003
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** see end-of-season rating changes
**So that** I know how players developed

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Players With Changes Listed**
- **Given:** 15 players had rating changes
- **When:** EOSRatingsView renders
- **Then:** 15 players listed
- **Verify:** Count player rows

**AC-2: Before/After Shown**
- **Given:** Player Power went 75 ‚Üí 80
- **When:** User views row
- **Then:** "75 ‚Üí 80" or "+5" visible
- **Verify:** Find delta indicator

**AC-3: Sortable By Change**
- **Given:** List displayed
- **When:** User clicks "Sort by Change"
- **Then:** Biggest changes at top
- **Verify:** Confirm sort order

### Technical Notes
- Per MASTER_SPEC EOS section
- Calculate from performance vs baseline

---

## S-E005: Create RetirementsScreen Component

**Parent Feature:** F-E004
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** see who is retiring
**So that** I can acknowledge careers

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Retirees Listed**
- **Given:** 3 players retiring
- **When:** RetirementsScreen renders
- **Then:** 3 players displayed
- **Verify:** Count retiree entries

**AC-2: Career Summary**
- **Given:** Retiree displayed
- **When:** User views entry
- **Then:** Career stats (years, WAR, key achievements) shown
- **Verify:** Find career summary per retiree

**AC-3: Jersey Retirement Flag**
- **Given:** Retiree eligible for jersey retirement
- **When:** User views entry
- **Then:** "üèÜ Jersey Retirement Eligible" shown
- **Verify:** Find eligibility indicator

### Technical Notes
- Per OFFSEASON_SPEC ¬ß7
- Retirement triggers: age + decline, low ratings

---

## S-E006: Check HOF Eligibility

**Parent Feature:** F-E004
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing retirements
**I want to** see HOF-eligible players
**So that** I know who may enter Hall of Fame

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: HOF Badge Shown**
- **Given:** Retiree career WAR > threshold
- **When:** User views entry
- **Then:** "üèõÔ∏è HOF Eligible" badge shown
- **Verify:** Find HOF indicator

**AC-2: Career WAR Threshold**
- **Given:** HOF threshold is 40 WAR
- **When:** Player has 45 career WAR
- **Then:** Badge appears
- **Verify:** Check calculation

**AC-3: Link to Induction**
- **Given:** HOF eligible
- **When:** User clicks badge
- **Then:** Navigate to HOF induction flow
- **Verify:** Click badge, see induction UI

### Technical Notes
- HOF threshold per MASTER_SPEC

---

## S-E007: Create FreeAgencyHub Component

**Parent Feature:** F-E005
**Priority:** P0
**Estimated Size:** Large

**As a** user in free agency
**I want to** see available free agents
**So that** I can sign players

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: FA Pool Displayed**
- **Given:** 20 free agents available
- **When:** FreeAgencyHub renders
- **Then:** All 20 listed with key stats
- **Verify:** Count FA entries

**AC-2: Cap Space Shown**
- **Given:** User has $15M cap space
- **When:** User views hub
- **Then:** "$15,000,000 available" displayed
- **Verify:** Find cap space amount

**AC-3: Round Indicator**
- **Given:** Currently Round 2 of 3
- **When:** User views hub
- **Then:** "Round 2/3" shown
- **Verify:** Find round indicator

### Technical Notes
- Per OFFSEASON_SPEC ¬ß8
- Multiple rounds of FA

---

## S-E008: Create ProtectedPlayerSelection Component

**Parent Feature:** F-E006
**Priority:** P0
**Estimated Size:** Medium

**As a** user before FA
**I want to** protect one player
**So that** they cannot leave

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Roster Displayed**
- **Given:** ProtectedPlayerSelection opens
- **When:** User views
- **Then:** Full roster shown for selection
- **Verify:** Find all roster players

**AC-2: Single Selection**
- **Given:** User selects player A
- **When:** User tries to select player B
- **Then:** A is deselected, B selected
- **Verify:** Only one can be protected

**AC-3: Confirm Protection**
- **Given:** Player selected
- **When:** User clicks "Protect"
- **Then:** Protection saved, player cannot be FA
- **Verify:** Confirm protection status

### Technical Notes
- 1 protected player per team
- Per OFFSEASON_SPEC ¬ß8

---

## S-E009: Create DraftHub Component

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Large

**As a** user in draft
**I want to** see draft order and prospects
**So that** I can make my picks

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Draft Order Displayed**
- **Given:** 8-team draft
- **When:** DraftHub renders
- **Then:** Order 1-8 with team names shown
- **Verify:** Find draft order list

**AC-2: Prospects Pool**
- **Given:** 24 prospects available
- **When:** User views pool
- **Then:** All 24 listed with ratings
- **Verify:** Count prospect entries

**AC-3: User's Turn Highlighted**
- **Given:** User picks 3rd
- **When:** Pick 3 is active
- **Then:** Prominent "YOUR PICK" indicator
- **Verify:** Find turn indicator

### Technical Notes
- Per OFFSEASON_SPEC ¬ß9
- 3 rounds typical

---

## S-E010: Add Pick Selection to Draft

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Medium

**As a** user making draft pick
**I want to** select a prospect
**So that** they join my team

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Select From Pool**
- **Given:** My pick active
- **When:** User clicks prospect
- **Then:** Prospect highlighted as selection
- **Verify:** Find selection highlight

**AC-2: Confirm Pick**
- **Given:** Prospect selected
- **When:** User clicks "Draft"
- **Then:** Prospect removed from pool, added to my farm
- **Verify:** Check farm system for new player

**AC-3: Cannot Double-Pick**
- **Given:** Prospect already drafted
- **When:** User views pool
- **Then:** Drafted prospects not shown
- **Verify:** Confirm no drafted prospects in pool

### Technical Notes
- Add to farm system, not active roster

---

## S-E011: Create DraftOrderReveal Component

**Parent Feature:** F-E008
**Priority:** P0
**Estimated Size:** Medium

**As a** user before draft
**I want to** see how order was determined
**So that** I understand the process

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Lottery Results**
- **Given:** Bottom 4 teams in lottery
- **When:** DraftOrderReveal shows
- **Then:** Lottery results displayed
- **Verify:** Find lottery outcome

**AC-2: Final Order Listed**
- **Given:** Order determined
- **When:** User views
- **Then:** Full 1-8 order with team names
- **Verify:** Find complete order

**AC-3: User Position Highlighted**
- **Given:** User picking 5th
- **When:** User views order
- **Then:** Position 5 highlighted
- **Verify:** Find user's spot highlight

### Technical Notes
- Per OFFSEASON_SPEC ¬ß9
- Bottom teams get lottery advantage

---

## S-E012: Create ProspectList Component

**Parent Feature:** F-E009
**Priority:** P0
**Estimated Size:** Large

**As a** user evaluating prospects
**I want to** see all prospects with ratings
**So that** I can make informed picks

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Prospects Listed**
- **Given:** 24 prospects in class
- **When:** ProspectList renders
- **Then:** 24 prospect cards shown
- **Verify:** Count prospect entries

**AC-2: Ratings Visible**
- **Given:** Prospect displayed
- **When:** User views card
- **Then:** Key ratings (Power, Contact, etc.) shown
- **Verify:** Find rating values

**AC-3: Sortable/Filterable**
- **Given:** List displayed
- **When:** User selects "Filter: Pitchers"
- **Then:** Only pitcher prospects shown
- **Verify:** Confirm filter works

### Technical Notes
- Per OFFSEASON_SPEC ¬ß9
- Prospect generation algorithm in spec

---

## S-E013: Create TradeHub Component

**Parent Feature:** F-E010
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** access trade functionality
**So that** I can manage roster via trades

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: New Trade Button**
- **Given:** TradeHub renders
- **When:** User views
- **Then:** "Propose Trade" button visible
- **Verify:** Find proposal button

**AC-2: Active Proposals Shown**
- **Given:** 2 pending trade proposals
- **When:** User views hub
- **Then:** Both proposals listed
- **Verify:** Count pending trades

**AC-3: Trade History**
- **Given:** 3 completed trades this season
- **When:** User views history
- **Then:** All 3 visible
- **Verify:** Find trade history section

### Technical Notes
- Per MASTER_SPEC ¬ß25

---

## S-E014: Create TradeProposalBuilder Component

**Parent Feature:** F-E011
**Priority:** P0
**Estimated Size:** Large

**As a** user proposing a trade
**I want to** build a trade package
**So that** I can send an offer

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Two-Column Layout**
- **Given:** TradeProposalBuilder opens
- **When:** User views
- **Then:** "Sending" and "Receiving" columns visible
- **Verify:** Find two-column structure

**AC-2: Player Selection**
- **Given:** Builder open
- **When:** User clicks player from roster
- **Then:** Player added to "Sending" column
- **Verify:** Find player in sending list

**AC-3: Submit When Valid**
- **Given:** Players selected both sides
- **When:** Trade valid (salary match)
- **Then:** "Propose Trade" button enabled
- **Verify:** Button activates on valid trade

### Technical Notes
- Per SALARY_SPEC trade rules

---

## S-E015: Create TradeSalaryMatcher Component

**Parent Feature:** F-E012
**Priority:** P0
**Estimated Size:** Medium

**As a** user building a trade
**I want to** see salary matching
**So that** I know if trade is valid

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Salary Totals Shown**
- **Given:** Trade in progress
- **When:** User views matcher
- **Then:** "Sending: $5M | Receiving: $8M" visible
- **Verify:** Find salary totals

**AC-2: Match Requirement Displayed**
- **Given:** Salary rule requires 80% match
- **When:** User views
- **Then:** "Must be within 80%" shown
- **Verify:** Find matching rule text

**AC-3: Pass/Fail Indicator**
- **Given:** Trade doesn't match
- **When:** User views
- **Then:** Red "‚ùå Does not match" indicator
- **Verify:** Find fail indicator

### Technical Notes
- Per SALARY_SPEC matching rules
- Different rules by cap status

---

# PHASE E SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-E001 | OffseasonHub | P0 |
| S-E002 | Phase Order Enforcement | P0 |
| S-E003 | OffseasonProgressTracker | P0 |
| S-E004 | EOSRatingsView | P0 |
| S-E005 | RetirementsScreen | P0 |
| S-E006 | HOF Eligibility Check | P1 |
| S-E007 | FreeAgencyHub | P0 |
| S-E008 | ProtectedPlayerSelection | P0 |
| S-E009 | DraftHub | P0 |
| S-E010 | Draft Pick Selection | P0 |
| S-E011 | DraftOrderReveal | P0 |
| S-E012 | ProspectList | P0 |
| S-E013 | TradeHub | P0 |
| S-E014 | TradeProposalBuilder | P0 |
| S-E015 | TradeSalaryMatcher | P0 |

**Total Phase E Stories:** 15
**P0 Stories:** 14
**P1 Stories:** 1

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/STORIES_PHASE_F.md

~~~markdown
# KBL Tracker - Phase F User Stories: Advanced Systems

> **Purpose**: User stories for Relationships, Aging, Park Factors, Fielding, Narrative
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE F: ADVANCED SYSTEMS

---

## S-F001: Create RelationshipEngine Module

**Parent Feature:** F-F001
**Priority:** P1
**Estimated Size:** Large

**As a** game system
**I want to** track player relationships
**So that** morale and chemistry are affected

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: 9 Relationship Types Supported**
- **Given:** RelationshipEngine created
- **When:** Type enum checked
- **Then:** DATING, MARRIED, DIVORCED, BEST_FRIENDS, MENTOR_PROTEGE, RIVALS, BULLY_VICTIM, JEALOUS, CRUSH defined
- **Verify:** Find all 9 types

**AC-2: Relationship Storage**
- **Given:** Relationship created
- **When:** Stored to IndexedDB
- **Then:** Retrievable with both player IDs
- **Verify:** Create, save, retrieve relationship

**AC-3: Relationship Limits**
- **Given:** Player already MARRIED
- **When:** Trying to create second MARRIED
- **Then:** Error or rejection occurs
- **Verify:** Confirm limit enforced

### Technical Notes
- New file: `src/engines/relationshipEngine.ts`
- Per FEATURE_WISHLIST HIGH priority
- Types per RELATIONSHIPS_SPEC

---

## S-F002: Calculate Relationship Morale Effects

**Parent Feature:** F-F001
**Priority:** P1
**Estimated Size:** Medium

**As a** game system
**I want to** calculate morale effects from relationships
**So that** relationships matter to gameplay

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Positive Effect Calculated**
- **Given:** Player in MARRIED relationship
- **When:** Morale calculated
- **Then:** +5 to +15 morale boost applied
- **Verify:** Check morale with and without relationship

**AC-2: Negative Effect Calculated**
- **Given:** Player in RIVALS relationship
- **When:** Morale calculated
- **Then:** -5 to -15 morale penalty applied
- **Verify:** Check morale difference

**AC-3: Multiple Relationships Stack**
- **Given:** Player has MARRIED (+10) and BEST_FRIENDS (+5)
- **When:** Total calculated
- **Then:** Both effects combine
- **Verify:** Confirm combined effect

### Technical Notes
- Per FEATURE_WISHLIST relationship morale table

---

## S-F003: Generate Trade Relationship Warnings

**Parent Feature:** F-F001
**Priority:** P1
**Estimated Size:** Medium

**As a** user trading players
**I want to** see relationship warnings
**So that** I understand morale impact

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Warning on Trade Screen**
- **Given:** Trading player A who is BEST_FRIENDS with player B
- **When:** Trade proposed
- **Then:** "Warning: Breaking friendship with Player B" shown
- **Verify:** Find warning in trade UI

**AC-2: Morale Impact Shown**
- **Given:** Warning displayed
- **When:** User views detail
- **Then:** "-5 morale for Player B" indicated
- **Verify:** Find morale impact number

**AC-3: Can Proceed Anyway**
- **Given:** Warning shown
- **When:** User clicks "Proceed Anyway"
- **Then:** Trade continues despite warning
- **Verify:** Confirm trade completes

### Technical Notes
- Per FEATURE_WISHLIST trade warnings

---

## S-F004: Create RelationshipPanel Component

**Parent Feature:** F-F002
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing player
**I want to** see their relationships
**So that** I understand their connections

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Panel in PlayerCard**
- **Given:** PlayerCard open
- **When:** Player has relationships
- **Then:** Relationships section visible
- **Verify:** Find relationships panel

**AC-2: Type Icons**
- **Given:** Relationship displayed
- **When:** User views entry
- **Then:** Icon for type (üíë MARRIED, üëä RIVALS, etc.)
- **Verify:** Find type icons

**AC-3: Related Player Clickable**
- **Given:** Relationship with Player B
- **When:** User clicks Player B name
- **Then:** PlayerCard for B opens
- **Verify:** Click related name, see their card

### Technical Notes
- Integrate into existing PlayerCard.tsx

---

## S-F005: Create AgingEngine Module

**Parent Feature:** F-F004
**Priority:** P0
**Estimated Size:** Large

**As a** game system
**I want to** apply age-based development and decline
**So that** player careers feel realistic

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Young Players Improve**
- **Given:** Player age 22
- **When:** Season ends
- **Then:** Ratings have chance to increase
- **Verify:** Check rating changes for young player

**AC-2: Old Players Decline**
- **Given:** Player age 35
- **When:** Season ends
- **Then:** Ratings decrease
- **Verify:** Check rating decline for old player

**AC-3: Max Age Enforced**
- **Given:** Player age 49
- **When:** Season ends
- **Then:** Player forced to retire
- **Verify:** Check retirement at 49

### Technical Notes
- New file: `src/engines/agingEngine.ts`
- Per FEATURE_WISHLIST HIGH priority
- Development: 18-29, Decline: 30+

---

## S-F006: Calculate Retirement Probability

**Parent Feature:** F-F004
**Priority:** P0
**Estimated Size:** Medium

**As a** game system
**I want to** calculate retirement probability
**So that** older players retire realistically

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Probability Increases With Age**
- **Given:** Player age 38 vs player age 42
- **When:** Probabilities calculated
- **Then:** 42-year-old has higher probability
- **Verify:** Compare probabilities

**AC-2: Low Rating Increases Probability**
- **Given:** Two 38-year-olds, one rated 45, one rated 75
- **When:** Probabilities calculated
- **Then:** 45-rated has higher retirement chance
- **Verify:** Compare probabilities

**AC-3: Retirement Triggered**
- **Given:** Random roll below probability
- **When:** End of season processed
- **Then:** Player added to retirees list
- **Verify:** Check retirement status

### Technical Notes
- Formula in AGING_SPEC
- Consider Fame (famous players stay longer)

---

## S-F007: Create AgingDisplay Component

**Parent Feature:** F-F005
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing player
**I want to** see their career phase
**So that** I understand their trajectory

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Phase Indicator**
- **Given:** Player age 25
- **When:** AgingDisplay renders
- **Then:** "Prime Years" or green indicator shown
- **Verify:** Find phase label

**AC-2: Age Shown**
- **Given:** AgingDisplay renders
- **When:** User views
- **Then:** Player age visible
- **Verify:** Find age number

**AC-3: Decline Warning**
- **Given:** Star player age 34
- **When:** User views
- **Then:** "‚ö†Ô∏è Beginning decline" warning shown
- **Verify:** Find decline indicator

### Technical Notes
- Phases: Development (18-24), Prime (25-32), Decline (33+)

---

## S-F008: Create ParkFactorDisplay Component

**Parent Feature:** F-F006
**Priority:** P1
**Estimated Size:** Medium

**As a** user viewing stadium
**I want to** see park factors
**So that** I understand how it affects play

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Overall Factor Shown**
- **Given:** Stadium "Emerald Diamond"
- **When:** ParkFactorDisplay renders
- **Then:** Overall park factor (e.g., "1.05") shown
- **Verify:** Find overall factor

**AC-2: Breakdown Shown**
- **Given:** Park factor displayed
- **When:** User views detail
- **Then:** HR, Hits, Runs factors visible
- **Verify:** Find breakdown values

**AC-3: Confidence Indicator**
- **Given:** Few games at stadium
- **When:** User views
- **Then:** "Low confidence (5 games)" indicator
- **Verify:** Find confidence text

### Technical Notes
- Per STADIUM_ANALYTICS_SPEC.md
- Default factors until 30 games

---

## S-F009: Create StatsByParkView Component

**Parent Feature:** F-F007
**Priority:** P2
**Estimated Size:** Large

**As a** user
**I want to** see stats by stadium
**So that** I understand performance variance

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Stats Grouped By Stadium**
- **Given:** Player played at 4 stadiums
- **When:** StatsByParkView renders
- **Then:** 4 stadium sections visible
- **Verify:** Find 4 stadium groupings

**AC-2: Home Park Highlighted**
- **Given:** Player's home is "Emerald Diamond"
- **When:** User views
- **Then:** Emerald Diamond section highlighted
- **Verify:** Find home park indicator

**AC-3: Sample Size Shown**
- **Given:** 5 games at one stadium
- **When:** User views that section
- **Then:** "(5 G)" or "5 games" shown
- **Verify:** Find sample size

### Technical Notes
- User requested feature
- Need stadium on game records

---

## S-F010: Create AdaptiveLearningSystem Module

**Parent Feature:** F-F008
**Priority:** P1
**Estimated Size:** Large

**As a** game system
**I want to** improve fielding inference over time
**So that** predictions become more accurate

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Track Inference vs Actual**
- **Given:** Fielding event occurs
- **When:** Stored to database
- **Then:** Inference (predicted fielder) and actual fielder recorded
- **Verify:** Find both values in record

**AC-2: Update At N>=20**
- **Given:** 20 events for hit zone "CF-deep"
- **When:** System calculates
- **Then:** Probability weights updated
- **Verify:** Check probability changed from default

**AC-3: Per-Player Adjustments**
- **Given:** Madoka Hayata has unusual range
- **When:** 20 events tracked
- **Then:** Hayata-specific probabilities stored
- **Verify:** Find player-specific weights

### Technical Notes
- Per FEATURE_WISHLIST HIGH
- Minimum 20 samples for confidence

---

## S-F011: Create FieldingStatsAggregation Service

**Parent Feature:** F-F009
**Priority:** P1
**Estimated Size:** Large

**As a** game system
**I want to** aggregate fielding stats by position
**So that** Gold Glove can be awarded

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Per-Position Stats**
- **Given:** Player played 50 games at SS, 10 at 2B
- **When:** Stats aggregated
- **Then:** Separate stats for SS and 2B
- **Verify:** Find position-split stats

**AC-2: Standard Stats**
- **Given:** Stats aggregated
- **When:** User views
- **Then:** PO, A, E, FLD% visible
- **Verify:** Find all 4 fielding stats

**AC-3: Season Totals**
- **Given:** Season ends
- **When:** Stats finalized
- **Then:** Season totals per player-position
- **Verify:** Find full season aggregates

### Technical Notes
- Per FWAR_CALCULATION_SPEC
- Needed for Gold Glove awards

---

## S-F012: Create LeagueNewsFeed Component

**Parent Feature:** F-F010
**Priority:** P1
**Estimated Size:** Large

**As a** user
**I want to** see league news feed
**So that** I stay informed about happenings

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Stories Listed**
- **Given:** 10 news events occurred
- **When:** LeagueNewsFeed renders
- **Then:** 10 story items shown
- **Verify:** Count news items

**AC-2: Chronological Order**
- **Given:** Stories from different dates
- **When:** User views feed
- **Then:** Most recent at top
- **Verify:** Check date ordering

**AC-3: Team Filter**
- **Given:** Filter set to "Sirloins"
- **When:** Feed updates
- **Then:** Only Sirloins stories shown
- **Verify:** Confirm filter works

### Technical Notes
- Per NARRATIVE_ENGINE_SPEC
- Story types: trades, milestones, injuries, signings

---

# PHASE F SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-F001 | RelationshipEngine Module | P1 |
| S-F002 | Relationship Morale Effects | P1 |
| S-F003 | Trade Relationship Warnings | P1 |
| S-F004 | RelationshipPanel | P1 |
| S-F005 | AgingEngine Module | P0 |
| S-F006 | Retirement Probability | P0 |
| S-F007 | AgingDisplay | P1 |
| S-F008 | ParkFactorDisplay | P1 |
| S-F009 | StatsByParkView | P2 |
| S-F010 | AdaptiveLearningSystem | P1 |
| S-F011 | FieldingStatsAggregation | P1 |
| S-F012 | LeagueNewsFeed | P1 |

**Total Phase F Stories:** 12
**P0 Stories:** 2
**P1 Stories:** 9
**P2 Stories:** 1

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/STORIES_PHASE_G.md

~~~markdown
# KBL Tracker - Phase G User Stories: Polish & History

> **Purpose**: User stories for Museum, Hall of Fame, Records, Data Export
> **Generated**: January 26, 2026
> **Format**: Ralph Framework - max 3 acceptance criteria per story

---

# PHASE G: POLISH & HISTORY

---

## S-G001: Create MuseumHub Component

**Parent Feature:** F-G001
**Priority:** P2
**Estimated Size:** Medium

**As a** user
**I want to** access franchise history museum
**So that** I can explore past achievements

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Section Navigation**
- **Given:** MuseumHub renders
- **When:** User views
- **Then:** Navigation to Hall of Fame, Retired Numbers, Records, Championships
- **Verify:** Find 4+ section links

**AC-2: Featured Items**
- **Given:** Museum hub displayed
- **When:** User views main area
- **Then:** Featured highlights (recent HOF inductee, latest record) shown
- **Verify:** Find featured content

**AC-3: Clean Layout**
- **Given:** Museum displayed
- **When:** User views
- **Then:** Gallery-style clean design
- **Verify:** Visual inspection of layout

### Technical Notes
- New file: `src/pages/MuseumHub.tsx`
- Per MASTER_SPEC ¬ß24

---

## S-G002: Create HallOfFameGallery Component

**Parent Feature:** F-G002
**Priority:** P2
**Estimated Size:** Large

**As a** user
**I want to** see Hall of Fame members
**So that** I honor franchise legends

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All HOF Members Listed**
- **Given:** 5 players in HOF
- **When:** HallOfFameGallery renders
- **Then:** All 5 displayed
- **Verify:** Count HOF entries

**AC-2: Plaque Display**
- **Given:** HOF member displayed
- **When:** User views entry
- **Then:** Plaque-style card with name and photo placeholder
- **Verify:** Find plaque visual

**AC-3: Career Summary**
- **Given:** HOF member displayed
- **When:** User views entry
- **Then:** Career stats (years, WAR, awards) visible
- **Verify:** Find career summary

### Technical Notes
- Per MASTER_SPEC ¬ß14

---

## S-G003: Create RetiredNumbersWall Component

**Parent Feature:** F-G003
**Priority:** P2
**Estimated Size:** Medium

**As a** user
**I want to** see retired jersey numbers
**So that** I honor numbered legends

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Numbers Displayed**
- **Given:** Numbers 7, 21, 42 retired
- **When:** RetiredNumbersWall renders
- **Then:** 7, 21, 42 visible in wall display
- **Verify:** Find all three numbers

**AC-2: Player Association**
- **Given:** #7 retired for "Joey Bagels"
- **When:** User views #7
- **Then:** "Joey Bagels" name shown
- **Verify:** Find name with number

**AC-3: Retirement Date**
- **Given:** #7 retired in 2028
- **When:** User views #7
- **Then:** "Retired: 2028" shown
- **Verify:** Find retirement date

### Technical Notes
- Per MASTER_SPEC ¬ß14

---

## S-G004: Create FranchiseRecords Component

**Parent Feature:** F-G004
**Priority:** P2
**Estimated Size:** Large

**As a** user
**I want to** see franchise record holders
**So that** I know historical bests

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Record Categories**
- **Given:** FranchiseRecords renders
- **When:** User views
- **Then:** Season and career categories visible
- **Verify:** Find category sections

**AC-2: Record Holder and Value**
- **Given:** Season HR record is 45 by Player X
- **When:** User views that record
- **Then:** "Player X - 45" shown
- **Verify:** Find holder and value

**AC-3: Category Filter**
- **Given:** User selects "Pitching"
- **When:** Filter applied
- **Then:** Only pitching records shown
- **Verify:** Confirm filter works

### Technical Notes
- Per MASTER_SPEC ¬ß15
- Track when records broken

---

## S-G005: Create ChampionshipBanners Component

**Parent Feature:** F-G005
**Priority:** P2
**Estimated Size:** Medium

**As a** user
**I want to** see championship banners
**So that** I celebrate past glory

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Banners Displayed**
- **Given:** 3 championships won (2026, 2028, 2030)
- **When:** ChampionshipBanners renders
- **Then:** 3 banner visuals shown
- **Verify:** Count championship banners

**AC-2: Year on Banner**
- **Given:** 2026 championship
- **When:** User views banner
- **Then:** "2026" visible on banner
- **Verify:** Find year text

**AC-3: Click for Details**
- **Given:** Banner displayed
- **When:** User clicks
- **Then:** Season summary/roster shown
- **Verify:** Click banner, see details

### Technical Notes
- Per MASTER_SPEC ¬ß24

---

## S-G006: Create DataExport Service

**Parent Feature:** F-G006
**Priority:** P2
**Estimated Size:** Large

**As a** user
**I want to** export data to CSV/JSON
**So that** I can analyze externally

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Box Score Export**
- **Given:** Game completed
- **When:** User clicks "Export Box Score"
- **Then:** CSV file downloads
- **Verify:** Check downloaded file contents

**AC-2: Season Stats Export**
- **Given:** Season has data
- **When:** User clicks "Export Season Stats"
- **Then:** CSV with all player stats downloads
- **Verify:** Check downloaded file

**AC-3: Format Selection**
- **Given:** Export dialog
- **When:** User selects format
- **Then:** CSV or JSON options available
- **Verify:** Find format dropdown

### Technical Notes
- Use Blob API for downloads
- Include headers in CSV

---

## S-G007: Create ContractionWarning Component

**Parent Feature:** F-G007
**Priority:** P1
**Estimated Size:** Medium

**As a** user
**I want to** be warned about contraction risk
**So that** I can save my team

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Warning at <30 Morale**
- **Given:** Team morale at 25
- **When:** Dashboard viewed
- **Then:** "‚ö†Ô∏è Contraction Risk" warning visible
- **Verify:** Find warning banner

**AC-2: Risk Factors Shown**
- **Given:** Warning displayed
- **When:** User views detail
- **Then:** "Low fan morale (25)" factor shown
- **Verify:** Find factor explanation

**AC-3: Dismissible**
- **Given:** Warning shown
- **When:** User clicks dismiss
- **Then:** Warning hidden (until next session)
- **Verify:** Dismiss and confirm hidden

### Technical Notes
- Per OFFSEASON_SPEC ¬ß6
- Contraction happens at offseason if morale < 30

---

## S-G008: Create ChemistryDisplay Component

**Parent Feature:** F-F003 (From Phase F, lower priority)
**Priority:** P2
**Estimated Size:** Large

**As a** user
**I want to** see team chemistry overview
**So that** I understand team cohesion

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Chemistry Score**
- **Given:** Team chemistry calculated
- **When:** ChemistryDisplay renders
- **Then:** Team score (0-100) visible
- **Verify:** Find chemistry score

**AC-2: Chemistry Grade**
- **Given:** Score is 75
- **When:** User views
- **Then:** Grade "B" shown
- **Verify:** Find letter grade

**AC-3: Top Pairings**
- **Given:** Best chemistry pairs identified
- **When:** User views detail
- **Then:** "Best: Player A + Player B" shown
- **Verify:** Find top pairing

### Technical Notes
- Per CHEMISTRY_SPEC
- Depends on Relationship Engine

---

# PHASE G SUMMARY

| ID | Feature | Priority |
|----|---------|----------|
| S-G001 | MuseumHub | P2 |
| S-G002 | HallOfFameGallery | P2 |
| S-G003 | RetiredNumbersWall | P2 |
| S-G004 | FranchiseRecords | P2 |
| S-G005 | ChampionshipBanners | P2 |
| S-G006 | DataExport Service | P2 |
| S-G007 | ContractionWarning | P1 |
| S-G008 | ChemistryDisplay | P2 |

**Total Phase G Stories:** 8
**P0 Stories:** 0
**P1 Stories:** 1
**P2 Stories:** 7

---

# COMPLETE STORY SUMMARY ACROSS ALL PHASES

| Phase | Description | Stories | P0 | P1 | P2 |
|-------|-------------|---------|----|----|-----|
| A | Foundation | 22 | 21 | 1 | 0 |
| B | Core Game Loop | 18 | 8 | 10 | 0 |
| C | Season Infrastructure | 15 | 4 | 11 | 0 |
| D | Awards & Recognition | 13 | 9 | 4 | 0 |
| E | Offseason System | 15 | 14 | 1 | 0 |
| F | Advanced Systems | 12 | 2 | 9 | 1 |
| G | Polish & History | 8 | 0 | 1 | 7 |
| **TOTAL** | | **103** | **58** | **37** | **8** |

## Implementation Order

1. **Phase A (Foundation)** - Must complete first, enables routing and state
2. **Phase B (Core Game)** - Requires Phase A, completes game loop
3. **Phase C (Season)** - Requires Phase B, adds season context
4. **Phase D (Awards)** - Requires Phase C, end-of-season features
5. **Phase E (Offseason)** - Requires Phase D, between-season features
6. **Phase F (Advanced)** - Can parallel Phases D-E, independent systems
7. **Phase G (Polish)** - Lowest priority, polish and history

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/ralph/USER_STORIES.md

~~~markdown
# KBL Tracker - Complete User Stories

> **Purpose**: Implementation-ready user stories following Ralph Framework
> **Generated**: January 26, 2026
> **Sizing Rule**: Each story < 200 lines of code, max 3 acceptance criteria
> **Scope**: Full MVP - ALL features across 7 phases

---

## Story Format Reference

Each story follows Ralph Framework:
- **"As a... I want... So that..."** format
- **Size Check** with 4 checkboxes
- **Max 3 acceptance criteria** with Given/When/Then/Verify
- **Technical notes** for implementation guidance

---

# PHASE A: FOUNDATION

---

## S-A001: Install React Router ‚úÖ (If not done)

**Parent Feature:** F-A001
**Priority:** P0
**Estimated Size:** Small

**As a** developer
**I want to** have React Router installed and configured
**So that** the app can support multiple pages and navigation

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Package Installed**
- **Given:** The project package.json
- **When:** `npm ls react-router-dom` is run
- **Then:** react-router-dom@7.x is listed
- **Verify:** Run command, confirm version output

**AC-2: BrowserRouter Wraps App**
- **Given:** main.tsx file
- **When:** Developer inspects the file
- **Then:** App is wrapped in `<BrowserRouter>` or `<RouterProvider>`
- **Verify:** Open main.tsx, find BrowserRouter import and usage

**AC-3: Route Definitions Exist**
- **Given:** Router configured
- **When:** App loads at "/"
- **Then:** A route handler matches and renders content
- **Verify:** Open app, confirm content renders without 404

### Technical Notes
- Use react-router-dom v7+ for React 19 compatibility
- Configure in main.tsx or separate router config file
- Create placeholder route for "/" initially

---

## S-A002: Create Routes Configuration

**Parent Feature:** F-A001
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** access different app sections via URLs
**So that** I can navigate and bookmark specific pages

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Core Routes Defined**
- **Given:** Router configured
- **When:** Developer checks route definitions
- **Then:** Routes exist for: `/`, `/season`, `/game`, `/team/:id`
- **Verify:** Find route array with 4+ route objects

**AC-2: 404 Route Exists**
- **Given:** App running
- **When:** User navigates to `/nonexistent-path`
- **Then:** A "Page Not Found" component renders
- **Verify:** Navigate to bad URL, see 404 content

**AC-3: Back/Forward Navigation Works**
- **Given:** User at `/season`
- **When:** User clicks browser back button after navigating from `/`
- **Then:** App returns to `/` without full page reload
- **Verify:** Navigate, click back, confirm SPA navigation

### Technical Notes
- Use createBrowserRouter for type-safe routing
- Include errorElement for route errors
- Placeholder components for routes initially

---

## S-A003: Create MainMenu Component

**Parent Feature:** F-A002
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** see a home screen with navigation options
**So that** I can access different features of the app

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: MainMenu Renders at Root**
- **Given:** App loaded
- **When:** User navigates to `/`
- **Then:** MainMenu component with app title visible
- **Verify:** Open app, see "KBL Tracker" or logo

**AC-2: Navigation Cards Visible**
- **Given:** MainMenu displayed
- **When:** User views the screen
- **Then:** Cards/buttons for "New Game", "Season", "Teams" are visible
- **Verify:** Count 3+ navigation options

**AC-3: Navigation Works**
- **Given:** "Season" card visible
- **When:** User clicks it
- **Then:** URL changes to `/season`
- **Verify:** Click card, confirm URL and content change

### Technical Notes
- New file: `src/pages/MainMenu.tsx`
- Use Tailwind for styling
- Link to routes defined in S-A002

---

## S-A004: Create NavigationHeader Component

**Parent Feature:** F-A003
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** see a persistent header for navigation
**So that** I can always navigate and see my context

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Header Visible on All Pages**
- **Given:** User on `/season` page
- **When:** User views the top of the screen
- **Then:** Navigation header is visible
- **Verify:** Navigate to multiple routes, confirm header present

**AC-2: Home Link Works**
- **Given:** Header visible
- **When:** User clicks logo or home icon
- **Then:** URL changes to `/`
- **Verify:** Click home, confirm navigation

**AC-3: Sticky Position**
- **Given:** Long page content
- **When:** User scrolls down
- **Then:** Header remains visible at top
- **Verify:** Scroll, confirm header stays fixed

### Technical Notes
- New file: `src/components/NavigationHeader.tsx`
- Use `position: sticky` or `fixed`
- Include in root layout component

---

## S-A005: Create SeasonDashboard Component

**Parent Feature:** F-A004
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** see a dashboard with season status
**So that** I know where I am in the season at a glance

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Dashboard Renders**
- **Given:** Season exists
- **When:** User navigates to `/season`
- **Then:** SeasonDashboard component renders with content
- **Verify:** Navigate, see dashboard content

**AC-2: Progress Shown**
- **Given:** Season with 10 games played of 48
- **When:** User views dashboard
- **Then:** Progress indicator shows "10/48" or ~21%
- **Verify:** Find progress element with game count

**AC-3: No Season State Handled**
- **Given:** No season started
- **When:** User navigates to `/season`
- **Then:** "No season started" message with "Start Season" button shown
- **Verify:** Clear season data, reload, see message

### Technical Notes
- New file: `src/pages/SeasonDashboard.tsx`
- Pull season data from seasonStorage
- Handle loading and empty states

---

## S-A006: Create GlobalStateProvider

**Parent Feature:** F-A006
**Priority:** P0
**Estimated Size:** Medium

**As a** developer
**I want to** global state management for shared data
**So that** components can access season/team/preferences anywhere

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Context Provider Created**
- **Given:** src/context folder
- **When:** Developer checks files
- **Then:** AppContext.tsx exists with createContext and AppProvider
- **Verify:** Find file with context creation

**AC-2: Provider Wraps App**
- **Given:** main.tsx
- **When:** Developer inspects
- **Then:** AppProvider wraps the app tree
- **Verify:** Find AppProvider in main.tsx

**AC-3: Hook Available**
- **Given:** Any component
- **When:** Developer imports useAppContext
- **Then:** Hook returns context values (season, team, etc.)
- **Verify:** Import hook, log values in any component

### Technical Notes
- New file: `src/context/AppContext.tsx`
- Include: currentSeason, selectedTeam, preferences
- Export useAppContext hook

---

## S-A007: Add IndexedDB State Hydration

**Parent Feature:** F-A006
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** my state to persist across page refreshes
**So that** I don't lose my progress

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: State Loads on App Start**
- **Given:** Previous session had team "Sirloins" selected
- **When:** App refreshes and loads
- **Then:** Global state shows "Sirloins" as selected team
- **Verify:** Select team, refresh, confirm selection persists

**AC-2: Loading State Shown**
- **Given:** App starting
- **When:** IndexedDB loading (may be instant)
- **Then:** Loading indicator shown until hydration complete
- **Verify:** Throttle network, observe loading state

**AC-3: Graceful Fallback**
- **Given:** IndexedDB unavailable (private mode)
- **When:** App starts
- **Then:** App functions with default state, no crash
- **Verify:** Block IndexedDB, confirm app loads

### Technical Notes
- Use existing IndexedDB patterns from seasonStorage
- Add hydration effect in AppProvider
- Set isLoading flag during hydration

---

## S-A008: Create TeamSelector Component

**Parent Feature:** F-A005
**Priority:** P0
**Estimated Size:** Medium

**As a** user
**I want to** select which team I'm managing
**So that** I see relevant data throughout the app

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Team Dropdown Renders**
- **Given:** Teams exist in database
- **When:** User views TeamSelector
- **Then:** Dropdown shows all available teams
- **Verify:** Click dropdown, see team list

**AC-2: Selection Updates Context**
- **Given:** "Beewolves" selected in dropdown
- **When:** Selection confirmed
- **Then:** Global state selectedTeam equals "Beewolves"
- **Verify:** Select team, log context value

**AC-3: Selection Persists**
- **Given:** "Beewolves" selected
- **When:** Page refreshes
- **Then:** TeamSelector shows "Beewolves" as selected
- **Verify:** Select, refresh, confirm persistence

### Technical Notes
- New file: `src/components/TeamSelector.tsx`
- Use useAppContext for state
- Persist to localStorage or IndexedDB

---

## S-A009: Create PlayerRatingsForm Component

**Parent Feature:** F-A007
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** input player ratings
**So that** salary can be calculated

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Position Player Fields**
- **Given:** Position player selected
- **When:** Form renders
- **Then:** 5 inputs visible: Power, Contact, Speed, Fielding, Arm
- **Verify:** Count 5 labeled inputs for position player

**AC-2: Pitcher Fields**
- **Given:** Pitcher selected
- **When:** Form renders
- **Then:** 3 inputs visible: Velocity, Junk, Accuracy
- **Verify:** Count 3 labeled inputs for pitcher

**AC-3: Save Works**
- **Given:** Ratings entered (Power: 75, etc.)
- **When:** User clicks Save
- **Then:** Ratings stored and retrievable for that player
- **Verify:** Save, reload, confirm ratings persist

### Technical Notes
- New file: `src/components/PlayerRatingsForm.tsx`
- Validate 0-99 range
- Store in playerRatings IndexedDB store

---

## S-A010: Create LeagueBuilder Component

**Parent Feature:** F-A008
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** set up a league with teams
**So that** I can start a season

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Team Selection Available**
- **Given:** Available teams in database
- **When:** LeagueBuilder renders
- **Then:** Checkboxes or multi-select for team selection visible
- **Verify:** See team selection UI with all teams

**AC-2: Minimum Team Validation**
- **Given:** Only 1 team selected
- **When:** User tries to create league
- **Then:** Error "Minimum 2 teams required" shown
- **Verify:** Select 1 team, try create, see error

**AC-3: League Saves**
- **Given:** 4 teams selected
- **When:** User clicks "Create League"
- **Then:** League configuration stored
- **Verify:** Create, confirm league data in storage

### Technical Notes
- New file: `src/pages/LeagueBuilder.tsx`
- Store league config to IndexedDB
- Link to season creation flow

---

## S-A011: Create ManualPlayerInput Component

**Parent Feature:** F-A009
**Priority:** P0
**Estimated Size:** Large

**As a** user
**I want to** manually add individual players
**So that** I can create one-off players

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Basic Fields Present**
- **Given:** ManualPlayerInput renders
- **When:** User views form
- **Then:** Inputs for Name, Team, Position, Handedness visible
- **Verify:** Find 4 required field inputs

**AC-2: Player Saves to Database**
- **Given:** Name "Test Player", Team "Sirloins", Position "SS"
- **When:** User submits form
- **Then:** Player retrievable from database
- **Verify:** Save, query database, find player

**AC-3: Validation Works**
- **Given:** Name field empty
- **When:** User tries to submit
- **Then:** Error message appears, submit blocked
- **Verify:** Try submit with empty name, see error

### Technical Notes
- New file: `src/components/ManualPlayerInput.tsx`
- Embed PlayerRatingsForm (S-A009) for ratings
- Use playerDatabase functions to save

---

## S-A012: Display Team Names in Scoreboard

**Parent Feature:** F-A010
**Priority:** P0
**Estimated Size:** Small

**As a** user tracking a game
**I want to** see team names in the scoreboard
**So that** I know which team is which

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Away Team Name Displays**
- **Given:** Game with "Sirloins" vs "Beewolves"
- **When:** User views scoreboard
- **Then:** "Sirloins" text visible in away position
- **Verify:** Inspect scoreboard, find team name

**AC-2: Home Team Name Displays**
- **Given:** Game with "Sirloins" vs "Beewolves"
- **When:** User views scoreboard
- **Then:** "Beewolves" text visible in home position
- **Verify:** Inspect scoreboard, find team name

**AC-3: Names Positioned Correctly**
- **Given:** Scoreboard displayed
- **When:** User views layout
- **Then:** Away name above/left of away score, home name above/left of home score
- **Verify:** Visual alignment check

### Technical Notes
- Edit: `src/components/GameTracker/Scoreboard.tsx`
- Props may already exist - verify they're being passed
- Truncate if > 12 characters

---

## S-A013: Add Visible Undo Button

**Parent Feature:** F-A011
**Priority:** P0
**Estimated Size:** Small

**As a** user who made a mistake
**I want to** click an undo button
**So that** I can reverse the last action

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Button Visible**
- **Given:** GameTracker loaded
- **When:** User views UI
- **Then:** "Undo" button or ‚Ü∂ icon visible
- **Verify:** Find undo button element

**AC-2: Initially Disabled**
- **Given:** Fresh game, no actions taken
- **When:** User views undo button
- **Then:** Button appears disabled
- **Verify:** Check disabled attribute or opacity

**AC-3: Enables After Action**
- **Given:** User records a hit
- **When:** At-bat completes
- **Then:** Undo button enabled
- **Verify:** Click undo, confirm it works

### Technical Notes
- Edit: `src/components/GameTracker/index.tsx`
- Wire to existing handleUndo function
- undoStack already tracks 10 states

---

## S-A014: Make Current Batter Name Clickable

**Parent Feature:** F-A012
**Priority:** P0
**Estimated Size:** Small

**As a** user viewing the current batter
**I want to** click their name to see full stats
**So that** I can check player details quickly

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Cursor Changes on Hover**
- **Given:** Batter name displayed
- **When:** User hovers over name
- **Then:** Cursor becomes pointer
- **Verify:** Hover, observe cursor change

**AC-2: Click Opens PlayerCard**
- **Given:** "Madoka Hayata" as batter
- **When:** User clicks name
- **Then:** PlayerCard modal opens with "Madoka Hayata"
- **Verify:** Click, see modal with player name

**AC-3: Modal Shows Data**
- **Given:** PlayerCard open
- **When:** User views modal
- **Then:** Position, handedness, and stats visible
- **Verify:** Read modal content

### Technical Notes
- Add onClick handler to batter name span
- Add state: selectedPlayerId, showPlayerCard
- Render PlayerCard when state set

---

## S-A015: Make Due-Up Names Clickable

**Parent Feature:** F-A012
**Priority:** P0
**Estimated Size:** Small

**As a** user viewing the due-up list
**I want to** click any player name for their stats
**So that** I can scout upcoming batters

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: All Names Clickable**
- **Given:** Due-up list shows 4 players
- **When:** User hovers each name
- **Then:** All show pointer cursor
- **Verify:** Hover all 4, confirm cursor change

**AC-2: Click Opens Correct Player**
- **Given:** "Damien Rush" second in due-up
- **When:** User clicks "Damien Rush"
- **Then:** PlayerCard shows Damien Rush data
- **Verify:** Click second name, confirm correct player

**AC-3: Works for All Positions**
- **Given:** Due-up with 4 different players
- **When:** User clicks each (closing modal between)
- **Then:** Each shows correct player
- **Verify:** Click all 4, confirm each is different/correct

### Technical Notes
- Reuse click handler pattern from S-A014
- Map handler to each due-up name element

---

## S-A016: Create Lineup View Panel

**Parent Feature:** F-A013
**Priority:** P0
**Estimated Size:** Large

**As a** user during a game
**I want to** view the current lineup
**So that** I can see who plays where

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Button Opens Panel**
- **Given:** "View Lineup" button visible
- **When:** User clicks button
- **Then:** Lineup panel appears
- **Verify:** Click button, see panel

**AC-2: Shows 9 Positions**
- **Given:** Panel open
- **When:** User counts entries
- **Then:** Exactly 9 batting order positions shown
- **Verify:** Count entries, confirm 9

**AC-3: Shows Names and Positions**
- **Given:** Panel open
- **When:** User reads entries
- **Then:** Each shows player name and defensive position
- **Verify:** Read entries, find name + position (e.g., "Hayata - SS")

### Technical Notes
- New file: `src/components/GameTracker/LineupPanel.tsx`
- Map through lineupState.currentLineup
- Toggle with showLineupPanel state

---

## S-A017: Add Mojo Indicators to Lineup Panel

**Parent Feature:** F-A013
**Priority:** P0
**Estimated Size:** Medium

**As a** user viewing the lineup
**I want to** see each player's mojo level
**So that** I identify who is hot or cold

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Indicator Visible**
- **Given:** Lineup panel open
- **When:** User views any player row
- **Then:** Mojo indicator (badge/icon) visible
- **Verify:** Find mojo element next to each name

**AC-2: Color Coded**
- **Given:** Player with mojo +2
- **When:** User views indicator
- **Then:** Indicator is blue/gold (not red)
- **Verify:** Check indicator color matches state

**AC-3: All Players Have Indicator**
- **Given:** 9 players in lineup
- **When:** User views panel
- **Then:** All 9 have mojo indicators
- **Verify:** Count indicators, confirm 9

### Technical Notes
- Colors: -2=red, -1=orange, 0=gray, +1=green, +2=blue
- May use placeholder 0 until mojo fully tracked

---

## S-A018: Add Fitness Indicators to Lineup Panel

**Parent Feature:** F-A013
**Priority:** P0
**Estimated Size:** Medium

**As a** user viewing the lineup
**I want to** see each player's fitness status
**So that** I identify tired or injured players

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Fitness Indicator Visible**
- **Given:** Lineup panel open
- **When:** User views any player row
- **Then:** Fitness indicator (distinct from mojo) visible
- **Verify:** Find second indicator element

**AC-2: Represents 6 States**
- **Given:** Fitness indicator displayed
- **When:** User hovers for tooltip
- **Then:** Shows one of: Hurt, Weak, Strained, Well, Fit, Juiced
- **Verify:** Hover, read tooltip

**AC-3: All Players Have Indicator**
- **Given:** 9 players in lineup
- **When:** User views panel
- **Then:** All 9 have fitness indicators
- **Verify:** Count indicators, confirm 9

### Technical Notes
- Place next to mojo indicator
- Use different icon set from mojo

---

## S-A019: Display Pitch Count

**Parent Feature:** F-A014
**Priority:** P0
**Estimated Size:** Small

**As a** user tracking a game
**I want to** see the pitcher's pitch count
**So that** I can decide when to make a change

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Pitch Count Visible**
- **Given:** Game in progress
- **When:** User views pitcher area
- **Then:** "Pitches: XX" or similar displayed
- **Verify:** Find pitch count text

**AC-2: Updates After At-Bat**
- **Given:** Pitch count at 15
- **When:** At-bat with 4+ pitches completes
- **Then:** Pitch count increases to 19+
- **Verify:** Note count, record at-bat, confirm increase

**AC-3: Starts at 0**
- **Given:** Fresh game started
- **When:** First batter appears
- **Then:** Pitch count shows 0
- **Verify:** Start game, see "Pitches: 0"

### Technical Notes
- Display near scoreboard or pitcher info
- May need to track pitches per at-bat

---

## S-A020: Add Batter Mojo Badge

**Parent Feature:** F-A015
**Priority:** P0
**Estimated Size:** Small

**As a** user viewing the current batter
**I want to** see their mojo status
**So that** I know if they're hot or slumping

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Badge Visible**
- **Given:** Current batter displayed
- **When:** User views batter area
- **Then:** Mojo badge visible near batter name
- **Verify:** Find badge element

**AC-2: Has Tooltip**
- **Given:** Mojo badge displayed
- **When:** User hovers
- **Then:** Tooltip shows state name (e.g., "Jacked")
- **Verify:** Hover, read tooltip

### Technical Notes
- Reuse mojo color scheme
- Position next to batter name display

---

## S-A021: Add Pitcher Fitness Badge

**Parent Feature:** F-A015
**Priority:** P0
**Estimated Size:** Small

**As a** user viewing the current pitcher
**I want to** see their fitness status
**So that** I know when they might be tiring

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Badge Visible**
- **Given:** Pitcher displayed
- **When:** User views pitcher info
- **Then:** Fitness badge visible
- **Verify:** Find badge near pitcher name/info

**AC-2: Near Pitch Count**
- **Given:** Pitch count and fitness badge displayed
- **When:** User views layout
- **Then:** Badge within visual proximity of pitch count
- **Verify:** Visual layout check

### Technical Notes
- Position near pitch count for easy scanning

---

## S-A022: Fix Exit Type Double Entry

**Parent Feature:** F-A016
**Priority:** P0
**Estimated Size:** Medium

**As a** user recording an at-bat
**I want to** select exit type once
**So that** I don't have to click twice

### Size Check ‚úì
- [x] Can be implemented in < 200 lines of code
- [x] Has no more than 3 acceptance criteria
- [x] Does not require architectural decisions
- [x] Has clear, testable end state

### Acceptance Criteria

**AC-1: Single Click Flow**
- **Given:** At-bat in progress
- **When:** User clicks "GO" button
- **Then:** Modal/flow proceeds without second exit type click
- **Verify:** Click GO, count clicks to complete

**AC-2: Exit Type in Modal**
- **Given:** Fielding modal open
- **When:** User views modal
- **Then:** Exit type options integrated in modal
- **Verify:** Find exit type selector in modal

**AC-3: Total Clicks ‚â§ 3**
- **Given:** GO selected
- **When:** User completes at-bat
- **Then:** Requires ‚â§ 3 clicks from result to completion
- **Verify:** Count clicks: GO ‚Üí fields ‚Üí confirm

### Technical Notes
- Edit: `src/components/GameTracker/AtBatFlow.tsx`
- Consolidate exit type into fielding modal
- Remove duplicate popup

---

# SUMMARY

This file contains Phase A foundation stories. Additional phases (B through G) are documented in separate files to prevent context overflow:

- **STORIES_PHASE_B.md** - Core Game Loop (Pre-game, Post-game, etc.)
- **STORIES_PHASE_C.md** - Season Infrastructure
- **STORIES_PHASE_D.md** - Awards & Recognition
- **STORIES_PHASE_E.md** - Offseason System
- **STORIES_PHASE_F.md** - Advanced Systems
- **STORIES_PHASE_G.md** - Polish & History

## Phase A Story Count

| ID Range | Feature | Stories |
|----------|---------|---------|
| S-A001-A002 | React Router | 2 |
| S-A003-A005 | Navigation/Dashboard | 3 |
| S-A006-A007 | Global State | 2 |
| S-A008 | Team Selector | 1 |
| S-A009 | Player Ratings | 1 |
| S-A010 | League Builder | 1 |
| S-A011 | Manual Player | 1 |
| S-A012-A015 | Scoreboard/PlayerCard | 4 |
| S-A016-A018 | Lineup Panel | 3 |
| S-A019-A021 | Display Enhancements | 3 |
| S-A022 | Bug Fix | 1 |
| **Total Phase A** | | **22** |

---

*All stories follow Ralph Framework: < 200 lines, max 3 acceptance criteria, Given/When/Then/Verify format.*
~~~

### Source File: specs/stories/STORIES_AWARDS_CEREMONY.md

~~~markdown
# User Stories: Awards Ceremony System

> **Feature Area**: Offseason Phase 2 - Awards Ceremony
> **Epic**: End-of-Season Recognition
> **Created**: January 29, 2026
> **Source Spec**: OFFSEASON_SYSTEM_SPEC.md ¬ß4, KBL_XHD_TRACKER_MASTER_SPEC_v3.md

---

## Overview

The Awards Ceremony is a **multi-screen presentation flow** that reveals end-of-season awards in dramatic fashion. Users tap through each screen to reveal winners. Awards are presented using a **Hybrid Voting System** where the system calculates recommendations but users can override.

### Award Processing Order
| Step | Award | Selection Method |
|------|-------|------------------|
| 1 | League Leaders | Auto-calculated |
| 2 | Gold Gloves (9 positions) | Hybrid voting |
| 3 | Platinum Glove | From GG winners |
| 4 | Booger Glove | Worst fielding |
| 5 | Silver Sluggers | Hybrid voting |
| 6 | Reliever of the Year (AL/NL) | Hybrid voting |
| 7 | Bench Player of the Year | Hybrid voting |
| 8 | Rookie of the Year (AL/NL) | Hybrid voting |
| 9 | Cy Young (AL/NL) | Hybrid voting |
| 10 | MVP (AL/NL) | Hybrid voting |
| 11 | Manager of the Year (AL/NL) | mWAR-based |
| 12 | Kara Kawaguchi Award | Special criteria |
| 13 | Bust of the Year | Underperformance |
| 14 | Comeback Player of the Year | Special criteria |

---

## Story: S-AWD001 - League Leaders Calculation

**As a** system
**I want to** auto-calculate league leaders for all statistical categories
**So that** leaders can be displayed and rewarded

### Acceptance Criteria
- [ ] Calculate AL and NL leaders for each category
- [ ] Hitting: AVG, HR, RBI, SB, OPS, Hits, Runs, BB
- [ ] Pitching: ERA, K, Wins, Saves, WHIP, IP
- [ ] Handle ties (show both players)
- [ ] Apply minimum qualifications (PA for hitters, IP for pitchers)
- [ ] Store leader data for awards ceremony display

### Leader Rewards
| Leader | Reward |
|--------|--------|
| AVG (AL/NL) | +5 Contact |
| HR Leader | +5 Power |
| RBI (AL/NL) | +3 Contact, +3 Power |
| ERA (AL/NL) | +5 to ACC, JNK, or VEL (user choice) |
| K Leader (AL/NL) | +5 to JNK or VEL (user choice) |
| Most Hitting K's | **Whiffer** trait |
| Most BB's (Hitter) | +5 Speed |
| Highest Net SB% | **Stealer** trait OR +5 Speed |
| Most Saves | **Clutch** trait |

---

## Story: S-AWD002 - Hybrid Voting System

**As a** user
**I want to** see system recommendations but be able to override them
**So that** I have agency in award decisions while getting intelligent suggestions

### Acceptance Criteria
- [ ] System calculates weighted score for each candidate
- [ ] Display top 3-5 candidates with scores
- [ ] Highlight #1 as "‚òÖ System Recommendation"
- [ ] Show voting breakdown (WAR %, Clutch %, etc.)
- [ ] Buttons: "Confirm #1", "Select #2", "Select #3", "Other Player..."
- [ ] "Other Player" opens searchable player list
- [ ] Selected player receives award and associated rewards

### Voting Weights by Award

**MVP (Position Players)**
| Component | Weight | Source |
|-----------|--------|--------|
| WAR | 40% | bWAR + rWAR + fWAR |
| Clutch | 25% | Net Clutch / Opportunities |
| Traditional | 15% | AVG, HR, RBI, SB, OPS |
| Team Success | 12% | Win percentage |
| Fame | 8% | Net Fame + Milestones |

**Cy Young (Pitchers)**
| Component | Weight | Source |
|-----------|--------|--------|
| pWAR | 40% | Pitching WAR |
| Advanced | 25% | Inverse FIP + TrueERA |
| Clutch | 25% | Pitching clutch rating |
| Team | 5% | Win percentage |
| Fame | 5% | Net Fame + Milestones |

**Gold Glove**
| Component | Weight | Source |
|-----------|--------|--------|
| fWAR | 55% | Fielding WAR |
| Clutch Plays | 25% | Raw fielding clutch count |
| Eye Test | 20% | Fame + User adjustment (-5 to +5) |

### Technical Notes
```typescript
interface AwardCandidate {
  playerId: string;
  playerName: string;
  team: string;
  score: number;
  breakdown: {
    war: number;
    clutch: number;
    traditional: number;
    teamSuccess: number;
    fame: number;
  };
  isSystemRecommendation: boolean;
}

function calculateMVPCandidates(league: 'AL' | 'NL'): AwardCandidate[] {
  // Filter position players in league
  // Calculate weighted scores
  // Sort by score descending
  // Mark top scorer as recommendation
}
```

---

## Story: S-AWD003 - Gold Glove Awards (9 Positions)

**As a** user
**I want to** select Gold Glove winners for each defensive position
**So that** the best fielders are recognized

### Acceptance Criteria
- [ ] Present each position sequentially: C, 1B, 2B, 3B, SS, LF, CF, RF, P
- [ ] Show top 3 fielders at each position by fWAR
- [ ] Hybrid voting UI with system recommendation
- [ ] Winner receives +5 Fielding
- [ ] After all 9, determine Platinum Glove (best fWAR among winners)
- [ ] Platinum Glove winner receives additional +5 Fielding

### Minimum Qualification
- Must have played 50%+ of games at that position

---

## Story: S-AWD004 - Booger Glove Award

**As a** user
**I want to** see the worst fielder recognized with the "Booger Glove"
**So that** poor defense has consequences

### Acceptance Criteria
- [ ] Auto-select player with lowest qualifying fWAR
- [ ] Display errors, fWAR, and defensive lowlights
- [ ] Penalty depends on current trait count:
  - If < 2 traits: Gains **Butter Fingers** trait
  - If 2 traits: Must lose one positive trait (user chooses)
- [ ] Dramatic/humorous presentation ("The glove that dreams forgot...")

### UI for Trait Loss
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üß§ BOOGER GLOVE AWARD üß§                           ‚ïë
‚ïë                                                     ‚ïë
‚ïë  Winner: Sluggo McBricks                           ‚ïë
‚ïë  fWAR: -1.8 | Errors: 23                           ‚ïë
‚ïë                                                     ‚ïë
‚ïë  PENALTY: Must lose one positive trait!            ‚ïë
‚ïë                                                     ‚ïë
‚ïë  [Lose RBI Hero]  [Lose Power Surge]               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

## Story: S-AWD005 - Silver Slugger Awards

**As a** user
**I want to** select Silver Slugger winners for each offensive position
**So that** the best hitters at each position are recognized

### Acceptance Criteria
- [ ] Present each position: C, 1B, 2B, 3B, SS, LF, CF, RF, DH
- [ ] Ranking based on offensive output (OPS, wRC+, bWAR)
- [ ] Hybrid voting UI with system recommendation
- [ ] Winner receives +3 Power, +3 Contact

---

## Story: S-AWD006 - MVP Award Ceremony

**As a** user
**I want to** experience a dramatic MVP reveal
**So that** the top player recognition feels special

### Acceptance Criteria
- [ ] Separate AL and NL MVP presentations
- [ ] Show voting breakdown with percentage bars
- [ ] Display winner's season stats prominently
- [ ] Winner receives: Random positive trait (chemistry-weighted)
- [ ] Runner-up receives: Random trait
- [ ] 3rd place receives: Random trait
- [ ] Dramatic animation on reveal

### Display Elements
- Large player photo
- Team logo and colors
- Season stats: AVG / HR / RBI / WAR / Clutch
- Voting bar chart showing top 5

---

## Story: S-AWD007 - Cy Young Award Ceremony

**As a** user
**I want to** experience a dramatic Cy Young reveal
**So that** the top pitcher recognition feels special

### Acceptance Criteria
- [ ] Separate AL and NL Cy Young presentations
- [ ] Show voting breakdown with percentage bars
- [ ] Display winner's season stats (W-L / ERA / WHIP / K / pWAR)
- [ ] Winner receives: Random positive pitching trait
- [ ] Runner-up receives: Random trait
- [ ] Note: No traditional W-L in scoring, but display for context

---

## Story: S-AWD008 - Rookie of the Year

**As a** user
**I want to** recognize the best first-year players
**So that** new talent is celebrated

### Acceptance Criteria
- [ ] Separate AL and NL ROY
- [ ] Filter to players in first season
- [ ] Hybrid voting based on WAR, traditional stats, fame
- [ ] Winner receives: Random trait
- [ ] Show "Rookie Year" stats vs league average

---

## Story: S-AWD009 - Reliever of the Year

**As a** user
**I want to** recognize the best relief pitchers
**So that** bullpen excellence is rewarded

### Acceptance Criteria
- [ ] Separate AL and NL
- [ ] Ranking based on: Saves, ERA, WHIP, Clutch rating
- [ ] Winner receives: **Clutch** trait (guaranteed)
- [ ] Display: Saves, ERA, Hold situations, Clutch rating

---

## Story: S-AWD010 - Bench Player of the Year

**As a** user
**I want to** recognize the best reserve player
**So that** bench contributions are valued

### Acceptance Criteria
- [ ] Filter to players with <50% starts
- [ ] Ranking based on: Pinch hit AVG, WAR per PA, Clutch in limited role
- [ ] Winner receives: **Pinch Perfect** trait (guaranteed)
- [ ] Display: PH AVG, Games, Key moments

---

## Story: S-AWD011 - Kara Kawaguchi Award

**As a** user
**I want to** recognize the player who most exceeded salary expectations
**So that** undervalued performers are celebrated

### Acceptance Criteria
- [ ] Calculate WAR percentile vs salary percentile at position
- [ ] Winner = highest positive delta
- [ ] Display: Salary, Salary %ile, WAR, WAR %ile, Delta %
- [ ] Winner receives: **Tough Out** trait + Random positive trait

### Calculation
```typescript
function calculateKaraKawaguchi(): Player {
  return players.maxBy(p => {
    const warPercentile = getWARPercentileAtPosition(p);
    const salaryPercentile = getSalaryPercentileAtPosition(p);
    return warPercentile - salaryPercentile;  // Positive = outperformed
  });
}
```

---

## Story: S-AWD012 - Bust of the Year

**As a** user
**I want to** recognize the biggest underperformer
**So that** salary vs performance matters

### Acceptance Criteria
- [ ] Calculate WAR percentile vs salary percentile
- [ ] Winner = biggest negative delta (high salary, low WAR)
- [ ] Humorous/sympathetic presentation (üí© emoji)
- [ ] Winner receives: **Choker** trait
- [ ] Display: Expected WAR, Actual WAR, Salary, Difference

---

## Story: S-AWD013 - Comeback Player of the Year

**As a** user
**I want to** recognize players who bounced back
**So that** recovery and improvement are celebrated

### Acceptance Criteria
- [ ] Compare current season WAR to previous season
- [ ] Require significant improvement (e.g., +2.0 WAR year-over-year)
- [ ] Hybrid voting for close cases
- [ ] Winner receives: "Recovered" trait (or random positive)
- [ ] Display: Previous season stats, current season stats, delta

---

## Story: S-AWD014 - Manager of the Year

**As a** user
**I want to** recognize the best managerial performance
**So that** user decisions are validated

### Acceptance Criteria
- [ ] Based on mWAR (Manager WAR)
- [ ] mWAR factors: Win% vs expected, in-game decisions (LI-weighted)
- [ ] Separate AL and NL
- [ ] Winner's team receives: +5 to EOS adjustment bonus pool, +5 Fan Morale
- [ ] Display: Record, Expected record, Overperformance, mWAR

---

## Story: S-AWD015 - Trait Replacement Flow

**As a** user
**I want to** choose which trait to replace when at max (2)
**So that** I have control over my player's development

### Acceptance Criteria
- [ ] Trigger when player with 2 traits earns new trait
- [ ] Show current traits with descriptions
- [ ] Show new trait with description
- [ ] Options: "Replace [Trait 1]", "Replace [Trait 2]", "Decline New"
- [ ] Apply selection and update player

### UI Example
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  TRAIT REPLACEMENT                                  ‚ïë
‚ïë                                                     ‚ïë
‚ïë  Player: Mike Trout                                ‚ïë
‚ïë  Award: All-Star Selection                         ‚ïë
‚ïë                                                     ‚ïë
‚ïë  Current Traits:                                    ‚ïë
‚ïë    1. RBI Hero (Spirited) - Bonus with RISP        ‚ïë
‚ïë    2. Tough Out (Competitive) - +CON on 2-strike   ‚ïë
‚ïë                                                     ‚ïë
‚ïë  New Trait: ‚òÖ Clutch (Spirited) ‚òÖ                  ‚ïë
‚ïë                                                     ‚ïë
‚ïë  [Replace RBI Hero]  [Replace Tough Out]  [Decline]‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

## Story: S-AWD016 - Awards Summary Screen

**As a** user
**I want to** see a complete summary of all awards
**So that** I can review the entire ceremony at once

### Acceptance Criteria
- [ ] Display all award winners in organized layout
- [ ] Group by: Major Awards, Position Awards, Special Awards
- [ ] Show team totals (e.g., "Giants: 5 awards")
- [ ] Show all ratings changes applied
- [ ] Show all traits awarded
- [ ] "View Full Details" option
- [ ] "Continue to [Next Phase]" button

---

## Story: S-AWD017 - Awards Ceremony Navigation

**As a** user
**I want to** progress through awards screens sequentially
**So that** the ceremony feels like an event

### Acceptance Criteria
- [ ] Fixed screen order (per Award Processing Order table)
- [ ] Cannot skip ahead
- [ ] "Next" button to advance
- [ ] Progress indicator (e.g., "Screen 3 of 6")
- [ ] All awards auto-save after each screen
- [ ] Can exit and resume later (saves progress)

### Screen Flow
```
Screen 1: League Leaders
    ‚Üì
Screen 2: Gold Glove & Silver Slugger
    ‚Üì
Screen 3: ROY, Reliever, Comeback, Kara Kawaguchi, Bench
    ‚Üì
Screen 4: MVP (AL/NL)
    ‚Üì
Screen 5: Cy Young (AL/NL)
    ‚Üì
Screen 6: Bust of the Year
    ‚Üì
Screen 7: Manager of the Year
    ‚Üì
Screen 8: Summary
```

---

## Implementation Priority

| Story | Priority | Complexity | Dependencies |
|-------|----------|------------|--------------|
| S-AWD001 | P0 | Medium | Season stats |
| S-AWD002 | P0 | High | S-AWD001 |
| S-AWD003 | P0 | Medium | S-AWD002, fWAR |
| S-AWD004 | P1 | Low | S-AWD003 |
| S-AWD005 | P0 | Medium | S-AWD002 |
| S-AWD006 | P0 | Medium | S-AWD002 |
| S-AWD007 | P0 | Medium | S-AWD002 |
| S-AWD008 | P1 | Low | S-AWD002 |
| S-AWD009 | P1 | Low | S-AWD002 |
| S-AWD010 | P2 | Low | S-AWD002 |
| S-AWD011 | P1 | Medium | Salary data |
| S-AWD012 | P1 | Low | S-AWD011 |
| S-AWD013 | P1 | Low | Previous season data |
| S-AWD014 | P2 | Medium | mWAR calculation |
| S-AWD015 | P0 | Low | Trait system |
| S-AWD016 | P1 | Low | All above |
| S-AWD017 | P0 | Medium | All above |

---

## Technical Notes

### Existing Components (from CURRENT_STATE.md)
- `AwardsCeremonyHub.tsx` - Awards ceremony navigation
- `awards/MVPCeremony.tsx` - MVP presentation
- `awards/CyYoungCeremony.tsx` - Cy Young presentation
- `awards/RookieOfYearCeremony.tsx` - ROY presentation
- `awards/GoldGloveCeremony.tsx` - Gold Glove presentation
- `awards/AllStarReveal.tsx` - All-Star team reveal
- `awards/BattingTitleCeremony.tsx` - Batting champion presentation
- `awards/PitchingAwardsCeremony.tsx` - Pitching awards

### Data Dependencies
- Season stats (batting, pitching, fielding)
- WAR calculations (bWAR, pWAR, fWAR, rWAR)
- Clutch ratings
- Fame accumulation
- Salary data
- Previous season stats (for Comeback)
- mWAR (Manager WAR)

---

*End of Stories Document*
~~~

### Source File: specs/stories/STORIES_CONTRACTION_EXPANSION.md

~~~markdown
# User Stories: Contraction/Expansion Phase

> **Feature Area**: Offseason Phase 4 - Contraction/Expansion
> **Created**: January 29, 2026
> **Source**: OFFSEASON_SYSTEM_SPEC.md ¬ß6, KBL_XHD_TRACKER_MASTER_SPEC_v3.md

---

## Overview

The Contraction/Expansion phase handles league structure changes:
1. **Contraction**: Teams with critically low fan morale may fold
2. **Voluntary Sale**: User may choose to sell/contract any team
3. **Expansion Draft**: Existing teams select players from contracted teams
4. **Expansion Team Creation**: User may add new franchises to the league

---

## Story Index

| ID | Story | Priority |
|----|-------|----------|
| S-CE001 | Contraction Risk Detection | P0 |
| S-CE002 | Contraction Probability Roll | P0 |
| S-CE003 | Voluntary Team Sale | P1 |
| S-CE004 | Protection Selection | P0 |
| S-CE005 | Legacy Cornerstone Designation | P0 |
| S-CE006 | Expansion Draft from Contraction | P0 |
| S-CE007 | Scorned Player System | P1 |
| S-CE008 | Remaining Player Disposal | P0 |
| S-CE009 | Defunct Team Museum Entry | P1 |
| S-CE010 | Expansion Team Creation | P1 |
| S-CE011 | Expansion Team Roster Population | P1 |
| S-CE012 | Phase Summary | P0 |
| S-CE013 | Navigation Controls | P0 |

---

## S-CE001: Contraction Risk Detection

**As a** league commissioner,
**I want** to see which teams are at risk of contraction based on fan morale,
**So that** I understand the stakes before the dice roll.

### Acceptance Criteria

- [ ] **AC-1**: System identifies all teams with fan morale < 50 as "at risk"
- [ ] **AC-2**: Display contraction probability based on happiness threshold:
  | Happiness Range | Contraction Probability |
  |-----------------|------------------------|
  | 40-49 | 5% |
  | 30-39 | 15% |
  | 20-29 | 35% |
  | 10-19 | 60% |
  | 0-9 | 85% |
- [ ] **AC-3**: Teams with morale ‚â• 50 show "No Risk" status
- [ ] **AC-4**: Display team's fan morale alongside probability
- [ ] **AC-5**: Highlight teams in "critical danger" (‚â§19 morale) with urgent visual treatment

### Technical Notes

```typescript
interface ContractionRisk {
  teamId: string;
  teamName: string;
  fanMorale: number;
  contractionProbability: number;
  riskLevel: 'NONE' | 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
}

function getContractionProbability(morale: number): number {
  if (morale >= 50) return 0;
  if (morale >= 40) return 5;
  if (morale >= 30) return 15;
  if (morale >= 20) return 35;
  if (morale >= 10) return 60;
  return 85;
}

function getRiskLevel(morale: number): ContractionRisk['riskLevel'] {
  if (morale >= 50) return 'NONE';
  if (morale >= 40) return 'LOW';
  if (morale >= 30) return 'MEDIUM';
  if (morale >= 20) return 'HIGH';
  return 'CRITICAL';
}
```

---

## S-CE002: Contraction Probability Roll

**As a** league commissioner,
**I want** to roll dice to determine if at-risk teams actually contract,
**So that** there's tension and uncertainty in the outcome.

### Acceptance Criteria

- [ ] **AC-1**: Display roll button for each at-risk team
- [ ] **AC-2**: Roll generates random number 1-100
- [ ] **AC-3**: If roll ‚â§ contraction probability, team contracts
- [ ] **AC-4**: If roll > probability, team survives
- [ ] **AC-5**: Show clear result: "CONTRACTED" or "SURVIVED"
- [ ] **AC-6**: Display the roll value and threshold for transparency
- [ ] **AC-7**: Process teams in order from lowest morale to highest

### Technical Notes

```typescript
interface ContractionRollResult {
  teamId: string;
  teamName: string;
  fanMorale: number;
  probability: number;
  diceRoll: number;  // 1-100
  contracted: boolean;
}

function rollContraction(risk: ContractionRisk): ContractionRollResult {
  const roll = Math.floor(Math.random() * 100) + 1;
  return {
    teamId: risk.teamId,
    teamName: risk.teamName,
    fanMorale: risk.fanMorale,
    probability: risk.contractionProbability,
    diceRoll: roll,
    contracted: roll <= risk.contractionProbability
  };
}
```

### Example

```
Team: Kansas City Athletics
Fan Morale: 23
Contraction Probability: 35%

üé≤ Rolling... 28

Result: 28 ‚â§ 35 = CONTRACTED ‚ùå
```

---

## S-CE003: Voluntary Team Sale

**As a** league commissioner,
**I want** to voluntarily contract any team regardless of morale,
**So that** I can reshape the league as desired.

### Acceptance Criteria

- [ ] **AC-1**: Display "Sell Team" option for every team (not just at-risk)
- [ ] **AC-2**: Confirmation dialog before voluntary sale
- [ ] **AC-3**: If team morale ‚â• 50, trigger Scorned Player System (S-CE007)
- [ ] **AC-4**: If team morale < 50, proceed with normal contraction
- [ ] **AC-5**: Skip dice roll for voluntary sales (automatic contraction)
- [ ] **AC-6**: Log that contraction was voluntary vs forced

### Technical Notes

```typescript
interface VoluntarySale {
  teamId: string;
  wasVoluntary: true;
  moraleAtSale: number;
  triggersScornedPlayer: boolean;  // morale >= 50
}
```

---

## S-CE004: Protection Selection

**As a** team owner of a contracted team,
**I want** to protect 4 players from the expansion draft,
**So that** I can preserve some talent for potential return.

### Acceptance Criteria

- [ ] **AC-1**: First protection slot auto-filled by Cornerstone (if exists)
- [ ] **AC-2**: User selects 3 additional players for slots 2-4
- [ ] **AC-3**: If no Cornerstone, user selects all 4 protection slots
- [ ] **AC-4**: Display all roster players with key stats for selection
- [ ] **AC-5**: Protected players marked clearly, cannot be unprotected
- [ ] **AC-6**: Must select exactly 4 players (or all if roster < 4)
- [ ] **AC-7**: Proceed button disabled until 4 selections made

### Technical Notes

```typescript
interface ProtectionSelection {
  teamId: string;
  protectedPlayers: {
    slot: 1 | 2 | 3 | 4;
    playerId: string;
    playerName: string;
    reason: 'CORNERSTONE' | 'USER_CHOICE';
  }[];
  unprotectedPlayers: string[];  // Available for expansion draft
}
```

---

## S-CE005: Legacy Cornerstone Designation

**As a** league historian,
**I want** the Cornerstone of a contracted team to receive "Legacy Cornerstone" status,
**So that** their tragic history is preserved in the narrative.

### Acceptance Criteria

- [ ] **AC-1**: Cornerstone auto-designated as "Legacy Cornerstone" upon contraction
- [ ] **AC-2**: Status is permanent (never removed)
- [ ] **AC-3**: Affects future team chemistry calculations
- [ ] **AC-4**: Display special badge on player card: "Legacy Cornerstone of [Team Name]"
- [ ] **AC-5**: Record in player's history the contraction event
- [ ] **AC-6**: Museum entry for the player's Legacy Cornerstone designation

### Technical Notes

```typescript
interface LegacyCornerstone {
  playerId: string;
  playerName: string;
  originalTeamId: string;
  originalTeamName: string;
  contractionSeasonId: number;
  designationType: 'LEGACY_CORNERSTONE';
  narrativeWeight: 'TRAGIC';  // Affects story generation
}
```

---

## S-CE006: Expansion Draft from Contraction

**As a** existing team manager,
**I want** to select players from the contracted team's unprotected roster,
**So that** I can strengthen my team.

### Acceptance Criteria

- [ ] **AC-1**: Selection order is reverse standings (worst team picks first)
- [ ] **AC-2**: Each team selects exactly 2 players:
  - 1 Position Player
  - 1 Pitcher
- [ ] **AC-3**: Display available players separated by position type
- [ ] **AC-4**: Show player grade, age, salary, and key stats
- [ ] **AC-5**: Once selected, player removed from available pool
- [ ] **AC-6**: Continue until all teams have selected or pool exhausted
- [ ] **AC-7**: Skip teams already at roster max (22 players)
- [ ] **AC-8**: Display selection order with current picker highlighted

### Technical Notes

```typescript
interface ExpansionDraftPick {
  selectingTeamId: string;
  selectingTeamName: string;
  pickNumber: number;
  selectedPlayer: {
    playerId: string;
    playerName: string;
    position: string;
    positionType: 'POSITION' | 'PITCHER';
    grade: string;
    salary: number;
  };
  pickType: 'POSITION_PLAYER' | 'PITCHER';
}

function getExpansionDraftOrder(teams: Team[]): Team[] {
  // Sort by wins ascending (worst record first)
  return [...teams]
    .filter(t => t.rosterCount < 22)
    .sort((a, b) => a.wins - b.wins);
}
```

---

## S-CE007: Scorned Player System

**As a** league storyteller,
**I want** players from voluntarily-sold teams (with morale ‚â• 50) to feel betrayed,
**So that** there are consequences for selling a happy franchise.

### Acceptance Criteria

- [ ] **AC-1**: Only triggers when voluntary sale AND morale ‚â• 50
- [ ] **AC-2**: Each unprotected player receives "Scorned" effects:
  - Random personality shift to DROOPY, EGOTISTICAL, or TOUGH
  - Trust damage: -20 to -40 (base, random)
  - Performance volatility for 2 seasons: -15 to +10 rating swing per game
- [ ] **AC-3**: Display scorned effects for each affected player
- [ ] **AC-4**: Record scorned status in player history
- [ ] **AC-5**: Scorned effects clearly marked on player card for 2 seasons
- [ ] **AC-6**: Protected players (4) do NOT receive scorned effects

### Technical Notes

```typescript
interface ScornedPlayerEffect {
  playerId: string;
  playerName: string;
  personalityShift: 'DROOPY' | 'EGOTISTICAL' | 'TOUGH';  // Random selection
  previousPersonality: string;
  trustDamage: number;  // -20 to -40
  volatilityDuration: 2;  // seasons
  volatilityRange: { min: -15, max: +10 };
  effectStartSeason: number;
  effectEndSeason: number;
}

function applyScornedEffects(player: Player): ScornedPlayerEffect {
  const personalities = ['DROOPY', 'EGOTISTICAL', 'TOUGH'];
  return {
    playerId: player.id,
    playerName: player.name,
    personalityShift: personalities[Math.floor(Math.random() * 3)],
    previousPersonality: player.personality,
    trustDamage: -(20 + Math.floor(Math.random() * 21)),  // -20 to -40
    volatilityDuration: 2,
    volatilityRange: { min: -15, max: +10 },
    effectStartSeason: currentSeason,
    effectEndSeason: currentSeason + 2
  };
}
```

---

## S-CE008: Remaining Player Disposal

**As a** league manager,
**I want** remaining players (after expansion draft) to be properly disposed,
**So that** all contracted team players find destinations.

### Acceptance Criteria

- [ ] **AC-1**: After expansion draft, remaining unprotected players enter retirement check
- [ ] **AC-2**: Retirement check has +30% modifier (contraction trauma)
- [ ] **AC-3**: Players who don't retire enter Free Agency pool
- [ ] **AC-4**: Display disposal results for each remaining player
- [ ] **AC-5**: Protected players also enter Free Agency pool (unless retired)
- [ ] **AC-6**: Summary shows: X retired, Y entered FA

### Technical Notes

```typescript
interface PlayerDisposal {
  playerId: string;
  playerName: string;
  wasProtected: boolean;
  retirementRoll: {
    baseProbability: number;
    contractionModifier: 30;  // +30%
    totalProbability: number;
    roll: number;
    retired: boolean;
  } | null;
  finalDestination: 'RETIRED' | 'FREE_AGENCY';
}

function calculateContractionRetirementProbability(
  baseProbability: number
): number {
  // Add 30% modifier, cap at 95%
  return Math.min(95, baseProbability + 30);
}
```

---

## S-CE009: Defunct Team Museum Entry

**As a** league historian,
**I want** contracted teams to be added to the Museum's "Defunct Teams" section,
**So that** their legacy is preserved.

### Acceptance Criteria

- [ ] **AC-1**: Auto-create Museum entry for contracted team
- [ ] **AC-2**: Entry includes:
  - Team name, city, colors, logo
  - Years active (first season to contraction season)
  - Championship count
  - Notable players (all-time WAR leaders)
  - Final season record
  - Reason for contraction (low morale vs voluntary)
- [ ] **AC-3**: Display "Defunct Teams" as separate Museum section
- [ ] **AC-4**: Retired jerseys from team remain in Museum
- [ ] **AC-5**: Link to Legacy Cornerstone (if exists)

### Technical Notes

```typescript
interface DefunctTeamEntry {
  teamId: string;
  teamName: string;
  city: string;
  colors: { primary: string; secondary: string };
  yearsActive: { start: number; end: number };
  totalSeasons: number;
  championships: number;
  playoffAppearances: number;
  finalSeasonRecord: { wins: number; losses: number };
  allTimeWARLeaders: { playerId: string; playerName: string; war: number }[];
  retiredJerseys: JerseyRetirement[];
  legacyCornerstoneId: string | null;
  contractionReason: 'LOW_MORALE' | 'VOLUNTARY_SALE';
  finalFanMorale: number;
}
```

---

## S-CE010: Expansion Team Creation

**As a** league commissioner,
**I want** to add expansion teams to the league,
**So that** the league can grow.

### Acceptance Criteria

- [ ] **AC-1**: Display "Add Expansion Team" option in phase
- [ ] **AC-2**: Require league to have 14+ existing teams for expansion
- [ ] **AC-3**: Expansion team creation wizard:
  - Step 1: City/Market selection
  - Step 2: Team name input
  - Step 3: Primary/Secondary color selection
  - Step 4: Logo selection (from templates or upload)
  - Step 5: Stadium name input
- [ ] **AC-4**: Initial fan morale set to 60 (optimistic new market)
- [ ] **AC-5**: Display preview of new team before confirmation
- [ ] **AC-6**: Can add multiple expansion teams in same offseason
- [ ] **AC-7**: Expansion teams start with empty roster

### Technical Notes

```typescript
interface ExpansionTeam {
  teamId: string;  // Generated
  teamName: string;
  city: string;
  colors: { primary: string; secondary: string };
  logoUrl: string;
  stadiumName: string;
  foundedSeason: number;
  initialFanMorale: 60;
  roster: [];  // Empty - populated in S-CE011
  division: string | null;  // Assigned after creation
}
```

---

## S-CE011: Expansion Team Roster Population

**As a** expansion team manager,
**I want** to populate my roster through an expansion draft from existing teams,
**So that** I can field a competitive team.

### Acceptance Criteria

- [ ] **AC-1**: Each existing team exposes players for expansion draft:
  - Protect 15 players
  - Remaining 7+ players exposed
- [ ] **AC-2**: Expansion team selects in rounds until roster reaches minimum (18)
- [ ] **AC-3**: Selection order rotates (if multiple expansion teams)
- [ ] **AC-4**: Each existing team can lose max 2 players to expansion draft
- [ ] **AC-5**: Display available players by team with grades and salaries
- [ ] **AC-6**: Expansion team salary cap starts at league average
- [ ] **AC-7**: Must select mix of positions (at least 2 pitchers per round)

### Technical Notes

```typescript
interface ExpansionDraftConfig {
  expansionTeamId: string;
  protectionLimit: 15;  // Existing teams protect 15
  maxLossPerTeam: 2;    // Existing teams lose max 2
  targetRosterSize: 18;  // Expansion team minimum
  positionRequirements: {
    minPitchers: 6;
    minPositionPlayers: 9;
  };
}

interface ExpansionDraftSelection {
  round: number;
  expansionTeamId: string;
  selectedFrom: string;  // Team ID
  playerId: string;
  playerName: string;
  position: string;
  grade: string;
  salary: number;
}
```

---

## S-CE012: Phase Summary

**As a** league commissioner,
**I want** to see a summary of all contraction/expansion activity,
**So that** I understand what changed.

### Acceptance Criteria

- [ ] **AC-1**: Display summary screen at phase end
- [ ] **AC-2**: Summary sections:
  - **Teams at Risk**: List with morale and survival/contraction result
  - **Contracted Teams**: List with reason and player count affected
  - **Expansion Draft Results**: By selecting team, players acquired
  - **Player Disposals**: Retired vs Free Agency counts
  - **Expansion Teams Created**: New franchises added
  - **Legacy Cornerstones**: Players designated
- [ ] **AC-3**: "View Details" expands each section
- [ ] **AC-4**: Export summary option (for records)
- [ ] **AC-5**: Continue button to next phase

### Technical Notes

```typescript
interface ContractionExpansionSummary {
  seasonId: number;
  teamsAtRisk: ContractionRisk[];
  teamsContracted: {
    teamId: string;
    teamName: string;
    reason: 'LOW_MORALE' | 'VOLUNTARY_SALE';
    playersAffected: number;
  }[];
  teamsSurvived: {
    teamId: string;
    teamName: string;
    roll: number;
    probability: number;
  }[];
  expansionDraftPicks: ExpansionDraftPick[];
  playerDisposals: {
    retired: number;
    enteredFA: number;
  };
  expansionTeamsCreated: ExpansionTeam[];
  legacyCornerstones: LegacyCornerstone[];
  scornedPlayers: ScornedPlayerEffect[];
}
```

---

## S-CE013: Navigation Controls

**As a** user,
**I want** clear navigation through the contraction/expansion screens,
**So that** I can complete the phase efficiently.

### Acceptance Criteria

- [ ] **AC-1**: Progress indicator shows current step in phase
- [ ] **AC-2**: Can't skip ahead until current step complete
- [ ] **AC-3**: "Back" available for review (read-only for completed steps)
- [ ] **AC-4**: Auto-save after each significant action
- [ ] **AC-5**: Can exit and resume later from last checkpoint
- [ ] **AC-6**: Step sequence:
  1. Risk Assessment (review at-risk teams)
  2. Contraction Rolls (for each at-risk team)
  3. Voluntary Sales (optional)
  4. Protection Selection (per contracted team)
  5. Expansion Draft (if any contractions)
  6. Player Disposal (remaining players)
  7. Expansion Team Creation (optional)
  8. Expansion Team Draft (if new teams)
  9. Summary

### Technical Notes

```typescript
type ContractionExpansionStep =
  | 'RISK_ASSESSMENT'
  | 'CONTRACTION_ROLLS'
  | 'VOLUNTARY_SALES'
  | 'PROTECTION_SELECTION'
  | 'EXPANSION_DRAFT'
  | 'PLAYER_DISPOSAL'
  | 'EXPANSION_CREATION'
  | 'EXPANSION_TEAM_DRAFT'
  | 'SUMMARY';

interface PhaseNavigation {
  currentStep: ContractionExpansionStep;
  completedSteps: ContractionExpansionStep[];
  canProceed: boolean;
  canGoBack: boolean;
}
```

---

## Dependency Map

```
S-CE001 (Risk Detection)
    ‚Üì
S-CE002 (Probability Roll) ‚Üê‚Üí S-CE003 (Voluntary Sale)
    ‚Üì                              ‚Üì
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚Üì
         S-CE004 (Protection Selection)
                 ‚Üì
         S-CE005 (Legacy Cornerstone)
                 ‚Üì
         S-CE006 (Expansion Draft from Contraction)
                 ‚Üì
S-CE007 (Scorned Players) ‚Üê‚îÄ‚îÄ [if voluntary & morale ‚â•50]
                 ‚Üì
         S-CE008 (Remaining Player Disposal)
                 ‚Üì
         S-CE009 (Defunct Team Museum)
                 ‚Üì
S-CE010 (Expansion Team Creation) ‚îÄ‚îÄ‚Üí S-CE011 (Expansion Roster)
                 ‚Üì
         S-CE012 (Summary)
                 ‚Üì
         S-CE013 (Navigation)
```

---

## Open Questions

1. **Multiple Contractions**: If multiple teams contract in same season, do they share an expansion draft pool or separate?
   - *Proposed*: Shared pool, alternating picks

2. **Expansion Team Division**: How is new team assigned to division?
   - *Proposed*: User choice with balance recommendation

3. **Protected Players Destination**: Where do protected players go if not drafted?
   - *Current*: Enter Free Agency pool with unprotected players

4. **Expansion Team Salary Cap**: What's the initial cap for new franchises?
   - *Proposed*: League average salary cap

---

*Last Updated: January 29, 2026*
~~~

### Source File: specs/stories/STORIES_DRAFT.md

~~~markdown
# User Stories: Draft Phase

> **Feature Area**: Offseason Phase 7 - Draft
> **Created**: January 29, 2026
> **Updated**: January 29, 2026 - Farm-first draft model
> **Source**: OFFSEASON_SYSTEM_SPEC.md ¬ß9, FARM_SYSTEM_SPEC.md

---

## Overview

The Draft phase fills **Farm roster gaps** with new prospects. All drafted players go to the Farm system first - they can be called up to MLB during the Finalize & Advance phase.

**Key Principle**: Draft ‚Üí Farm ‚Üí (optional) Call-up to MLB

### Roster Structure Reminder
| Level | Size | Notes |
|-------|------|-------|
| MLB Roster | 22 players | Active roster |
| Farm Roster | 10 players | Development pool |
| **Total** | **32 players** | Per team |

### Draft Flow
1. **Pre-Draft**: Optional inactive player additions
2. **Draft Class Generation**: AI-generated prospects (B to C- grades)
3. **Draft Execution**: Fill Farm roster gaps
4. **Summary**: Review all picks

---

## Story Index

| ID | Story | Priority |
|----|-------|----------|
| S-DRF001 | Pre-Draft: Inactive Player Database | P1 |
| S-DRF002 | Draft Class Generation (Farm Prospects) | P0 |
| S-DRF003 | Draft Order Calculation | P0 |
| S-DRF004 | Draft Order Reveal | P1 |
| S-DRF005 | Draft Pick Selection (to Farm) | P0 |
| S-DRF006 | Full Farm Roster Release Rule | P0 |
| S-DRF007 | Released Player Pool | P1 |
| S-DRF008 | Auto-Draft Option | P2 |
| S-DRF009 | Pass/Skip Pick | P1 |
| S-DRF010 | Draft Completion | P0 |
| S-DRF011 | Undrafted Player Retirement | P1 |
| S-DRF012 | Draft Summary | P0 |
| S-DRF013 | Navigation Controls | P0 |

---

## S-DRF001: Pre-Draft: Inactive Player Database

**As a** league commissioner,
**I want** to add retired players back into the draft class,
**So that** legendary players can return to the league.

### Acceptance Criteria

- [ ] **AC-1**: Display list of all players in inactive database (retired players)
- [ ] **AC-2**: Show player name, position, grade at retirement, retirement season
- [ ] **AC-3**: Multi-select checkboxes to choose players for draft
- [ ] **AC-4**: Selected players added to draft pool alongside generated prospects
- [ ] **AC-5**: "Skip" option to proceed with only generated prospects
- [ ] **AC-6**: Search/filter by name, position, grade
- [ ] **AC-7**: Sort by retirement season, grade, or name
- [ ] **AC-8**: Inactive players enter draft at **Farm-appropriate grade** (capped at B if higher)

### Technical Notes

```typescript
interface InactivePlayer {
  playerId: string;
  firstName: string;
  lastName: string;
  position: string;
  gradeAtRetirement: string;
  retirementSeason: number;
  careerStats: {
    seasons: number;
    war: number;
    allStarSelections: number;
  };
  hallOfFame: boolean;
}

function addToActiveDraftPool(
  inactivePlayers: InactivePlayer[],
  draftPool: DraftProspect[]
): DraftProspect[] {
  const reactivated = inactivePlayers.map(p => ({
    id: p.playerId,
    firstName: p.firstName,
    lastName: p.lastName,
    position: p.position,
    // Cap grade at B for Farm system (no A-tier in farm)
    grade: capGradeForFarm(p.gradeAtRetirement),
    age: 18,  // Reset age for returning players (fresh start)
    source: 'INACTIVE_DATABASE',
    originalRetirementSeason: p.retirementSeason
  }));

  return [...draftPool, ...reactivated];
}

function capGradeForFarm(grade: string): string {
  const farmMaxGrades = ['B', 'B-', 'C+', 'C', 'C-'];
  if (farmMaxGrades.includes(grade)) return grade;
  return 'B';  // Cap A+, A, A- at B for farm
}
```

---

## S-DRF002: Draft Class Generation (Farm Prospects)

**As a** league commissioner,
**I want** the system to generate a fictional draft class of Farm prospects,
**So that** there are enough prospects to fill all Farm roster gaps.

### Acceptance Criteria

- [ ] **AC-1**: Auto-generate draft class based on total **Farm roster gaps** across league
- [ ] **AC-2**: **Farm-appropriate grade distribution** (B to C- only, NO A-tier):
  | Grade | Round 1 | Rounds 2-3 | Later Rounds |
  |-------|---------|------------|--------------|
  | B | 25% | 10% | 5% |
  | B- | 35% | 20% | 15% |
  | C+ | 25% | 35% | 30% |
  | C | 10% | 25% | 30% |
  | C- | 5% | 10% | 20% |
- [ ] **AC-3**: Minimum 2 players at each position (C, 1B, 2B, SS, 3B, LF, CF, RF, SP, RP, CP)
- [ ] **AC-4**: Draft class size = max(22, farm_roster_gaps + 10)
- [ ] **AC-5**: Names generated from provided name database
- [ ] **AC-6**: Age range: 18-21 years old (younger prospects)
- [ ] **AC-7**: Random personality assignment
- [ ] **AC-8**: Each prospect has a **Potential Ceiling** rating (what they could become)
- [ ] **AC-9**: All prospects marked as `destination: 'FARM'`
- [ ] **AC-10**: **Gender distribution**: ~25% of generated prospects should be female

### Technical Notes

```typescript
interface FarmProspect {
  id: string;
  firstName: string;
  lastName: string;
  gender: 'M' | 'F';    // ~25% female
  position: Position;
  grade: 'B' | 'B-' | 'C+' | 'C' | 'C-';  // Farm-only grades
  potentialCeiling: 'A' | 'A-' | 'B+' | 'B' | 'B-';  // What they could become
  age: number;          // 18-21
  attributes: PlayerAttributes;
  personality: Personality;
  source: 'GENERATED' | 'INACTIVE_DATABASE';
  destination: 'FARM';  // Always Farm
  yearsInMinors: 0;     // Fresh prospect
}

function generateDraftClass(
  farmRosterGaps: number,
  nameDatabase: NameDatabase
): FarmProspect[] {
  const draftClass: FarmProspect[] = [];

  // Ensure minimum 2 per position
  const positions = ['C', '1B', '2B', 'SS', '3B', 'LF', 'CF', 'RF', 'SP', 'RP', 'CP'];
  for (const pos of positions) {
    draftClass.push(generateFarmProspect(pos, 1, nameDatabase));  // Round 1 quality
    draftClass.push(generateFarmProspect(pos, 2, nameDatabase));  // Round 2 quality
  }

  // Fill remaining slots
  let round = 3;
  while (draftClass.length < Math.max(22, farmRosterGaps + 10)) {
    const randomPos = positions[Math.floor(Math.random() * positions.length)];
    draftClass.push(generateFarmProspect(randomPos, round, nameDatabase));
    round++;
  }

  // Ensure ~25% female distribution
  // Gender assigned per prospect: Math.random() < 0.25 ? 'F' : 'M'
  // NameDatabase should contain both male and female first names

  return draftClass;
}

function generateProspectGrade(round: number): string {
  const roll = Math.random();

  if (round === 1) {
    // Round 1: Better prospects
    if (roll < 0.25) return 'B';
    if (roll < 0.60) return 'B-';
    if (roll < 0.85) return 'C+';
    if (roll < 0.95) return 'C';
    return 'C-';
  } else if (round <= 3) {
    // Rounds 2-3: Standard
    if (roll < 0.10) return 'B';
    if (roll < 0.30) return 'B-';
    if (roll < 0.65) return 'C+';
    if (roll < 0.90) return 'C';
    return 'C-';
  } else {
    // Later rounds: More organizational players
    if (roll < 0.05) return 'B';
    if (roll < 0.20) return 'B-';
    if (roll < 0.50) return 'C+';
    if (roll < 0.80) return 'C';
    return 'C-';
  }
}

function generatePotentialCeiling(currentGrade: string): string {
  const potentialMap = {
    'B':  { 'A': 0.20, 'A-': 0.40, 'B+': 0.30, 'B': 0.10 },
    'B-': { 'A': 0.05, 'A-': 0.25, 'B+': 0.40, 'B': 0.30 },
    'C+': { 'A-': 0.05, 'B+': 0.25, 'B': 0.45, 'B-': 0.25 },
    'C':  { 'B+': 0.10, 'B': 0.30, 'B-': 0.60 },
    'C-': { 'B': 0.15, 'B-': 0.85 },
  };
  return weightedRandomSelect(potentialMap[currentGrade]);
}
```

---

## S-DRF003: Draft Order Calculation

**As a** league commissioner,
**I want** draft order determined by team strength,
**So that** weaker teams get better picks.

### Acceptance Criteria

- [ ] **AC-1**: Calculate average expected WAR per player for each team (MLB roster)
- [ ] **AC-2**: Sort teams by average WAR ascending (worst first)
- [ ] **AC-3**: Use average (not aggregate) to account for roster size differences
- [ ] **AC-4**: Store draft order for multiple rounds
- [ ] **AC-5**: Handle ties by reverse alphabetical (Z picks before A)

### Technical Notes

```typescript
interface DraftOrderEntry {
  teamId: string;
  teamName: string;
  avgExpectedWAR: number;
  pickPosition: number;
  mlbRosterSize: number;
  farmRosterSize: number;
  farmRosterGaps: number;  // 10 - farmRosterSize
}

function calculateDraftOrder(teams: Team[]): DraftOrderEntry[] {
  const entries = teams.map(team => {
    const mlbRoster = team.roster.filter(p => p.level === 'MLB');
    const farmRoster = team.roster.filter(p => p.level === 'FARM');
    const avgWAR = team.totalExpectedWAR / mlbRoster.length;

    return {
      teamId: team.id,
      teamName: team.name,
      avgExpectedWAR: avgWAR,
      pickPosition: 0,
      mlbRosterSize: mlbRoster.length,
      farmRosterSize: farmRoster.length,
      farmRosterGaps: 10 - farmRoster.length
    };
  });

  // Sort by average WAR (worst first)
  entries.sort((a, b) => {
    if (a.avgExpectedWAR !== b.avgExpectedWAR) {
      return a.avgExpectedWAR - b.avgExpectedWAR;
    }
    return b.teamName.localeCompare(a.teamName);
  });

  entries.forEach((entry, index) => {
    entry.pickPosition = index + 1;
  });

  return entries;
}
```

---

## S-DRF004: Draft Order Reveal

**As a** league viewer,
**I want** to see the draft order revealed dramatically,
**So that** there's excitement before picks begin.

### Acceptance Criteria

- [ ] **AC-1**: Display draft order reveal screen before picks begin
- [ ] **AC-2**: Show teams in pick order (1st pick at top)
- [ ] **AC-3**: Display each team's average WAR and **Farm roster gaps**
- [ ] **AC-4**: Highlight user's team position
- [ ] **AC-5**: Option to skip animation and view full order immediately
- [ ] **AC-6**: Proceed to draft execution after reveal

### Technical Notes

```typescript
interface DraftOrderReveal {
  season: number;
  totalTeams: number;
  totalFarmGaps: number;
  order: DraftOrderEntry[];
  userTeamPosition: number;
}
```

---

## S-DRF005: Draft Pick Selection (to Farm)

**As a** team manager,
**I want** to select prospects from the available pool,
**So that** I can fill my **Farm roster** gaps with talent.

### Acceptance Criteria

- [ ] **AC-1**: Display available prospects when team is on the clock
- [ ] **AC-2**: Show prospect details: name, position, grade, **potential ceiling**, age, attributes
- [ ] **AC-3**: Highlight prospects that match team's **Farm roster needs**
- [ ] **AC-4**: Sort/filter by position, grade, potential, age
- [ ] **AC-5**: "Best Fit" recommendation based on Farm gaps
- [ ] **AC-6**: Confirm selection before finalizing pick
- [ ] **AC-7**: Remove selected prospect from available pool
- [ ] **AC-8**: Add prospect to team's **Farm roster** immediately
- [ ] **AC-9**: Display pick confirmation with prospect card showing "‚Üí FARM"

### Technical Notes

```typescript
interface DraftPick {
  round: number;
  pickNumber: number;
  teamId: string;
  teamName: string;
  selectedPlayer: FarmProspect;
  releasedPlayer: Player | null;  // If Farm roster was full
  destination: 'FARM';  // Always Farm
}

interface DraftSelectionContext {
  teamId: string;
  farmRosterSize: number;
  farmRosterGaps: number;  // 10 - farmRosterSize
  positionNeeds: Position[];  // Based on Farm roster composition
  availableProspects: FarmProspect[];
  releasedPlayersPool: Player[];
}

function getRecommendedPick(context: DraftSelectionContext): FarmProspect | null {
  // Find best available that matches a Farm need
  const needMatches = context.availableProspects
    .filter(p => context.positionNeeds.includes(p.position))
    .sort((a, b) => {
      // Sort by grade first, then potential
      const gradeCompare = gradeToValue(b.grade) - gradeToValue(a.grade);
      if (gradeCompare !== 0) return gradeCompare;
      return gradeToValue(b.potentialCeiling) - gradeToValue(a.potentialCeiling);
    });

  if (needMatches.length > 0) return needMatches[0];

  // Otherwise, best available by grade + potential
  return context.availableProspects
    .sort((a, b) => {
      const gradeCompare = gradeToValue(b.grade) - gradeToValue(a.grade);
      if (gradeCompare !== 0) return gradeCompare;
      return gradeToValue(b.potentialCeiling) - gradeToValue(a.potentialCeiling);
    })[0];
}
```

---

## S-DRF006: Full Farm Roster Release Rule

**As a** team manager with a full Farm roster,
**I want** to release a Farm player when drafting,
**So that** I can still acquire new talent.

### Acceptance Criteria

- [ ] **AC-1**: Detect when team has full **Farm roster (10 players)**
- [ ] **AC-2**: Require Farm player release when selecting a prospect
- [ ] **AC-3**: Released player must be **same grade or worse** than prospect
- [ ] **AC-4**: Display eligible release candidates from **Farm roster only**
- [ ] **AC-5**: Cannot complete pick without selecting release candidate
- [ ] **AC-6**: Released player enters "Released Players Pool"
- [ ] **AC-7**: Show warning if releasing B-grade prospect

### Technical Notes

```typescript
function validateDraftPick(
  team: Team,
  prospect: FarmProspect,
  releasedPlayer: Player | null
): { valid: boolean; error?: string } {
  const farmRoster = team.roster.filter(p => p.level === 'FARM');

  // Open Farm slot - no release needed
  if (farmRoster.length < 10) {
    return { valid: true };
  }

  // Full Farm roster - must release someone from Farm
  if (!releasedPlayer) {
    return { valid: false, error: 'Must release a Farm player (Farm roster full at 10)' };
  }

  // Released must be from Farm
  if (releasedPlayer.level !== 'FARM') {
    return { valid: false, error: 'Can only release Farm players during draft' };
  }

  // Released must be same grade or worse
  if (gradeToValue(releasedPlayer.grade) > gradeToValue(prospect.grade)) {
    return {
      valid: false,
      error: `Cannot release ${releasedPlayer.grade} player for ${prospect.grade} prospect`
    };
  }

  return { valid: true };
}

function getEligibleReleaseCandidates(
  farmRoster: Player[],
  prospectGrade: string
): Player[] {
  const prospectValue = gradeToValue(prospectGrade);
  return farmRoster.filter(p => gradeToValue(p.grade) <= prospectValue);
}
```

---

## S-DRF007: Released Player Pool

**As a** team manager,
**I want** to draft released Farm players from other teams,
**So that** I can find value in other teams' discarded prospects.

### Acceptance Criteria

- [ ] **AC-1**: Display released players alongside new prospects
- [ ] **AC-2**: Mark released players distinctly (badge: "Released")
- [ ] **AC-3**: Show releasing team name for context
- [ ] **AC-4**: Released players can be drafted like prospects ‚Üí go to Farm
- [ ] **AC-5**: If undrafted by end, released players retire
- [ ] **AC-6**: Released players retain their existing stats/history

### Technical Notes

```typescript
interface ReleasedPlayer {
  player: Player;
  releasingTeamId: string;
  releasingTeamName: string;
  releaseRound: number;
  releasePickNumber: number;
  previousLevel: 'FARM';  // Only Farm players released during draft
}

interface DraftPool {
  prospects: FarmProspect[];
  releasedPlayers: ReleasedPlayer[];
}
```

---

## S-DRF008: Auto-Draft Option

**As a** team manager,
**I want** to auto-draft the best available prospect to my Farm,
**So that** I can speed through the draft if desired.

### Acceptance Criteria

- [ ] **AC-1**: "Auto-Draft Best Available" button during pick
- [ ] **AC-2**: Auto-selects highest grade + potential prospect matching Farm need
- [ ] **AC-3**: If no need match, selects highest grade + potential overall
- [ ] **AC-4**: If Farm roster full, auto-selects release candidate (lowest grade)
- [ ] **AC-5**: Show confirmation of auto-draft selection
- [ ] **AC-6**: Can enable "Auto-Draft All Remaining" for full automation

### Technical Notes

```typescript
function autoDraft(context: DraftSelectionContext): DraftPick {
  const prospect = getRecommendedPick(context);

  let releasedPlayer = null;
  if (context.farmRosterSize >= 10) {
    // Release lowest grade Farm player
    const farmRoster = context.team.roster.filter(p => p.level === 'FARM');
    releasedPlayer = farmRoster
      .sort((a, b) => gradeToValue(a.grade) - gradeToValue(b.grade))[0];
  }

  return {
    selectedPlayer: prospect,
    releasedPlayer,
    destination: 'FARM'
  };
}
```

---

## S-DRF009: Pass/Skip Pick

**As a** team manager with a full Farm roster,
**I want** to pass on drafting,
**So that** I can keep my current Farm roster intact.

### Acceptance Criteria

- [ ] **AC-1**: "Pass This Round" option available for teams with **full Farm rosters (10)**
- [ ] **AC-2**: Cannot pass if Farm roster has gaps (must draft)
- [ ] **AC-3**: Passing in Round 1 removes team from all subsequent rounds
- [ ] **AC-4**: Confirmation dialog: "Passing now will exit you from the draft"
- [ ] **AC-5**: Minimum one pick rule: all teams must draft at least once
- [ ] **AC-6**: If team hasn't picked yet, pass option disabled in Round 1

### Technical Notes

```typescript
interface PassRules {
  canPass: boolean;
  reason?: string;
}

function canTeamPass(team: Team, hasDraftedThisDraft: boolean): PassRules {
  const farmRoster = team.roster.filter(p => p.level === 'FARM');

  // Must have full Farm roster
  if (farmRoster.length < 10) {
    return { canPass: false, reason: 'Cannot pass with Farm roster gaps' };
  }

  // Must have drafted at least once
  if (!hasDraftedThisDraft) {
    return { canPass: false, reason: 'Must draft at least one player' };
  }

  return { canPass: true };
}
```

---

## S-DRF010: Draft Completion

**As a** league commissioner,
**I want** the draft to end when all Farm rosters are filled,
**So that** we can proceed to the next phase.

### Acceptance Criteria

- [ ] **AC-1**: Draft continues until all teams have **full Farm rosters (10)** AND all teams have drafted at least once
- [ ] **AC-2**: Teams that pass with full Farm rosters exit the draft
- [ ] **AC-3**: Draft ends when no more teams need to pick
- [ ] **AC-4**: Display "Draft Complete" message
- [ ] **AC-5**: Show total picks, total rounds, and round-by-round breakdown
- [ ] **AC-6**: Reminder: "Drafted players are in your Farm system. Call them up during Finalize & Advance."

### Technical Notes

```typescript
function isDraftComplete(
  teams: Team[],
  draftHistory: DraftPick[],
  passedTeams: Set<string>
): boolean {
  for (const team of teams) {
    if (passedTeams.has(team.id)) continue;

    const farmRoster = team.roster.filter(p => p.level === 'FARM');

    // Team has Farm gap - not complete
    if (farmRoster.length < 10) return false;

    // Team hasn't drafted yet - not complete
    const teamPicks = draftHistory.filter(p => p.teamId === team.id);
    if (teamPicks.length === 0) return false;
  }

  return true;
}
```

---

## S-DRF011: Undrafted Player Retirement

**As a** league historian,
**I want** undrafted released players to retire,
**So that** the player pool stays clean.

### Acceptance Criteria

- [ ] **AC-1**: After draft completes, identify all undrafted released players
- [ ] **AC-2**: Auto-retire all undrafted released players
- [ ] **AC-3**: Add to inactive player database
- [ ] **AC-4**: Display retirement notice for each player
- [ ] **AC-5**: Record retirement reason as "Undrafted - Released from Farm"
- [ ] **AC-6**: Offer jersey retirement option for significant players (called up previously)

### Technical Notes

```typescript
interface UndraftedRetirement {
  playerId: string;
  playerName: string;
  position: string;
  grade: string;
  releasingTeamId: string;
  releasingTeamName: string;
  yearsInFarm: number;
  everCalledUp: boolean;
  reason: 'UNDRAFTED_RELEASED';
}

function processUndraftedPlayers(
  releasedPool: ReleasedPlayer[],
  draftHistory: DraftPick[]
): UndraftedRetirement[] {
  const draftedIds = new Set(draftHistory.map(p => p.selectedPlayer.id));

  return releasedPool
    .filter(r => !draftedIds.has(r.player.id))
    .map(r => ({
      playerId: r.player.id,
      playerName: `${r.player.firstName} ${r.player.lastName}`,
      position: r.player.position,
      grade: r.player.grade,
      releasingTeamId: r.releasingTeamId,
      releasingTeamName: r.releasingTeamName,
      yearsInFarm: r.player.yearsInMinors || 0,
      everCalledUp: r.player.mlbDebut !== null,
      reason: 'UNDRAFTED_RELEASED'
    }));
}
```

---

## S-DRF012: Draft Summary

**As a** league commissioner,
**I want** to see a comprehensive draft summary,
**So that** I understand all Farm roster changes.

### Acceptance Criteria

- [ ] **AC-1**: Display summary screen after draft completion
- [ ] **AC-2**: Summary sections:
  - **Top Prospects**: First 5 picks with team, grade, and **potential ceiling**
  - **By Team**: Each team's picks listed (all go to Farm)
  - **By Position**: Picks grouped by position
  - **Released Players**: All players released during draft
  - **Retired (Undrafted)**: Players who retired due to no selection
  - **Inactive Additions**: Players returned from inactive database
- [ ] **AC-3**: Total statistics: picks, rounds, releases, retirements
- [ ] **AC-4**: "View Farm Roster" links to see updated Farm rosters
- [ ] **AC-5**: Export summary option
- [ ] **AC-6**: Continue to next phase button
- [ ] **AC-7**: Note: "All drafted players are in Farm. Use Finalize & Advance to call up to MLB."

### Technical Notes

```typescript
interface DraftSummary {
  seasonId: number;
  totalPicks: number;
  totalRounds: number;
  picksByTeam: Map<string, DraftPick[]>;
  picksByPosition: Map<Position, DraftPick[]>;
  releasedPlayers: ReleasedPlayer[];
  retiredUndrafted: UndraftedRetirement[];
  fromInactiveDB: DraftPick[];
  topPicks: DraftPick[];  // First 5
  gradeDistribution: Map<string, number>;  // B, B-, C+, C, C-
  potentialDistribution: Map<string, number>;  // A, A-, B+, B, B-
  allPicksDestination: 'FARM';  // Reminder
}
```

---

## S-DRF013: Navigation Controls

**As a** user,
**I want** clear navigation through the draft,
**So that** I can track progress and complete the phase.

### Acceptance Criteria

- [ ] **AC-1**: Progress indicator shows current round and pick
- [ ] **AC-2**: Display "On the Clock" team prominently
- [ ] **AC-3**: Show queue of upcoming teams
- [ ] **AC-4**: Timer option for picks (optional, configurable)
- [ ] **AC-5**: Auto-save after each pick
- [ ] **AC-6**: Can exit and resume later (saves draft state)
- [ ] **AC-7**: Show "Teams with Farm Gaps" count
- [ ] **AC-8**: Phase sequence:
  1. Pre-Draft: Inactive Players
  2. Draft Class Generation (auto)
  3. Draft Order Reveal
  4. Draft Execution (rounds) - all picks ‚Üí Farm
  5. Undrafted Retirements
  6. Draft Summary

### Technical Notes

```typescript
interface DraftNavigation {
  currentRound: number;
  currentPick: number;
  totalPicks: number;
  onTheClockTeamId: string;
  upcomingTeams: string[];
  teamsWithFarmGaps: number;
  phase: 'PRE_DRAFT' | 'ORDER_REVEAL' | 'DRAFTING' | 'RETIREMENTS' | 'SUMMARY';
}
```

---

## Dependency Map

```
S-DRF001 (Inactive Player DB)
    ‚Üì
S-DRF002 (Draft Class Generation - Farm Prospects)
    ‚Üì
S-DRF003 (Draft Order Calculation)
    ‚Üì
S-DRF004 (Draft Order Reveal)
    ‚Üì
S-DRF005 (Draft Pick Selection ‚Üí FARM)
    ‚îú‚îÄ‚îÄ‚Üí S-DRF006 (Full Farm Roster Release)
    ‚îÇ         ‚Üì
    ‚îÇ    S-DRF007 (Released Player Pool)
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí S-DRF008 (Auto-Draft Option)
    ‚îÇ
    ‚îî‚îÄ‚îÄ‚Üí S-DRF009 (Pass/Skip Pick)
              ‚Üì
         S-DRF010 (Draft Completion)
              ‚Üì
         S-DRF011 (Undrafted Retirement)
              ‚Üì
         S-DRF012 (Draft Summary)
              ‚Üì
         S-DRF013 (Navigation)
```

---

## Key Differences from Previous Version

| Aspect | Previous (Incorrect) | Current (Correct) |
|--------|---------------------|-------------------|
| Draft Destination | MLB Roster (22) | Farm Roster (10) |
| Max Grade | A- | B |
| Grade Range | A- to C- | B to C- |
| Roster Check | MLB slots | Farm slots |
| Release Pool | MLB players | Farm players |
| Call-up | Immediate | Deferred to Finalize & Advance |
| Rookie Status | N/A | Set during call-up in Finalize |

---

## Integration with Later Phases

### Phase: Trades
- Can trade Farm players to other teams
- Can trade for Farm players from other teams

### Phase: Finalize & Advance
- Call up Farm players to MLB (creates Farm vacancy)
- Send down MLB players to Farm (creates MLB vacancy)
- **Rookie designation**: Any player called up who was just drafted OR has never been called up = Rookie next season
- Must end with: 22 MLB + 10 Farm = 32 players per team
- Then advance to next season

---

## Open Questions

1. **Lottery System**: Should there be a draft lottery for bottom teams?
   - *Current*: Pure reverse average WAR

2. **Compensatory Picks**: Should teams that lost major FA signings get compensatory picks?
   - *Proposed*: Not in initial implementation

3. **International Prospects**: Should there be a separate international signing period?
   - *Proposed*: Defer to future enhancement

---

*Last Updated: January 29, 2026*
~~~

### Source File: specs/stories/STORIES_FINALIZE_ADVANCE.md

~~~markdown
# Finalize & Advance Phase - User Stories

> **Feature Area**: Offseason Final Phase - Finalize & Advance
> **Platform**: iPad-first (1024√ó768 minimum)
> **Created**: January 29, 2026
> **Source**: OFFSEASON_SYSTEM_SPEC.md, FARM_SYSTEM_SPEC.md, User Requirements

---

## Overview

The Finalize & Advance phase is the final offseason phase where users:
1. Make final roster changes (call-ups, send-downs) for their team(s)
2. Review AI-managed roster changes for other teams
3. Validate all rosters meet requirements (22 MLB + 10 Farm = 32 per team)
4. Generate a transaction report to apply changes in SMB4
5. Trigger season transition (ages, salaries, stat resets)
6. **Review Chemistry Rebalancing** (see how roster changes affected team dynamics)
7. Advance to the new season (which starts with an empty schedule)

**Key Principle**: This phase focuses on ROSTER FINALIZATION only. Schedule management happens in the Regular Season after advancing.

---

## Phase Context

**Preceding Phases:**
- Phase 7: Draft (all picks ‚Üí Farm)
- Phase 8: Trade Phase (trade players between teams)

**This Phase:**
- Phase 9: Finalize & Advance

**Following:**
- New Season begins (Regular Season tab, empty schedule)

---

## User Stories

### Section 1: Phase Entry & Team Selection

#### S-FA001: Enter Finalize & Advance Phase
**As a** user completing the Trade Phase
**I want to** enter the Finalize & Advance phase
**So that** I can make final roster adjustments before the new season

**Acceptance Criteria:**
- Phase header shows "Finalize & Advance - Season [X+1] Prep"
- Team selector dropdown defaults to user's primary team
- Can switch between any team in the league
- Current roster status displayed (X/22 MLB, Y/10 Farm)

---

#### S-FA002: Select Team to Manage
**As a** user managing multiple teams or viewing AI teams
**I want to** select any team from a dropdown
**So that** I can view and (for my teams) modify their rosters

**Acceptance Criteria:**
- Dropdown lists all teams alphabetically
- User's team(s) marked with ‚≠ê indicator
- Selecting a team loads their MLB and Farm rosters
- AI-controlled teams show roster but actions are disabled (view-only)
- User-controlled teams show full editing capabilities

---

### Section 2: Roster Viewing

#### S-FA003: View MLB Roster
**As a** user viewing a team's roster
**I want to** see the full 22-player MLB roster
**So that** I can assess who to keep, send down, or replace

**Acceptance Criteria:**
- Shows all MLB players with: Name, Position, Grade, Age, Salary, WAR (last season)
- Indicates roster count: "MLB Roster: 21/22" (with gap indicator if under 22)
- Players sortable by: Position, Grade, Age, Salary, WAR
- Each player row has [Send Down] action button (for user's team)
- Highlights players who are send-down candidates (low grade, high salary, old age)

**Display Fields:**
```
| Name | Pos | Grade | Age | Salary | WAR | Traits | [Action] |
```

---

#### S-FA004: View Farm Roster
**As a** user viewing a team's roster
**I want to** see the full 10-player Farm roster
**So that** I can assess who to call up or keep developing

**Acceptance Criteria:**
- Shows all Farm prospects with: Name, Position, Grade, Potential Ceiling, Age, Years in Minors
- Indicates roster count: "Farm Roster: 9/10" (with gap indicator if under 10)
- Players sortable by: Position, Grade, Potential, Age, Years
- Each player row has [Call Up] action button (for user's team)
- Highlights prospects ready for call-up (high potential, 2+ years in minors)

**Display Fields:**
```
| Name | Pos | Grade | Ceiling | Age | Yrs Minor | [Action] |
```

---

### Section 3: Roster Transactions (User's Team)

#### S-FA005: Call Up Prospect to MLB
**As a** user managing my team
**I want to** call up a Farm prospect to the MLB roster
**So that** I can add young talent to my major league team

**Acceptance Criteria:**
- Clicking [Call Up] opens confirmation modal
- Modal shows:
  - Prospect details (Name, Position, Grade, Ceiling, Age)
  - "This player will be designated as a ROOKIE for the upcoming season"
  - Salary assignment based on grade: B=$1.2M, B-=$0.9M, C+=$0.7M, C=$0.6M, C-=$0.5M
  - Warning if MLB roster is full (must send down someone first)
- On confirm:
  - Prospect moves from Farm to MLB
  - Farm roster decreases by 1
  - MLB roster increases by 1
  - Rookie flag set (if just drafted OR never previously called up)
  - Transaction logged

**Rookie Designation Rules:**
- Player is designated ROOKIE if:
  - They were drafted in the most recent draft, OR
  - They have never been called up to MLB before
- Rookie status lasts for their first MLB season

---

#### S-FA006: Send Down Player to Farm
**As a** user managing my team
**I want to** send down an MLB player to the Farm roster
**So that** I can make room for call-ups or develop struggling players

**Acceptance Criteria:**
- Clicking [Send Down] opens confirmation modal
- Modal shows:
  - Player details (Name, Position, Grade, Age, Salary, WAR)
  - Morale impact: "-15 to -25 morale" (based on tenure)
  - Retirement risk calculation (see formula below)
  - Warning if Farm roster is full (must call up someone first)
  - Warning if player grade is A- or higher: "High-grade players rarely accept demotion"
- On confirm:
  - Player moves from MLB to Farm
  - MLB roster decreases by 1
  - Farm roster increases by 1
  - Morale penalty applied
  - Retirement risk assessed
  - Transaction logged

**Send-Down Retirement Risk Formula:**
```
Base Risk = 0%

if (age >= 35): risk += 40%
else if (age >= 32): risk += 20%
else if (age >= 30): risk += 10%

if (yearsOfService >= 10): risk += 30%
else if (yearsOfService >= 6): risk += 15%

if (salary >= $20M): risk += 20%
else if (salary >= $10M): risk += 10%

if (hasCareerAwards): risk += 15%

risk += (priorDemotions √ó 10%)

Maximum: 90%
```

**Retirement Check:**
- If player retires immediately:
  - Remove from roster entirely
  - Add to Inactive Player Database
  - Display retirement notification
  - No Farm slot consumed

---

#### S-FA007: Swap Players (Call Up + Send Down)
**As a** user managing my team
**I want to** swap a Farm prospect with an MLB player in one action
**So that** I can efficiently manage roster transactions

**Acceptance Criteria:**
- "Swap" button available when viewing either roster
- Opens modal showing:
  - Left side: Select player to send down (from MLB)
  - Right side: Select prospect to call up (from Farm)
  - Combined impact summary (morale, salary, roster balance)
- Both transactions processed atomically
- Single transaction log entry: "Swapped [Player] for [Prospect]"

---

#### S-FA008: Undo Recent Transaction
**As a** user who made a roster change
**I want to** undo my most recent transaction
**So that** I can correct mistakes before finalizing

**Acceptance Criteria:**
- [Undo] button appears after any transaction
- Shows: "Undo: [Transaction description]"
- Clicking undo reverses the transaction
- Undo available until user advances or switches teams
- Maximum undo depth: 5 transactions
- Undo not available for AI-managed transactions

---

### Section 4: AI Roster Management

#### S-FA009: AI Auto-Manages Non-User Teams
**As a** user with AI-controlled teams in the league
**I want** the system to automatically balance their rosters
**So that** all teams are valid without manual intervention

**Acceptance Criteria:**
- AI runs automatically when entering phase (or on demand via [Process AI Teams])
- For each AI team:
  - If MLB < 22: Call up best Farm prospects (by Potential Ceiling)
  - If MLB > 22: Send down worst MLB players (by Grade, then Age)
  - If Farm < 10: Flag as incomplete (rare, usually filled by draft)
  - If Farm > 10: Release worst prospects (lowest Grade + Ceiling)
- AI decisions logged in transaction report
- User can view AI team rosters (read-only)

**AI Call-Up Priority:**
1. Highest Potential Ceiling
2. Highest Current Grade (tie-breaker)
3. Youngest Age (tie-breaker)

**AI Send-Down Priority:**
1. Lowest Grade
2. Oldest Age (tie-breaker)
3. Highest Salary (tie-breaker)

---

#### S-FA010: Review AI Transactions
**As a** user reviewing the league state
**I want to** see what roster changes AI made for other teams
**So that** I understand the competitive landscape

**Acceptance Criteria:**
- "AI Transactions" section shows all AI-made moves
- Grouped by team
- Each transaction shows: Action, Player, From, To
- Can collapse/expand by team
- Printable/exportable with main transaction report

---

### Section 5: Validation

#### S-FA011: Roster Validation Gate
**As a** user attempting to advance
**I want** the system to validate all rosters
**So that** every team has exactly 22 MLB + 10 Farm players

**Acceptance Criteria:**
- Validation runs automatically before advance
- Checks each team: MLB = 22, Farm = 10
- If any team fails:
  - Shows validation errors: "Team X: MLB 21/22 (1 short), Farm 10/10"
  - [Advance] button disabled
  - Links to problem teams for fixing
- If all teams pass:
  - Shows green checkmarks for all teams
  - [Advance] button enabled

**Validation Summary Display:**
```
‚úì Tigers: 22 MLB, 10 Farm
‚úì Sox: 22 MLB, 10 Farm
‚úó Bears: 21 MLB, 10 Farm (1 MLB short)
‚úì Crocs: 22 MLB, 10 Farm
...
```

---

#### S-FA012: Fix Validation Errors
**As a** user with roster validation errors
**I want** clear guidance on how to fix them
**So that** I can proceed to advance

**Acceptance Criteria:**
- Each error shows specific issue and suggested action:
  - "MLB short: Call up a prospect or sign a free agent"
  - "Farm short: This should not happen - contact support"
  - "MLB over: Send down a player"
  - "Farm over: Release a prospect"
- Clicking error navigates to that team's roster view
- Real-time validation updates as changes are made

---

### Section 6: Transaction Report

#### S-FA013: Generate Transaction Report
**As a** user ready to apply changes to SMB4
**I want** a comprehensive list of all roster transactions
**So that** I can accurately replicate changes in the actual game

**Acceptance Criteria:**
- Transaction Report shows ALL changes:
  - User transactions (call-ups, send-downs, swaps)
  - AI transactions (same)
  - Retirements triggered by send-downs
- Organized by team for easy reference
- Each transaction shows:
  - Team name
  - Action type (CALL UP, SEND DOWN, RELEASE, RETIRE)
  - Player name and position
  - Additional context (new salary, rookie status, etc.)

**Report Format:**
```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TRANSACTION REPORT - SEASON 2 PREP
Generated: January 29, 2026
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

TIGERS (User-Controlled)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì CALL UP: Marcus Williams (SS, B) ‚Üí MLB [ROOKIE]
  - Salary: $1.2M
‚úì SEND DOWN: Mike Johnson (SS, C+) ‚Üí Farm
  - Morale: -18

SOX (AI-Controlled)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì CALL UP: Jake Thompson (SP, B) ‚Üí MLB [ROOKIE]
‚úì SEND DOWN: Tom Davis (SP, C) ‚Üí Farm
‚úì RETIRED: Bill Smith (RP, C-) - Declined demotion

[... more teams ...]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SUMMARY
- Total Call-Ups: 12
- Total Send-Downs: 14
- Total Retirements: 3
- All teams validated: 22 MLB + 10 Farm
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

---

#### S-FA014: Export/Print Transaction Report
**As a** user applying changes to SMB4
**I want to** print or export the transaction report
**So that** I can reference it while making changes in the game

**Acceptance Criteria:**
- [Print Report] button generates printer-friendly version
- [Copy to Clipboard] button copies text version
- Report persists and is accessible from Season Archive after advancing

---

### Section 7: Season Transition

#### S-FA015: Season Transition Processing
**As a** user advancing to a new season
**I want** the system to process all season-end updates
**So that** player ages, salaries, and stats are properly updated

**Acceptance Criteria:**
- Processing runs automatically on advance confirmation
- Updates applied:
  - **Player Ages**: All players age +1 year
  - **Salaries**: Recalculated based on new age factor, ratings, traits
  - **Mojo**: Reset to NORMAL for all players
  - **Seasonal Stats**: Cleared (career totals preserved)
  - **Clutch Counters**: Reset to 0
  - **Season Fame**: Reset to 0 (career fame preserved)
  - **Years of Service**: Incremented by 1 for all MLB players
  - **Rookie Status**: Applied to newly called-up players
- Progress indicator shows each step
- Summary displayed on completion

**Age Factor Impact on Salary:**
| Age Range | Factor | Label |
|-----------|--------|-------|
| ‚â§24 | 0.70 | Rookie |
| 25-26 | 0.85 | Pre-Arb |
| 27-29 | 1.00 | Prime |
| 30-32 | 1.10 | Peak |
| 33-35 | 0.95 | Veteran |
| 36+ | 0.80 | Twilight |

---

#### S-FA016: Archive Previous Season
**As a** user advancing to a new season
**I want** the previous season's data archived
**So that** historical records are preserved

**Acceptance Criteria:**
- Archive includes:
  - Final standings
  - All player stats
  - Award winners
  - All transactions
  - Playoff results
  - Championship winner
  - Hall of Fame inductions
  - Retired numbers
- Archive accessible via Museum tab
- Season number incremented

---

### Section 7B: Chemistry Rebalancing

#### S-FA015B: Chemistry Recalculation

**As a** user advancing to a new season
**I want** the system to recalculate team chemistry based on all offseason roster changes
**So that** chemistry reflects the new team dynamics

**Acceptance Criteria:**
- Chemistry recalculated for all teams after roster finalization
- Factors considered:
  - **Veteran Leaders** (+5 to +10): Players with 8+ years who stayed
  - **Teammate Bonds** (+3 per bond): Pairs who played 3+ seasons together
  - **New Players** (-2 each): FA signings, draftees, trade acquisitions
  - **Personality Conflicts** (-5 to -15): Conflicting personality types
  - **Chemistry Drains Departing** (+3 to +10): Low morale players who left
  - **Championship Core** (+10): 3+ players from championship team remain
- Net chemistry change calculated per team
- Results passed to Chemistry Summary screen

**Chemistry Factors Table:**
| Factor | Effect | Trigger |
|--------|--------|---------|
| Veteran Leader | +5 to +10 | 8+ years in league, 3+ with team |
| Teammate Bond | +3 per bond | Pairs with 3+ seasons together |
| New Player | -2 each | FA signings, draftees, trades in |
| Personality Conflict | -5 to -15 | EGOTISTICAL vs TIMID, etc. |
| Chemistry Drain Left | +3 to +10 | Low morale player departed |
| Championship Core | +10 | 3+ championship players remain |

**Technical Notes:**
```typescript
interface ChemistryChange {
  factor: string;
  playerIds: string[];
  delta: number;
  description: string;
  icon: 'üìà' | 'üìâ';
}

interface TeamChemistryResult {
  teamId: string;
  teamName: string;
  previousChemistry: number;
  newChemistry: number;
  netDelta: number;
  changes: ChemistryChange[];
}

function calculateChemistryRebalancing(
  team: Team,
  offseasonMoves: OffseasonMoves
): TeamChemistryResult {
  let delta = 0;
  const changes: ChemistryChange[] = [];

  // Bonus: Chemistry drains who departed
  for (const player of offseasonMoves.departed) {
    if (player.chemistryImpact < 0) {
      const bonus = Math.abs(player.chemistryImpact);
      delta += bonus;
      changes.push({
        factor: 'CHEMISTRY_DRAIN_LEFT',
        playerIds: [player.id],
        delta: bonus,
        description: `${player.name} departed (was chemistry drain)`,
        icon: 'üìà'
      });
    }
  }

  // Bonus: New veteran leaders
  for (const player of team.roster) {
    if (player.yearsInLeague >= 8 &&
        player.seasonsWithTeam >= 3 &&
        !player.hasVeteranLeaderBonus) {
      delta += 5;
      changes.push({
        factor: 'VETERAN_LEADER',
        playerIds: [player.id],
        delta: 5,
        description: `${player.name} became Veteran Leader`,
        icon: 'üìà'
      });
    }
  }

  // Penalty: New players adjustment period
  const newPlayers = team.roster.filter(p => p.seasonsWithTeam === 0);
  if (newPlayers.length > 0) {
    const penalty = newPlayers.length * -2;
    delta += penalty;
    changes.push({
      factor: 'NEW_PLAYERS',
      playerIds: newPlayers.map(p => p.id),
      delta: penalty,
      description: `${newPlayers.length} new player(s) adjusting`,
      icon: 'üìâ'
    });
  }

  // Bonus: Championship core
  const champPlayers = team.roster.filter(p => p.wonChampionshipLastSeason);
  if (champPlayers.length >= 3) {
    delta += 10;
    changes.push({
      factor: 'CHAMPIONSHIP_CORE',
      playerIds: champPlayers.map(p => p.id),
      delta: 10,
      description: `Championship core intact (${champPlayers.length} players)`,
      icon: 'üìà'
    });
  }

  return {
    teamId: team.id,
    teamName: team.name,
    previousChemistry: team.chemistry,
    newChemistry: Math.max(0, Math.min(100, team.chemistry + delta)),
    netDelta: delta,
    changes
  };
}
```

---

#### S-FA015C: Chemistry Summary Screen

**As a** user advancing to a new season
**I want** to see a summary of chemistry changes for all teams
**So that** I understand how roster moves affected team dynamics

**Acceptance Criteria:**
- Screen title: "Chemistry Rebalancing"
- League-wide summary at top:
  - Teams with improved chemistry: X
  - Teams with declined chemistry: Y
  - Teams unchanged: Z
- Team-by-team list showing:
  - Team name and logo
  - Previous chemistry score
  - New chemistry score
  - Net delta (+X or -X)
  - Chemistry rating label (Excellent/Good/Average/Poor/Toxic)
- Expandable detail per team showing individual changes
- [Continue to Advance] button at bottom

**Chemistry Rating Labels:**
| Score | Label | Color |
|-------|-------|-------|
| 80-100 | Excellent | Green |
| 60-79 | Good | Light Green |
| 40-59 | Average | Yellow |
| 20-39 | Poor | Orange |
| 0-19 | Toxic | Red |

**Display Example:**
```
CHEMISTRY REBALANCING
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
League Summary: 5 improved ‚Ä¢ 2 declined ‚Ä¢ 1 unchanged

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Logo] NEW YORK THUNDER                         ‚îÇ
‚îÇ        Chemistry: 64 ‚Üí 72 (+8)    Good üìà       ‚îÇ
‚îÇ        ‚ñº View Changes                           ‚îÇ
‚îÇ        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ        ‚îÇ üìà +8: Barry Bonds departed           ‚îÇ‚îÇ
‚îÇ        ‚îÇ üìà +5: Derek Jeter became Vet Leader  ‚îÇ‚îÇ
‚îÇ        ‚îÇ üìâ -3: Lost bond (Clemens retired)    ‚îÇ‚îÇ
‚îÇ        ‚îÇ üìâ -2: New player (Marcus Williams)   ‚îÇ‚îÇ
‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Logo] BOSTON LEGENDS                           ‚îÇ
‚îÇ        Chemistry: 55 ‚Üí 48 (-7)    Average üìâ    ‚îÇ
‚îÇ        ‚ñº View Changes                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              [Continue to Advance ‚Üí]
```

---

### Section 8: Advance Confirmation

#### S-FA017: Pre-Advance Checklist
**As a** user ready to advance
**I want** a final checklist before committing
**So that** I don't miss any important steps

**Acceptance Criteria:**
- Checklist displays:
  - ‚úì All rosters validated (22 + 10)
  - ‚úì Transaction report generated
  - ‚úì AI teams processed
  - ‚ö†Ô∏è Reminder: "Apply these changes in SMB4 and advance the season there"
- All items must be checked/complete
- Cannot advance with incomplete items

---

#### S-FA018: Advance to New Season
**As a** user completing all finalization steps
**I want to** advance to the new season
**So that** I can begin tracking the next season's games

**Acceptance Criteria:**
- [Begin Season X] button enabled when all validations pass
- Confirmation modal: "Ready to begin Season X?"
- On confirm:
  - Season transition processing runs
  - Previous season archived
  - Season counter incremented
  - Navigate to Regular Season tab
  - Schedule tab shows empty state: "No games scheduled"
  - Today's Game tab shows: "Add games to your schedule to begin"
- No automatic schedule generation (user adds games manually)

---

#### S-FA019: Post-Advance State
**As a** user who just advanced to a new season
**I want** clear guidance on next steps
**So that** I know how to begin the new season

**Acceptance Criteria:**
- Welcome message: "Welcome to Season X!"
- Instructions displayed:
  1. "Apply roster changes to SMB4 using the Transaction Report"
  2. "Advance to the new season in SMB4"
  3. "Add games to your schedule as you play them"
- Quick action buttons:
  - [View Transaction Report]
  - [Go to Schedule]
  - [Add First Game]

---

### Section 9: Schedule Integration (Post-Advance)

#### S-FA020: Empty Schedule State
**As a** user starting a new season
**I want** the Schedule tab to prompt me to add games
**So that** I can build the schedule as I play

**Acceptance Criteria:**
- Schedule tab shows: "No games scheduled for Season X"
- Prominent [+ Add Game] button
- Helper text: "Add games to your schedule as you play them in SMB4"
- Filter dropdown defaults to user's team
- Once games are added, Today's Game tab auto-pulls the next one

---

#### S-FA021: Add Game to Schedule
**As a** user building the season schedule
**I want to** add individual games or series
**So that** I can track all league games

**Acceptance Criteria:**
- [+ Add Game] opens modal:
  - Game Number (auto-incremented, editable)
  - Date/Day (auto-incremented, editable)
  - Away Team (dropdown)
  - Home Team (dropdown)
  - Time (optional, for display)
- [+ Add Series] option:
  - Away Team, Home Team
  - Number of games (1-7)
  - Starting Date/Day
  - Auto-creates sequential games
- Validation: Away ‚â† Home team
- Games appear in Schedule tab immediately

---

#### S-FA022: Today's Game Auto-Pull
**As a** user with games in the schedule
**I want** Today's Game tab to automatically show the next unplayed game
**So that** I can quickly start tracking

**Acceptance Criteria:**
- Today's Game tab finds first game with status = SCHEDULED
- Displays matchup, records, game number
- If no scheduled games: "No games in queue - add games to schedule"
- After completing a game: Auto-advances to next scheduled game
- If queue becomes empty: Prompts to add more games

---

## Data Models

### RosterTransaction
```typescript
interface RosterTransaction {
  id: string;
  timestamp: Date;
  teamId: string;
  type: 'CALL_UP' | 'SEND_DOWN' | 'RELEASE' | 'RETIRE' | 'SWAP';
  playerId: string;
  playerName: string;
  position: Position;
  fromRoster: 'MLB' | 'FARM' | null;
  toRoster: 'MLB' | 'FARM' | 'INACTIVE' | null;
  isRookie: boolean;
  newSalary?: number;
  moralePenalty?: number;
  retirementRisk?: number;
  triggeredBy: 'USER' | 'AI';
  notes?: string;
}
```

### SeasonTransition
```typescript
interface SeasonTransition {
  fromSeason: number;
  toSeason: number;
  timestamp: Date;
  playersAged: number;
  salariesRecalculated: number;
  rookiesDesignated: string[];  // Player IDs
  statsArchived: boolean;
  transactionReport: RosterTransaction[];
}
```

### ScheduledGame
```typescript
interface ScheduledGame {
  id: string;
  seasonNumber: number;
  gameNumber: number;           // 1 to seasonLength
  dayNumber: number;            // For display (Day 1, Day 2, etc.)
  date?: string;                // Optional display date (July 12)
  time?: string;                // Optional time (7:00 PM)
  awayTeamId: string;
  homeTeamId: string;
  status: 'SCHEDULED' | 'IN_PROGRESS' | 'COMPLETED' | 'SKIPPED';
  result?: {
    awayScore: number;
    homeScore: number;
    winningTeamId: string;
  };
  gameLogId?: string;           // Links to full game data
}
```

---

## Business Rules Summary

1. **Roster Requirements**: Every team must have exactly 22 MLB + 10 Farm = 32 players
2. **Call-Up Salary**: Based on grade (B=$1.2M, B-=$0.9M, C+=$0.7M, C=$0.6M, C-=$0.5M)
3. **Rookie Designation**: Applied if player was just drafted OR never previously called up
4. **Send-Down Morale**: -15 to -25 based on player tenure and status
5. **Retirement Risk**: Calculated formula based on age, service, salary, awards, prior demotions
6. **AI Priority**: Call up by Ceiling ‚Üí Grade ‚Üí Age; Send down by Grade ‚Üí Age ‚Üí Salary
7. **Schedule**: Starts empty; user adds games manually; Today's Game auto-pulls from queue
8. **Season Transition**: Ages +1, salaries recalculated, stats reset, season archived

---

## Screen Flow

```
FINALIZE & ADVANCE PHASE
‚îÇ
‚îú‚îÄ‚îÄ Screen 1: Team Roster Management
‚îÇ   ‚îú‚îÄ‚îÄ Team Selector Dropdown
‚îÇ   ‚îú‚îÄ‚îÄ MLB Roster Panel (22 players)
‚îÇ   ‚îú‚îÄ‚îÄ Farm Roster Panel (10 players)
‚îÇ   ‚îî‚îÄ‚îÄ Transaction Actions (Call Up, Send Down, Swap)
‚îÇ
‚îú‚îÄ‚îÄ Screen 2: AI Processing & Review
‚îÇ   ‚îú‚îÄ‚îÄ Process AI Teams Button
‚îÇ   ‚îî‚îÄ‚îÄ AI Transaction Summary
‚îÇ
‚îú‚îÄ‚îÄ Screen 3: Validation Summary
‚îÇ   ‚îú‚îÄ‚îÄ All Teams Checklist
‚îÇ   ‚îî‚îÄ‚îÄ Error Resolution Links
‚îÇ
‚îú‚îÄ‚îÄ Screen 4: Transaction Report
‚îÇ   ‚îú‚îÄ‚îÄ Full Transaction List
‚îÇ   ‚îî‚îÄ‚îÄ Export/Print Options
‚îÇ
‚îú‚îÄ‚îÄ Screen 5: Season Transition
‚îÇ   ‚îú‚îÄ‚îÄ Processing Indicators
‚îÇ   ‚îî‚îÄ‚îÄ Transition Summary
‚îÇ
‚îî‚îÄ‚îÄ Screen 6: Advance Confirmation
    ‚îú‚îÄ‚îÄ Pre-Advance Checklist
    ‚îú‚îÄ‚îÄ Reminder: Apply to SMB4
    ‚îî‚îÄ‚îÄ [Begin Season X] Button

         ‚Üì

REGULAR SEASON (New Season)
‚îú‚îÄ‚îÄ Schedule Tab (Empty ‚Üí Add Games)
‚îî‚îÄ‚îÄ Today's Game Tab (Auto-pulls from schedule)
```

---

*End of User Stories - Finalize & Advance Phase*
~~~

### Source File: specs/stories/STORIES_FREE_AGENCY.md

~~~markdown
# Free Agency Implementation Stories

> **Purpose**: Close all gaps between OFFSEASON_SYSTEM_SPEC.md ¬ß8 (Free Agency) and current implementation.
> **Created**: January 28, 2026
> **Source Gaps**: GAP-002, COHESION_REPORT.md, AUDIT_REPORT.md

---

## Story Dependency Graph

```
S-FA001 (Sign FA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                           ‚îÇ
S-FA002 (Wire Protection) ‚îÄ‚îÄ‚îê                              ‚îÇ
                            ‚îú‚îÄ‚ñ∫ S-FA004 (Dice Roll UI) ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
S-FA003 (Dice Assignment) ‚îÄ‚îÄ‚îò                              ‚îÇ
                                                           ‚îú‚îÄ‚ñ∫ S-FA008 (Two Rounds)
S-FA005 (Personality Dest) ‚îÄ‚î¨‚îÄ‚ñ∫ S-FA007 (Exchange) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
                            ‚îÇ                              ‚îÇ
S-FA006 (H2H Tracking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                              ‚îÇ
                                                           ‚îÇ
                                              S-FA009 (Summary UI) ‚óÑ‚îÄ‚îò
```

---

## S-FA001: Sign Free Agent Action

**Parent Feature:** F-E007 (FreeAgencyHub)
**Priority:** P0 - CRITICAL BLOCKER
**Estimated Size:** Medium
**Closes Gap:** GAP-002

### User Story

**As a** league manager during free agency
**I want to** sign a free agent to my team
**So that** I can add players to my roster

### Acceptance Criteria

**AC-1: Sign Button on FA Card**
- **Given:** FreeAgencyHub displays free agent pool
- **When:** User views any FA card
- **Then:** "Sign to [Team]" button visible with team selector dropdown
- **Verify:** Button present on every FA card

**AC-2: Contract Calculation**
- **Given:** User clicks "Sign" on a free agent
- **When:** Contract modal opens
- **Then:** Display:
  - Calculated salary (per SALARY_SYSTEM_SPEC.md formula)
  - Personality modifier applied (isNewTeam = true)
  - Contract years (default: 1)
- **Verify:** Salary matches `calculateSalary(player, null, null, true)`

**AC-3: Cap Space Validation**
- **Given:** Contract modal is open
- **When:** Team would exceed soft cap ($150M)
- **Then:** Warning displayed: "This signing exceeds soft cap. Fan morale may be affected."
- **Verify:** Warning appears when total payroll + new salary > $150M

**AC-4: Signing Transaction**
- **Given:** User confirms signing
- **When:** Transaction processes
- **Then:**
  1. Player removed from FA pool
  2. Player added to team roster
  3. Player's `teamId` updated
  4. Player's salary set (with personality modifier)
  5. Team payroll recalculated
  6. Transaction logged to `transactionStorage`
- **Verify:** All state updates persist to storage

**AC-5: Roster Limit Check**
- **Given:** Team already has 25 players (full roster)
- **When:** User attempts to sign FA
- **Then:** Prompt: "Roster full. Select a player to release."
- **Verify:** Cannot complete signing without releasing a player

### Technical Notes

```typescript
interface FASigningTransaction {
  type: 'FA_SIGNING';
  playerId: string;
  fromPool: 'FREE_AGENT';
  toTeamId: string;
  salary: number;
  personalityModifier: number;
  timestamp: Date;
  seasonId: string;
}

// Wire to existing transactionStorage.ts (currently orphaned per GAP-041)
```

### Definition of Done
- [ ] Sign button on all FA cards
- [ ] Contract modal with salary calculation
- [ ] Cap space warning
- [ ] Roster limit check
- [ ] Transaction logged
- [ ] FA removed from pool
- [ ] Player appears on team roster
- [ ] Unit tests for signing flow

---

## S-FA002: Wire ProtectedPlayerSelection to FA Flow

**Parent Feature:** F-E008
**Priority:** P0
**Estimated Size:** Small
**Closes Gap:** S-E008 listed as "NOT WIRED (orphaned)"

### User Story

**As a** team manager entering free agency
**I want to** protect one player from leaving via free agency
**So that** my best player cannot be selected by the dice roll

### Acceptance Criteria

**AC-1: Protection Phase Entry**
- **Given:** User completes Retirements phase
- **When:** Free Agency phase begins
- **Then:** ProtectedPlayerSelection modal appears for each team (in sequence or parallel based on league settings)
- **Verify:** Cannot proceed to dice roll without protection selection

**AC-2: Single Selection Enforcement**
- **Given:** ProtectedPlayerSelection modal is open
- **When:** User selects a player
- **Then:** Only ONE player can be selected (radio button, not checkbox)
- **Verify:** Selecting new player deselects previous

**AC-3: Protection Confirmation**
- **Given:** User has selected a player to protect
- **When:** User clicks "Confirm Protection"
- **Then:**
  1. Protected player flagged: `player.isProtectedFA = true`
  2. Player excluded from dice assignment pool
  3. Proceed to next team's protection (or dice roll if all teams done)
- **Verify:** Protected player never appears in dice roll list

**AC-4: UI Display**
- **Given:** ProtectedPlayerSelection renders
- **When:** Viewing roster
- **Then:** Display:
  - Player name, position, grade
  - Recommendation: highlight highest-grade players
  - Dice probability preview (optional)
- **Verify:** Matches wireframe in OFFSEASON_SYSTEM_SPEC.md ¬ß8.2

### Technical Notes

```typescript
// Add to offseason flow state
interface FAProtectionState {
  teamId: string;
  protectedPlayerId: string | null;
  confirmedAt: Date | null;
}

// ProtectedPlayerSelection.tsx already exists - just needs wiring
// Wire to OffseasonFlow.tsx phase progression
```

### Definition of Done
- [ ] Modal appears after Retirements phase
- [ ] Single selection enforced
- [ ] Protection persists to state
- [ ] Protected player excluded from dice pool
- [ ] All teams must protect before dice roll

---

## S-FA003: FA Dice Assignment System

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Medium

### User Story

**As the** free agency system
**I want to** assign dice values (2-12) to eligible players
**So that** better players are more likely to leave (adding drama)

### Acceptance Criteria

**AC-1: Eligible Player Filtering**
- **Given:** A team's roster for free agency
- **When:** Calculating dice assignments
- **Then:**
  1. Exclude protected player
  2. Sort remaining by grade (best first)
  3. Take top 11 players only
- **Verify:** Protected player never in list; exactly 11 players (or fewer if roster < 12)

**AC-2: Dice Value Assignment**
- **Given:** Top 11 eligible players sorted by grade
- **When:** Assigning dice values
- **Then:** Assign in this order: `[7, 6, 8, 5, 9, 4, 10, 3, 11, 2, 12]`
  - Best player ‚Üí 7 (16.67% chance, most likely to leave)
  - 2nd best ‚Üí 6 (13.89%)
  - 3rd best ‚Üí 8 (13.89%)
  - ... continuing pattern
  - 10th best ‚Üí 2 (2.78%, safest)
  - 11th best ‚Üí 12 (2.78%, safest)
- **Verify:** Dice order matches OFFSEASON_SYSTEM_SPEC.md ¬ß8.3

**AC-3: Probability Calculation**
- **Given:** Dice assignments complete
- **When:** Displaying to user
- **Then:** Show probability for each dice value:
  | Dice | Probability |
  |------|-------------|
  | 2, 12 | 2.78% |
  | 3, 11 | 5.56% |
  | 4, 10 | 8.33% |
  | 5, 9 | 11.11% |
  | 6, 8 | 13.89% |
  | 7 | 16.67% |
- **Verify:** Probabilities match two-dice distribution

**AC-4: Tiebreaker for Equal Grades**
- **Given:** Two players have identical grades
- **When:** Sorting for dice assignment
- **Then:** Tiebreaker order:
  1. Higher WAR (current season)
  2. Higher salary
  3. Alphabetical by last name
- **Verify:** Deterministic ordering for identical grades

**AC-5: Manual Reorder Before Roll (User Control)**
- **Given:** Initial dice assignments displayed (auto-sorted by grade)
- **When:** User views the dice assignment table BEFORE rolling
- **Then:**
  1. User can drag-and-drop to reorder players
  2. Dice values stay fixed (7, 6, 8, 5, 9, 4, 10, 3, 11, 2, 12)
  3. Moving a player UP puts them at higher-risk dice values
  4. Moving a player DOWN puts them at lower-risk dice values
  5. "Reset to Default" button restores grade-based auto-sort
- **Example:** User wants to protect their A+ pitcher but is willing to risk their A- shortstop ‚Üí drag shortstop to position 1 (dice value 7)
- **Verify:** User has full control over which players are at risk before committing to roll

### Technical Notes

```typescript
const DICE_ORDER = [7, 6, 8, 5, 9, 4, 10, 3, 11, 2, 12];
const DICE_PROBABILITIES: Record<number, number> = {
  2: 0.0278, 3: 0.0556, 4: 0.0833, 5: 0.1111, 6: 0.1389,
  7: 0.1667,
  8: 0.1389, 9: 0.1111, 10: 0.0833, 11: 0.0556, 12: 0.0278
};

interface FADiceAssignment {
  diceValue: number;
  playerId: string;
  playerName: string;
  position: string;
  grade: string;
  probability: number;
}

function assignDiceValues(
  roster: Player[],
  protectedPlayerId: string
): FADiceAssignment[];

// User can reorder the assignments before rolling
function reorderDiceAssignments(
  assignments: FADiceAssignment[],
  newOrder: string[]  // Array of playerIds in desired order
): FADiceAssignment[] {
  // Dice values stay fixed, players get reassigned
  return newOrder.map((playerId, index) => {
    const player = assignments.find(a => a.playerId === playerId)!;
    return {
      ...player,
      diceValue: DICE_ORDER[index],
      probability: DICE_PROBABILITIES[DICE_ORDER[index]]
    };
  });
}
```

### Definition of Done
- [ ] Filtering excludes protected player
- [ ] Sorting by grade with tiebreakers (default order)
- [ ] Dice values assigned correctly (7 = first position)
- [ ] Probabilities displayed
- [ ] **Drag-and-drop reorder implemented**
- [ ] **"Reset to Default" restores grade-based order**
- [ ] Unit tests for edge cases (< 11 players, ties, reorder)

---

## S-FA004: FA Dice Roll UI

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Medium

### User Story

**As a** team manager in free agency
**I want to** roll dice to determine which player leaves
**So that** there's tension and uncertainty in free agency

### Acceptance Criteria

**AC-1: Dice Roll Display**
- **Given:** Protection phase complete for a team
- **When:** Dice roll UI renders
- **Then:** Display:
  - Two dice images (or single 2-12 control)
  - "ROLL DICE" button
  - Table of all 11 players with assigned dice values (sorted by risk)
  - Probability column showing % chance for each dice value
  - Drag handles (‚ò∞) on each row for reordering
  - "Reset to Default" button to restore grade-based order
  - Protected player shown (grayed out, marked "PROTECTED")
- **Verify:** Matches wireframe in FREE_AGENCY_FIGMA_SPEC.md Screen 2

**AC-2: Manual Reorder Before Roll**
- **Given:** Dice assignment table displayed
- **When:** User drags a player row to a new position
- **Then:**
  1. Player moves to new position in list
  2. Dice values stay fixed to positions (position 1 = dice 7, etc.)
  3. All players' dice values and probabilities update accordingly
  4. Visual feedback during drag (row lifts, drop zone highlighted)
- **Example:** Drag "Barry Bonds" from position 1 (7, 16.7%) to position 10 (2, 2.8%) to protect him
- **Verify:** Reorder reflected immediately, "ROLL DICE" uses new order

**AC-3: Dice Animation**
- **Given:** User clicks "ROLL DICE"
- **When:** Roll animation plays
- **Then:**
  1. Dice tumble animation (1-2 seconds)
  2. Final values shown on dice faces
  3. Sum calculated and displayed prominently
  4. Matched player row highlighted
- **Verify:** Animation adds drama without being too long

**AC-4: Result Display**
- **Given:** Dice roll complete
- **When:** Result shown
- **Then:** Display:
  - "You rolled: [X]"
  - Departing player card (name, position, grade, personality)
  - Personality-based destination preview
  - "Continue" button to proceed to destination resolution
- **Verify:** Correct player selected based on dice sum

**AC-5: Edge Case - No Match**
- **Given:** Team has fewer than 11 non-protected players
- **When:** Dice roll lands on unassigned value
- **Then:**
  - Display: "No player assigned to [X]. No one leaves this round."
  - Proceed to next team
- **Verify:** Graceful handling of small rosters

### Technical Notes

```typescript
interface DiceRollResult {
  die1: number;  // 1-6
  die2: number;  // 1-6
  sum: number;   // 2-12
  matchedPlayer: FADiceAssignment | null;
}

function rollDice(): DiceRollResult {
  const die1 = Math.floor(Math.random() * 6) + 1;
  const die2 = Math.floor(Math.random() * 6) + 1;
  return { die1, die2, sum: die1 + die2, matchedPlayer: null };
}
```

### Definition of Done
- [ ] Dice UI matches wireframe
- [ ] Roll animation works
- [ ] Correct player identified from roll
- [ ] Result card shows player + personality
- [ ] Edge case for unassigned dice value handled
- [ ] Proceed to destination resolution

---

## S-FA005: Personality-Based FA Destination Routing

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Large

### User Story

**As the** free agency system
**I want to** route departing players based on their SMB4 personality
**So that** player movement feels thematic and personality-driven

### Acceptance Criteria

**AC-1: COMPETITIVE Routing**
- **Given:** Departing player has COMPETITIVE personality
- **When:** Resolving destination
- **Then:** Route to team's **rival** (closest to .500 H2H all-time)
- **Verify:** Uses `findRival()` function (see S-FA006)

**AC-2: RELAXED Routing**
- **Given:** Departing player has RELAXED personality
- **When:** Resolving destination
- **Then:**
  1. Roll dice for random team (1-N where N = team count)
  2. If rolls current team, player STAYS
  3. Otherwise, route to rolled team
- **Verify:** Equal probability for all teams including staying

**AC-3: DROOPY Routing**
- **Given:** Departing player has DROOPY personality
- **When:** Resolving destination
- **Then:**
  1. Player RETIRES
  2. Add to retirement flow (HOF check if eligible)
  3. Remove from all rosters and FA pool
- **Verify:** Player gone from league entirely

**AC-4: JOLLY Routing**
- **Given:** Departing player has JOLLY personality
- **When:** Resolving destination
- **Then:** Player STAYS with current team (no move)
- **Verify:** No roster change, no exchange triggered

**AC-5: TOUGH Routing**
- **Given:** Departing player has TOUGH personality
- **When:** Resolving destination
- **Then:** Route to team with **highest team OPS** from just-completed season
- **Verify:** Uses season stats to find highest OPS team

**AC-6: TIMID Routing**
- **Given:** Departing player has TIMID personality
- **When:** Resolving destination
- **Then:** Route to **championship winner** from just-completed season
- **Verify:** Goes to World Series winner

**AC-7: EGOTISTICAL Routing**
- **Given:** Departing player has EGOTISTICAL personality
- **When:** Resolving destination
- **Then:** Route to **worst team** (lowest total team WAR)
- **Verify:** Wants to be the star on a bad team

**AC-8: Destination UI**
- **Given:** Destination resolved
- **When:** Displaying result
- **Then:** Show:
  - Player card
  - Personality badge
  - Destination team (or "RETIRES" / "STAYS")
  - Flavor text explaining why (e.g., "COMPETITIVE: Joins rival team Boston!")
- **Verify:** Matches wireframe in OFFSEASON_SYSTEM_SPEC.md ¬ß8.5

### Technical Notes

```typescript
type FADestinationType =
  | 'RIVAL'
  | 'RANDOM'
  | 'RETIRES'
  | 'STAYS'
  | 'HIGHEST_OPS'
  | 'CHAMPION'
  | 'WORST_TEAM';

interface FADestinationResult {
  destination: Team | null;
  type: FADestinationType;
  flavorText: string;
}

function resolveFADestination(
  player: Player,
  currentTeam: Team,
  allTeams: Team[],
  seasonStats: SeasonStats
): FADestinationResult;
```

### Definition of Done
- [ ] All 7 personality types route correctly
- [ ] RELAXED can result in staying
- [ ] DROOPY triggers retirement
- [ ] Destination UI with flavor text
- [ ] Unit tests for each personality

---

## S-FA006: Head-to-Head Record Tracking

**Parent Feature:** F-E007 (required for COMPETITIVE routing)
**Priority:** P1
**Estimated Size:** Medium

### User Story

**As the** league system
**I want to** track head-to-head records between all teams
**So that** I can calculate rivals for COMPETITIVE free agents

### Acceptance Criteria

**AC-1: H2H Record Storage**
- **Given:** A game completes between Team A and Team B
- **When:** Game result is saved
- **Then:** Update H2H record:
  - `h2hRecords[teamA][teamB].wins++` or `.losses++`
  - `h2hRecords[teamB][teamA]` updated inversely
- **Verify:** H2H updates on every game completion

**AC-2: All-Time Aggregation**
- **Given:** H2H records exist across multiple seasons
- **When:** Querying all-time H2H
- **Then:** Sum all seasons: `{ wins: total, losses: total, winPct: wins/(wins+losses) }`
- **Verify:** Spans all historical seasons

**AC-3: Rival Calculation**
- **Given:** Team needs to find rival
- **When:** `findRival(team)` called
- **Then:**
  1. Get H2H vs all other teams
  2. Calculate `|winPct - 0.500|` for each
  3. Return team with smallest delta
- **Verify:** Closest to .500 wins

**AC-4: Tiebreaker for Rival**
- **Given:** Two teams have identical H2H distance from .500
- **When:** Finding rival
- **Then:** Tiebreaker:
  1. More total games played
  2. Geographic proximity (if implemented)
  3. Alphabetical
- **Verify:** Deterministic rival selection

**AC-5: New League Handling**
- **Given:** League just started (no H2H history)
- **When:** COMPETITIVE player leaves in Season 1
- **Then:** Fallback to random team (same as RELAXED)
- **Verify:** Graceful handling of no history

### Technical Notes

```typescript
interface HeadToHeadRecord {
  teamAId: string;
  teamBId: string;
  wins: number;
  losses: number;
  winPct: number;
}

// Store in franchiseStorage or dedicated h2hStorage
interface H2HStorage {
  records: Record<string, Record<string, HeadToHeadRecord>>;
  getRecord(teamA: string, teamB: string): HeadToHeadRecord;
  updateFromGame(game: CompletedGame): void;
  findRival(teamId: string): string;
}
```

### Definition of Done
- [ ] H2H updates on game completion
- [ ] All-time aggregation works
- [ ] `findRival()` returns closest to .500
- [ ] Tiebreaker implemented
- [ ] Season 1 fallback works
- [ ] Unit tests for edge cases

---

## S-FA007: Player Exchange Rule

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Medium
**Updated:** January 29, 2026 - Changed from grade-based to salary-based matching; removed position type requirement

### User Story

**As the** receiving team in a free agent move
**I want to** give back a player of comparable value
**So that** rosters stay balanced and the losing team gets fair compensation

### Core Rule: Salary-Based Matching (¬±10%)

**The receiving team must return a player within ¬±10% of the incoming player's TRUE VALUE (salary).**

| Scenario | Matching Rule |
|----------|---------------|
| Receiving team has **BETTER** record | Must return player within **+10%** of incoming salary (can't lowball) |
| Receiving team has **WORSE** record | Can return player within **-10%** of incoming salary (slight discount OK) |

**Fallback Rule**: If no player on the receiving team's roster meets the ¬±10% threshold, they **MUST give the player whose salary is CLOSEST to the incoming player's salary** (minimizing the absolute salary difference).

> **Note**: Position type matching is NOT required. Teams can exchange any player for any player (pitcher for position player, etc.) because rosters can be filled via draft picks and farm system call-ups.

### Acceptance Criteria

**AC-1: Salary Matching - Better Team Receives**
- **Given:** Receiving team has BETTER record than losing team
- **When:** Selecting return player
- **Then:** Must return player with salary ‚â• 90% of incoming player's salary
- **Example:** Incoming player = $10M ‚Üí Must return someone ‚â• $9M
- **Verify:** Cannot lowball the worse team

**AC-2: Salary Matching - Worse Team Receives**
- **Given:** Receiving team has WORSE record than losing team
- **When:** Selecting return player
- **Then:** Can return player with salary ‚â• 90% of incoming player's salary (same rule, but practically more flexibility since worse teams often have cheaper rosters)
- **Example:** Incoming player = $10M ‚Üí Must return someone ‚â• $9M
- **Verify:** ¬±10% rule still applies

**AC-3: No Position Restriction**
- **Given:** Any player leaves Team A for Team B
- **When:** Selecting return player
- **Then:** ANY player on receiving team's roster is eligible (regardless of position)
- **Example:** Incoming CF can be exchanged for SP, 1B, or any position
- **Verify:** Position filter is NOT applied
- **Rationale:** Teams can fill positional gaps via draft and farm system call-ups

**AC-4: Fallback - No Eligible Players**
- **Given:** No players on receiving team meet the ¬±10% salary threshold
- **When:** Exchange modal renders
- **Then:**
  1. Display warning: "No players meet salary threshold"
  2. Auto-select the player whose salary is **CLOSEST to the incoming player's salary**
  3. Show this player as "REQUIRED - Closest Available"
- **Example A:** Incoming $25M, roster has $12M, $10M, $9M ‚Üí Give $12M (closest to $25M from below)
- **Example B:** Incoming $5M, roster has $15M, $18M, $20M ‚Üí Give $15M (closest to $5M from above)
- **Verify:** Fallback always produces the valid return player with minimum salary gap

**AC-5: Return Player Selection UI**
- **Given:** Exchange required
- **When:** Receiving team's manager views exchange modal
- **Then:** Display:
  - Incoming player card with salary prominently shown
  - Salary threshold range (e.g., "$9M - $11M eligible")
  - List of ALL eligible return players (within threshold, any position)
  - Ineligible players shown grayed with salary delta (e.g., "Too low: $5M (-50%)")
  - If fallback triggered: "REQUIRED" badge on closest-salary player
- **Verify:** Only valid options selectable (or forced fallback)

**AC-6: Auto-Selection (Optional)**
- **Given:** Exchange modal has "Auto-Select" option
- **When:** User clicks "Auto-Select"
- **Then:** System picks the **closest salary match** within threshold (or fallback if none)
- **Verify:** Valid selection made automatically

**AC-7: Exchange Transaction**
- **Given:** Return player selected
- **When:** Exchange confirmed
- **Then:**
  1. Departing player added to receiving team
  2. Return player added to losing team
  3. Both players' `teamId` updated
  4. Both salaries recalculated (isNewTeam = true, personality modifier applies)
  5. Transaction logged with salary values
- **Verify:** Both roster changes persist

### Technical Notes

```typescript
const SALARY_MATCH_THRESHOLD = 0.10;  // ¬±10%

interface ExchangeEligibility {
  eligible: Player[];
  fallbackPlayer: Player | null;  // Closest salary if no one eligible
  fallbackRequired: boolean;
}

function getExchangeEligibility(
  receivingTeam: Team,
  losingTeam: Team,
  departingPlayer: Player
): ExchangeEligibility {
  const incomingSalary = departingPlayer.trueValue;  // Use TRUE VALUE, not contract
  const minSalary = incomingSalary * (1 - SALARY_MATCH_THRESHOLD);  // 90%
  const maxSalary = incomingSalary * (1 + SALARY_MATCH_THRESHOLD);  // 110%

  // NO position filtering - any player can be exchanged for any player
  // Teams can fill positional gaps via draft and farm system call-ups

  // Filter by salary threshold only
  const eligible = receivingTeam.roster.filter(p =>
    p.trueValue >= minSalary && p.trueValue <= maxSalary
  );

  // If no one eligible, find fallback (player with salary CLOSEST to incoming)
  let fallbackPlayer: Player | null = null;
  let fallbackRequired = false;

  if (eligible.length === 0) {
    fallbackRequired = true;
    // Find player with minimum absolute salary difference from incoming
    const sorted = [...receivingTeam.roster].sort((a, b) => {
      const diffA = Math.abs(a.trueValue - incomingSalary);
      const diffB = Math.abs(b.trueValue - incomingSalary);
      return diffA - diffB;  // Smallest difference first
    });
    fallbackPlayer = sorted[0] || null;
  }

  return { eligible, fallbackPlayer, fallbackRequired };
}

function calculateSalaryMatchPercentage(
  returnPlayerSalary: number,
  incomingPlayerSalary: number
): number {
  return ((returnPlayerSalary - incomingPlayerSalary) / incomingPlayerSalary) * 100;
  // Returns: -5% means 5% below, +8% means 8% above
}
```

### Examples

**Example 1: Normal Match (Cross-Position)**
```
Incoming: Barry Bonds ($15M, LF, from Thunder)
Receiving: Red Sox (better record)
Threshold: $13.5M - $16.5M (¬±10%)

Red Sox Eligible Players (ANY position):
‚úì David Ortiz ($14M, 1B) - Within range
‚úì Manny Ramirez ($16M, LF) - Within range
‚úì Pedro Martinez ($15M, SP) - Within range ‚Üê Pitcher eligible too!
‚úó Johnny Damon ($8M, CF) - Too low (-47%)

User selects: Pedro Martinez (pitcher for outfielder is valid)
Thunder can draft/call-up pitching replacement
```

**Example 2: Fallback Required (All Players Below Threshold)**
```
Incoming: Mike Trout ($25M, CF, from Angels)
Receiving: Rockies (worse record, low payroll team)
Threshold: $22.5M - $27.5M (¬±10%)

Rockies Players by Salary (ALL positions):
- Todd Helton ($12M, 1B) - Below threshold (-52% from $25M)
- Larry Walker ($10M, RF) - Below threshold (-60% from $25M)
- Mike Hampton ($9M, SP) - Below threshold (-64% from $25M)
- (no one meets threshold)

FALLBACK: Find closest to $25M incoming salary
- Helton gap: |$12M - $25M| = $13M
- Walker gap: |$10M - $25M| = $15M
- Hampton gap: |$9M - $25M| = $16M

FALLBACK TRIGGERED: Must give Todd Helton ($12M) - closest to incoming
```

**Example 3: Fallback Required (All Players Above Threshold)**
```
Incoming: Johnny Bench ($5M, C, from Reds)
Receiving: Yankees (big payroll team)
Threshold: $4.5M - $5.5M (¬±10%)

Yankees Players by Salary (ALL positions):
- Derek Jeter ($18M, SS) - Above threshold (+260% from $5M)
- Bernie Williams ($15M, CF) - Above threshold (+200% from $5M)
- Andy Pettitte ($12M, SP) - Above threshold (+140% from $5M)
- (no one meets threshold)

FALLBACK: Find closest to $5M incoming salary
- Pettitte gap: |$12M - $5M| = $7M ‚Üê CLOSEST
- Williams gap: |$15M - $5M| = $10M
- Jeter gap: |$18M - $5M| = $13M

FALLBACK TRIGGERED: Must give Andy Pettitte ($12M) - closest to incoming
```

### Definition of Done
- [ ] ~~Position type matching enforced~~ REMOVED - any position valid
- [ ] ¬±10% salary threshold calculated correctly
- [ ] Fallback rule implemented (closest salary to incoming, any position)
- [ ] UI shows salary threshold range
- [ ] Ineligible players show salary delta
- [ ] Fallback player marked as "REQUIRED - Closest Available"
- [ ] Auto-select picks closest salary match
- [ ] Both rosters update correctly
- [ ] Salaries recalculated with personality modifier
- [ ] Transaction logged with salary values

---

## S-FA008: Two-Round FA Orchestration

**Parent Feature:** F-E007
**Priority:** P0
**Estimated Size:** Medium

### User Story

**As the** league manager
**I want** free agency to run for two complete rounds
**So that** there's more player movement and roster churn

### Acceptance Criteria

**AC-1: Round 1 Flow**
- **Given:** Free agency phase begins
- **When:** Round 1 starts
- **Then:** For each team in order:
  1. Protection selection
  2. Dice roll
  3. Destination resolution
  4. Exchange (if applicable)
- **Verify:** All teams complete Round 1 before Round 2

**AC-2: Round 2 Flow**
- **Given:** Round 1 complete
- **When:** Round 2 starts
- **Then:** Repeat entire process with UPDATED ROSTERS
- **Verify:** New protection, new dice assignment based on current roster

**AC-3: Round Indicator**
- **Given:** FA flow is active
- **When:** Viewing any FA screen
- **Then:** Display "ROUND 1 of 2" or "ROUND 2 of 2" prominently
- **Verify:** Always clear which round user is in

**AC-4: Between-Round Summary**
- **Given:** Round 1 completes
- **When:** Transitioning to Round 2
- **Then:** Display summary of all Round 1 moves:
  - Player ‚Üí Team (reason)
  - Return player ‚Üê Team
- **Verify:** User can review Round 1 before starting Round 2

**AC-5: Final Summary**
- **Given:** Round 2 completes
- **When:** FA phase ends
- **Then:** Display complete FA summary (see S-FA009)
- **Verify:** All moves from both rounds shown

**AC-6: State Persistence**
- **Given:** User exits mid-FA
- **When:** User returns
- **Then:** Resume from exact point (round, team, phase)
- **Verify:** No progress lost

### Technical Notes

```typescript
interface FreeAgencyState {
  currentRound: 1 | 2;
  currentTeamIndex: number;
  currentPhase: 'PROTECTION' | 'DICE_ROLL' | 'DESTINATION' | 'EXCHANGE';
  round1Moves: FAMove[];
  round2Moves: FAMove[];
  protections: Record<string, string>;  // teamId ‚Üí playerId
  isComplete: boolean;
}

// Persist to offseasonStorage
```

### Definition of Done
- [ ] Round 1 completes for all teams
- [ ] Round 2 uses updated rosters
- [ ] Round indicator visible
- [ ] Between-round summary
- [ ] State persists across sessions
- [ ] Final summary shows all moves

---

## S-FA009: FA Summary UI

**Parent Feature:** F-E007
**Priority:** P1
**Estimated Size:** Small

### User Story

**As a** league manager
**I want to** see a summary of all free agency moves
**So that** I can understand how rosters changed

### Acceptance Criteria

**AC-1: Move List Display**
- **Given:** FA phase complete
- **When:** Summary UI renders
- **Then:** Display all moves grouped by round:
  ```
  ROUND 1 MOVES:
  ‚Ä¢ Barry Bonds (A+, LF) NYT ‚Üí BOS (COMPETITIVE - rival)
    Return: David Ortiz (A, 1B)
  ‚Ä¢ Ken Griffey Jr. (A, CF) SEA ‚Üí RETIRED (DROOPY)
  ‚Ä¢ Pedro Martinez (B+, SP) BOS ‚Üí STAYED (JOLLY)

  ROUND 2 MOVES:
  ‚Ä¢ ...
  ```
- **Verify:** Matches format in OFFSEASON_SYSTEM_SPEC.md ¬ß8.7

**AC-2: Team Filter**
- **Given:** Summary displayed
- **When:** User selects a team filter
- **Then:** Show only moves involving that team
- **Verify:** Filter works for any team

**AC-3: Net Change Display**
- **Given:** Summary displayed
- **When:** Viewing team totals
- **Then:** Show per-team:
  - Players gained: X
  - Players lost: Y
  - Net WAR change: +/- Z
  - Net salary change: +/- $M
- **Verify:** Calculations correct

**AC-4: Print/Export**
- **Given:** Summary complete
- **When:** User clicks "Export"
- **Then:** Download as CSV or PDF
- **Verify:** Export includes all move data

### Technical Notes

```typescript
interface FASummary {
  round1Moves: FAMove[];
  round2Moves: FAMove[];
  teamSummaries: Record<string, {
    gained: Player[];
    lost: Player[];
    netWAR: number;
    netSalary: number;
  }>;
}
```

### Definition of Done
- [ ] All moves listed by round
- [ ] Team filter works
- [ ] Net changes calculated
- [ ] Export option functional
- [ ] Accessible from offseason hub after completion

---

## Implementation Order

| Priority | Story | Dependency | Est. Size |
|----------|-------|------------|-----------|
| 1 | S-FA001 (Sign FA) | None | Medium |
| 2 | S-FA002 (Wire Protection) | None | Small |
| 3 | S-FA003 (Dice Assignment) | S-FA002 | Medium |
| 4 | S-FA006 (H2H Tracking) | None | Medium |
| 5 | S-FA004 (Dice Roll UI) | S-FA003 | Medium |
| 6 | S-FA005 (Personality Dest) | S-FA006 | Large |
| 7 | S-FA007 (Exchange) | S-FA005 | Medium |
| 8 | S-FA008 (Two Rounds) | S-FA007 | Medium |
| 9 | S-FA009 (Summary UI) | S-FA008 | Small |

**Total Estimate:** ~9-12 story points (Large effort)

---

## Testing Requirements

### Unit Tests
- `assignDiceValues()` - correct ordering, edge cases
- `resolveFADestination()` - all 7 personalities
- `findRival()` - H2H calculation, tiebreakers
- `getEligibleReturnPlayers()` - grade rules, position matching

### Integration Tests
- Full FA flow: Protection ‚Üí Dice ‚Üí Destination ‚Üí Exchange ‚Üí Round 2
- State persistence across session breaks
- Transaction logging to `transactionStorage`

### E2E Tests
- Complete two-round FA with all personality types
- Verify rosters correct after FA completion
- Summary displays all moves accurately

---

## Appendix: Grade Value Mapping

```typescript
function gradeToValue(grade: string): number {
  const grades: Record<string, number> = {
    'S': 10, 'A+': 9, 'A': 8, 'A-': 7,
    'B+': 6, 'B': 5, 'B-': 4,
    'C+': 3, 'C': 2, 'C-': 1,
    'D+': 0.5, 'D': 0, 'D-': -0.5
  };
  return grades[grade] ?? 5;
}

function decreaseGradeByHalf(grade: string): string {
  const order = ['S', 'A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-'];
  const idx = order.indexOf(grade);
  return order[Math.min(idx + 1, order.length - 1)];
}
```

---

*End of Free Agency Stories*
~~~

### Source File: specs/stories/STORIES_GAMETRACKER_FIXES.md

~~~markdown
# GameTracker Fix Stories

> **Created**: 2026-01-31
> **Source**: BROKEN_IMPLEMENTATION_AUDIT_v2.md (31 issues)
> **Purpose**: Actionable stories for Claude Code to implement fixes

---

## P0 - CRITICAL (Must Fix First)

### GT-001: Fix Fielder Teleportation on Enhanced Field

**Priority**: P0 - CRITICAL
**Issue**: #30
**Blocks**: All spray chart data accuracy

**Problem**:
When dragging a fielder on Enhanced Field, they appear at a WRONG Y coordinate.
- Drag RF to (800, 420) ‚Üí appears at (800, 335) - WRONG!
- Legacy Field works correctly - fielders stay where dropped

**Root Cause**:
Enhanced Field's coordinate transformation is broken. The SVG viewBox or coordinate conversion doesn't preserve the drop location.

**Acceptance Criteria**:
- [ ] Fielder appears at EXACT coordinates where dropped (within 5px tolerance)
- [ ] Ball location stored matches visual drop position
- [ ] Works for all 9 fielder positions
- [ ] Test: Drag CF to y=400, verify they appear at y‚âà400

**Files to Investigate**:
- `src/src_figma/app/components/EnhancedInteractiveField.tsx`
- `src/src_figma/app/components/FieldCanvas.tsx`
- `src/src_figma/app/components/FielderIcon.tsx`
- Compare with Legacy Field coordinate handling

**Fix Approach**:
1. Check how Legacy Field converts screen coords to field coords
2. Apply same logic to Enhanced Field
3. Verify SVG viewBox settings match

---

### GT-002: Make CLASSIFY Button Functional

**Priority**: P0 - CRITICAL
**Issue**: #27, #28
**Blocks**: Recording ANY out via fielder drag

**Problem**:
CLASSIFY button appears after fielder drag but clicking it does NOTHING.
- Single fielder (6): CLASSIFY does nothing
- Full sequence (6-4-3): CLASSIFY does nothing

**Acceptance Criteria**:
- [ ] CLASSIFY button calls the inference engine
- [ ] Single fielder ‚Üí infers fly out or ground out based on ball depth
- [ ] 6-4-3 sequence ‚Üí infers "Ground Out, SS-2B-1B" (or DP if runners on)
- [ ] Shows confirmation modal with inferred play type
- [ ] User can confirm or adjust

**Files to Investigate**:
- `src/src_figma/app/components/EnhancedInteractiveField.tsx` (CLASSIFY onClick)
- `src/src_figma/app/components/playClassifier.ts` (inference engine)
- Trace what happens when CLASSIFY is clicked

**Fix Approach**:
1. Find CLASSIFY button onClick handler
2. Wire it to call `classifyPlay()` from playClassifier.ts
3. Pass throw sequence + ball location to classifier
4. Display result in confirmation modal

---

### GT-003: Remove "HIT or OUT?" Modal (PlayTypeModal)

**Priority**: P0 - CRITICAL
**Issue**: #1, #7

**Problem**:
After CLASSIFY, system asks "Was it a HIT or OUT?" - but we already KNOW:
- Fielder drag = OUT (always)
- Batter drag = HIT (always)

**Spec Says**:
> "The user already told us WHAT happened. Contextual buttons ask 'was there anything SPECIAL about it?'"

**Acceptance Criteria**:
- [ ] PlayTypeModal removed entirely OR only used for edge cases
- [ ] Fielder drag ‚Üí goes directly to OutTypeModal or auto-completes
- [ ] Batter drag ‚Üí goes directly to HitTypeModal
- [ ] No "HIT or OUT?" question ever asked

**Files to Investigate**:
- `src/src_figma/app/components/PlayTypeModal.tsx`
- `src/src_figma/app/components/EnhancedInteractiveField.tsx`
- Find where PlayTypeModal is triggered

**Fix Approach**:
1. Remove PlayTypeModal from the flow
2. After fielder drag + CLASSIFY ‚Üí call OutTypeModal directly
3. After batter drag ‚Üí call HitTypeModal directly

---

### GT-004: Enable Fielder-Only Out Recording

**Priority**: P0 - CRITICAL
**Issue**: #8

**Problem**:
Currently can't record an out by just dragging a fielder. The system seems to require batter involvement.

**Spec Says**:
- Drag fielder to ball location = OUT
- Tap additional fielders = throw sequence
- CLASSIFY infers out type from sequence

**Acceptance Criteria**:
- [ ] Drag fielder ‚Üí builds throw sequence
- [ ] CLASSIFY ‚Üí records out WITHOUT needing batter drag
- [ ] Ground out: 6-3 (SS to 1B)
- [ ] Fly out: 8 (CF catch)
- [ ] Double play: 6-4-3 (with runner on 1st)

**Files to Investigate**:
- `src/src_figma/app/components/EnhancedInteractiveField.tsx`
- Check if there's a flag requiring batter involvement

**Fix Approach**:
1. Ensure throw sequence can be built without batter
2. CLASSIFY should work with fielder-only sequence
3. Complete the out recording flow

---

## P1 - HIGH (Core Functionality)

### GT-005: Fix Fielder Duplication After Drag

**Priority**: P1 - HIGH
**Issue**: #26

**Problem**:
After dragging a fielder, they appear in TWO places:
1. Red box at dropped location (with sequence badge)
2. Original position (faded label)

**Acceptance Criteria**:
- [ ] Fielder appears in ONE location only after drag
- [ ] Original position cleared or clearly shown as "moved from here"
- [ ] No duplicate labels

**Fix Approach**:
1. On drag start, hide or remove original fielder marker
2. On drag end, show fielder at new position only
3. Or: Show "ghost" at original with clear visual distinction

---

### GT-006: Fix HitTypeModal Options

**Priority**: P1 - HIGH
**Issue**: #3

**Problem**:
HitTypeModal shows: **1B, 2B, 3B** (the base result)
Should show: **Ground, Line, Fly** (the trajectory)

The BASE is already known from where the batter was dragged!

**Acceptance Criteria**:
- [ ] HitTypeModal shows "Ground Ball", "Line Drive", "Fly Ball"
- [ ] Base (1B/2B/3B) inferred from batter drop location
- [ ] Selection records hit trajectory for spray chart analysis

**Files to Investigate**:
- `src/src_figma/app/components/HitTypeModal.tsx`

**Fix Approach**:
1. Change HitTypeModal options to Ground/Line/Fly
2. Pass base info separately from trajectory
3. Record both: `{ base: '1B', trajectory: 'ground' }`

---

### GT-007: Add Missing Quick Buttons

**Priority**: P1 - HIGH
**Issue**: #5

**Problem**:
Only 2 quick buttons present: "7+ PITCH" and "HR"
Missing: BB, IBB, HBP, K, ÍùÑ (looking K), D3K

**Spec Says**:
Quick buttons for non-ball-in-play outcomes should be prominent.

**Acceptance Criteria**:
- [ ] BB (Walk) button
- [ ] K (Strikeout swinging) button
- [ ] ÍùÑ (Strikeout looking) button
- [ ] HBP (Hit by pitch) button
- [ ] Optional: IBB, D3K as secondary options

**Files to Investigate**:
- `src/src_figma/app/components/EnhancedInteractiveField.tsx`
- `src/src_figma/app/components/QuickButtons.tsx` (if exists)

**Fix Approach**:
1. Add button row below field: [BB] [K] [ÍùÑ] [HBP] [HR]
2. Each button records the appropriate at-bat result
3. Style consistently with existing buttons

---

### GT-008: Infer Out Type from Throw Sequence

**Priority**: P1 - HIGH
**Issue**: #4

**Problem**:
OutTypeModal asks user to pick out type instead of inferring from throw sequence.

**Inference Logic**:
| Sequence | Inferred Out Type |
|----------|-------------------|
| 8 | Fly Out (F8) |
| 6-3 | Ground Out (6-3) |
| 5 | Ground Out (5 unassisted) |
| 6-4-3 | DP (if runner on 1st) or GO |
| 4-6-3 | DP (if runner on 1st) or GO |
| 1-6-3 | Comebacker, GO |

**Acceptance Criteria**:
- [ ] Out type auto-inferred from throw sequence
- [ ] User shown confirmation, can override if wrong
- [ ] Common patterns auto-detected (6-4-3 DP, etc.)

**Files to Investigate**:
- `src/src_figma/app/components/playClassifier.ts`
- `src/src_figma/app/components/OutTypeModal.tsx`

---

### GT-009: Fix HR Button Flow

**Priority**: P1 - HIGH
**Issue**: #25

**Problem**:
HR button immediately records HR without asking for location.
Should prompt for location first (for spray chart).

**Acceptance Criteria**:
- [ ] HR button ‚Üí prompts "TAP WHERE BALL LEFT YARD"
- [ ] User taps location in outfield
- [ ] Then prompts for distance (optional)
- [ ] Records HR with spray chart data

**Fix Approach**:
1. HR button sets mode to "awaiting HR location"
2. User taps outfield area
3. Show distance input (250-550 ft range)
4. Complete HR recording

---

## P2 - MEDIUM (Polish & UX)

### GT-010: Fix Wasted Space / Scale Field to Viewport

**Priority**: P2 - MEDIUM
**Issue**: #31

**Problem**:
Enhanced Field uses only ~40% of screen width. Huge dead zones on left and right.
Legacy Field uses ~90% - much better.

**Acceptance Criteria**:
- [ ] Field scales to fill available width
- [ ] Maintains proper aspect ratio
- [ ] Works on different screen sizes
- [ ] iPad layout uses space efficiently

**Fix Approach**:
1. Check CSS/SVG viewBox settings
2. Use responsive width like Legacy Field
3. Test on various screen widths

---

### GT-011: Improve Ball Landing Tap Registration

**Priority**: P2 - MEDIUM
**Issue**: #29

**Problem**:
"TAP WHERE BALL LANDED" prompt sometimes doesn't register clicks.
Works in infield but not always in outfield.

**Acceptance Criteria**:
- [ ] Tap anywhere on field registers location
- [ ] Visual feedback when tap registered
- [ ] Works in outfield, infield, and foul territory

**Fix Approach**:
1. Check click/touch event handlers
2. Ensure field SVG receives all pointer events
3. Add visual feedback (dot or pulse) when location registered

---

### GT-012: Add Foul Territory Visual Shading

**Priority**: P2 - MEDIUM
**Issue**: #22

**Problem**:
No visual indication of foul territory on Enhanced Field.

**Acceptance Criteria**:
- [ ] Foul territory shaded differently (lighter green or gray)
- [ ] Foul lines clearly visible
- [ ] Ball drops in foul = auto-detected as foul ball

**Fix Approach**:
1. Add SVG path for foul territory
2. Apply different fill color
3. Update isFoulTerritory() detection if needed

---

### GT-013: Add Stands Area Visual for HR

**Priority**: P2 - MEDIUM
**Issue**: #23

**Problem**:
No visual stands area beyond outfield fence.
Can't drag to stands for HR.

**Acceptance Criteria**:
- [ ] Stands area visible beyond fence (y > 1.0 in spec coords)
- [ ] Different visual treatment (gray/blue)
- [ ] Dragging batter to stands = HR auto-detected

**Fix Approach**:
1. Extend SVG to show stands area
2. Add visual boundary (fence line)
3. Ball in stands ‚Üí auto-classify as HR

---

### GT-014: Fix Base Drop Zone Coordinates

**Priority**: P2 - MEDIUM
**Issue**: #10

**Problem**:
Base drop zones may have incorrect Y coordinates for determining 1B/2B/3B.

**Acceptance Criteria**:
- [ ] Drop near 1B ‚Üí "1B HIT"
- [ ] Drop near 2B ‚Üí "2B HIT"
- [ ] Drop near 3B ‚Üí "3B HIT"
- [ ] Coordinates match visual base positions

**Fix Approach**:
1. Map screen coordinates to base positions
2. Test each base detection
3. Adjust thresholds as needed

---

## P3 - LOW (Nice to Have)

### GT-015: Add Confirmation Modal for Inferred Plays

**Priority**: P3 - LOW
**Issue**: #9

**Problem**:
No confirmation shown for auto-inferred plays.

**Acceptance Criteria**:
- [ ] After inference, show: "6-3 Ground Out - Confirm?"
- [ ] User can confirm (one tap) or adjust
- [ ] Clear display of what was inferred

---

### GT-016: Visual Feedback for Throw Sequence Building

**Priority**: P3 - LOW
**Issue**: #14

**Problem**:
No visual line showing throw path as sequence is built.

**Acceptance Criteria**:
- [ ] Lines drawn between fielders in sequence
- [ ] Animates as fielders are tapped
- [ ] Clear order indication (1, 2, 3 badges)

---

### GT-017: Make Undo Button More Visible

**Priority**: P3 - LOW
**Issue**: #19

**Problem**:
Undo button exists but is hard to find.

**Acceptance Criteria**:
- [ ] Undo button prominently placed
- [ ] Clear undo count indicator
- [ ] Works for all play types

---

## Implementation Order

### Sprint 1: Foundation (GT-001, GT-002)
1. **GT-001**: Fix coordinate teleportation - everything depends on this
2. **GT-002**: Make CLASSIFY button work - core recording flow

### Sprint 2: Core Flow (GT-003, GT-004, GT-006)
3. **GT-003**: Remove "HIT or OUT?" modal
4. **GT-004**: Enable fielder-only outs
5. **GT-006**: Fix HitTypeModal options

### Sprint 3: Quick Actions (GT-005, GT-007, GT-008, GT-009)
6. **GT-005**: Fix fielder duplication
7. **GT-007**: Add missing quick buttons
8. **GT-008**: Auto-infer out types
9. **GT-009**: Fix HR button flow

### Sprint 4: Polish (GT-010 through GT-017)
10. All P2 and P3 issues

---

## Testing Checklist

After fixes, verify:

- [ ] Drag SS to (700, 450) ‚Üí SS appears at (700, 450)
- [ ] Tap 2B, tap 1B ‚Üí sequence shows "6-4-3"
- [ ] Click CLASSIFY ‚Üí shows "Ground Out 6-4-3 - Confirm?"
- [ ] Confirm ‚Üí out recorded, batter advances
- [ ] Drag batter to 1B area ‚Üí "1B HIT" prompt appears
- [ ] Tap ball location ‚Üí HitTypeModal shows Ground/Line/Fly
- [ ] Click BB button ‚Üí walk recorded
- [ ] Click K button ‚Üí strikeout recorded
- [ ] Click HR button ‚Üí prompts for location first
- [ ] Field fills viewport width (no dead zones)

---

*Stories ready for Claude Code implementation*
~~~

### Source File: specs/stories/STORIES_GAP_CLOSERS.md

~~~markdown
# KBL Tracker - Gap Closure Stories

> **Generated**: January 26, 2026
> **Purpose**: User stories to close gaps identified in GAPS_MASTER.md
> **Format**: Ralph Framework (As a/I want/So that, Given/When/Then/Verify)

---

## Story Index

| Story ID | Closes Gap | Title | Priority | Size |
|----------|------------|-------|----------|------|
| NEW-001 | GAP-002 | Sign Free Agent Action | P0 | Medium |
| NEW-002 | GAP-038 | Spring Training Phase | P0 | Medium |
| NEW-003 | GAP-039 | Schedule Generation Phase | P0 | Small |
| NEW-004 | GAP-040 | Farm System Roster View | P1 | Large |
| NEW-005 | GAP-040 | Call Up Player Mid-Season | P1 | Medium |
| NEW-006 | GAP-001 | Player Ratings Storage | P0 | Medium |
| NEW-007 | GAP-003 | Unified Player Database | P0 | Large |
| NEW-008 | GAP-004 | Data Integration Layer | P0 | Large |
| NEW-009 | GAP-031 | Fix Exit Type Double Entry | P1 | Small |
| NEW-010 | GAP-032 | Make Player Names Clickable | P1 | Small |
| NEW-011 | GAP-033 | Display Team Names in Scoreboard | P1 | Small |
| NEW-012 | GAP-034 | Add Lineup Access Panel | P1 | Medium |
| NEW-013 | GAP-041 | Wire Relationship Engine | P1 | Medium |
| NEW-014 | GAP-042 | Wire Aging Engine | P1 | Medium |
| NEW-015 | GAP-046 | Wire Beat Reporter to Fan Morale | P1 | Small |
| NEW-016 | GAP-050 | Enforce Offseason Phase Order | P1 | Small |
| NEW-017 | GAP-051 | Create Farm System State | P1 | Medium |
| NEW-018 | GAP-065 | Add IndexedDB Backup/Restore | P2 | Medium |

---

# CRITICAL PRIORITY (P0)

---

## [NEW-001]: Sign Free Agent Action

**Closes Gap:** GAP-002
**Parent Feature:** F-E007 (FreeAgencyHub)
**Priority:** P0
**Estimated Size:** Medium

**As a** user in free agency
**I want to** sign a free agent to my team
**So that** I can improve my roster

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [ ] No architectural decisions (requires transaction storage decision)
- [x] Clear end state

### Acceptance Criteria

**AC-1: Sign Button on FA Card**
- **Given:** Free agent displayed in FreeAgencyHub
- **When:** User views FA card
- **Then:** "Sign" button visible on each eligible FA card
- **Verify:** Open FreeAgencyHub, find sign button on FA cards

**AC-2: Contract Offer Modal**
- **Given:** User clicks "Sign" on FA
- **When:** Modal opens
- **Then:** Shows contract years, salary, "Confirm" button
- **Verify:** Click sign, see contract details in modal

**AC-3: Player Added to Roster**
- **Given:** User confirms signing
- **When:** Transaction completes
- **Then:** Player on user's roster, cap space reduced, FA removed from pool
- **Verify:** Check roster contains new player, cap space decreased

### Technical Notes
- Use transactionStorage.ts (GAP-026) for recording transaction
- Update GlobalState with new roster
- Remove signed FA from free agent pool

---

## [NEW-002]: Spring Training Phase

**Closes Gap:** GAP-038
**Parent Feature:** F-E001 (OffseasonHub)
**Priority:** P0
**Estimated Size:** Medium

**As a** user completing offseason
**I want to** experience spring training
**So that** my players can prepare for the season

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Spring Training Screen**
- **Given:** Trade phase complete
- **When:** Spring Training phase unlocks
- **Then:** Spring Training screen renders with roster overview
- **Verify:** Navigate to spring training route after trades

**AC-2: Player Development Preview**
- **Given:** Spring Training screen visible
- **When:** User views roster
- **Then:** Projected rating changes shown per player (using agingEngine)
- **Verify:** Find development indicators on player cards

**AC-3: Complete Phase Button**
- **Given:** User reviews spring training
- **When:** User clicks "Complete Spring Training"
- **Then:** Phase marked complete, next phase unlocked
- **Verify:** Progress tracker updates, schedule gen unlocks

### Technical Notes
- Wire agingEngine.ts for development projections
- Add `/offseason/spring-training` route
- Track phase completion state

---

## [NEW-003]: Schedule Generation Phase

**Closes Gap:** GAP-039
**Parent Feature:** F-E001 (OffseasonHub)
**Priority:** P0
**Estimated Size:** Small

**As a** user completing offseason
**I want to** generate the new season schedule
**So that** games can begin

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Schedule Generation Screen**
- **Given:** Spring Training complete
- **When:** Schedule Generation phase unlocks
- **Then:** Schedule configuration screen renders
- **Verify:** Navigate to schedule generation route

**AC-2: Season Length Option**
- **Given:** Schedule screen visible
- **When:** User views options
- **Then:** Season length dropdown (32/48/64/128) available
- **Verify:** Find season length selector with 4 options

**AC-3: Generate and Start**
- **Given:** User configures schedule
- **When:** User clicks "Generate Schedule"
- **Then:** Schedule created, "Start New Season" button appears
- **Verify:** Schedule exists in storage, start button visible

### Technical Notes
- Add `/offseason/schedule-gen` route
- Use existing schedule generation logic
- Transition to SeasonDashboard on start

---

## [NEW-006]: Player Ratings Storage

**Closes Gap:** GAP-001
**Parent Feature:** F-A007 (Player Ratings Input)
**Priority:** P0
**Estimated Size:** Medium

**As a** user creating players
**I want to** have player ratings stored persistently
**So that** salary can be calculated and displayed

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [ ] No architectural decisions (new IndexedDB store)
- [x] Clear end state

### Acceptance Criteria

**AC-1: Ratings Schema Defined**
- **Given:** PlayerRatings type created
- **When:** Schema inspected
- **Then:** Contains: power, contact, speed, fielding, arm, velocity, junk, accuracy
- **Verify:** TypeScript type definition exists in types/

**AC-2: IndexedDB Store Created**
- **Given:** App initializes
- **When:** Database opens
- **Then:** `playerRatings` store exists
- **Verify:** Check IndexedDB in dev tools

**AC-3: CRUD Operations Work**
- **Given:** Ratings storage service
- **When:** Create/Read/Update/Delete called
- **Then:** Operations succeed
- **Verify:** Unit tests pass for all CRUD

### Technical Notes
- Add `playerRatings` store to existing IndexedDB schema
- Create `ratingsStorage.ts` service
- Wire to ManualPlayerInput form

---

## [NEW-007]: Unified Player Database

**Closes Gap:** GAP-003
**Parent Feature:** F-A008 (LeagueBuilder)
**Priority:** P0
**Estimated Size:** Large

**As a** user managing my roster
**I want to** have custom players available in games
**So that** I can play with my created players

### Size Check
- [ ] < 200 lines of code (Large - 300+ lines)
- [x] ‚â§ 3 acceptance criteria
- [ ] No architectural decisions (database unification)
- [x] Clear end state

### Acceptance Criteria

**AC-1: Single Player Store**
- **Given:** Player created via ManualPlayerInput
- **When:** Player saved
- **Then:** Player appears in unified `players` IndexedDB store
- **Verify:** Check IndexedDB, find player in store

**AC-2: Game Can Load Custom Players**
- **Given:** Custom player in unified store
- **When:** Game starts
- **Then:** Custom player available in lineup selection
- **Verify:** Start game, find custom player in roster

**AC-3: Migration from Legacy Store**
- **Given:** Players in old localStorage (`kbl-custom-players`)
- **When:** App initializes
- **Then:** Players migrated to unified store
- **Verify:** Old players appear in new store, old store empty

### Technical Notes
- Create unified `players` store
- Migrate from localStorage to IndexedDB
- Update playerDatabase.ts to read from unified store

---

## [NEW-008]: Data Integration Layer

**Closes Gap:** GAP-004
**Parent Feature:** All Phases B-G
**Priority:** P0
**Estimated Size:** Large

**As a** user navigating the app
**I want to** see real data in all screens
**So that** the app is functional

### Size Check
- [ ] < 200 lines of code (Large - 500+ lines across files)
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Wrapper Components Load Data**
- **Given:** Route wrapper components in App.tsx
- **When:** Route renders
- **Then:** Wrapper fetches real data from IndexedDB
- **Verify:** Navigate to /roster, see real roster data

**AC-2: Loading States Shown**
- **Given:** Data loading in progress
- **When:** Component renders
- **Then:** Loading indicator displayed
- **Verify:** See loading state before data appears

**AC-3: Error States Handled**
- **Given:** Data fetch fails
- **When:** Component renders
- **Then:** Error message displayed with retry option
- **Verify:** Simulate failure, see error UI

### Technical Notes
- Add data loading hooks to each wrapper
- Create useSeasonData, useRosterData, etc. hooks
- Wire GlobalStateProvider to IndexedDB

---

# IMPORTANT PRIORITY (P1)

---

## [NEW-009]: Fix Exit Type Double Entry

**Closes Gap:** GAP-031
**Parent Feature:** GameTracker
**Priority:** P1
**Estimated Size:** Small

**As a** user tracking at-bats
**I want to** select exit type once
**So that** at-bat entry is faster

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Single Exit Type Selection**
- **Given:** User clicks at-bat result (1B, 2B, etc.)
- **When:** AtBatFlow modal opens
- **Then:** Exit type selection is in modal only, no pre-selection
- **Verify:** Click 1B, see modal with exit type options

**AC-2: Auto-Proceed After Selection**
- **Given:** User selects exit type in modal
- **When:** Selection made
- **Then:** Flow proceeds to next step (fielding or confirmation)
- **Verify:** Select exit type, flow advances automatically

**AC-3: No Redundant Clicks**
- **Given:** At-bat flow complete
- **When:** Counting clicks
- **Then:** Exit type selected exactly once
- **Verify:** Track clicks, confirm single selection

### Technical Notes
- Refactor AtBatFlow.tsx to remove pre-modal exit type
- Move all exit type UI into modal
- Ensure state updates correctly

---

## [NEW-010]: Make Player Names Clickable

**Closes Gap:** GAP-032
**Parent Feature:** GameTracker
**Priority:** P1
**Estimated Size:** Small

**As a** user during a game
**I want to** click player names to see their stats
**So that** I can make informed decisions

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Current Batter Clickable**
- **Given:** GameTracker displaying current batter
- **When:** User clicks batter name
- **Then:** PlayerCard modal opens with batter stats
- **Verify:** Click batter name, see PlayerCard

**AC-2: Due-Up Names Clickable**
- **Given:** GameTracker displaying due-up list
- **When:** User clicks any due-up name
- **Then:** PlayerCard modal opens for that player
- **Verify:** Click due-up name, see their PlayerCard

**AC-3: Current Pitcher Clickable**
- **Given:** GameTracker displaying current pitcher
- **When:** User clicks pitcher name
- **Then:** PlayerCard modal opens with pitcher stats
- **Verify:** Click pitcher name, see PlayerCard

### Technical Notes
- Wrap player names with clickable component
- Pass player ID to PlayerCard modal
- Reuse existing PlayerCard component

---

## [NEW-011]: Display Team Names in Scoreboard

**Closes Gap:** GAP-033
**Parent Feature:** GameTracker
**Priority:** P1
**Estimated Size:** Small

**As a** user during a game
**I want to** see team names in the scoreboard
**So that** I know who is playing

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Team Names Displayed**
- **Given:** Game in progress
- **When:** Scoreboard renders
- **Then:** Shows "Sirloins vs Beewolves" (or actual team names)
- **Verify:** Start game, see team names in scoreboard

**AC-2: Home/Away Indicated**
- **Given:** Scoreboard with team names
- **When:** User views scoreboard
- **Then:** Away team on top/left, Home team on bottom/right
- **Verify:** Confirm standard baseball scoreboard layout

**AC-3: Names Persist Through Game**
- **Given:** Game in progress
- **When:** Innings change
- **Then:** Team names remain visible throughout
- **Verify:** Play multiple innings, names always visible

### Technical Notes
- Pass team names to Scoreboard component
- Get team names from game setup or GlobalState
- Update Scoreboard.tsx to display names

---

## [NEW-012]: Add Lineup Access Panel

**Closes Gap:** GAP-034
**Parent Feature:** GameTracker
**Priority:** P1
**Estimated Size:** Medium

**As a** user during a game
**I want to** access the current lineup
**So that** I can view and update mojo/fitness

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Lineup Button Visible**
- **Given:** GameTracker active
- **When:** User views UI
- **Then:** "View Lineup" or "Roster" button visible
- **Verify:** Find lineup access button in GameTracker

**AC-2: Lineup Panel Opens**
- **Given:** User clicks lineup button
- **When:** Panel opens
- **Then:** Shows current lineup with positions, mojo, fitness
- **Verify:** Click button, see lineup with all player data

**AC-3: Mojo/Fitness Visible**
- **Given:** Lineup panel open
- **When:** User views player
- **Then:** Mojo indicator (-2 to +2) and fitness state shown
- **Verify:** Find mojo and fitness badges on each player

### Technical Notes
- Create LineupPanel component or reuse existing
- Wire mojoEngine and fitnessEngine data
- Add toggle button to GameTracker UI

---

## [NEW-013]: Wire Relationship Engine

**Closes Gap:** GAP-041
**Parent Feature:** F-F001 (RelationshipEngine)
**Priority:** P1
**Estimated Size:** Medium

**As a** game system
**I want to** have relationships affect gameplay
**So that** team dynamics matter

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Engine Called at Season Start**
- **Given:** New season starts
- **When:** Season initialization runs
- **Then:** relationshipEngine processes initial relationships
- **Verify:** Check relationship data exists after season start

**AC-2: Relationships Affect Morale**
- **Given:** Player with relationship
- **When:** Morale calculated
- **Then:** Relationship modifiers applied
- **Verify:** Compare morale with/without relationship

**AC-3: Trade Warnings Generated**
- **Given:** Trade proposal includes player with relationship
- **When:** Trade evaluated
- **Then:** Warning shown about relationship impact
- **Verify:** Propose trade, see relationship warning

### Technical Notes
- Wire relationshipEngine.ts to season initialization
- Connect to morale calculations
- Add warning to TradeHub

---

## [NEW-014]: Wire Aging Engine

**Closes Gap:** GAP-042
**Parent Feature:** F-F005 (AgingEngine)
**Priority:** P1
**Estimated Size:** Medium

**As a** game system
**I want to** have players age and develop
**So that** franchise mode feels realistic

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Engine Called at Season End**
- **Given:** Season ends
- **When:** Season end processing runs
- **Then:** agingEngine processes all player ages
- **Verify:** Check player ages incremented after season

**AC-2: Development Applied**
- **Given:** Player under 30
- **When:** Aging processes
- **Then:** Appropriate development curve applied
- **Verify:** Young player stats improve per curve

**AC-3: Retirement Probability Calculated**
- **Given:** Player over 35
- **When:** Offseason starts
- **Then:** Retirement probability calculated and displayed
- **Verify:** See retirement chance on older players

### Technical Notes
- Wire agingEngine.ts to season end processing
- Add age field to player display
- Connect to RetirementsScreen

---

## [NEW-015]: Wire Beat Reporter to Fan Morale

**Closes Gap:** GAP-046
**Parent Feature:** F-F001 (NarrativeEngine)
**Priority:** P1
**Estimated Size:** Small

**As a** game system
**I want to** have news stories affect fan morale
**So that** narrative has consequences

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Story Generates Morale Impact**
- **Given:** narrativeEngine generates story
- **When:** Story created
- **Then:** calculateStoryMoraleImpact() called
- **Verify:** Check morale impact value on story

**AC-2: Fan Morale Updated**
- **Given:** Story with morale impact
- **When:** Story published
- **Then:** fanMoraleEngine receives impact
- **Verify:** Fan morale changes after story

**AC-3: Impact Visible in UI**
- **Given:** Story affected morale
- **When:** User views FanMoralePanel
- **Then:** Morale change reflected
- **Verify:** See morale change after story publishes

### Technical Notes
- Wire narrativeEngine output to fanMoraleEngine input
- Use existing calculateStoryMoraleImpact()
- Update fan morale state

---

## [NEW-016]: Enforce Offseason Phase Order

**Closes Gap:** GAP-050
**Parent Feature:** F-E001 (OffseasonHub)
**Priority:** P1
**Estimated Size:** Small

**As a** user in offseason
**I want to** complete phases in order
**So that** the flow makes sense

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Future Phases Locked**
- **Given:** User on Phase 2 (Ratings)
- **When:** User views OffseasonHub
- **Then:** Phases 3-11 show as locked
- **Verify:** Try to click locked phase, nothing happens

**AC-2: Completed Phases Accessible**
- **Given:** User completed Phase 3
- **When:** User views OffseasonHub
- **Then:** Phases 1-3 accessible, 4+ locked until 3 done
- **Verify:** Can revisit completed phases

**AC-3: Completion Unlocks Next**
- **Given:** User completes current phase
- **When:** "Complete" clicked
- **Then:** Next phase unlocks
- **Verify:** Click complete, next phase clickable

### Technical Notes
- Add phase state to GlobalState
- Track completion status per phase
- Add visual lock/unlock indicators

---

## [NEW-017]: Create Farm System State

**Closes Gap:** GAP-051
**Parent Feature:** F-FARM (New)
**Priority:** P1
**Estimated Size:** Medium

**As a** game system
**I want to** track minor league rosters
**So that** farm system can function

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Farm Roster Store Exists**
- **Given:** App initialized
- **When:** Database checked
- **Then:** `farmRosters` IndexedDB store exists
- **Verify:** Check IndexedDB for store

**AC-2: Players Assignable to Farm**
- **Given:** Player in system
- **When:** Player assigned to farm
- **Then:** Player appears in farm roster
- **Verify:** Assign player, check farm roster

**AC-3: Farm Separate from MLB**
- **Given:** Farm roster and MLB roster
- **When:** Rosters queried
- **Then:** Distinct lists returned
- **Verify:** Query both, no overlap

### Technical Notes
- Add `farmRosters` store
- Add `rosterLevel` field to player
- Create farmStorage.ts service

---

# LOWER PRIORITY (P2)

---

## [NEW-018]: Add IndexedDB Backup/Restore

**Closes Gap:** GAP-065
**Parent Feature:** Data Safety
**Priority:** P2
**Estimated Size:** Medium

**As a** user with valuable data
**I want to** backup and restore my data
**So that** I don't lose progress

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Export Button Exists**
- **Given:** User in settings or menu
- **When:** User clicks "Export Data"
- **Then:** JSON file downloads with all data
- **Verify:** Click export, file downloads

**AC-2: Import Button Exists**
- **Given:** User has backup JSON
- **When:** User clicks "Import Data" and selects file
- **Then:** Data restored to IndexedDB
- **Verify:** Import backup, data appears

**AC-3: Import Overwrites Cleanly**
- **Given:** Existing data in app
- **When:** User imports backup
- **Then:** Old data replaced with backup
- **Verify:** Import different save, see new data

### Technical Notes
- Use dataExportService.ts (GAP-028)
- Add UI in settings
- Handle version migration if needed

---

# SUMMARY

## Stories by Priority

| Priority | Count | Stories |
|----------|-------|---------|
| P0 (Critical) | 6 | NEW-001, NEW-002, NEW-003, NEW-006, NEW-007, NEW-008 |
| P1 (Important) | 9 | NEW-009 through NEW-017 |
| P2 (Lower) | 1 | NEW-018 |
| **Total** | **16** | |

## Estimated Effort

| Size | Count | Est. Lines |
|------|-------|------------|
| Small | 6 | <100 each |
| Medium | 8 | 100-200 each |
| Large | 2 | 300+ each |

---

*Document generated January 26, 2026*
~~~

### Source File: specs/stories/STORIES_LEAGUE_BUILDER.md

~~~markdown
# League Builder & Season Setup User Stories

> **Purpose**: User stories for implementing the League Builder hub and Season Setup wizard
> **Created**: January 29, 2026
> **Status**: DRAFT
> **Related**: LEAGUE_BUILDER_SPEC.md, SEASON_SETUP_SPEC.md, GRADE_ALGORITHM_SPEC.md

---

## Story Index

| Module | Stories | Priority |
|--------|---------|----------|
| League Builder Hub | LB-001 to LB-005 | P0 |
| LEAGUES Module | LB-010 to LB-015 | P0 |
| TEAMS Module | LB-020 to LB-027 | P0 |
| PLAYERS Module | LB-030 to LB-040 | P0 |
| ROSTERS Module | LB-050 to LB-057 | P1 |
| DRAFT Module | LB-060 to LB-067 | P1 |
| RULES Module | LB-070 to LB-078 | P1 |
| Season Setup Wizard | SS-001 to SS-012 | P0 |
| Playoff Mode | SS-020 to SS-025 | P1 |

---

## Module: League Builder Hub

### LB-001: League Builder Navigation Entry
**Priority**: P0
**As a** user
**I want** to access League Builder from the main menu
**So that** I can customize leagues, teams, and players before starting a franchise

**Acceptance Criteria**:
- [ ] "League Builder" button appears on Main Menu
- [ ] Button navigates to `/league-builder` route
- [ ] League Builder hub displays 6-module grid (LEAGUES, TEAMS, PLAYERS, ROSTERS, DRAFT, RULES)
- [ ] Back button returns to Main Menu

---

### LB-002: League Builder Hub Layout
**Priority**: P0
**As a** user
**I want** a clear hub interface showing all customization modules
**So that** I can easily navigate to the section I need

**Acceptance Criteria**:
- [ ] 2x3 grid layout with module cards
- [ ] Each card shows module name and brief description
- [ ] Each card is clickable and navigates to respective module
- [ ] Current leagues list appears below the grid
- [ ] League list shows name, team count, and click-to-expand details

---

### LB-003: Current Leagues List
**Priority**: P0
**As a** user
**I want** to see all my saved leagues on the League Builder hub
**So that** I can quickly access or modify existing leagues

**Acceptance Criteria**:
- [ ] List displays all saved LeagueTemplate records from storage
- [ ] Each entry shows: league name, team count, default rules preset
- [ ] Clicking a league expands inline details (conferences, divisions)
- [ ] Edit button on each league opens LEAGUES module with that league loaded
- [ ] "Create New League" button at bottom of list

---

### LB-004: Module Navigation Persistence
**Priority**: P1
**As a** user
**I want** my work in progress to be preserved when switching modules
**So that** I don't lose unsaved changes

**Acceptance Criteria**:
- [ ] Unsaved changes prompt "Save before leaving?" dialog
- [ ] User can choose Save, Don't Save, or Cancel
- [ ] State persists in session storage during module switches
- [ ] Full save commits to IndexedDB

---

### LB-005: League Builder IndexedDB Stores
**Priority**: P0
**As a** developer
**I want** dedicated IndexedDB stores for League Builder data
**So that** leagues, teams, players, and rules persist between sessions

**Acceptance Criteria**:
- [ ] `leagueTemplates` store for LeagueTemplate records
- [ ] `globalTeams` store for Team records
- [ ] `globalPlayers` store for Player records (extends existing playerDatabase)
- [ ] `rulesPresets` store for RulesPreset records
- [ ] `teamRosters` store for TeamRoster records
- [ ] CRUD operations for each store

---

## Module: LEAGUES

### LB-010: View Leagues List
**Priority**: P0
**As a** user
**I want** to see all my saved league templates
**So that** I can choose which one to edit or use

**Acceptance Criteria**:
- [ ] LEAGUES module shows list of all LeagueTemplate records
- [ ] Each entry displays: name, team count, conference/division structure
- [ ] Clicking a league loads it for editing
- [ ] "Create New League" button at top

---

### LB-011: Create New League
**Priority**: P0
**As a** user
**I want** to create a new league template
**So that** I can define a custom competitive structure

**Acceptance Criteria**:
- [ ] Step 1: Name & Description (required: name; optional: description, logo, color)
- [ ] Step 2: Select Teams (multi-select from global team pool)
- [ ] Step 3: Configure Structure (conferences: 0/1/2; divisions per conference)
- [ ] Step 4: Assign Teams to Divisions (drag-drop or select)
- [ ] Step 5: Select Default Rules Preset
- [ ] Step 6: Review & Save
- [ ] Cancel returns to leagues list without saving

---

### LB-012: Edit Existing League
**Priority**: P0
**As a** user
**I want** to modify a saved league template
**So that** I can update team membership or structure

**Acceptance Criteria**:
- [ ] All fields from creation flow are editable
- [ ] Changes do not affect active franchises using this template
- [ ] Save updates the LeagueTemplate in storage
- [ ] "Save As New" creates a copy with new ID

---

### LB-013: Delete League Template
**Priority**: P1
**As a** user
**I want** to delete a league template I no longer need
**So that** I can keep my league list organized

**Acceptance Criteria**:
- [ ] Delete button on league detail view
- [ ] Confirmation dialog: "Delete [League Name]? This cannot be undone."
- [ ] Warning if league is referenced by active franchises
- [ ] Removes from `leagueTemplates` store on confirm

---

### LB-014: Duplicate League Template
**Priority**: P1
**As a** user
**I want** to duplicate a league template
**So that** I can use an existing league as a starting point

**Acceptance Criteria**:
- [ ] "Duplicate" button on league detail view
- [ ] Creates new LeagueTemplate with "[Original Name] Copy" as name
- [ ] Opens in edit mode for immediate customization
- [ ] Assigns new unique ID

---

### LB-015: League Structure Visualization
**Priority**: P1
**As a** user
**I want** to see a visual representation of my league structure
**So that** I can verify conference/division assignments

**Acceptance Criteria**:
- [ ] Tree view showing: League ‚Üí Conferences ‚Üí Divisions ‚Üí Teams
- [ ] Teams display with logo (if available) and abbreviation
- [ ] Drag-and-drop to reassign teams between divisions
- [ ] Unassigned teams appear in "Free Pool" section

---

## Module: TEAMS

### LB-020: View Teams List
**Priority**: P0
**As a** user
**I want** to see all teams in the global team pool
**So that** I can manage and edit team details

**Acceptance Criteria**:
- [ ] Grid or list view of all Team records
- [ ] Each entry shows: logo, name, abbreviation, leagues membership
- [ ] Filter by: league membership, city/location, name search
- [ ] Sort by: name, location, created date

---

### LB-021: Create New Team
**Priority**: P0
**As a** user
**I want** to create a new team from scratch
**So that** I can add custom teams to my leagues

**Acceptance Criteria**:
- [ ] Form fields per Team interface: name, abbreviation, location, nickname
- [ ] Color picker for primary, secondary, accent colors
- [ ] Logo upload (PNG/SVG, max 500KB)
- [ ] Stadium name input
- [ ] Optional: founded year, championships count
- [ ] Save creates Team in `globalTeams` store

---

### LB-022: Edit Existing Team
**Priority**: P0
**As a** user
**I want** to edit a saved team's details
**So that** I can update branding or information

**Acceptance Criteria**:
- [ ] All creation fields are editable
- [ ] Changes reflect across all leagues containing this team
- [ ] Warning if team is in active franchises
- [ ] Save updates Team in storage

---

### LB-023: Delete Team
**Priority**: P1
**As a** user
**I want** to delete a team I no longer need
**So that** I can remove outdated or test teams

**Acceptance Criteria**:
- [ ] Delete button with confirmation dialog
- [ ] Cannot delete if team is in active franchises (hard block)
- [ ] If in leagues, prompt: "Remove from X leagues and delete?"
- [ ] Also deletes associated TeamRoster

---

### LB-024: Assign Team to Leagues
**Priority**: P0
**As a** user
**I want** to add a team to multiple leagues
**So that** the same team can compete in different league configurations

**Acceptance Criteria**:
- [ ] "League Membership" section in team editor
- [ ] Checkbox list of all available leagues
- [ ] Toggle to add/remove team from each league
- [ ] Updates both Team.leagueIds and LeagueTemplate.teamIds

---

### LB-025: Team CSV Import
**Priority**: P1
**As a** user
**I want** to import multiple teams from a CSV file
**So that** I can bulk-create teams efficiently

**Acceptance Criteria**:
- [ ] "Import CSV" button in TEAMS module
- [ ] File upload accepting .csv files
- [ ] Preview parsed data in table format
- [ ] Validation: check required fields, duplicate names
- [ ] Error highlighting for invalid rows
- [ ] Confirm imports valid rows, skips invalid with report

**CSV Format**:
```csv
name,abbreviation,location,nickname,primaryColor,secondaryColor,accentColor,logoUrl,stadium
```

---

### LB-026: Team Logo Management
**Priority**: P1
**As a** user
**I want** to upload and manage team logos
**So that** teams have visual identity in the app

**Acceptance Criteria**:
- [ ] Image upload supporting PNG, JPG, SVG
- [ ] Max file size: 500KB
- [ ] Image preview in editor
- [ ] Logo stored as base64 or file path reference
- [ ] Fallback to abbreviation badge if no logo

---

### LB-027: Team Color Palette
**Priority**: P1
**As a** user
**I want** to set team colors with a visual picker
**So that** UI elements use correct branding

**Acceptance Criteria**:
- [ ] Color picker component for each color slot
- [ ] Hex input field for manual entry
- [ ] Preview panel showing colors applied to sample UI elements
- [ ] Contrast checker for text readability

---

## Module: PLAYERS

### LB-030: View Players Database
**Priority**: P0
**As a** user
**I want** to browse all players in the global database
**So that** I can find, review, and edit player details

**Acceptance Criteria**:
- [ ] Paginated table/grid of all Player records
- [ ] Columns: name, position, grade, team (or Free Agent)
- [ ] Filters: position, grade range, team, bats/throws
- [ ] Search by name
- [ ] Click row to open player editor

---

### LB-031: Create New Player
**Priority**: P0
**As a** user
**I want** to create a custom player with all attributes
**So that** I can add any player I want to the database

**Acceptance Criteria**:
- [ ] Full player editor form (per LEAGUE_BUILDER_SPEC.md Section 5.4)
- [ ] Identity: first name, last name, nickname, gender
- [ ] Physical: age, bats, throws
- [ ] Position: primary (required), secondary (optional)
- [ ] Ratings sliders 0-99 for all 5 batting stats
- [ ] Ratings sliders 0-99 for all 3 pitching stats (if pitcher/two-way)
- [ ] Arsenal multi-select (if pitcher)
- [ ] Traits dropdown (2 slots)
- [ ] Personality & Chemistry dropdowns
- [ ] Status: morale, mojo, fame sliders
- [ ] Team assignment dropdown
- [ ] Grade auto-calculates from weighted ratings
- [ ] Salary auto-calculates from formula
- [ ] Save creates Player in `globalPlayers` store

---

### LB-032: Edit Existing Player
**Priority**: P0
**As a** user
**I want** to edit any attribute of a saved player
**So that** I can update ratings, traits, or team assignment

**Acceptance Criteria**:
- [ ] All fields from creation are editable
- [ ] Grade and salary recalculate on rating changes
- [ ] Changes reflect in all contexts using this player
- [ ] Save updates Player in storage

---

### LB-033: Delete Player
**Priority**: P1
**As a** user
**I want** to delete a player from the database
**So that** I can remove test or unwanted players

**Acceptance Criteria**:
- [ ] Delete button with confirmation
- [ ] Cannot delete if player is in active franchise roster (warning + skip)
- [ ] Removes from team roster if assigned
- [ ] Deletes from `globalPlayers` store

---

### LB-034: Auto-Calculate Grade
**Priority**: P0
**As a** developer
**I want** grades to calculate automatically from ratings
**So that** grades always reflect the weighted rating formula

**Acceptance Criteria**:
- [ ] Position players: POW√ó0.30 + CON√ó0.30 + SPD√ó0.20 + FLD√ó0.10 + ARM√ó0.10
- [ ] Pitchers: (VEL + JNK + ACC) / 3
- [ ] Two-way: (positionWeighted + pitcherWeighted) √ó 1.25
- [ ] Grade assigned per GRADE_ALGORITHM_SPEC.md thresholds
- [ ] Grade field is read-only (display only)
- [ ] Updates in real-time as sliders change

---

### LB-035: Auto-Calculate Salary
**Priority**: P0
**As a** developer
**I want** salary to calculate automatically from ratings and modifiers
**So that** salaries reflect player value per SALARY_SYSTEM_SPEC.md

**Acceptance Criteria**:
- [ ] Base calculation: (weightedRating / 100)^2.5 √ó $50M √ó positionMult √ó traitMod
- [ ] Position multipliers applied (C: +15%, SS: +12%, etc.)
- [ ] Trait modifiers applied (¬±10%, ¬±5%, ¬±2%)
- [ ] Two-way bonus: √ó 1.25
- [ ] Salary field is read-only (display only)
- [ ] Updates in real-time as ratings/traits change

---

### LB-036: Generate Fictional Players
**Priority**: P1
**As a** user
**I want** to generate random players matching a target grade
**So that** I can quickly populate rosters with balanced prospects

**Acceptance Criteria**:
- [ ] "Generate Players" button in PLAYERS module
- [ ] Configuration modal:
  - Count: 1-50
  - Target grade: dropdown (S through D-)
  - Position distribution: balanced / random / specific position
  - Gender ratio slider
  - Age range min/max
  - Include traits: toggle + pool selection
- [ ] Generation uses GRADE_ALGORITHM_SPEC.md reverse algorithm
- [ ] Generated players added to `globalPlayers` store
- [ ] Preview before confirming generation

---

### LB-037: Player CSV Import
**Priority**: P1
**As a** user
**I want** to import players from a CSV file
**So that** I can bulk-add players from external sources

**Acceptance Criteria**:
- [ ] "Import CSV" button in PLAYERS module
- [ ] File upload for .csv
- [ ] Column mapping UI for non-standard formats
- [ ] Validation of required fields and value ranges
- [ ] Grade calculation applied to imported players
- [ ] Error report for invalid rows

---

### LB-038: Player Photo/Avatar
**Priority**: P2
**As a** user
**I want** to upload or generate player photos
**So that** player cards have visual identity

**Acceptance Criteria**:
- [ ] Photo upload supporting PNG, JPG
- [ ] Max size: 200KB
- [ ] Fallback: generated avatar from initials + colors
- [ ] Photo displayed in player card and roster views

---

### LB-039: View Player Career Stats
**Priority**: P1
**As a** user
**I want** to view and edit a player's career statistics
**So that** I can track historical performance

**Acceptance Criteria**:
- [ ] "Career Stats" tab in player editor
- [ ] Displays season-by-season statistics
- [ ] Read-only for stats from completed franchises
- [ ] Manual entry for historical stats (imported players)
- [ ] Totals and averages calculated automatically

---

### LB-040: Bulk Edit Players
**Priority**: P2
**As a** user
**I want** to edit multiple players at once
**So that** I can make sweeping changes efficiently

**Acceptance Criteria**:
- [ ] Multi-select in players list
- [ ] "Bulk Edit" action
- [ ] Fields: team assignment, age adjustment (¬±N), trait assignment
- [ ] Preview changes before applying
- [ ] Undo capability for bulk operations

---

## Module: ROSTERS

### LB-050: View Team Rosters
**Priority**: P0
**As a** user
**I want** to see each team's current roster
**So that** I can review player assignments

**Acceptance Criteria**:
- [ ] Team selector dropdown
- [ ] Roster view showing MLB (22) and Farm (10) players
- [ ] Grouped by: position players, pitchers
- [ ] Shows player grade, position, salary for each
- [ ] Total salary displayed

---

### LB-051: Assign Player to Team
**Priority**: P0
**As a** user
**I want** to move players between teams and free agency
**So that** I can build custom rosters

**Acceptance Criteria**:
- [ ] Drag-drop player between teams
- [ ] Or: select player ‚Üí choose destination team/free agency
- [ ] Updates Player.currentTeamId
- [ ] Updates TeamRoster records for both teams
- [ ] Validation: cannot exceed roster limits

---

### LB-052: Set Starting Lineup
**Priority**: P0
**As a** user
**I want** to configure the batting order and fielding positions
**So that** the team has a default starting lineup

**Acceptance Criteria**:
- [ ] Drag-drop lineup order (1-9)
- [ ] Position dropdown for each lineup slot
- [ ] Lineup vs RHP tab
- [ ] Lineup vs LHP tab (optional, can copy from RHP)
- [ ] Validation: unique positions, valid position for player

---

### LB-053: Set Pitching Rotation
**Priority**: P0
**As a** user
**I want** to define the starting rotation order
**So that** starting pitchers are used in the correct order

**Acceptance Criteria**:
- [ ] Drag-drop list for 4-5 starting pitchers
- [ ] Separate list for setup pitchers
- [ ] Closer designation (single player)
- [ ] Validation: only SP/SP-RP players in rotation

---

### LB-054: Set Depth Chart
**Priority**: P1
**As a** user
**I want** to define backup order for each position
**So that** substitution AI makes intelligent choices

**Acceptance Criteria**:
- [ ] Position-by-position depth chart view
- [ ] Drag-drop players into depth order
- [ ] Shows secondary position capability
- [ ] Validation: at least one player per position

---

### LB-055: Set Bench Preferences
**Priority**: P1
**As a** user
**I want** to define pinch hit/run preferences
**So that** substitution recommendations prioritize my preferences

**Acceptance Criteria**:
- [ ] Pinch hitter priority list
- [ ] Pinch runner priority list
- [ ] Defensive sub priority list
- [ ] Drag-drop ordering

---

### LB-056: Roster Validation
**Priority**: P0
**As a** developer
**I want** automatic validation of roster compliance
**So that** users are warned about invalid roster configurations

**Acceptance Criteria**:
- [ ] MLB roster: exactly 22 players
- [ ] Farm roster: 0-10 players
- [ ] Position minimums: C:2, infield positions:1 each, OF:3, SP:4, RP:3
- [ ] Validation indicators (green check / red X) on roster view
- [ ] Cannot start franchise with invalid rosters

---

### LB-057: Quick Roster Fill
**Priority**: P2
**As a** user
**I want** to auto-fill an incomplete roster
**So that** I can quickly make a roster valid

**Acceptance Criteria**:
- [ ] "Auto-Fill" button when roster is below minimum
- [ ] Pulls best available free agents for needed positions
- [ ] Or generates fictional players if free agent pool insufficient
- [ ] Preview before confirming

---

## Module: DRAFT

### LB-060: Draft Configuration
**Priority**: P1
**As a** user
**I want** to configure draft settings before running a fantasy draft
**So that** the draft runs according to my preferences

**Acceptance Criteria**:
- [ ] Player pool source: league players / all players / generated
- [ ] Draft format: snake / straight / auction
- [ ] Rounds: 22 (default for full roster)
- [ ] Time per pick: unlimited / 30s / 60s / 90s
- [ ] Draft order: random / manual assignment

---

### LB-061: Set Draft Order
**Priority**: P1
**As a** user
**I want** to set the draft order manually or randomly
**So that** teams pick in the desired sequence

**Acceptance Criteria**:
- [ ] "Randomize" button for random order
- [ ] Drag-drop list for manual ordering
- [ ] Snake format: reverses order each round automatically
- [ ] Order preview showing first 3 rounds

---

### LB-062: Run Fantasy Draft
**Priority**: P1
**As a** user
**I want** to execute the fantasy draft with live picking
**So that** I can build my roster through player selection

**Acceptance Criteria**:
- [ ] Draft board showing all picks (rounds √ó teams grid)
- [ ] Current pick highlighted
- [ ] Available players panel with filters and search
- [ ] User picks for user-controlled teams
- [ ] AI auto-picks for AI teams
- [ ] Timer display if time limit enabled
- [ ] "Auto-pick" button for user to delegate

---

### LB-063: Draft AI Strategy
**Priority**: P1
**As a** developer
**I want** AI teams to draft intelligently
**So that** AI rosters are competitive and realistic

**Acceptance Criteria**:
- [ ] Strategy options: best_available / position_need / balanced
- [ ] Position need awareness (fill required positions first)
- [ ] Grade-based player ranking
- [ ] Slight randomization to avoid identical AI drafts

---

### LB-064: View Draft Results
**Priority**: P1
**As a** user
**I want** to review draft results after completion
**So that** I can see how each team drafted

**Acceptance Criteria**:
- [ ] Team-by-team draft recap
- [ ] Full draft order log
- [ ] Grade analysis per team
- [ ] Export draft results to CSV option

---

### LB-065: Undo/Redo Draft Pick
**Priority**: P2
**As a** user
**I want** to undo a draft pick I made by mistake
**So that** I can correct errors

**Acceptance Criteria**:
- [ ] Undo available for user picks only
- [ ] Cannot undo AI picks
- [ ] Undo/redo stack (last 5 picks)
- [ ] Confirmation before undo

---

### LB-066: Draft Trade
**Priority**: P2
**As a** user
**I want** to trade draft picks with other teams
**So that** I can move up or down in the draft

**Acceptance Criteria**:
- [ ] "Trade Pick" button during draft
- [ ] Select pick(s) to trade
- [ ] Select pick(s) to receive
- [ ] AI acceptance based on value comparison
- [ ] Trade confirmation screen

---

### LB-067: Generate Draft Prospects
**Priority**: P1
**As a** user
**I want** to generate fictional players for the draft pool
**So that** I can draft from a fresh set of prospects

**Acceptance Criteria**:
- [ ] Uses GRADE_ALGORITHM_SPEC.md generation
- [ ] Configure: count, grade distribution, age range
- [ ] Generated players marked with `sourceDatabase: 'Generated'`
- [ ] Integrates with draft player pool

---

## Module: RULES

### LB-070: View Rules Presets
**Priority**: P0
**As a** user
**I want** to see all available rules presets
**So that** I can choose or customize game rules

**Acceptance Criteria**:
- [ ] List of presets: Standard, Quick Play, Full Simulation, Arcade
- [ ] Built-in presets marked as read-only
- [ ] Custom presets editable
- [ ] "Create New Preset" button

---

### LB-071: Create Custom Rules Preset
**Priority**: P1
**As a** user
**I want** to create my own rules preset
**So that** I can play with exactly the settings I prefer

**Acceptance Criteria**:
- [ ] Full RulesPreset editor (per LEAGUE_BUILDER_SPEC.md Section 8.2)
- [ ] Sections: Game, Season, Playoffs, DH, Roster, Economics
- [ ] Advanced sections: Development, Narrative, Stats, AI, Offseason
- [ ] Save creates new preset in `rulesPresets` store

---

### LB-072: Edit Custom Rules Preset
**Priority**: P1
**As a** user
**I want** to modify my custom rules presets
**So that** I can refine my preferred settings

**Acceptance Criteria**:
- [ ] All fields editable
- [ ] Cannot edit built-in presets (must duplicate first)
- [ ] Save updates preset in storage

---

### LB-073: Duplicate Rules Preset
**Priority**: P1
**As a** user
**I want** to duplicate a preset as a starting point
**So that** I can create variations of existing presets

**Acceptance Criteria**:
- [ ] Works for built-in and custom presets
- [ ] Creates "[Original Name] Copy"
- [ ] Opens in edit mode

---

### LB-074: Delete Custom Rules Preset
**Priority**: P2
**As a** user
**I want** to delete custom rules presets I no longer need
**So that** my preset list stays manageable

**Acceptance Criteria**:
- [ ] Cannot delete built-in presets
- [ ] Confirmation dialog
- [ ] Warning if preset is default for any league

---

### LB-075: Game Settings Configuration
**Priority**: P0
**As a** user
**I want** to configure core game settings
**So that** games play according to my preferences

**Acceptance Criteria**:
- [ ] Innings per game: 6, 7, 9
- [ ] Extra innings rule: standard, runner on 2nd, sudden death
- [ ] Mercy rule: enable/disable, run differential, inning threshold
- [ ] Pitch counts: enable/disable, starter limit, reliever limit
- [ ] Mound visits: enable/disable, per-game limit

---

### LB-076: Development Sliders
**Priority**: P1
**As a** user
**I want** to adjust player development parameters
**So that** prospects develop at my preferred pace

**Acceptance Criteria**:
- [ ] Sliders 0-100 for each parameter
- [ ] Prospect development speed
- [ ] Regression age
- [ ] Peak years length
- [ ] Injury frequency and recovery speed
- [ ] Bust rate and breakout rate
- [ ] Tooltips explaining each slider

---

### LB-077: Narrative Settings
**Priority**: P1
**As a** user
**I want** to toggle and configure narrative features
**So that** I can control the storytelling elements

**Acceptance Criteria**:
- [ ] Master toggle: narrative enabled/disabled
- [ ] Random event frequency slider
- [ ] Chemistry impact slider
- [ ] Personality effects slider
- [ ] Media stories toggle
- [ ] Rivalry intensity slider

---

### LB-078: AI Behavior Sliders
**Priority**: P1
**As a** user
**I want** to configure AI team behavior
**So that** AI opponents act the way I prefer

**Acceptance Criteria**:
- [ ] Trade aggressiveness slider
- [ ] Trade acceptance threshold slider
- [ ] Free agency spending slider
- [ ] Rebuild threshold slider
- [ ] Prospect valuation slider
- [ ] Win-now bias slider
- [ ] Salary cap management slider

---

## Module: Season Setup Wizard

### SS-001: New Franchise Entry Point
**Priority**: P0
**As a** user
**I want** to start a new franchise from the main menu
**So that** I can begin a new playthrough

**Acceptance Criteria**:
- [ ] "New Franchise" button on Main Menu
- [ ] Opens Season Setup wizard at Step 1
- [ ] 6-step progress indicator displayed

---

### SS-002: Step 1 - Select League
**Priority**: P0
**As a** user
**I want** to choose a league template for my franchise
**So that** I play with my preferred team configuration

**Acceptance Criteria**:
- [ ] Radio button list of available leagues
- [ ] Each entry shows: name, team count, default rules
- [ ] "Create New League" option links to League Builder
- [ ] Next button enabled when league selected
- [ ] Back button / Cancel returns to Main Menu

---

### SS-003: Step 2 - Season Settings
**Priority**: P0
**As a** user
**I want** to configure regular season parameters
**So that** the season matches my time availability

**Acceptance Criteria**:
- [ ] Quick preset buttons: Standard, Quick Play, Full Season, Custom
- [ ] Games per team selection: 16, 32, 40, 80, 128, 162, custom
- [ ] Innings per game: 6, 7, 9
- [ ] Extra innings rule selection
- [ ] Schedule type: balanced, division heavy, rivalry focused
- [ ] Toggles: All-Star game, Trade deadline, Mercy rule
- [ ] Values default from league's default rules preset

---

### SS-004: Step 3 - Playoff Settings
**Priority**: P0
**As a** user
**I want** to configure playoff structure
**So that** the postseason matches my preferences

**Acceptance Criteria**:
- [ ] Teams qualifying: 4, 6, 8, 10, 12
- [ ] Format: bracket, pool, best record bye
- [ ] Series lengths for each round
- [ ] Home field advantage format
- [ ] Values default from league's default rules preset

---

### SS-005: Step 4 - Team Control Selection
**Priority**: P0
**As a** user
**I want** to select which teams I will control
**So that** I can play single or multiplayer seasons

**Acceptance Criteria**:
- [ ] All teams displayed in conference/division grouping
- [ ] Checkbox or toggle button for each team
- [ ] "Selected" state is visually distinct (sticky highlight)
- [ ] Quick select buttons: Select All, Clear All, Random 1
- [ ] Selected count and AI count displayed
- [ ] Multiplayer toggle (enables player assignment)
- [ ] At least 1 team must be selected to proceed
- [ ] If multiplayer: assign teams to player numbers

---

### SS-006: Step 5 - Roster Mode
**Priority**: P0
**As a** user
**I want** to choose between existing rosters or fantasy draft
**So that** I can start with the roster configuration I prefer

**Acceptance Criteria**:
- [ ] Radio selection: Use Existing Rosters / Fantasy Draft
- [ ] If existing: "View Rosters" preview button
- [ ] If draft: player pool source selection
- [ ] If draft: draft settings (rounds, format, time)
- [ ] If draft: redirects to draft after confirmation

---

### SS-007: Step 6 - Confirm & Start
**Priority**: P0
**As a** user
**I want** to review all settings before starting
**So that** I can verify everything is correct

**Acceptance Criteria**:
- [ ] Franchise name input field
- [ ] Summary of all settings from steps 1-5
- [ ] "Edit Settings" button to jump back to any step
- [ ] Warning about creating new franchise
- [ ] "Start Franchise" button creates franchise and navigates to Season Hub

---

### SS-008: Wizard Navigation
**Priority**: P0
**As a** developer
**I want** consistent navigation throughout the wizard
**So that** users can move between steps easily

**Acceptance Criteria**:
- [ ] Step indicator shows current/completed/pending states
- [ ] Back button returns to previous step
- [ ] Next button validates current step before proceeding
- [ ] Cannot skip steps (clicking future step is no-op)
- [ ] Cancel button prompts confirmation before exiting
- [ ] State preserved when navigating back

---

### SS-009: Wizard State Persistence
**Priority**: P1
**As a** user
**I want** my wizard progress saved if I navigate away
**So that** I don't lose my configuration

**Acceptance Criteria**:
- [ ] Wizard state stored in session storage
- [ ] Returning to setup wizard restores previous state
- [ ] "Start Fresh" option to clear saved state
- [ ] State cleared on franchise creation or cancel

---

### SS-010: Franchise Creation
**Priority**: P0
**As a** developer
**I want** the franchise creation process to work correctly
**So that** new franchises are properly initialized

**Acceptance Criteria**:
- [ ] Create new Franchise record in storage
- [ ] Copy league structure (teams, conferences, divisions)
- [ ] Copy team rosters at creation time
- [ ] Copy and apply rules preset
- [ ] Generate initial schedule based on settings
- [ ] Navigate to Season Hub / Dashboard

---

### SS-011: Validation Errors
**Priority**: P0
**As a** user
**I want** clear error messages when configuration is invalid
**So that** I can fix issues before proceeding

**Acceptance Criteria**:
- [ ] Inline validation errors per field
- [ ] Step-level validation before Next
- [ ] Error messages are descriptive ("At least 1 team required")
- [ ] Focus moves to first error on validation failure

---

### SS-012: Default Values
**Priority**: P1
**As a** user
**I want** sensible defaults pre-selected
**So that** I can quickly start with standard settings

**Acceptance Criteria**:
- [ ] First league pre-selected if only one exists
- [ ] Season settings default to league's rules preset
- [ ] Playoff settings default to league's rules preset
- [ ] No teams pre-selected (explicit user choice required)
- [ ] Roster mode defaults to "Use Existing"

---

## Module: Playoff Mode

### SS-020: Playoff Mode Entry Point
**Priority**: P1
**As a** user
**I want** to start a standalone playoff tournament
**So that** I can play just the postseason

**Acceptance Criteria**:
- [ ] "Playoff Mode" button on Main Menu
- [ ] Opens abbreviated setup wizard (5 steps)
- [ ] Skips season settings

---

### SS-021: Playoff Mode - Select League
**Priority**: P1
**As a** user
**I want** to choose which league's teams compete
**So that** I use the correct team pool

**Acceptance Criteria**:
- [ ] Same as SS-002 but for playoff mode
- [ ] Proceeds to Playoff Settings (skips Season Settings)

---

### SS-022: Playoff Mode - Playoff Settings
**Priority**: P1
**As a** user
**I want** to configure the playoff structure
**So that** the tournament matches my preferences

**Acceptance Criteria**:
- [ ] Same as SS-004
- [ ] Teams qualifying limited by league team count

---

### SS-023: Playoff Mode - Team Control
**Priority**: P1
**As a** user
**I want** to select which playoff teams I control
**So that** I play as my preferred team(s)

**Acceptance Criteria**:
- [ ] Same as SS-005
- [ ] Only shows teams that will be in playoffs

---

### SS-024: Playoff Mode - Seeding
**Priority**: P1
**As a** user
**I want** to set the playoff bracket seeding
**So that** matchups are configured correctly

**Acceptance Criteria**:
- [ ] Auto-seed options: Random, By Grade
- [ ] Manual drag-drop ordering
- [ ] Bracket preview showing matchups
- [ ] Seeding determines home field advantage

---

### SS-025: Playoff Mode - Confirm & Start
**Priority**: P1
**As a** user
**I want** to review and start the playoff tournament
**So that** I begin playing immediately

**Acceptance Criteria**:
- [ ] Tournament name input
- [ ] Settings summary
- [ ] "Start Playoffs" creates playoff instance
- [ ] Navigates to Playoff Bracket view

---

## Implementation Notes

### Priority Guide

| Priority | Meaning | Target |
|----------|---------|--------|
| P0 | Core functionality, MVP | Must have for launch |
| P1 | Important features | Should have for launch |
| P2 | Nice to have | Can defer post-launch |

### Dependencies

```
LB-005 (IndexedDB stores) ‚Üí All other stories
LB-031 (Create Player) ‚Üí LB-036 (Generate Players)
LB-034 (Auto Grade) ‚Üí LB-031, LB-036
LB-035 (Auto Salary) ‚Üí LB-031, LB-036
LB-021 (Create Team) ‚Üí LB-050 (View Rosters)
LB-051 (Assign Player) ‚Üí LB-052 (Set Lineup)
SS-001 to SS-007 are sequential
```

### Estimation

| Module | P0 Stories | P1 Stories | P2 Stories | Est. Days |
|--------|------------|------------|------------|-----------|
| Hub | 3 | 2 | 0 | 2 |
| LEAGUES | 4 | 2 | 0 | 3 |
| TEAMS | 4 | 4 | 0 | 4 |
| PLAYERS | 5 | 4 | 2 | 6 |
| ROSTERS | 4 | 3 | 1 | 4 |
| DRAFT | 0 | 6 | 2 | 5 |
| RULES | 3 | 6 | 1 | 4 |
| Season Setup | 10 | 2 | 0 | 5 |
| Playoff Mode | 0 | 6 | 0 | 3 |
| **Total** | 33 | 35 | 6 | **36 days** |

---

## Changelog

- v1.0 (2026-01-29): Initial story creation from LEAGUE_BUILDER_SPEC.md and SEASON_SETUP_SPEC.md
~~~

### Source File: specs/stories/STORIES_PLAYOFFS.md

~~~markdown
# Playoffs Tab - User Stories

> **Phase**: Post-Regular Season (before Offseason Phase 1)
> **Trigger**: Regular season complete (`gameNumber >= totalGames`) AND playoffs configured
> **Purpose**: Manage playoff bracket, track series, determine champion
> **Next Phase**: Season End Processing (Phase 1)

---

## Overview

The Playoffs tab manages the postseason tournament from bracket generation through championship determination. It supports multiple playoff formats, tracks series progress, and handles all playoff-specific game tracking.

**Key Operations:**
1. Playoff qualification and seeding
2. Bracket generation and visualization
3. Series management and game tracking
4. Clinch/elimination detection
5. Championship determination
6. Series MVP awards

**Reference**: PLAYOFF_SYSTEM_SPEC.md for full system details

---

## User Stories

### S-PLY001: Playoff Configuration

**As a** league manager,
**I want** to configure the playoff format before the season,
**So that** the postseason structure matches my league preferences.

**Acceptance Criteria:**
1. AC-1: Configure number of playoff teams (4, 6, 8, 10, or 12)
2. AC-2: Select seeding method (Best Records, Division Winners + Wildcards, Conference Seeds)
3. AC-3: Choose series lengths per round (3, 5, or 7 games)
4. AC-4: Set home field advantage pattern (2-3-2, 2-2-1-1-1, or none)
5. AC-5: Configuration saved and displayed on league settings

**Technical Notes:**
```typescript
interface PlayoffConfig {
  teamCount: 4 | 6 | 8 | 10 | 12;
  seedingMethod: 'BEST_RECORDS' | 'DIVISION_WINNERS_PLUS_WILDCARDS' | 'CONFERENCE_SEEDS';
  rounds: {
    name: PlayoffRound;
    seriesLength: 3 | 5 | 7;
  }[];
  homeFieldPattern: '2-3-2' | '2-2-1-1-1' | 'ALTERNATING' | 'NONE';
  byeRounds?: number;  // For 6 or 10 team formats
}
```

---

### S-PLY002: Playoff Qualification

**As a** league manager,
**I want** teams to automatically qualify for playoffs based on final standings,
**So that** the bracket reflects competitive results.

**Acceptance Criteria:**
1. AC-1: Division winners automatically qualify with top seeds
2. AC-2: Remaining spots filled by best records (wildcards)
3. AC-3: Tiebreakers applied: Head-to-head ‚Üí Division record ‚Üí Run differential
4. AC-4: Qualification displayed on standings with playoff indicators
5. AC-5: Non-qualifying teams shown as eliminated

**Seeding Logic:**
```typescript
function determinePlayoffSeeds(
  standings: TeamStanding[],
  config: PlayoffConfig
): PlayoffSeed[] {
  // 1. Division winners get top seeds
  const divisionWinners = getDivisionWinners(standings);

  // 2. Sort remaining by record
  const remaining = standings.filter(t => !divisionWinners.includes(t));
  const wildcards = remaining
    .sort((a, b) => compareRecords(a, b))
    .slice(0, config.teamCount - divisionWinners.length);

  // 3. Apply tiebreakers and assign seeds
  return assignSeeds([...divisionWinners, ...wildcards]);
}
```

---

### S-PLY003: Bracket Generation

**As a** league manager,
**I want** the playoff bracket to be automatically generated from seeding,
**So that** matchups are set correctly.

**Acceptance Criteria:**
1. AC-1: Bracket generated with correct matchups (1 vs 8, 2 vs 7, etc.)
2. AC-2: Higher seed has home field advantage
3. AC-3: Bracket shows all rounds with TBD placeholders
4. AC-4: Bye rounds indicated for 6 or 10 team formats
5. AC-5: Bracket can be regenerated if needed before first game

**Bracket Structure:**
```typescript
interface PlayoffBracket {
  seasonId: number;
  config: PlayoffConfig;
  rounds: BracketRound[];
  status: 'GENERATED' | 'IN_PROGRESS' | 'COMPLETE';
  championId?: string;
}

interface BracketRound {
  name: 'WILD_CARD' | 'DIVISIONAL' | 'CHAMPIONSHIP' | 'WORLD_SERIES';
  seriesLength: 3 | 5 | 7;
  matchups: BracketMatchup[];
}

interface BracketMatchup {
  matchupId: string;
  higherSeed: { teamId: string; seed: number };
  lowerSeed: { teamId: string; seed: number };
  series: SeriesState;
  winnerId?: string;
  advancesTo?: string;  // Next matchup ID
}
```

---

### S-PLY004: Bracket Visualization

**As a** league manager,
**I want** to see the full playoff bracket in a visual format,
**So that** I can track tournament progress at a glance.

**Acceptance Criteria:**
1. AC-1: Multi-column bracket layout (rounds left to right)
2. AC-2: Each matchup shows team names, seeds, and series score
3. AC-3: Current series highlighted with "LIVE" indicator
4. AC-4: Completed matchups show winner advancing
5. AC-5: TBD placeholders for future matchups
6. AC-6: Champion shown with trophy icon when determined

**Display Format:**
```
WILD CARD          DIVISION SERIES      CHAMPIONSHIP       WORLD SERIES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[1] Hawks
    BYE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îú‚îÄ‚îÄ [1] Hawks ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
[4] Storm         ‚îÇ       vs        ‚îÇ
   2-1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   [4] Storm     ‚îú‚îÄ‚îÄ [1] Hawks ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
[5] Wolves                          ‚îÇ       vs        ‚îÇ
   1-2                              ‚îÇ   [2] Cats      ‚îÇ
                                    ‚îÇ                 ‚îÇ
[2] Cats                            ‚îÇ                 ‚îú‚îÄ‚îÄ üèÜ CHAMPION
    BYE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                 ‚îÇ
                  ‚îú‚îÄ‚îÄ [2] Cats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
[3] Giants        ‚îÇ       vs                          ‚îÇ
   1-2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   [3] Giants                      ‚îÇ
[6] Bears                                             ‚îÇ
   2-1                                                ‚îÇ
```

---

### S-PLY005: Series State Management

**As a** league manager,
**I want** each playoff series to track wins and game results,
**So that** I know who is leading and when a series ends.

**Acceptance Criteria:**
1. AC-1: Series tracks wins for each team
2. AC-2: Games needed to win calculated from series length
3. AC-3: Series status: NOT_STARTED ‚Üí IN_PROGRESS ‚Üí COMPLETE
4. AC-4: Individual game results stored (score, winner, pitchers)
5. AC-5: Series leader shown in bracket view

**Series State:**
```typescript
interface SeriesState {
  seriesId: string;
  round: PlayoffRound;
  homeTeam: { id: string; seed: number };
  awayTeam: { id: string; seed: number };
  seriesLength: 3 | 5 | 7;
  winsNeeded: number;  // (seriesLength + 1) / 2

  homeWins: number;
  awayWins: number;
  currentGame: number;

  games: SeriesGame[];

  status: 'NOT_STARTED' | 'IN_PROGRESS' | 'COMPLETE';
  winnerId?: string;
  isClinchGame: boolean;
  isEliminationGame: boolean;
}

interface SeriesGame {
  gameNumber: number;
  homeTeamId: string;
  homeScore: number;
  awayScore: number;
  winnerId: string;
  winningPitcher?: string;
  losingPitcher?: string;
  savePitcher?: string;
}
```

---

### S-PLY006: Home Field Advantage

**As a** league manager,
**I want** home field advantage applied correctly per series format,
**So that** the higher seed benefits appropriately.

**Acceptance Criteria:**
1. AC-1: 2-3-2 pattern for 7-game series (Games 1-2, 6-7 at higher seed)
2. AC-2: 2-2-1 pattern for 5-game series (Games 1-2, 5 at higher seed)
3. AC-3: 2-1 pattern for 3-game series (Games 1, 3 at higher seed)
4. AC-4: Current game location displayed clearly
5. AC-5: Home team listed second in matchup display (Away @ Home)

**Home Field Pattern:**
```typescript
function getHomeTeam(
  series: SeriesState,
  gameNumber: number,
  pattern: HomeFieldPattern
): string {
  const patterns: Record<number, boolean[]> = {
    3: [true, false, true],           // Higher seed: G1, G3
    5: [true, true, false, false, true],  // Higher seed: G1-2, G5
    7: [true, true, false, false, false, true, true]  // 2-3-2
  };

  const isHigherSeedHome = patterns[series.seriesLength][gameNumber - 1];
  return isHigherSeedHome ? series.homeTeam.id : series.awayTeam.id;
}
```

---

### S-PLY007: Start Playoff Game

**As a** league manager,
**I want** to start a playoff game from the bracket or series view,
**So that** I can begin tracking the game.

**Acceptance Criteria:**
1. AC-1: [Start Game] button on current series
2. AC-2: Game number and matchup displayed before starting
3. AC-3: Home/away teams set based on home field pattern
4. AC-4: Playoff game uses same tracking UI as regular season
5. AC-5: Clutch multipliers automatically applied based on round

**Clutch Multipliers by Round:**
```typescript
const PLAYOFF_CLUTCH_MULTIPLIERS: Record<PlayoffRound, number> = {
  WILD_CARD: 1.5,
  DIVISIONAL: 1.75,
  CHAMPIONSHIP: 2.0,
  WORLD_SERIES: 2.5
};

const SITUATION_BONUSES = {
  ELIMINATION_GAME: 0.5,
  CLINCH_GAME: 0.25
};
```

---

### S-PLY008: Clinch and Elimination Detection

**As a** league manager,
**I want** the system to identify clinch and elimination games,
**So that** high-stakes situations are highlighted.

**Acceptance Criteria:**
1. AC-1: Clinch game: One team is 1 win from advancing
2. AC-2: Elimination game: One team cannot lose another game
3. AC-3: Visual indicator on game card (‚≠ê CLINCH / ‚ö†Ô∏è ELIMINATION)
4. AC-4: Both flags can be true simultaneously (e.g., Game 7)
5. AC-5: Clutch multiplier bonuses applied to these games

**Detection Logic:**
```typescript
function detectGameStakes(series: SeriesState): GameStakes {
  const { homeWins, awayWins, winsNeeded } = series;

  const homeClinch = homeWins === winsNeeded - 1;
  const awayClinch = awayWins === winsNeeded - 1;
  const homeElimination = awayWins === winsNeeded - 1;
  const awayElimination = homeWins === winsNeeded - 1;

  return {
    isClinchGame: homeClinch || awayClinch,
    isEliminationGame: homeElimination || awayElimination,
    clinchTeam: homeClinch ? series.homeTeam.id : (awayClinch ? series.awayTeam.id : null),
    eliminationTeam: homeElimination ? series.homeTeam.id : (awayElimination ? series.awayTeam.id : null)
  };
}
```

---

### S-PLY009: Record Playoff Game Result

**As a** league manager,
**I want** to record the result of a playoff game,
**So that** the series updates and bracket progresses.

**Acceptance Criteria:**
1. AC-1: Final score recorded for both teams
2. AC-2: Winner's series wins incremented
3. AC-3: Winning/losing/save pitchers recorded
4. AC-4: Key plays recorded (HR, walk-offs, etc.)
5. AC-5: Series status checked for completion
6. AC-6: If series complete, winner advances in bracket

**Game Result Flow:**
```typescript
function recordPlayoffGameResult(
  series: SeriesState,
  result: GameResult
): SeriesState {
  // 1. Add game to series
  series.games.push(result);

  // 2. Update wins
  if (result.winnerId === series.homeTeam.id) {
    series.homeWins++;
  } else {
    series.awayWins++;
  }

  // 3. Check for series completion
  if (series.homeWins >= series.winsNeeded) {
    series.status = 'COMPLETE';
    series.winnerId = series.homeTeam.id;
  } else if (series.awayWins >= series.winsNeeded) {
    series.status = 'COMPLETE';
    series.winnerId = series.awayTeam.id;
  } else {
    series.currentGame++;
    series.isClinchGame = detectClinch(series);
    series.isEliminationGame = detectElimination(series);
  }

  return series;
}
```

---

### S-PLY010: Series Completion and Advancement

**As a** league manager,
**I want** the winning team to automatically advance to the next round,
**So that** the bracket progresses correctly.

**Acceptance Criteria:**
1. AC-1: Winner populates next round matchup
2. AC-2: Bracket updates visually to show advancement
3. AC-3: Series MVP calculated for completed series
4. AC-4: If championship round, trigger championship processing
5. AC-5: Celebration animation for series win

**Advancement Logic:**
```typescript
function advanceWinner(
  bracket: PlayoffBracket,
  completedMatchup: BracketMatchup
): PlayoffBracket {
  if (!completedMatchup.advancesTo) {
    // This was the championship - set champion
    bracket.championId = completedMatchup.winnerId;
    bracket.status = 'COMPLETE';
    return bracket;
  }

  // Find next matchup and populate with winner
  const nextMatchup = findMatchup(bracket, completedMatchup.advancesTo);
  if (nextMatchup.higherSeed.teamId === null) {
    nextMatchup.higherSeed.teamId = completedMatchup.winnerId;
  } else {
    nextMatchup.lowerSeed.teamId = completedMatchup.winnerId;
  }

  return bracket;
}
```

---

### S-PLY011: Series Detail View

**As a** league manager,
**I want** to see detailed information about a series,
**So that** I can review game-by-game results and stats.

**Acceptance Criteria:**
1. AC-1: Series header shows matchup and current score (e.g., "Hawks lead 2-1")
2. AC-2: Game-by-game results with scores and locations
3. AC-3: Winning/losing/save pitchers for each game
4. AC-4: Key plays per game (HR, walk-offs)
5. AC-5: Series leaders (batting and pitching stats)
6. AC-6: Upcoming game info (probable pitchers, location)

**Series Leaders Display:**
```
SERIES LEADERS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BATTING                  PITCHING
M. Johnson  .455  5 RBI  R. Martinez  2-0  1.50 ERA
D. Chen     .400  3 HR   T. Williams  1-0  2.25 ERA
J. Davis    .385  4 R    K. Brown     0-1  3.60 ERA
```

---

### S-PLY012: Series MVP Award

**As a** league manager,
**I want** a Series MVP to be calculated when a series ends,
**So that** the best performer is recognized.

**Acceptance Criteria:**
1. AC-1: MVP calculated from winning team only
2. AC-2: Score factors: Hits, HR, RBI, Runs, AVG, Wins, Saves, K, ERA, IP, Clutch
3. AC-3: MVP displayed on series completion screen
4. AC-4: MVP recorded in playoff history
5. AC-5: World Series MVP gets +3.0 Fame bonus

**MVP Calculation:**
```typescript
function calculateSeriesMVP(
  series: SeriesState,
  playerStats: Map<string, SeriesStats>
): string {
  const winningTeamPlayers = getWinningTeamPlayers(series);

  let mvpScore = 0;
  let mvpId = '';

  for (const playerId of winningTeamPlayers) {
    const stats = playerStats.get(playerId);
    const score =
      (stats.hits * 1) +
      (stats.hr * 3) +
      (stats.rbi * 1.5) +
      (stats.runs * 1) +
      ((stats.avg - 0.250) * 20) +
      (stats.wins * 5) +
      (stats.saves * 4) +
      (stats.strikeouts * 0.5) +
      ((4.00 - stats.era) * 2) +
      (stats.ip * 0.5) +
      (stats.clutchPoints * 0.5);

    if (score > mvpScore) {
      mvpScore = score;
      mvpId = playerId;
    }
  }

  return mvpId;
}
```

---

### S-PLY013: Championship Determination

**As a** league manager,
**I want** the championship winner to be clearly identified,
**So that** Season End Processing can apply bonuses.

**Acceptance Criteria:**
1. AC-1: Championship series completion triggers champion declaration
2. AC-2: Trophy animation and celebration screen
3. AC-3: Championship roster captured (for fame bonuses)
4. AC-4: World Series MVP calculated and displayed
5. AC-5: [Proceed to Season End] button appears

**Championship Result:**
```typescript
interface ChampionshipResult {
  seasonId: number;
  championId: string;
  championName: string;
  opponentId: string;
  opponentName: string;
  seriesResult: string;  // e.g., "4-2"
  worldSeriesMVP: {
    playerId: string;
    playerName: string;
    stats: SeriesStats;
  };
  championshipRoster: string[];  // All player IDs at time of win
}
```

---

### S-PLY014: Playoff Stats Tracking

**As a** league manager,
**I want** playoff stats tracked separately from regular season,
**So that** postseason performance is properly measured.

**Acceptance Criteria:**
1. AC-1: All batting/pitching stats tracked for playoffs
2. AC-2: Playoff stats separate from regular season totals
3. AC-3: Postseason WAR calculated from playoff games
4. AC-4: Clutch points accumulated with playoff multipliers
5. AC-5: Playoff stats available in player profile

**Playoff Stats:**
```typescript
interface PlayoffStats {
  playerId: string;
  seasonId: number;
  gamesPlayed: number;

  // Batting
  atBats: number;
  hits: number;
  doubles: number;
  triples: number;
  homeRuns: number;
  rbi: number;
  runs: number;
  walks: number;
  strikeouts: number;
  stolenBases: number;
  avg: number;
  ops: number;

  // Pitching
  wins: number;
  losses: number;
  saves: number;
  inningsPitched: number;
  earnedRuns: number;
  era: number;
  strikeoutsP: number;
  walksP: number;
  whip: number;

  // Advanced
  postseasonWAR: number;
  clutchPoints: number;
}
```

---

### S-PLY015: Playoff Roster Management

**As a** league manager,
**I want** to manage my playoff roster between rounds,
**So that** I can adjust for injuries or matchups.

**Acceptance Criteria:**
1. AC-1: Roster locked during active series
2. AC-2: Up to 2 roster changes allowed between rounds
3. AC-3: Injury replacements don't count against limit
4. AC-4: Players must have been on roster by trade deadline or Sept 1
5. AC-5: Roster changes displayed in transaction log

**Roster Rules:**
```typescript
interface PlayoffRosterRules {
  rosterSize: 26;
  maxChangesBetweenRounds: 2;
  eligibilityCutoff: 'TRADE_DEADLINE' | 'SEPTEMBER_1';
  injuryExemption: true;
}

function validateRosterChange(
  player: Player,
  season: Season
): RosterChangeValidation {
  const isEligible =
    player.addedToRosterDate <= season.tradeDeadline ||
    player.addedToRosterDate <= season.september1;

  return {
    valid: isEligible,
    reason: isEligible ? null : 'Player not eligible for playoff roster'
  };
}
```

---

### S-PLY016: Exhibition Playoff Series

**As a** league manager,
**I want** to play standalone playoff series outside of franchise mode,
**So that** I can have playoff experiences without a full season.

**Acceptance Criteria:**
1. AC-1: Select any two teams for series
2. AC-2: Choose series length (3, 5, or 7 games)
3. AC-3: Home field assigned to selected team
4. AC-4: Stats tracked to exhibition history (optional)
5. AC-5: Series MVP calculated at completion
6. AC-6: No impact on franchise records

**Exhibition Series:**
```typescript
interface ExhibitionPlayoffSeries {
  type: 'EXHIBITION';
  homeTeam: Team;
  awayTeam: Team;
  seriesLength: 3 | 5 | 7;
  homeFieldAdvantage: 'HOME_TEAM' | 'AWAY_TEAM';
  trackStats: boolean;
  applyClutchMultipliers: boolean;
  series: SeriesState;
}
```

---

### S-PLY017: Playoff Records

**As a** league manager,
**I want** playoff records tracked and displayed,
**So that** historic performances are preserved.

**Acceptance Criteria:**
1. AC-1: Most HR in a playoff series
2. AC-2: Most RBI in a playoff series
3. AC-3: Most wins in a single postseason
4. AC-4: Most saves in a single postseason
5. AC-5: Longest hitting streak in playoffs
6. AC-6: Most consecutive scoreless innings
7. AC-7: Records displayed in Museum/History

**Record Tracking:**
```typescript
interface PlayoffRecord {
  category: string;
  value: number;
  playerId: string;
  playerName: string;
  teamId: string;
  seasonId: number;
  description: string;
}

const PLAYOFF_RECORD_CATEGORIES = [
  'SERIES_HR',
  'SERIES_RBI',
  'POSTSEASON_WINS',
  'POSTSEASON_SAVES',
  'HITTING_STREAK',
  'SCORELESS_INNINGS'
];
```

---

### S-PLY018: Transition to Season End Processing

**As a** league manager,
**I want** to transition smoothly from playoffs to Season End Processing,
**So that** the offseason can begin properly.

**Acceptance Criteria:**
1. AC-1: [Complete Playoffs] button after championship
2. AC-2: Confirmation modal with playoff summary
3. AC-3: Championship result passed to Season End Processing
4. AC-4: Playoff stats finalized and locked
5. AC-5: Transition to Phase 1 (Season End Processing)

**Transition Data:**
```typescript
interface PlayoffCompletionData {
  seasonId: number;
  champion: ChampionshipResult;
  playoffGames: SeriesGame[];
  seriesMVPs: { round: string; playerId: string }[];
  playoffStats: Map<string, PlayoffStats>;
  postseasonWAR: Map<string, number>;
}

// This data feeds into Season End Processing (Phase 1)
// - Postseason MVP selection uses postseasonWAR
// - Championship processing uses champion.championshipRoster
```

---

## Data Models

### Playoff State

```typescript
interface PlayoffState {
  seasonId: number;
  config: PlayoffConfig;
  bracket: PlayoffBracket;
  status: 'NOT_STARTED' | 'IN_PROGRESS' | 'COMPLETE';

  // Current series tracking
  activeSeries?: SeriesState;
  currentGame?: number;

  // Results
  seriesResults: SeriesResult[];
  seriesMVPs: { seriesId: string; playerId: string }[];
  champion?: ChampionshipResult;

  // Stats
  playerStats: Map<string, PlayoffStats>;
}
```

### Bracket Round Types

```typescript
type PlayoffRound =
  | 'WILD_CARD'
  | 'DIVISIONAL'
  | 'CHAMPIONSHIP'
  | 'WORLD_SERIES';

const ROUND_DISPLAY_NAMES: Record<PlayoffRound, string> = {
  WILD_CARD: 'Wild Card Round',
  DIVISIONAL: 'Division Series',
  CHAMPIONSHIP: 'Championship Series',
  WORLD_SERIES: 'World Series'
};
```

---

## Integration Points

### Upstream Dependencies
- **Regular Season**: Final standings for seeding
- **Roster Management**: Playoff-eligible players
- **Stats System**: Regular season stats baseline

### Downstream Consumers
- **Season End (Phase 1)**: Championship result, postseason WAR
- **Awards (Phase 2)**: Playoff stats for awards voting
- **History/Museum**: Playoff records, series results

---

## Screen Flow

```
Regular Season Complete
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Playoff Bracket    ‚îÇ ‚óÑ‚îÄ‚îÄ View bracket, select series
‚îÇ  (Main View)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Series Detail      ‚îÇ ‚óÑ‚îÄ‚îÄ View series info, start game
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Playoff Game       ‚îÇ ‚óÑ‚îÄ‚îÄ Same UI as regular season
‚îÇ  (Today's Game)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Game Complete      ‚îÇ ‚óÑ‚îÄ‚îÄ Record result
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           ‚îÇ
Series        Series
Continues     Complete
    ‚îÇ           ‚îÇ
    ‚îÇ           ‚ñº
    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ    ‚îÇ  Series MVP     ‚îÇ
    ‚îÇ    ‚îÇ  Award          ‚îÇ
    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ              ‚îÇ
    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ    ‚îÇ                   ‚îÇ
    ‚îÇ  More              Championship
    ‚îÇ  Rounds               Complete
    ‚îÇ    ‚îÇ                   ‚îÇ
    ‚îÇ    ‚îÇ                   ‚ñº
    ‚îÇ    ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ    ‚îÇ         ‚îÇ  Championship       ‚îÇ
    ‚îÇ    ‚îÇ         ‚îÇ  Celebration        ‚îÇ
    ‚îÇ    ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ    ‚îÇ                   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Season End         ‚îÇ
         ‚îÇ  Processing (Ph 1)  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Edge Cases

1. **Tie games**: Baseball has no ties - extra innings until winner
2. **Rainouts**: SMB4 doesn't have rainouts, N/A
3. **All teams eliminated from one division**: Proceed with remaining bracket
4. **Roster player injury mid-series**: Replacement allowed, counts against limit unless IL
5. **User quits mid-series**: Save state, resume from same point

---

*Last Updated: January 29, 2026*
*Stories: S-PLY001 through S-PLY018*
~~~

### Source File: specs/stories/STORIES_RATINGS_ADJUSTMENT.md

~~~markdown
# EOS Ratings Adjustment - User Stories

> **Phase**: 3 of 11 (Offseason)
> **Trigger**: After Awards Ceremony (Phase 2) completes
> **Purpose**: Adjust player ratings and salaries based on season performance vs expectations
> **Next Phase**: Contraction/Expansion (Phase 4)

---

## Overview

End-of-Season (EOS) Ratings Adjustments is an offseason ceremony where player ratings change based on their WAR performance vs salary expectations. The system runs two sequential operations:

1. **System A (Rating Adjustments)**: Compare WAR percentile to salary percentile ‚Üí adjust ratings
2. **System B (Salary Adjustments)**: Calculate "True Value" from WAR ‚Üí adjust contract salary

**Reference Documents**:
- `EOS_RATINGS_ADJUSTMENT_SPEC.md` ‚Äî Position detection, thresholds, formulas
- `EOS_RATINGS_FIGMA_SPEC.md` ‚Äî UI design specification
- `EOS_RATINGS_READINESS.md` ‚Äî Decision log and data requirements

---

## User Stories

### S-EOS001: Phase Entry and Validation

**As a** league manager,
**I want** the system to validate that Awards Ceremony is complete before entering Ratings Adjustments,
**So that** all prerequisite data is available.

**Acceptance Criteria:**
1. AC-1: Phase 3 only accessible after Phase 2 (Awards) completes
2. AC-2: All season stats must be finalized
3. AC-3: WAR calculations (bWAR, rWAR, fWAR, pWAR) must be complete for all players
4. AC-4: Display entry screen with league-wide preview

**Technical Notes:**
```typescript
function canEnterRatingsPhase(offseasonState: OffseasonState): boolean {
  return (
    offseasonState.awardsComplete &&
    offseasonState.warCalculationsComplete &&
    offseasonState.currentPhase >= 2
  );
}
```

---

### S-EOS002: Position Detection

**As a** league manager,
**I want** the system to detect each player's primary position based on their season usage,
**So that** they are compared to appropriate peers.

**Acceptance Criteria:**
1. AC-1: Detect position using scalable thresholds based on season length
2. AC-2: Pitcher types: SP, SP/RP, RP, CP based on starts/relief/saves
3. AC-3: Position player types: C, 1B, 2B, SS, 3B, LF, CF, RF, DH, UTIL, BENCH
4. AC-4: Two-way players detected when meeting both pitching and batting thresholds
5. AC-5: Detected position displayed on player card as badge

**Position Thresholds (40-game season)**:
| Position | Threshold |
|----------|-----------|
| SP | 5+ starts, starts > relief |
| SP/RP | 2+ starts, relief >= 50% of starts |
| RP | 10+ relief appearances |
| CP | 5+ saves |
| UTIL | 3+ positions, 6+ games each, none >60% |
| BENCH | <50% of team games at primary |
| TWO-WAY | 5+ pitching games AND 49+ PA |

**Technical Notes:**
```typescript
function detectPosition(
  player: Player,
  seasonStats: SeasonStats,
  seasonLength: number
): DetectedPosition {
  const thresholds = getPositionThresholds(seasonLength);
  // Detection algorithm per EOS_RATINGS_ADJUSTMENT_SPEC.md
  return detectedPosition;
}
```

---

### S-EOS003: Peer Pool Assignment

**As a** league manager,
**I want** players compared to appropriate peer groups,
**So that** rating adjustments are fair.

**Acceptance Criteria:**
1. AC-1: Minimum 6 players per pool for meaningful comparison
2. AC-2: Small pools merge with similar positions:
   - Pitchers: CP ‚Üî RP, SP/RP ‚Üî SP/RP
   - Corner IF: 1B ‚Üî 3B
   - Middle IF: 2B ‚Üî SS
   - Outfield: LF ‚Üî CF ‚Üî RF
   - Bench: UTIL ‚Üî BENCH
3. AC-3: Two-way players compared separately for pitching and batting
4. AC-4: Pool size shown in player adjustment detail

**Technical Notes:**
```typescript
function getComparisonPool(
  position: string,
  allPlayers: Player[]
): Player[] {
  const posPlayers = allPlayers.filter(p => p.detectedPosition === position);

  if (posPlayers.length < MIN_POOL_SIZE) {
    return getMergedPool(position, allPlayers);
  }
  return posPlayers;
}
```

---

### S-EOS004: WAR Percentile Calculation

**As a** league manager,
**I want** each player's WAR ranked within their position peer group,
**So that** performance can be compared to expectations.

**Acceptance Criteria:**
1. AC-1: Calculate percentile for each WAR component within peer pool
2. AC-2: bWAR percentile for all batters
3. AC-3: rWAR percentile for all players (baserunning)
4. AC-4: fWAR percentile for fielders only (null for DH)
5. AC-5: pWAR percentile for pitchers only
6. AC-6: Percentiles shown as 0-100 on player card

**Technical Notes:**
```typescript
function calculateWARPercentile(
  playerWAR: number,
  peerPool: Player[],
  warComponent: 'bWAR' | 'rWAR' | 'fWAR' | 'pWAR'
): number {
  const values = peerPool.map(p => p[warComponent]).sort((a, b) => a - b);
  const rank = values.filter(v => v < playerWAR).length;
  return Math.round((rank / values.length) * 100);
}
```

---

### S-EOS005: Salary Percentile Calculation

**As a** league manager,
**I want** each player's salary ranked within their position peer group,
**So that** expectations are properly calibrated.

**Acceptance Criteria:**
1. AC-1: Calculate salary percentile within position peer pool
2. AC-2: Assign salary tier based on percentile:
   - Elite: 90-100%
   - High: 75-89%
   - Mid-High: 50-74%
   - Mid-Low: 25-49%
   - Low: 10-24%
   - Minimum: 0-9%
3. AC-3: Display tier badge on player card
4. AC-4: Tier determines asymmetric adjustment factors

**Salary Tier Factors**:
| Tier | Positive Factor | Negative Factor |
|------|-----------------|-----------------|
| Elite | 1.0 | 10.0 |
| High | 2.0 | 7.0 |
| Mid-High | 4.0 | 5.0 |
| Mid-Low | 6.0 | 3.0 |
| Low | 8.0 | 1.5 |
| Minimum | 10.0 | 1.0 |

---

### S-EOS006: Rating Adjustment Calculation (System A)

**As a** league manager,
**I want** player ratings adjusted based on WAR percentile vs salary percentile delta,
**So that** performance above/below expectations is reflected.

**Acceptance Criteria:**
1. AC-1: Calculate delta = WAR percentile - Salary percentile
2. AC-2: Apply salary tier factor (asymmetric based on over/underperformance)
3. AC-3: Map WAR components to rating categories:
   - bWAR ‚Üí Power, Contact (50/50)
   - rWAR ‚Üí Speed (100%)
   - fWAR ‚Üí Fielding, Arm (50/50)
   - pWAR ‚Üí Velocity, Junk, Accuracy (33/33/33)
4. AC-4: Cap adjustments at ¬±10 per WAR component
5. AC-5: Display before/after for each rating category

**Technical Notes:**
```typescript
interface RatingAdjustment {
  category: string;
  before: number;
  after: number;
  change: number;
  source: 'bWAR' | 'rWAR' | 'fWAR' | 'pWAR';
}

function calculateRatingAdjustment(
  warPercentile: number,
  salaryPercentile: number,
  salaryTier: SalaryTier
): number {
  const delta = warPercentile - salaryPercentile;
  const factor = delta >= 0
    ? salaryTier.positiveFactor
    : salaryTier.negativeFactor;

  const raw = delta * factor / 10;  // Scale to rating points
  return Math.max(-10, Math.min(10, Math.round(raw)));  // Cap at ¬±10
}
```

---

### S-EOS007: DH Fielding Handling

**As a** league manager,
**I want** DHs to skip fielding adjustments,
**So that** they aren't penalized for not fielding.

**Acceptance Criteria:**
1. AC-1: DHs have null fWAR (no fielding data)
2. AC-2: Display "N/A (DH - no fielding)" for fielding/arm adjustments
3. AC-3: Net change calculation excludes fielding for DHs
4. AC-4: Gray italic styling for N/A fields

**Display Example**:
```
RATINGS ADJUSTMENT - Big Papi (DH)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Batting:     +4
Baserunning: -1
Fielding:    N/A (DH - no fielding)
Pitching:    N/A
```

---

### S-EOS008: Two-Way Player Handling

**As a** league manager,
**I want** two-way players to receive both batting and pitching adjustments,
**So that** their dual role is properly evaluated.

**Acceptance Criteria:**
1. AC-1: Two-way players compared against batting peers for bWAR/rWAR/fWAR
2. AC-2: Two-way players compared against pitching peers for pWAR
3. AC-3: Both adjustment sets displayed on player card
4. AC-4: Net change combines batting and pitching adjustments
5. AC-5: Separate sections for "Batting Adjustments" and "Pitching Adjustments"

**Display Example**:
```
SHOHEI OHTANI (TWO-WAY)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BATTING ADJUSTMENTS (vs RF peers)
  Power: +2  Contact: +1  Speed: +1

PITCHING ADJUSTMENTS (vs SP peers)
  Velocity: +1  Junk: +1  Accuracy: +1

NET CHANGE: +7
```

---

### S-EOS009: Pitcher Rating Adjustments

**As a** league manager,
**I want** pitchers evaluated only on pitching metrics,
**So that** their ratings reflect mound performance.

**Acceptance Criteria:**
1. AC-1: pWAR ‚Üí Velocity, Junk, Accuracy (33/33/33 distribution)
2. AC-2: Pitchers skip bWAR/rWAR/fWAR adjustments (display N/A)
3. AC-3: Detected position shown (SP, RP, CP, SP/RP)
4. AC-4: Display number of starts vs relief appearances

---

### S-EOS010: Salary Adjustment Calculation (System B)

**As a** league manager,
**I want** player salaries adjusted toward their "True Value",
**So that** contracts reflect actual performance.

**Acceptance Criteria:**
1. AC-1: Calculate True Value from WAR performance
2. AC-2: Adjustment = 50% of gap between current salary and True Value
3. AC-3: Respect salary floor/ceiling by grade
4. AC-4: Display before/after salary with delta
5. AC-5: System B runs AFTER System A (rating adjustments)

**Technical Notes:**
```typescript
function calculateSalaryAdjustment(
  currentSalary: number,
  trueValue: number,
  grade: string
): SalaryAdjustment {
  const gap = trueValue - currentSalary;
  const adjustment = gap * 0.5;  // 50% of gap

  const newSalary = Math.max(
    SALARY_FLOOR[grade],
    Math.min(SALARY_CEILING[grade], currentSalary + adjustment)
  );

  return {
    before: currentSalary,
    after: newSalary,
    delta: newSalary - currentSalary
  };
}
```

---

### S-EOS011: Overview Dashboard Display

**As a** league manager,
**I want** to see a league-wide summary before diving into team details,
**So that** I understand the scope of changes.

**Acceptance Criteria:**
1. AC-1: Display total players with changes (improved/declined/unchanged)
2. AC-2: Show top 3 risers with name, team, change amount
3. AC-3: Show top 3 fallers with name, team, change amount
4. AC-4: List all teams with change counts
5. AC-5: [Begin Team Review] and [Skip All] buttons

---

### S-EOS012: Team-by-Team Reveal

**As a** league manager,
**I want** to review each team's adjustments one at a time,
**So that** I can focus on individual team changes.

**Acceptance Criteria:**
1. AC-1: Display team header (logo, name, record)
2. AC-2: Show net rating change and average change per player
3. AC-3: List all players with adjustments
4. AC-4: Each player card shows before/after ratings and net change
5. AC-5: Filter options: All, Position, Change type (positive/negative)
6. AC-6: [Prev Team] [Next Team] navigation

---

### S-EOS013: Player Adjustment Card

**As a** league manager,
**I want** to see detailed adjustment breakdown for each player,
**So that** I understand why their ratings changed.

**Acceptance Criteria:**
1. AC-1: Player photo, name, detected position
2. AC-2: Salary and tier badge
3. AC-3: WAR percentiles for each component
4. AC-4: Before/after for each rating category
5. AC-5: Change visualization bar (green/red)
6. AC-6: Net change badge
7. AC-7: Salary adjustment amount
8. AC-8: Expandable detail view with full calculation breakdown

---

### S-EOS014: Manager Distribution Pool Calculation

**As a** league manager,
**I want** each manager to receive a point pool based on their performance,
**So that** good managers can boost their players.

**Acceptance Criteria:**
1. AC-1: Base pool = 20 points for all managers
2. AC-2: mWAR bonus/penalty based on manager WAR vs league median
3. AC-3: Manager of the Year bonus = +5 points
4. AC-4: Total pool can be positive or negative
5. AC-5: Negative pools must still be distributed (penalizes team)

**Pool Calculation**:
```typescript
interface ManagerPool {
  basePool: 20;
  mwarBonus: number;  // Can be negative
  moyBonus: 0 | 5;
  totalPool: number;
}

function calculateManagerPool(manager: Manager): ManagerPool {
  const leagueMedianMWAR = getLeagueMedianMWAR();
  const mwarDiff = manager.mWAR - leagueMedianMWAR;
  const mwarBonus = Math.round(mwarDiff * getGradeFactor(manager.grade) * 5);

  return {
    basePool: 20,
    mwarBonus,
    moyBonus: manager.isManagerOfYear ? 5 : 0,
    totalPool: 20 + mwarBonus + (manager.isManagerOfYear ? 5 : 0)
  };
}
```

---

### S-EOS015: Manager Distribution Interface

**As a** league manager,
**I want** to manually allocate my manager's bonus points to players,
**So that** I can reward specific performers.

**Acceptance Criteria:**
1. AC-1: Display manager info (name, grade, mWAR, record)
2. AC-2: Show pool breakdown (base + mWAR + MOY = total)
3. AC-3: [+ Add Allocation] button opens modal
4. AC-4: Select player, rating category, and point amount
5. AC-5: Max 50% of pool to any single player
6. AC-6: Can allocate positive OR negative points
7. AC-7: Running total of remaining points
8. AC-8: [Confirm Distribution] enabled only when remaining = 0

---

### S-EOS016: Manager Distribution Validation

**As a** league manager,
**I want** the system to enforce distribution rules,
**So that** all points are properly allocated.

**Acceptance Criteria:**
1. AC-1: Cannot exceed 50% of pool to single player
2. AC-2: Must distribute ALL points (positive or negative)
3. AC-3: Real-time validation as allocations are made
4. AC-4: Warning if trying to proceed with points remaining
5. AC-5: Can remove/edit allocations before confirming

---

### S-EOS017: Negative Manager Pool

**As a** league manager,
**I want** poor-performing managers to distribute negative points,
**So that** bad management has consequences.

**Acceptance Criteria:**
1. AC-1: Negative total pool clearly indicated
2. AC-2: Warning message: "You must distribute -X points across your roster"
3. AC-3: Explanation: "Poor management penalizes player development"
4. AC-4: Same distribution rules apply (50% max per player)
5. AC-5: Cannot proceed without distributing all negative points

---

### S-EOS018: Zero Manager Pool

**As a** league manager,
**I want** managers with zero pool to skip distribution,
**So that** the flow isn't unnecessarily delayed.

**Acceptance Criteria:**
1. AC-1: Display: "No distribution needed"
2. AC-2: Message: "Your team performed exactly as expected"
3. AC-3: [Continue] button immediately available
4. AC-4: No allocation interface shown

---

### S-EOS019: League Summary

**As a** league manager,
**I want** to see a final summary of all adjustments across the league,
**So that** I can review the complete picture.

**Acceptance Criteria:**
1. AC-1: Completion banner: "Season X ‚Üí Season Y Adjustments Complete"
2. AC-2: League totals: X improved, Y declined, Z unchanged
3. AC-3: Team summary table with improved/declined/net change/salary delta
4. AC-4: Notable changes: Biggest riser, biggest faller, biggest raise, biggest cut
5. AC-5: [Export PDF] option
6. AC-6: [Continue to Contraction/Expansion] button

---

### S-EOS020: Edge Case - No Changes for Team

**As a** league manager,
**I want** teams with no rating changes to be handled gracefully,
**So that** the UI doesn't show empty states.

**Acceptance Criteria:**
1. AC-1: Display: "No rating changes this season"
2. AC-2: Message: "All players performed as expected based on their salary"
3. AC-3: [Next Team] button available
4. AC-4: Team still counted in progress indicator

---

### S-EOS021: Mid-Phase Exit and Resume

**As a** league manager,
**I want** to save progress and resume later,
**So that** I don't lose work if interrupted.

**Acceptance Criteria:**
1. AC-1: Auto-save after each team reviewed
2. AC-2: Auto-save after manager distribution confirmed
3. AC-3: [Save & Exit] option at any point
4. AC-4: Resume returns to last incomplete step
5. AC-5: Warning before exit: "Progress will be saved"

---

### S-EOS022: Apply Adjustments

**As a** league manager,
**I want** all adjustments to be applied when I complete the phase,
**So that** player data is updated for the next season.

**Acceptance Criteria:**
1. AC-1: Rating changes applied to all players
2. AC-2: Salary changes applied to all contracts
3. AC-3: Manager distribution points applied
4. AC-4: Transaction log created for all changes
5. AC-5: Changes reflected in player profiles immediately

---

## Data Models

### EOS Adjustment State

```typescript
interface EOSAdjustmentState {
  seasonId: number;
  phase: 3;
  status: 'IN_PROGRESS' | 'COMPLETE';

  // Progress tracking
  currentTeamIndex: number;
  teamsReviewed: string[];
  managerDistributionsComplete: string[];

  // Calculations
  playerAdjustments: Map<string, PlayerAdjustment>;
  salaryAdjustments: Map<string, SalaryAdjustment>;
  managerPools: Map<string, ManagerPool>;
  managerAllocations: Map<string, ManagerAllocation[]>;

  // Summary
  leagueSummary: {
    improved: number;
    declined: number;
    unchanged: number;
    totalRatingChange: number;
    totalSalaryChange: number;
  };
}
```

### Player Adjustment

```typescript
interface PlayerAdjustment {
  playerId: string;
  playerName: string;
  teamId: string;

  // Position
  detectedPosition: string;
  peerPoolSize: number;

  // Percentiles
  salaryPercentile: number;
  salaryTier: SalaryTier;
  warPercentiles: {
    bWAR?: number;
    rWAR?: number;
    fWAR?: number;
    pWAR?: number;
  };

  // Rating changes
  ratingsBefore: PlayerRatings;
  ratingsAfter: PlayerRatings;
  ratingChanges: RatingChange[];
  netRatingChange: number;

  // Salary change
  salaryBefore: number;
  salaryAfter: number;
  salaryDelta: number;
}
```

---

## Integration Points

### Upstream Dependencies
- **Phase 2 (Awards)**: WAR calculations, season stats finalized
- **Season Stats**: All batting, pitching, fielding statistics
- **Roster Data**: Player salaries, positions, grades

### Downstream Consumers
- **Phase 4 (Contraction/Expansion)**: Uses updated ratings/salaries
- **Phase 5 (Retirements)**: Uses adjusted player values
- **Player Profiles**: Display updated ratings/salaries

---

## Screen Flow

```
Phase 2 Complete (Awards)
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Screen 1:          ‚îÇ ‚óÑ‚îÄ‚îÄ League-wide preview
‚îÇ  Overview Dashboard ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Screen 2:          ‚îÇ ‚óÑ‚îÄ‚îÄ Repeat for each team
‚îÇ  Team Reveal        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Screen 3:          ‚îÇ ‚óÑ‚îÄ‚îÄ Per team (if user manages)
‚îÇ  Manager            ‚îÇ
‚îÇ  Distribution       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Screen 4:          ‚îÇ ‚óÑ‚îÄ‚îÄ Final overview
‚îÇ  League Summary     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
    Phase 4: Contraction/
       Expansion
```

---

*Last Updated: January 29, 2026*
*Stories: S-EOS001 through S-EOS022*
~~~

### Source File: specs/stories/STORIES_RETIREMENT.md

~~~markdown
# User Stories: Retirement System

> **Feature Area**: Offseason Phase 5 - Retirements
> **Epic**: End-of-Season Player Lifecycle
> **Created**: January 29, 2026
> **Source Spec**: OFFSEASON_SYSTEM_SPEC.md ¬ß7, KBL_XHD_TRACKER_MASTER_SPEC_v3.md

---

## Overview

The Retirement phase processes player retirements team-by-team, with the goal of **1-2 players per team retiring each season**. Retirement probability is based on reverse age order (oldest players most likely), and each retirement triggers an optional jersey retirement decision.

---

## Story: S-RET001 - Calculate Retirement Probabilities

**As a** system
**I want to** calculate retirement probabilities for all players on a team
**So that** the retirement dice roll system works correctly

### Acceptance Criteria
- [ ] Players sorted by age descending (oldest first)
- [ ] Oldest player gets highest probability (~40-50%)
- [ ] Youngest player gets lowest probability (~1-5%)
- [ ] Probability decreases linearly as you go down age list
- [ ] Formula: `baseProbability = Math.max(5, 50 - (ageRank * (45 / rosterSize)))`
- [ ] Each player shows name, age, position, grade, and retirement %

### Data Structure
```typescript
interface RetirementCandidate {
  playerId: string;
  playerName: string;
  age: number;
  position: string;
  grade: string;
  retirementProbability: number;  // 0-100%
}

function calculateRetirementProbabilities(roster: Player[]): RetirementCandidate[] {
  const sorted = [...roster].sort((a, b) => b.age - a.age);

  return sorted.map((player, index) => {
    const ageRank = index;
    const rosterSize = sorted.length;
    const baseProbability = Math.max(5, 50 - (ageRank * (45 / rosterSize)));

    return {
      playerId: player.id,
      playerName: player.name,
      age: player.age,
      position: player.position,
      grade: player.grade,
      retirementProbability: baseProbability
    };
  });
}
```

### Dependencies
- Player roster with age data
- Player position and grade data

---

## Story: S-RET002 - Retirement Probability Table Display

**As a** user
**I want to** see all players on a team with their retirement probabilities
**So that** I can understand who is at risk of retiring

### Acceptance Criteria
- [ ] Table shows all players sorted by retirement probability (highest first)
- [ ] Columns: Player Name, Age, Position, Grade, Retirement %
- [ ] Probability displayed as percentage with visual bar indicator
- [ ] Higher percentages have warmer colors (red/orange)
- [ ] Lower percentages have cooler colors (green/blue)
- [ ] Team header shows team name and logo
- [ ] Counter shows "Retirements this team: X/2"

### UI Specification
- Player rows should be scrollable if roster is large
- Current retirement count visible at all times
- Clear visual hierarchy emphasizing high-risk players

---

## Story: S-RET003 - Retirement Dice Roll System

**As a** user
**I want to** roll dice to reveal if someone retires
**So that** I can experience the drama of the retirement lottery

### Acceptance Criteria
- [ ] "Reveal Retirement" button triggers dice roll
- [ ] System generates random number 0-100 for each player
- [ ] If random < player's probability, that player retires
- [ ] First player (from top) to hit their threshold retires
- [ ] If no one hits their threshold, display "No Retirement"
- [ ] Button disabled during roll animation
- [ ] Maximum 2 retirements per team per season

### Roll Logic
```typescript
function rollForRetirement(candidates: RetirementCandidate[]): RetirementResult {
  // Roll for each player starting from highest probability
  for (const candidate of candidates) {
    const roll = Math.random() * 100;
    if (roll < candidate.retirementProbability) {
      return {
        retired: true,
        player: candidate,
        roll: roll
      };
    }
  }

  return {
    retired: false,
    player: null,
    roll: null
  };
}
```

### UX Flow
1. User taps "Reveal Retirement"
2. Brief animation/suspense (1-2 seconds)
3. Result revealed with animation
4. If retirement: celebration/ceremony screen
5. If no retirement: confirmation with option to retry or skip

---

## Story: S-RET004 - Retirement Announcement Display

**As a** user
**I want to** see a dramatic announcement when a player retires
**So that** the moment feels significant and memorable

### Acceptance Criteria
- [ ] Player photo displayed prominently (120√ó120px)
- [ ] Player name in large, bold text
- [ ] Age, position, and grade displayed
- [ ] Retirement flavor text based on player age/stats
- [ ] Career summary: seasons played, key stats
- [ ] Animation: card slides up or fades in dramatically
- [ ] Top hat or retirement icon (üé©) displayed

### Flavor Text Examples
- Age 40+: "Going out on top after {seasons} seasons"
- Age 35-39: "Hanging up the cleats while still in his prime"
- Age 30-34: "A career cut short, but what a career it was"
- DROOPY personality (FA): "I don't want to start over somewhere new"
- Injury-related: "The body said it was time"

### Data Required
```typescript
interface RetirementAnnouncement {
  player: Player;
  careerSeasons: number;
  careerWAR: number;
  careerHighlights: string[];  // "3√ó All-Star", "1√ó MVP"
  flavorText: string;
  teamsPlayedFor: TeamSummary[];
}
```

---

## Story: S-RET005 - Probability Recalculation After Retirement

**As a** system
**I want to** recalculate retirement probabilities after each retirement
**So that** remaining players have updated chances

### Acceptance Criteria
- [ ] After a retirement, remove retired player from candidate list
- [ ] Recalculate all probabilities with smaller roster size
- [ ] Update UI to show new probabilities
- [ ] Probabilities will increase for remaining players
- [ ] Animation showing probability changes (optional)

### Example
Before: 12 players, oldest at 47%
After 1 retirement: 11 players, new oldest at ~50%

---

## Story: S-RET006 - Second Retirement Roll Option

**As a** user
**I want to** optionally roll for a second retirement
**So that** I can complete the target of 1-2 retirements per team

### Acceptance Criteria
- [ ] After first retirement, show two options:
  - "Reveal Second Retirement" button
  - "Skip to Jersey Retirement" button
- [ ] Second roll uses recalculated probabilities
- [ ] If second retirement occurs, proceed to both jersey retirement decisions
- [ ] Cannot exceed 2 retirements per team
- [ ] If no one retired on first roll, can "Try Again" or "Skip to Next Team"

### UI States
1. First roll pending: "Reveal Retirement" button
2. First retirement complete: "Reveal Second Retirement" + "Skip" buttons
3. Second retirement complete: Proceed to jersey retirement
4. No retirement (first roll): "Try Again" + "Skip to Next Team" buttons

---

## Story: S-RET007 - Jersey Retirement Decision UI

**As a** user
**I want to** decide whether to retire a player's jersey number
**So that** I can honor franchise legends

### Acceptance Criteria
- [ ] Prompt appears immediately after retirement announcement
- [ ] Shows all teams the player played for
- [ ] For each team, show:
  - Team name and logo
  - Jersey number with that team
  - Seasons with team
  - WAR accumulated with team
  - Awards won with team
- [ ] Checkbox for each team to retire the jersey
- [ ] Multiple teams can retire same player's number
- [ ] "Retire Selected" and "Skip" buttons
- [ ] No eligibility criteria - purely user discretion

### Data Structure
```typescript
interface JerseyRetirementOption {
  teamId: string;
  teamName: string;
  teamLogo: string;
  jerseyNumber: number;
  seasonsWithTeam: number;
  warWithTeam: number;
  awardsWithTeam: string[];
}

interface JerseyRetirementDecision {
  playerId: string;
  playerName: string;
  teams: JerseyRetirementOption[];
  selectedTeamIds: string[];  // Teams that will retire the jersey
}
```

---

## Story: S-RET008 - Jersey Retirement Ceremony Animation

**As a** user
**I want to** see a ceremony when a jersey is retired
**So that** the moment feels special and celebratory

### Acceptance Criteria
- [ ] Jersey displayed with team colors
- [ ] Player name above the number
- [ ] Retirement year shown below jersey
- [ ] Animation: jersey raised to "rafters" or spotlit
- [ ] Optional confetti/celebration effect
- [ ] Proceeds to next jersey retirement or next team

### Visual Elements
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CLEMENS   ‚îÇ  ‚Üê Player name
‚îÇ             ‚îÇ
‚îÇ     21      ‚îÇ  ‚Üê Jersey number
‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    2026       ‚Üê Retirement year
```

---

## Story: S-RET009 - Retired Numbers Data Persistence

**As a** system
**I want to** persist retired jersey numbers
**So that** they cannot be reassigned and display in the museum

### Acceptance Criteria
- [ ] Store retired number in franchise data
- [ ] Retired numbers cannot be assigned to new players
- [ ] Data includes: player name, number, team, year retired
- [ ] Multiple teams can have same player's number retired
- [ ] Data accessible for Museum ‚Üí Retired Numbers Wall

### Data Model
```typescript
interface RetiredJersey {
  playerId: string;
  playerName: string;
  jerseyNumber: number;
  teamId: string;
  teamName: string;
  retirementYear: number;  // Season number
  seasonsWithTeam: number;
  warWithTeam: number;
}

// In franchise state
interface FranchiseState {
  retiredNumbers: Record<string, RetiredJersey[]>;  // teamId ‚Üí jerseys
}
```

---

## Story: S-RET010 - Empty Roster Slot Tracking

**As a** system
**I want to** track empty roster slots after retirements
**So that** the draft phase knows how many players each team needs

### Acceptance Criteria
- [ ] Each retirement creates an empty roster slot
- [ ] Slot visually shows: "[EMPTY - {Player Name} retired]"
- [ ] Track total empty slots per team
- [ ] Pass empty slot count to Draft phase
- [ ] Empty slots filled during draft

### Example
```
ROSTER SLOT 5: [EMPTY - Roger Clemens retired]
ROSTER SLOT 8: [EMPTY - Tony Gwynn retired]
```

---

## Story: S-RET011 - Team-by-Team Retirement Navigation

**As a** user
**I want to** process retirements for each team sequentially
**So that** I can experience each team's retirement drama

### Acceptance Criteria
- [ ] Start with first team (alphabetical or standings order)
- [ ] Complete retirement process for current team before moving to next
- [ ] "Continue to Next Team" button after jersey decisions
- [ ] Progress indicator: "Team 3 of 8" or progress bar
- [ ] Cannot skip teams (all must be processed)
- [ ] After all teams: proceed to summary screen

### Navigation Flow
```
Team 1 ‚Üí Retirement Rolls ‚Üí Jersey Decisions ‚Üí
Team 2 ‚Üí Retirement Rolls ‚Üí Jersey Decisions ‚Üí
...
Team N ‚Üí Retirement Rolls ‚Üí Jersey Decisions ‚Üí
Summary Screen
```

---

## Story: S-RET012 - Retirement Phase Summary Screen

**As a** user
**I want to** see a summary of all retirements across all teams
**So that** I can review what happened before moving to the next phase

### Acceptance Criteria
- [ ] Total retirements count
- [ ] Total jerseys retired count
- [ ] List all retired players with team and position
- [ ] List all jersey retirements with team and number
- [ ] Grouped by team or in single list
- [ ] "Continue to Hall of Fame" or "Continue to Free Agency" button
- [ ] Optional: Export summary or share

### Summary Data
```typescript
interface RetirementPhaseSummary {
  totalRetirements: number;
  totalJerseysRetired: number;
  retirements: {
    player: Player;
    team: string;
    jerseyRetired: boolean;
    jerseyTeams: string[];  // If multiple teams retired the jersey
  }[];
}
```

---

## Implementation Priority

| Story | Priority | Complexity | Dependencies |
|-------|----------|------------|--------------|
| S-RET001 | P0 | Medium | Player data |
| S-RET002 | P0 | Medium | S-RET001 |
| S-RET003 | P0 | Medium | S-RET001, S-RET002 |
| S-RET004 | P0 | Medium | S-RET003 |
| S-RET005 | P1 | Low | S-RET001, S-RET003 |
| S-RET006 | P1 | Low | S-RET003, S-RET005 |
| S-RET007 | P0 | Medium | S-RET004 |
| S-RET008 | P2 | Low | S-RET007 |
| S-RET009 | P0 | Medium | S-RET007 |
| S-RET010 | P1 | Low | S-RET003 |
| S-RET011 | P1 | Medium | All above |
| S-RET012 | P2 | Low | S-RET011 |

---

## Technical Notes

### Retirement vs FA Retirement (DROOPY)
There are TWO retirement mechanisms:
1. **Phase 5 Retirement** (this feature): Age-based probability, 1-2 per team
2. **Free Agency Retirement**: DROOPY personality players retire instead of changing teams

These are separate systems but both result in the same outcome (player retired, empty roster slot).

### Hall of Fame Integration
Hall of Fame is **NOT decided at retirement**. Instead:
- HOF is a separate museum tab accessible anytime
- Users manually add retired players to HOF
- See HOF_MUSEUM_SPEC for details

### Existing Components
Based on CURRENT_STATE.md, these components exist (shell/partial):
- `RetirementsScreen.tsx` - Main retirement ceremony screen
- `RetiredNumbersWall.tsx` - Museum display for retired numbers
- `AgingBadge.tsx` - Career phase and retirement probability display

---

*End of Stories Document*
~~~

### Source File: specs/stories/STORIES_SEASON_END.md

~~~markdown
# Season End Processing - User Stories

> **Phase**: 1 of 11 (Offseason)
> **Trigger**: All regular season games completed (`gameNumber >= totalGames`)
> **Purpose**: Finalize standings, process championship, select postseason MVP, reset mojo
> **Next Phase**: Awards Ceremony (Phase 2)

---

## Overview

Season End Processing is the gateway phase that transitions from Regular Season to the full offseason. It captures competitive outcomes, applies immediate rewards, and prepares data for subsequent phases.

**Key Operations:**
1. Final Standings Calculation & Display
2. Postseason MVP Selection (if playoffs occurred)
3. Championship Processing (+1 Fame to winners)
4. Mojo Reset (all players ‚Üí Normal)

---

## User Stories

### S-SEP001: Phase Entry Validation

**As a** league manager,
**I want** the system to validate that all regular season games are complete before entering Season End Processing,
**So that** final standings and stats are accurate.

**Acceptance Criteria:**
1. AC-1: Phase 1 only accessible when `gameNumber >= totalGames`
2. AC-2: If games remaining, display "X games remaining" with option to return to Regular Season
3. AC-3: All player stats finalized and locked upon phase entry
4. AC-4: Playoff bracket validated (if playoffs configured)

**Technical Notes:**
```typescript
function canEnterSeasonEnd(season: Season): ValidationResult {
  const gamesRemaining = season.totalGames - season.gameNumber;
  if (gamesRemaining > 0) {
    return { valid: false, reason: `${gamesRemaining} games remaining` };
  }
  if (season.playoffConfigured && !season.playoffComplete) {
    return { valid: false, reason: 'Playoffs not complete' };
  }
  return { valid: true };
}
```

---

### S-SEP002: Final Standings Display

**As a** league manager,
**I want** to see the final standings for all teams organized by division,
**So that** I can review the competitive results before proceeding.

**Acceptance Criteria:**
1. AC-1: Display standings grouped by division
2. AC-2: Each team shows: Rank, Name, W-L, Win%, GB (Games Behind)
3. AC-3: Division winners highlighted with üèÜ indicator
4. AC-4: Playoff seeds shown (1-8 or configured number)
5. AC-5: Wildcard teams indicated if applicable
6. AC-6: [Confirm Standings] button to proceed

**Data Display:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FINAL STANDINGS - SEASON 5                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  EAST DIVISION                                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ
‚îÇ  üèÜ 1. Thunderhawks    95-67  .586   -    [1]      ‚îÇ
‚îÇ     2. Cyclones        88-74  .543   7    [4]      ‚îÇ
‚îÇ     3. Nightwings      82-80  .506  13             ‚îÇ
‚îÇ     4. Ironclads       71-91  .438  24             ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  WEST DIVISION                                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ
‚îÇ  üèÜ 1. Wildcats        92-70  .568   -    [2]      ‚îÇ
‚îÇ     2. Storm           89-73  .549   3    [3]      ‚îÇ
‚îÇ     3. Renegades       78-84  .481  14    [WC]     ‚îÇ
‚îÇ     4. Pioneers        65-97  .401  27             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              [ Confirm Standings ‚Üí ]
```

---

### S-SEP003: Playoff Seed Assignment

**As a** league manager,
**I want** playoff seeds automatically calculated based on regular season records,
**So that** the bracket is set correctly.

**Acceptance Criteria:**
1. AC-1: Division winners get top seeds (1 & 2)
2. AC-2: Remaining seeds by best record
3. AC-3: Tiebreakers applied: Head-to-head ‚Üí Division record ‚Üí Run differential
4. AC-4: Wildcard slots filled based on configured playoff format
5. AC-5: Seeds displayed next to team names in standings

**Technical Notes:**
```typescript
interface PlayoffSeed {
  seed: number;
  teamId: string;
  seedType: 'DIVISION_WINNER' | 'WILDCARD' | 'BEST_RECORD';
  record: { wins: number; losses: number };
  tiebreaker?: string;  // If tiebreaker was applied
}

function calculatePlayoffSeeds(
  standings: TeamStanding[],
  config: PlayoffConfig
): PlayoffSeed[] {
  // 1. Division winners get seeds 1-2 (or however many divisions)
  // 2. Fill remaining seeds by best record
  // 3. Apply tiebreakers as needed
  // 4. Return ordered seed array
}
```

---

### S-SEP004: Postseason MVP Candidates (Conditional)

**As a** league manager,
**I want** to see the top 3 postseason MVP candidates if playoffs occurred,
**So that** I can select the most deserving player.

**Acceptance Criteria:**
1. AC-1: Only displayed if `season.playoffGames.length > 0`
2. AC-2: Candidates ranked by postseason WAR (playoff games only)
3. AC-3: Display as face-down cards initially
4. AC-4: User clicks each card to reveal candidate
5. AC-5: Skip this screen entirely if no playoffs occurred

**Postseason WAR Calculation:**
```typescript
function calculatePostseasonWAR(
  playerId: string,
  playoffGames: Game[]
): number {
  // Filter to games where player participated
  // Calculate WAR using playoff-only stats
  // Weight championship round games higher (1.5x)
  return postseasonWAR;
}
```

**Candidate Data:**
```typescript
interface PostseasonMVPCandidate {
  playerId: string;
  playerName: string;
  teamName: string;
  position: string;
  postseasonWAR: number;
  playoffStats: {
    gamesPlayed: number;
    // Hitters
    avg?: number;
    hr?: number;
    rbi?: number;
    // Pitchers
    era?: number;
    wins?: number;
    saves?: number;
  };
}
```

---

### S-SEP005: Postseason MVP Card Reveal

**As a** league manager,
**I want** to reveal each MVP candidate through a card flip interaction,
**So that** the selection feels ceremonial and engaging.

**Acceptance Criteria:**
1. AC-1: Three face-down cards displayed (Bronze, Silver, Gold frames)
2. AC-2: Click card to flip and reveal candidate
3. AC-3: Card shows: Player name, team, position, postseason WAR, key stats
4. AC-4: Cards remain revealed once flipped
5. AC-5: All three must be revealed before selection enabled
6. AC-6: Reveal order: 3rd place ‚Üí 2nd place ‚Üí 1st place (by WAR)

**Card States:**
```typescript
type CardState = 'FACE_DOWN' | 'REVEALING' | 'REVEALED';

interface MVPCard {
  rank: 1 | 2 | 3;
  state: CardState;
  candidate: PostseasonMVPCandidate;
  frameStyle: 'GOLD' | 'SILVER' | 'BRONZE';
}
```

---

### S-SEP006: Postseason MVP Selection

**As a** league manager,
**I want** to select the postseason MVP from the revealed candidates,
**So that** the award is recorded and bonuses applied.

**Acceptance Criteria:**
1. AC-1: After all cards revealed, [Select as MVP] button appears on each
2. AC-2: User can select any of the three candidates (not just #1 by WAR)
3. AC-3: Selected player receives +10 rating points (max +5 per category)
4. AC-4: Confirmation modal shows rating distribution before finalizing
5. AC-5: Award recorded in player history and season records

**Rating Bonus Distribution:**
```typescript
interface MVPRatingBonus {
  playerId: string;
  totalBonus: 10;  // Always +10 total
  distribution: {
    category: RatingCategory;
    bonus: number;  // Max 5 per category
  }[];
}

// Example distribution for a hitter:
// Contact +5, Power +3, Speed +2 = 10 total

// System auto-distributes based on player's lowest ratings
// to help balance their profile
```

---

### S-SEP007: Championship Team Identification

**As a** league manager,
**I want** the system to identify the championship-winning team,
**So that** appropriate bonuses can be applied.

**Acceptance Criteria:**
1. AC-1: Championship team identified from playoff bracket winner
2. AC-2: Display championship team name with trophy graphic
3. AC-3: List all players on championship roster (at season end)
4. AC-4: Show "+1 Fame" indicator next to each player
5. AC-5: If no playoffs configured, skip championship processing

**Technical Notes:**
```typescript
interface ChampionshipResult {
  teamId: string;
  teamName: string;
  seasonNumber: number;
  rosterAtChampionship: string[];  // Player IDs
  opponentTeamId: string;
  seriesResult: string;  // e.g., "4-2"
}
```

---

### S-SEP008: Championship Fame Bonus Application

**As a** league manager,
**I want** all players on the championship team to receive +1 Fame bonus,
**So that** their career achievements are properly recorded.

**Acceptance Criteria:**
1. AC-1: Each player on championship roster gets +1 Fame Bonus
2. AC-2: Fame bonus is cumulative (persists across seasons)
3. AC-3: Player's `Championships` counter incremented
4. AC-4: Confirmation screen shows all affected players
5. AC-5: Fame affects future award voting (8% weight in MVP voting)

**Fame Update:**
```typescript
function applyChampionshipFame(
  championshipTeam: Team,
  roster: Player[]
): FameUpdate[] {
  return roster.map(player => ({
    playerId: player.id,
    previousFame: player.fameBonus,
    newFame: player.fameBonus + 1,
    previousChampionships: player.championships,
    newChampionships: player.championships + 1,
    reason: `Season ${season.number} Championship`
  }));
}
```

---

### S-SEP009: Championship Morale Boost

**As a** league manager,
**I want** championship-winning players to receive a morale boost,
**So that** their happiness reflects the achievement.

**Acceptance Criteria:**
1. AC-1: All championship players receive +20 Morale magnitude
2. AC-2: Event type: CHAMPIONSHIP
3. AC-3: Morale boost affects retirement probability (lower risk)
4. AC-4: Morale boost affects free agency decisions
5. AC-5: Effect displayed on confirmation screen

**Morale Event:**
```typescript
const championshipMoraleEvent: MoraleEvent = {
  type: 'CHAMPIONSHIP',
  magnitude: 20,
  duration: 'PERMANENT',  // Persists until superseded
  description: 'Won the championship'
};
```

---

### S-SEP010: Mojo Reset

**As a** league manager,
**I want** all players' mojo to reset to Normal at season end,
**So that** everyone starts the new season on equal footing.

**Acceptance Criteria:**
1. AC-1: All players (all teams, all rosters) reset to Normal mojo
2. AC-2: Previous mojo state (Hot/Cold/Special) cleared
3. AC-3: Reset applies regardless of team or roster status
4. AC-4: Confirmation message: "All player mojo reset to Normal"
5. AC-5: Mojo reset is automatic (no user interaction required)

**Technical Notes:**
```typescript
function resetAllMojo(players: Player[]): void {
  players.forEach(player => {
    player.mojo = {
      state: 'NORMAL',
      previousState: player.mojo.state,
      resetReason: 'SEASON_END',
      resetDate: new Date()
    };
  });
}
```

---

### S-SEP011: Season Archive

**As a** league manager,
**I want** the completed season to be archived for historical reference,
**So that** I can look back at past seasons.

**Acceptance Criteria:**
1. AC-1: All season stats archived with timestamp
2. AC-2: Final standings preserved
3. AC-3: Award winners recorded (linked to Phase 2)
4. AC-4: Championship result recorded
5. AC-5: Archive accessible from History/Museum section

**Archive Structure:**
```typescript
interface SeasonArchive {
  seasonNumber: number;
  year: number;
  finalStandings: DivisionStandings[];
  playoffBracket?: PlayoffBracket;
  champion?: {
    teamId: string;
    teamName: string;
    roster: string[];
  };
  postseasonMVP?: {
    playerId: string;
    playerName: string;
  };
  leagueLeaders: LeagueLeader[];
  // Awards populated after Phase 2
  awards?: SeasonAwards;
}
```

---

### S-SEP012: Phase Completion Confirmation

**As a** league manager,
**I want** to confirm all Season End Processing is complete before advancing,
**So that** I don't accidentally skip important steps.

**Acceptance Criteria:**
1. AC-1: Summary screen shows all completed actions
2. AC-2: Checklist format: ‚úì Standings Confirmed, ‚úì MVP Selected (if applicable), etc.
3. AC-3: [Proceed to Awards Ceremony ‚Üí] button enabled only when all complete
4. AC-4: Warning if any step incomplete
5. AC-5: Cannot return to Regular Season after confirming

**Summary Checklist:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SEASON END PROCESSING COMPLETE                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚úì Final standings calculated and confirmed         ‚îÇ
‚îÇ  ‚úì Playoff seeds assigned (8 teams)                 ‚îÇ
‚îÇ  ‚úì Postseason MVP selected: Mike Johnson            ‚îÇ
‚îÇ  ‚úì Championship processed: Thunderhawks             ‚îÇ
‚îÇ  ‚úì Fame bonuses applied (25 players)                ‚îÇ
‚îÇ  ‚úì Mojo reset for all players (200 players)         ‚îÇ
‚îÇ  ‚úì Season 5 archived                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      [ Proceed to Awards Ceremony ‚Üí ]
```

---

### S-SEP013: No Playoffs Path

**As a** league manager,
**I want** the system to handle seasons where no playoffs occurred,
**So that** I can still complete Season End Processing.

**Acceptance Criteria:**
1. AC-1: If no playoffs configured, skip postseason MVP screen
2. AC-2: If no playoffs, skip championship processing
3. AC-3: Display message: "No playoffs this season"
4. AC-4: Mojo reset still occurs
5. AC-5: Season archive still created (without champion)

**Flow Adjustment:**
```typescript
function getSeasonEndSteps(season: Season): SeasonEndStep[] {
  const steps: SeasonEndStep[] = [
    'FINAL_STANDINGS',
    'MOJO_RESET',
    'SEASON_ARCHIVE',
    'CONFIRMATION'
  ];

  if (season.playoffGames.length > 0) {
    // Insert playoff-specific steps
    steps.splice(1, 0, 'POSTSEASON_MVP', 'CHAMPIONSHIP');
  }

  return steps;
}
```

---

### S-SEP014: Mid-Phase Exit and Resume

**As a** league manager,
**I want** to be able to exit Season End Processing and resume later,
**So that** I don't lose progress if interrupted.

**Acceptance Criteria:**
1. AC-1: Progress auto-saved after each completed step
2. AC-2: [Save & Exit] option available at any point
3. AC-3: Resume button on main menu returns to last incomplete step
4. AC-4: Completed steps remain completed on resume
5. AC-5: Warning before exit: "Progress will be saved"

**Progress Tracking:**
```typescript
interface SeasonEndProgress {
  seasonId: number;
  currentStep: SeasonEndStep;
  completedSteps: SeasonEndStep[];
  standingsConfirmed: boolean;
  postseasonMVPId?: string;
  championshipProcessed: boolean;
  mojoReset: boolean;
  archived: boolean;
}
```

---

## Data Models

### Season End State

```typescript
interface SeasonEndState {
  seasonId: number;
  phase: 1;
  status: 'IN_PROGRESS' | 'COMPLETE';

  // Step tracking
  currentStep: SeasonEndStep;
  completedSteps: SeasonEndStep[];

  // Results
  finalStandings: {
    divisions: DivisionStanding[];
    playoffSeeds: PlayoffSeed[];
    wildcards: TeamId[];
  };

  postseasonMVP?: {
    candidates: PostseasonMVPCandidate[];
    selectedId: string;
    ratingBonus: MVPRatingBonus;
  };

  championship?: {
    teamId: string;
    roster: string[];
    fameUpdates: FameUpdate[];
    moraleBoosts: MoraleEvent[];
  };

  mojoResetComplete: boolean;
  archiveCreated: boolean;
}

type SeasonEndStep =
  | 'FINAL_STANDINGS'
  | 'POSTSEASON_MVP'
  | 'CHAMPIONSHIP'
  | 'MOJO_RESET'
  | 'SEASON_ARCHIVE'
  | 'CONFIRMATION';
```

### Standings Model

```typescript
interface DivisionStanding {
  divisionId: string;
  divisionName: string;
  teams: TeamStanding[];
}

interface TeamStanding {
  teamId: string;
  teamName: string;
  rank: number;
  wins: number;
  losses: number;
  winPct: number;
  gamesBehind: number;
  divisionWinner: boolean;
  playoffSeed?: number;
  isWildcard: boolean;
  tiebreaker?: string;
}
```

---

## Integration Points

### Upstream Dependencies
- **Regular Season**: All games must be complete
- **Playoff System**: Bracket results if playoffs configured
- **Stats System**: Final season stats for WAR calculations

### Downstream Consumers
- **Phase 2 (Awards)**: Uses finalized stats, standings for voting
- **Phase 5 (Retirements)**: Uses morale from championship boost
- **Phase 6 (Free Agency)**: Uses fame for player valuation
- **History/Museum**: Archives season data

---

## Edge Cases

1. **Tie for playoff spot**: Apply tiebreakers (H2H ‚Üí Division ‚Üí Run Diff)
2. **Multiple players same postseason WAR**: Use championship round WAR as tiebreaker
3. **Championship team had roster changes**: Use roster at final game
4. **Season ended early (contraction mid-season)**: Skip to reduced standings
5. **No games played (expansion team)**: Show 0-0 record, exclude from playoffs

---

## Screen Flow

```
Regular Season Complete
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Final Standings    ‚îÇ ‚óÑ‚îÄ‚îÄ Confirm to proceed
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Postseason MVP     ‚îÇ ‚óÑ‚îÄ‚îÄ Card reveal + selection (if playoffs)
‚îÇ  (conditional)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Championship       ‚îÇ ‚óÑ‚îÄ‚îÄ Fame bonus application (if playoffs)
‚îÇ  (conditional)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mojo Reset         ‚îÇ ‚óÑ‚îÄ‚îÄ Automatic, brief confirmation
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Phase Complete     ‚îÇ ‚óÑ‚îÄ‚îÄ Summary checklist
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
    Awards Ceremony
      (Phase 2)
```

---

*Last Updated: January 29, 2026*
*Stories: S-SEP001 through S-SEP014*
~~~

### Source File: specs/stories/STORIES_TRADE.md

~~~markdown
# Trade Phase - User Stories

> **Feature Area**: Offseason Phase - Trade Phase
> **Platform**: iPad-first (1024√ó768 minimum)
> **Created**: January 29, 2026
> **Source**: User design screenshots, OFFSEASON_SYSTEM_SPEC.md

---

## Overview

The Trade Phase allows teams to exchange players through two-way or three-way trades. This phase occurs after the Draft and before Finalize & Advance, giving teams flexibility to reshape their rosters before the final validation.

### Key Principles

1. **No Salary Matching** - Teams can increase or decrease payroll freely
2. **Advisory Warnings** - Beat reporters provide hints (may or may not be accurate)
3. **AI Protection** - AI teams won't accept clearly exploitative trades
4. **AI Proposals** - AI teams can propose trades to the user
5. **Full Roster Access** - MLB, Farm, and new draftees are all tradeable
6. **Waiver Wire** - Released players go through waiver claims (reverse standings order)

---

## Phase Context

**Preceding Phase:**
- Phase 7: Draft (Farm-First) - Farm rosters may exceed 10 temporarily

**This Phase:**
- Phase 8: Trade Phase

**Following Phase:**
- Phase 9: Finalize & Advance (rosters must balance to 22 MLB + 10 Farm)

---

## User Stories

### Section 1: Trade Interface

#### S-TRD001: Access Trade Phase
**As a** user in the offseason
**I want to** access the Trade phase
**So that** I can trade players between teams

**Acceptance Criteria:**
- Trade tab visible in offseason navigation
- Shows "TRADES" tab between Draft and Finalize & Advance
- Defaults to Two-Way Trade view
- Team 1 defaults to user's team

---

#### S-TRD002: Select Trade Type
**As a** user initiating a trade
**I want to** choose between two-way and three-way trades
**So that** I can execute complex multi-team deals

**Acceptance Criteria:**
- Tab selector: [TWO-WAY TRADE] | [THREE-WAY TRADE]
- Two-way shows Team 1 and Team 2 panels
- Three-way shows Team 1, Team 2, and Team 3 panels
- Switching tabs clears current selections

**Trade Types:**
```
TWO-WAY:  Team A ‚Üê‚Üí Team B
          (Direct swap of players)

THREE-WAY: Team A ‚Üí Team B ‚Üí Team C ‚Üí Team A
           (Circular trade, each team gives and receives)
```

---

#### S-TRD003: Select Teams for Trade
**As a** user setting up a trade
**I want to** select which teams are involved
**So that** I can trade between any two or three teams

**Acceptance Criteria:**
- Each team panel has dropdown selector
- Dropdown lists all teams alphabetically
- User's team(s) marked with ‚≠ê
- Cannot select same team twice in one trade
- Selecting a team loads their available players

---

#### S-TRD004: View Available Players
**As a** user selecting players to trade
**I want to** see all available players from each team
**So that** I can make informed trade decisions

**Acceptance Criteria:**
- Player list shows all tradeable players
- Each player card displays:
  - Name
  - Position (CF, SP, etc.)
  - OVR (overall rating / grade equivalent)
  - Salary
- Players grouped by roster:
  - MLB Roster (22 players)
  - Farm Roster (may exceed 10 after draft)
  - Includes new draftees
- Sortable by: Position, OVR, Salary, Name
- Search/filter option

**Player Card Format:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  J. Rodriguez              $15.2M   ‚îÇ
‚îÇ  CF ‚Ä¢ OVR 92                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

#### S-TRD005: Select Players for Trade
**As a** user building a trade package
**I want to** select players from each team
**So that** I can construct the trade

**Acceptance Criteria:**
- Click/tap player to toggle selection
- Selected players highlighted
- Running counter shows: "TRADING: X players"
- Running total shows: "TOTAL: $X.XM"
- Can select multiple players per team
- Selected players visually distinct (highlight, checkmark, or moved to "trading" section)

---

#### S-TRD006: View Trade Summary
**As a** user reviewing a trade
**I want to** see the complete trade summary
**So that** I can understand the full impact

**Acceptance Criteria:**
- Summary shows all players moving in each direction
- Salary impact displayed for each team:
  - "Tigers: +$2.7M payroll"
  - "Sox: -$2.7M payroll"
- Net salary swing prominently displayed
- Position changes noted (e.g., "Gaining: CF, SP | Losing: 3B")

---

### Section 2: Beat Reporter Warnings

#### S-TRD007: Receive Beat Reporter Warnings
**As a** user proposing a trade
**I want to** see beat reporter commentary
**So that** I can consider potential consequences

**Acceptance Criteria:**
- Beat reporter pop-up appears before trade confirmation
- Warnings are ADVISORY ONLY (do not block trade)
- Warnings may or may not be accurate (adds uncertainty)
- Multiple warnings can appear for complex trades
- User can dismiss and proceed anyway

**Warning Categories:**
| Category | Example Warning |
|----------|-----------------|
| **Morale** | "Word is the clubhouse isn't thrilled. Martinez was popular." |
| **Relationships** | "Rodriguez and your catcher have been close friends for years." |
| **Fan Reaction** | "Fans might not understand trading a fan favorite for salary relief." |
| **Player Happiness** | "Sources say Johnson has always wanted to play for the Tigers." |
| **Team Chemistry** | "Adding another high-ego player could disrupt your clubhouse." |
| **AI Skepticism** | "Our sources are skeptical the Sox will accept this offer." |

**Warning Display:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üì∞ BEAT WRITER                                               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ "Word is the clubhouse isn't thrilled about this deal.      ‚îÇ
‚îÇ  Martinez was popular in the locker room. Also, don't be    ‚îÇ
‚îÇ  surprised if fans boo Rodriguez on opening day - they      ‚îÇ
‚îÇ  loved that guy."                                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ ‚ö†Ô∏è These reports may or may not be accurate.                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

#### S-TRD008: Beat Reporter Accuracy Variance
**As a** user receiving beat reporter warnings
**I want** the warnings to have variable accuracy
**So that** I can't always predict outcomes perfectly

**Acceptance Criteria:**
- Warnings have hidden accuracy rating (60-90% accurate)
- Some warnings are "hot takes" that don't pan out
- System tracks warning accuracy for reporter reputation over time
- Creates uncertainty and replayability

**Accuracy Logic:**
```typescript
interface BeatReporterWarning {
  message: string;
  category: 'MORALE' | 'RELATIONSHIP' | 'FAN' | 'CHEMISTRY' | 'AI_HINT';
  accuracy: number;        // 0.6 to 0.9 (hidden from user)
  actuallyTrue: boolean;   // Determined at trade time, revealed through consequences
}
```

---

### Section 3: Trade Execution

#### S-TRD009: Propose Trade
**As a** user with a complete trade package
**I want to** propose the trade
**So that** it can be evaluated and potentially accepted

**Acceptance Criteria:**
- [PROPOSE TRADE] button enabled when:
  - At least one player selected from each team
  - All involved teams have valid selections
- Clicking propose triggers:
  1. Beat reporter warnings display
  2. User confirms or cancels
  3. AI evaluation (if AI team involved)
  4. Trade accepted or rejected

---

#### S-TRD010: AI Trade Evaluation
**As a** user proposing a trade to an AI team
**I want** the AI to realistically evaluate the offer
**So that** I can't exploit the system with lopsided trades

**Acceptance Criteria:**
- AI evaluates trade based on:
  - WAR comparison (total value)
  - Team needs (positional gaps)
  - Salary implications (payroll flexibility)
  - Prospect potential (ceiling vs current grade)
  - Player age (years of value remaining)
  - Chemistry fit (personality compatibility)
- AI can: ACCEPT, REJECT, or COUNTER
- AI won't accept clearly exploitative trades
- AI may accept slightly unfavorable trades if fills urgent need

**AI Evaluation Factors:**
```typescript
interface TradeEvaluation {
  warDifferential: number;      // Positive = AI gains value
  positionNeedFilled: boolean;  // Does this fill a gap?
  salarySavings: number;        // Positive = AI saves money
  prospectPotential: number;    // Ceiling value of prospects received
  ageAdvantage: number;         // Younger players = more value
  chemistryFit: number;         // Personality compatibility score

  // Decision threshold
  overallScore: number;         // Weighted combination
  decision: 'ACCEPT' | 'REJECT' | 'COUNTER';
}
```

**AI Decision Thresholds:**
| Score | Decision |
|-------|----------|
| ‚â• 0.7 | ACCEPT immediately |
| 0.4 - 0.69 | ACCEPT if fills need, else COUNTER |
| 0.2 - 0.39 | COUNTER with modified offer |
| < 0.2 | REJECT outright |

---

#### S-TRD011: Trade Acceptance
**As a** user whose trade is accepted
**I want** the trade to execute properly
**So that** players move to their new teams

**Acceptance Criteria:**
- On acceptance:
  - Players removed from original team rosters
  - Players added to new team rosters
  - Salary adjustments applied
  - Trade logged in transaction history
  - Morale effects queued (applied over time)
- Confirmation message displays trade details
- Teams' roster counts update immediately

**Post-Trade State Changes:**
```typescript
function executeTrade(trade: Trade): void {
  for (const movement of trade.playerMovements) {
    // Remove from old team
    removeFromRoster(movement.player, movement.fromTeam);

    // Add to new team
    addToRoster(movement.player, movement.toTeam);

    // Queue morale effects (processed over time)
    queueMoraleEffect(movement.player, 'TRADED');
    queueTeamChemistryUpdate(movement.fromTeam);
    queueTeamChemistryUpdate(movement.toTeam);
  }

  // Log transaction
  logTransaction(trade);
}
```

---

#### S-TRD012: Trade Rejection
**As a** user whose trade is rejected by AI
**I want** to understand why and have options
**So that** I can adjust my offer

**Acceptance Criteria:**
- Rejection message indicates general reason:
  - "The Tigers don't see enough value in this deal."
  - "The Sox aren't willing to part with their ace."
  - "Detroit is looking for pitching, not position players."
- Options after rejection:
  - [Modify Offer] - Return to trade builder
  - [Try Different Trade] - Clear and start over
  - [Cancel] - Exit trade flow

---

#### S-TRD013: AI Counter-Offer
**As a** user receiving a counter-offer from AI
**I want** to see their modified proposal
**So that** I can accept, modify, or decline

**Acceptance Criteria:**
- Counter-offer shows:
  - Original offer (crossed out or dimmed)
  - AI's counter-proposal
  - What changed (added/removed players)
- User options:
  - [Accept Counter] - Execute the counter-offer
  - [Modify] - Continue negotiating
  - [Decline] - End negotiation

**Counter-Offer Display:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üîÑ COUNTER-OFFER FROM DETROIT TIGERS                          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë  YOUR OFFER:                    THEIR COUNTER:                 ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                 ‚ïë
‚ïë  You give:                      You give:                      ‚ïë
‚ïë  ‚Ä¢ M. Chen (SP)                 ‚Ä¢ M. Chen (SP)                 ‚ïë
‚ïë                                 ‚Ä¢ K. Wilson (RP) ‚Üê ADDED       ‚ïë
‚ïë                                                                ‚ïë
‚ïë  You get:                       You get:                       ‚ïë
‚ïë  ‚Ä¢ J. Rodriguez (CF)            ‚Ä¢ J. Rodriguez (CF)            ‚ïë
‚ïë                                 ‚Ä¢ R. Davis (3B) ‚Üê ADDED        ‚ïë
‚ïë                                                                ‚ïë
‚ïë  Salary Impact: +$2.7M ‚Üí +$5.8M                                ‚ïë
‚ïë                                                                ‚ïë
‚ïë      [ ACCEPT COUNTER ]   [ MODIFY ]   [ DECLINE ]             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

### Section 4: AI Trade Proposals

#### S-TRD014: Receive AI Trade Proposal
**As a** user during the trade phase
**I want** AI teams to propose trades to me
**So that** I have more trade opportunities

**Acceptance Criteria:**
- AI teams can initiate trade proposals
- Notification appears: "üì® Trade Proposal from [Team]"
- User can view proposal details
- Options: [Accept] [Counter] [Decline]
- AI proposals based on:
  - AI team needs vs user's roster surplus
  - Realistic trade logic
  - Adaptive engine learning

**AI Proposal Triggers:**
| Trigger | Example |
|---------|---------|
| **Position Surplus** | AI has 3 good SS, user needs SS |
| **Salary Dump** | AI over budget, wants to shed salary |
| **Playoff Push** | AI contending, wants to add talent |
| **Rebuild** | AI rebuilding, wants prospects for vets |
| **Random** | Occasional "shake things up" offers |

---

#### S-TRD015: AI Proposal Queue
**As a** user with multiple AI proposals
**I want** to see all pending proposals
**So that** I can review and respond to each

**Acceptance Criteria:**
- Inbox/queue shows all pending proposals
- Each proposal shows: Team, Key players involved, Salary impact
- Proposals expire at end of Trade Phase if not addressed
- Can respond in any order

**Proposal Queue:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üì® TRADE PROPOSALS (3)                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  üîµ Detroit Tigers                                           ‚îÇ
‚îÇ     Offering: J. Rodriguez (CF, 92)                          ‚îÇ
‚îÇ     Wanting: M. Chen (SP, 88)                                ‚îÇ
‚îÇ     Salary: +$2.7M                          [VIEW DETAILS]   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  üîµ Miami Marlins                                            ‚îÇ
‚îÇ     Offering: T. Smith (1B, 85) + prospect                   ‚îÇ
‚îÇ     Wanting: R. Johnson (1B, 91)                             ‚îÇ
‚îÇ     Salary: -$4.2M                          [VIEW DETAILS]   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  üîµ Chicago Cubs                                             ‚îÇ
‚îÇ     Offering: Draft pick compensation                        ‚îÇ
‚îÇ     Wanting: K. Wilson (RP, 78)                              ‚îÇ
‚îÇ     Salary: -$4.2M                          [VIEW DETAILS]   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Section 5: Three-Way Trades

#### S-TRD016: Configure Three-Way Trade
**As a** user executing a complex trade
**I want to** set up a three-way trade
**So that** I can facilitate deals that wouldn't work two-way

**Acceptance Criteria:**
- Three team panels displayed
- Each team sends players AND receives players
- Circular flow: A‚ÜíB, B‚ÜíC, C‚ÜíA
- All three teams must have valid selections
- AI evaluates from each team's perspective

**Three-Way Trade Flow:**
```
        TEAM A (User)
        Sends: SP
        Gets: CF
            ‚Üë      ‚Üò
           /        \
          /          ‚Üì
    TEAM C          TEAM B
    Sends: CF       Sends: 3B
    Gets: 3B        Gets: SP
```

---

#### S-TRD017: Three-Way Trade Validation
**As a** user proposing a three-way trade
**I want** all three teams to evaluate independently
**So that** the trade only executes if all agree

**Acceptance Criteria:**
- Each AI team evaluates their portion independently
- Trade only succeeds if ALL teams accept
- If any team rejects, entire trade fails
- Counter-offers more complex (may only modify one leg)
- Display shows each team's status: ‚úì Accepted | ‚úó Rejected | ‚è≥ Pending

---

### Section 6: Waiver Wire

#### S-TRD018: Release Player Triggers Waiver Wire
**As a** team releasing a player during Finalize & Advance
**I want** other teams to have a chance to claim them
**So that** good players don't just disappear

**Acceptance Criteria:**
- When any team releases a player ‚Üí Waiver Wire triggered
- Claim order: Reverse of previous season standings (worst team first)
- Each team gets one chance to claim or pass
- If claimed: Player joins claiming team
- If all pass: Player goes to Inactive Player Database

**Waiver Wire Flow:**
```
Player Released by Team A
         ‚Üì
WAIVER WIRE BEGINS
         ‚Üì
Team with worst record: CLAIM or PASS?
         ‚Üì
If PASS ‚Üí Next worst team: CLAIM or PASS?
         ‚Üì
... continues through all teams ...
         ‚Üì
If ALL PASS ‚Üí Player retires (Inactive DB)
```

---

#### S-TRD019: AI Waiver Wire Decisions
**As a** user observing the waiver wire
**I want** AI teams to make realistic claim decisions
**So that** the system feels authentic

**Acceptance Criteria:**
- AI evaluates each waiver claim based on:
  - Does player fill a need?
  - Can team afford the salary?
  - Is player's grade worth a roster spot?
  - Would claim require dropping someone valuable?
- AI more likely to claim if:
  - Player grade ‚â• B
  - Position is a team need
  - Salary is reasonable
- AI less likely if:
  - Would have to drop better player
  - Already strong at that position
  - Salary is prohibitive

---

#### S-TRD020: User Waiver Wire Claim
**As a** user with waiver priority
**I want to** claim players on waivers
**So that** I can add talent my rivals released

**Acceptance Criteria:**
- Notification when player hits waivers: "Player X on waivers - You have claim #3"
- When user's turn:
  - Show player details (Name, Position, Grade, Salary)
  - Show user's roster status
  - Options: [CLAIM] or [PASS]
- If claiming with full roster:
  - Must select player to drop
  - Dropped player also goes to waivers (but user can't reclaim)
- Time limit or auto-pass for user turns (prevents blocking)

**Waiver Claim Screen:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üìã WAIVER WIRE CLAIM                                          ‚ïë
‚ïë  Your claim priority: #3 of 20                                 ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë  PLAYER AVAILABLE:                                             ‚ïë
‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚ïë
‚ïë  ‚îÇ  M. JOHNSON                                            ‚îÇ    ‚ïë
‚ïë  ‚îÇ  Shortstop ‚îÇ Grade: B- ‚îÇ Age: 28 ‚îÇ Salary: $6.2M      ‚îÇ    ‚ïë
‚ïë  ‚îÇ                                                        ‚îÇ    ‚ïë
‚ïë  ‚îÇ  Released by: Detroit Tigers                           ‚îÇ    ‚ïë
‚ïë  ‚îÇ  Last Season: .275 AVG, 18 HR, 2.1 WAR                ‚îÇ    ‚ïë
‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚ïë
‚ïë                                                                ‚ïë
‚ïë  YOUR ROSTER STATUS:                                           ‚ïë
‚ïë  MLB: 22/22 (FULL) ‚îÇ Farm: 11/10 (OVER)                       ‚ïë
‚ïë                                                                ‚ïë
‚ïë  ‚ö†Ô∏è You must drop a player to claim.                          ‚ïë
‚ïë  Select player to drop: [ K. Wilson (RP, C+)        ‚ñº ]       ‚ïë
‚ïë                                                                ‚ïë
‚ïë              [ PASS ]                    [ CLAIM ]             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

#### S-TRD021: Waiver Wire Results
**As a** user tracking waiver activity
**I want** to see all waiver wire results
**So that** I know where released players ended up

**Acceptance Criteria:**
- Summary shows all waiver transactions
- Each entry shows: Player, Released By, Claimed By (or "Unclaimed")
- If unclaimed: "Added to Inactive Player Database"
- Results accessible from Trade Phase summary

---

### Section 7: Trade Utilities

#### S-TRD022: Clear Trade
**As a** user wanting to start over
**I want to** clear my current trade selections
**So that** I can begin fresh

**Acceptance Criteria:**
- [CLEAR] button visible at all times
- Clears all selected players from all teams
- Resets counters to "TRADING: 0 players" and "TOTAL: $0.0M"
- Does not change selected teams
- Confirmation not required (easy undo by reselecting)

---

#### S-TRD023: Trade History
**As a** user reviewing past trades
**I want to** see all trades made this offseason
**So that** I can track what's happened

**Acceptance Criteria:**
- Trade History section/tab shows all completed trades
- Each trade shows:
  - Teams involved
  - Players exchanged
  - Salary impact
  - Date/time of trade
- Filterable by team
- Exportable/printable for reference

---

#### S-TRD024: Trade Phase Completion
**As a** user finishing the trade phase
**I want to** confirm I'm done trading
**So that** I can proceed to Finalize & Advance

**Acceptance Criteria:**
- [Continue to Finalize & Advance ‚Üí] button
- Confirmation: "Are you done trading? You can still trade during Finalize if needed."
- Pending AI proposals expire (or prompt to address them)
- All trades logged in transaction history
- Proceed to Finalize & Advance phase

---

## Data Models

### Trade
```typescript
interface Trade {
  id: string;
  type: 'TWO_WAY' | 'THREE_WAY';
  status: 'PROPOSED' | 'ACCEPTED' | 'REJECTED' | 'COUNTERED';
  teams: string[];                    // Team IDs involved
  playerMovements: PlayerMovement[];
  salaryImpact: Map<string, number>;  // TeamID ‚Üí salary change
  proposedBy: string;                 // Team ID or 'USER'
  proposedAt: Date;
  resolvedAt?: Date;
  beatReporterWarnings: BeatReporterWarning[];
}

interface PlayerMovement {
  playerId: string;
  playerName: string;
  position: Position;
  grade: Grade;
  salary: number;
  fromTeamId: string;
  toTeamId: string;
  fromRoster: 'MLB' | 'FARM';
  toRoster: 'MLB' | 'FARM';
}
```

### Waiver Claim
```typescript
interface WaiverClaim {
  id: string;
  playerId: string;
  playerName: string;
  releasedBy: string;              // Team ID
  claimOrder: string[];            // Team IDs in claim order
  currentClaimIndex: number;
  status: 'ACTIVE' | 'CLAIMED' | 'UNCLAIMED';
  claimedBy?: string;              // Team ID if claimed
  droppedPlayerId?: string;        // Player dropped to make room
  createdAt: Date;
  resolvedAt?: Date;
}
```

### Beat Reporter Warning
```typescript
interface BeatReporterWarning {
  id: string;
  message: string;
  category: 'MORALE' | 'RELATIONSHIP' | 'FAN' | 'CHEMISTRY' | 'AI_HINT';
  accuracy: number;                // 0.6 to 0.9 (hidden)
  actuallyTrue?: boolean;          // Revealed through consequences
  tradeId: string;
}
```

---

## Business Rules Summary

1. **No Salary Matching** - Teams can freely increase or decrease payroll
2. **Beat Reporter Warnings** - Advisory only, 60-90% accuracy, cannot block trades
3. **AI Protection** - AI evaluates trades realistically, won't accept exploits
4. **AI Proposals** - AI teams actively propose trades based on needs
5. **Waiver Order** - Reverse standings (worst team gets first claim)
6. **Roster Flexibility** - Farm can exceed 10 temporarily; validated at Finalize & Advance
7. **Three-Way Trades** - All three teams must accept independently
8. **Tradeable Players** - MLB roster + Farm roster + new draftees

---

## Screen Flow

```
TRADE PHASE
‚îÇ
‚îú‚îÄ‚îÄ Main Trade Interface
‚îÇ   ‚îú‚îÄ‚îÄ Two-Way Trade Tab
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Team 1 Selection + Players
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Team 2 Selection + Players
‚îÇ   ‚îî‚îÄ‚îÄ Three-Way Trade Tab
‚îÇ       ‚îú‚îÄ‚îÄ Team 1 Selection + Players
‚îÇ       ‚îú‚îÄ‚îÄ Team 2 Selection + Players
‚îÇ       ‚îî‚îÄ‚îÄ Team 3 Selection + Players
‚îÇ
‚îú‚îÄ‚îÄ Trade Proposal Flow
‚îÇ   ‚îú‚îÄ‚îÄ Select Players
‚îÇ   ‚îú‚îÄ‚îÄ View Summary
‚îÇ   ‚îú‚îÄ‚îÄ Beat Reporter Warnings
‚îÇ   ‚îú‚îÄ‚îÄ Propose Trade
‚îÇ   ‚îî‚îÄ‚îÄ AI Response (Accept/Reject/Counter)
‚îÇ
‚îú‚îÄ‚îÄ AI Proposals Inbox
‚îÇ   ‚îú‚îÄ‚îÄ View Proposals
‚îÇ   ‚îî‚îÄ‚îÄ Accept/Counter/Decline
‚îÇ
‚îú‚îÄ‚îÄ Waiver Wire (triggered by releases)
‚îÇ   ‚îú‚îÄ‚îÄ Claim Order Display
‚îÇ   ‚îú‚îÄ‚îÄ Claim or Pass Decision
‚îÇ   ‚îî‚îÄ‚îÄ Results Summary
‚îÇ
‚îî‚îÄ‚îÄ Trade History
    ‚îî‚îÄ‚îÄ All Completed Trades
```

---

## Integration Points

- **Draft Phase** ‚Üí Trade Phase (Farm may have >10 players)
- **Trade Phase** ‚Üí Finalize & Advance (rosters validated there)
- **Waiver Wire** ‚Üî Finalize & Advance (releases trigger waivers)
- **Morale System** ‚Üê Trade effects (queued, applied over time)
- **Adaptive Engine** ‚Üí AI trade proposals and evaluations

---

*End of User Stories - Trade Phase*
~~~

### Source File: specs/stories/STORIES_WIRING.md

~~~markdown
# KBL Tracker - Wiring Stories for Orphaned Components

> **Generated**: January 26, 2026
> **Purpose**: Quick-win stories to wire existing orphaned components into the app
> **Format**: Ralph Framework
> **Note**: These components already exist - just need import and render

---

## Story Index

| Story ID | Closes Gap | Component | Location | Priority | Size | Status |
|----------|------------|-----------|----------|----------|------|--------|
| WIRE-001 | GAP-005 | BoxScoreView | PostGameScreen | P1 | Small | ‚úÖ Done (prior) |
| WIRE-002 | GAP-006 | StandingsView | SeasonDashboard | P1 | Small | ‚úÖ Done |
| WIRE-003 | GAP-007 | TeamStatsView | TeamPage | P1 | Small | ‚úÖ Done |
| WIRE-004 | GAP-009 | FanMoralePanel | GameTracker | P1 | Small | ‚úÖ Done |
| WIRE-005 | GAP-010 | PlayoffBracket | SeasonDashboard | P2 | Small | ‚úÖ Done |
| WIRE-006 | GAP-011 | ChampionshipCelebration | PostGameScreen | P2 | Small | ‚úÖ Done |
| WIRE-007 | GAP-012 | SeasonProgressTracker | SeasonDashboard | P1 | Small | ‚úÖ Done |
| WIRE-008 | GAP-014 | SalaryDisplay | PlayerCard | P1 | Small | ‚úÖ Done |
| WIRE-009 | GAP-015 | RelationshipPanel | PlayerCard | P2 | Small | ‚úÖ Done |
| WIRE-010 | GAP-016 | AgingDisplay | PlayerCard | P2 | Small | ‚úÖ Done |
| WIRE-011 | GAP-018 | LeagueNewsFeed | SeasonDashboard | P1 | Small | ‚úÖ Done |
| WIRE-012 | GAP-019 | ChemistryDisplay | RosterView | P2 | Small | ‚úÖ Done |
| WIRE-013 | GAP-020 | ContractionWarning | SeasonDashboard | P2 | Small | ‚úÖ Done |
| WIRE-014 | GAP-021 | LeagueBuilder | MainMenu | P0 | Medium | ‚úÖ Done |
| WIRE-015 | GAP-022 | PlayerRatingsForm | ManualPlayerInput | P0 | Small | ‚úÖ Done (prior) |
| WIRE-016 | GAP-023 | Museum Components | MuseumHub | P2 | Medium | ‚úÖ Done |
| WIRE-017 | GAP-024 | Awards Components | AwardsCeremonyHub | P1 | Medium | ‚úÖ Done |
| WIRE-018 | GAP-025 | Offseason Components | OffseasonHub | P1 | Medium | ‚úÖ Done |
| WIRE-019 | GAP-026 | transactionStorage | FreeAgencyHub, TradeHub | P1 | Small | ‚úÖ Done |
| WIRE-020 | GAP-027 | fieldingStatsAggregator | AwardsHub | P1 | Small | ‚úÖ Done |
| WIRE-021 | GAP-028 | dataExportService | PostGameScreen | P1 | Small | ‚úÖ Done |
| WIRE-022 | GAP-029 | traitPools | TraitLotteryWheel | P2 | Small | ‚úÖ Done |
| WIRE-023 | GAP-030 | adaptiveLearningEngine | FieldingModal | P1 | Medium | ‚úÖ Done |

---

# CRITICAL WIRING (P0)

---

## [WIRE-014]: Wire LeagueBuilder

**Closes Gap:** GAP-021
**Component:** `src/components/LeagueBuilder.tsx`
**Priority:** P0
**Estimated Size:** Medium

**As a** user starting the app
**I want to** create a new league/season
**So that** I can begin playing games

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** MainMenu rendered
- **When:** User clicks "Start New Season"
- **Then:** LeagueBuilder component renders
- **Verify:** Click "Start New Season", see LeagueBuilder

**AC-2: Component Receives Data**
- **Given:** LeagueBuilder rendered
- **When:** User views component
- **Then:** Team selection and season length options available
- **Verify:** Find team checkboxes and season dropdown

**AC-3: Component Creates League**
- **Given:** User configures league
- **When:** User clicks "Create League"
- **Then:** League created in storage, user redirected to SeasonDashboard
- **Verify:** Create league, see SeasonDashboard with schedule

### Technical Notes
- Import in App.tsx for route `/league-builder`
- Add navigation from MainMenu "Start New Season" button
- Wire to seasonStorage for league creation

---

## [WIRE-015]: Wire PlayerRatingsForm

**Closes Gap:** GAP-022
**Component:** `src/components/PlayerRatingsForm.tsx`
**Priority:** P0
**Estimated Size:** Small

**As a** user creating a player
**I want to** input player ratings
**So that** salary can be calculated

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** ManualPlayerInput rendered
- **When:** User creating player
- **Then:** PlayerRatingsForm section visible
- **Verify:** Open add-player, find ratings inputs

**AC-2: Component Receives Props**
- **Given:** PlayerRatingsForm rendered
- **When:** Form inspected
- **Then:** All rating fields present (power, contact, speed, fielding, arm, velocity, junk, accuracy)
- **Verify:** Find all 8 rating input fields

**AC-3: Ratings Flow to Salary**
- **Given:** User enters ratings
- **When:** Ratings change
- **Then:** Salary auto-calculates using salaryCalculator
- **Verify:** Change rating, see salary update

### Technical Notes
- Import in ManualPlayerInput.tsx
- Wire onChange to salaryCalculator.ts
- Display calculated salary

---

# IMPORTANT WIRING (P1)

---

## [WIRE-001]: Wire BoxScoreView

**Closes Gap:** GAP-005
**Component:** `src/components/BoxScoreView.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user after a game
**I want to** view the box score
**So that** I can see detailed game stats

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** PostGameScreen rendered
- **When:** User clicks "View Box Score"
- **Then:** BoxScoreView renders
- **Verify:** Find and click box score button, see component

**AC-2: Component Receives Data**
- **Given:** BoxScoreView rendered
- **When:** Game data available
- **Then:** Displays batting stats, pitching stats per team
- **Verify:** See actual player stats from completed game

**AC-3: Component Interactive**
- **Given:** BoxScoreView rendered
- **When:** User clicks player name
- **Then:** PlayerCard opens with full stats
- **Verify:** Click player in box score, see PlayerCard

### Technical Notes
- Import in PostGameScreen.tsx
- Pass game stats from completed game
- Add "View Box Score" button to PostGameScreen

---

## [WIRE-002]: Wire StandingsView

**Closes Gap:** GAP-006
**Component:** `src/components/StandingsView.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user during the season
**I want to** view league standings
**So that** I know my team's position

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** SeasonDashboard rendered
- **When:** User clicks "Standings" or views standings section
- **Then:** StandingsView renders
- **Verify:** Navigate to standings, see component

**AC-2: Component Receives Data**
- **Given:** StandingsView rendered
- **When:** Season data available
- **Then:** Shows all teams with W-L record, PCT, GB
- **Verify:** See actual standings data

**AC-3: Component Updates**
- **Given:** Game completed
- **When:** Standings refreshed
- **Then:** Standings reflect latest results
- **Verify:** Complete game, see standings update

### Technical Notes
- Import in SeasonDashboard.tsx
- Create `/standings` route or embed in dashboard
- Pass standings from seasonStorage

---

## [WIRE-003]: Wire TeamStatsView

**Closes Gap:** GAP-007
**Component:** `src/components/TeamStatsView.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user
**I want to** view team statistics
**So that** I can analyze team performance

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** TeamPage rendered
- **When:** User views team
- **Then:** TeamStatsView renders as section
- **Verify:** Navigate to team, see stats section

**AC-2: Component Receives Data**
- **Given:** TeamStatsView rendered
- **When:** Team data available
- **Then:** Shows team batting avg, ERA, runs scored/allowed
- **Verify:** See actual team stats

**AC-3: Component Has Tabs**
- **Given:** TeamStatsView rendered
- **When:** User clicks tabs
- **Then:** Batting/Pitching/Fielding views available
- **Verify:** Click tabs, content changes

### Technical Notes
- Import in TeamPage.tsx
- Pass team stats from seasonStorage
- Complete TeamPage.tsx stub (GAP-066)

---

## [WIRE-004]: Wire FanMoralePanel

**Closes Gap:** GAP-009
**Component:** `src/components/FanMoralePanel.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user during a game
**I want to** see fan morale
**So that** I understand fan sentiment

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** GameTracker or SeasonDashboard rendered
- **When:** User views UI
- **Then:** FanMoralePanel visible in sidebar/header
- **Verify:** Find fan morale indicator

**AC-2: Component Receives Data**
- **Given:** FanMoralePanel rendered
- **When:** Morale data available
- **Then:** Shows morale level with color coding
- **Verify:** See morale indicator with value

**AC-3: Component Updates Live**
- **Given:** Game in progress
- **When:** Morale-affecting event occurs
- **Then:** Panel updates to reflect change
- **Verify:** Win game, see morale improve

### Technical Notes
- Import in GameTracker sidebar
- Wire useFanMorale hook
- Show in SeasonDashboard header

---

## [WIRE-007]: Wire SeasonProgressTracker

**Closes Gap:** GAP-012
**Component:** `src/components/SeasonProgressTracker.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user during the season
**I want to** see season progress
**So that** I know how far along we are

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** SeasonDashboard rendered
- **When:** User views dashboard
- **Then:** SeasonProgressTracker visible
- **Verify:** Find progress tracker in dashboard

**AC-2: Component Receives Data**
- **Given:** SeasonProgressTracker rendered
- **When:** Season data available
- **Then:** Shows "Game X of Y" with progress bar
- **Verify:** See progress indicator with numbers

**AC-3: Component Shows Milestones**
- **Given:** SeasonProgressTracker rendered
- **When:** User views component
- **Then:** Key milestones marked (All-Star, playoffs)
- **Verify:** Find milestone markers on progress

### Technical Notes
- Import in SeasonDashboard.tsx
- Pass gamesPlayed, totalGames from season
- Mark milestones at appropriate points

---

## [WIRE-008]: Wire SalaryDisplay

**Closes Gap:** GAP-014
**Component:** `src/components/GameTracker/SalaryDisplay.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user viewing a player
**I want to** see their salary
**So that** I understand their value

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** PlayerCard rendered
- **When:** User views player
- **Then:** SalaryDisplay shows in PlayerCard
- **Verify:** Open PlayerCard, find salary section

**AC-2: Component Receives Data**
- **Given:** SalaryDisplay rendered
- **When:** Player has ratings
- **Then:** Calculated salary displayed
- **Verify:** See salary value (requires GAP-001 fix)

**AC-3: Component Shows Breakdown**
- **Given:** SalaryDisplay rendered
- **When:** User expands details
- **Then:** Shows base + modifiers breakdown
- **Verify:** Find salary breakdown details

### Technical Notes
- Import in PlayerCard.tsx
- Wire salaryCalculator.ts
- Requires player ratings (WIRE-015, NEW-006)

---

## [WIRE-011]: Wire LeagueNewsFeed

**Closes Gap:** GAP-018
**Component:** `src/components/LeagueNewsFeed.tsx`
**Priority:** P1
**Estimated Size:** Small

**As a** user
**I want to** see league news
**So that** I stay informed about events

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** SeasonDashboard or MainMenu rendered
- **When:** User views UI
- **Then:** LeagueNewsFeed visible
- **Verify:** Find news feed section

**AC-2: Component Receives Data**
- **Given:** LeagueNewsFeed rendered
- **When:** News exists
- **Then:** Shows recent stories with headlines
- **Verify:** See news items with content

**AC-3: Component Shows Story Types**
- **Given:** News feed with items
- **When:** User views items
- **Then:** Different story types styled differently
- **Verify:** Trade news, game recaps visually distinct

### Technical Notes
- Import in SeasonDashboard.tsx
- Wire narrativeEngine for stories
- Add story storage for persistence

---

## [WIRE-017]: Wire Awards Components

**Closes Gap:** GAP-024
**Components:** 9 award components in `src/components/awards/`
**Priority:** P1
**Estimated Size:** Medium

**As a** user in awards ceremony
**I want to** see award presentations
**So that** I can celebrate achievements

### Size Check
- [ ] < 200 lines of code (Medium - multiple components)
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Components Imported**
- **Given:** AwardsCeremonyHub rendered
- **When:** User progresses through ceremony
- **Then:** Individual award components render in sequence
- **Verify:** Navigate awards, see MVP, Cy Young, etc.

**AC-2: Components Receive Data**
- **Given:** Award component rendered
- **When:** Season stats available
- **Then:** Winner displayed with relevant stats
- **Verify:** See actual player as MVP with WAR

**AC-3: Sequence Navigation**
- **Given:** Awards ceremony active
- **When:** User clicks "Next"
- **Then:** Next award component renders
- **Verify:** Progress through all 9 awards

### Technical Notes
- Import all 9 components in AwardsCeremonyHub
- Create ceremony state machine for sequencing
- Pass winner data from season stats

---

## [WIRE-018]: Wire Offseason Components

**Closes Gap:** GAP-025
**Components:** 6 offseason components in `src/components/offseason/`
**Priority:** P1
**Estimated Size:** Medium

**As a** user in offseason
**I want to** access all offseason features
**So that** I can manage my team

### Size Check
- [ ] < 200 lines of code (Medium - multiple components)
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Components Imported**
- **Given:** OffseasonHub rendered
- **When:** User navigates to phase
- **Then:** Appropriate component renders
- **Verify:** Click each phase, see component

**AC-2: ProgressTracker Visible**
- **Given:** OffseasonHub rendered
- **When:** User views hub
- **Then:** OffseasonProgressTracker shows all phases
- **Verify:** Find progress tracker with 11 phases

**AC-3: Child Components Functional**
- **Given:** Offseason component rendered
- **When:** User interacts
- **Then:** Features work (protect players, draft, trade)
- **Verify:** Complete actions in each component

### Technical Notes
- Import all 6 components
- Create sub-routes for each phase
- Wire to appropriate storage services

---

## [WIRE-019]: Wire transactionStorage

**Closes Gap:** GAP-026
**Component:** `src/utils/transactionStorage.ts`
**Priority:** P1
**Estimated Size:** Small

**As a** game system
**I want to** record transactions
**So that** history is preserved

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Service Imported**
- **Given:** FreeAgencyHub, TradeHub code
- **When:** Transaction occurs
- **Then:** transactionStorage methods called
- **Verify:** Check import statements added

**AC-2: Transactions Recorded**
- **Given:** User signs FA or completes trade
- **When:** Transaction completes
- **Then:** Record saved to IndexedDB
- **Verify:** Check IndexedDB for transaction record

**AC-3: History Retrievable**
- **Given:** Transactions recorded
- **When:** History queried
- **Then:** All transactions returned
- **Verify:** Call getTransactions(), see list

### Technical Notes
- Import in FreeAgencyHub.tsx
- Import in TradeHub.tsx
- Call on signing/trade completion

---

## [WIRE-020]: Wire fieldingStatsAggregator

**Closes Gap:** GAP-027
**Component:** `src/services/fieldingStatsAggregator.ts`
**Priority:** P1
**Estimated Size:** Small

**As a** awards system
**I want to** aggregate fielding stats by position
**So that** Gold Gloves can be awarded

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Service Imported**
- **Given:** Awards calculation code
- **When:** Gold Glove calculated
- **Then:** fieldingStatsAggregator called
- **Verify:** Check import in awards logic

**AC-2: Stats Aggregated by Position**
- **Given:** Season fielding data exists
- **When:** Aggregator called
- **Then:** Returns stats grouped by position
- **Verify:** Call method, see 9 positions with stats

**AC-3: Used for Awards**
- **Given:** Aggregated fielding stats
- **When:** Gold Glove award calculated
- **Then:** Best fWAR at each position wins
- **Verify:** See Gold Glove winners per position

### Technical Notes
- Import in GoldGloveAwards calculation
- Wire to season end processing
- Use for position-based award determination

---

## [WIRE-021]: Wire dataExportService

**Closes Gap:** GAP-028
**Component:** `src/services/dataExportService.ts`
**Priority:** P1
**Estimated Size:** Small

**As a** user
**I want to** export game data
**So that** I can analyze it externally

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Service Imported**
- **Given:** PostGameScreen or stats view
- **When:** Export functionality needed
- **Then:** dataExportService imported
- **Verify:** Check import statements

**AC-2: Export Button Added**
- **Given:** PostGameScreen rendered
- **When:** User clicks "Export Box Score"
- **Then:** CSV/JSON file downloads
- **Verify:** Click export, file downloads

**AC-3: Data Complete**
- **Given:** Export generated
- **When:** File opened
- **Then:** Contains all game stats
- **Verify:** Open file, find all player stats

### Technical Notes
- Import in PostGameScreen.tsx
- Add "Export" button
- Support CSV and JSON formats

---

## [WIRE-023]: Wire adaptiveLearningEngine

**Closes Gap:** GAP-030
**Component:** `src/engines/adaptiveLearningEngine.ts`
**Priority:** P1
**Estimated Size:** Medium

**As a** fielding system
**I want to** improve inference over time
**So that** predictions become more accurate

### Size Check
- [x] < 200 lines of code
- [x] ‚â§ 3 acceptance criteria
- [x] No architectural decisions
- [x] Clear end state

### Acceptance Criteria

**AC-1: Engine Imported**
- **Given:** FieldingModal code
- **When:** User corrects inference
- **Then:** adaptiveLearningEngine called
- **Verify:** Check import in FieldingModal

**AC-2: Corrections Tracked**
- **Given:** User changes inferred fielder
- **When:** At-bat submitted
- **Then:** Correction recorded for learning
- **Verify:** Check learning data after correction

**AC-3: Inference Improves**
- **Given:** 20+ corrections for scenario
- **When:** Same scenario occurs
- **Then:** Inference probability updated
- **Verify:** After corrections, default changes

### Technical Notes
- Import in FieldingModal.tsx
- Call on user correction (when inferred != actual)
- Store correction data in IndexedDB

---

# LOWER PRIORITY WIRING (P2)

---

## [WIRE-005]: Wire PlayoffBracket

**Closes Gap:** GAP-010
**Component:** `src/components/PlayoffBracket.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user during playoffs
**I want to** see the playoff bracket
**So that** I can track tournament progress

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** Playoffs active
- **When:** User views SeasonDashboard
- **Then:** PlayoffBracket renders
- **Verify:** Navigate to dashboard during playoffs

**AC-2: Component Receives Data**
- **Given:** PlayoffBracket rendered
- **When:** Playoff data available
- **Then:** Shows matchups and results
- **Verify:** See bracket with team names

**AC-3: Updates with Results**
- **Given:** Playoff game completed
- **When:** Bracket refreshed
- **Then:** Winner advances to next round
- **Verify:** Win game, see bracket update

---

## [WIRE-006]: Wire ChampionshipCelebration

**Closes Gap:** GAP-011
**Component:** `src/components/ChampionshipCelebration.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user winning championship
**I want to** see celebration
**So that** the moment feels special

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** Championship game won
- **When:** Game ends
- **Then:** ChampionshipCelebration renders
- **Verify:** Win final, see celebration

**AC-2: Component Shows Trophy**
- **Given:** Celebration rendered
- **When:** User views screen
- **Then:** Trophy graphic and confetti displayed
- **Verify:** See championship visuals

**AC-3: Stats Highlighted**
- **Given:** Celebration rendered
- **When:** User views details
- **Then:** Key stats from championship run shown
- **Verify:** See MVP, record, etc.

---

## [WIRE-009]: Wire RelationshipPanel

**Closes Gap:** GAP-015
**Component:** `src/components/RelationshipPanel.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user viewing a player
**I want to** see their relationships
**So that** I understand team dynamics

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** PlayerCard rendered
- **When:** Player has relationships
- **Then:** RelationshipPanel visible
- **Verify:** Open PlayerCard, find relationships section

**AC-2: Relationships Listed**
- **Given:** RelationshipPanel rendered
- **When:** Data available
- **Then:** Shows relationship types and partners
- **Verify:** See "Best Friends: John Smith"

**AC-3: Morale Impact Shown**
- **Given:** Relationship displayed
- **When:** User views details
- **Then:** Morale modifier visible
- **Verify:** See "+2 morale from friendship"

---

## [WIRE-010]: Wire AgingDisplay

**Closes Gap:** GAP-016
**Component:** `src/components/AgingDisplay.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user viewing a player
**I want to** see their career phase
**So that** I understand their trajectory

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** PlayerCard rendered
- **When:** User views player
- **Then:** AgingDisplay shows career phase
- **Verify:** Open PlayerCard, find aging section

**AC-2: Phase Displayed**
- **Given:** AgingDisplay rendered
- **When:** Player data available
- **Then:** Shows "Prime" / "Declining" / "Veteran"
- **Verify:** See career phase indicator

**AC-3: Projection Shown**
- **Given:** AgingDisplay rendered
- **When:** User views details
- **Then:** Expected development/decline shown
- **Verify:** See "Expected -3 ratings next year"

---

## [WIRE-012]: Wire ChemistryDisplay

**Closes Gap:** GAP-019
**Component:** `src/components/ChemistryDisplay.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user managing roster
**I want to** see team chemistry
**So that** I can build cohesive teams

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** RosterView or TeamPage rendered
- **When:** User views team
- **Then:** ChemistryDisplay visible
- **Verify:** Find chemistry section

**AC-2: Chemistry Score Shown**
- **Given:** ChemistryDisplay rendered
- **When:** Team data available
- **Then:** Overall chemistry rating displayed
- **Verify:** See "Team Chemistry: 85"

**AC-3: Personality Mix Shown**
- **Given:** ChemistryDisplay rendered
- **When:** User views details
- **Then:** Personality breakdown visible
- **Verify:** See personality type distribution

---

## [WIRE-013]: Wire ContractionWarning

**Closes Gap:** GAP-020
**Component:** `src/components/ContractionWarning.tsx`
**Priority:** P2
**Estimated Size:** Small

**As a** user with struggling team
**I want to** see contraction risk
**So that** I can take action

### Acceptance Criteria

**AC-1: Component Imported**
- **Given:** Team at risk of contraction
- **When:** SeasonDashboard renders
- **Then:** ContractionWarning visible
- **Verify:** See warning banner when at risk

**AC-2: Risk Level Shown**
- **Given:** Warning displayed
- **When:** User views warning
- **Then:** Risk percentage and factors shown
- **Verify:** See "Contraction Risk: 45%"

**AC-3: Suggestions Provided**
- **Given:** Warning displayed
- **When:** User reads details
- **Then:** Actions to reduce risk listed
- **Verify:** Find actionable suggestions

---

## [WIRE-016]: Wire Museum Components

**Closes Gap:** GAP-023
**Components:** 4 museum components in `src/components/museum/`
**Priority:** P2
**Estimated Size:** Medium

**As a** user exploring franchise history
**I want to** see museum content
**So that** I can appreciate achievements

### Acceptance Criteria

**AC-1: Components Imported**
- **Given:** MuseumHub rendered
- **When:** User clicks museum section
- **Then:** Appropriate component renders
- **Verify:** Click each section, see component

**AC-2: Components Receive Data**
- **Given:** Museum component rendered
- **When:** History data available
- **Then:** Shows HOF members, records, banners
- **Verify:** See actual franchise history

**AC-3: Navigation Works**
- **Given:** MuseumHub active
- **When:** User navigates between sections
- **Then:** Content switches appropriately
- **Verify:** Move between all 4 sections

---

## [WIRE-022]: Wire traitPools

**Closes Gap:** GAP-029
**Component:** `src/data/traitPools.ts`
**Priority:** P2
**Estimated Size:** Small

**As a** All-Star player
**I want to** spin the trait wheel
**So that** I can earn new traits

### Acceptance Criteria

**AC-1: Data Imported**
- **Given:** TraitLotteryWheel code
- **When:** Wheel needs traits
- **Then:** traitPools data imported
- **Verify:** Check import statement

**AC-2: Pools Configured**
- **Given:** traitPools loaded
- **When:** Data inspected
- **Then:** Trait pools exist (Good, Bad, Neutral)
- **Verify:** Find pool arrays

**AC-3: Wheel Uses Pools**
- **Given:** User spins wheel
- **When:** Result determined
- **Then:** Trait selected from appropriate pool
- **Verify:** Spin wheel, get valid trait

---

# SUMMARY

## Wiring Stories by Priority

| Priority | Count | Est. Effort |
|----------|-------|-------------|
| P0 (Critical) | 2 | ~4 hours |
| P1 (Important) | 13 | ~16 hours |
| P2 (Lower) | 8 | ~8 hours |
| **Total** | **23** | **~28 hours** |

## Quick Wins (Smallest Effort)

1. WIRE-011: LeagueNewsFeed (~30 min)
2. WIRE-019: transactionStorage (~30 min)
3. WIRE-020: fieldingStatsAggregator (~30 min)
4. WIRE-021: dataExportService (~30 min)
5. WIRE-001: BoxScoreView (~45 min)
6. WIRE-002: StandingsView (~45 min)
7. WIRE-007: SeasonProgressTracker (~45 min)

## Blocked Wiring

*No blocked stories remaining.*

## Completion Status (Updated Jan 26, 2026)

**23 of 23 stories COMPLETE (100%)**

All wiring stories complete! Player database now has full ratings for all 506 players, enabling salary calculation in PlayerCard.

---

*Document generated January 26, 2026*
~~~
