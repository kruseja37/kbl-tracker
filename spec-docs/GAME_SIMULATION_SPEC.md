# Game Simulation & Skip Specification

> **Purpose**: Define architecture for skipping and simulating games
> **Status**: PLANNING - Build out deferred until other features complete
> **Priority**: Future Phase
> **Related Specs**: STAT_TRACKING_ARCHITECTURE_SPEC.md, FRANCHISE_MODE_SPEC.md

---

## 1. Overview

The simulation system allows users to:
1. **Skip** individual games (no stats generated, adjusts qualification thresholds)
2. **Simulate** individual games (generates realistic stats via play-by-play engine)
3. **Sim to Next Event** (batch simulate multiple games, stopping at season milestones)
4. **Unsimulate** (reverse a simulated game if user decides to play it manually)

### 1.1 Core Principles

- Simulated games should feel **real** (clutch moments, fame events, realistic distributions)
- Use **player ratings from roster data** as simulation inputs
- Simulated games are **visually distinct** in box scores and history
- Simulations are **reversible** (can unsimulate before playing)
- **Data integrity first** - no simulation operation should risk data loss

---

## 2. Game Status Types

```typescript
type GameStatus =
  | 'scheduled'      // Not yet played or simulated
  | 'in_progress'    // Currently being played manually
  | 'completed'      // Played manually, finalized
  | 'simulated'      // Generated by simulation engine
  | 'skipped';       // Marked as skipped, no stats

interface ScheduledGame {
  gameId: string;
  seasonId: string;
  gameNumber: number;        // 1-512 (or whatever total)
  scheduledDate: string;     // YYYY-MM-DD
  awayTeamId: string;
  homeTeamId: string;
  status: GameStatus;

  // Simulation metadata (if simulated)
  simulatedAt?: number;      // Timestamp
  simulationSeed?: number;   // For reproducibility
  canUnsimulate?: boolean;   // False after manual game played after this one

  // Skip metadata (if skipped)
  skippedAt?: number;
  skipReason?: string;       // Optional user note
}
```

---

## 3. Skip Game Feature

### 3.1 What Happens When a Game is Skipped

1. Game marked as `status: 'skipped'`
2. No stats generated for any players
3. Season schedule advances
4. Qualification thresholds recalculate based on games actually played

### 3.2 Qualification Threshold Adjustment

Standard thresholds are based on team games played:

| Stat | Standard Threshold | Adjusted Formula |
|------|-------------------|------------------|
| Batting title | 3.1 PA per team game | `3.1 Ã— teamGamesPlayed` |
| ERA title | 1 IP per team game | `1.0 Ã— teamGamesPlayed` |
| Fielding | 2/3 of team games at position | `0.667 Ã— teamGamesAtPosition` |

```typescript
interface TeamSeasonContext {
  teamId: string;
  seasonId: string;
  gamesScheduled: number;    // Total on schedule
  gamesPlayed: number;       // Completed + Simulated
  gamesSkipped: number;      // Skipped
  gamesRemaining: number;    // Scheduled - Played - Skipped
}

function getQualifyingPA(team: TeamSeasonContext): number {
  return Math.floor(3.1 * team.gamesPlayed);
}

function getQualifyingIP(team: TeamSeasonContext): number {
  return team.gamesPlayed; // 1 IP per game played
}
```

### 3.3 Skip Game UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Game 45: Tigers @ Yankees                      â”‚
â”‚  April 15, 2026                                 â”‚
â”‚                                                 â”‚
â”‚  [Play Game]  [Simulate]  [Skip]                â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ User clicks "Skip"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Skip Game?                                     â”‚
â”‚                                                 â”‚
â”‚  No stats will be generated. Qualification     â”‚
â”‚  thresholds will adjust automatically.         â”‚
â”‚                                                 â”‚
â”‚  Reason (optional): [________________]          â”‚
â”‚                                                 â”‚
â”‚  [Cancel]  [Skip Game]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Simulate Game Feature

### 4.1 Simulation Engine Overview

The simulation engine generates **play-by-play** at-bat results that flow through the existing event log system, producing:

- Realistic box scores
- Individual player stats
- Fame events (when triggered)
- Proper run/hit/error distributions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SIMULATION FLOW                       â”‚
â”‚                                                          â”‚
â”‚  Roster Data â”€â”€â–º Simulation â”€â”€â–º Event Log â”€â”€â–º Stats     â”‚
â”‚  (ratings)       Engine        (same as     (same as    â”‚
â”‚                  (new)          manual)      manual)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Simulation Engine Architecture

```typescript
interface SimulationEngine {
  // Simulate a single game
  simulateGame(
    game: ScheduledGame,
    awayRoster: SimRoster,
    homeRoster: SimRoster,
    options?: SimulationOptions
  ): Promise<SimulatedGameResult>;

  // Simulate multiple games (for "Sim to Next Event")
  simulateGames(
    games: ScheduledGame[],
    rosters: Map<TeamId, SimRoster>,
    options?: SimulationOptions
  ): AsyncGenerator<SimulatedGameResult>;
}

interface SimulationOptions {
  seed?: number;              // For reproducibility
  verboseLog?: boolean;       // Log each at-bat (for debugging)
  fameDetectionEnabled?: boolean;  // Generate fame events (default: true)
}

interface SimRoster {
  teamId: string;
  lineup: SimPlayer[];        // 9 batters in order
  startingPitcher: SimPlayer;
  bench: SimPlayer[];
  bullpen: SimPlayer[];
}

interface SimPlayer {
  playerId: string;
  name: string;
  position: Position;
  ratings: PlayerRatings;     // From roster data
}
```

### 4.3 At-Bat Simulation Logic

Each at-bat is resolved using probability tables based on player ratings:

```typescript
interface AtBatSimulator {
  simulateAtBat(
    batter: SimPlayer,
    pitcher: SimPlayer,
    situation: GameSituation
  ): SimulatedAtBatResult;
}

interface GameSituation {
  inning: number;
  halfInning: 'TOP' | 'BOTTOM';
  outs: number;
  runners: RunnerState;
  awayScore: number;
  homeScore: number;

  // For fatigue/substitution decisions
  pitcherPitchCount: number;
  pitcherOutsRecorded: number;
}

interface SimulatedAtBatResult {
  result: AtBatResult;
  runnerOutcomes: RunnerOutcomes;
  runsScored: number;
  rbiCount: number;

  // For event log
  leverageIndex: number;
  isClutch: boolean;
  fameEvents: FameEvent[];
}
```

### 4.4 Probability Model with Randomness

Base probabilities derived from player ratings (0-99 scale from SMB4), but with **variance injected** to prevent deterministic outcomes. If simulation were 100% rating-driven, results would be predictable and uninteresting.

#### 4.4.1 Rating-Based Probabilities

```typescript
// Simplified probability calculation
function calculateOutcomeProbabilities(
  batter: SimPlayer,
  pitcher: SimPlayer
): OutcomeProbabilities {
  const batterContact = batter.ratings.contact;    // 0-99
  const batterPower = batter.ratings.power;        // 0-99
  const batterEye = batter.ratings.eye;            // 0-99
  const pitcherStuff = pitcher.ratings.stuff;      // 0-99
  const pitcherControl = pitcher.ratings.control;  // 0-99

  // Matchup adjustment (batter vs pitcher)
  const contactDiff = (batterContact - pitcherStuff) / 100;
  const powerDiff = (batterPower - pitcherStuff) / 100;
  const eyeDiff = (batterEye - pitcherControl) / 100;

  // Base rates (league average)
  const baseRates = {
    strikeout: 0.22,
    walk: 0.08,
    hit: 0.24,
    homeRun: 0.03,
    // etc.
  };

  // Adjusted rates
  return {
    strikeout: Math.max(0.05, Math.min(0.40, baseRates.strikeout - contactDiff * 0.15)),
    walk: Math.max(0.02, Math.min(0.20, baseRates.walk + eyeDiff * 0.10)),
    homeRun: Math.max(0.005, Math.min(0.08, baseRates.homeRun + powerDiff * 0.05)),
    // ... more outcomes
  };
}
```

#### 4.4.2 Variance & Randomness

Ratings determine the **expected distribution**, but each at-bat introduces randomness:

```typescript
interface VarianceConfig {
  // How much randomness to inject (0 = pure ratings, 1 = pure chaos)
  varianceFactor: number;  // Recommended: 0.15-0.25

  // Hot/cold streak simulation
  streakEnabled: boolean;
  streakLength: { min: number; max: number };  // e.g., 3-10 at-bats

  // Clutch variance (more variance in high-leverage situations)
  clutchVarianceBoost: number;  // e.g., 0.05 extra variance when LI > 2.0
}

function applyVariance(
  baseProbabilities: OutcomeProbabilities,
  config: VarianceConfig,
  rng: SeededRandom
): OutcomeProbabilities {
  const result = { ...baseProbabilities };

  // Add random variance to each probability
  for (const key of Object.keys(result)) {
    const variance = (rng.random() - 0.5) * 2 * config.varianceFactor;
    result[key] = clamp(result[key] * (1 + variance), 0.01, 0.99);
  }

  // Normalize so probabilities sum to 1
  return normalizeProbabilities(result);
}
```

**Why Variance Matters:**
- A 99-rated hitter should hit ~.340, not exactly .340 every season
- Underdogs can win games (like real baseball)
- Creates meaningful hot/cold streaks
- Prevents "solved" simulations where you know the outcome

#### 4.4.3 Seeded Random Number Generator

For **reproducibility** (same seed = same results), use a seeded PRNG:

```typescript
class SeededRandom {
  private seed: number;

  constructor(seed?: number) {
    this.seed = seed ?? Date.now();
  }

  // Mulberry32 algorithm - fast and good distribution
  random(): number {
    let t = this.seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }

  getSeed(): number {
    return this.seed;
  }
}
```

This allows:
- **Reproducible simulations**: Re-run with same seed, get same game
- **Debugging**: Reproduce a specific unusual result
- **Fairness verification**: Users can verify simulation wasn't rigged

### 4.5 Simulation Output â†’ Event Log

Simulated at-bats produce the **same `AtBatEvent` structure** as manual games:

```typescript
async function simulateAndLog(game: ScheduledGame, ...): Promise<void> {
  // Create game header (marked as simulated)
  await createGameHeader({
    ...gameData,
    isSimulated: true,  // NEW FIELD
    simulationSeed: options.seed,
  });

  // Simulate each at-bat
  let sequence = 0;
  while (!gameOver) {
    const result = atBatSimulator.simulateAtBat(batter, pitcher, situation);
    sequence++;

    // Log to event log (same as manual game!)
    await logAtBatEvent({
      eventId: `${game.gameId}_${sequence}`,
      gameId: game.gameId,
      sequence,
      isSimulated: true,  // NEW FIELD - marks this at-bat as simulated
      // ... all other fields same as manual
    });

    // Update situation
    updateGameState(result);
  }

  // Complete game
  await completeGame(game.gameId, finalScore, finalInning);
}
```

### 4.6 Visual Distinction for Simulated Games

Box scores and history show simulated games differently:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š SIMULATED                                   â”‚
â”‚  Game 45: Tigers 5, Yankees 3                   â”‚
â”‚  April 15, 2026                                 â”‚
â”‚                                                 â”‚
â”‚  [View Box Score]  [Unsimulate]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.7 Stat Filtering: Manual vs Simulated

Stats from simulated games are tracked separately, allowing users to filter leaderboards and records.

#### 4.7.1 Filter Modes

| Mode | Shows | Use Case |
|------|-------|----------|
| **All Games** | Manual + Simulated stats combined | Default view, complete picture |
| **Manual Only** | Only stats from manually played games | "Pure" competitive view |
| **Sim Only** | Only stats from simulated games | Compare sim performance |

```typescript
type StatFilterMode = 'all' | 'manual_only' | 'sim_only';

interface LeaderboardOptions {
  seasonId: string;
  statCategory: 'batting' | 'pitching' | 'fielding';
  filterMode: StatFilterMode;
  minQualifyingGames?: number;
}
```

#### 4.7.2 UI Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Season 1 Batting Leaders                                   â”‚
â”‚                                                             â”‚
â”‚  Filter: [All Games â–¼] [Manual Only] [Sim Only]            â”‚
â”‚                                                             â”‚
â”‚  Batting Average (min 3.1 PA/team game)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. J. Smith      .342  (128 G: 112 manual, 16 sim)    â”‚â”‚
â”‚  â”‚ 2. M. Johnson    .328  (128 G: 96 manual, 32 sim)     â”‚â”‚
â”‚  â”‚ 3. T. Williams   .315  (128 G: 128 manual, 0 sim)     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š = includes simulated games                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.7.3 Per-Player Stat Breakdown

Player stat pages show the split:

```typescript
interface PlayerSeasonStatsSplit {
  playerId: string;
  seasonId: string;

  // Combined totals
  total: BattingStats;

  // Breakdown by source
  manual: BattingStats;   // From manually played games
  simulated: BattingStats; // From simulated games

  // Metadata
  manualGames: number;
  simulatedGames: number;
  totalGames: number;
}
```

### 4.8 Stat Legitimacy: Fully Simulated vs Partially Played Seasons

A critical question: **Should a fully simulated season have the same stat legitimacy as a partially played season?**

#### 4.8.1 Recommendation: Simulation Percentage Threshold

Stats from seasons with **low manual play percentage** should be treated differently:

| Manual Play % | Classification | Award Eligibility | Record Eligibility |
|---------------|----------------|-------------------|-------------------|
| 75%+ | **Primary Season** | âœ… Full eligibility | âœ… Full eligibility |
| 25-74% | **Mixed Season** | âš ï¸ With asterisk | âš ï¸ With asterisk |
| <25% | **Simulated Season** | âŒ Not eligible | âŒ Not eligible |

```typescript
interface SeasonClassification {
  seasonId: string;
  totalGames: number;
  manualGames: number;
  simulatedGames: number;
  skippedGames: number;

  manualPercentage: number;  // manualGames / (manualGames + simulatedGames)
  classification: 'primary' | 'mixed' | 'simulated';
}

function classifySeason(stats: SeasonClassification): 'primary' | 'mixed' | 'simulated' {
  const playedGames = stats.manualGames + stats.simulatedGames;
  if (playedGames === 0) return 'simulated';

  const manualPct = stats.manualGames / playedGames;

  if (manualPct >= 0.75) return 'primary';
  if (manualPct >= 0.25) return 'mixed';
  return 'simulated';
}
```

#### 4.8.2 Impact on Awards & Records

**MVP/Cy Young/ROY Awards:**
- **Primary seasons**: Full eligibility for all awards
- **Mixed seasons**: Can win awards, but noted with "(mixed season)"
- **Simulated seasons**: Stats tracked but not eligible for awards

**All-Time Records:**
- **Primary seasons**: Records count fully
- **Mixed seasons**: Records noted with "â€ " (dagger) annotation
- **Simulated seasons**: Records tracked separately ("Sim Records" category)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  All-Time Home Run Leaders                                  â”‚
â”‚                                                             â”‚
â”‚  1. J. Smith       287  (S1-S5, primary)                   â”‚
â”‚  2. M. Johnson     245â€  (S1-S3, mixed S2)                  â”‚
â”‚  3. T. Williams    198  (S1-S2, primary)                   â”‚
â”‚                                                             â”‚
â”‚  â€  Season included >25% simulated games                     â”‚
â”‚                                                             â”‚
â”‚  [Show Simulated Records]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.8.3 User Control

Users can configure their own thresholds:

```typescript
interface SimulationSettings {
  // Threshold for "primary" classification
  primarySeasonThreshold: number;  // Default: 0.75 (75%)

  // Threshold for "mixed" (below this = "simulated")
  mixedSeasonThreshold: number;    // Default: 0.25 (25%)

  // Whether to show simulated stats in default leaderboard view
  includeSimulatedInDefault: boolean;  // Default: true

  // Whether simulated seasons can earn awards
  allowSimulatedAwards: boolean;  // Default: false
}
```

#### 4.8.4 Rationale

This approach balances flexibility with competitive integrity:

1. **Users who sim most games** get a complete franchise experience but don't claim records they didn't "earn"
2. **Users who play most games** get full recognition for their stats
3. **Mixed usage** (sim some, play some) is acknowledged but still counts
4. **All data is preserved** - nothing is discarded, just classified differently

---

## 5. Unsimulate Feature

### 5.1 When Unsimulate is Available

A simulated game can be unsimulated **only if**:
- No manual games have been played AFTER it in the schedule
- The season hasn't ended
- It hasn't been more than X days (optional time limit?)

```typescript
function canUnsimulate(game: ScheduledGame, season: SeasonContext): boolean {
  if (game.status !== 'simulated') return false;
  if (season.isComplete) return false;

  // Check if any manual game was played after this one
  const laterManualGame = season.games.find(g =>
    g.gameNumber > game.gameNumber &&
    g.status === 'completed'
  );

  return !laterManualGame;
}
```

### 5.2 Unsimulate Process

1. **Confirmation prompt**: "Unsimulate this game? All generated stats will be removed."
2. **Remove event log entries**: Delete all `AtBatEvent` records for this game
3. **Remove from season stats**: Re-aggregate season without this game
4. **Reset game status**: Change to `scheduled`
5. **Integrity check**: Verify season totals still valid

```typescript
async function unsimulateGame(gameId: string): Promise<void> {
  const game = await getGame(gameId);
  if (!canUnsimulate(game)) {
    throw new Error('Cannot unsimulate: manual game played after this one');
  }

  // 1. Delete event log entries
  await deleteGameEvents(gameId);

  // 2. Delete game header
  await deleteGameHeader(gameId);

  // 3. Re-aggregate season stats (rebuild from remaining games)
  await rebuildSeasonStats(game.seasonId);

  // 4. Reset schedule entry
  await updateScheduleEntry(gameId, { status: 'scheduled' });

  console.log(`[Unsimulate] Game ${gameId} reverted to scheduled`);
}
```

### 5.3 Data Safety

- Event log provides complete audit trail
- Season stats can always be rebuilt from event log
- Unsimulate is safe because we're just removing simulated data

---

## 6. Sim to Next Event

### 6.1 Season Event Milestones

The "Sim to Next Event" feature stops at these milestones:

| Event | Description |
|-------|-------------|
| **All-Star Break** | Mid-season break (if configured) |
| **Trade Deadline** | Last day for trades |
| **September Callups** | Roster expansion date |
| **Regular Season End** | Last game before playoffs |
| **Playoff Series** | Each series (WC, Division, LCS, WS) |
| **Off-Season Events** | Draft, free agency, etc. |

```typescript
type SeasonMilestone =
  | 'all_star_break'
  | 'trade_deadline'
  | 'roster_expansion'
  | 'regular_season_end'
  | 'wild_card_round'
  | 'division_series'
  | 'championship_series'
  | 'world_series'
  | 'offseason_start'
  | 'draft'
  | 'free_agency_opens'
  | 'free_agency_closes'
  | 'spring_training';

interface SeasonEvent {
  type: SeasonMilestone;
  date: string;
  gameNumber?: number;  // For game-based milestones
  description: string;
}
```

### 6.2 Sim to Next Event Flow

```
User clicks "Sim to Next Event"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sim to Next Event                          â”‚
â”‚                                             â”‚
â”‚  Current: Game 45 of 512                    â”‚
â”‚  Next Event: All-Star Break (Game 256)      â”‚
â”‚                                             â”‚
â”‚  This will simulate 211 games.              â”‚
â”‚  Estimated time: ~30 seconds                â”‚
â”‚                                             â”‚
â”‚  [Cancel]  [Simulate]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ User confirms
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Simulating...                              â”‚
â”‚                                             â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  45%                  â”‚
â”‚  Game 140 of 211                            â”‚
â”‚                                             â”‚
â”‚  Tigers: 38-24 (.613)                       â”‚
â”‚  Current game: Tigers 4, Yankees 2 (6th)    â”‚
â”‚                                             â”‚
â”‚  [Cancel]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ Complete
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Simulation Complete!                       â”‚
â”‚                                             â”‚
â”‚  211 games simulated                        â”‚
â”‚  Season standings updated                   â”‚
â”‚                                             â”‚
â”‚  Notable events:                            â”‚
â”‚  â€¢ J. Smith hit for the cycle (Game 89)     â”‚
â”‚  â€¢ M. Johnson threw a no-hitter (Game 156)  â”‚
â”‚  â€¢ Tigers clinched division (Game 198)      â”‚
â”‚                                             â”‚
â”‚  [View Standings]  [Continue]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 Batch Simulation Performance

For 200+ games, we need efficient batch processing:

```typescript
async function simToNextEvent(
  seasonId: string,
  onProgress?: (progress: SimProgress) => void
): Promise<SimBatchResult> {
  const season = await getSeason(seasonId);
  const nextEvent = findNextMilestone(season);
  const gamesToSim = getGamesUntil(season, nextEvent);

  const results: SimulatedGameResult[] = [];
  const notableEvents: NotableEvent[] = [];

  for (let i = 0; i < gamesToSim.length; i++) {
    const game = gamesToSim[i];

    // Simulate game
    const result = await simulateGame(game, ...);
    results.push(result);

    // Check for notable events
    notableEvents.push(...detectNotableEvents(result));

    // Report progress
    onProgress?.({
      current: i + 1,
      total: gamesToSim.length,
      currentGame: result,
      standings: calculateStandings(results),
    });

    // Yield to UI every 10 games
    if (i % 10 === 0) {
      await new Promise(r => setTimeout(r, 0));
    }
  }

  return { results, notableEvents, nextEvent };
}
```

### 6.4 Cancellation Support

User can cancel mid-simulation:
- Games already simulated remain simulated
- Current game in progress is discarded
- User can continue from where they stopped

---

## 7. Off-Season Simulation

### 7.1 Off-Season Events (Future Consideration)

Off-season events that could potentially be simulated:

| Event | Simulatable? | Notes |
|-------|--------------|-------|
| Award voting | âœ… Yes | Based on season stats |
| Draft | âš ï¸ Partial | Could auto-pick based on team needs |
| Free agency | âš ï¸ Partial | AI could make signings based on team needs/budget |
| Trades | âŒ Manual | Too complex for meaningful simulation |
| Roster cuts | âœ… Yes | Based on ratings/contracts |
| Spring training | âœ… Yes | Minor rating adjustments |

### 7.2 Recommendation

For initial implementation, **off-season events should remain manual**:
- They're infrequent (once per season)
- User decisions matter more here
- Simulation logic would be complex

Future enhancement: "Auto-draft" and "Auto-sign" options for users who want hands-off off-seasons.

---

## 8. Implementation Dependencies

### 8.1 Prerequisites

Before implementing simulation:

- [x] Event log system (Phase 4) - âœ… Complete
- [ ] Season schedule management
- [ ] Roster/lineup management with ratings
- [ ] Standings calculations
- [ ] Playoff bracket system

### 8.2 New Components Needed

| Component | Purpose |
|-----------|---------|
| `SimulationEngine` | Core at-bat simulation logic |
| `ProbabilityModel` | Rating â†’ outcome probabilities |
| `ScheduleManager` | Track game status, find next event |
| `BatchSimulator` | Handle "Sim to Next Event" |
| `SimulationUI` | Progress dialogs, confirmations |

### 8.3 Database Schema Additions

```typescript
// GameHeader additions
interface GameHeader {
  // ... existing fields
  isSimulated: boolean;
  simulatedAt: number | null;
  simulationSeed: number | null;
}

// AtBatEvent additions
interface AtBatEvent {
  // ... existing fields
  isSimulated: boolean;
}

// New: Schedule tracking
interface SeasonSchedule {
  seasonId: string;
  games: ScheduledGame[];
  milestones: SeasonEvent[];
  currentGameNumber: number;
}
```

---

## 9. Open Questions

1. **Simulation speed vs. fidelity tradeoff**: How detailed should pitch-by-pitch be? Could simplify to just at-bat outcomes.

2. **Injury simulation**: Should simulated games generate injuries? Could affect realism but adds complexity.

3. **Fatigue/rest**: Should simulation respect pitcher rest days? Probably yes for realism.

4. **Home field advantage**: Small boost for home team? (e.g., 54% win rate vs 50%)

5. **Weather/park factors**: âœ… **RESOLVED** - See Section 9.2 below.

6. **Partial game simulation**: User plays 5 innings, sims the rest? Probably not for v1.

### 9.1 Resolved Questions

| Question | Decision |
|----------|----------|
| How should simulated stats count? | Track separately, allow filtering (manual/sim/all) |
| Randomness in simulation? | Yes, 15-25% variance factor with seeded PRNG |
| Awards for simulated seasons? | No awards for <25% manual play; asterisk for 25-74% |
| How to differentiate fully sim vs partial? | Percentage-based classification (primary/mixed/simulated) |
| Park factors in simulation? | âœ… Yes - see Section 9.2 |

### 9.2 Park Factor Integration

> **See STADIUM_ANALYTICS_SPEC.md** for complete park factor system.

Park factors modify outcome probabilities during game simulation:

```javascript
interface SimulationParkModifiers {
  homeRunChance: number;         // Multiply base HR probability
  doubleChance: number;          // Multiply base 2B probability
  tripleChance: number;          // Multiply base 3B probability
  hitChance: number;             // Multiply base hit probability

  // Per-handedness modifiers
  byHandedness: {
    left: { homeRunChance: number; hitChance: number; };
    right: { homeRunChance: number; hitChance: number; };
  };

  strikeoutChance: number;
  walkChance: number;
}

function getSimulationModifiers(stadiumId: string): SimulationParkModifiers {
  const stadium = getStadium(stadiumId);
  const pf = stadium.parkFactors;

  return {
    homeRunChance: pf.homeRuns,
    doubleChance: pf.doubles,
    tripleChance: pf.triples,
    hitChance: pf.hits,

    byHandedness: {
      left: {
        homeRunChance: pf.leftHandedHR,
        hitChance: pf.leftHandedAVG || pf.hits
      },
      right: {
        homeRunChance: pf.rightHandedHR,
        hitChance: pf.rightHandedAVG || pf.hits
      }
    },

    strikeoutChance: pf.strikeouts,
    walkChance: pf.walks
  };
}
```

#### Applying Park Factors to Plate Appearances

```javascript
function resolvePlateAppearance(
  batter: Player,
  pitcher: Player,
  gameContext: SimulationContext
): PlateAppearanceResult {
  // Get base probabilities from batter/pitcher matchup
  const baseProbs = calculateBaseOutcomeProbabilities(batter, pitcher, gameContext);

  // Apply park factor modifiers for current stadium
  const parkMods = getSimulationModifiers(gameContext.stadiumId);
  const handedness = batter.bats;

  const adjustedProbs = {
    homeRun: baseProbs.homeRun * parkMods.byHandedness[handedness].homeRunChance,
    triple: baseProbs.triple * parkMods.tripleChance,
    double: baseProbs.double * parkMods.doubleChance,
    single: baseProbs.single * parkMods.byHandedness[handedness].hitChance,
    walk: baseProbs.walk * parkMods.walkChance,
    strikeout: baseProbs.strikeout * parkMods.strikeoutChance,
    // Out probability adjusts to maintain total = 1.00
  };

  // Normalize and roll for outcome
  const normalized = normalizeProbabilities(adjustedProbs);
  return selectOutcome(normalized, gameContext.rng);
}
```

#### Confidence Threshold

Only apply park factors when confidence is sufficient:

```javascript
function shouldApplyParkFactors(stadium: Stadium): boolean {
  // Don't apply unreliable factors
  return stadium.parkFactors.confidence !== 'LOW';
}

// In simulation:
if (shouldApplyParkFactors(stadium)) {
  probs = applyParkModifiers(probs, stadium);
} else {
  // Use base probabilities (neutral park assumption)
}

---

## 10. UI Mockups

### 10.1 Schedule View with Sim Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Season 1 Schedule                    [Sim to Next Event]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Game 43 âœ“  Tigers 5, Yankees 3         [Box Score]        â”‚
â”‚  Game 44 âœ“  Tigers 2, Red Sox 7         [Box Score]        â”‚
â”‚  Game 45 ğŸ“Š Tigers 4, Red Sox 1  (SIM)  [Box] [Unsim]      â”‚
â”‚  Game 46 â—‹  @ Blue Jays                 [Play] [Sim] [Skip]â”‚
â”‚  Game 47 â—‹  @ Blue Jays                 [Play] [Sim] [Skip]â”‚
â”‚  ...                                                        â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€ ALL-STAR BREAK (Game 256) â”€â”€â”€                         â”‚
â”‚                                                             â”‚
â”‚  Game 257 â—‹  vs Orioles                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend: âœ“ = Played, ğŸ“Š = Simulated, â—‹ = Scheduled, âŠ˜ = Skipped
```

### 10.2 Simulated Box Score Indicator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“Š SIMULATED GAME                                    â”‚  â”‚
â”‚  â”‚ This game was simulated, not played manually.        â”‚  â”‚
â”‚  â”‚ [Unsimulate] to play this game yourself.             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  TIGERS 4, RED SOX 1                                       â”‚
â”‚  Game 45 â€¢ April 15, 2026                                  â”‚
â”‚                                                             â”‚
â”‚  1  2  3  4  5  6  7  8  9    R  H  E                      â”‚
â”‚  0  0  2  0  1  0  0  1  0    4  9  0   Tigers             â”‚
â”‚  0  0  0  0  0  1  0  0  0    1  5  1   Red Sox            â”‚
â”‚                                                             â”‚
â”‚  ... (normal box score content) ...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Summary

| Feature | Description | Complexity |
|---------|-------------|------------|
| **Skip Game** | Mark as skipped, adjust thresholds | Low |
| **Simulate Game** | Play-by-play generation from ratings + variance | Medium |
| **Unsimulate** | Revert simulated game to scheduled | Low |
| **Sim to Next Event** | Batch simulate to milestone | Medium |
| **Stat Filtering** | Manual-only / Sim-only / All games views | Low |
| **Season Classification** | Primary (75%+) / Mixed (25-74%) / Simulated (<25%) | Low |
| **Off-Season Sim** | Auto-handle off-season events | High (deferred) |

The simulation system integrates cleanly with the existing event log architecture - simulated at-bats produce the same data structures as manual games, just with an `isSimulated` flag for visual distinction and reversibility.

**Key Design Decisions:**
1. **Randomness**: 15-25% variance factor prevents deterministic outcomes
2. **Stat tracking**: All stats tracked with source flag, filterable in UI
3. **Legitimacy tiers**: Seasons classified by manual play percentage for awards/records
4. **User control**: Thresholds configurable per franchise

---

## 12. References

| Document | Relevance |
|----------|-----------|
| STAT_TRACKING_ARCHITECTURE_SPEC.md | Event log integration |
| FRANCHISE_MODE_SPEC.md | Season/schedule context |
| eventLog.ts | AtBatEvent structure |
| KBL_XHD_TRACKER_MASTER_SPEC_v3.md | Player ratings schema |

---

*Last Updated: January 22, 2026 (v2 - added randomness, stat filtering, season classification)*
*Status: PLANNING - Awaiting completion of prerequisite features*
